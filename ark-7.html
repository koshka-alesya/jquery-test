<!-- COMMON LIBRIRIES -->
<script>
  const time = {
	timestamp: function(callback) {
	  var xhr = new XMLHttpRequest();
	  xhr.withCredentials = true;
	  xhr.addEventListener("readystatechange", function() {
		if (this.readyState === 4) {
		  if (typeof(callback) === "function") return callback(this.responseText);
		  else return this.responseText;
		}
	  });
	  xhr.open("GET", globalReferences.server + "resources/rs/custom/onb/timestamp.php");
	  xhr.send();
	},
	dhm: function(t) {
	  var cd = 24 * 60 * 60 * 1000,
		  ch = 60 * 60 * 1000,
		  d = Math.floor(t / cd),
		  h = Math.floor((t - d * cd) / ch),
		  m = Math.round((t - d * cd - h * ch) / 60000),
		  pad = function(n) {
			return n < 10 ? '0' + n : n;
		  };
	  if (m === 60) {
		h++;
		m = 0;
	  }
	  if (h === 24) {
		d++;
		h = 0;
	  }
	  return [d, pad(h), pad(m)].join(':');
	}
  };
</script>

<!-- USER & GENERAL UI -->
<script>
  const access = {
	version: '1.0.0.38',
	test: {
	  enable: false,
	  email: "test12399@test.test",
	  firstName: "ergwrg",
	  lastName: "sdfsdf"
	},
	data : null,
	init: function(callback) {
	  //init checkout timer
	  access._checkForInactivity();
	  access._checkLatestVersion();
	  //
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  access.user = {
		Email: document.querySelector("#sso input[name=Email]").value,
		Name: document.querySelector("#sso input[name=FirstName]").value + ", " + document.querySelector("#sso input[name=LastName]").value
	  };
	  if(!access.user.Email) {
		var userAttribute  = '[SSOData.UserAttribute]';
		var parsedUA = JSON.parse(userAttribute || '');
		access.user.Email = parsedUA.User.emailAddress;
		access.user.Name = parsedUA.User.firstName + ', ' + parsedUA.User.lastName;
	  }
	  if (access.test.enable) {
		access.user = {
		  Email: access.test.email,
		  Name: access.test.firstName + ", " + access.test.lastName
		};
	  }

	  // if(access.user.Email =='andrici.andrei-toni@hpe.com') access.user.Email = 'fu-yu.wang@hpe.com';

	  access._initUser(function() {
		access._initAccess(function() {
		  if (typeof(callback) === "function") callback();
		});
	  });
	},
	_initUser: function(callback) {
	  access._getUserData(access.user.Email, function(data) {

		if (data.Rows.length == 0) {
		  mo.fn.modal.show({
			ctaLabel: "OK",
			class: "ark-modal",
			title: "User account error",
			content: "<p>No user account identified for your information.<br><a href='https://prp-dxp.it.hpe.com/group/internal'>Go back to PRP</a></p>"
		  });
		  mo.fn.overlay.show({
			close: false,
			loading: true
		  });
		  document.querySelector("#nav #burger").innerHTML = "";

		  document.querySelector(".screen").innerHTML = "";



		} else if (data.Rows.length > 1) {
		  mo.fn.modal.show({
			ctaLabel: "OK",
			class: "ark-modal",
			title: "User account error",
			content: "<p>Multiple user records matching your account were identified. Please raise a support ticket for further assistance.<br><a href='https://prp-dxp.it.hpe.com/group/internal'>Go back to DXP</a></p>"
		  });
		  mo.fn.overlay.show({
			close: false
		  });
		  document.querySelector("#nav #burger").innerHTML = "";
		  document.querySelector(".screen").innerHTML = "";

		} else {


		  data = data.Rows[0];
		  access.data = data;

		  access.user.FirstName = data.FirstName;
		  access.user.LastName = data.LastName;
		  access.user.EntryId = data.EntryId;
		  access.user.UserRole = JSON.parse(data.UserRole);
		  access.user._UserRole = access.user.UserRole;
		  access.user.UserVisits = parseInt(data.UserVisits) || 0;
		  access.user.UserVisits = access.user.UserVisits + 1;
		  try {
			access.user.UserData = JSON.parse(data.UserData);
		  } catch (err) {
			access.user.UserData = {
			  total: 0,
			  opened: [],
			  updated: 0
			}
		  }
		  if (access.user.UserRole.length == 0) {
			mo.fn.modal.show({
			  ctaLabel: "OK",
			  class: "ark-modal",
			  title: "User account error",
			  content: "<p>No valid permissions assigned to the user account.<br><a href='https://prp-dxp.it.hpe.com/group/internal'>Go back to DXP</a></p>"
			});
		  } else if (access.user.UserRole.ACTIVE == false) {

			mo.fn.modal.show({
			  ctaLabel: "OK",
			  class: "ark-modal",
			  title: "User account error",
			  content: "<p>User inactive.<br><a href='https://prp-dxp.it.hpe.com/group/internal'>Go back to DXP</a></p>"
			});

			document.querySelector("#nav #burger").innerHTML = "";
			document.querySelector(".screen").innerHTML = "";
		  } else if (typeof(callback) === "function") {
			access._putUserData(access.user.EntryId, {
			  UserVisits: access.user.UserVisits,
			  LastLogin: access.user.LastLogin
			}, function(d) {
			  access.data = d;
			  console.log("User account updated successfully");
			});
			callback();
		  }
		}
	  });
	  time.timestamp(function(time) {
		access.user.LastLogin = time;
	  });
	},
	_initAccess: function(callback) {
	  if (access.user.UserRole["ADMIN"]) {
		// ENABLE ALL PERMISSIONS FOR ADMI
	  } else {
		Object.entries(access.user.UserRole).forEach(function([key, value]) {
		  switch (key) {
			case 'LOC':
			  if (value == false) {
				Array.from(document.querySelectorAll('*[section-id="localization"]')).forEach(function(el) {
				  el.classList.add('hidden');
				});
			  }
			  break;
			case 'UAR':
			  if (value == false) {
				Array.from(document.querySelectorAll('*[section-id="users"]')).forEach(function(el) {
				  el.classList.add('hidden');
				});
			  }
			  break;
			case 'CMR':
			  if (value == false) {
				Array.from(document.querySelectorAll('*[section-id="countries"]')).forEach(function(el) {
				  el.classList.add('hidden');
				});
			  }
			  break;
			case 'IFM':
			  if (value == false) {
				Array.from(document.querySelectorAll('*[section-id="intake"]')).forEach(function(el) {
				  el.classList.add('hidden');
				});
			  }
			  break;
			case 'ADMIN':
			  if (!value) {
				Array.from(document.querySelectorAll('*[section-id="all-invitations"]')).forEach(function(el) {
				  el.classList.add('hidden');
				});
			  }
			  break;
			default:
			  // code block
		  }


		});
	  }
	  if (typeof(callback) === "function") callback();
	},
	_getUserData: function(email, callback) {
	  crud.read("2493", "Email=" + email + "&Source=ARK", function(d) {
		if (typeof(callback) === "function") return callback(d);
		else return d;
	  });
	},
	_putUserData: function(id, data, callback) {
	  crud.update("3255", id, data, function(d) {
		if (typeof(callback) === "function") return callback(d);
		else return d;
	  });
	},
	_updUserStat: function(eid) {
	  if (access.user.UserData.opened.indexOf(eid) == -1) {
		access.user.UserData.opened.push(eid);
		access.user.UserData.total = access.user.UserData.opened.length;
		onbd.r.usr.app(function(d) {
		  access.user.UserData.updated = d.Total;
		  access._putUserData(access.user.EntryId, {
			UserData: JSON.stringify(access.user.UserData)
		  }, function() {
			console.log("Internal user statistics updated successfully");
		  });
		})
	  }
	},
	_getAuth: function(role) {
	  var role = access.user.UserRole[role.toUpperCase()];
	  if (typeof(role) === "boolean") return role;
	  else {
		var arr = [];
		for (i = 0; i < Object.keys(role).length; i++)
		  if (role[Object.keys(role)[i]])
			arr.push(Object.keys(role)[i]);
		if (arr.length == 0) return false;
		else return arr;
	  }
	},
	hasAccessToOperationTask: function(task) {

	  var userPermissions = access.user._UserRole;

	  var taskInfo = invitation.invitationOverview.tasks.config.find(c => c.id == task.FKB);

	  var eligble = false;

	  if(taskInfo.permissions.length == 0)
		eligble = true;
	  else
		taskInfo.permissions.forEach(role => {

		  var r = role;
		  var perm = userPermissions[r];

		  if (role != "BU") {
			if (perm[task.Region]) {
			  eligble = true;
			}
			else eligble = false;
		  } else {
			var configs = perm[task.Region];
			if (configs.indexOf(task.ConfigName) >= 0)
			  eligble = true;
			else eligble = false;
		  }
		});



	  return eligble;
	},
	_checkForInactivity: function() {
	  let timer;
	  let t = 15 * 60000; // 15 minutes 
	  function startTimer(){
		//console.log('------------- TIMER STARTED -------------');
		timer = window.setTimeout(doWhenInactive , t);
	  }

	  function doWhenInactive() {
		console.log('------------- OPENING MODAL -------------');
		// 1. clear initial timer
		window.clearTimeout(timer);

		// OPEN MODAL - message + countdown timer of 15:00;
		mo.fn.modal.show({
		  ctaLabel:'Return to page',
		  title:'Inactivity Warning',
		  close: false,
		  content:'<div class="inactivity-warning-modal"><span> You will be redirected to the DXP landing/login page in 15 minutes.</span> <p id="inactivity-timer" style="font-size:2em"></p> </div>',
		  contentCallback:function(){
			document.querySelector('.inactivity-warning-modal #inactivity-timer').innerHTML = 15 + ":" + 00;
			initModalTimer();

			function initModalTimer() {
			  let currentTime = document.querySelector('.inactivity-warning-modal #inactivity-timer').innerHTML;
			  let min = currentTime.split(':')[0];
			  let sec = formatSeconds((currentTime.split(':')[1] - 1));

			  if(sec==59) min--;
			  // When time is up
			  if(min<0){
				//alert('The time is up! Going to redirect')
				window.location.href="https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166";
				return
			  }

			  document.querySelector('.inactivity-warning-modal #inactivity-timer').innerHTML = min + ":" + sec;

			  modalTimer = setTimeout(initModalTimer, 1000);
			}

			function formatSeconds(sec) {
			  if (sec < 10 && sec >= 0) sec = "0" + sec ; // add zero in front of numbers < 10
			  if (sec < 0) sec = "59";
			  return sec;
			}

			//clear listeners
			let events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
			events.forEach( ev =>  document.removeEventListener(ev, resetTimer, false));

		  },
		  ctaCallback: function() {
			// clear modal timeout
			window.clearTimeout(modalTimer);
			// start main timeout counter
			initTimeoutCheck();

			mo.fn.events.closeAll();

		  }
		});
	  }

	  function resetTimer(){
		//console.log('------------- TIMER WAS RESETTED -------------');
		window.clearTimeout(timer);
		startTimer();
	  }

	  function initTimeoutCheck(){
		let events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
		events.forEach( ev =>  document.addEventListener(ev, resetTimer, false));
		startTimer();
	  }

	  initTimeoutCheck();
	},
	_checkLatestVersion: function() {

	  function checkVersion() {
		let dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1622/ARK_Versioning/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId"
			}
		  },
		  serverPaging: false,
		  serverFiltering: true,
		  sort: { field: "EntryId", dir: "desc" },
		  pageSize: 1,
		  filter: { field: "Application", operator: "eq", value: "internal"}
		});

		dataSource.read()
		  .then(function () {
		  let data = dataSource.view();
		  console.log(data[0].Version);
		  if (data[0].Version == access.version) {
			console.log('--------------no refresh needed--------------')
			return 
		  } else {
			mo.fn.modal.show({
			  ctaLabel:'Refresh',
			  class:"bottom-right",
			  title:'New app version',
			  content:'<div><p>A new version of the application is available.</div>',
			  contentCallback:function(){
			  },
			  ctaCallback: function() {

				// redirect to login page
				window.location.href= "https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166";
				mo.fn.events.closeAll();
			  } 
			});

		  }
		});
	  }

	  checkVersion();

	  setInterval(checkVersion, 5 * 60 * 1000);

	}
  };

  const ui = {
	dom: {
	  burger: document.querySelector("#burger"),
	  nav: document.querySelector("nav"),
	  logo: document.querySelector("#logo"),
	  message: document.querySelector("#message"),
	  menu: document.querySelectorAll("*[section-id]:not(.inactive)"),
	  icons: document.querySelectorAll("#icons li"),
	  iconsClose: document.querySelectorAll("#icons li span"),
	  modules: document.querySelectorAll("#container section.wrapper"),
	},
	init: function() {
	  ui.checkAccess();
	  ui.burger.init();
	  ui.nav.init();
	  ui.icons.init();
	  ui.logo();
	  ui.initJiraReporting();

	  profile.init();
	  // DOCUMENT LEVEL EVENTS
	  document.addEventListener("click", function(e) {
		ui.burger.escape(e);
		ui.icons.escape(e);
		ui.message.escape(e);
	  });

	  mo.fn.overlay.hide();


	  navigationSearch.init();
	  search.init();

	  //Hide batch operations if not Admin
	  if (access.user.UserRole.ADMIN == true && !access.user.UserRole.Readonly) {
		document.querySelectorAll('[section-id="bulk-invs"]').forEach(function(el) {
		  el.style.display = "block";
		})
		document.querySelectorAll('[section-id="authCodes"]').forEach(function(el) {
		  el.style.display = "block";
		})
	  } else {
		document.querySelectorAll('[section-id="bulk-invs"]').forEach(function(el) {
		  el.style.display = "none";
		})

	  }


	  if (access.user.UserRole.Readonly) document.querySelector('[section-id="create-company"]').style.display = 'none';
	  document.addEventListener("keyup", function(event) {
		// Number 13 is the "Enter" key on the keyboard
		if (event.keyCode === 13) {
		  var navinp = document.querySelector('#search-input-nav').value;
		  if (search.holder() && search.holder().querySelector('.search_company')) search.holder().querySelector('.search_company').click();
		  else if (navinp) navigationSearch.eventListener();
		}
	  });


	  var caseId = document.querySelector("#sso input[name=cid]").value;
	  if (caseId) {
		invitation.invitationOverview.init(caseId);
	  }

	  overviewCounters.init();

	},
	translate: function(key) {
	  if (typeof(reference.translations.data[key]) !== "undefined") {
		if (typeof(reference.translations.data[key]["en_US"]) !== "undefined")
		  return reference.translations.data[key]["en_US"];
	  } else if (typeof(key) === "string") {
		return key;
	  }
	  return key;
	},
	checkAccess: function() {
	  // ENABLE ACCESS TO ALL FEATURES
	  var navLi = document.querySelectorAll("nav li");
	  var tiles = document.querySelectorAll("#tiles .tile");
	  for (i = 0; i < navLi.length; i++) navLi[i].classList.remove("inactive");
	  for (i = 0; i < tiles.length; i++) tiles[i].classList.remove("inactive");
	},
	burger: {
	  init: function() {
		ui.dom.burger.addEventListener("click", ui.burger.toggle);
	  },
	  show: function() {
		ui.dom.burger.classList.add("open");
		ui.dom.nav.classList.add("open");
	  },
	  hide: function() {
		ui.dom.burger.classList.remove("open");
		ui.dom.nav.classList.remove("open");
	  },
	  toggle: function() {
		if (ui.dom.burger.getAttribute("class") == null || ui.dom.burger.getAttribute("class").indexOf("open") == -1) ui.burger.show();
		else ui.burger.hide();
	  },
	  escape: function(e) {
		if (e.target.closest("#burger") == null && (e.target.closest("nav") == null || (e.target.closest("nav") != null && e.target.closest("li") != null)))
		  ui.burger.hide();
	  }
	},
	nav: {
	  init: function() {
		ui.dom.menu = document.querySelectorAll("*[section-id]:not(.inactive)");
		for (i = 0; i < ui.dom.menu.length; i++)
		  ui.dom.menu[i].addEventListener("click", function(e) {
			var target = e.target.closest("[section-id]").getAttribute("section-id");
			if (document.getElementById(target)) {
			  ui.nav.reset();
			  document.getElementById(target).classList.add("active");
			  ui.showModule(target);
			}
		  });
	  },
	  reset: function() {
		var wrpEl = document.querySelectorAll("section.screen section.wrapper");
		for (i = 0; i < wrpEl.length; i++) wrpEl[i].classList.remove("active");
	  }
	},
	icons: {
	  init: function() {
		for (i = 0; i < ui.dom.icons.length; i++)
		  ui.dom.icons[i].addEventListener("click", function(e) {
			var target = e.target.closest("[icon-id]").getAttribute("icon-id");
			if (e.srcElement.nodeName != "SPAN" && e.target.closest("span") == null) {
			  ui.icons.reset();
			  e.target.closest("[icon-id]").classList.add("open");
			  if (document.getElementById(target))
				document.getElementById(target).classList.add("open");
			}
		  });
		for (i = 0; i < ui.dom.iconsClose.length; i++)
		  ui.dom.iconsClose[i].addEventListener("click", function(e) {
			e.preventDefault();
			var target = e.target.closest("[icon-id]").getAttribute("icon-id");
			if (e.srcElement.nodeName == "SPAN" || e.target.closest("span") != null) {
			  ui.icons.reset();
			  document.getElementById(target).classList.remove("open");
			}
		  });
	  },
	  reset: function() {
		for (i = 0; i < ui.dom.icons.length; i++)
		  ui.dom.icons[i].classList.remove("open");
	  },
	  escape: function(e) {
		if (e.target.closest("#profile") == null && (e.target.closest("[icon-id]") == null || e.target.closest("[icon-id]").getAttribute("icon-id") != "profile")) {
		  document.querySelector("li[icon-id=profile]").classList.remove("open");
		  document.getElementById("profile").classList.remove("open");
		}
	  }
	},
	message: {
	  open: function(message, state, timer) {
		ui.dom.message.innerHTML = message;
		if (typeof(state) !== "undefined") {
		  if (state == 1 || state == "scs" || state == "success")
			ui.dom.message.classList.add("success");
		  else if (state == 2 || state == "wrn" || state == "warning")
			ui.dom.message.classList.add("warning");
		  else if (state == 3 || state == "err" || state == "error")
			ui.dom.message.classList.add("error");
		}
		ui.dom.message.classList.add("active");
		window.scrollTo({
		  top: 0,
		  behavior: 'smooth'
		});
		timer = parseInt(timer) || 10;
		ui.message.wait(timer);
	  },
	  reset: function() {
		var arr = ["active", "success", "warning", "error"];
		for (i = 0; i < arr.length; i++)
		  ui.dom.message.classList.remove(arr[i]);
	  },
	  wait: function(timer) {
		setTimeout(function() {
		  ui.message.reset();
		}, timer * 1000);
	  },
	  escape: function(e) {
		if (e.target.closest("#message") == null)
		  ui.message.reset();
	  }
	},
	logo: function() {
	  document.querySelector("#logo").addEventListener("click", function() {
		ui.showModule("tiles");
	  });
	},
	showModule: function(module) {
	  /*
                           console.log(ui.dom.modules);
                            for (i = 0; i < ui.dom.modules.length; i++) {
                              ui.dom.modules[i].classList.remove("active");
                              if (ui.dom.modules[i].getAttribute("id") == module)
                                ui.dom.modules[i].classList.add("active");
                            }

                            switch (module) {
                              default: console.log("No application component requested");
                                break;
                              case "profile":
                                profile.init();
                                break;
                              case "search":
                                search.init();
                                break;
                              case "pending":
                                pending.init();
                                break;
                              case "last-actions":
                                lastActions.init();
                                break;
                              case "invitations":
                                myInvitations.init();
                                break;
                              case "countries":
                                countries.init();
                                break;
                              case "users":
                                users.init();
                                break;
                              case "localization":
                                localization.init();
                                break;
                              case "company":
                                company.init();
                                break;
                              case "intake":
                                intakeForms.init();
                                break;
                            }
                            */
	},
	initJiraReporting: function() {

	  try {
		jQuery.ajax({
		  url: "https://hpheroes.atlassian.net/s/d41d8cd98f00b204e9800998ecf8427e-T/-onpk8x/b/7/b0105d975e9e59f24a3230a22972a71a/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-US&collectorId=f51e9fa0",
		  type: "get",
		  cache: true,
		  dataType: "script"
		}).done(function() {
		  setTimeout(function() {
			var jiraBugButton = document.querySelector("#atlwdg-trigger");
			if (jiraBugButton) {
			  jiraBugButton.style.display = "none";
			  var bugIcon = document.querySelector("[icon-id=jira-bugs]");
			  if (bugIcon) {
				bugIcon.style.display = "initial";
				bugIcon.addEventListener("click", function() {
				  var jiraBugButton = document.querySelector("#atlwdg-trigger");
				  if (jiraBugButton)
					jiraBugButton.click();

				});
			  }
			}
		  }, 1000);
		});
	  } catch (err) {
		console.error('Failed to load RFB Jira Issue Collector');
	  }


	}
  };
</script>

<!--utils -->
<script>
  const util = {
	removeTime: function(object) {
	  if (!object)
		return object;

	  var keys = Object.keys(object);
	  keys.forEach(x => {
		if (object[x] && typeof object[x] === "string")
		  object[x] = object[x].replace("T00:00:00", "");
	  });

	  return object;
	},
	sort: function(objs, field) {
	  return objs.sort(function(a, b) {
		return a[field].localeCompare(b[field])
	  });
	},
	stringifyConfig: function(obj) {
	  return JSONfn.stringify(obj);
	},
	parseConfigStr: function(str) {
	  return JSONfn.parse(str);
	},
	Email: function() {
	  return access.user.Email
	},
	getDate: function(date, onlyDate) {
	  if (date) {
		var d = date.split('T');
		if (onlyDate)
		  return d[0]
		else {
		  try {
			return d[0] + ' ' + d[1].substring(0, 5);
		  } catch (e) {
			return d[0]
		  }
		}
	  } else return date;
	},
	getToggleValue: function(value) {
	  return value == "Y" ? "Yes" : "No";
	},
	escapeTooltip: function(string) {
	  var part;
	  if (string.length >= 25) {
		part = string.substring(0, 24) + '...';
		var a = '<span class="tooltip">' + part + ' <span class="tooltiptext">' + string + '</span></span>';
		return a;
	  } else return string;

	},
	isDeveloper: function() {
	  if (access.user.Email == 'andrici.andrei-toni@hpe.com') {
		return true;
	  } else if (access.user.Email == 'sergey.kalinin@hpe.com') {
		return true;
	  } else if (access.user.Email == 'anton.zhabin@hpe.com') {
		return true;
	  } else return false;
	},
	getCookie: function(name) {
	  try {
		var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
		if (match) return match[2];
	  } catch (e) {}
	  return undefined;
	},
	populateSelect: function(select, values, options) {
	  var value = select.value;
	  util.clearSelect(select);
	  for (var i = 0; i < values.length; i++) {
		var opt = document.createElement('option');
		opt.value = values[i];
		opt.innerHTML = options[i];
		select.appendChild(opt);
	  }
	  select.value = value;

	},
	clearSelect: function(select) {
	  var i, L = select.options.length - 1;
	  for (i = L; i >= 0; i--) {
		if (!select.options[i].disabled)
		  select.remove(i);
	  }
	},
	getDifference: function(object1, object2, conf, includeFKs) {
	  var changes = "";

	  Object.keys(object2).forEach(x => {


		if (["Modified", "ModifiedBy", "Created", "CreatedBy", "CompanyInfo"].indexOf(x) >= 0)
		  return;

		if (object1[x] == object2[x])
		  return;

		if (!object1[x] && !object2[x])
		  return;

		var caption = x;
		if (conf)
		  caption = util.findTitleByDataName(conf, x);

		if (!caption)
		  caption = x;

		if (caption.includes("FK") && !includeFKs)
		  return;

		if (caption == "Select File")
		  caption = "File";

		var prevValue = object1[x];
		if (prevValue == "null")
		  prevValue = null;

		var newValue = object2[x];
		if (newValue == "Y")
		  newValue = "Yes";
		else if (newValue == "N")
		  newValue = "No";

		var configNameOld = util.getConfigNameById(prevValue);
		if (configNameOld)
		  prevValue = configNameOld;

		var configNameNew = util.getConfigNameById(newValue);
		if (configNameNew)
		  newValue = configNameNew;

		if (prevValue) {
		  changes += caption + ": " + '"' + prevValue + '"' + " -> " + '"' + newValue + '"' + ";##";
		} else changes += caption + ": " + '"-"' + " -> " + newValue + '"' + ";##";
	  });

	  return changes;
	},
	findTitleByDataName: function(conf, dataName) {
	  if (!conf)
		return "";

	  for (var i = 0; i < conf.pages.length; i++)
		for (var s = 0; s < conf.pages[i].structure.length; s++)
		  for (var g = 0; g < conf.pages[i].structure[s].group.length; g++)
			for (var e = 0; e < conf.pages[i].structure[s].group[g].length; e++)
			  if (conf.pages[i].structure[s].group[g][e].data == dataName)
				return conf.pages[i].structure[s].group[g][e].label;
	},
	findInputByDataName: function(conf, dataName) {
	  if (!conf)
		return "";

	  for (var i = 0; i < conf.pages.length; i++)
		for (var s = 0; s < conf.pages[i].structure.length; s++)
		  for (var g = 0; g < conf.pages[i].structure[s].group.length; g++)
			for (var e = 0; e < conf.pages[i].structure[s].group[g].length; e++)
			  if (conf.pages[i].structure[s].group[g][e].data == dataName)
				return conf.pages[i].structure[s].group[g][e];
	},
	getNbsfInputs: function(conf) {
	  if (!conf)
		return "";

	  var res = [];
	  for (var i = 0; i < conf.pages.length; i++)
		for (var s = 0; s < conf.pages[i].structure.length; s++)
		  for (var g = 0; g < conf.pages[i].structure[s].group.length; g++)
			for (var e = 0; e < conf.pages[i].structure[s].group[g].length; e++)
			  res.push(conf.pages[i].structure[s].group[g][e]);

	  return res;
	},
	getConfigNameById: function(configId) {

	  try {
		return reference.configs.data.find(x => x.ConfigId == configId).ConfigName
	  } catch (e) {
		return null;
	  }
	},
	getAuditString: function(name, value1, value2) {
	  if (value1)
		return name + ": '" + (value1 || "-") + "' -> '" + (value2 || "-") + "'";
	  else
		return name + ": '" + (value2 || "-") + "'";
	},
	beautifyAuditString: function(string) {
	  try {
		var res = "";
		var strs = string.split(";");
		strs.forEach(str => {
		  var idx1 = str.indexOf(":");
		  if (idx1 == -1)
			res += str;
		  else {
			var field = str.substring(0, idx1);
			field = "<span class='audit_field'>" + field + ": </span>";

			res += field + str.substring(idx1 + 1);
		  }
		});

		return res.replaceAll('"', "'");

	  } catch (e) {
		return string;
	  }

	},
	exportExcel: function(e) {

	  if (!e.sender.exporting) {
		e.preventDefault();

		if (e.sender.dataSource.total() > 1000) {
		  mo.fn.modal.show({
			ctaLabel: "OK",
			class: "ark-modal",
			title: "Download excel",
			content: "There are " + e.sender.dataSource.total() + " records found. Are you sure that you want to proceed?",
			ctaCallback: function() {
			  setTimeout(function() {
				window.isExporting = true;
				e.sender.exporting = true;
				e.sender.saveAsExcel();
				mo.fn.modal.hide();
				mo.fn.overlay.hide();
			  }, 500);
			}
		  });
		  return;
		} else {
		  window.isExporting = true;
		  e.sender.exporting = true;
		  e.sender.saveAsExcel();
		  mo.fn.overlay.hide();
		  return;
		}
	  }



	  var data = e.data;
	  var gridColumns = e.sender.columns;
	  var sheet = e.workbook.sheets[0];
	  var visibleGridColumns = [];
	  var columnTemplates = [];
	  var dataItem;
	  // Create element to generate templates in.
	  var elem = document.createElement('div');

	  // Get a list of visible columns
	  gridColumns = gridColumns.filter(x => x.title);
	  for (var i = 0; i < gridColumns.length; i++) {
		if (!gridColumns[i].hidden) {
		  visibleGridColumns.push(gridColumns[i]);
		}
	  }

	  // Create a collection of the column templates, together with the current column index
	  for (var i = 0; i < visibleGridColumns.length; i++) {
		if (visibleGridColumns[i].template) {
		  columnTemplates.push({
			cellIndex: i,
			template: visibleGridColumns[i].template
		  });
		}
	  }

	  // Traverse all exported rows.
	  for (var i = 1; i < sheet.rows.length; i++) {
		var row = sheet.rows[i];
		// Traverse the column templates and apply them for each row at the stored column position.

		// Get the data item corresponding to the current row.
		var dataItem = data[i - 1];
		for (var j = 0; j < columnTemplates.length; j++) {
		  var columnTemplate = columnTemplates[j];
		  // Generate the template content for the current cell.
		  var value = columnTemplate.template(dataItem);
		  if (row.cells[columnTemplate.cellIndex] != undefined)
			// Output the text content of the templated cell into the exported cell.
			row.cells[columnTemplate.cellIndex].value = value || ""; //elem.textContent || elem.innerText || "";
		}
	  }

	  e.sender.exporting = false;
	},
	getUnqiueValues: function(tableName, columnName, callback) {
	  jQuery.ajax({
		url: '/form/1166/sp/spGetUniqValues/call',
		dataType: 'json',
		type: 'POST',
		data: {
		  'p.TableName': tableName,
		  'p.FieldName': columnName
		},
	  })
		.done(function(response) {
		var data = _.get(response, "Rows", []);

		if (callback) {
		  callback(data);
		}
	  }.bind(this));

	},
	customFieldsTooltips: function(config, node) {
	  if (!node)
		node = document;

	  var inputs = util.getNbsfInputs(config);

	  inputs.filter(x => x.tooltip).forEach(x => {
		var lb = node.querySelector("[data-name=" + x.data + "]").closest(".wrapper");

		var ttclass = 'custom-fields-tooltip';
		if (x.type == "toggle")
		  ttclass = 'custom-fields-tooltip-toggle';

		if (x.type.includes("date"))
		  ttclass = 'custom-fields-tooltip-date';


		/*lb.innerHTML += `<div tooltip='` + x.tooltip +`' class='` + ttclass + `'><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="circle information" width="20px" height="20px">
              <path fill="none" stroke="#666" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M12,10 L12,18 M12,6 L12,8">
  </path>
  </svg></div>`;*/
		if (x.tooltip) lb.insertAdjacentHTML('beforeend', `<div class="tooltipMess"><div class="tooltipMessWrapper"><svg class="tooltipSvg" version="1.1" viewBox="0 0 24 24" role="img" aria-label="circle information" width="20px" height="20px">
<path fill="none" stroke="#666" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M12,10 L12,18 M12,6 L12,8">
  </path>
  </svg><span class="tooltiptext">${x.tooltip}</span></div><div>`);


	  });

	},
	isJson: function(item) {
	  item = typeof item !== "string" ?
		JSON.stringify(item) :
	  item;
	  try {
		item = JSON.parse(item);
	  } catch (e) {
		return false;
	  }
	  if (typeof item === "object" && item !== null) {
		return true;
	  }
	  return false;
	},
	filter: function(object, logic) {
	  return {
		logic: logic,
		filters: object
	  }
	},
	kendoGrid: {
	  dataBound: function(e) {
		if (this.dataSource.view().length == 0) {
		  //insert empty row
		  var colspan = this.thead.find("th").length;
		  var emptyRow = "<tr><td colspan='" + colspan + "'></td></tr>";
		  this.tbody.html(emptyRow);
		}
	  },
	  filter: function(e) {
		if (e.filter && e.filter.filters && e.sender.dataSource.options.schema.model && e.sender.dataSource.options.schema.model.fields) {
		  e.filter.filters.forEach(x => {
			var column = e.sender.dataSource.options.schema.model.fields[x.field];
			if (column) {

			  var type = column.type;
			  if (type == "date") {
				try {
				  x.value = new Date(x.value).toISOString();
				} catch (e) {}
			  }
			}
		  });
		}
	  },
	  addDateFieldsToSchema: function(datasource, columnNames) {
		columnNames.forEach(x => {
		  datasource.options.schema.model.fields[x] = {
			type: "date"
		  };
		});
	  }
	},
	checkEmailTemplate: function(companyFk, Language, callback) {
	  crud.read(3758, "eid=" + companyFk, function(data) {
		if (data && data.Rows && data.Rows.length) {
		  var conf = util.parseConfigStr(data.Rows[0].Config);
		  crud.read(3689, "key=" + conf.invite, function(dt) {
			if (dt && dt.Rows && dt.Rows.length) {
			  var getLanguage = dt.Rows[0][Language];
			  if (!getLanguage) {
				error = "There is no <b>email templates</b> for this Intake form for the language of the selected country. Invitation will be sent in English. Continue ?";
				mo.fn.modal.show({
				  ctaLabel: "Send",
				  closeLabel: "Cancel",
				  title: "Error",
				  class: "ark-modal",
				  content: error,
				  ctaCallback: function() {
					mo.fn.events.closeAll();
					if (typeof callback == 'function') callback();
				  }
				});
			  } else {
				if (typeof callback == 'function') callback();
			  }
			} else {
			  error = "There is no <b>Translation</b> for this Intake form. Please select another Language.";

			  mo.fn.modal.show({
				ctaLabel: "OK",
				title: "Error",
				class: "ark-modal",
				content: error,
			  });

			}
		  });
		} else {
		  error = "There is no <b>available email templates</b> for this Intake form.";
		  mo.fn.modal.show({
			ctaLabel: "OK",
			title: "Error",
			class: "ark-modal",
			content: error,
		  });
		}
	  });


	},
	initPopup: function(el, data, callback, height) {
	  var templ = `<div class="rep-popup">
<div class="rep-popup-container">
<section><input type="text" placeholder="Quick filter" data-name="search" /> </section>
<section><div class="separator"></div></section>
<section class="popup-vals"><ul></ul></section> 
  </div>    
  </div>`;

	  el.insertAdjacentHTML('afterend', templ);

	  if (height) {
		var item = el.closest(".fmmcosmin");
		var popup = item.querySelector(".rep-popup");
		popup.style.height = height + "px";
		popup.style.top = -height + "px";
	  }

	  var vals = el.parentNode.querySelector('ul');

	  data.forEach(function(elem) {

		if (elem && elem !== undefined) vals.innerHTML += '<li> ' + elem + '</li>';

	  });

	  el.addEventListener('click', function(ev) {
		var popup = ev.target.parentNode.querySelector('.rep-popup')
		if (ev.target.tagName == 'INPUT') {
		  if (document.querySelector('.popup-open')) {
			document.querySelector('.popup-open').classList.remove('popup-open');
		  }
		  popup.classList.add('popup-open');
		  popup.querySelector('[data-name="search"]').focus();
		}
		ev.stopPropagation();
		ev.preventDefault();
	  });

	  el.parentNode.querySelector('.popup-vals ul').addEventListener('click', function(ev) {
		if (ev.currentTarget.querySelector('.li-active')) ev.currentTarget.querySelector('.li-active').classList.remove('li-active');
		if (ev.target.tagName !== 'UL') {
		  var input;
		  input = ev.target.innerText;
		  if (input) el.value = input;
		  ev.target.classList.add('li-active');
		  el.parentNode.querySelector('.rep-popup').classList.remove('popup-open');
		}
		ev.preventDefault();
		ev.stopPropagation();
	  });
	  el.parentNode.querySelector('[data-name="search"]').addEventListener('input', function(ev) {
		el.parentNode.querySelector('ul').querySelectorAll('li').forEach(function(el) {
		  if (el.innerText.toUpperCase().includes(ev.target.value.toUpperCase())) {
			el.style.display = "block";
		  } else el.style.display = "none";

		});
	  })
	},
	dateDiffToString: function(a, b) {
	  let diff = Math.abs(a - b);

	  let ms = diff % 1000;
	  diff = (diff - ms) / 1000;
	  let s = diff % 60;
	  diff = (diff - s) / 60;
	  let m = diff % 60;
	  diff = (diff - m) / 60;
	  let h = diff;

	  let ss = s <= 9 && s >= 0 ? ("0" + s) : s;
	  let mm = m <= 9 && m >= 0 ? ("0" + m) : m;
	  let hh = h <= 9 && h >= 0 ? ("0" + h) : h;

	  return hh + ':' + mm + ':' + ss;
	},
	debounce: function(func, wait, immediate) {
	  var timeout;

	  return function executedFunction() {
		var context = this;
		var args = arguments;

		var later = function() {
		  timeout = null;
		  if (!immediate) func.apply(context, args);
		};

		var callNow = immediate && !timeout;

		clearTimeout(timeout);

		timeout = setTimeout(later, wait);

		if (callNow) func.apply(context, args);
	  };
	},
	buildFilterCombobox: function (grid, field, dataSource) {
	  const configureDataSource = function () {
		if (Array.isArray(dataSource)) {
		  return { dataSource };
		} else {
		  const { dataset, form, filter, dataTextField, dataValueField } = dataSource;
		  return ({
			dataSource: typeof dataset === 'string' ? new kendo.data.DataSource({
			  type: "rfb-v2",
			  serverSorting: true,
			  sort: {
				field: dataTextField,
				dir: "asc"
			  },
			  transport: {
				read: {
				  url: `/form/data-set-provider/v2/${form}/${dataset}/kendo/data/search`,
				  type: "POST",
				},
			  },
			}) : dataset,
			dataTextField,
			dataValueField,
			filter: filter || [],
		  });
		}
	  };
	  const comboboxFilter = function (element) {
		const dataSourceConfig = configureDataSource();
		element.kendoComboBox({
		  ...dataSourceConfig,
		  filter: "contains",
		});
	  };
	  const addFilterToGridConfig = function () {
		const grid_data = grid.data("kendoGrid");
		const column = grid_data.columns.find(el => el.field === field);
		if (column) {
		  column.filterable = {
			ui: comboboxFilter,
		  }
		  grid_data.setOptions({
			columns: grid_data.columns,
		  });
		}
	  };
	  addFilterToGridConfig();
	},
	customFieldsSearchPanel: function (container_id, search_id) {
	  // Original JavaScript code by Chirp Internet: chirpinternet.eu
	  // Please acknowledge use of this code by including this header.
	  function Hilitor2(id, tag) {
		// private variables
		var targetNode = document.getElementById(id) || document.body;
		var hiliteTag = tag || "MARK";
		var skipTags = new RegExp("^(?:" + hiliteTag + "|SCRIPT|FORM)$");
		var colors = ["#ff6", "#a0ffff", "#9f9", "#f99", "#f6f"];
		var wordColor = [];
		var colorIdx = 0;
		var matchRegExp = "";
		var openLeft = false;
		var openRight = false;
		var matches = [];

		this.setMatchType = function (type) {
		  switch (type) {
			case "open":
			  this.openLeft = this.openRight = true;
			  break;

			case "closed":
			  this.openLeft = this.openRight = false;
			  break;

			case "right":
			  this.openLeft = true;
			  this.openRight = false;
			  break;

			case "left":
			default:
			  this.openLeft = false;
			  this.openRight = true;
		  }
		  return true;
		};

		// break user input into words and convert to RegExp
		this.setRegex = function (input) {
		  input = input.replace(/\\u[0-9A-F]{4}/g, ""); // remove missed unicode
		  input = input.replace(/^\||\|$/g, "");
		  input = input.replace(/\(/,'\\(');
		  input = input.replace(/\)/,'\\)');

		  if (input) {
			var re = "(" + input + ")";
			if (!this.openLeft) {
			  re = "(?:^|[\\b\\s])" + re;
			}
			if (!this.openRight) {
			  re = re + "(?:[\\b\\s]|$)";
			}
			matchRegExp = new RegExp(re, "i");
			return matchRegExp;
		  }
		  return false;
		};

		// recursively apply word highlighting
		this.hiliteWords = function (node) {
		  if (node === undefined || !node) return;
		  if (!matchRegExp) return;
		  if (skipTags.test(node.nodeName)) return;

		  if (node.hasChildNodes()) {
			for (var i = 0; i < node.childNodes.length; i++)
			  this.hiliteWords(node.childNodes[i]);
		  }
		  const parentNode = node.parentNode;
		  if (
			node.nodeType == 3 &&
			(parentNode.tagName === "SPAN" || parentNode.tagName === "H4")
		  ) {
			// NODE_TEXT
			if ((nv = node.nodeValue) && (regs = matchRegExp.exec(nv))) {
			  if (!wordColor[regs[1].toLowerCase()]) {
				wordColor[regs[1].toLowerCase()] =
				  colors[colorIdx++ % colors.length];
			  }

			  var match = document.createElement(hiliteTag);
			  match.appendChild(document.createTextNode(regs[1]));
			  // match.style.backgroundColor = wordColor[regs[1].toLowerCase()];
			  match.style.backgroundColor = "#ff6";
			  match.style.color = "#000";

			  var after;
			  if (regs[0].match(/^\s/)) {
				// in case of leading whitespace
				after = node.splitText(regs.index + 1);
			  } else {
				after = node.splitText(regs.index);
			  }
			  after.nodeValue = after.nodeValue.substring(regs[1].length);
			  parentNode.insertBefore(match, after);

			  // header
			  if (
				parentNode.tagName === "H4" &&
				parentNode.parentNode.className === "heading"
			  ) {
				const row = $(node).closest(".row");
				$(row).find($("label.wrapper")).show();
				row.show();
			  }
			  // label
			  if (
				parentNode.tagName === "SPAN" &&
				parentNode.className === "name"
			  ) {
				$(node).closest("label.wrapper").show();
				$(node).closest(".row").show();
			  }
			}
		  }
		};

		// remove highlighting
		this.remove = function () {
		  var arr = document.getElementsByTagName(hiliteTag);
		  while (arr.length && (el = arr[0])) {
			var parent = el.parentNode;
			parent.replaceChild(el.firstChild, el);
			parent.normalize();
		  }
		  return true;
		};

		this.hide = function () {
		  $(`#${id} label.wrapper`).hide();
		  $(`#${id} .row`).hide();
		};

		this.show = function () {
		  $(`#${id} label.wrapper`).show();
		  $(`#${id} .row`).show();
		};

		// start highlighting at target node
		this.apply = function (input) {
		  this.remove();
		  this.hide();
		  if (input === undefined || !(input = input.replace(/(^\s+|\s+$)/g, ""))) {
			this.show();
			return;
		  }
		  input = escapeUnicode(input);
		  input = removeUnicode(input);
		  if (this.setRegex(input)) {
			this.hiliteWords(targetNode);
		  }

		  // build array of matches
		  matches = targetNode.getElementsByTagName(hiliteTag);

		  // return number of matches
		  return matches.length;
		};

		// convert escaped UNICODE to ASCII
		function removeUnicode(input) {
		  var retval = input;
		  retval = retval.replace(/\\u(00E[024]|010[23]|00C2)/gi, "a");
		  retval = retval.replace(/\\u00E7/gi, "c");
		  retval = retval.replace(/\\u00E[89AB]/gi, "e");
		  retval = retval.replace(/\\u(00E[EF]|00CE)/gi, "i");
		  retval = retval.replace(/\\u00F[46]/gi, "o");
		  retval = retval.replace(/\\u00F[9BC]/gi, "u");
		  retval = retval.replace(/\\u00FF/gi, "y");
		  retval = retval.replace(/\\u(00DF|021[89])/gi, "s");
		  retval = retval.replace(/\\u(0163i|021[AB])/gi, "t");
		  return retval;
		}

		// added by Yanosh Kunsh to include utf-8 string comparison
		function dec2hex4(textString) {
		  var hexequiv = new Array(
			"0",
			"1",
			"2",
			"3",
			"4",
			"5",
			"6",
			"7",
			"8",
			"9",
			"A",
			"B",
			"C",
			"D",
			"E",
			"F"
		  );
		  return (
			hexequiv[(textString >> 12) & 0xf] +
			hexequiv[(textString >> 8) & 0xf] +
			hexequiv[(textString >> 4) & 0xf] +
			hexequiv[textString & 0xf]
		  );
		}

		// escape UNICODE characters in string
		function escapeUnicode(str) {
		  // convertCharStr2jEsc
		  // Converts a string of characters to JavaScript escapes
		  // str: sequence of Unicode characters
		  var highsurrogate = 0;
		  var suppCP;
		  var pad;
		  var n = 0;
		  var outputString = "";
		  for (var i = 0; i < str.length; i++) {
			var cc = str.charCodeAt(i);
			if (cc < 0 || cc > 0xffff) {
			  outputString +=
				"!Error in convertCharStr2UTF16: unexpected charCodeAt result, cc=" +
				cc +
				"!";
			}
			if (highsurrogate != 0) {
			  // this is a supp char, and cc contains the low surrogate
			  if (0xdc00 <= cc && cc <= 0xdfff) {
				suppCP = 0x10000 + ((highsurrogate - 0xd800) << 10) + (cc - 0xdc00);
				suppCP -= 0x10000;
				outputString +=
				  "\\u" +
				  dec2hex4(0xd800 | (suppCP >> 10)) +
				  "\\u" +
				  dec2hex4(0xdc00 | (suppCP & 0x3ff));
				highsurrogate = 0;
				continue;
			  } else {
				outputString +=
				  "Error in convertCharStr2UTF16: low surrogate expected, cc=" +
				  cc +
				  "!";
				highsurrogate = 0;
			  }
			}
			if (0xd800 <= cc && cc <= 0xdbff) {
			  // start of supplementary character
			  highsurrogate = cc;
			} else {
			  // this is a BMP character
			  switch (cc) {
				case 0:
				  outputString += "\\0";
				  break;
				case 8:
				  outputString += "\\b";
				  break;
				case 9:
				  outputString += "\\t";
				  break;
				case 10:
				  outputString += "\\n";
				  break;
				case 13:
				  outputString += "\\r";
				  break;
				case 11:
				  outputString += "\\v";
				  break;
				case 12:
				  outputString += "\\f";
				  break;
				case 34:
				  outputString += '\\"';
				  break;
				case 92:
				  outputString += "\\\\";
				  break;
				default:
				  if (cc > 0x1f && cc < 0x7f) {
					outputString += String.fromCharCode(cc);
				  } else {
					pad = cc.toString(16).toUpperCase();
					while (pad.length < 4) {
					  pad = "0" + pad;
					}
					outputString += "\\u" + pad;
				  }
			  }
			}
		  }
		  return outputString;
		}
	  }
	  var hilitor = new Hilitor2(container_id);
	  hilitor.setMatchType("open");
	  var matches = 0;
	  var container = document.getElementById(container_id);
	  var searchEl = document.getElementById(search_id);		  
	  var searchTrigger = function (e) {
		matches = hilitor.apply(searchEl.value);
	  };
	  searchEl.addEventListener("keyup", searchTrigger, false);
	},
  }
</script>

<!-- LOCALIZATION MODULE -->
<script>
  const localization = {
	data: {},
	holder: function() {
	  return document.querySelector('#navigation #localization:last-child')
	},
	html: function() {
	  return "<div id='localization'><div class='localization'></div></div>";
	},
	init: function() {
	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });
	  localization.getData(function() {

		navigation.push(localization.html());
		localization._ui();

		recentlyViewed.add({
		  Module: 'Localization',
		  Id: null,
		}, function() {});
		mo.fn.overlay.hide();
	  });
	},
	_ui: function() {
	  hpe.ui.tabs({
		dom: localization.holder().querySelector('.localization'),
		tabs: [{
		  label: "Ark external",
		  id: "ark_external"
		},
			   {
				 label: "Emails",
				 id: "email_reminders"
			   }
			  ]
	  }, function(all) {
		localization.arkExternal.init(all[0]);
		localization.holder().querySelector('span[tab-id="ark_external"]').addEventListener('click', function() {
		  localization.arkExternal.init(all[0]);
		});

		localization.holder().querySelector('span[tab-id="email_reminders"]').addEventListener('click', function() {
		  localization.emailReminders.init(all[1]);
		});
	  });
	},
	arkExternal: {
	  init: function(node, callback) {
		node.innerHTML = "<section class='grid'></section><div class='toolbar'></div>";
		var filterArk = {
		  logic: "and",
		  filters: [{
			field: "Group",
			operator: "neq",
			value: 'EmailReminder'
		  }, {
			field: "Group",
			operator: "neq",
			value: 'Emails'
		  }, ]
		};

		localization.grid._load(node, localization.arkExternal.dataSource(filterArk), localization.grid._config());
	  },
	  dataSource: function(filter) {

		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1274/ARK_Localization/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  /* set page size*/
		  serverFiltering: true,
		  filter: filter,
		  serverSorting: true,
		  /* set default sort */
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		});

	  },
	},
	emailReminders: {
	  init: function(node, callback) {
		node.innerHTML = "<section class='grid'></section><div class='toolbar'></div>";
		var filterEmail = {
		  logic: "or",
		  filters: [{
			field: "Group",
			operator: "eq",
			value: 'EmailReminder'
		  },
					{
					  field: "Group",
					  operator: "eq",
					  value: 'Emails'
					}
				   ]
		};
		localization.grid._load(node, localization.emailReminders.dataSource(filterEmail), localization.grid._config(), true);
	  },
	  dataSource: function(filter) {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1274/ARK_Localization/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  /* set page size*/
		  serverFiltering: true,
		  filter: filter,
		  serverSorting: true,
		  /* set default sort */
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		});

	  },
	},
	_softRefresh: function() {
	  var g = localization.currentGrid;
	  g.refresh();
	},
	getData: function(callback) {
	  crud.read('3895', "Group=ServiceKey", function(d) {
		localization.data = d.Rows;
		callback();
	  });
	},
	create: function(data, callback) {
	  crud.read("3689", "key=" + data.Key, function(d) {
		try {
		  if (d.Rows.length > 0) {
			mo.fn.modal.msg("A language key already exists with the key provided in the form; please provide a unique key or edit the existing key", 3);
			mo.fn.modal.unlock();
		  } else {
			crud.create("3687", data, function(d) {
			  try {
				// mo.fn.modal.msg("Language key was succesfully created (" + d.EntryId + ")", 1);
				callback();
				// PUSH TO DATA                                                
				localization.currentGrid.dataSource.insert(0, d);
				localization._softRefresh();
				mo.fn.modal.unlock();
				mo.fn.modal.hide();
			  } catch (err) {
				mo.fn.modal.msg("An error occurred writing to the database. Please try again later.", 3);
				mo.fn.modal.unlock();
			  }
			});
		  }
		} catch (err) {
		  console.error(err);
		  mo.fn.modal.msg("An error occurred when accessing the language database. Please try again later.", 3);
		  mo.fn.modal.unlock();
		}
	  });
	},
	update: function(eid, data) {
	  crud.update("3688", eid, data, function(d) {
		if (typeof(d.EntryId) !== "undefined") {
		  localization.currentGrid.dataSource.pushUpdate(d);
		  localization._softRefresh();
		  mo.fn.modal.unlock();
		  mo.fn.modal.hide();
		} else {
		  mo.fn.modal.msg("An error occured when writing to the database. Please try again later.", 3);
		  mo.fn.modal.unlock();
		  mo.fn.modal.hide();
		}
	  });
	},
	modal: {
	  show: function(type, data, expanded) {
		//show modal window to add/edit localizations keys
		console.log(data);
		if (type == "add") {
		  var ctalabel = "CREATE";
		  var modtitle = "Create language key";
		} else {
		  var ctalabel = "SAVE";
		  var modtitle = "Edit language key";
		}
		mo.fn.modal.show({
		  ctaLabel: ctalabel,
		  title: modtitle,
		  class: "ark-modal",
		  content: '<div class="localization_modal" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.msg').classList.remove("err");
			// document.querySelector('msg').classList.remove("scs");
			hpe.ui.tabs({
			  dom: document.querySelector(".localization_modal"),
			  tabs: [{
				label: "IDS",
				id: "ids"
			  },
					 {
					   label: "AMS",
					   id: "ams"
					 },
					 {
					   label: "EMEA",
					   id: "emea"
					 },
					 {
					   label: "APJ",
					   id: "apj"
					 }
					]
			}, function(all) {

			  localization.modal.idsConfig(all[0], data);
			  if (type == 'edit') {
				document.querySelector('input[data-name="Key"').disabled = true;
				document.querySelector('input[data-name="Group"').disabled = true;
			  }
			  localization.modal.amsConfig(all[1], data, expanded);
			  localization.modal.emeaConfig(all[2], data, expanded);
			  localization.modal.apjConfig(all[3], data, expanded);

			});
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			})
		  },
		  ctaCallback: function() {
			// HELPERS
			var sel = document.querySelector(".dxpModalContent");
			var def = {
			  Key: "",
			  Group: "",
			  en_US: "",
			  es_MX: "",
			  fr_CA: "",
			  pt_BR: "",
			  in_ID: "",
			  ja_JP: "",
			  ko_KR: "",
			  th_TH: "",
			  vi_VN: "",
			  zh_CN: "",
			  zh_TW: "",
			  ar_AE: "",
			  cz_CH: "",
			  es_ES: "",
			  de_DE: "",
			  fr_FR: "",
			  gr_GR: "",
			  he_IL: "",
			  hu_HU: "",
			  it_IT: "",
			  pl_PL: "",
			  pt_PT: "",
			  ro_RO: "",
			  ru_RU: "",
			  sk_SK: "",
			  tr_TR: "",
			  ms_MY: ""
			};
			var cnt = 0;

			for (i = 0; i < Object.keys(def).length; i++) {
			  var key = Object.keys(def)[i];

			  var input = sel.querySelector("input[data-name=" + key + "], textarea[data-name=" + key + "]");
			  def[key] = input.value;
			  if ((key == "Key" || key == "Group") && (def[key] == '' || def[key] == undefined)) {
				mo.fn.modal.msg("Please provide all the required information in the form", 3);
				return;
			  }
			  //if (def[key].length == 0) cnt++;
			}


			// UPDATE DATABASE
			mo.fn.modal.lock();
			if (type == "add") {

			  if (cnt > 0) {
				mo.fn.modal.msg("Please provide all the required information in the form", 3);
				mo.fn.modal.unlock();
			  } else {

				localization.create(def, function() {
				  var inputs = sel.querySelectorAll("input");
				  for (i = 0; i < inputs.length; i++)
					inputs[i].value = "";
				});
			  }
			} else if (type == "edit") {
			  var eid = data.EntryId;
			  localization.update(eid, def);
			}
		  }
		});

	  },
	  idsConfig: function(node, data) {
		node.innerHTML = '<div class="ids"></div>';
		var conf = {
		  dom: document.querySelector('.ids'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Key ID",
				  data: "Key",
				  required: true,
				  type: "text",
				  value: data && data.Key ? data.Key : null,
				  placeholder: "Provide the unique key id",
				  validation: ["minLen|1", "maxLen|255", "noBlanks"],

				},
				 {
				   label: "Group ID",
				   data: "Group",
				   required: true,
				   value: data && data.Group ? data.Group : null,
				   type: "text",
				   placeholder: "Provide the group id",
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 }
				]
			  ]
			}]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },
	  amsConfig: function(node, data, expanded) {
		node.innerHTML = '<div class="ams"></div>';
		var conf = {
		  dom: document.querySelector('.ams'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "English (US)",
				  data: "en_US",
				  required: false,
				  type: expanded ? "textarea" : "text",
				  value: data && data.en_US ? data.en_US : null,
				  placeholder: "",
				  validation: ["minLen|1", "maxLen|4000"]
				},
				 {
				   label: "LAR Spanish",
				   data: "es_MX",
				   required: false,
				   value: data && data.es_MX ? data.es_MX : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "French (Canada)",
				   data: "fr_CA",
				   required: false,
				   value: data && data.fr_CA ? data.fr_CA : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Portuguese (Brazil)",
				   data: "pt_BR",
				   required: false,
				   value: data && data.pt_BR ? data.pt_BR : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 }
				]
			  ]
			}]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },
	  emeaConfig: function(node, data, expanded) {
		node.innerHTML = '<div class="emea"></div>';
		var conf = {
		  dom: document.querySelector('.emea'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Arabic",
				  data: "ar_AE",
				  required: false,
				  value: data && data.ar_AE ? data.ar_AE : null,
				  type: expanded ? "textarea" : "text",
				  placeholder: "",
				  validation: ["minLen|1", "maxLen|4000"]
				},
				 {
				   label: "Czech",
				   data: "cz_CH",
				   required: false,
				   value: data && data.cz_CH ? data.cz_CH : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "German",
				   data: "de_DE",
				   required: false,
				   value: data && data.de_DE ? data.de_DE : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Spanish (Spain)",
				   data: "es_ES",
				   required: false,
				   value: data && data.es_ES ? data.es_ES : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "French",
				   data: "fr_FR",
				   required: false,
				   value: data && data.fr_FR ? data.fr_FR : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Greek",
				   data: "gr_GR",
				   required: false,
				   value: data && data.gr_GR ? data.gr_GR : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Hebrew",
				   data: "he_IL",
				   required: false,
				   value: data && data.he_IL ? data.he_IL : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Hungarian",
				   data: "hu_HU",
				   required: false,
				   value: data && data.hu_HU ? data.hu_HU : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Italian",
				   data: "it_IT",
				   required: false,
				   value: data && data.it_IT ? data.it_IT : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Polish",
				   data: "pl_PL",
				   required: false,
				   value: data && data.pl_PL ? data.pl_PL : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Portuguese",
				   data: "pt_PT",
				   required: false,
				   value: data && data.pt_PT ? data.pt_PT : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Romanian",
				   data: "ro_RO",
				   required: false,
				   value: data && data.ro_RO ? data.ro_RO : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Russian",
				   data: "ru_RU",
				   required: false,
				   type: expanded ? "textarea" : "text",
				   value: data && data.ru_RU ? data.ru_RU : null,
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Slovak",
				   data: "sk_SK",
				   required: false,
				   type: expanded ? "textarea" : "text",
				   value: data && data.sk_SK ? data.sk_SK : null,
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Turkish (Turkey)",
				   data: "tr_TR",
				   required: false,
				   value: data && data.tr_TR ? data.tr_TR : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 }
				]
			  ]
			}]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },
	  apjConfig: function(node, data, expanded) {
		node.innerHTML = '<div class="apj"></div>';
		var conf = {
		  dom: document.querySelector('.apj'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Indonesian (Indonesia)",
				  data: "in_ID",
				  required: false,
				  type: expanded ? "textarea" : "text",
				  value: data && data.in_ID ? data.in_ID : null,
				  placeholder: "",
				  validation: ["minLen|1", "maxLen|4000"]
				},
				 {
				   label: "Japanese (Japan)",
				   data: "ja_JP",
				   required: false,
				   type: expanded ? "textarea" : "text",
				   value: data && data.ja_JP ? data.ja_JP : null,
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Korean (South Korea)",
				   data: "ko_KR",
				   required: false,
				   value: data && data.ko_KR ? data.ko_KR : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Thai",
				   data: "th_TH",
				   required: false,
				   value: data && data.th_TH ? data.th_TH : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Vietnamese",
				   data: "vi_VN",
				   required: false,
				   value: data && data.vi_VN ? data.vi_VN : null,
				   type: expanded ? "textarea" : "text",
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Chinese (Simplified)",
				   data: "zh_CN",
				   required: false,
				   type: expanded ? "textarea" : "text",
				   value: data && data.zh_CN ? data.zh_CN : null,
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Chinese (Traditional)",
				   data: "zh_TW",
				   required: false,
				   type: expanded ? "textarea" : "text",
				   value: data && data.zh_TW ? data.zh_TW : null,
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 },
				 {
				   label: "Malay",
				   data: "ms_MY",
				   required: false,
				   type: expanded ? "textarea" : "text",
				   value: data && data.ms_MY ? data.ms_MY: null,
				   placeholder: "",
				   validation: ["minLen|1", "maxLen|4000"]
				 }
				]
			  ]
			}]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },
	  email: function() {
		var conf = '';
		mo.fn.modal.show({
		  ctaLabel: 'Send email',
		  title: 'Send email',
		  class: "ark-modal",
		  content: '<div class="send_em" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {

			var emails = [...reference.translations.groups.EmailReminder, ...reference.translations.groups.Emails]

			conf = {
			  dom: document.querySelector('.send_em'),
			  pages: [{
				nav: false,
				structure: [{
				  group: [
					[{
					  label: "Localization:",
					  data: "Localization",
					  type: "select",
					  required: true,
					  value: 'en_US',
					  validation: ["inArray"],
					  options: singleCompanyDetails.sendInvitation.localization.map(el => el.option),
					  values: singleCompanyDetails.sendInvitation.localization.map(el => el.value)
					},
					 {
					   label: "Template",
					   data: "templateId",
					   type: "select",
					   required: true,
					   value: null,
					   options: emails.map(x => x.Key),
					   values: emails.map(x => x.Key),
					   validation: ["inArray"],
					 },
					 {
					   label: "Email",
					   data: "Email",
					   required: true,
					   value: null,
					   type: "text",
					   placeholder: "Email",
					   validation: ["minLen|1", "maxLen|100", "noBlanks"]
					 },
					]
				  ]
				}]
			  }],
			  dataset: {},
			};
			nbsf.init(conf, 0);
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			})
		  },
		  ctaCallback: function() {

			crud.read(3689, "key=" + conf.dataset.templateId, function(d) {
			  crud.read(3689, "key=" + conf.dataset.templateId + " Subject", function(s) {
				if (d && d.Rows.length > 0) {
				  var subject = "Test";
				  if (s && s.Rows.length)
					subject = s.Rows[0][conf.dataset.Localization];

				  mail.send({
					"ID": "ARK_TEST_EMAIL",
					"To": conf.dataset.Email,
					"Subject": subject,
					"Big1": d.Rows[0][conf.dataset.Localization],
				  });
				}
			  });
			});


			mo.fn.modal.hide();
		  }
		});
	  },
	},
	grid: {
	  _custom: function() {
		var cusConfig = [{
		  field: "Key",
		  title: "Key ID",
		  hidden: false,
		  locked: true,
		  width: "300px"
		},
						 {
						   field: "Group",
						   title: "Key groups",
						   hidden: false,
						   locked: true,
						   width: "300px"
						 },
						 {
						   field: "EntryId",
						   hidden: true
						 },
						 {
						   field: "Created",
						   hidden: true
						 },
						 {
						   field: "CreatedBy",
						   hidden: true
						 },
						 {
						   field: "Modified",
						   hidden: true
						 },
						 {
						   field: "ModifiedBy",
						   hidden: true
						 },
						 {
						   title: "",
						   width: "75px",
						   locked: true,
						   attributes: {
							 "class": "cta"
						   },
						   template: function(d) {
							 var icons = '<a class="edit"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></a>';
							 if (!access.user.UserRole.Readonly) return icons;
							 else return '';
						   }
						 }
						];
		return cusConfig;
	  },
	  _default: function() {
		var defConfig = [];
		var keys = Object.keys(localization.data[0]);

		for (i = 0; i < keys.length; i++) {
		  var key = keys[i];
		  var obj = {};
		  obj.field = key;
		  obj.title = key;
		  obj.hidden = false;
		  obj.filterable = true;
		  obj.width = "250px";
		  obj.attributes = {
			style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
		  };
		  if (key == "en_US")
			defConfig.unshift(obj);
		  else
			defConfig.push(obj);
		}
		return defConfig;
	  },
	  _config: function() {
		var cusConfig = localization.grid._custom();
		var defConfig = localization.grid._default();
		for (j = cusConfig.length - 1; j >= 0; j--) {
		  for (i = 0; i < defConfig.length; i++) {
			if (defConfig[i].field == cusConfig[j].field) {
			  defConfig.splice(i, 1);
			  break;
			}
		  }
		}
		for (i = cusConfig.length - 1; i >= 0; i--) {
		  defConfig.unshift(cusConfig[i]);
		}
		return defConfig;
	  },
	  _load: function(selector, datasource, config, expand) {
		var toolbar = [{
		  name: "add",
		  text: "Add key"
		}, {
		  name: 'send_email',
		  text: "Send email"
		}];
		$(selector).find('.grid').kendoGrid({
		  toolbar: !access.user.UserRole.Readonly ? toolbar : '',
		  dataSource: datasource,
		  columns: config,
		  dataBound: function(e) {},
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  resizable: true,
		});

		localization.currentGrid = $(selector).find('.grid').data("kendoGrid");

		$(selector).find('.k-grid-toolbar').appendTo($(selector).parent().find('.toolbar'));

		$(selector).delegate(".edit", "click", function(e) {
		  var grid = $(selector).find('.grid').data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  localization.modal.show("edit", row, expand);
		});
		$(selector).find(".k-grid-add").on("click", function(e) {
		  localization.modal.show("add", null, expand);
		});
		$(selector).find(".k-grid-send_email").on("click", function(e) {
		  localization.modal.email();
		});
	  }
	}
  };
</script>

<!-- COUNTRIES MODULE -->
<script>
  const countries = {
	holder: function() {
	  return document.querySelector('#navigation #countries:last-child')
	},

	html: function() {
	  return "<div id='countries' class='countries'><div id='countriesContainer'></div></div>";
	},

	init: function() {
	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });
	  navigation.push(countries.html());
	  recentlyViewed.add({
		Module: 'Countries',
		Id: null,
	  }, function() {});
	  countries.configs.init(function() {
		countries.ui.grid.load(countries.holder().querySelector("#countriesContainer"));
		mo.fn.overlay.hide();
	  });
	},
	ui: {
	  grid: {
		dataSource: function(selector) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1288/ARK_Countries/kendo/data/search",
				type: 'POST'
			  }
			},
			schema: {
			  model: {
				id: "EntryId",
				fields: {
				  CountryCPI: {
					editable: true,
					nullable: true,
					type: "number",
					validation: {
					  min: 0
					}
				  },
				  Name: {
					editable: false
				  },
				  Region: {
					editable: false
				  },
				  CountryCode: {
					editable: false
				  },
				  MAP: {
					editable: false
				  },
				  Eligible: {
					editable: false
				  }

				}
			  }
			},
			serverPaging: true,
			pageSize: 10,
			serverFiltering: true,
			serverSorting: true,
			sort: {
			  field: "Name",
			  dir: "asc"
			}
		  });
		},
		load: function(selector) {
		  var grid = $(selector);
		  grid.kendoGrid({
			height: 600,
			pageable: {
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			dataSource: countries.ui.grid.dataSource(selector),
			columns: [{
			  field: "Name",
			  title: "Name"
			},
					  {
						field: "Region",
						title: "Region",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},
					  },
					  {
						field: "CountryCode",
						title: "Code",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},
					  },
					  {
						field: "Eligible",
						title: "Eligible",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},
					  },
					  {
						field: "MAP",
						title: "MAP",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},
					  },
					  {
						field: "CountryCPI",
						title: "CPI",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},

					  },
					  {
						template: function(d) {
						  return `
${!access.user.UserRole.Readonly ? `<span class='customEdit'>
<svg version='1.1' viewBox='0 0 24 24' role='img' aria-label='edit' width='24px' height='24px'>
<path fill='none' stroke='#666' stroke-width='2' d='M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9'>
  </path>
  </svg>
  </span> `: '' }
<div class="updateCancelContainer" style="display: none;">
<div class='customUpdate'>
<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="checkmark" width="28px" height="28px">
<polyline fill="none" stroke="#666" stroke-width="2" points="2 14 9 20 22 4">
  </polyline>
  </svg>
  </div>
<div class='customCancel' style="margin-left: 15px;">
<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="clear" width="28px" height="28px">
<path fill="none" stroke="#666" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M5,5 L19,19">
  </path>
  </svg>
  </div>
  </div>
`;
						},
						width: "100px"
					  }
					 ],
			editable: "inline",
			detailInit: function(e) {

			  var countryItem = e.data;
			  var data = [];
			  var configData = countries.configs.data;
			  var riskModel = null;

			  //PARSE VALUES FROM RISK MODEL AND APPLY THEM TO EACH CONFIG FOR THiS COUNTRY
			  if (e.data.RiskModel)
				riskModel = JSON.parse(e.data.RiskModel);

			  for (var i = 0; i < configData.length; i++)
				data.push({
				  EntryId: configData[i].EntryId,
				  ConfigName: configData[i].ConfigName,
				  ConfigId: configData[i].ConfigId,
				  Version: configData[i].Version,
				  Score: undefined,
				});

			  if (riskModel) {
				var keys = Object.keys(riskModel);
				for (var i = 0; i < data.length; i++)
				  for (var j = 0; j < keys.length; j++)
					if (keys[j] == data[i].ConfigId)
					  data[i].Score = riskModel[keys[j]];
			  }

			  //INIT DETAIL GRID
			  var gridConfigs = $("<div/>").appendTo(e.detailCell);
			  gridConfigs.kendoGrid({
				dataSource: new kendo.data.DataSource({
				  data: data,
				  schema: {
					model: {
					  id: "EntryId",
					  fields: {
						EntryId: {
						  editable: false
						},
						ConfigName: {
						  editable: false
						},
						Version: {
						  editable: false
						},
						Score: {
						  editable: true,
						  nullable: true,
						  type: "number",
						  validation: {
							min: 0
						  }
						}
					  }
					}
				  }
				}),
				scrollable: false,
				sortable: true,
				pageable: false,
				columns: [{
				  field: "EntryId",
				  title: "ID",
				  width: "110px"
				},
						  {
							field: "ConfigName",
							title: "Intake Form"
						  },
						  {
							field: "Version",
							title: "Version",
							width: "200px"
						  },
						  {
							field: "Score",
							title: "Score Overrides",
							width: "150px",
							number: true
						  },
						  {
							template: function(d) {
							  return `
${!access.user.UserRole.Readonly ? `<span class='customEdit'>
<svg version='1.1' viewBox='0 0 24 24' role='img' aria-label='edit' width='24px' height='24px'>
<path fill='none' stroke='#666' stroke-width='2' d='M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9'>
  </path>
  </svg>
  </span> `: '' }
<div class="updateCancelContainer" style="display: none;" >
<div class='customUpdate'>
<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="checkmark" width="28px" height="28px">
<polyline fill="none" stroke="#666" stroke-width="2" points="2 14 9 20 22 4">
  </polyline>
  </svg>
  </div>
<div class='customCancel' style="margin-left: 15px;">
<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="clear" width="28px" height="28px">
<path fill="none" stroke="#666" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M5,5 L19,19">
  </path>
  </svg>
  </div>
  </div>
`;
							},
							width: "100px"
						  }
						 ],
				editable: "inline",
				save: function(e) {


				}
			  });

			  gridConfigs.on("click", ".customEdit", function(e) {
				var row = $(this).closest("tr");
				$(gridConfigs).data("kendoGrid").editRow(row);
				row[0].querySelector(".updateCancelContainer").style.display = "flex";
				row[0].querySelector(".customEdit").hidden = true;
			  });

			  gridConfigs.on("click", ".customCancel", function(e) {
				var row = $(this).closest("tr");
				row[0].querySelector(".updateCancelContainer").style.display = "none";
				row[0].querySelector(".customEdit").hidden = false;
				$(gridConfigs).data("kendoGrid").cancelChanges();
			  });

			  gridConfigs.on("click", ".customUpdate", function(e) {
				var row = $(this).closest("tr");

				//GET CHANGED DATAITEM
				var riskModelItem = $(gridConfigs).data("kendoGrid").dataItem(row);

				//UPDATE RISK MODEL PROPERTY 
				var riskModel = {};

				if (countryItem.RiskModel)
				  riskModel = JSON.parse(countryItem.RiskModel);

				var found = false;
				var keys = Object.keys(riskModel);
				for (var i = 0; i < keys.length; i++) {
				  if (keys[i] == riskModelItem.ConfigId) {
					riskModel[keys[i]] = riskModelItem.Score;
					found = true;
					break;
				  }
				}

				if (!found)
				  riskModel[riskModelItem.ConfigId] = riskModelItem.Score;

				countryItem.RiskModel = JSON.stringify(riskModel);

				//RESET UI
				row[0].querySelector(".updateCancelContainer").style.display = "none";
				row[0].querySelector(".customEdit").hidden = false;

				$(gridConfigs).data("kendoGrid").refresh();

				//SAVE DATA
				mo.fn.overlay.show({
				  close: false,
				  loading:true
				});
				crud.update("3708", countryItem.EntryId, {
				  RiskModel: countryItem.RiskModel
				}, function(d) {
				  if (!d || !d.EntryId)
					mo.fn.modal.show({
					  ctaLabel: "Ok",
					  class: "ark-modal",
					  title: "Error",
					  content: '<div>Could not save data. Please try again</div>',
					});



				  mo.fn.overlay.hide();
				});

			  });
			}
		  });

		  grid.on("click", ".customEdit", function(e) {
			var row = $(this).closest("tr");
			$(selector).data("kendoGrid").editRow(row);
			row[0].querySelector(".updateCancelContainer").style.display = "flex";
			row[0].querySelector(".customEdit").hidden = true;
		  });

		  grid.on("click", ".customCancel", function(e) {
			var row = $(this).closest("tr");
			row[0].querySelector(".updateCancelContainer").style.display = "none";
			row[0].querySelector(".customEdit").hidden = false;
			$(selector).data("kendoGrid").cancelChanges();
		  });

		  grid.on("click", ".customUpdate", function(e) {
			var row = $(this).closest("tr");
			var item = $(selector).data("kendoGrid").dataItem(row);
			row[0].querySelector(".updateCancelContainer").style.display = "none";
			row[0].querySelector(".customEdit").hidden = false;
			$(selector).data("kendoGrid").refresh();

			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
			crud.update("3708", item.EntryId, {
			  CountryCPI: item.CountryCPI
			}, function(d) {
			  if (!d || !d.EntryId)
				mo.fn.modal.show({
				  ctaLabel: "Ok",
				  class: "ark-modal",
				  title: "Error",
				  content: '<div>Could not save data. Please try again</div>',
				});

			  mo.fn.overlay.hide();
			});
		  });
		}

	  }
	},
	configs: {
	  data: [],
	  init: function(callback) {
		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1279/ARK_Configs_MetaData/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId"
			}
		  },
		  serverPaging: false,
		  serverFiltering: true,
		  filter: {
			field: "Status",
			operator: "eq",
			value: 1
		  }
		});

		dataSource.read().then(function() {
		  countries.configs.data = dataSource.view();
		  callback();
		});
	  }
	}
  }
</script>

<!-- USERS MODULE -->
<script>
  const users = {
	config: {},
	holder: function() {
	  return document.querySelector('#navigation #users:last-child')
	},
	html: function() {
	  return "<div id='users'><div class='users'></div><div class='toolbar'></div></div>";
	},
	init: function() {
	  mo.fn.overlay.show({
		close: false,
		loading:true
	  });
	  navigation.push(users.html());
	  users.getConfig();
	  users._ui();
	  recentlyViewed.add({
		Module: 'Users',
		Id: null,
	  }, function() {});
	  mo.fn.overlay.hide();
	},
	getConfig: function() {
	  crud.read('3780', 'Application=Ark&Status=1', function(d) {
		d.Rows.forEach(function(e) {
		  users.config[e.ConfigName] = false;
		});
	  });
	},
	_softRefresh: function() {
	  var g = $(".users .k-grid").data("kendoGrid");
	  g.refresh();
	},
	_ui: function() {
	  hpe.ui.tabs({
		dom: users.holder().querySelector(".users"),
		tabs: [{
		  label: "Users",
		  id: "users"
		}]
	  }, function(all) {
		users.grid._load(all[0], users.data, users.grid._config());
	  });
	},
	create: function(email, sel, roles) {
	  crud.read("2493", "Email=" + email.value + "&Source=Ark", function(d) {
		try {
		  if (d.Rows.length > 0) {
			mo.fn.modal.msg("A user already exists with this email address", 3);
			mo.fn.modal.unlock();
		  } else {
			crud.create("2495", {
			  Email: email.value,
			  FirstName: sel.querySelector("input[data-name=FirstName]").value,
			  LastName: sel.querySelector("input[data-name=LastName]").value,
			  Source: "Ark",
			  UserRole: JSON.stringify(roles)
			}, function(d) {
			  try {
				sel.querySelector("input[data-name=FirstName]").value = "";
				$(".users .k-grid").data("kendoGrid").dataSource.insert(0, d);
				users._softRefresh();
				mo.fn.modal.unlock();
				mo.fn.modal.hide();
			  } catch (err) {
				mo.fn.modal.msg("An error occurred writing to the database. Please try again later.", 3);
				mo.fn.modal.unlock();
			  }
			});
		  }
		} catch (err) {
		  console.error(err);
		  mo.fn.modal.msg("An error occurred when accessing the user database. Please try again later.", 3);
		  mo.fn.modal.unlock();
		}
	  });
	},
	update: function(eid, email, sel, roles) {
	  crud.update("3255", eid, {
		Email: sel.querySelector("input[data-name=Email]").value,
		FirstName: sel.querySelector("input[data-name=FirstName]").value,
		LastName: sel.querySelector("input[data-name=LastName]").value,
		UserRole: JSON.stringify(roles)
	  }, function(d) {
		if (typeof(d.EntryId) !== "undefined") {
		  $(".users .k-grid").data("kendoGrid").dataSource.pushUpdate(d);
		  users._softRefresh();
		  mo.fn.modal.hide();
		  mo.fn.modal.unlock();
		} else {
		  mo.fn.modal.msg("An error occured when writing to the database. Please try again later.", 3);
		  mo.fn.modal.unlock();
		}
	  });
	},
	modal: {
	  html: function() {
		return '<div class="users_modal" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>'
	  },
	  show: function(type, data) {
		//show modal window to add/edit users keys	 
		if (type == "add") {
		  var ctalabel = "CREATE";
		  var modtitle = "Create user profile";
		} else {
		  var ctalabel = "SAVE";
		  var modtitle = "Edit user profile";
		  if (data && data.UserRole && typeof data.UserRole == 'string') data.UserRole = JSON.parse(data.UserRole);
		  var userRoles = data.UserRole;
		  var aux = {
			BU: {}
		  };
		  Object.entries(userRoles).forEach(function([key, value]) {
			if (typeof value == 'object') {
			  Object.entries(value).forEach(function([k, v]) {
				if (Array.isArray(v)) {
				  aux[key][k] = v.join(',');
				} else {
				  if (v == true) {
					aux[key] += ',' + k;
				  }
				}
			  });
			} else aux[key] = value == false ? value = 'N' : value = 'Y';
		  });
		}
		mo.fn.modal.show({
		  ctaLabel: ctalabel,
		  title: modtitle,
		  class: "ark-modal",
		  content: users.modal.html(),
		  contentCallback: function() {
			document.querySelector('.msg').classList.remove("err");
			hpe.ui.tabs({
			  dom: document.querySelector(".dxpModalContent .users_modal"),
			  tabs: [{
				label: "Personal details",
				id: "personal_details"
			  },
					 {
					   label: "Ark roles",
					   id: "ark_roles"
					 },
					 {
					   label: "Operational",
					   id: "operational"
					 },
					 /* {
                                           label: "Business",
                                           id: "business"
                                         },*/
					]
			}, function(all) {
			  users.modal.personalConfig(all[0], data, aux);
			  users.modal.arkRolesConfig(all[1], data, aux);
			  users.modal.operationalConfig(all[2], data, aux);
			  //users.modal.businessConfig(all[3], data, aux);

			  //Hide ark roles
			  document.querySelector('span[tab-id="ark_roles"]').style.visibility = 'hidden';
			  document.querySelector('span[tab-id="ark_roles"]').style.width = "0";
			  document.querySelector('span[tab-id="ark_roles"]').style.padding = "0";
			  document.querySelector('span[tab-id="ark_roles"]').style.margin = "0";

			  document.querySelector('.wrapper.toggle').style.margin = "20px 0";

			  var admin = document.querySelector('.dxpModalContent input[data-name=ADMIN]');
			  var readOnly = document.querySelector('.dxpModalContent input[data-name=Readonly]');
			  var tabs = document.querySelectorAll(".users_modal div[tab-id]");
			  if (admin.value == 'Y') {
				for (var i = 0; i < tabs.length; i++) {
				  var arr = tabs[i].querySelectorAll('input, select');
				  if (arr && arr.length) {
					arr.forEach(function(el) {
					  if (el.tagName == 'SELECT') {
						el.disabled = true;
						var options = el.getElementsByTagName("option");
						Array.from(options).forEach(function(e) {
						  e.selected = true;
						});
					  }
					  /*  else if (el.tagName == 'INPUT' && el.type !== 'text') {
                              el.closest("label").classList.add("active");
                              el.value = "Y";
                              if (el.getAttribute('name') !== 'ADMIN' && el.getAttribute('name') !== 'ACTIVE' && el.getAttribute('name') !== 'Readonly') {
                                if( el.closest("label ~ .toggle") &&  el.closest("label ~ .toggle").length)  el.closest("label ~ .toggle").classList.add('toggle--disabled');
                              }
                            }; */
					});
				  }
				}
			  }
			  admin.closest("label").addEventListener('click', function(ev) {
				if (this.getAttribute('class') == 'active') {
				  for (var i = 0; i < tabs.length; i++) {
					var arr = tabs[i].querySelectorAll('input, select');
					arr.forEach(function(el) {
					  if (el.tagName == 'SELECT') {
						el.disabled = true;
						var options = el.getElementsByTagName("option");
						Array.from(options).forEach(function(e) {
						  e.selected = true;
						});
					  } else if (el.tagName == 'INPUT' && el.type !== 'text' && el.getAttribute('name') !== 'ACTIVE' && el.getAttribute('name') !== 'Readonly') {
						el.closest("label").classList.add("active");
						el.value = "Y";
						if (el.getAttribute('name') !== 'ADMIN') {
						  if (el.closest("label ~ .toggle") && el.closest("label ~ .toggle").length) el.closest("label ~ .toggle").classList.add('toggle--disabled');
						}
					  };
					  if (el.getAttribute('name') == 'Readonly') {
						el.closest("label").classList.remove("active");
						el.value = "N";
					  }
					});
				  }
				} else {
				  for (var i = 0; i < tabs.length; i++) {
					var arr = tabs[i].querySelectorAll('input, select');
					arr.forEach(function(el) {
					  if (el.tagName == 'SELECT') {
						var options = el.getElementsByTagName("option");
						el.disabled = false;
						Array.from(options).forEach(function(e) {
						  e.selected = false;
						});
					  } else if (el.tagName == 'INPUT' && el.type !== 'text' && el.getAttribute('name') !== 'ACTIVE' && el.getAttribute('name') !== 'Readonly') {

						el.closest("label").classList.remove("active");
						el.value = "N";
						if (el.getAttribute('name') !== 'ADMIN') {
						  if (el.closest("label ~ .toggle") && el.closest("label ~ .toggle").length) el.closest("label ~ .toggle").classList.remove('toggle--disabled');
						}
					  };
					});
				  }
				}
			  });

			  readOnly.closest("label").addEventListener('click', function(ev) {
				if (this.getAttribute('class') == 'active') {
				  admin.closest("label").classList.remove("active");
				  admin.value = "N";
				  for (var i = 0; i < tabs.length; i++) {
					var arr = tabs[i].querySelectorAll('input, select');
					arr.forEach(function(el) {
					  if (el.tagName == 'SELECT') {
						var options = el.getElementsByTagName("option");
						el.disabled = false;
						Array.from(options).forEach(function(e) {
						  e.selected = false;
						});
					  } else if (el.tagName == 'INPUT' && el.type !== 'text' && el.getAttribute('name') !== 'ACTIVE' && el.getAttribute('name') !== 'Readonly') {

						el.closest("label").classList.remove("active");
						el.value = "N";
						if (el.getAttribute('name') !== 'ADMIN') {
						  if (el.closest("label ~ .toggle") && el.closest("label ~ .toggle").length) el.closest("label ~ .toggle").classList.remove('toggle--disabled');
						}
					  };
					});
				  }
				}

			  });

			});
			mo.fn.overlay.show({
			  close: false,
			  loading:true
			})
		  },
		  ctaCallback: function() {
			// HELPERS
			var sel = document.querySelector(".dxpModalContent");
			var roles = {
			  ADMIN: false,
			  ACTIVE: false,
			  CMR: false,
			  LOC: false,
			  IFM: false,
			  UAR: false,
			  Readonly: false,
			  RPR: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  OPA: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  RL: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  DDI: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  DDIS: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  IDD: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  EDD: {
				EMEA: false,
				AMS: false,
				APJ: false
			  },
			  AT: {
				EMEA: false,
				AMS: false,
				APJ: false
			  }
			};
			for (i = 0; i < Object.keys(roles).length; i++) {
			  var key = Object.keys(roles)[i];
			  var input = sel.querySelector("*[data-name=" + key + "]");
			  if (key == 'BU') {
				var inputs = sel.querySelectorAll("*[data-name^=" + key + "]");
				roles.BU = {
				  EMEA: [],
				  APJ: [],
				  AMS: []
				};
				Array.from(inputs).forEach(function(el) {
				  var k = el.getAttribute('data-name').split('_');
				  var options = el.getElementsByTagName("option");
				  Array.from(options).forEach(function(e) {
					if (e.selected == true) {
					  roles[key][k[1]].push(e.value);
					}
				  });
				})
			  } else if (input != null && input.tagName == "SELECT") {
				var opt = input.querySelectorAll("option:checked");
				var arr = [];
				for (k = 0; k < opt.length; k++) arr.push(opt[k].value);
				for (k = 0; k < Object.keys(roles[key]).length; k++) {
				  if (arr.indexOf(Object.keys(roles[key])[k]) > -1) roles[key][Object.keys(roles[key])[k]] = true;
				  else roles[key][Object.keys(roles[key])[k]] = false;
				}
			  } else if (input != null && input.tagName == "INPUT") {
				if (input.value == "Y") roles[key] = true;
				else roles[key] = false;
			  }
			}

			// UPDATE DATABASE
			mo.fn.modal.lock();
			if (type == "add") {
			  var email = sel.querySelector("input[data-name=Email]");
			  if (email.value.length < 9 || email.value.indexOf("@hpe.com") == -1) {
				mo.fn.modal.msg("Please provide a valid employee email address", 3);
				mo.fn.modal.unlock();
			  } else {
				users.create(email, sel, roles);
			  }
			} else if (type == "edit") {
			  var eid = data.EntryId;
			  users.update(eid, email, sel, roles);
			}
		  }
		});
	  },
	  personalConfig: function(node, data, aux) {
		node.innerHTML = '<div class="persConf"></div>';
		var conf = {
		  dom: node.querySelector('.persConf'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Email address",
				  data: "Email",
				  required: true,
				  type: "text",
				  value: data && data.Email ? data.Email : null,
				  placeholder: "Internal user email address",
				  validation: ["minLen|1", "maxLen|255", "noBlanks"],

				},
				 {
				   label: "First name",
				   data: "FirstName",
				   required: true,
				   value: data && data.FirstName ? data.FirstName : null,
				   type: "text",
				   placeholder: "Internal user first name",
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "Last name",
				   data: "LastName",
				   required: true,
				   value: data && data.LastName ? data.LastName : null,
				   type: "text",
				   placeholder: "Internal user last name",
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "Active",
				   data: "ACTIVE",
				   type: "toggle",
				   values: ['N', 'Y'],
				   value: aux && aux.ACTIVE ? aux.ACTIVE : '',
				   validation: ["minLen|1", "maxLen|255", "noBlanks"],

				 },
				 {
				   label: "Admin role",
				   data: "ADMIN",
				   type: "toggle",
				   values: ['N', 'Y'],
				   value: aux && aux.ADMIN ? aux.ADMIN : '',
				   validation: ["minLen|1", "maxLen|255", "noBlanks"],

				 },
				 {
				   label: "Read Only",
				   data: "Readonly",
				   type: "toggle",
				   values: ['N', 'Y'],
				   value: aux && aux.Readonly ? aux.Readonly : '',
				   validation: ["minLen|1", "maxLen|255", "noBlanks"],
				 }
				]
			  ]
			}]
		  }],
		  dataset: {},
		};

		nbsf.init(conf, 0);
	  },
	  arkRolesConfig: function(node, data, aux) {
		node.innerHTML = '<div style="visibility: hidden" class="contrConf"></div>';
		var conf = {
		  dom: node.querySelector('.contrConf'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[
				  /*{
                            label: "Admin role",
                            data: "ADMIN",				
                            type: "toggle",
                            values: ['N', 'Y'],
                            value: aux && aux.ADMIN ? aux.ADMIN : '',
                            validation: ["minLen|1", "maxLen|255", "noBlanks"],

                          },*/
				  {
					label: "Country Management ",
					data: "CMR",
					type: "toggle",
					values: ['N', 'Y'],
					value: aux && aux.CMR ? aux.CMR : '',
					validation: ["minLen|1", "maxLen|255", "noBlanks"],
				  },
				  {
					label: "Localization management",
					data: "LOC",
					type: "toggle",
					values: ['N', 'Y'],
					value: aux && aux.LOC ? aux.LOC : '',
					validation: ["minLen|1", "maxLen|255", "noBlanks"],
				  },
				  {
					label: "Intake forms management",
					data: "IFM",
					type: "toggle",
					values: ['N', 'Y'],
					value: aux && aux.IFM ? aux.IFM : '',
					validation: ["minLen|1", "maxLen|255", "noBlanks"],
				  },
				  {
					label: "User management",
					data: "UAR",
					value: aux && aux.UAR ? aux.UAR : '',
					type: "toggle",
					values: ['N', 'Y'],
					validation: ["minLen|1", "maxLen|255", "noBlanks"]
				  },
				],
				[

				],
				/*[
                                            {
                                              label: "Reporting role",
                                              data: "RPR",
                                              value: aux && aux.RPR ? aux.RPR : '',
                                              type: "multiselect",
                                              values: ['EMEA', 'AMS', 'APJ'],
                                              placeholder: "Internal user last name",
                                              validation: ["minLen|1", "maxLen|100", "noBlanks"]
                                            }
                                          ] */
			  ]
			}]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);

	  },
	  operationalConfig: function(node, data, aux) {
		node.innerHTML = '<div class="profConf"></div>';

		var conf = {
		  dom: node.querySelector('.profConf'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Operational admin role",
				  data: "OPA",
				  value: aux && aux.OPA ? aux.OPA : '',
				  type: "multiselect",
				  values: ['EMEA', 'AMS', 'APJ'],
				  validation: ["minLen|1", "maxLen|100", "noBlanks"]
				},
				 {
				   label: "Regional lead",
				   data: "RL",
				   required: false,
				   value: aux && aux.RL ? aux.RL : '',
				   type: "multiselect",
				   values: ['EMEA', 'AMS', 'APJ'],
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "DDI Investigation",
				   data: "DDI",
				   required: false,
				   value: aux && aux.DDI ? aux.DDI : '',
				   type: "multiselect",
				   values: ['EMEA', 'AMS', 'APJ'],
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "DDI Scoring",
				   data: "DDIS",
				   required: false,
				   value: aux && aux.DDIS ? aux.DDIS : '',
				   type: "multiselect",
				   values: ['EMEA', 'AMS', 'APJ'],
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "IDD Investigation",
				   data: "IDD",
				   required: false,
				   value: aux && aux.IDD ? aux.IDD : '',
				   type: "multiselect",
				   values: ['EMEA', 'AMS', 'APJ'],
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "EDD Investigation",
				   data: "EDD",
				   required: false,
				   value: aux && aux.EDD ? aux.EDD : '',
				   type: "multiselect",
				   values: ['EMEA', 'AMS', 'APJ'],
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "Agility team",
				   data: "AT",
				   required: false,
				   value: aux && aux.AT ? aux.AT : '',
				   type: "multiselect",
				   values: ['EMEA', 'AMS', 'APJ'],
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 }
				]
			  ]
			},

					   ]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
		//CHECK THE STATE OF OPERATIONAL ADMIN ROLE AND DISABLE OR ENABLE ROLES UNDER OPERATIONAL ADMIN CONTROL 
		var opadmin = document.querySelector('.dxpModalContent select[data-name=OPA]');
		var activeOptions = opadmin.getElementsByTagName("option")
		//tab only for operational tab
		var tab = document.querySelector('div[tab-id=operational]');
		var arr = tab.querySelectorAll('select');
		for (var i = 0; i < arr.length; i++) {
		  var nested = arr[i].getAttribute('data-name').split('_');
		  for (var j = 0; j < activeOptions.length; j++) {
			if (nested && nested[1]) {
			  if (activeOptions[j].value == nested[1] && activeOptions[j].selected == true) {
				arr[i].disabled = true;
			  };
			} else {
			  if (arr[i].getAttribute('data-name') !== 'COR' && arr[i].getAttribute('data-name') !== 'POR' && arr[i].getAttribute('data-name') !== 'OPA') {
				if (activeOptions[j].selected == true) {
				  arr[i].disabled = true;
				}
			  }
			}

		  }
		}


		opadmin.addEventListener('change', function(ev) {
		  //CHECK IF WE NEED TO DISABLE OPERATIONAL ROLES BASED ON OPERATIONAL ADM
		  var removeDisabledSelect = true;
		  Array.from(activeOptions).forEach(function(e) {
			if (e.selected == true) {
			  removeDisabledSelect = false;
			}
		  });
		  //Loop trough all operational elements
		  for (var i = 0; i < arr.length; i++) {
			//Exceptions for operational admin control
			if (arr[i].getAttribute('data-name') !== 'COR' && arr[i].getAttribute('data-name') !== 'POR' && arr[i].getAttribute('data-name') !== 'OPA') {
			  var allOptions = arr[i].getElementsByTagName("option");
			  var nested = arr[i].getAttribute('data-name').split('_');
			  for (var j = 0; j < activeOptions.length; j++) {

				if (nested && nested[1]) { //In this case we have regional + config
				  arr[i].disabled = true;
				  if (activeOptions[j].value == nested[1] && activeOptions[j].selected == true) {
					Array.from(allOptions).forEach(function(e) {
					  e.selected = true;
					});
				  } else if (activeOptions[j].value == nested[1] && activeOptions[j].selected !== true) Array.from(allOptions).forEach(function(e) {
					if (removeDisabledSelect) arr[i].disabled = false;
					e.selected = false;
				  });
				} else { //In this case we have only regional                             

				  if (activeOptions[j].selected == true) {
					allOptions[j].selected = true;
					arr[i].disabled = true;
				  } else {
					if (removeDisabledSelect) arr[i].disabled = false;
					allOptions[j].selected = false;
				  }
				}
			  }

			}
		  }
		});

	  },
	  businessConfig: function(node, data, aux) {
		node.innerHTML = '<div class="ids"></div>';
		var arr = Object.keys(users.config);
		var conf = {
		  dom: node.querySelector('.ids'),
		  pages: [{
			nav: false,
			structure: [{

			  header: "BU role",
			  group: [
				[{
				  label: "EMEA:",
				  data: "BU_EMEA",
				  required: true,
				  value: aux && aux.BU.EMEA ? aux.BU.EMEA : '',
				  type: "multiselect",
				  values: arr,
				  validation: ["minLen|1", "maxLen|100", "noBlanks"]
				},
				 {
				   label: "AMS:",
				   data: "BU_AMS",
				   required: true,
				   value: aux && aux.BU.AMS ? aux.BU.AMS : '',
				   type: "multiselect",
				   values: arr,
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 },
				 {
				   label: "APJ:",
				   data: "BU_APJ",
				   required: true,
				   value: aux && aux.BU.APJ ? aux.BU.APJ : '',
				   type: "multiselect",
				   values: arr,
				   validation: ["minLen|1", "maxLen|100", "noBlanks"]
				 }
				]
			  ]

			}]
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);


	  },
	},
	grid: {
	  datasource: function() {

		function processed(r, d) {
		  try {
			var roles = JSON.parse(d.UserRole);
			var arr = [];
			if (roles[r].EMEA) arr.push("EMEA");
			if (roles[r].AMS) arr.push("AMS");
			if (roles[r].APJ) arr.push("APJ");
			if (arr.length == 0) return "N/A";
			else if (arr.length == 3) return "WW";
			else return arr.join(",");
		  } catch (err) {
			return "N/A";
		  }
		}

		function processedWithConfig(r, d) {
		  try {
			var roles = JSON.parse(d.UserRole);
			var arr = [];
			if (roles[r].EMEA && roles[r].EMEA.length) arr.push("EMEA: " + roles[r].EMEA.length);
			if (roles[r].AMS && roles[r].AMS.length) arr.push(" AMS: " + roles[r].AMS.length);
			if (roles[r].APJ && roles[r].APJ.length) arr.push(" APJ: " + roles[r].APJ.length);
			if (arr.length == 0) return "N/A";
			else return arr.join(",");
		  } catch (err) {
			return "N/A";
		  }
		}

		function basic(r, d) {
		  try {
			var roles = JSON.parse(d.UserRole);
			if (roles[r]) return "Y";
			else return "N";
		  } catch (err) {
			return "N/A";
		  }
		}

		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/641/CustomInternalUser_Dataset/kendo/data/search",
			  type: "POST"
			}
		  },
		  schema: {
			model: {
			  id: "EntryId",
			}
		  },
		  filter: {
			logic: "and",
			filters: [
			  {
				field: "Source",
				operator: "eq",
				value: 'Ark'
			  },
			  {
				field: "Email",
				operator: "neq",
				value: access.user.Email
			  }

			]
		  },
		  schema: {
			parse: function(response) {
			  var columns = [];
			  if (response.Data.length > 0)
				columns = Object.keys(response.Data[0]);

			  response.Data.forEach(item => {
				item["Active"] = basic("ACTIVE", item);
				item["Admin"] = basic("ADMIN", item);
				item["CMR"] = basic("CMR", item);
				item["LOC"] = basic("LOC", item);
				item["IFM"] = basic("LOC", item);
				item["UAR"] = basic("LOC", item);
				item["RL"] = processed("RL", item);
				item["OPA"] = processed("OPA", item);
				item["DDI"] = processed("DDI", item);
				item["DDIS"] = processed("DDIS", item);
				item["IDD"] = processed("IDD", item);
				item["EDD"] = processed("EDD", item);
				item["AT"] = processed("AT", item);
			  });


			  return response;
			} 
		  },
		  autoSync: true,
		  serverPaging: true,
		  pageSize: 10, // -1 to 
		  serverFiltering: true,
		  serverSorting: true,
		  sort: {
			field: "Modified",
			dir: "desc"
		  }
		})
	  },
	  _custom: function() {
		/*function processed(r, d) {
		  try {
			var roles = JSON.parse(d.UserRole);
			var arr = [];
			if (roles[r].EMEA) arr.push("EMEA");
			if (roles[r].AMS) arr.push("AMS");
			if (roles[r].APJ) arr.push("APJ");
			if (arr.length == 0) return "N/A";
			else if (arr.length == 3) return "WW";
			else return arr.join(",");
		  } catch (err) {
			return "N/A";
		  }
		}

		function processedWithConfig(r, d) {
		  try {
			var roles = JSON.parse(d.UserRole);
			var arr = [];
			if (roles[r].EMEA && roles[r].EMEA.length) arr.push("EMEA: " + roles[r].EMEA.length);
			if (roles[r].AMS && roles[r].AMS.length) arr.push(" AMS: " + roles[r].AMS.length);
			if (roles[r].APJ && roles[r].APJ.length) arr.push(" APJ: " + roles[r].APJ.length);
			if (arr.length == 0) return "N/A";
			else return arr.join(",");
		  } catch (err) {
			return "N/A";
		  }
		}

		function basic(r, d) {
		  try {
			var roles = JSON.parse(d.UserRole);
			if (roles[r]) return "Y";
			else return "N";
		  } catch (err) {
			return "N/A";
		  }
		}*/
		var cusConfig = [
		  {
			field: "Active",
			title: "Active",
			width: '100px',
			hidden: false,
			locked: true,
			filterable: true,
			/*template: function(d) {
			  return basic("ACTIVE", d);
			}*/
		  },
		  {
			field: "Email",
			title: "Email",
			width: '250px',
			locked: true,
			hidden: false,
			filterable: true
		  },
		  {
			field: "Admin",
			title: "Admin",
			width: '100px',
			hidden: false,
			locked: true,
			filterable: true
		  },
		  {
			field: "CMR",
			title: "CMR",
			hidden: false,
			width: '100px',
			filterable: true
		  },
		  {
			field: "LOC",
			title: "LOC",
			hidden: false,
			width: '100px',
			filterable: true
		  },
		  {
			field: "IFM",
			title: "IFM",
			hidden: false,
			width: '100px',
			filterable: true
		  },
		  {
			field: "UAR",
			title: "UAR",
			hidden: false,
			width: '160px',
			filterable: true
		  },
		  {
			field: "RL",
			title: "RL",
			hidden: false,
			width: '160px',
			filterable: true
		  },
		  {
			field: "OPA",
			title: "OPA",
			hidden: false,
			width: '160px',
			filterable: true,
		  },
		  {
			field: "DDI",
			title: "DDI",
			hidden: false,
			width: '160px',
			filterable: true
		  },
		  {
			field: "DDIS",
			title: "DDIS",
			hidden: false,
			width: '160px',
			filterable: true
		  },
		  {
			field: "IDD",
			title: "IDD",
			width: '160px',
			hidden: false,
			filterable: true,
		  },
		  {
			field: "EDD",
			title: "EDD",
			hidden: false,
			width: '160px',
			filterable: true,
		  },
		  {
			field: "AT",
			title: "AT",
			width: '160px',
			hidden: false,
			filterable: true,
		  },
		  {
			title: "",
			width: "55px",
			locked: true,
			attributes: {
			  "class": "cta"
			},
			template: function(d) {

			  var icons = '<a class="edit"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></a>';
			  if (access.user.UserRole.UAR == true && !access.user.UserRole.Readonly) return icons;
			  else return '';

			}
		  }
		];
		return cusConfig;
	  },
	  _config: function() {
		var cusConfig = users.grid._custom();
		return cusConfig;
	  },
	  _load: function(selector, datasource, config) {
		var toolbar = [{
		  name: "excel",
		  text: "Export Excel"
		},{
		  name: "add",
		  text: "Add user"
		}];

		$(selector).kendoGrid({
		  toolbar: (access.user.UserRole.UAR == true && !access.user.UserRole.Readonly) ? toolbar : null,
		  dataSource: users.grid.datasource(),
		  columns: config,
		  dataBound: function(e) {},
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			}
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  excel: {
			allPages: true,
			fileName: "Users" + util.getDate((new Date()).toISOString()) + ".xlsx", 
			filterable: true,
		  },
		  excelExport: util.exportExcel,
		});

		util.buildFilterCombobox($(selector), "Active", {
		  dataset: [
			{ text: "Yes", value: "Y" },
			{ text: "No", value: "N" },
		  ],
		  dataTextField: "text",
		  dataValueField: "value",
		});
		util.buildFilterCombobox($(selector), "Admin", {
		  dataset: [
			{ text: "Yes", value: "Y" },
			{ text: "No", value: "N" },
		  ],
		  dataTextField: "text",
		  dataValueField: "value",
		});
		util.buildFilterCombobox($(selector), "Email", {
		  dataset: "ARK_Users_MetaData",
		  form: "641",
		  dataTextField: "Email",
		  dataValueField: "Email",
		});


		document.querySelector('.toolbar').innerHTML = "";
		$('#users .k-grid-toolbar').appendTo('#users .toolbar');

		$(selector).delegate(".edit", "click", function(e) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  users.modal.show("edit", row);
		});
		if ($('#users .k-grid-toolbar') && $('#users .k-grid-toolbar').length) {
		  $('#users .k-grid-toolbar').appendTo('#users section[tab-id=users] .toolbar');
		  document.querySelector("#users .k-grid-add").addEventListener("click", function(e) {
			users.modal.show("add");
		  });
		}
	  }
	}
  }
</script>

<!-- INTAKE MODULE -->
<script>
  const intakeForms = {
	holder: function() {
	  return document.querySelector('#navigation #intake:last-child');
	},
	html: function() {
	  return "<div id='intake'><div id='intakeContainer'></div></div>";
	},
	init: function(reload) {
	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });
	  configsAPI.overview(function(d) {
		if (reload) {
		  intakeForms.holder().innerHTML = intakeForms.html();
		  intakeForms.holder().classList.remove('hidden');
		  mo.fn.overlay.hide();
		} else {
		  navigation.push(intakeForms.html());
		  recentlyViewed.add({
			Module: 'Intake forms',
			Id: null,
		  }, function() {});
		}
		intakeForms.data = d
		intakeForms.ui.grid.load(intakeForms.holder().querySelector("#intakeContainer"));
		mo.fn.overlay.hide();
	  });

	},
	data: {},
	ui: {
	  grid: {
		load: function(selector) {
		  var grid = $(selector);
		  grid.kendoGrid({
			height: 800,
			pageable: {
			  pageSize: 25,
			  pageSizes: [25, 50, 100],
			  refresh: false
			},
			scrollable: true,
			sortable: true,
			filterable: true,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			dataSource: {
			  data: intakeForms.data,
			  sort: {
				field: "EntryId",
				dir: "asc"
			  }
			},
			columns: [{
			  field: "ConfigName",
			  title: "Intake Form",
			  hidden: false,
			  width: "180px",
			  headerAttributes: {
				style: "white-space: normal"
			  },
			},
					  {
						field: "Modified",
						title: "Last Modified",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},
						template: function(d) {
						  return util.getDate(d.Modified)
						}
					  },
					  {
						field: "ModifiedBy",
						title: "Modified By",
						hidden: false,
						width: "120px",
						headerAttributes: {
						  style: "white-space: normal"
						},
					  },
					  {
						field: "Active",
						title: "Active",
						hidden: false,
						width: "120px",
						template: function(d) {
						  return d.Active == 1 ? 'Yes' : 'No'
						}
					  }
					 ],
			editable: "inline",
			detailInit: function(e) {

			  var countryItem = e.data;
			  var data = [];
			  var configData = intakeForms.data;
			  var riskModel = null;

			  for (var i = 0; i < e.data.versions.length; i++) {

				data.push({
				  EntryId: e.data.versions[i].EntryId,
				  Version: e.data.versions[i].Version,
				  Status: e.data.versions[i].Status,
				  Modified: e.data.versions[i].Modified,
				  ModifiedBy: e.data.versions[i].ModifiedBy
				});

			  }

			  //INIT DETAIL GRID
			  var gridConfigs = $("<div/>").appendTo(e.detailCell);
			  gridConfigs.kendoGrid({
				dataSource: new kendo.data.DataSource({
				  data: data,
				  schema: {
					model: {
					  id: "EntryId",
					  fields: {
						EntryId: {
						  editable: false
						},
						Version: {
						  editable: false
						},
						Status: {
						  editable: false
						},
						Modified: {
						  editable: false
						},
						ModifiedBy: {
						  editable: false
						}

					  }
					}
				  }
				}),
				scrollable: false,
				sortable: true,
				pageable: false,
				columns: [{
				  field: "EntryId",
				  title: "ID",
				  width: "110px"
				},
						  {
							field: "Version",
							title: "Version",
							width: "150px"
						  },
						  {
							field: "Status",
							title: "Status",
							width: "80px",
							template: function(d) {
							  return d.Status == 1 ? 'Active' : 'Inactive'
							}
						  },
						  {
							field: "Modified",
							title: "Modified",
							width: "130px",
							number: true,
							template: function(d) {
							  return util.getDate(d.Modified)
							}
						  },
						  {
							field: "ModifiedBy",
							title: "ModifiedBy",
							width: "150px",
							number: true
						  },
						  {
							template: function(d) {
							  return `
${d.Status == 0 ? `<span class='customView'>
<svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></svg>
<div class="updateCancelContainer" style="display: none;" >
<div class='customUpdate'>
<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="checkmark" width="28px" height="28px">
<polyline fill="none" stroke="#666" stroke-width="2" points="2 14 9 20 22 4">
  </polyline>
  </svg>
  </div>` : ` <span class='customEdit'>
<svg version='1.1' viewBox='0 0 24 24' role='img' aria-label='edit' width='24px' height='24px'>
<path fill='none' stroke='#666' stroke-width='2' d='M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9'>
  </path>
  </svg>
  </span>`}


`;
							},
							width: "100px"
						  }
						 ],
				editable: "inline",
				save: function(e) {


				}
			  });

			  gridConfigs.on("click", ".customEdit", function(e) {
				mo.fn.overlay.show({
				  close: false,
				  loading: true
				});
				$(gridConfigs).data("kendoGrid").editRow(row);
				var grid = $(gridConfigs).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));

				configsAPI.get(row.EntryId, reference.translations.data, function(d) {
				  intakeForms.intakeFormsManagement.init(d, false);
				  mo.fn.overlay.hide();
				});

			  });

			  gridConfigs.on("click", ".customView", function(e) {
				mo.fn.overlay.show({
				  close: false,
				  loading: true
				});
				$(gridConfigs).data("kendoGrid").editRow(row);
				var grid = $(gridConfigs).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));
				configsAPI.get(row.EntryId, reference.translations.data, function(d) {
				  console.log(d);

				  intakeForms.intakeFormsManagement.init(d, true);
				  mo.fn.overlay.hide();
				});

			  });
			}
		  });

		}

	  }
	},
	intakeFormsManagement: {
	  holder: function() {
		return document.querySelector('#navigation #intakeManagement:last-child')
	  },
	  html: function() {
		return "<div id='intakeManagement'><div class='info'></div><div class='intakeTabs'></div></div>";
	  },
	  dataSet: null,
	  settingsConfig: null,
	  remindersConfig: null,
	  versionConfig: null,
	  init: function(data, viewOnly) {
		intakeForms.intakeFormsManagement.dataSet = data;
		navigation.push(intakeForms.intakeFormsManagement.html());
		//document.querySelector('#intakeContainer').classList.add('hidden');
		//document.querySelector('#intake .intakeManagement').classList.remove('hidden');
		//node.innerHTML = '<div class="info"></div><div class="intakeTabs"></div>';
		intakeForms.intakeFormsManagement.holder().querySelector('.info').innerHTML = intakeForms.intakeFormsManagement.template(data.config, viewOnly);
		hpe.ui.tabs({
		  dom: intakeForms.intakeFormsManagement.holder().querySelector(".intakeTabs"),
		  tabs: [{
			label: "Settings",
			id: "settings"
		  },
				 {
				   label: "Questions",
				   id: "questions"
				 },
				 {
				   label: "Reminders",
				   id: "reminders"
				 }
				]
		}, function(all) {
		  nbsf.init(intakeForms.intakeFormsManagement.settingsSection(all[0], data, viewOnly), 0);
		  if (access.user.UserRole.Readonly) all[0].querySelector('.buttons').style.display = 'none';

		  intakeForms.intakeFormsManagement.questionsSection(all[1], data);
		  nbsf.init(intakeForms.intakeFormsManagement.remindersSection(all[2], data, viewOnly), 0);
		  if (access.user.UserRole.Readonly) all[2].querySelector('.buttons').style.display = 'none';
		});
	  },
	  settingsSection: function(node, data, viewOnly) {
		var conf = {
		  dom: node,
		  pages: [{
			nav: viewOnly ? false : true,
			cLabel: 'gerg',
			structure: [{
			  group: [
				[{
				  label: "CPI Weight:",
				  data: "cpiWeight",
				  required: true,
				  type: "text",
				  validation: ["isInteger", "minVal|0", "maxVal|100", "noBlanks"],
				  typing: "isInteger"

				},
				 {
				   label: "DDQ Weight:",
				   data: "ddqWeight",
				   required: true,
				   type: "text",
				   validation: ["isInteger", "minVal|0", "maxVal|100", "noBlanks"],
				   typing: "isInteger"
				 },
				 {
				   label: "Max country score:",
				   data: "maxCountry",
				   required: true,
				   type: "text",
				   validation: ["isInteger", "noBlanks"],
				   typing: "isInteger"
				 },
				 {
				   label: "Expired in (days):",
				   data: "expired",
				   type: "text",
				   required: true,
				   type: "text",
				   validation: ["isInteger", "minVal|1", "maxVal|356", "noBlanks"],
				   typing: "isInteger"
				 }

				]
			  ]
			},
						{
						  header: 'Score ranges',
						  group: [
							[]
						  ]
						},
						{
						  repeatable: "scoreRanges",
						  repeatableLimit: 10,
						  //  description: 'Score ranges',
						  group: [
							[{
							  label: "Min CPI",
							  data: "min",
							  value: null,
							  required: true,
							  type: "text",
							  minVal: 0,
							  maxVal: 100,
							  validation: ["isInteger", "minVal|0", "maxVal|100", "noBlanks"],
							  //typing: "flt"
							},
							 {
							   label: "Max CPI:",
							   data: "max",
							   required: true,
							   value: null,
							   type: "text",
							   validation: ["isInteger", "minVal|0", "maxVal|100", "noBlanks"],
							   typing: "isInteger"
							 },
							 {
							   label: "Score",
							   data: "score",
							   required: true,
							   value: null,
							   type: "text",
							   validation: ["isInteger", "noBlanks"],
							   typing: "isInteger"
							 }
							]
						  ],
						  callback: function() {},
						},
						{
						  header: 'Risk tiers',
						  group: [
							[]
						  ]
						},
						{
						  repeatable: "riskTiers",
						  repeatableLimit: 10,
						  //description: 'Risk tiers',
						  group: [
							[{
							  label: "Min score",
							  data: "min",
							  value: null,
							  required: true,
							  type: "text",
							  validation: ["isInteger", "minVal|0", "maxVal|100", "noBlanks"],
							  typing: "isInteger"
							},
							 {
							   label: "Max score:",
							   data: "max",
							   value: null,
							   required: true,
							   type: "text",
							   validation: ["isInteger", "minVal|0", "maxVal|100", "noBlanks"],
							   typing: "isInteger"
							 },
							 {
							   label: "Tier",
							   data: "label",
							   required: true,
							   value: null,
							   type: "text",
							   validation: ["minLen|1", "maxLen|100"],
							 }
							]
						  ],
						  callback: function() {},

						}
					   ],
			dataset: {},
			callback: function() {
			  if (viewOnly) {

				var firstGroup = intakeForms.intakeFormsManagement.holder().querySelector('[tab-id="settings"] .row');
				Array.from(firstGroup.querySelectorAll('input, select')).forEach(function(el) {
				  el.disabled = true;
				});

				node.querySelectorAll('.repeater').forEach(function(el) {
				  el.classList.add('hidden');
				  el.closest('.row').querySelectorAll('input').forEach(function(item) {
					item.disabled = true;
				  });
				});
			  }
			  node.querySelectorAll('.heading').forEach(function(el) {
				if (el && el.closest('.row')) el.closest('.row').style.marginBottom = "0px";
			  })

			  Array.from(intakeForms.intakeFormsManagement.holder().querySelectorAll('[data-rname="scoreRanges"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.text')).forEach(function(d, index) {
				  d.style.display = 'inline-block';
				  if (index == 2) {

					d.style.width = '120px';
				  } else {

					d.style.width = '100px';
				  }


				});
			  });
			  Array.from(intakeForms.intakeFormsManagement.holder().querySelectorAll('[data-rname="riskTiers"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.text')).forEach(function(d, index) {
				  d.style.display = 'inline-block';
				  if (index == 2) {

					d.style.width = '250px';
				  } else {

					d.style.width = '70px';
				  }


				});
			  });


			},
			validation: function() {
			  var result = {
				fail: [],
				pass: []
			  };
			  return result;
			},

		  }],
		  onNext: function() {

			mo.fn.modal.show({
			  ctaLabel: "Save",
			  class: "ark-modal",
			  title: "Please provide the version name",
			  content: "<div class='versionNameIntake'></div>",
			  contentCallback: function() {
				var conf = {
				  dom: document.querySelector('.versionNameIntake'),
				  pages: [{
					nav: false,
					structure: [{
					  group: [
						[{
						  label: "Version name:",
						  data: "Version",
						  required: true,
						  type: "text",
						  validation: ["minLen|1", "maxLen|100"],
						}, ]
					  ],
					  callback: function() {


					  },
					}],
					callback: function() {},
				  }]
				};

				intakeForms.intakeFormsManagement.versionConfig = conf;
				nbsf.init(conf, 0);
			  },

			  ctaCallback: function() {

				intakeForms.intakeFormsManagement.dataSet.settings = intakeForms.intakeFormsManagement.settingsConfig.dataset;
				intakeForms.intakeFormsManagement.dataSet.settings.riskTiers = JSON.parse(intakeForms.intakeFormsManagement.dataSet.settings.riskTiers);
				intakeForms.intakeFormsManagement.dataSet.settings.scoreRanges = JSON.parse(intakeForms.intakeFormsManagement.dataSet.settings.scoreRanges);
				mo.fn.modal.hide();
				mo.fn.overlay.show({
				  close: false,
				  loading: true
				});
				nbsf.data.update(intakeForms.intakeFormsManagement.versionConfig, {});
				configsAPI.save(intakeForms.intakeFormsManagement.versionConfig.dataset.Version, intakeForms.intakeFormsManagement.dataSet, function(d) {

				  intakeForms.holder().querySelector('#intakeContainer').classList.remove('hidden');
				  intakeForms.intakeFormsManagement.holder().classList.add('hidden');
				  intakeForms.intakeFormsManagement.holder().innerHTML = '';
				  navigation.back();
				  navigation.stack.pop();
				  intakeForms.init(true);

				  mo.fn.overlay.hide();
				});

			  }
			});
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});

		  },
		};
		if (data && data.settings) {
		  conf.dataset = data.settings;
		  conf.dataset.riskTiers = JSON.stringify(conf.dataset.riskTiers);
		  conf.dataset.scoreRanges = JSON.stringify(conf.dataset.scoreRanges);
		}
		intakeForms.intakeFormsManagement.settingsConfig = conf;
		return conf;
	  },
	  remindersSection: function(node, data, viewOnly) {

		node.innerHTML = '<h4>If necessary, set a set of reminders here. Each reminder will activate a selected number of days after the invitation is sent.</h4><div class="contentReminder"></div>';
		var conf = {
		  dom: intakeForms.intakeFormsManagement.holder().querySelector('.contentReminder'),
		  pages: [{
			nav: viewOnly ? false : true,
			structure: [{
			  repeatable: "reminders",
			  repeatableLimit: 10,

			  group: [
				[{
				  label: "remind in (days)",
				  data: "days",
				  required: true,
				  type: "text",
				  validation: ["isInteger", "minVal|1", "maxVal|365", "noBlanks"],
				},

				 {
				   label: "Template",
				   data: "templateId",
				   type: "select",
				   required: true,
				   value: null,
				   options: reference.translations.groups.EmailReminder.map(x => x.Key),
				   values: reference.translations.groups.EmailReminder.map(x => x.Key),
				   validation: ["inArray"],
				 },
				]
			  ],
			  callback: function() {


			  }
			}, ],
			callback: function() {

			  if (viewOnly) {
				node.querySelectorAll('.repeater').forEach(function(el) {
				  el.classList.add('hidden');
				  el.closest('.row').querySelectorAll('input, select').forEach(function(item) {
					item.disabled = true;
				  });
				});
				node.querySelectorAll('.heading').forEach(function(el) {
				  if (el && el.closest('.row')) el.closest('.row').style.marginBottom = "0px";
				})
			  }

			  Array.from(document.querySelectorAll('[data-rname="reminders"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.text, .wrapper.select')).forEach(function(d, index) {
				  d.style.width = '181px';
				  d.style.display = 'inline-block';
				});
			  });


			},
			validation: function() {
			  var result = {
				fail: [],
				pass: []
			  };
			  return result;
			}

		  }],
		  onNext: function() {
			mo.fn.modal.show({
			  ctaLabel: "Save",
			  class: "ark-modal",
			  title: "Please provide the version name",
			  content: "<div class='versionNameIntake'></div>",
			  contentCallback: function() {
				var conf = {
				  dom: document.querySelector('.versionNameIntake'),
				  pages: [{
					nav: false,
					structure: [{
					  group: [
						[{
						  label: "Version name:",
						  data: "Version",
						  required: true,
						  type: "text",
						  validation: ["minLen|1", "maxLen|100"],
						}, ]
					  ],
					  callback: function() {


					  },
					}],
					callback: function() {},
				  }]
				};

				intakeForms.intakeFormsManagement.versionConfig = conf;
				nbsf.init(conf, 0);
			  },

			  ctaCallback: function() {

				intakeForms.intakeFormsManagement.dataSet.settings = intakeForms.intakeFormsManagement.settingsConfig.dataset;
				intakeForms.intakeFormsManagement.dataSet.settings.riskTiers = JSON.parse(intakeForms.intakeFormsManagement.dataSet.settings.riskTiers);
				intakeForms.intakeFormsManagement.dataSet.settings.scoreRanges = JSON.parse(intakeForms.intakeFormsManagement.dataSet.settings.scoreRanges);
				intakeForms.intakeFormsManagement.dataSet.reminders = JSON.parse(intakeForms.intakeFormsManagement.remindersConfig.dataset.reminders);
				mo.fn.modal.hide();
				mo.fn.overlay.show({
				  close: false,
				  loading: true
				});
				nbsf.data.update(intakeForms.intakeFormsManagement.versionConfig, {});
				configsAPI.save(intakeForms.intakeFormsManagement.versionConfig.dataset.Version, intakeForms.intakeFormsManagement.dataSet, function(d) {
				  console.log(d);

				  intakeForms.holder().querySelector('#intakeContainer').classList.remove('hidden');
				  intakeForms.intakeFormsManagement.holder().classList.add('hidden');
				  intakeForms.intakeFormsManagement.holder().innerHTML = '';
				  navigation.back();
				  navigation.stack.pop();
				  intakeForms.init(true);

				  mo.fn.overlay.hide();
				});

			  }
			});
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
		  }
		};
		conf.dataset = {
		  reminders: JSON.stringify(data.reminders)
		};
		intakeForms.intakeFormsManagement.remindersConfig = conf;
		return conf;
	  },
	  questionsSection: function(node, data) {
		for (var i = 0; i < data.questions.length; i++) {
		  node.innerHTML += `<p>${data.questions[i].question}</p>
<ul class="intakeQuestions">
${(intakeForms.intakeFormsManagement.questionAutomation(data.questions[i])) }
  </ul>
`
		};

	  },
	  questionAutomation: function(question) {
		string = "";
		if (question.answers && question.answers.length) {
		  for (var j = 0; j < question.answers.length; j++) {

			string += '<li><label>' + question.answers[j].title + '</label>  <span>' + (question.answers[j].score > 0 ? '+ ' + question.answers[j].score : question.answers[j].score) + '</span></li>';

		  }
		}

		if (question.subQuestions && question.subQuestions.length) {

		  for (k = 0; k < question.subQuestions.length; k++) {

			if (question.subQuestions[k].answers && question.subQuestions[k].answers.length) {
			  if (question.subQuestions[k].answers[0].type == 'multiple') string += '<p>' + question.subQuestions[k].text + '</p>';
			  for (var z = 0; z < question.subQuestions[k].answers.length; z++) {
				if (question.subQuestions[k].answers[z].type == 'multiple') {

				  string += '<li><label>' + question.subQuestions[k].answers[z].title + '</label>  <span>' + (question.subQuestions[k].answers[z].score > 0 ? '+ ' + question.subQuestions[k].answers[z].score : question.subQuestions[k].answers[z].score) + '</span></li>';
				}
			  }
			}
			if (question.subQuestions[k].answers[0].type !== 'multiple') string += '<p>' + question.subQuestions[k].text + '</p>';
		  }
		}

		return string;
	  },
	  msg: function(str, typ) {
		$('.msgBox').addClass(typ);
		$('.msgBox p').text(str);
		window.scrollTo({
		  top: 0,
		  behavior: 'smooth'
		});
		$('.msgBox .close').on('click', function(ev) {
		  $('.msgBox').removeClass('err');

		});
	  },

	  template: function(data, viewOnly) {
		return '<section class="wrapper headerInfo">' +
		  '<div class="container">' +
		  '<div tab-id="application" class="nbsf active" data-step="step-1" >' +
		  '<div class="row" style="padding-left: 5px" review-id="IntakeForms info">' +
		  '<h3 style="clear:both;">' + data.ConfigName + ' (' + data.Version + ') </h3>' +
		  '<div >' +
		  '<div class ="row--left">' +
		  ' <div class="item"><span>Status:</span>' +
		  ' <p class="prr"><b>' + (data.Status == 1 ? 'Active' : 'Inactive') + '</b></p>' +
		  '</div>' +
		  ' <div class="item"><span>Id:</span>' +
		  ' <p class="prr">' + (data.EntryId || 'N/A') + '</p>' +
		  '</div>' +
		  '</div>' +
		  '<div class ="row--right">' +
		  ' <div class="item"><span>Last Modified:</span>' +
		  ' <p class="prr">' + (util.getDate(data.Modified) || 'N/A') + '</p>' +
		  '</div>' +
		  ' <div class="item"><span>Modified by:</span>' +
		  ' <p class="prr">' + (data.ModifiedBy || 'N/A') + '</p>' +
		  '</div>' +
		  '</div>' +
		  '</section>' +
		  '<div class="msgBox">' +
		  '<p></p>' +
		  '<span class="close">×</span>' +
		  '</div> ';
		//(viewOnly ? '' : '<a href="#" style="margin-bottom:40px; float: right; z-index: 5" class="k-button-action k-button-icontext k-grid-updateIntake"> Save changes </a>');
	  }
	}
  };
</script>

<!-- INVITATION  -->
<script>
  const invitation = {
	holder: function() {
	  return document.querySelector('#navigation #company_invitation_info:last-child')
	},
	html: function(id) {
	  return '<section id="company_invitation_info" data-id="' + (id ? id : '') + '">' +
		'<section class="inv_info"></section>' +
		'<div class="invitation_progress_bar"></div>' +
		'<div class="invitation_overview" style="overflow:hidden;padding-bottom:10px;max-width:100%;"></div>' +
		'</section>'
	},
	data: {},
	statusHistory: '',
	manageStatus: function(status) {
	  if (status == '1') return 'Sent'
	  else if (status == '2') return 'Submitted'
	  else if (status == '3') return 'Expired'
	  else if (status == '4') return 'Passed'
	  else if (status == '5') return 'Denied'
	  else if (status == '6') return 'Closed'
	  else return !status ? 'N/A' : status
	},
	openFromBackButton: function() {
	  if (invitation.data && invitation.data.invitation)
		invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId);
	},
	updateDDQOnResend: function(caseId, company, configFk, cb) {
	  crud.read("3699", "inv=" + caseId, function(resp) {
		if (resp && resp.Rows && resp.Rows.length) {
		  var ddqRow = resp.Rows[0];
		  crud.read("3758", "eid=" + configFk, function(r) {
			if (r && r.Rows && r.Rows.length) {
			  var conf = JSON.parse(r.Rows[0].Config);
			  var fields = [];
			  conf.pages[0].structure.map(struct => {
				struct.group.map(g => {
				  fields.push(...g);
				});
			  });
			  var oldObj = {};
			  var newObj = {};
			  fields.map(f => {
				var profileValue = undefined;
				switch (f.data) {
				  case "OfficialCompanyName":
					profileValue = company.CompanyName;
					break;
				  case "TradeOrBussinessName":
					profileValue = company.TradingCompanyName;
					break;
				  case "BusinessRegistrationNumber":
					profileValue = company.TaxId || company.RegistrationNumber;
					break;
				  case "RegistrationNumber":
					profileValue = company.TaxId || company.RegistrationNumber;
					break;
				  case "Fax":
					profileValue = company.FAX;
					break;
				  case "TaxId":
					profileValue = company.TaxId || company.RegistrationNumber;
					break;
				  case "POCPosition":
					profileValue = company.Position;
					break;
				  case "POCName":
					profileValue = company.Name;
					break;
				  case "POCTelephone":
					profileValue = company.Telephone;
					break;
				  case "POCEmail":
					profileValue = company.EmailAddress;
					break;
				  case "POCAddress":
					profileValue = company.EmailAddress;
					break;
				  default:
					profileValue = company[f.data] !== undefined ? company[f.data] : undefined;
					break;
				};
				if (profileValue && ddqRow[f.data] !== profileValue) {
				  oldObj[f.data] = ddqRow[f.data];
				  newObj[f.data] = profileValue;
				}
			  });
			  if (newObj !== {}) {
				crud.update("4090", ddqRow.EntryId, newObj, function() {
				  cb({
					oldObj: oldObj,
					newObj: newObj
				  })
				});
			  } else {
				cb(null);
			  }
			} else {
			  cb(null);
			}
		  });
		} else {
		  cb(null);
		}
	  });
	},
	invitationOverview: {
	  init: function(id, callback) {
		navigation.push(invitation.html(id), invitation.openFromBackButton);
		invitation.invitationOverview.updateSection(id);

		recentlyViewed.add({
		  Module: 'Case',
		  Id: id,
		}, function() {});
	  },
	  updateSection: function(id, tabIdx, callback) {

		mo.fn.overlay.show({
		  close: false,
		  loading: true

		});
		invitationAPI.get(id, function(d) {

		  mo.fn.overlay.hide();
		  if (d.error) {
			mo.fn.modal.show({
			  ctaLabel: "Ok",
			  width: 1020,
			  class: "ark-modal",
			  title: "Invitation ",
			  content: '<section class="inv_info"></section>',
			  contentCallback: function() {
				document.querySelector('.inv_info').innerHTML = d.error;
			  },
			  ctaCallback: function() {
				mo.fn.modal.hide();
			  }
			});

		  } else {

			invitation.data = d;
			invitation.holder().querySelector('.inv_info').innerHTML = invitation.invitationOverview.template(invitation.data);
			//Read History Status and update template
			invitation.invitationOverview.statusHistory = '';
			invitation.invitationOverview.readStatusChanges(invitation.data.invitation, function() {

			});
			if (!access.user.UserRole.Readonly) {

			  invitation.holder().querySelector('.invitation-profile-bt').addEventListener('click', function() {
				singleCompanyDetails.init(invitation.data.invitation.CompanyFK);
			  });

			  invitation.holder().querySelector('.invitation-refresh').addEventListener('click', function() {
				invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId);
			  });

			  //set final status
			  invitation.holder().querySelector('.invitation-complete').addEventListener('click', function() {
				invitation.invitationOverview.completeInvitation();
			  });

			  //change pass fail code
			  invitation.holder().querySelector('.invitation-pass-fail').addEventListener('click', function() {
				invitation.invitationOverview.changeInvitationCode();
			  });

			  //Change profile of invitation
			  invitation.holder().querySelector('.change-profile').addEventListener('click', function() {
				profiles.changeProfile.init(invitation.data, function() {});
			  });

			  //only if submitted
			  /*if(invitation.data.invitation.Status > 2)
                {
                  //invitation.holder().querySelector('.invitation-complete').style.display = "none";
                  //invitation.holder().querySelector('.invitation-pass-fail').style.display = "none";
                }*/

			  invitation.holder().querySelector('.invitation-resend').addEventListener('click', function() {
				invitation.invitationOverview.resendInvitation();
			  });


			  //only if not submitted and has the same intake form as its profile
			  if (invitation.data.invitation.Status > 1 || invitation.data.invitation.ConfigFK != invitation.data.profile.ConfigFK)
				invitation.holder().querySelector('.invitation-resend').style.display = "none";
			}

			invitation.invitationOverview.progressBar();


			/*if (invitation.data.legacyData) {
                  var item1 = document.querySelector(".item.ops-status");
                  item1.innerHTML = "<strong>Securimate ID:</strong><p class='prr'> <strong>" + invitation.data.invitation.LegacyId + "</strong></p>";
                }*/

			invitation.holder().querySelector('.invitation_overview').innerHTML = "";

			hpe.ui.tabs({
			  dom: invitation.holder().querySelector('.invitation_overview'),
			  tabs: [{
				label: "Company",
				id: "intake"
			  },
					 {
					   label: "DDQ",
					   id: "ddq"
					 },
					 {
					   label: "Submit",
					   id: "accd"
					 },
					 {
					   label: "Tasks",
					   id: "task"
					 },
					 {
					   label: "Attachments",
					   id: "documents"
					 },
					 {
					   label: "Notes",
					   id: "notes"
					 },
					 {
					   label: "Custom Fields",
					   id: "custom_fields"
					 },
					 {
					   label: "Notifications",
					   id: "notifications"
					 },
					 {
					   label: "Task History",
					   id: "history"
					 },
					 {
					   label: "Audit Log",
					   id: "AuditLog"
					 },

					]
			}, function(all) {

			  invitation.holder().querySelector('.invitation_overview .container').style.marginLeft = "10px";

			  invitation.invitationOverview.showIntakeData(all[0]);
			  invitation.invitationOverview.showDDQData(all[1]);
			  invitation.invitationOverview.showAccdTab(all[2]);
			  invitation.invitationOverview.showTaskData(all[3]);

			  invitation.holder().querySelector('[tab-id="documents"]').addEventListener('click', function() {
				invitation.invitationOverview.initDocumentsTab(all[4]);
			  });

			  invitation.holder().querySelector('[tab-id="notes"]').addEventListener('click', function() {
				invitation.invitationOverview.showNotesTab(all[5]);
			  });

			  invitation.holder().querySelector('[tab-id="custom_fields"]').addEventListener('click', function() {
				invitation.invitationOverview.customFields.init(all[6]);
			  });

			  invitation.invitationOverview.showNotificationsData(all[7]);

			  invitation.invitationOverview.showHistoryData(all[8]);

			  invitation.holder().querySelector('[tab-id="AuditLog"]').addEventListener('click', function() {
				invitation.invitationOverview.initAuditTab(all[9]);
			  });

			  if (invitation.data.legacyData) {
				invitation.holder().querySelector('[tab-id="task"]').style.display = "none";
				invitation.holder().querySelector('[tab-id="history"]').style.display = "none";
				invitation.holder().querySelector('[tab-id="notifications"]').style.display = "none";
			  }


			  invitation.holder().querySelector('[tab-id="notifications"]').style.display = "none";

			  if (tabIdx)
				invitation.holder().querySelectorAll(".tabs [tab-id]")[tabIdx].click();

			  if (callback)
				callback();

			});
		  }

		});
	  },
	  resendInvitation: function() {
		var companyInfo = invitation.data.profile;
		var error = "";
		if (!companyInfo.Language)
		  error = "There is no <b>Language</b> specified for this profile. Please select a Language."


		if (!companyInfo.IntakeForm)
		  error = "There is no <b>Intake form</b> specified for this profile. Please select an Intake form."


		if (!companyInfo.EmailAddress)
		  error = "There is no <b>Email</b> specified for this profile. Please select a email."


		if (!companyInfo.Name)
		  error = "There is no <b>Name</b> specified for the main point of contact. Please provide a name."


		if (!companyInfo.Region)
		  error = "There is no <b>Region</b> specified for this profile. Please select a region."


		if (!companyInfo.Country)
		  error = "There is no <b>Country</b> specified for this profile. Please select a country."



		if (error)
		  mo.fn.modal.show({
			ctaLabel: "OK",
			title: "Error",
			class: "ark-modal",
			content: error,
		  });
		else {

		  function sendInvitation() {

			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
			$.ajax({
			  type: 'GET',
			  url: globalReferences.server + 'resources/rs/custom/php/ark/invite.php?pid=' + companyInfo.EntryId + "&cid=" + invitation.data.invitation.EntryId,
			  success: function(response) {
				var data = JSON.parse(response);
				if (!data.Success) {
				  var message = data.Message;
				  if(data.Code == "F-0" || data.Code == "F-2")
					message = "Cannot re-send the invitation as the case status is not equal to Sent.";
				  if(data.Code == "F-1")
					message = "Option not available as a new intake form version is now in use or Intake form of the profile is not the same as the intake form of the case.";

				  mo.fn.modal.show({
					ctaLabel: "OK",
					title: "Error",
					class: "ark-modal",
					content: message,
				  });
				  mo.fn.overlay.hide();
				  return;
				}


				var data = JSON.parse(data.Message);

				if (data.InvitationId) {

				  if (data.Type == "Create") {
					singleCompanyDetails.addAuditLog("Invitation",
													 'ID: ' + "'" + data.InvitationId + "'",
													 util.Email(),
													 null,
													 companyInfo.EntryId);



					invitation.invitationOverview.addAuditLog("Case created (Invitation sent)",
															  util.getAuditString('ID', null, data.InvitationId),
															  util.Email(),
															  null,
															  data.InvitationId
															 );
					mo.fn.overlay.hide();
					invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId);
				  } else if (data.Type == "Update") {

					singleCompanyDetails.addAuditLog("Invitation updated",
													 'ID: ' + "'" + data.InvitationId + "'",
													 util.Email(),
													 null,
													 companyInfo.EntryId);



					invitation.updateDDQOnResend(data.InvitationId, invitation.data.profile, Number(invitation.data.invitation.ConfigFK), function(result) {
					  if (result !== null) {
						invitation.invitationOverview.addAuditLog("Case updated (Invitaiton resent)",
																  util.getDifference({ ...data.OldInvitation,
																					  ...result.oldObj
																					 }, { ...data.NewInvitation,
																						 ...result.newObj
																						}, null, true),
																  util.Email(),
																  null,
																  data.InvitationId
																 );
					  } else {
						invitation.invitationOverview.addAuditLog("Case updated (Invitaiton resent)",
																  util.getDifference(data.OldInvitation, data.NewInvitation, null, true),
																  util.Email(),
																  null,
																  data.InvitationId
																 );
					  }
					  mo.fn.overlay.hide();
					  invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId);
					});
				  }
				} else {
				  mo.fn.overlay.hide();
				  mo.fn.modal.show({
					ctaLabel: "OK",
					title: "Error",
					class: "ark-modal",
					content: "Unknown error",
				  });
				}



			  },
			  error: function(xhr, ajaxOptions, thrownError) {
				mo.fn.overlay.hide();
				mo.fn.modal.show({
				  ctaLabel: "OK",
				  title: "Error",
				  class: "ark-modal",
				  content: "Couldn't send invitaiton. XHR: " + JSON.stringify(xhr) + ". Error: " + thrownError,
				});
			  }
			});
		  }


		  mo.fn.modal.show({
			ctaLabel: "OK",
			close: true,
			closeLabel: "Close",
			title: "Send Invitation",
			class: "ark-modal",
			content: "<p>You are about to re-send an invitation. Continue?" + "</p>",
			ctaCallback: function() {
			  mo.fn.modal.hide();

			  util.checkEmailTemplate(companyInfo.ConfigFK, companyInfo.Language, function() {
				sendInvitation();
			  });
			}
		  });


		}

	  },
	  readStatusChanges: function(inv, callback) {
		var invitationStatus = invitation.holder().querySelector('.invitation-complete');
		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_STATUS_CASES_HISTORY/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 10,
		  /* set page size*/
		  serverFiltering: true,
		  filter: {
			field: "CaseId",
			operator: "eq",
			value: inv.EntryId
		  },
		  serverSorting: true,
		  /* set default sort */
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }
		});
		dataSource.read().then(function() {
		  var view = dataSource.view();

		  if (view && view.length) {
			invitation.invitationOverview.statusHistory = view[0];
		  }
		  if (invitationStatus) {
			if (((inv.Status == 3 || inv.Status == 4 || inv.Status == 5 || inv.Status == 6)) && ((!invitation.invitationOverview.statusHistory || invitation.invitationOverview.statusHistory.Done == 1))) {
			  invitationStatus.classList.add('invitation-status-disable');
			} else invitationStatus.classList.remove('invitation-status-disable');
		  }

		});
	  },
	  checkInvitationStatus: function(callback) {
		var status = invitation.holder().querySelector('.invitation-status-disable');
		if (status) {
		  if (!access.user.UserRole['ADMIN']) {
			mo.fn.modal.show({
			  ctaLabel: ui.translate("OK"),
			  title: 'Status Closed',
			  content: "<p>The status is already provided. To change it, contact an admin.</p>",
			  ctaCallback: function() {
				mo.fn.modal.hide();
			  }
			});
		  } else {

			mo.fn.modal.show({
			  ctaLabel: "Yes",
			  closeLabel: "No",
			  title: 'Enable status button',
			  content: "<p>Do you want to re-enable the Final status button?</p>",
			  ctaCallback: function() {
				mo.fn.modal.hide();
				crud.create('4500', {
				  Admin: access.user.Email,
				  CaseId: invitation.data.invitation.EntryId,
				  Done: 0
				}, function(d) {
				  invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId);
				});
			  },
			});

		  }
		} else {
		  callback();
		}
	  },
	  completeInvitation: function() {

		var conf = {
		  pages: [{
			nav: false,
			structure: [
			  {
				group: [
				  [
					{
					  label: "Status",
					  data: "Status",
					  required: true,
					  type: "select",
					  options: ["Passed", "Denied", "Closed"],
					  values: ["Passed", "Denied", "Closed"],
					  value: '',
					  attributes: [{
						"dependencies": "CloseCode"
					  }],
					},
					{
					  label: "PASS/FAIL Case",
					  data: "CloseCode",
					  required: true,
					  type: "select",
					  options: ['Non-Responsive', "01-Reject/Fail-Incomplete, Non-Responsive", '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision', '04-Pass -Low Risk', '05-Pass-Medium Risk', '06-Pass-Medium-High Risk', '07-Pass-High Risk', '08-Pass-Hold for Review', '09-Pass-Executive Exemption', '97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case'],
					  values: ['Non-Responsive', "01-Reject/Fail-Incomplete, Non-Responsive", '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision', '04-Pass -Low Risk', '05-Pass-Medium Risk', '06-Pass-Medium-High Risk', '07-Pass-High Risk', '08-Pass-Hold for Review', '09-Pass-Executive Exemption', '97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case'],
					  attributes: [{
						"visible": "Status"
					  }],
					  validation: ["minLen|1"]
					}
				  ],
				  [{
					label: "Reason",
					data: "Comment",
					required: true,
					type: "textarea",
					validation: ["minLen|1"]
				  }]
				],
			  },
			  {
				header: "Confirmation email/attachment",
				description: 'Please upload an email confirmation',
				group: [
				  [{
					label: "Select File",
					data: "DeleteFile",
					required: true,
					type: "kUpload",
					value: null,
					uploadConfig: {
					  formId: 1275,
					  extensions: [],
					  maxFileSize: 10
					}
				  }]
				],
			  },
			],
		  }],
		};

		invitation.invitationOverview.checkInvitationStatus(function() {
		  mo.fn.modal.show({
			ctaLabel: "Submit",
			class: "ark-modal",
			title: "Complete the case",
			content: '<div class="complete_case" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {
			  document.querySelector('.dxpModalFooter').classList.remove('hidden');

			  conf.dom = document.querySelector(".dxpModalContent .complete_case");
			  invitation.completeConf = conf;
			  conf.dataset = invitation.data.invitation;
			  nbsf.init(conf, 0);

			  if (conf.dataset.CloseCode !== '99-Permanently Deleted Case') document.querySelector('.complete_case .row:last-child').style.display = 'none';
			  document.querySelector('[data-name="CloseCode"]').addEventListener('change', function(ev) {
				if (ev.target.value == '99-Permanently Deleted Case') {
				  document.querySelector('.complete_case .row:last-child').style.display = 'block';
				} else document.querySelector('.complete_case .row:last-child').style.display = 'none';

			  });

			  document.querySelector('.complete_case [data-name="Status"]').addEventListener('change', function(ev) {
				var outletOptions = document.querySelector('.complete_case [data-name="CloseCode"]');
				var arr = [];
				// Remove existing options
				Array.from(outletOptions).forEach((option) => {
				  outletOptions.removeChild(option);
				});
				switch (ev.target.value) {
				  case 'Passed':
					arr = ['04-Pass -Low Risk', '05-Pass-Medium Risk', '06-Pass-Medium-High Risk', '07-Pass-High Risk', '08-Pass-Hold for Review', '09-Pass-Executive Exemption']
					break;

				  case 'Denied':
					arr = ['01-Reject/Fail-Incomplete, Non-Responsive', '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision']
					break;

				  case 'Closed':
					arr = ['97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case', 'Non-Responsive']
					break;
				}

				var opt = document.createElement('option')
				opt.appendChild(document.createTextNode('Select one'));
				opt.value = '';
				opt.option = 'Select value';
				outletOptions.appendChild(opt);

				arr.map((optionData) => {
				  var opt = document.createElement('option')
				  opt.appendChild(document.createTextNode(optionData));
				  opt.value = optionData;
				  opt.option = optionData;
				  outletOptions.appendChild(opt);
				});
			  });
			},
			ctaCallback: function() {

			  const old = {...invitation.data.invitation};
			  const oldStatus = old.Status;

			  nbsf.data.update(invitation.completeConf, {});
			  var data = invitation.completeConf.dataset;

			  var res = nbsf.ev.global(invitation.completeConf, true);
			  if (data.CloseCode !== '99-Permanently Deleted Case' && res.input.fail.filter(el => el.classList.contains('kUpload')).length) {
				res.total.fail = 0;
			  }

			  if (res.total.fail > 0)
				return;



			  mo.fn.modal.lock();


			  var inv = invitation.data.invitation;
			  if (data.Status == "Passed")
				inv.Status = 4;
			  if (data.Status == "Denied")
				inv.Status = 5;
			  if (data.Status == "Closed")
				inv.Status = 6;
			  if (conf.dataset.CloseCode === '99-Permanently Deleted Case') inv.Status = 6;
			  inv.CompletedTS = (new Date()).toISOString();
			  inv.CloseCode = data.CloseCode;
			  inv.CloseComment = data.Comment;

			  const newStatus = inv.Status;
			  crud.update(3693, inv.EntryId, inv, function(d) {
				console.log(d);
				if (d) {

				  //update Status table 
				  if (invitation.invitationOverview.statusHistory.EntryId) {
					crud.update(4502, invitation.invitationOverview.statusHistory.EntryId, {
					  Done: 1
					}, function(d) {
					  invitation.invitationOverview.statusHistory.Done = 1;
					});
				  }

				  invitation.data.overview.GlobalStatus = d.Status;
				  crud.update(3702, invitation.data.overview.EntryId, invitation.data.overview, function(d) {
					console.log(d);
				  });

				  var updateSection = function() {
					mo.fn.modal.hide();
					mo.fn.modal.unlock();

					invitation.invitationOverview.updateSection(inv.EntryId, null, function() {
					  mo.fn.overlay.hide();
					  var status = invitation.holder().querySelector('.invitation-complete');
					  status.classList.add('invitation-status-disable');
					});
				  };

				  //if status was changed for the first time
				  //send data to iCertis
				  if(oldStatus <= 2 && newStatus > 2) {
					$.ajax({
					  type: 'GET',
					  url: 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/ark/sync_case.php?caseId='+inv.EntryId,
					  success: function() {
						updateSection();
					  },
					  error: function(err) {
						mo.fn.modal.show({
						  ctaLabel: ui.translate("OK"),
						  title: ui.translate("Error"),
						  content: "<p>" + "Could not update information in ICertis" + "</p>",
						  ctaCallback: function() {
							updateSection();
						  }
						});
					  }
					});
				  }
				  else {
					//if status was changed for the second,third,etc time
					//send a notification email to the contract team
					if(newStatus > 2) 
					{
					  invitation.invitationOverview.notifyContractTeam(
						invitation.data.invitation.EntryId,  
						invitation.data.profile.PartyId,
						invitation.data.profile.CompanyName,
						newStatus,
						invitation.data.invitation.Region
					  );

					}
					updateSection();
				  }



				  invitation.invitationOverview.addAuditLog("Case Completed",
															"Status: " + invitation.manageStatus(d.Status) + ";##Close Code: " + inv.CloseCode + ";##Comment: " + data.Comment,
															util.Email());


				  $.ajax({
					type: 'GET',
					url: 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/ark/rescoring.php',
					success: function() {},
					error: function() {}
				  });
				} else {
				  mo.fn.modal.show({
					ctaLabel: ui.translate("OK"),
					title: ui.translate("Critical"),
					content: "<p>" + ui.translate("Error_DataNotSaved") + "</p>",
					ctaCallback: function() {
					}
				  });
				}
			  });


			}
		  });
		});


	  },
	  notifyContractTeam: function(caseId, partyId, companyName, status, region) {

		var email = "sergey.kalinin@clevercraft.net"; //test

		if(region == "EMEA")
		  email = "emea_rlb_onboarding_notification@hpe.com";
		if(region == "AMS")
		  email = "hpe_contracts_lar@hpe.com";
		if(region == "APJ")
		  email = "hpe_contracts-apj@hpe.com";


		var statusName = "";
		if(status == 4)
		  statusName = "Approved";
		if(status == 5 || status == 6)
		  statusName = "Rejected";

		mail.send({
		  "ID": "ARK_Status_CT",
		  "To": email,
		  "Col1": invitation.data.invitation.EntryId,
		  'Col2': invitation.data.profile.CompanyName,
		  'Col3': invitation.data.profile.PartyId,
		  'Col4': statusName
		});

	  },
	  changeInvitationCode: function() {

		var conf = {
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "PASS/FAIL Case",
				  data: "CloseCode",
				  required: true,
				  type: "select",
				  options: ['Non-Responsive', "01-Reject/Fail-Incomplete, Non-Responsive", '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision', '04-Pass -Low Risk', '05-Pass-Medium Risk', '06-Pass-Medium-High Risk', '07-Pass-High Risk', '08-Pass-Hold for Review', '09-Pass-Executive Exemption', '97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case'],
				  values: ['Non-Responsive', "01-Reject/Fail-Incomplete, Non-Responsive", '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision', '04-Pass -Low Risk', '05-Pass-Medium Risk', '06-Pass-Medium-High Risk', '07-Pass-High Risk', '08-Pass-Hold for Review', '09-Pass-Executive Exemption', '97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case'],
				  attributes: [{
					"visible": "Status"
				  }],
				  validation: ["minLen|1"]
				}],
				[{
				  label: "Reason",
				  data: "Comment",
				  required: true,
				  type: "textarea",
				  validation: ["minLen|1"]
				}]
			  ],
			},
						{
						  header: "Confirmation email/attachment",
						  description: 'Please upload an email confirmation',
						  group: [
							[{
							  label: "Select File",
							  data: "DeleteFile",
							  required: true,
							  type: "kUpload",
							  value: null,
							  uploadConfig: {
								formId: 1275,
								extensions: [],
								maxFileSize: 10
							  }
							}]
						  ],
						},

					   ],
		  }],
		};

		mo.fn.modal.show({
		  ctaLabel: "Submit",
		  class: "ark-modal",
		  title: "Complete the case",
		  content: '<div class="complete_case" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			conf.dom = document.querySelector(".dxpModalContent .complete_case");
			invitation.completeConf = conf;
			conf.dataset = invitation.data.invitation;
			nbsf.init(conf, 0);

			if (conf.dataset.CloseCode !== '99-Permanently Deleted Case') document.querySelector('.complete_case .row:last-child').style.display = 'none';
			document.querySelector('[data-name="CloseCode"]').addEventListener('change', function(ev) {
			  if (ev.target.value == '99-Permanently Deleted Case') {
				document.querySelector('.complete_case .row:last-child').style.display = 'block';
			  } else document.querySelector('.complete_case .row:last-child').style.display = 'none';

			});

		  },
		  ctaCallback: function() {
			nbsf.data.update(invitation.completeConf, {});
			var data = invitation.completeConf.dataset;

			var res = nbsf.ev.global(invitation.completeConf, true);

			if (data.CloseCode !== '99-Permanently Deleted Case' && res.input.fail.filter(el => el.classList.contains('kUpload')).length) {
			  res.total.fail = 0;
			}

			if (res.total.fail > 0)
			  return;



			mo.fn.modal.lock();

			var inv = invitation.data.invitation;
			inv.CloseCode = data.CloseCode;
			inv.CloseComment = data.Comment;
			if (conf.dataset.CloseCode === '99-Permanently Deleted Case') inv.Status = 6;

			crud.update(3693, inv.EntryId, inv, function(d) {
			  console.log(d);
			  if (d) {

				mo.fn.modal.unlock();
				mo.fn.modal.hide();

				invitation.invitationOverview.updateSection(inv.EntryId, null, function() {
				  mo.fn.overlay.hide();
				});

				invitation.invitationOverview.addAuditLog("Pass/Fail Code",
														  "Close Code: " + inv.CloseCode + ";##Comment: " + data.Comment,
														  util.Email());
			  } else {
				mo.fn.modal.show({
				  ctaLabel: ui.translate("OK"),
				  title: ui.translate("Critical"),
				  content: "<p>" + ui.translate("Error_DataNotSaved") + "</p>",
				  ctaCallback: function() {
					director.killSession();
				  }
				});
			  }
			});


		  }
		});
	  },
	  showTaskData: function(node) {
		if (!invitation.data.legacyData)
		  invitation.invitationOverview.tasks.init(node);
	  },
	  createPreview: function(node, config, dataset, type) {
		config.dataset = dataset || invitation.data.legacyDDQ || {};
		config.reference = {
		  languages: reference.translations.data
		};

		function populateGroup(divGroupData, header, groupArray, dataset) {
		  if (header) {
			var spanHeader = document.createElement("div");
			spanHeader.classList.add("header");
			spanHeader.innerHTML = ui.translate(header);

			divGroupData.appendChild(spanHeader);
		  }

		  for (var l = 0; l < groupArray.length; l++) {
			var group = groupArray[l];
			for (var h = 0; h < group.length; h++) {

			  var spanValue = document.createElement("div");
			  var value = dataset[group[h].data];
			  //EXTRA LOGIC
			  if (group[h].type == "pdf") {

				if (value == "Y") {
				  spanValue.classList.add("pdf-value");
				  spanValue.innerHTML = ui.translate("Completed");
				} else spanValue.innerHTML = "-";

				divGroupData.appendChild(spanValue);
				return;
			  }


			  var divRow = document.createElement("div");
			  divRow.classList.add("row");

			  if (group[h].label) {
				var spanName = document.createElement("div");
				spanName.classList.add("name");
				var labelValue = ui.translate(group[h].label) + ":";
				spanName.innerHTML = labelValue.replace(/\:{2,}/, ':');
				divRow.appendChild(spanName);
			  }


			  //COMMON LOGIC]
			  spanValue.classList.add("value");
			  spanValue.innerHTML = dataset[group[h].data] || "-";
			  if (spanValue.innerHTML == "Select one")
				spanValue.innerHTML = "-";

			  //EXTRA LOGIC
			  if (group[h].data == "Ownership") {
				spanValue.innerHTML = spanValue.innerHTML + " %";
			  }
			  if (group[h].type == "agree") {
				if(dataset[group[h].data] == "Y")
				  spanValue.innerHTML = ui.translate("Yes");
				else if(dataset[group[h].data] == "N")
				  spanValue.innerHTML = ui.translate("No");
				else 
				  spanValue.innerHTML = dataset[group[h].data];
			  }


			  spanValue.innerHTML = spanValue.innerHTML.replace(/,/g, ", ");

			  divRow.appendChild(spanValue);

			  divGroupData.appendChild(divRow);
			}
		  }
		}

		function setGroupColumnClass(divGroupData, idx, length) {
		  if (idx + 1 < length && idx % 2 == 0)
			divGroupData.classList.add("group-left");

		  if (idx + 1 <= length && idx % 2 != 0)
			divGroupData.classList.add("group-right");

		}

		var divReview = document.createElement("div");
		divReview.classList.add("review-page");
		divReview.style.fontFamily = "Metric, HPSimplified, Arial, sans-serif, Helvetica !important";

		node.appendChild(divReview);


		var firstPage = 0;
		var lastPage = 0;

		for (var i = 0; i < config.pages.length; i++)
		  if (config.pages[i].review) {
			lastPage = i;
			break;
		  }


		if (type == 2) {
		  firstPage = config.pages.length - 1;
		  lastPage = config.pages.length;
		}

		for (var i = firstPage; i < lastPage; i++) {
		  if (type == 0 && !config.pages[i].ddq || type != 0 && config.pages[i].ddq)
			continue;


		  var divPageData = document.createElement("div");
		  divPageData.classList.add("page");
		  divReview.appendChild(divPageData);


		  var dPageTitle = document.createElement("div");
		  dPageTitle.classList.add("title");
		  dPageTitle.innerHTML = ui.translate(config.pages[i].title);

		  divPageData.appendChild(dPageTitle);

		  //CUSTOM LOGIC FOR DDQ
		  if (config.pages[i].ddq) {

			for (var j = 0; j < config.pages[i].structure.length; j++) {
			  var structure = config.pages[i].structure[j];

			  var divGroupData = document.createElement("div");
			  divGroupData.classList.add("group-question");


			  if (structure.description) {
				var spanMainQuestion = document.createElement("div");
				spanMainQuestion.classList.add("question");
				spanMainQuestion.classList.add("question-text");
				if (typeof(structure.description) === "string")
				  spanMainQuestion.innerHTML = ui.translate(structure.description);
				else spanMainQuestion.innerHTML = structure.description(config);

				divGroupData.appendChild(spanMainQuestion);
			  }

			  var score = null;
			  for (var l = 0; l < structure.group.length; l++) {
				var group = structure.group[0];
				for (var a = 0; a < group.length; a++) {
				  var element = group[a];

				  //DO NOT SHOW THE GLOBALTRADING CHECkBOX IF THE GLOBAL TRADING QUESTION WAS ANSWERED YES
				  if (element.label == "DDQPage_GlobalTradingQuestion_CheckBox") {
					if (config.dataset[group[a - 1].data] == "Y")
					  continue;
				  }

				  if (element.label && element.type != "kUpload") {
					var spanName = document.createElement("div");
					spanName.classList.add("subquestion");
					spanName.classList.add("question-text");
					spanName.innerHTML = ui.translate(element.label);
					divGroupData.appendChild(spanName);
				  }

				  var value = config.dataset[element.data];

				  if (!invitation.data.data && invitation.data.legacyDDQ) {
					var qId = element.questionId;
					var qIdParsed = qId.split("-")[0].split("_")[0];
					var keys = Object.keys(invitation.data.legacyDDQ);
					var key = element.securimateName;
					if (!key)
					  key = keys.find(x => x.toLowerCase().includes(qIdParsed.toLowerCase() + "_"));

					if (key)
					  value = invitation.data.legacyDDQ[key];

				  }

				  var divValue = document.createElement("div");
				  divValue.innerHTML = value || "-";

				  if (value && element.type == "radio") {
					divValue.classList.add("answer");

					if (value == "Yes")
					  value = "Y";
					if (value == "No")
					  value = "N";
					if (value.includes("No Compliance"))
					  value = "NCP";

					var idx = element.values.indexOf(value);
					if (idx >= 0) {
					  divValue.innerHTML = ui.translate(element.options[idx]);
					  if (element.score) {
						score = element.score[idx];

						var divScore = document.createElement("div");
						divScore.classList.add("score");
						divScore.innerHTML = "+ " + score;
						if (score == 0)
						  divScore.classList.add("zero-points");
						else divScore.classList.add("nonzero-points");
						divValue.appendChild(divScore);
					  }
					} else divValue.innerHTML = value;
				  } else if (value && element.type == "checkbox") {
					divValue.innerHTML = "";
					var values = value.split(',');
					for (var v = 0; v < values.length; v++) {
					  var divV = document.createElement("div");
					  divV.classList.add("answer");
					  divV.innerHTML = ui.translate(element.options[element.values.indexOf(values[v])]);
					  divValue.appendChild(divV);

					}
				  } else if (value && element.type == "kUpload") {
					divValue.innerHTML = "";

					var divLink = document.createElement("div");
					divLink.classList.add("answer-attachment");


					var link = globalReferences.server + 'form/' + element.uploadConfig.formId + '/attachments/' + config.dataset.EntryId + '/' + element.data + '?' + value;
					var aLink = document.createElement("a");
					aLink.setAttribute("target", "_blank");
					aLink.innerHTML = value;
					aLink.setAttribute("href", link);

					divLink.appendChild(aLink);
					divValue.appendChild(divLink);
				  }


				  if (value && element.type == "agree") {
					divValue.classList.add("text-answer");
					divValue.innerHTML = ui.translate("Yes");
				  } else
					divValue.classList.add("text-answer");



				  divGroupData.appendChild(divValue);
				}


			  }


			  divPageData.appendChild(divGroupData);
			}
		  }
		  //COMMON LOGIC
		  else {
			for (var j = 0; j < config.pages[i].structure.length; j++) {

			  var structure = config.pages[i].structure[j];

			  if (structure.repeatable) {
				var data = config.dataset[config.pages[i].structure[j].repeatable];

				if (data)
				  data = JSON.parse(data);

				if (data)
				  for (var n = 0; n < data.length; n++) {
					var headerText = structure.header;

					//EXTRA LOGIC
					if (config.pages[i].title == "OnwersPage_Title")
					  headerText = ui.translate("Person") + " " + (n + 1);

					//COMMON LOGIC
					var divGroupData = document.createElement("div");
					divGroupData.classList.add("group");

					setGroupColumnClass(divGroupData, n, data.length);

					populateGroup(divGroupData, headerText, structure.group, data[n]);
					divPageData.appendChild(divGroupData);

				  }

			  } else {
				//COMMON LOGIC
				var divGroupData = document.createElement("div");
				divGroupData.classList.add("group");

				if (config.pages[i].title == "OwnersPage_Title") {
				  populateGroup(divGroupData, structure.header, structure.group, config.dataset);
				} else {
				  setGroupColumnClass(divGroupData, j, config.pages[i].structure.length);

				  populateGroup(divGroupData, structure.header, structure.group, config.dataset);
				}
				divPageData.appendChild(divGroupData);
			  }

			}
		  }


		  var divPageData2 = document.createElement("div");
		  divPageData2.classList.add("separator");
		  divReview.appendChild(divPageData2);

		  divReview.querySelectorAll(".required").forEach(x => x.remove());
		  divReview.querySelectorAll(".question-info").forEach(x => x.remove());

		}
	  },
	  showDDQData: function(node) {

		try {
		  if (invitation.data.invitation.Status >= 1) {

			if (!invitation.data.legacyData && invitation.data.scoring) {
			  node.innerHTML = "<div>" +
				"<div class='ddq-calc' style-'margin-bottom:0px'>" +
				"<div class='ddq-row'><div class='ddq-total'>DDQ Score (weighted): </div><div class='value ddq-total-value' >" + invitation.data.scoring.DDQPoints + " / " + invitation.data.scoring.DDQMax + " * " + invitation.data.scoring.DDQWeight + " = " + invitation.data.scoring.DDQScore + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>DDQ Score: </div><div class='value'>" + invitation.data.scoring.DDQPoints + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>Max DDQ Score: </div><div class='value'>" + invitation.data.scoring.DDQMax + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>DDQ Weight: </div><div class='value'>" + invitation.data.scoring.DDQWeight + "</div></div>" +

				"<div class='ddq-row'><div style='margin-top:20px'>Country Score (weighted): </div><div class='value' style='margin-top:20px'>" + invitation.data.scoring.CountryScoreClean + " / " + invitation.data.scoring.CountryMax + " * " + invitation.data.scoring.CPIWeight + " = " + invitation.data.scoring.CountryScore + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>Maximum Score: </div><div class='value'>" + invitation.data.scoring.CountryMax + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>Country CPI: </div><div class='value'>" + (invitation.data.scoring.CountryCPI || "-") + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>Country Score: </div><div class='value'>" + invitation.data.scoring.CountryScoreClean + "</div></div>" +
				"<div class='ddq-row'><div class='caption'>CPI Weight: </div><div class='value'>" + invitation.data.scoring.CPIWeight + "</div></div>" +

				"<div class='ddq-row'><div style='margin-top:20px'>Total Score: </div><div class='value' style='margin-top:20px'>" + invitation.data.scoring.DDQScore + " + " + invitation.data.scoring.CountryScore + " = " + invitation.data.scoring.RiskScore + "</div></div>" +

				"</div>" +
				"<div class='scoring-exception'></div>" +
				"<div class='ddq-questions'></div>" +
				"</div>";

			  var config = util.parseConfigStr(invitation.data.config.Config);
			  if (invitation.data.scoring.ExceptionRiskRank) {
				//TODO REMOVE HARDCODE
				var exception = config.exception;

				var excep = node.querySelector(".scoring-exception");

				var exceptionCondition = exception.pass;
				if(exception.fail)
				  exceptionCondition = exception.fail;

				excep.innerHTML = "Special Condition Met: " + exceptionCondition.replaceAll("&&", " and ").replaceAll("||", " or ") + " - " + invitation.data.scoring.ExceptionRiskRank;

			  }

			  if (config.weight.useUnweightedDdqValue) {
				var ddqTotal = node.querySelector(".ddq-total");
				ddqTotal.innerHTML = "DDQ Score: ";

				var ddqTotalValue = node.querySelector(".ddq-total-value");
				ddqTotalValue.innerHTML = invitation.data.scoring.DDQScore;
			  }


			} else {
			  node.innerHTML = "<div>" +
				"<div class='ddq-questions'></div>" +
				"</div>";

			}

			if (!invitation.data.data && !invitation.data.legacyDDQ) {
			  node.querySelector(".ddq-questions").innerHTML = "No data available";
			} else {

			  if ((!invitation.data.data || invitation.data.config.EntryId == 107) && invitation.data.legacyDDQ)
				invitation.invitationOverview.legacyDataPreview(node, invitation.data.legacyDDQ, "ddqData");
			  else {
				invitation.invitationOverview.createPreview(node.querySelector(".ddq-questions"), util.parseConfigStr(invitation.data.config.Config), invitation.data.data, 0);

				node.querySelector(".ddq-questions .title").style.fontSize = "20px";
				node.querySelector(".ddq-questions .title").style.marginTop = "40px";
				node.querySelector(".ddq-questions .title").style.marginBottom = "30px";
				node.querySelector(".ddq-questions .review-page").style.marginTop = "0px";
				node.querySelector(".ddq-questions .group-question").style.marginTop = "20px";
			  }
			}

		  } else
			invitation.holder().querySelector('[tab-id="ddq"]').style.display = "none";


		} catch (e) {}
	  },
	  legacyDataPreview: function(node, data, type) {
		var legacyData = JSON.parse(data.JSON);
		var data = [];
		if (type == "intakeData")
		  data = ["Official Company Name", ...Object.keys(legacyData).filter(x =>
																			 !x.includes("Column") &&
																			 !x.includes("Case") &&
																			 !x.includes("Q") &&
																			 !x.includes("Third") &&
																			 !x.includes("SubmittedBy") &&
																			 !x.includes("TrainingCompleted") &&
																			 !x.replace(/\s+/g, '').includes("IntakeFormName") &&
																			 !x.replace(/\s+/g, '').includes("OfficialCompanyName") &&
																			 !x.includes("Profile") &&
																			 !x.includes("Submitted") &&
																			 !x.includes("Bus-") &&
																			 !x.includes("Aut-") && ["Created", "CreatedBy", "EntryId", "Modified", "ModifiedBy"].indexOf(x) == -1)];

		if (type == "ddqData")
		  data = Object.keys(legacyData).filter(x =>
												(x.includes("Q") || x.includes("Bus-")) &&
												["Created", "CreatedBy", "EntryId", "Modified", "ModifiedBy"].indexOf(x) == -1);

		if (type == "accdData") {
		  var config = {};
		  config.reference = {
			languages: reference.translations.data
		  };

		  var html = '<div class="accd-page">';
		  const possibleNames = ["officialcompanyname", "autcompanyname"];
		  const possibleEmails = ["submittedbyemail", "autemail"];
		  const nameField = Object.keys(legacyData).find(key => !!possibleNames.find(el => el === key.replace(/\W+/g, '').toLowerCase()));
		  const emailField = Object.keys(legacyData).find(key => !!possibleEmails.find(el => el === key.replace(/\W+/g, '').toLowerCase()));
		  const submitDate = reference.switchMonthDay(invitation.data.legacyData.CaseIntakeFormSubmitted || invitation.data.legacyData.CaseIntakeFormLastAccess) || "";
		  html += invitation.invitationOverview.setAccdHTML(config, nameField ? legacyData[nameField] : undefined, util.getDate(submitDate, true));
		  html = html + "</div>";
		  node.innerHTML += html;
		  const values = [{
			key: "Name",
			value: legacyData["Submitted By: Name"] || legacyData["Aut-Company Name:"]
		  },
						  {
							key: "Position",
							value: legacyData["Submitted By: Title"] || legacyData["Aut-Title:"]
						  },
						  {
							key: "Telephone",
							value: legacyData["Submitted By: Phone"] || legacyData["Aut-Telephone:"]
						  },
						  {
							key: "Email",
							value: emailField ? legacyData[emailField] : undefined
						  },
						  {
							key: "Confirm Email",
							value: emailField ? legacyData[emailField] : undefined
						  },
						  {
							key: "Date",
							value: util.getDate(submitDate, false) + " UTC"
						  }
						 ];
		  node.innerHTML += "<div class='review-page'><div class='page' style='float: none;  margin-top: -30px;'><div class='group'></div>  </div> </div>";
		  values.map(val => {
			node.querySelector('.group').innerHTML += "<div class='row'><div class='name'>" + val.key + ": </div><div class='value'>" + (val.value || "-") + "</div></div>";
		  });
		  return;
		}

		node.innerHTML += "<div class='review-page'><div class='page' style='float: none;  margin-top: -30px;'><div class='group'></div>  </div> </div>";
		data.forEach(function(el) {
		  if (legacyData[el]) {
			if (legacyData[el] == 'Training Completed') {
			  node.querySelector('.group').innerHTML += "<div class='row'><div class='title'>Training: </div><div class='group'><div class='pdf-value'>" + (legacyData[el] || "-") + "</div></div></div>";
			} else
			  node.querySelector('.group').innerHTML += "<div class='row'><div class='name'>" + el.replace(':', '').replace(/\s+/, ' ') + ": </div><div class='value'>" + (legacyData[el] || "-") + "</div></div>";
		  }
		});
	  },
	  showIntakeData: function(node) {
		if (((!invitation.data.data || invitation.data.config.EntryId == 107) && invitation.data.legacyData)) {
		  if (invitation.data.legacyDDQ) {
			invitation.invitationOverview.legacyDataPreview(node, invitation.data.legacyDDQ, "intakeData");

			function setGroupColumnClass(divGroupData, idx, length) {
			  if (idx + 1 < length && idx % 2 == 0)
				divGroupData.classList.add("group-left");
			  if (idx + 1 <= length && idx % 2 != 0)
				divGroupData.classList.add("group-right");
			}


			var divPageReview = document.createElement('div');
			divPageReview.classList.add("review-page");
			var divPage = document.createElement('div');
			var div = document.createElement('div');
			divPage.classList.add("page");
			var group1 = node.querySelector('.group');
			var dPageTitle = document.createElement("div");
			dPageTitle.classList.add("title");
			dPageTitle.style.marginBottom = "-20px";
			dPageTitle.innerHTML = 'Company profile';

			divPage.appendChild(dPageTitle);

			node.appendChild(divPageReview);
			divPageReview.appendChild(divPage);
			divPage.appendChild(div);
			divPage.appendChild(group1);
			var separator = document.createElement('div');
			separator.innerHTML += '<div class="separator"></div>';
			divPage.appendChild(separator);
			divPage.appendChild(div);
			var dataSource = [];
			var columns = [];
			var validation = {
			  Name: false,
			  Email: false,
			  Phone: false,
			  Relationship: false,
			  Owner: false,
			  KeyManager: false,
			  BoardMemmber: false,
			  KeyConsultant: false,
			  Owner_: false
			}
			if (invitation.data.legacyKeyPersonel) {
			  //const owner = invitation.data.legacyKeyPersonel.find(el => el.PersonType.indexOf("Owner") > -1);
			  invitation.data.legacyKeyPersonel.map(kp => {
				dataSource.push({
				  Name: kp.KeyPersonName,
				  Email: kp.Email,
				  Phone: kp.Phone,
				  Position: kp.Position,
				  Address: kp.Address,
				  Role: kp.PersonType,
				  Ownership: `${!!kp.Ownership ? ((kp.Ownership || 0) * 100).toFixed(0) : '-'}%`,
				  //Relationship: '',//invitation.data.legacyData['CasePrin_'+i+'Relationship'],
				  //Owner: kp.PersonType.indexOf("Owner") > -1 ? 'Yes' : 'No',
				  //KeyManager: invitation.data.legacyData['CasePrin_'+i+'KeyManager'],
				  //BoardMemmber: kp.PersonType.indexOf("Board Member") > -1 ? 'Yes' : 'No',
				  //KeyConsultant: kp.PersonType.indexOf("Key Consultant") > -1 ? 'Yes' : 'No',
				  //Shareholder: ((kp.Ownership || 0) / 100),							
				  //Owner_:	owner ? owner.Email : '',							
				});
			  });
			}
			/*for(var i = 1; i <= 10; i++)
                              {
                                if(invitation.data.legacyData['CasePrincipal_'+i]) {
                                  dataSource.push({
                                    Name: invitation.data.legacyData['CasePrincipal_'+i],
                                    Email: invitation.data.legacyData['CasePrin_'+i+'Email'],
                                    Phone: invitation.data.legacyData['CasePrin_'+i+'Phone'],
                                    Relationship: invitation.data.legacyData['CasePrin_'+i+'Relationship'],
                                    Owner: invitation.data.legacyData['CasePrin_'+i+'Owner'],
                                    KeyManager: invitation.data.legacyData['CasePrin_'+i+'KeyManager'],
                                    BoardMemmber: invitation.data.legacyData['CasePrin_'+i+'BoardMemmber'],
                                    KeyConsultant: invitation.data.legacyData['CasePrin_'+i+'KeyConsultant'],
                                    Shareholder: invitation.data.legacyData['CasePrin_'+i+'Owner_1'],							
                                    Owner_:	invitation.data.legacyData['CasePrin_'+i+'Owner_1'],							
                                  });
                                }
                              }*/
			/*var columns = [
                                    {
                                      field: "Name",
                                      title: "Name",
                                      hidden: false,
                                      filterable: true,
                                      width: "150px"
                                    },
                                    {
                                      field: "Email",
                                      title: "Email",
                                      hidden: false,
                                      filterable: true,
                                      width: "180px"
                                    },
                                    {
                                      field: "Phone",
                                      title: "Phone",
                                      hidden: false,
                                      filterable: true,
                                      width: "140px"
                                    },
                                    {
                                      field: "Relationship",
                                      title: "Relationship",
                                      hidden: false,
                                      filterable: true,
                                      width: "150px"
                                    },
                                    {
                                      field: "Owner",
                                      title: "Owner",
                                      hidden: false,
                                      filterable: true,
                                      width: "120px"
                                    },	
                                    {
                                      field: "KeyManager",
                                      title: "Key Manager",
                                      hidden: false,
                                      filterable: true,
                                      width: "150px"
                                    },
                                    {
                                      field: "BoardMemmber",
                                      title: "Board member",
                                      hidden: false,
                                      filterable: true,
                                      width: "150px"
                                    },
                                    {
                                      field: "KeyConsultant",
                                      title: "Key Consultant",
                                      hidden: false,
                                      filterable: true,
                                      width: "150px"
                                    },
                                    {
                                      field: "Owner_",
                                      title: "Owner %",
                                      hidden: false,
                                      filterable: true,
                                      width: "120px",
                                      template: function(d) {
                                        if(!d.Owner_)
                                          return "";

                                        return (d.Owner_ * 100) + "%";
                                      }
                                    }
                                  ];

                                  div.style.float = "left";
                                  div.innerHTML += '<h4 style="margin-top: 50px;">Key personnel</h4><div class="intake-prin-grid"></div>';
                                  $('.intake-prin-grid').kendoGrid({
                                    height: 500,
                                    noRecords: {
                                      template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
                                    },
                                    dataSource: dataSource,
                                    columns: columns,
                                    pageable: {
                                      buttonCount: 4,
                                      pageSize: 10,
                                      pageSizes: [10, 25, 50, 100],
                                      refresh: true
                                    },
                                    scrollable: true,
                                    sortable: true,
                                    filterable: true,
                                    resizable: true,
                                    filter: util.kendoGrid.filter
                                  });*/

			//div.classList.add('group');
			//div.innerHTML += '<div class="title">Key personnel</div>';

			div.classList.add('page');
			div.innerHTML += '<div class="title">Key personnel</div>';

			dataSource.forEach(function(el, idx) {
			  var divGroupData = document.createElement("div");
			  divGroupData.classList.add("group");

			  setGroupColumnClass(divGroupData, idx, dataSource.length);
			  var yNVals = [];
			  for (const [key, value] of Object.entries(el)) {
				if (key == 'Shareholder') {
				  divGroupData.innerHTML += "<div class='row'><div class='name'>Ownership/Shareholder %: </div><div class='value'>" + (Number(value * 100) || "-") + " %</div></div>";
				} else if (key !== 'BoardMemmber' && key !== 'Owner' && key !== 'KeyManager' && key !== 'KeyConsultant') {
				  divGroupData.innerHTML += "<div class='row'><div class='name'>" + key + ": </div><div class='value'>" + (value || "-") + "</div></div>";
				} else {
				  if (value == 'Yes') yNVals.push(key.split(/(?=[A-Z])/).join(" "));
				}
			  }
			  if (yNVals.length) divGroupData.innerHTML += "<div class='row'><div class='name'>Role </div><div class='value'>" + (yNVals.join(', ') || "-") + "</div></div>";

			  div.appendChild(divGroupData);
			});
		  } else node.innerHTML = "No data available";
		} else {
		  invitation.invitationOverview.createPreview(node, util.parseConfigStr(invitation.data.config.Config), invitation.data.data, 1);

		  //TODO

		}

		try {
		  var country = "";
		  node.querySelectorAll(".name").forEach(x => {
			var elValue = x.parentElement.querySelector(".value");
			var value = elValue.innerHTML;
			if (!value || value == "-")
			  return;

			if (x.innerHTML == "Country" || x.innerHTML.includes("Country")) {
			  x.parentElement.querySelector(".value").innerHTML = reference.convertCountry(value) || value;
			  country = value;
			}


			if (x.innerHTML == "State/Province" && country) {
			  x.parentElement.querySelector(".value").innerHTML = reference.convertState(country, value);
			}
		  });
		} catch (e) {

		}
	  },
	  showHistoryData: function(node) {
		if (!invitation.data.legacyData)
		  invitation.invitationOverview.history.init(node);
	  },
	  showNotificationsData: function(node) {

		if (invitation.data.legacyData)
		  return;

		node.innerHTML = '<div class="notifications-tab"><div class="notifications_data_inv"></div>' +
		  '<a href="#" class="k-button-action k-button-action k-grid-updateNotificationsInv" style="padding: 10px 5px;"> Save changes </a>' +
		  "</div>";
		if (invitation.data.invitation.Status != 1)
		  node.querySelector(".k-grid-updateNotificationsInv").style.display = "none";

		var conf = {
		  dom: document.querySelector('.notifications_data_inv'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Expiration date:",
				  data: "Expiry",
				  required: true,
				  type: "datetime",
				  placeholder: "Select a date",
				  dtp: {
					format: 'Y-m-d',
					timepicker: false,
					formatDate: 'Y-m-d',
					scrollMonth: false,
					scrollInput: false,
					onChangeDateTime: function(dp, $input) {}
				  }
				}, ]
			  ]
			},
						{
						  header: 'Reminders',
						  group: [
							[]
						  ]
						},
						{
						  repeatable: "reminders",
						  repeatableLimit: 10,
						  //  description: 'Score ranges',
						  group: [
							[{
							  label: "Reminder date",
							  data: "ReminderDate",
							  required: true,
							  type: "datetime",
							  dtp: {
								format: 'Y-m-d H:i',
								formatDate: 'Y-m-d',
								scrollMonth: false,
								scrollInput: false,
								onChangeDateTime: function(dp, $input) {}
							  }
							},

							 {
							   label: "Template",
							   data: "ReminderTemplateId",
							   type: "select",
							   required: true,
							   value: null,
							   options: reference.translations.groups.EmailReminder.map(x => x.Key),
							   values: reference.translations.groups.EmailReminder.map(x => x.Key),
							   validation: ["inArray"],
							 },
							]
						  ],
						  callback: function() {},
						},

					   ],
			callback: function() {


			  if (invitation.data.invitation.Status >= 2)
				Array.from(node.querySelectorAll('input, select')).forEach(function(el) {
				  el.disabled = true;
				});

			  node.querySelectorAll('.heading').forEach(function(el) {
				if (el && el.closest('.row')) el.closest('.row').style.marginBottom = "0px";
			  })

			  Array.from(document.querySelectorAll('[data-rname="reminders"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.datetime, .wrapper.select')).forEach(function(d, index) {
				  d.style.width = '181px';
				  d.style.display = 'inline-block';
				});
			  });


			},
			validation: function() {
			  var result = {
				fail: [],
				pass: []
			  };
			  return result;
			}
		  }]
		};
		console.log(invitation.data);
		for (var i = 0; i < invitation.data.reminders.length; i++) {
		  invitation.data.reminders[i].ReminderDate = util.getDate(invitation.data.reminders[i].ReminderDate)
		}
		conf.dataset = {
		  Expiry: util.getDate(invitation.data.overview.Expiry),
		  reminders: JSON.stringify(invitation.data.reminders)
		}
		console.log(conf.dataset);

		nbsf.init(conf, 0);

		if (invitation.data.invitation.Status == 1)
		  document.querySelector('.k-grid-updateNotificationsInv').addEventListener('click', function(el) {
			nbsf.data.update(conf, {});

			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});

			function updateExpirationDate() {
			  if (util.getDate(invitation.data.overview.Expiry) !== conf.dataset.Expiry) {
				var expiry = conf.dataset.Expiry.replace(" ", "T");

				invitation.invitationOverview.addAuditLog("Expiration Date",
														  util.getAuditString("Date", util.getDate(invitation.data.overview.Expiry), util.getDate(conf.dataset.Expiry)),
														  util.Email());

				invitationAPI.updateExpirationDate(invitation.data, expiry, function(res) {
				  console.log(res);

				});
			  }
			}

			var oldReminders = invitation.data.reminders;
			var reminders = JSON.parse(conf.dataset.reminders);
			var remindersToChange = [];
			var remindersChanged = false;
			if (reminders.length > 0) {
			  for (var i = 0; i < reminders.length; i++) {
				if (oldReminders.length <= i || reminders[i].ReminderDate != oldReminders[i].ReminderDate || reminders[i].ReminderTemplateId != oldReminders[i].ReminderTemplateId)
				  remindersToChange.push(reminders[i]);

				if (reminders[i].ReminderDate) reminders[i].ReminderDate = reminders[i].ReminderDate.replace(" ", "T");
			  }

			  invitationAPI.updateReminders(invitation.data, remindersToChange, function(res2) {

				remindersToChange.forEach(x => {
				  invitation.invitationOverview.addAuditLog("Reminder changed",
															util.getAuditString("Date", "", x.ReminderDate) + ";##" +
															util.getAuditString("Template", "", x.ReminderTemplateId),
															util.Email());
				});



				updateExpirationDate();
				mo.fn.overlay.hide();

			  });
			} else updateExpirationDate();


		  });


	  },
	  /*showACCD: function(node) {

                      if(invitation.data.legacyData )
                      {  
                        if(invitation.data.legacyDDQ)
                          invitation.invitationOverview.legacyDataPreview(node, invitation.data.legacyDDQ, "accdData");
                        return;
                      }

                      node.innerHTML += "<h3>Sent to:<h3>";
                      JSON.parse(invitation.data.invitation.BusinessContact).forEach(function(el) {
                        node.innerHTML += '<section style="margin-left:10px;margin-bottom:40px">'+
                          '<label style="margin-left:30px;">Name:  </label> <strong>'+el.FirstName +' '+ el.LastName + '</strong>'+		   
                          '<label style="margin-left:30px;">Email:  </label> <strong>'+el.Email +'</strong>'+
                          '</section>';
                      });

                    },*/
	  showContacts: function(node) {
		node.innerHTML += "<h3>Sent to:<h3>";
		JSON.parse(invitation.data.invitation.BusinessContact).forEach(function(el) {
		  node.innerHTML += '<section style="margin-left:10px;margin-bottom:40px">' +
			'<label style="margin-left:30px;">Name:  </label> <strong>' + el.FirstName + ' ' + el.LastName + '</strong>' +
			'<label style="margin-left:30px;">Email:  </label> <strong>' + el.Email + '</strong>' +
			'</section>';
		});

		if (invitation.data.invitation.Status >= 2) {
		  node.innerHTML += "<h3>Submitted By:<h3>";
		  node.innerHTML += '<section name="submitter-data" style="margin-left:10px;margin-bottom:20px">';

		  var config = util.parseConfigStr(invitation.data.config.Config);
		  var lastPage = config.pages[config.pages.length - 1];
		  var section = lastPage.structure.find(x => x.header == "SubmittedBy");
		  if (section) {
			section.group[0].forEach(x => {
			  node.innerHTML += '<div style="margin-left:40px;margin-top:20px">' + ui.translate(x.label) + '</div>';
			  node.innerHTML += '<div style="margin-left:40px;margin-top:10px;"><strong>' + invitation.data.data[x.data] + '</strong></div>';
			});
			node.innerHTML += '</section>';
		  }
		}



	  },
	  showNotesTab: function(node) {
		node.innerHTML = "<div class='inv-notes'></div>" +
		  `${!access.user.UserRole.Readonly ? '<a class="k-button k-button-action inv-add-note" style="margin-top: 30px; float: right; margin-left:15px;" href="#"  >Add Note</a>;': '' }`;
		var selector = node.querySelector(".inv-notes");
		if (node.querySelector(".inv-add-note")) {
		  node.querySelector(".inv-add-note").addEventListener("click", function() {
			invitation.invitationOverview.editNote();
		  });
		}

		var columns = [{
		  field: "EntryId",
		  title: "Id",
		  hidden: true,
		  width: "100px",
		},
					   {
						 field: "Subject",
						 title: "Subject",
						 hidden: false,
						 width: "250px",
						 headerAttributes: {
						   style: "white-space: normal"
						 }
					   },
					   {
						 field: "Note",
						 title: "Note",
						 hidden: false,
						 //width: "150px",
						 template: function(d) {
						   var note = d.Note;
						   if (note.length > 250)
							 note = note.substring(0, 250) + "...";

						   return note;
						 }
					   },
					   {
						 field: "Created",
						 title: "Date",
						 hidden: false,
						 width: "180px",
						 template: function(d) {
						   if (d.LegacyCreated)
							 return util.getDate(d.LegacyCreated);
						   return util.getDate(d.Created)
						 }
					   },
					   {
						 field: "CreatedBy",
						 title: "Owner",
						 hidden: false,
						 width: "200px",
						 template: function(d) {
						   return d.LegacyCreatedBy || d.CreatedBy;
						 }
					   },
					   {
						 title: "",
						 width: "60px",
						 //locked: true,
						 hidden: false,
						 attributes: {
						   "class": "cta"
						 },
						 template: function(d) {
						   var icons = '<a class="view_note"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';

						   /*if(util.Email() == d.ModifiedBy)
                          {
                            icons += '<a class="edit_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></a>';
                            icons += '<a class="delete_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="21px" height="21px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M4,5 L20,5 L20,23 L4,23 L4,5 Z M1,5 L23,5 M9,1 L15,1 L15,5 L9,5 L9,1 Z M9,1 L15,1 L15,5 L9,5 L9,1 Z M15,9 L15,19 M9,9 L9,19"></path></a>';			
                          }*/
						   return icons;
						 }
					   }
					  ];

		$(selector).kendoGrid({
		  height: 500,
		  dataSource: new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1372/ARK_Notes/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				fields: {}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			filter: [{
			  field: "InvitationFK",
			  operator: "eq",
			  value: invitation.data.invitation.EntryId
			}],
			serverSorting: false,
			sort: [{
			  field: "LegacyCreatedBy",
			  dir: "desc"
			},
				   {
					 field: "CreatedBy",
					 dir: "desc"
				   }
				  ]

		  }),
		  columns: columns,
		  pageable: {
			buttonCount: 4,
			pageSize: 15,
			pageSizes: [10, 25, 50, 100],
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  groupable: false,
		});


		$(selector).delegate(".view_note", "click", function(e) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  invitation.invitationOverview.viewNote(row.toJSON());
		});

	  },
	  customFields: {
		getCustomFields: function(id, callback) {
		  crud.read('4012', 'eid=' + id, function(d) {
			callback(d);

		  });
		},
		init: function(node) {
		  var conf; // ??

		  var makeValuesBold = function() {
			node.querySelector(".custom-fields").querySelectorAll("input, select").forEach(x => {
			  if (x.value && x.value != "Select one")
				x.style.fontWeight = 700
			});
		  };

		  node.innerHTML = "<input id='cf-search-panel' class='cf-search-panel' size='24' placeholder='Quick filter...' /><section class='custom-fields' id='custom-fields'></section>" +
			`${!access.user.UserRole.Readonly ? `<div class="customFields-control-buttons"><a class="k-button k-button-big customFields-cancel" style="margin-left:15px;width:100px" href="#">Cancel</a>
<a class="k-button k-button-action customFields-save" style="margin-left:15px;width:100px" href="#">Save</a></div>` : '' }`;

		  invitation.invitationOverview.customFields.getCustomFields(invitation.data.invitation.EntryId, function(d) {
			invitation.customFieldsVal = d.Rows[0];
			conf = invitation.invitationOverview.customFields.config(node);
			if (invitation.customFieldsVal) conf.dataset = Object.assign({}, invitation.customFieldsVal);
			conf.dataset = util.removeTime(conf.dataset);
			nbsf.init(conf, 0);
			util.customFieldsTooltips(conf, node);
			util.customFieldsSearchPanel('custom-fields', 'cf-search-panel');

			makeValuesBold();
		  });
		  if (node.querySelector('.customFields-control-buttons')) {
			const ctrlBtns = node.querySelector('.customFields-control-buttons');
			const initialOffset = ctrlBtns.getBoundingClientRect().top + window.scrollY - 20;

			window.addEventListener('scroll', function() {
			  let vertical_position = 0;
			  if (pageYOffset) // usual
				vertical_position = pageYOffset;
			  else if (document.documentElement.clientHeight) // ie
				vertical_position = document.documentElement.scrollTop;
			  else if (document.body) // ie quirks
				vertical_position = document.body.scrollTop;

			  ctrlBtns.style.top = (vertical_position > initialOffset) ? (vertical_position - initialOffset) + 'px' : 0;
			});
		  }
		  if (node.querySelector('.customFields-save')) {
			node.querySelector('.customFields-save').addEventListener('click', function(ev) {
			  nbsf.data.update(conf, {});

			  var keys = Object.keys(conf.dataset);
			  keys.forEach(key => {
				if (conf.dataset[key] == "Select one")
				  conf.dataset[key] = "";
			  });

			  if (!invitation.customFieldsVal || Object.keys(invitation.customFieldsVal).length == 0) {
				conf.dataset.CaseFK = invitation.data.invitation.EntryId;
				crud.create('4007', conf.dataset, function(d) {
				  invitation.customFieldsVal = d;
				  if (d == false) {
					mo.fn.modal.show({
					  ctaLabel: "OK",
					  class: "ark-modal",
					  title: "Error!",
					  content: "<p>" + d.Message + "</p>"
					});
				  } else {
					invitation.invitationOverview.addAuditLog("Case Custom Fields created", util.getDifference({}, d), util.Email(), null, invitation.data.invitation.EntryId);
					mo.fn.modal.show({
					  ctaLabel: "OK",
					  class: "ark-modal",
					  title: "Success!",
					  content: "<p>Custom field updated.</p>"
					});
					makeValuesBold();
				  }
				});
			  } else {
				crud.update('4008', invitation.customFieldsVal.EntryId, conf.dataset, function(d) {
				  const old = { ...invitation.customFieldsVal
							  };
				  invitation.customFieldsVal = d;
				  console.log(d);
				  if (d == false) {
					mo.fn.modal.show({
					  ctaLabel: "OK",
					  class: "ark-modal",
					  title: "Error!",
					  content: "<p>" + d.Message + "</p>"
					});
				  } else {
					invitation.invitationOverview.addAuditLog("Case Custom Fields updated", util.getDifference(old, d),
															  util.Email(), null, invitation.data.invitation.EntryId);
					mo.fn.modal.show({
					  ctaLabel: "OK",
					  class: "ark-modal",
					  title: "Success!",
					  content: "<p>Custom field updated.</p>"
					});
					makeValuesBold();
				  }
				});
			  }

			  ev.preventDefault();
			});
		  }
		  if (node.querySelector('.customFields-cancel')) {
			node.querySelector('.customFields-cancel').addEventListener('click', function(ev) {
			  conf = invitation.invitationOverview.customFields.config(node);
			  if (invitation.customFieldsVal) conf.dataset = invitation.customFieldsVal;
			  conf.dataset = util.removeTime(conf.dataset);
			  nbsf.init(conf, 0);
			  util.customFieldsTooltips(conf, node);
			  ev.preventDefault();
			});
		  }


		},
		structure: [
		  {
			header: "Specific to this Case Folder",
			group: [
			  [{
				label: "CPI- DO NOT UPDATE",
				data: "CPIDoNotUpdate",
				required: false,
				disabled: true,
				type: "text",
				validation: ["flt", "minLen|1", "maxLen|30", "noBlanks"],
				typing: "flt",
				tooltip: 'DO NOT COMPLETE - This field should not be manually populated, it is calculated automatically'
			  },
			   {
				 label: "DDQ Score-DO NOT UPDATE",
				 data: "DDQScoreDoNotUpdate",
				 required: false,
				 disabled: true,
				 type: "text",
				 validation: ["flt", "minLen|1", "maxLen|30", "noBlanks"],
				 typing: "flt",
				 tooltip: 'DO NOT COMPLETE - This field should not be manually populated, it is calculated automatically'
			   },
			   {
				 label: "GT Question-DO NOT UPDATE",
				 data: "GTQuestionDoNotUpdate",
				 required: false,
				 disabled: true,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: 'DO NOT COMPLETE - This field should not be manually populated, it is calculated automatically'
			   },
			   {
				 label: "IFQ-DO NOT UPDATE",
				 data: "IFQDoNotUpdate",
				 required: false,
				 disabled: true,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: 'DO NOT COMPLETE - This field should not be manually populated, it is calculated automatically'
			   },
			   {
				 label: "MarketingVendor_LOW RISK_Q5&Q6",
				 data: "MarketingVendorLowRiskQ5Q6",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: 'Applies for Marketing Vendor only.If Q5 & Q6, both, are here , the risk rating is LOW, regarding the rest of questions'
			   },

			   {
				 label: "Red Flag Questions-DO NOT UPDATE",
				 data: "RedFlagQuestionsDoNotUpdate",
				 disabled: true,
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: 'DO NOT COMPLETE - This field should not be manually populated, it is calculated automatically'
			   },
			   {
				 label: "CPI",
				 data: "CPI",
				 required: false,
				 type: "text",
				 validation: ["flt", "minLen|1", "maxLen|30", "noBlanks"],
				 typing: "flt"
			   },
			   {
				 label: "DDQ Score",
				 data: "DDQScore",
				 required: false,
				 type: "text",
				 validation: ["flt", "minLen|1", "maxLen|30", "noBlanks"],
				 typing: "flt"
			   },
			   {
				 label: "Red Flag Questions",
				 data: "RedFlagQuestions",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["flt", "minLen|1", "maxLen|30", "noBlanks"],
				 typing: "flt"
			   },
			   {
				 label: "Contract Requestor Email",
				 data: "ContractRequestorEmail",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: "Email address of the HP employee (or team mailbox) who requested the partner contract. Important for Active EDD Review. A contact name or team mailbox are acceptable, but an individual's HP email address is preferred where possible."
			   },
			   {
				 label: "Partner Location ID",
				 data: "PartnerLocationID",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Siebel PRM ID or Supplier Vendor ID",
				 data: "SiebelPRMIDOrSupplierVendorID",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: "Siebel PRM Partner Row ID or Supplier Vendor ID"
			   },
			   {
				 label: "AppID",
				 data: "AppID",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Party ID",
				 data: "PartyID",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "On-Boarding Program",
				 data: "OnBoardingProgram",
				 required: false,
				 type: "select",
				 values: ['Agent', 'AgentHPEFS', 'APJIPGESPSSP410', 'China931', 'DXC', 'GlobalExmption', 'H3CHPNRussiaForwardedProgram', 'HPEFSPartner', 'IntegrityComplete', 'IntegrityNonComplete', 'Lobbyist', 'lookback', 'MADOArcSight', 'MADOAruba', 'MADOAutonomy', 'MADOAutonomy&ExistingHP', 'MADOEucalyptus', 'MADOFortify', 'MADOIndigo', 'MADONiara', 'MADONimble', 'MADOSGI', 'MADOSimplivity(SVT)', 'MADOSupplier', 'MADOTrilead', 'MADOVertica', 'MADOVoltage', 'MicroFocus', 'OEM', 'OEMAffiliate', 'OneTimeDeal', 'PartnerLogisticAffiliates', 'PartsOne', 'PPEMEACandidate', 'Proximity', 'PRSP', 'Retailer', 'SBSO', 'ServiceProviders', 'SOAR', 'Supplier', 'USSuppliesPartners', 'NonContractedPartner', 'Zerto'],
				 options: ['Agent', 'Agent HPEFS', 'APJ IPG ESP SSP 410', 'China 931', 'DXC', 'Global Exemption', 'H3C-HPN Russia Forwarder Program', 'HPEFS Partner', 'Integrity Complete', 'Integrity Non-Complete', 'Lobbyst', 'lookback', 'MADO ArcSight', 'MADO Aruba', 'MADO Autonomy', 'MADO Autonomy & Existing HP', 'MADO Eucalyptus', 'MADO Fortify', 'MADO Indigo', 'MADO Niara', 'MADO Nimble', 'MADO SGI', 'MADO Simplivity (SVT)', 'MADO Supplier', 'MADO Trilead', 'MADO Vertica', 'MADO Voltage', 'Micro Focus', 'OEM', 'OEM Affiliate', 'One Time Deal', 'Partner Logistic Affiliates', 'PartsOne', 'PP EMEA Candidate', 'Proximity', 'PRSP', 'Retailer', 'SBSO', 'Service Providers', 'SOAR', 'Supplier', 'US Supplies Partners' , 'Non Contracted Partner', 'Zerto']
			   },
			   {
				 label: "Pre-Screened",
				 data: "PreScreened",
				 required: false,
				 type: "select",
				 values: ['Yes', 'No'],
				 options: ['Yes', 'No']
			   },
			   {
				 label: "Special Consideration",
				 data: "SpecialConsideration",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|2000"],
			   },

			   {
				 label: "Simplified Code 06 Case",
				 data: "SimplifiedCodeSixCase",
				 required: false,
				 type: "toggle",
				 values: ['N', 'Y']
			   },
			   {
				 label: "Requesting Business Unit",
				 data: "RequestingBusinessUnit",
				 required: false,
				 type: "select",
				 values: ['Alliance', 'Aruba', 'Cloud', 'CMS', 'EB', 'Edge', 'EG', 'ESSN', 'HPN', 'Hybrid IT', 'IPG', 'Micro Focus', 'Nimble', 'Pointnext', 'PPS', 'PSG', 'SGI', 'Simplivity (SVT)', 'Software', 'SW-ESP', 'TSC', 'TSS'],
				 options: ['Alliance', 'Aruba', 'Cloud', 'CMS', 'EB', 'Edge', 'EG', 'ESSN', 'HPN', 'Hybrid IT', 'IPG', 'Micro Focus', 'Nimble', 'Pointnext', 'PPS', 'PSG', 'SGI', 'Simplivity (SVT)', 'Software', 'SW-ESP', 'TSC', 'TSS']
			   },
			   {
				 label: "Category Status",
				 data: "CategoryStatus",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: "Final outcome of L&R Compliance partner screening - This field should not be manually populated, it will be calculated automatically when Case Repository Report is run."
			   },
			   {
				 label: "On-Going Special Handling",
				 data: "OnGoingSpecialHandling",
				 required: false,
				 type: "select",
				 values: ['Yes', 'No'],
				 options: ['Yes', 'No']
			   },
			   {
				 label: "Contract Termination Reason",
				 data: "ContractTerminationReason",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Contract Termination Date",
				 data: "ContractTerminationDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Contract Inactivation Reason",
				 data: "ContractInactivationReason",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Contract Inactivation Date",
				 data: "ContractInactivationDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },


			  ]
			]
		  },
		  {
			header: "DDI Tracker Data",
			group: [
			  [{
				label: "DDI Region Lead Active Review",
				data: "DDIRegionLeadActiveReview",
				required: false,
				type: "select",
				values: ['Pending', 'Approved', 'Approved Referred Partner', 'Active Reject', 'Passive Reject', 'Reject-Application not submitted by Partner'],
				options: ['Pending', 'Approved', 'Approved-Referred Partner', 'Active Reject', 'Passive Reject', 'Reject-Application not submitted by Partner']

			  },
			   {
				 label: "DDI Region Lead Review Result Date",
				 data: "DDIRegionLeadReviewResultDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 },
				 tooltip: "DDI Region Lead Review Result Date"
			   },
			   {
				 label: "DDI Analyst",
				 data: "DDIAnalyst",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {},
				 tooltip: "The initials of the DDI Analyst who is assigned to the case."
			   },
			   {
				 label: "DDI Start Date",
				 data: "DDIStartDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDI Completed Date",
				 data: "DDICompletedDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDI Scoring Analyst",
				 data: "DDIScoringAnalyst",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {},
				 tooltip: "The initials of the DDI Scoring Analyst who is assigned to the case."
			   },
			   {
				 label: "DDI 'Yes' Responses",
				 data: "DDIYesResponses",
				 required: false,
				 type: "text",
				 tooltip: "Total weighted score of YES responses",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {}
			   },
			   {
				 label: "DDI 'No' Responses",
				 data: "DDINoResponses",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {},
				 tooltip: "Total weighted score of NO responses"
			   },
			   {
				 label: "DDI 'No info Responses'",
				 data: "DDINoInfoResponses",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {},
				 tooltip: "Total weighted score of NO INFO responses"
			   },
			   {
				 label: "DDI Final Result",
				 data: "DDIFinalResult",
				 required: false,
				 type: "multiselect",
				 tooltip: "The final result of the DDI scoring. This result can be overridden by an analyst if they have any concerns.",
				 values: ['PR', 'PRGT', 'SQ', 'IDD', 'EDD', 'SH', 'RGT', 'RABAC', 'NR', 'ARR', 'BR', 'GT'],
				 options: ['Positive Recommendation', 'Positive Recommendation_GT', 'Supplement Questionnaire', 'In-depth Due Diligence (IDD)', 'Enhanced Due Diligence', 'Special Handling-SOE/COI', 
						   'Reject_Global Trade', 'Reject_ABAC', 'Negative Recommendation', 'Additional Research Required', 'Business Review', 'Global Trade']

			   },
			   /*  {
                                               label: "DDI SQ Result",
                                               data: "DDISQResult",
                                               required: false,
                                               type: "select",
                                               tooltip: "SQ Final Results",
                                               values: ['Criminal Activity or Litigation (CAL)', 'CAL + CA', 'CAL + UKI', 'CAL + UO', 'CAL + UPSA', 'CAL + UGO', 'CAL + BR', 'CAL + CEA', 'CAL + CA + UKI', 'CAL + CA + UKI  + UO', 'CAL + CA + UKI  + UO + UPSA', 'CAL + CA + UKI  + UO + UPSA + UGO', 'CAL + CA + UKI  + UO + UPSA + UGO + BR', 'CAL + CA + UKI  + UO + UPSA + UGO + BR + CEA', 'CAL + UKI  + UO', 'CAL + UKI  + UO + UPSA', 'CAL + UKI  + UO + UPSA + UGO', 'CAL + UKI  + UO + UPSA + UGO + BR', 'CAL + UKI  + UO + UPSA + UGO + BR + CEA', 'CAL + UO + UPSA', 'CAL + UO + UPSA + UGO', 'CAL + UO + UPSA + UGO + BR', 'CAL + UO + UPSA + UGO + BR + CEA', 'CAL + UPSA + UGO', 'CAL + UPSA + UGO + BR', 'CAL + UPSA + UGO + BR + CEA', 'CAL + UGO + BR', 'CAL + UGO + BR + CEA', 'CAL + BR + CEA', 'CAL + CA + UO', 'CAL + CA + UO + UPSA', 'CAL + CA + UO + UPSA + UGO', 'CAL + CA + UO + UPSA + UGO + BR', 'CAL + CA + UO + UPSA + UGO + BR + CEA', 'CAL + CA + UPSA', 'CAL + CA + UPSA + UGO', 'CAL + CA + UPSA + UGO + BR', 'CAL + CA + UPSA + UGO + BR + CEA', 'CAL + CA + UGO', 'CAL + CA + UGO + BR', 'CAL + CA + UGO + BR + CEA', 'CAL + CA + BR', 'CAL + CA + BR + CEA', 'CAL + CA + CEA', 'CAL + UKI  + UPSA', 'CAL + UKI  + UPSA + UGO', 'CAL + UKI  + UPSA + UGO + BR', 'CAL + UKI  + UPSA + UGO + BR + CEA', 'Confirmation of Address (CA)', 'CA + UKI', 'CA + UO', 'CA + UPSA', 'CA + UGO', 'CA + BR', 'CA + CEA', 'CA + UKI  + UO', 'CA + UKI  + UO + UPSA', 'CA + UKI  + UO + UPSA + UGO', 'CA + UKI  + UO + UPSA + UGO + BR', 'CA + UKI  + UO + UPSA + UGO + BR + CEA', 'CA + UKI  + UPSA', 'CA + UKI  + UPSA + UGO', 'CA + UKI  + UPSA + UGO + BR', 'CA + UKI  + UGO', 'CA + UKI  + UGO + BR', 'CA + UKI  + UGO + BR + CEA', 'CA + UKI  + BR', 'CA + UKI  + BR + CEA', 'CA + UKI  + CEA', 'CA + UO + UPSA', 'CA + UO + UPSA + UGO', 'CA + UO + UPSA + UGO + BR', 'CA + UO + UPSA + UGO + BR + CEA', 'CA + UPSA + UGO', 'CA + UPSA + UGO + BR', 'CA + UPSA + UGO + BR + CEA', 'CA + UGO + BR', 'CA + UGO + BR + CEA', 'CA + BR + CEA', 'Unreported Key Individuals (UKI)', 'UKI  + UO', 'UKI  + UPSA', 'UKI  + UGO', 'UKI  + BR', 'UKI  + CEA', 'UKI  + UO + UPSA', 'UKI  + UO + UPSA + UGO', 'UKI  + UO + UPSA + UGO + BR', 'UKI  + UO + UPSA + UGO + BR + CEA', 'UKI  + UO + UGO', 'UKI  + UO + UGO + BR', 'UKI  + UO + UGO + BR + CEA', 'UKI  + UO + BR', 'UKI  + UO + BR + CEA', 'UKI  + UPSA + UGO', 'UKI  + UPSA + UGO + BR', 'UKI  + UPSA + UGO + BR + CEA', 'UKI  + UGO + BR', 'UKI  + UGO + BR + CEA', 'Unreported Ownership (UO)', 'UO + UPSA', 'UO + UGO', 'UO + BR', 'UO + CEA', 'UO + UPSA + UGO', 'UO + UPSA + UGO + BR', 'UO + UPSA + UGO + BR + CEA', 'UO + UGO + BR', 'UO + UGO + BR + CEA', 'UO + BR + CEA', 'Unreported Public Sector Affiliation (UPSA)', 'UPSA + UGO', 'UPSA + BR', 'UPSA + CEA', 'UPSA + UGO + BR', 'UPSA + UGO + BR + CEA', 'UPSA + BR + CEA', 'Unreported Government Ownership (UGO)', 'UGO + BR', 'UGO + CEA', 'UGO + BR + CEA', 'Business Review (BR)', 'BR + CEA', 'Confirmation of Email Address (CEA)'],
                                               options: ['Criminal Activity or Litigation (CAL)', 'CAL + CA', 'CAL + UKI', 'CAL + UO', 'CAL + UPSA', 'CAL + UGO', 'CAL + BR', 'CAL + CEA', 'CAL + CA + UKI', 'CAL + CA + UKI  + UO', 'CAL + CA + UKI  + UO + UPSA', 'CAL + CA + UKI  + UO + UPSA + UGO', 'CAL + CA + UKI  + UO + UPSA + UGO + BR', 'CAL + CA + UKI  + UO + UPSA + UGO + BR + CEA', 'CAL + UKI  + UO', 'CAL + UKI  + UO + UPSA', 'CAL + UKI  + UO + UPSA + UGO', 'CAL + UKI  + UO + UPSA + UGO + BR', 'CAL + UKI  + UO + UPSA + UGO + BR + CEA', 'CAL + UO + UPSA', 'CAL + UO + UPSA + UGO', 'CAL + UO + UPSA + UGO + BR', 'CAL + UO + UPSA + UGO + BR + CEA', 'CAL + UPSA + UGO', 'CAL + UPSA + UGO + BR', 'CAL + UPSA + UGO + BR + CEA', 'CAL + UGO + BR', 'CAL + UGO + BR + CEA', 'CAL + BR + CEA', 'CAL + CA + UO', 'CAL + CA + UO + UPSA', 'CAL + CA + UO + UPSA + UGO', 'CAL + CA + UO + UPSA + UGO + BR', 'CAL + CA + UO + UPSA + UGO + BR + CEA', 'CAL + CA + UPSA', 'CAL + CA + UPSA + UGO', 'CAL + CA + UPSA + UGO + BR', 'CAL + CA + UPSA + UGO + BR + CEA', 'CAL + CA + UGO', 'CAL + CA + UGO + BR', 'CAL + CA + UGO + BR + CEA', 'CAL + CA + BR', 'CAL + CA + BR + CEA', 'CAL + CA + CEA', 'CAL + UKI  + UPSA', 'CAL + UKI  + UPSA + UGO', 'CAL + UKI  + UPSA + UGO + BR', 'CAL + UKI  + UPSA + UGO + BR + CEA', 'Confirmation of Address (CA)', 'CA + UKI', 'CA + UO', 'CA + UPSA', 'CA + UGO', 'CA + BR', 'CA + CEA', 'CA + UKI  + UO', 'CA + UKI  + UO + UPSA', 'CA + UKI  + UO + UPSA + UGO', 'CA + UKI  + UO + UPSA + UGO + BR', 'CA + UKI  + UO + UPSA + UGO + BR + CEA', 'CA + UKI  + UPSA', 'CA + UKI  + UPSA + UGO', 'CA + UKI  + UPSA + UGO + BR', 'CA + UKI  + UGO', 'CA + UKI  + UGO + BR', 'CA + UKI  + UGO + BR + CEA', 'CA + UKI  + BR', 'CA + UKI  + BR + CEA', 'CA + UKI  + CEA', 'CA + UO + UPSA', 'CA + UO + UPSA + UGO', 'CA + UO + UPSA + UGO + BR', 'CA + UO + UPSA + UGO + BR + CEA', 'CA + UPSA + UGO', 'CA + UPSA + UGO + BR', 'CA + UPSA + UGO + BR + CEA', 'CA + UGO + BR', 'CA + UGO + BR + CEA', 'CA + BR + CEA', 'Unreported Key Individuals (UKI)', 'UKI  + UO', 'UKI  + UPSA', 'UKI  + UGO', 'UKI  + BR', 'UKI  + CEA', 'UKI  + UO + UPSA', 'UKI  + UO + UPSA + UGO', 'UKI  + UO + UPSA + UGO + BR', 'UKI  + UO + UPSA + UGO + BR + CEA', 'UKI  + UO + UGO', 'UKI  + UO + UGO + BR', 'UKI  + UO + UGO + BR + CEA', 'UKI  + UO + BR', 'UKI  + UO + BR + CEA', 'UKI  + UPSA + UGO', 'UKI  + UPSA + UGO + BR', 'UKI  + UPSA + UGO + BR + CEA', 'UKI  + UGO + BR', 'UKI  + UGO + BR + CEA', 'Unreported Ownership (UO)', 'UO + UPSA', 'UO + UGO', 'UO + BR', 'UO + CEA', 'UO + UPSA + UGO', 'UO + UPSA + UGO + BR', 'UO + UPSA + UGO + BR + CEA', 'UO + UGO + BR', 'UO + UGO + BR + CEA', 'UO + BR + CEA', 'Unreported Public Sector Affiliation (UPSA)', 'UPSA + UGO', 'UPSA + BR', 'UPSA + CEA', 'UPSA + UGO + BR', 'UPSA + UGO + BR + CEA', 'UPSA + BR + CEA', 'Unreported Government Ownership (UGO)', 'UGO + BR', 'UGO + CEA', 'UGO + BR + CEA', 'Business Review (BR)', 'BR + CEA', 'Confirmation of Email Address (CEA)']

                                             },*/
			   {
				 label: "DDI SQ Result",
				 data: "DDISQResult",
				 required: false,
				 tooltip: "SQ Final Results",
				 // value: aux && aux.RL ? aux.RL : '',
				 type: "multiselect",
				 options: ["Criminal Activity or Litigation (CAL)", "Confirmation of Address (CA)", "Unreported Key Individuals (UKI)", "Unreported Ownership (UO)", "Unreported Public Sector Affiliation (UPSA)", "Unreported Government Ownership (UGO)", "Business Review (BR)", "Confirmation of Email Address (CEA)"],
				 values: ['CAL', 'CA', 'UKI', "UO", "UPSA", "UGO", "BR", "CEA"]
			   },
			   {
				 label: "DDI SQ Comments",
				 data: "DDISQComments",
				 required: false,
				 type: "textarea",
				 tooltip: "Additional details related to the SQ results",
				 validation: ["minLen|1"],
				 onChange: function() {}
			   },
			   {
				 label: "DDI Result Override?",
				 data: "DDIResultOverride",
				 required: false,
				 type: "toggle",
				 values: ['N', 'Y'],
				 tooltip: "Is the result overridden or not"
			   },
			   {
				 label: "DDI Reason for Override",
				 data: "DDIReasonForOverride",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {},
				 tooltip: "The question number(s) from the DDI that justifies the override."
			   },
			   {
				 label: "DDI Batch Number",
				 data: "DDIBatchNumber",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {},
				 tooltip: "The number sequence the batch was created"
			   },
			   {
				 label: "DDI Scoring Completed Date",
				 data: "DDIScoringCompletedDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDI Result sent to Contracts Team",
				 data: "DDIResultSentToContractsTeam",
				 required: false,
				 type: "select",
				 values: ['Pass', 'EDD', 'Reject', 'Special Handling', 'Business Caution', "IDD"],
				 options: ['Pass', 'EDD', 'Reject', 'Special Handling', 'Business Caution', "IDD"],
				 tooltip: "DDI Result sent to Contracts Team"
			   },
			   {
				 label: "DDI Update sent to Contracts Team",
				 data: "DDIUpdateSentToContractsTeam",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDI Date Assigned to Agility",
				 data: "DDIDateAssignedToAgility",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 },
				 tooltip: "DDI Date Assigned to Agility"
			   },
			   {
				 label: "DDI Agility Special Handling Instructions",
				 data: "DDIAgilitySpecialHandlingInstructions",
				 required: false,
				 type: "textarea",
				 validation: ["minLen|1"],
				 onChange: function() {},
				 tooltip: "DDI Agility Special Handling Instructions -open text field"
			   },
			   {
				 label: "DDI Agility Release Date",
				 data: "DDIAgilityReleaseDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDI Agility Result Override",
				 data: "DDIAgilityResultOverride",
				 required: false,
				 type: "select",
				 values: ['Positive Recommendation', 'Other'],
				 options: ['Positive Recommendation', 'Other']
			   },
			   {
				 label: "DDI Agility Reason for Override",
				 data: "DDIAgilityReasonForOverride",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {}
			   },
			   {
				 label: "DDI Agility Comments/Additional Request",
				 data: "DDIAgilityCommentsAdditionalRequest",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
				 onChange: function() {}
			   }

			  ]
			]
		  },
		  {
			header: "IDD Tracker Data",
			group: [
			  [{
				label: "IDD Analyst",
				data: "IDDAnalyst",
				required: false,
				type: "text",
				validation: ["minLen|1", "maxLen|100"],
				tooltip: "The initials of the IDD Analyst who is assigned to the case."
			  },
			   {
				 label: "IDD Start Date",
				 data: "IDDStartDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "IDD Completed Date",
				 data: "IDDCompletedDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "IDD Date assigned to Agility",
				 data: "IDDDateAssignedToAgility",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "IDD Agility recommendation",
				 data: "IDDAgilityRecommendation",
				 required: false,
				 type: "select",
				 values: ['Positive', 'Pass with business caution', 'Special handling', 'Supplemental questionnaire', 'EDD', 'Hold ECO', 'Reject'],
				 options: ['Positive', 'Pass with business caution', 'Special handling', 'Supplemental questionnaire', 'EDD', 'Hold ECO', 'Reject']
			   },

			   {
				 label: "IDD Agility release date",
				 data: "IDDAgilityReleaseDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "IDD Agility Business Caution Instructions",
				 data: "IDDAgilityBusinessCautionInstructions",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "IDD Agility Special Handling Instructions",
				 data: "IDDAgilitySpecialHandlingInstructions",
				 required: false,
				 type: "textarea",
				 validation: ["minLen|1"],
				 tooltip: "IDD Agility Special Handling Instructions -open text field"
			   },
			   {
				 label: "IDD Agility Supplemental questionnaire Instructions",
				 data: "IDDAgilitySupplementalQuestionnaireInstructions",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "IDD Agility EDD Reasons",
				 data: "IDDAgilityEDDReasons",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "IDD Result override",
				 data: "IDDResultOverride",
				 required: false,
				 type: "select",
				 values: ['Positive Recommendation', 'Other'],
				 options: ['Positive Recommendation', 'Other']
			   },
			   {
				 label: "IDD Reason override",
				 data: "IDDReasonOverride",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "IDD Result sent to Contracts Team",
				 data: "IDDResultSentToContractsTeam",
				 required: false,
				 type: "select",
				 values: ['Pass', 'EDD', 'Reject', 'Special handling SQ'],
				 options: ['Pass', 'EDD', 'Reject', 'Special handling SQ']
			   },
			   {
				 label: "IDD Update sent to Contract team",
				 data: "IDDUpdateSentToContractTeam",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   formatDate: 'Y-m-d',
				   timepicker: false,
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   }
			  ]
			]

		  },
		  {

			header: "OSI Tracker Date",
			group: [
			  [{
				label: "CFI Analyst",
				data: "CFIAnalyst",
				required: false,
				type: "text",
				validation: ["minLen|1", "maxLen|100"],
				tooltip: "The initials of the analyst who is assigned to the case."
			  },
			   {
				 label: "'Yes' Responses",
				 data: "YesResponses",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: "Total weighted score of Yes responses to OSI questions."
			   },
			   {
				 label: "'No' Responses",
				 data: "NoResponses",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: "Total weighted score of No responses to OSI questions."
			   },
			   {
				 label: "'No Info' Responses",
				 data: "NoInfoResponses",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
				 tooltip: "Total weighted score of No Info responses to OSI questions."
			   },
			   {
				 label: "OSI Final Result",
				 data: "OSIFinalResult",
				 required: false,
				 type: "select",
				 tooltip: "The final result of the OSI scoring. This result can be overridden by an analyst if they have any concerns.",
				 values: ['Positive Recommendation', 'Positive Recommendation_GT', 'Supplement Questionnaire', 'In-depth Due Diligence (IDD)', 'Enhanced Due Diligence', 'Special Handling-SOE/COI', 'SQ+EDD+SH', 'SQ+EDD', 'SQ+SH', 'EDD+SH', 'Reject_Global Trade', 'Reject_ABAC', 'Negative Recommendation', 'Additional Research Required', 'Business Review', 'Business Review + Special handling'],
				 options: ['Positive Recommendation', 'Positive Recommendation_GT', 'Supplement Questionnaire', 'In-depth Due Diligence (IDD)', 'Enhanced Due Diligence', 'Special Handling-SOE/COI', 'SQ+EDD+SH', 'SQ+EDD', 'SQ+SH', 'EDD+SH', 'Reject_Global Trade', 'Reject_ABAC', 'Negative Recommendation', 'Additional Research Required', 'Business Review', 'Business Review + Special handling']

			   },

			   {
				 label: "OSI SQ Result",
				 data: "OSISQResult",
				 required: false,
				 tooltip: "SQ Final Results",
				 type: "multiselect",
				 options: ["Criminal Activity or Litigation (CAL)", "Confirmation of Address (CA)", "Unreported Key Individuals (UKI)", "Unreported Ownership (UO)", "Unreported Public Sector Affiliation (UPSA)", "Unreported Government Ownership (UGO)", "Business Review (BR)", "Confirmation of Email Address (CEA)"],
				 values: ['CAL', 'CA', 'UKI', "UO", "UPSA", "UGO", "BR", "CEA"]
			   },
			   {
				 label: "OSI SQ Comments",
				 data: "OSISQComments",
				 required: false,
				 type: "textarea",
				 validation: ["minLen|1"],
				 tooltip: "OSI Additional details related to the SQ results"
			   },
			   {
				 label: "Result Override?",
				 data: "OSIResultOverride",
				 required: false,
				 type: "toggle",
				 tooltip: "Is the result overridden or not?",
				 values: ['N', 'Y']
			   },
			   {
				 label: "Reason for Override",
				 data: "OSIReasonForOverride",
				 required: false,
				 value: null,
				 type: "text",
				 tooltip: "The question number(s) from the DDQ that justifies the override.",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "OSI Batch Number",
				 data: "OSIBatchNumber",
				 required: false,
				 value: null,
				 type: "text",
				 tooltip: "The number sequence the OSI batch was created",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Date Batch Completed",
				 data: "DateBatchCompleted",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date the batch was created. 24 hours to complete and send to GBS.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Remarks",
				 data: "Remarks",
				 required: false,
				 value: null,
				 type: "text",
				 tooltip: "Any additional remarks",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Post-OSI Supplementary Research",
				 data: "PostOsiSupplementaryResearch",
				 required: false,
				 type: "select",
				 tooltip: "On-line supplemental research to see if borderline cases can be prevented from having an EDD and to have some check & balance to see if any additional research is found.",
				 values: ['Borderline Cases Supplementary Research', 'High "No Information" Supplementary Research'],
				 options: ['Borderline Cases Supplementary Research', 'High "No Information" Supplementary Research']
			   },
			   {
				 label: "Post-OSI Result Override?",
				 data: "PostOSIResultOverride",
				 required: false,
				 type: "toggle",
				 tooltip: "Did the Post-OSI Supplemental Research result in an override or not?",
				 values: ['N', 'Y']
			   },
			   {
				 label: "Initial Override Recommendation",
				 data: "InitialOverrideRecommendation",
				 required: false,
				 type: "select",
				 values: ['Positive', 'Negative', 'EDD'],
				 options: ['Positive', 'Negative', 'EDD'],
				 tooltip: "Rinal result/recommendation"
			   },
			   {
				 label: "OSI Date Assigned to Agility",
				 data: "OSIDateAssignedtoAgility",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "OSI Agility Special Handling Instructions",
				 data: "OSIAgilitySpecialHandlingInstructions",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "OSI Agility Release Date",
				 data: "OSIAgilityReleaseDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "OSI Agility Result Override",
				 data: "OSIAgilityResultOverride",
				 required: false,
				 type: "select",
				 values: ['Positive Recommendation', 'Other'],
				 options: ['Positive Recommendation', 'Other']
			   },
			   {
				 label: "OSI Agility Reason for Override",
				 data: "OSIAgilityReasonforOverride",
				 required: false,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			  ]
			]

		  },
		  {

			header: "EDD Tracker Data",
			group: [
			  [{
				label: "OSI Case Number",
				data: "OSICaseNumber",
				required: false,
				type: "text",
				tooltip: "The unique number assigned for each OSI investigation.",
				validation: ["minLen|1", "maxLen|100"],
			  },
			   {
				 label: "Date Assigned to Agility",
				 data: "DateAssignedToAgility",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date a completed EDD is sent for review to Agility Center",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Date Scorecard Released by Agility",
				 data: "DateScorecardReleasedByAgility",
				 type: "datetime",
				 tooltip: "The date Agility uploads the completed scorecard into Securimate.",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "EDD Decision Released",
				 data: "EDDDecisionReleased",
				 required: false,
				 tooltip: "The ECO decision (reject, accept, special handling, business issue) is received by HP and released. If decision does not make sense it is returned and not released.",
				 type: "select",
				 values: ['Yes', 'No', 'Hold SOE', 'Hold Agility', 'Hold BRM', 'Hold ECO', 'No action from Agility/ECO exception'],
				 options: ['Yes', 'No', 'Hold SOE', 'Hold Agility', 'Hold BRM', 'Hold ECO', 'No action from Agility/ECO exception']
			   },
			   {
				 label: "Date EDD Decision Released by Agility",
				 data: "DateEDDDecisionReleasedByAgility",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date when the Agility decision (reject, accept, special handling, business issue) is released to the Regional Compliance Lead.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },

			   {
				 label: "EDD Scorecard Results",
				 data: "EDDScorecardResults",
				 type: "select",
				 tooltip: "The ECO recommendation for the EDD.",
				 values: ['EDD-GREY-Additional Research', 'EDD-PASS', 'EDD-Pass w Business Caution Factors', 'EDD-PASS w Special Handling', 'EDD-Pass w/Sp', 'EDD-REJECT', 'EDD-REJECT BUSINESS', 'EDD-Reject Partner Non-response', 'Continuation of Contract', 'Continuation of Contract with Special Conditions', 'Continuation of Contract with Business Caution', 'Termination', 'Requires Discussion'],
				 options: ['EDD-GREY-Additional Research', 'EDD-PASS', 'EDD-Pass w Business Caution Factors', 'EDD-PASS w Special Handling', 'EDD-Pass w/Sp', 'EDD-REJECT', 'EDD-REJECT BUSINESS', 'EDD-Reject Partner Non-response', 'Continuation of Contract', 'Continuation of Contract with Special Conditions', 'Continuation of Contract with Business Caution', 'Termination', 'Requires Discussion']
			   },
			   {
				 label: "EDD Scorecard Results Revised",
				 data: "EDDScorecardResultsRevised",
				 required: false,
				 tooltip: "EDD Recommendation Change",
				 type: "toggle",
				 values: ['N', 'Y']
			   },
			   {
				 label: "Special Handling Instructions",
				 data: "SpecialHandlingInstructions",
				 required: false,
				 tooltip: "Instructions from ECO regarding risks and further review by the Governance Board to address the risks.",
				 type: "textarea",
				 validation: ["minLen|1"],
			   },
			   {
				 label: "Other Instructions",
				 data: "OtherInstructions",
				 required: false,
				 type: "textarea",
				 tooltip: "Additional information pertaining to the handling of the EDD.",
				 validation: ["minLen|1"],
			   },
			   {
				 label: "Business Caution Factors",
				 data: "BusinessCautionFactors",
				 required: false,
				 tooltip: "Instructions from ECO regarding business risks and further review by the Governance Board to address the risks.",
				 type: "textarea",
				 validation: ["minLen|1"],
			   },
			   {
				 label: "Other Notable Factors",
				 data: "OtherNotableFactors",
				 required: false,
				 tooltip: "Text field for additional comments by ECO for more insight into the decision rendered.",
				 type: "textarea",
				 validation: ["minLen|1"],
			   }
			  ]
			]

		  },
		  {

			header: "General Data(CR)",
			group: [
			  [{
				label: "Sub Regions",
				data: "SubRegion",
				required: false,
				tooltip: "Smaller section of the region",
				type: "select",
				values: ['APAC', 'CERTA', 'China', 'DACH', 'Europe South', 'India', 'Japan', 'Latin America', 'North America', 'North West Europe', 'UKIMESA'],
				options: ['APAC', 'CERTA', 'China', 'DACH', 'Europe South', 'India', 'Japan', 'Latin America', 'North America', 'North West Europe', 'UKIMESA']
			  }]
			]

		  },
		  {

			header: "DDQ (CR)",
			group: [
			  [{
				label: "DDQ Request Receive Date",
				data: "DDQRequestReceiveDate",
				type: "datetime",
				placeholder: "Select a date",
				tooltip: "The date the HP GBS Compliance team receives a DDQ trigger request from HP GBS Contracts team and an application is created.",
				dtp: {
				  format: 'Y-m-d',
				  timepicker: false,
				  formatDate: 'Y-m-d',
				  scrollMonth: false,
				  scrollInput: false,
				  onChangeDateTime: function(dp, $input) {}
				}
			  },
			   {
				 label: "DDQ Reminder Date",
				 data: "DDQReminderDate",
				 type: "datetime",
				 tooltip: "The date a reminder is sent to the prospective partner if no response. 3 days for pros. Partners, 4 days for current partner.",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Update DDQ Result to Contracts Team",
				 data: "UpdateDDQResultToContractsTeam",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date an email is sent to the Contracts team informing them that the Partner has responded to the DDQ and the L&R process and scoring will begin.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDQ Result",
				 data: "DDQResult",
				 required: false,
				 type: "select",
				 tooltip: "Based on the results of the scoring GBS Compliance determines the next step in the process.",
				 values: ['Close- Non-Respondent/Incomplete', 'DDQ Active OSI/EDD Rejection', 'EDD (BU Decision)', 'In Progress', 'DDI', 'OSI', 'Pass/Contract', 'DDQ_Rejected Non-Recruited', 'Close-GT Rejected', 'Simplified Move to Rescreening', 'Terminated', 'Reject-Other reasons'],
				 options: ['Close- Non-Respondent/Incomplete', 'DDQ Active OSI/EDD Rejection', 'EDD (BU Decision)', 'In Progress', 'DDI', 'OSI', 'Pass/Contract', 'DDQ_Rejected Non-Recruited', 'Close-GT Rejected', 'Simplified Move to Rescreening', 'Terminated', 'Reject-Other reasons']
			   },
			   {
				 label: "Red Line DDQ",
				 data: "RedLineDDQ",
				 required: false,
				 type: "toggle",
				 tooltip: "Flag to indicate that the partner has submitted a DDQ with 'red line' changes, approved by HP as an exception",
				 values: ['N', 'Y']
			   }
			  ]
			]

		  },
		  {

			header: "Reactivation (CR)",
			group: [
			  [{
				label: "Reactivation Request/Trigger Date",
				data: "ReactivationRequestTriggerDate",
				type: "datetime",
				placeholder: "Select a date",
				tooltip: "When a partner does not respond on time (non-response) GBS Contracts requests that the DDQ be reactivated. There is no limit to how many reactivations can occur.",
				dtp: {
				  format: 'Y-m-d',
				  timepicker: false,
				  formatDate: 'Y-m-d',
				  scrollMonth: false,
				  scrollInput: false,
				  onChangeDateTime: function(dp, $input) {}
				}
			  },
			   {
				 label: "DDQ Reactivation Trigger Date",
				 data: "DDQReactivationTriggerDate",
				 type: "datetime",
				 tooltip: "The date the DDQ was resent to a prospective partner.",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Reminder Date",
				 data: "ReminderDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Update Reactivation Result to Contracts Team",
				 data: "UpdateReactivationResulttoContractsTeam",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date an email is sent to the Contracts team informing them that the Partner has responded to the Reactivation and the L&R process and scoring will begin.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "DDQ Reactivation Result",
				 data: "DDQReactivationResult",
				 required: false,
				 tooltip: "Based on the results of the scoring, GBS Compliance determines the next step in the process.",
				 type: "select",
				 values: ['Close', 'EDD (BU Decision)', 'In Progress', 'OSI', 'Pass/Contract', 'DDQ_Rejected Non-Recruited'],
				 options: ['Close', 'EDD (BU Decision)', 'In Progress', 'OSI', 'Pass/Contract', 'DDQ_Rejected Non-Recruited']
			   }
			  ]
			]

		  },
		  {

			header: "OSI (CR)",
			group: [
			  [{
				label: "OSI Trigger Date",
				data: "OSITriggerDate",
				type: "datetime",
				placeholder: "Select a date",
				dtp: {
				  format: 'Y-m-d',
				  timepicker: false,
				  formatDate: 'Y-m-d',
				  scrollMonth: false,
				  scrollInput: false,
				  onChangeDateTime: function(dp, $input) {}
				}
			  },
			   {
				 label: "OSI Result Receive Date",
				 data: "OSIResultReceiveDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date the result of the OSI is received.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Update OSI Result to Contracts Team",
				 data: "UpdateOSIResultToContractsTeam",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date an email is sent to Contracts team informing them that the OSI has been received and the L&R process and scoring will begin.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "OSI Result",
				 data: "OSIResult",
				 required: false,
				 type: "select",
				 tooltip: "Based on the results of the scoring GBS Compliance determines the next step in the process.",
				 values: ['EDD', 'In Progress', 'In-depth Due Diligence (IDD)', 'Pass/Contract', 'Reject', 'Special Handling'],
				 options: ['EDD', 'In Progress', 'In-depth Due Diligence (IDD)', 'Pass/Contract', 'Reject', 'Special Handling']
			   }
			  ]
			]

		  },
		  {

			header: "EDD (CR)",
			group: [
			  [{
				label: "EDD Case Number(s)",
				data: "EDDCaseNumbers",
				required: false,
				value: null,
				type: "text",
				validation: ["minLen|1", "maxLen|100"],
			  },
			   {
				 label: "BU EDD Decision Date",
				 data: "BUEDDDecisionDate",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date the approval to proceed with an EDD is received from the Business Unit. Needs Business Unit checkpoint because the cost of an EDD needs to be budgeted.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "BU EDD Decision",
				 data: "BUEDDDecision",
				 type: "select",
				 values: ['BU_EDD proceed', 'BU_Reject EDD'],
				 options: ['BU_EDD proceed', 'BU_Reject EDD']
			   },
			   {
				 label: "EDD Trigger Date",
				 data: "EDDTriggerDate",
				 type: "datetime",
				 tooltip: "The date the request for an EDD is sent to Steele.",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "EDD Result Receive Date",
				 data: "EDDResultReceiveDate",
				 type: "datetime",
				 tooltip: "The date the result of the EDD is received.",
				 placeholder: "Select a date",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Update EDD Result to Contracts Team",
				 data: "UpdateEDDResultToContractsTeam",
				 type: "datetime",
				 placeholder: "Select a date",
				 tooltip: "The date an email is sent to Contracts team informing that the EDD result has been received and the L&R process and scoring will begin.",
				 dtp: {
				   format: 'Y-m-d',
				   timepicker: false,
				   formatDate: 'Y-m-d',
				   scrollMonth: false,
				   scrollInput: false,
				   onChangeDateTime: function(dp, $input) {}
				 }
			   },
			   {
				 label: "Final EDD Result",
				 data: "FinalEDDResult",
				 required: false,
				 tooltip: "Based on the results of the scoring, L&R Ops Compliance determines the next step in the process. This field will reflect the final result of the EDD.",
				 type: "select",
				 values: ['BU Decision', 'Pass/Business Caution', 'In Progress', 'Pass/Contract', 'Reject', 'Special Handling', 'ADD'],
				 options: ['BU Decision', 'Pass/Business Caution', 'In Progress', 'Pass/Contract', 'Reject', 'Special Handling', 'ADD']
			   },
			  ]
			]

		  },
		  {

			header: "BU Special Handling(CR)",
			group: [
			  [{
				label: "SH/BC Result Receive Date",
				data: "SHBCResultReceiveDate",
				type: "datetime",
				placeholder: "Select a date",
				tooltip: "Special Handling/Business Caution - the date received from the Business Unit for more investigation to accept or reject the partner. An internal HP process that goes back to the region for re-assessment.",
				dtp: {
				  format: 'Y-m-d',
				  timepicker: false,
				  formatDate: 'Y-m-d',
				  scrollMonth: false,
				  scrollInput: false,
				  onChangeDateTime: function(dp, $input) {}
				}
			  },
			   {
				 label: "SH/BC Final Result",
				 data: "SHBCFinalResult",
				 required: false,
				 type: "select",
				 tooltip: "The final result by the Business Unit.",
				 values: ['Country/Region Decision Pass Contract', 'Country/Region Decision In Progress', 'Country/Region Decision Reject'],
				 options: ['Country/Region Decision Pass Contract', 'Country/Region Decision In Progress', 'Country/Region Decision Reject']
			   },
			   {
				 label: "Extended DDQ Days",
				 data: "ExtendedDDQDays",
				 required: false,
				 tooltip: "An adjustment for the working days TAT based on reasons the DDQ is extended.",
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Extension Reason",
				 data: "ExtensionReason",
				 required: false,
				 tooltip: "The reason for an extension.",
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Holidays",
				 data: "Holidays",
				 required: false,
				 tooltip: "An adjustment for the working days TAT for any local holidays.",
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   }
			  ]
			]

		  }
		],
		config: function(node) {
		  return {
			dom: node.querySelector('.custom-fields'),
			pages: [{
			  nav: false,
			  structure: invitation.invitationOverview.customFields.structure,
			  callback: function() {
				setTimeout(function() {
				  var subRegion = node.querySelector("select[data-name='SubRegion']");
				  if(subRegion && invitation.customFieldsVal)
					subRegion.value =  invitation.customFieldsVal.SubRegion;

				  var dates = node.querySelectorAll('.date, .datetime');
				  var selects = node.querySelectorAll('.select');
				  var multiselects = node.querySelectorAll('.multiselect');				  
				  var clearIcon = `
<div class="date-clear" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="clear" width="24px" height="24px" style="
cursor: pointer;
">
<path fill="none" stroke="#666" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M5,5 L19,19">
  </path>
  </svg></div>`;
				  dates.forEach(function(el) {
					el.querySelector('svg').remove();
					el.querySelector('.fmmcosmin').insertAdjacentHTML('beforeend', clearIcon);
					el.addEventListener('click', function(ev) {
					  ev.target.parentNode.querySelector('input').value = '';
					  ev.preventDefault();
					  ev.stopPropagation();
					});
				  });
				  selects.forEach(function(el) {
					el.querySelector('.fmmcosmin').insertAdjacentHTML('beforeend', clearIcon);
					el.querySelector('.date-clear').addEventListener('click', function(ev) {
					  ev.currentTarget.parentNode.querySelector('select').value = '';
					  ev.preventDefault();
					  ev.stopPropagation();
					});
				  });
				  multiselects.forEach(function (el) {
					const multiselect = el.querySelector("select");
					multiselect.insertAdjacentHTML('beforebegin', '<div class="cf-multiselect-container"></div>');

					const init_options = Array.from(multiselect.querySelectorAll("option"));
					const container = el.querySelector(".cf-multiselect-container");

					let weakMapClones = new WeakMap();
					let weakMapOptions = new WeakMap();

					const moveSelectedToTop = function () {
					  const selected_options =
							Array.from(multiselect.querySelectorAll("option:checked")) || [];
					  selected_options.forEach((option) => {
						const isExist = weakMapOptions.get(option);
						if (!isExist) {
						  const clone = option.cloneNode(true);
						  weakMapClones.set(clone, option);
						  weakMapOptions.set(option, clone);
						  $(container).append(clone);

						  // Remove handler
						  $(clone).on("click", function () {
							const option = weakMapClones.get(clone);
							weakMapOptions.delete(option);
							weakMapClones.delete(clone);
							$(option).attr("style", "display: block !important;");
							option.selected = false;
							$(clone).remove();
						  });
						}
					  });

					  // Just in case check selected in the container (may be damaged due to nbsf)
					  const clones = container.querySelectorAll("option");
					  clones.forEach((clone) => {
						const option = weakMapClones.get(clone);
						option.selected = true;
						$(option).attr("style", "display: none !important;");
						$(clone).attr("style", "display: block !important;");
					  });

					  // Just in case check unselected (may be damaged due to nbsf)
					  init_options.forEach((option) => {
						const clone = weakMapOptions.get(option);
						if (!$(container).find($(clone)).length) {
						  $(option).attr("style", "display: block !important;");
						}
					  });
					};

					// Prepopulate
					moveSelectedToTop();

					// Change event
					el.addEventListener('change', function (ev) {
					  ev.preventDefault();
					  ev.stopPropagation();
					  moveSelectedToTop();
					});
				  });		  
				}, 500);
			  },
			  validation: function() {
				var result = {
				  fail: [],
				  pass: []
				};
				return result;
			  }
			}],
		  }

		},
		saveDate: function() {

		  /*crud.create("4007", data, function(d) { 
                                    if(d.EntryId){
                                      mo.fn.modal.unlock();
                                      mo.fn.modal.hide();
                                    }
                                    else
                                    {
                                      mo.fn.modal.unlock();
                                      mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
                                    }
                                  }); */
		}
	  },
	  riskRankColor: function(rank) {

		switch (rank) {
		  case 'Low Touch':
			return '#a9d47e'
			break;
		  case 'Low Pass':
			return '#2d8743'
			break;
		  case 'Medium Touch':
			return '#af923a'
			break;
		  case 'Medium High':
			return '#da9090'
			break;
		  case 'Medium Pass':
			return '#dcca96'
			break;
		  case 'High':
			return '#bb3e3e'
			break;
		  case 'No DDQ submitted':
			return '#e8badc'
			break;
		  case 'Not Available':
			return '#e8badc'
			break;
		  case 'High Touch':
			return '#943131'
			break;
		  case 'Medium High Touch':
			return '#d0b872'
			break;
		  default:
			return '#000'

		}
	  },
	  template: function(data) {
		var config = {};
		if (data.config.Config)
		  config = JSON.parse(data.config.Config);

		var opsStatus = "N/A";

		if (invitation.data.operational && invitation.data.operational.task.EntryId)
		  opsStatus = invitation.invitationOverview.tasks.config.filter(x => x.id == invitation.data.operational.task.FKB)[0].title;

		function getScore() {
		  var score = "N/A";

		  if (data.legacyData)
			score = invitation.data.legacyData.ThirdPartyRiskScore;

		  if (invitation.data.scoring && invitation.data.scoring.RiskScore != null)
			score = invitation.data.scoring.RiskScore;

		  return score;
		}

		function getCPI() {
		  var cpi = null;

		  if (data.scoring && data.scoring.CountryCPI)
			cpi = data.scoring.CountryCPI;
		  if (invitation.data.legacyData)
			cpi = invitation.data.legacyData.csCpi || invitation.data.legacyData.csCpi1;

		  return cpi || "N/A";
		}

		function getRequestedBy() {
		  var rb = "N/A";

		  if (data.overview && data.overview.RequestedBy)
			rb = data.overview.RequestedBy;
		  if (invitation.data.legacyData)
			rb = invitation.data.legacyData.CaseCreator || invitation.data.legacyData.CaseOwner || 'N/A';

		  return rb;
		}

		function getSubmittedBy() {
		  var rb = "N/A";

		  if (data.overview && data.overview.SubmitterEmail)
			rb = data.overview.SubmitterEmail;

		  if (invitation.data.legacyDDQ)
			rb = invitation.data.legacyDDQ.SubmittedBy_Email || 'N/A';

		  return rb;
		}

		function getSubmittedTS() {
		  var sts = "";

		  if (data.invitation.SubmittedTS)
			sts = data.invitation.SubmittedTS;

		  if (invitation.data.legacyDDQ)
			sts = invitation.data.legacyDDQ.Submitted || '';

		  return sts;
		}

		function getRiskRank() {

		  if (invitation.data.legacyData && invitation.data.legacyData.ThirdPartyRiskLevel) {
			var legacyRank = invitation.data.legacyData.ThirdPartyRiskLevel;
			if (legacyRank == "High")
			  return legacyRank;
			if (legacyRank == "High Touch" || legacyRank == "High-Touch")
			  return "High Touch";
			if (legacyRank == "Low Touch" || legacyRank == "LowTouch")
			  return "Low Touch";
			if (legacyRank == "Medium - High" || legacyRank == "Medium High")
			  return "Medium High";
			if (legacyRank == "Low - Pass")
			  return "Low Pass";
			if (legacyRank == "Medium - Pass")
			  return "Medium Pass";
			if (legacyRank == "Med-High Touch")
			  return "Medium High Touch";
			if (legacyRank == "Medium Touch")
			  return "Medium Touch";
			if (legacyRank == "No DDQ Submitted")
			  return "No DDQ submitted";
			if (legacyRank == "Not Available")
			  return "Not Available";
			return "N/A";
		  }


		  return data.scoring ? (data.scoring.ExceptionRiskRank || data.scoring.RiskRank) : "N/A";
		}

		function getConfigName() {
		  if(data.configFK == 107)
			return ((invitation.data.legacyData ? invitation.data.legacyData.CaseIntakeForm : null) || data.config.ConfigName || 'N/A ');
		  else return data.config.ConfigName;
		}

		var template = '<section class="wrapper invitationOverview">' +
			'<div class="container">' +
			'<div tab-id="application" class="nbsf active" data-step="step-1" data-step-name="Invitation "# ' + data.invitation.EntryId + '"">' +
			'<div class="row" review-id="companyInfo">' +
			`${!access.user.UserRole.Readonly ? `<div class="button-group invitation-refresh" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="128px" height="128px">
<path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9">
  </path>
  </svg><span>Refresh</span>
  </div>` +
			`<div class="button-group change-profile" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="transaction" width="128px" height="128px">
<path fill="none" stroke="#666" stroke-width="2" d="M2,7 L20,7 M16,2 L21,7 L16,12 M22,17 L4,17 M8,12 L3,17 L8,22">
  </path>
  </svg><span>Change profile</span>
  </div>` +
			`<div class="button-group invitation-complete invitation-status-disable" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="shield security" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M12,22 C12,22 2.99999999,18 3,11 L3,5 L12,2 L21,5 C21,5 21,11 21,11 C21,18 12,22 12,22 Z M12,14 C13.6568542,14 15,12.6568542 15,11 C15,9.34314575 13.6568542,8 12,8 C10.3431458,8 9,9.34314575 9,11 C9,12.6568542 10.3431458,14 12,14 Z M12,8 L12,5 M12,17 L12,14 M6,11 L9,11 M15,11 L18,11 M8,7 L10,9 M14,13 L16,15 M16,7 L14,9 M10,13 L8,15"></path></svg>
<span>Final Status</span>
  </div>` +
			`<div class="button-group invitation-pass-fail" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="validate" width="128px" height="128px">
<path fill="none" stroke="#666" stroke-width="2" d="M20,15 C19,16 21.25,18.75 20,20 C18.75,21.25 16,19 15,20 C14,21 13.5,23 12,23 C10.5,23 10,21 9,20 C8,19 5.25,21.25 4,20 C2.75,18.75 5,16 4,15 C3,14 1,13.5 1,12 C1,10.5 3,10 4,9 C5,8 2.75,5.25 4,4 C5.25,2.75 8,5 9,4 C10,3 10.5,1 12,1 C13.5,1 14,3 15,4 C16,5 18.75,2.75 20,4 C21.25,5.25 19,8 20,9 C21,10 23,10.5 23,12 C23,13.5 21,14 20,15 Z M7,12 L10,15 L17,8">
  </path>
  </svg><span>Pass/Fail</span>
  </div>` +
			`<div class="button-group invitation-profile-bt" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg><span>Profile</span>
  </div>` +
			`<div class="button-group invitation-resend" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="send" width="128px" height="128px" style="
">
<path fill="none" stroke="#666" stroke-width="2" d="M22,3 L2,11 L20.5,19 L22,3 Z M10,20.5 L13,16 M15.5,9.5 L9,14 L9.85884537,20.0119176 C9.93680292,20.5576204 10.0751625,20.5490248 10.1651297,20.009222 L11,15 L15.5,9.5 Z">
  </path>
  </svg><span>Re-send</span>
  </div>` : '' }` +
			'<h2 style="margin-left: 10px;">Case # ' + data.invitation.EntryId + (data.invitation.Status == 4 ? '<span style="color: green;"> Passed</span>' : (data.invitation.Status == 5 ? '<span style="color: red;"> Denied</span>' : "")) + "<span style='font-size:16px;'>" + (data.invitation.CloseCode ? " " + data.invitation.CloseCode + "" : "") + "</span>" + '</h2>' +

			'<div class ="row--left" style="width:35%;margin-bottom: 30px;">' +
			'<div class="item"><strong>Securimate Id:</strong>' +
			'<p class="prr">' + (invitation.data.legacyData ? invitation.data.legacyData.Case : "N/A") + '</p>' +
			'</div>' +
			'<div class="item"><strong>Official Company Name:</strong>' +
			'<p class="prr">' + (data.data && data.data.OfficialCompanyName  ? data.data.OfficialCompanyName : "N/A") + '</p>' +
			'</div>' +
			'<div class="item"><strong>English Company Name:</strong>' +
			'<p class="prr">' + (invitation.data && invitation.data.profile.EnglishCompanyName  ? invitation.data.profile.EnglishCompanyName : "N/A") + '</p>' +
			'</div>' +
			'<div class="item"><strong>Alternate Trade Name(s):</strong>' +
			'<p class="prr">' + (invitation.data && invitation.data.profile.TradingCompanyName  ? invitation.data.profile.TradingCompanyName : "N/A") + '</p>' +
			'</div>' +
			'<div class="item"><strong>Country:</strong>' +
			'<p class="prr">' + (data.data && data.data.Country && reference.countries.data.find(x => x.value == data.data.Country) ? (reference.countries.data.find(x => x.value == data.data.Country).option) : "N/A") + '</p>' +
			'</div>' +
			' <div class="item risk-rank"><strong>Risk Rank:</strong>' +
			' <p class="prr" style="color: white; background-color:' + invitation.invitationOverview.riskRankColor(getRiskRank()) + '; font-weight:bold; opacity: 0.5">' + getRiskRank() + '</p>' +
			'</div>' +
			' <div class="item"><strong>Score:</strong>' +
			' <p class="prr">' + getScore() + '</p>' +
			'</div>' +
			' <div class="item ops-status"><strong>Ops Status:</strong>' +
			' <p class="prr ops-status">' + opsStatus + '</p>' +
			'</div>' +
			' <div class="item"><span>Country CPI:</span>' +
			' <p class="prr">' + getCPI() + '</p>' +
			'</div>' +
			/*' <div class="item"><span>Country Override</span>' +
                                ' <p class="prr">' + ((!data.scoring || !data.scoring.CountryOverride) ? "N/A" : data.scoring.CountryOverride || "N/A") + '</p>' +
                                '</div>' +*/
			' <div class="item"><span>CPI Weight:</span>' +
			' <p class="prr">' + (config.weight == null ? "N/A" : config.weight.cpi) + '</p>' +
			'</div>' +
			' <div class="item"><span>DDQ Weight:</span>' +
			' <p class="prr">' + (config.weight == null ? "N/A" : config.weight.ddq) + '</p>' +
			'</div>' +
			'</div>' +

			'<div class ="row--right">' +
			' <div class="item"><strong>Status:</strong>' +
			' <p class="prr" >' + (invitation.manageStatus(data.invitation.Status) || 'N/A') + '</p>' +
			'</div>' +
			' <div class="item"><span>Requestor:</span>' +
			' <p class="prr">' + getRequestedBy() + '</p>' +
			'</div>' +
			' <div class="item"><span>Invitation Sent:</span>' +
			' <p class="prr">' + (util.getDate(data.invitation.SentTS) || util.getDate(data.invitation.Created) || 'N/A') + '</p>' +
			'</div>' +
			' <div class="item"><span>Intake Form:</span>' +
			' <p class="prr">' + (getConfigName() || 'N/A ') + ' ' + (data.config.Version || 'N/A ') + '</p>' +
			'</div>' +
			' <div class="item"><span>Language:</span>' +
			' <p class="prr">' + ((reference.languages.data.find(l => l.value == data.invitation.Language) || {}).option || data.invitation.Language || 'N/A ') + '</p>' +
			'</div>' +
			' <div class="item"><span>Submitter Email:</span>' +
			' <p class="prr">' + getSubmittedBy() + '</p>' +
			'</div>' +
			' <div class="item"><span>Submitted:</span>' +
			' <p class="prr">' + (util.getDate(getSubmittedTS()) || 'N/A') + '</p>' +
			'</div>' +
			' <div class="item"><span>Source:</span>' +
			' <p class="prr">' + (invitation.data.invitation.Source || 'N/A')  + '</p>' +
			'</div>' +
			' <div class="item"><span>Referral Id:</span>' +
			' <p class="prr">' + (invitation.data.invitation.ReferralId || 'N/A')  + '</p>' +
			'</div>' +
			' <div class="item"><span>IP Address:</span>' +
			' <p class="prr">' + ((invitation.data.overview && invitation.data.overview.Partner_IPAddress) ? invitation.data.overview.Partner_IPAddress  : 'N/A')  + '</p>' +
			'</div>' +

			'</div>' +



			'<div class="cfix"></div>' +
			' </div>' +
			' </div>' +
			' </div>' +
			'</section>';


		return template;
	  },
	  config: function() {
		return {
		  dom: document.querySelector('div[class="create_company"]'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Name:",
				  data: "CompanyName",
				  required: true,
				  value: null,
				  type: "text",
				  validation: ["minLen|1", "maxLen|100"],
				},
				 {
				   label: "Tax ID:",
				   data: "TaxId",
				   required: true,
				   value: null,
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 },
				 {
				   label: "Party ID:",
				   data: "PartyId",
				   required: false,
				   value: null,
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 },
				 {
				   label: "Country Entity:",
				   data: "CountryEntity",
				   required: false,
				   value: null,
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 },
				 {
				   label: "Country:",
				   data: "Country",
				   type: "select",
				   required: true,
				   value: null,
				   validation: ["inArray"],
				   options: search.countries.options,
				   values: search.countries.values
				 },
				]
			  ]
			},

					   ],
			callback: function() {},
		  }],
		  dataset: {},
		};
	  },
	  tasks: {
		node: null,
		oldTask: {},
		config: [],
		getNBSF: function(taskConfig, task, callback, node, preventAutoUpload = null, onError = undefined, onSuccess = undefined) {
		  var attachmentCaption = taskConfig.attachment.caption || "Please attach the file if needed.";
		  var title = taskConfig.title;

		  //Changed by the ticket HPE22-2119
		  // if (invitation.data.profile.Country == "KR")
		  //	title = title.replace("DDI", "OSI");

		  var conf = {
			pages: [{
			  nav: true,
			  structure: [
				{
				  header: title,
				  description: taskConfig.caption,
				  group: [
					[{
					  label: "Status:",
					  data: "Status",
					  required: true,
					  type: "select",
					  values: taskConfig.statuses,
					  options: taskConfig.statuses

					}],
				  ],
				},
				{
				  header: "Comment",
				  group: [
					[{
					  label: "Leave some comment here",
					  data: "Comment",
					  required: taskConfig.comment.required || false,
					  type: "textarea",
					  validation: ["minLen|1"]
					}]
				  ],
				},
				{
				  header: "Attachment",
				  description: attachmentCaption,
				  group: [
					[{
					  label: "Select File",
					  data: "Attachment",
					  required: taskConfig.attachment.required,
					  type: "kUpload",
					  value: null,
					  preventAutoUpload: preventAutoUpload,
					  onError: onError,
					  onSuccess: onSuccess,
					  uploadConfig: {
						formId: 1278,
						extensions: [],
						maxFileSize: 10
					  }
					}]
				  ],
				},
			  ],
			  callback: function() {
				var statusSelect = (node ? node : document).querySelector("[data-name=Status]");
				var opsSelect = (node ? node : document).querySelector("[data-name=SubStatus]");
				//HIDE/SHOW OPS STATUS SELECT DPEENDING ON THE SELECTED STATUS
				if (opsSelect) {
				  statusSelect.addEventListener("change", function(e) {
					if (statusSelect.selectedIndex == 2) {
					  opsSelect.closest(".wrapper").classList.remove("hidden");
					  nbsf.ui.ignoreValidation(opsSelect, false);
					} else {
					  opsSelect.closest(".wrapper").classList.add("hidden");
					  nbsf.ui.ignoreValidation(opsSelect, true);
					}
					nbsf.ev.global(conf, true);
				  });

				  opsSelect.closest(".wrapper").classList.add("hidden");
				  nbsf.ui.ignoreValidation(opsSelect, true);
				}

			  },
			  validation: function() {	
				var result = {
				  fail: [],
				  pass: []
				};

				return result;
			  }
			}],
			onSubmit: function() {
			  mo.fn.overlay.show({
				loading: true,
				close: false
			  });
			  invitation.holder().querySelector('[tab-id="task"] .buttons').style.display = "none";
			  callback();
			}
		  };

		  if (taskConfig.ops.length > 0)
			conf.pages[0].structure[0].group[0].push({
			  label: "Operation Status:",
			  data: "SubStatus",
			  required: true,
			  type: "select",
			  values: taskConfig.ops.map(x => x.text),
			  options: taskConfig.ops.map(x => x.text)
			});

		  return conf;
		},
		init: function(node) {
		  invitation.invitationOverview.tasks.node = node;
		  //CHECK IF THERE IS ANY ACTIVE TASK and CHECK USER'S PERMISSIONS

		  if (invitation.data.operational.task.EntryId && access.hasAccessToOperationTask(invitation.data.operational.task)) {
			//IF YES, SHOW IT 
			node.innerHTML = '<div class="invitation_op_tasks"></div>';
			invitation.invitationOverview.tasks.oldTask = {...invitation.data.operational.task};
			var config = invitation.invitationOverview.tasks.config.filter(x => x.id == invitation.data.operational.task.FKB)[0];
			var nbsfConf = invitation.invitationOverview.tasks.getNBSF(
			  config,
			  invitation.data.operational.task,
			  function() {
				invitation.invitationOverview.tasks.submit(config, nbsfConf);
			  },
			  null,
			  null,
			);
			nbsfConf.dom = node.querySelector('.invitation_op_tasks');
			nbsfConf.dataset = invitation.data.operational.task;

			nbsf.init(nbsfConf, 0);

			var kUpload = invitation.invitationOverview.tasks.node.querySelector("[data-name='Attachment']");
			var uploader = $(kUpload).data("kendoUpload");
			uploader.bind("error", function() {
			  mo.fn.modal.show({
				ctaLabel: "OK",
				class: "ark-modal",
				title: "Attachment is not saved",
				content: "<p>Failed to save attachment</p>"
			  });
			});

			if (access.user.UserRole.Readonly) node.querySelector('.buttons').style.display = 'none';

		  } else
			node.innerHTML = "<h4>There are no currently pending tasks.<h4>";
		},
		submit: util.debounce(function(taskConfig, nbsfConfig) {		  
		  var changeTask = nbsfConfig.dataset.Status == "Completed";

		  if(nbsfConfig.dataset.Status == "Completed" && nbsfConfig.dataset.SubStatus == "Select one")
		  {	
			return 
			mo.fn.modal.show({
			  ctaLabel: "OK",
			  class: "ark-modal",
			  title: "Operation status",
			  content: "Please, provied the operation status."
			});
		  }

		  var curTask = {
			Status: nbsfConfig.dataset.Status,
			Email: access.user.Email,
			Comment: nbsfConfig.dataset.Comment,
			SubStatus: changeTask ? nbsfConfig.dataset.SubStatus : null,
			StatusTS: (new Date()).toISOString()
		  };

		  //UPDATE THE CURRENT TASK
		  crud.update(3961, invitation.data.operational.task.EntryId, curTask, function(d) {
			if (d && d.EntryId) {

			  invitation.invitationOverview.addAuditLog("Note updated",
														util.getDifference(invitation.invitationOverview.tasks.oldTask, d),
														util.Email());

			  var newTask = {
				Region: d.Region,
				Status: "Pending",
				FKA: d.FKA,
				History: d.EntryId,
				Application: d.Application
			  };


			  function processNextAction(object) {
				var needCreateNewTask = true;
				if (object["task"]) {
				  newTask.FKB = object["task"];
				  if (object["task"] == 6) {
					mail.send({
					  "ID": "ARK_AGILITY_TEAM",
					  "To": "agilitycenter@hpe.com",
					  "Subject": 'Case Review',
					  "Col1": invitation.data.invitation.EntryId,
					  'Col2': invitation.data.profile.CompanyName,
					  'Col3': '<a href="https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '">https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '</a>'
					});
				  }
				  if (object["task"] == 4) {
					var sendTo = ''
					switch (invitation.data.invitation.Region) {
					  case 'EMEA':
						sendTo = "emea.legal.and.regulatory.region.leads@hpe.com";
						break;
					  case 'AMS':
						sendTo = "itza.maciel@hpe.com";
						break;
					  case 'APJ':
						sendTo = "apj.legal.and.regulatory.region.leads@hpe.com";
						break;
					}
					mail.send({
					  "ID": "ARK_REGION_LEAD",
					  "To": sendTo,
					  "Subject": 'ARK. Supplemental Questionnaire Task',
					  "Col1": invitation.data.invitation.EntryId,
					  'Col2': invitation.data.profile.CompanyName,
					  'Col3': '<a href="https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '">https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '</a>'
					});
				  }
				} else if (object["globalStatus"]) {
				  needCreateNewTask = false;

				  /*var newStatus = object["globalStatus"] == "Pass" ? 4 : 5;
                                crud.update(3693, invitation.data.invitation.EntryId, {
                                  Status: newStatus
                                }, function(d) {
                                  if(d && d.EntryId)
                                  {
                                    crud.read(3834, "inv=" + invitation.data.invitation.EntryId, function(overview){
                                      if(overview && overview.Rows.length > 0)
                                      { 
                                        overview = overview.Rows[0];
                                        crud.update(3982, overview.EntryId, {
                                          GlobalStatus: newStatus
                                        }, function(d) {

                                          invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, 3);
                                        });
                                      }
                                      else invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, 3);
                                    });
                                  }
                                  else 
                                    mo.fn.modal.show({
                                      ctaLabel: "OK",
                                      class: "ark-modal",
                                      title: "Data is not saved",
                                      content: "<p>Failed to save data while updating the invitation data." +  + "</p>"
                                    });

                                });

              */
				  invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, 3);
				} else needCreateNewTask = false;


				if (needCreateNewTask)
				  crud.create(3962, newTask, function(d) {
					if (d && d.EntryId) {
					  invitation.invitationOverview.addAuditLog("Task created",
																util.getDifference({}, d),
																util.Email());
					  invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, 3);
					} else mo.fn.modal.show({
					  ctaLabel: "OK",
					  class: "ark-modal",
					  title: "Data is not saved",
					  content: "<p>Failed to save data while creating a new task." + +"</p>"
					});
				  });
				else invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, 3);
			  }

			  //IF THE CURRENT TASK IS COMPLETED
			  if (changeTask) {
				if (taskConfig.ops.length > 0) {
				  var opsInfo = taskConfig.ops.find(x => x.text == nbsfConfig.dataset.SubStatus);
				  processNextAction(opsInfo);
				} else processNextAction(taskConfig.next);

			  }
			  //IF THE CURRENT TASK IS NOT COMPLETED
			  else {
				newTask.FKB = d.FKB;
				crud.create(3962, newTask, function(d) {
				  if (d && d.EntryId) {
					invitation.invitationOverview.addAuditLog("Note added",
															  util.getDifference({}, d),
															  util.Email());
					invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, 3);
				  } else mo.fn.modal.show({
					ctaLabel: "OK",
					class: "ark-modal",
					title: "Data is not saved",
					content: "<p>Failed to save data while creating a new task." + +"</p>"
				  });
				});
			  }
			  mo.fn.overlay.hide();
			} else {
			  mo.fn.modal.show({
				ctaLabel: "OK",
				class: "ark-modal",
				title: "Data is not saved",
				content: "<p>Failed to save data while updating the task." + +"</p>"
			  });
			  mo.fn.overlay.hide();
			}

		  });

		}, 700),
	  },
	  history: {
		init: function(node) {
		  node.innerHTML = '<div class="invitation_op_history"></div>';
		  invitation.invitationOverview.history.load(
			node.querySelector('.invitation_op_history'),
			invitation.data.operational.tasks
		  );
		},
		dataSource: function(data) {
		  return new kendo.data.DataSource({
			data: data,
			schema: {
			  model: {
				id: "EntryId",
			  }
			},
			serverPaging: false,
			pageSize: 10,
			serverFiltering: false
		  });
		},
		load: function(selector, data) {

		  data.forEach(x => {
			var task = invitation.invitationOverview.tasks.config.filter(y => y.id == x.TaskId)[0];
			x.TaskName = task.title;
		  });

		  var grid = $(selector);
		  grid.kendoGrid({
			dataSource: invitation.invitationOverview.history.dataSource(data),
			height: "600px",
			pageable: {
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  refresh: false
			},
			scrollable: true,
			sortable: false,
			filterable: false,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available. </div>"
			},
			columns: [
			  {
				field: "TaskName",
				title: "Task",
				width: "250px",
			  },
			  {
				field: "Status",
				title: "Status",
				width: "120px",
				template: function(d) {
				  return !!d.LastTask && !!d.LastTask.Archived ? "Archived" : d.Status;
				}
			  },
			  {
				field: "LastUpdate",
				title: "Last Update",
				hidden: false,
				width: "250px",
				headerAttributes: {
				  style: "white-space: normal"
				},
				template: function(d) {
				  return util.getDate(d.LastUpdate);
				}
			  },
			  {
				field: "LastSubmitter",
				title: "Last Submitter",
				hidden: false,
				width: "140px",
				headerAttributes: {
				  style: "white-space: normal"
				},
				template: function(d) {
				  return d.LastSubmitter || "";
				}
			  },
			  {
				title: "Actions",
				template: function(d) {
				  var icons = "";
				  var lastTask = d.LastTask;
				  if(!!lastTask && lastTask.Archived !== 1 && lastTask.Status == "Completed" && (access.user.UserRole.ADMIN || util.Email() === lastTask.Email))
					icons += '<a style="margin-left: 5px" class="edit"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="edit" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></svg></a>';

				  return icons;
				},
				width: "100px"
			  }
			],
			editable: false,
			detailInit: function(e) {

			  var history = e.data.history;

			  //INIT DETAIL GRID
			  var gridHistory = $("<div/>").appendTo(e.detailCell);
			  gridHistory.kendoGrid({
				dataSource: new kendo.data.DataSource({
				  data: history,
				  schema: {
					model: {
					  id: "EntryId"
					}
				  }
				}),
				scrollable: false,
				sortable: false,
				pageable: false,
				columns: [{
				  field: "Email",
				  title: "Submitter",
				  width: "250px",
				},
						  {
							field: "Status",
							title: "Task Status",
							width: "120px",
						  },
						  {
							field: "SubStatus",
							title: "Operation Status",
							width: "200px",
							headerAttributes: {
							  style: "white-space: normal"
							},
						  },
						  {
							field: "StatusTS",
							title: "Submitted",
							hidden: false,
							width: "140px",
							template: function(d) {
							  return d.StatusTS ? util.getDate(d.StatusTS) : "";
							}
						  },
						  {
							field: "Attachment",
							title: "Attachment",
							width: "200px"
						  },
						  {
							title: "Actions",
							template: function(d) {
							  var icons = "";
							  if (d.Attachment)
								icons += '<a style="margin-right: 5px" class="download"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="download" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M1,17 L1,23 L23,23 L23,17 M12,2 L12,19 M5,12 L12,19 L19,12"></path></svg></a>';

							  if (d.StatusTS)
								icons += '<a style="margin-left: 5px" class="preview"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="view" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></svg></a>';
							  return icons;
							},
							width: "100px"
						  }
						 ],
				editable: false
			  });

			  gridHistory.on("click", ".download", function(e) {
				var dataItem = gridHistory.data("kendoGrid").dataItem($(this).closest("tr"));
				var link = globalReferences.server + 'form/1278/attachments/' + dataItem.EntryId + '/Attachment?' + dataItem.Attachment;
				var aLink = document.createElement("a");
				aLink.setAttribute("target", "_self");
				aLink.innerHTML = dataItem.Attachment;
				aLink.setAttribute("href", link);
				aLink.click();

			  });

			  gridHistory.on("click", ".preview", function(e) {
				var dataItem = gridHistory.data("kendoGrid").dataItem($(this).closest("tr"));
				invitation.invitationOverview.history.taskDetials(dataItem);

			  });
			},
			dataBound: function(e) {
			  var data = grid.data("kendoGrid").dataSource.data();
			  data.map(row => {
				if (!!row.LastTask && !!row.LastTask.Archived) {
				  var element = $('tr[data-uid="' + row.uid + '"] ');
				  $(element).addClass("grid-row-old");
				}
			  });
			},
		  });
		  grid.on("click", ".edit", function(e) {
			var dataItem = grid.data("kendoGrid").dataItem($(this).closest("tr"));
			invitation.invitationOverview.history.editTask(dataItem.LastTask);
		  });
		},
		taskDetials: function(task) {

		  var taskConfig = invitation.invitationOverview.tasks.config.filter(y => y.id == task.FKB)[0];

		  mo.fn.modal.show({
			ctaLabel: "Close",
			class: "ark-modal",
			title: taskConfig.title,
			content: '<div class="invitation_task" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {
			  document.querySelector('.dxpModalFooter').classList.remove('hidden');

			  var container = document.querySelector(".invitation_task");

			  var link = globalReferences.server + 'form/1278/attachments/' + task.EntryId + '/Attachment?' + task.Attachment;

			  container.innerHTML =
				'<div class="title">Submitter</div><div class="value">' + task.Email + ' (' + util.getDate(task.StatusTS) + ')' + '</div>' +
				'<div class="title">Status</div><div class="value">' + task.Status + '</div>';

			  if (task.SubStatus)
				container.innerHTML +=
				  '<div class="title">Operation Status</div><div class="value">' + task.SubStatus + '</div>';

			  container.innerHTML +=
				'<div class="title">Comment</div><div class="value">' + task.Comment + '</div>';

			  if (task.Attachment)
				container.innerHTML +=
				  '<div class="title">Attachment</div><div class="value"><a target="_self" href=' + link + '>' + task.Attachment + '</a></div>';
			}
		  });
		},
		editTask: function(task) {
		  var curTask = {...task, Comment2: ""};
		  mo.fn.modal.show({
			ctaLabel: "Submit",
			closeLabel: "Cancel",
			class: "ark-modal",
			title: "Edit task",
			content: '<div class="invitation_task" style="overflow:auto;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {
			  document.querySelector('.dxpModalFooter').classList.remove('hidden');
			  var node = document.querySelector(".invitation_task");
			  invitation.invitationOverview.history.taskEditor.init(node, curTask);
			},
			ctaCallback: function() {
			  invitation.invitationOverview.history.taskEditor.submit(curTask);
			},
		  });
		},
		taskEditor: {
		  config: [],
		  nbsfConf: {},
		  oldTask: {},
		  node: null,
		  init: function(node, task) {
			node.innerHTML = '<div class="invitation_op_tasks"></div>';
			invitation.invitationOverview.history.taskEditor.node = node;
			invitation.invitationOverview.history.taskEditor.oldTask = {...task};
			var config = invitation.invitationOverview.tasks.config.filter(x => x.id == task.FKB)[0];
			invitation.invitationOverview.history.taskEditor.config = config;
			var nbsfConf = invitation.invitationOverview.tasks.getNBSF(config, task, function() {}, node, true);
			nbsfConf.dom = node.querySelector('.invitation_op_tasks');
			nbsfConf.dataset = task;
			nbsfConf.pages[0].structure.push({header: "Update reason", group: [[{
			  data: "Comment2",
			  label: "Reason to update",
			  required: true,
			  type: "textarea",
			  validation: ['minLen|1'],
			}]]});
			nbsfConf.onSubmit = function() {};
			nbsfConf.pages[0].nav = false;

			invitation.invitationOverview.history.taskEditor.nbsfConf = nbsfConf;
			nbsf.init(nbsfConf, 0);

			if(task.Status === "Completed" && config.ops.length > 0) {
			  var opsSelect = node.querySelector("[data-name=SubStatus]");
			  opsSelect.closest(".wrapper").classList.remove("hidden");
			  nbsf.ui.ignoreValidation(opsSelect, false);
			}
		  },
		  submit: function(task) {
			mo.fn.modal.lock();
			var res = nbsf.ev.global(invitation.invitationOverview.history.taskEditor.nbsfConf, true);
			if(res.total.fail) {
			  mo.fn.modal.unlock();
			  mo.fn.modal.msg("Please, fill all required fields",3);
			  return;
			}

			var oldTask = invitation.invitationOverview.history.taskEditor.oldTask;

			var changeTask = task.Status == "Completed";

			var curTask = {
			  Status: task.Status,
			  Email: access.user.Email,
			  Comment: task.Comment,
			  SubStatus: changeTask ? task.SubStatus : null,
			  StatusTS: (new Date()).toISOString(),
			  Comment2: task.Comment2,
			};

			var testNewTask = {...curTask, Attachment: task.Attachment};
			var testOldTask = {
			  Status: oldTask.Status,
			  Email: oldTask.Email,
			  Comment: oldTask.Comment,
			  SubStatus: oldTask.SubStatus,
			  StatusTS: oldTask.StatusTS,
			  Comment2: oldTask.Comment2,
			  Attachment: oldTask.Attachment,
			};
			testNewTask.Comment2 = oldTask.Comment2;
			testNewTask.StatusTS = oldTask.StatusTS;

			if(JSON.stringify(testNewTask) === JSON.stringify(testOldTask)) {
			  mo.fn.modal.unlock();
			  mo.fn.modal.msg("Nothing to update",2);
			  return;
			}

			const cb = function() {
			  mo.fn.modal.unlock();
			  mo.fn.modal.hide();
			  invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, null, function() {
				mo.fn.overlay.hide();
				invitation.holder().querySelector('[tab-id="history"]').click();
			  });
			};

			var needCreate = false;
			var needArchive = false;

			if(curTask.Status === "Completed" && curTask.SubStatus !== oldTask.SubStatus) {
			  needCreate = true;
			  needArchive = true;
			}
			else if(oldTask.Status === "Completed" && curTask.Status === "Pending") {
			  needArchive = true;
			  curTask.SubStatus = null;
			  curTask.Email = null;
			  curTask.StatusTS = null;
			}
			const callback = function(d) {
			  if (d && d.EntryId) {

				invitation.invitationOverview.addAuditLog(needArchive ? "Note created" : "Note updated",
														  util.getDifference(testOldTask, testNewTask),
														  util.Email());
				function fn() {

				  console.log("after arch");
				  if(needCreate) {
					// try to close here
					var newTask = {
					  Region: d.Region,
					  Status: "Pending",
					  FKA: d.FKA,
					  History: d.EntryId,
					  Application: d.Application
					};


					function processNextAction(object) {
					  var needCreateNewTask = true;
					  if (object["task"]) {
						newTask.FKB = object["task"];
						if (object["task"] == 6) {
						  mail.send({
							"ID": "ARK_AGILITY_TEAM",
							"To": "agilitycenter@hpe.com",
							"Subject": 'Case Review',
							"Col1": invitation.data.invitation.EntryId,
							'Col2': invitation.data.profile.CompanyName,
							'Col3': '<a href="https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '">https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '</a>'
						  });
						}
						if (object["task"] == 4) {
						  var sendTo = ''
						  switch (invitation.data.invitation.Region) {
							case 'EMEA':
							  sendTo = "emea.legal.and.regulatory.region.leads@hpe.com";
							  break;
							case 'AMS':
							  sendTo = "itza.maciel@hpe.com";
							  break;
							case 'APJ':
							  sendTo = "apj.legal.and.regulatory.region.leads@hpe.com";
							  break;
						  }
						  mail.send({
							"ID": "ARK_REGION_LEAD",
							"To": sendTo,
							"Subject": 'ARK. Supplemental Questionnaire Task',
							"Col1": invitation.data.invitation.EntryId,
							'Col2': invitation.data.profile.CompanyName,
							'Col3': '<a href="https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '">https://prp-dxp.it.hpe.com/group/internal/esm/-/link/15702?id=ark-central&fid=1166&cid=' + invitation.data.invitation.EntryId + '</a>'
						  });
						}
					  } else if (object["globalStatus"]) {
						needCreateNewTask = false;
						cb();
					  } else needCreateNewTask = false;

					  if (needCreateNewTask)
						crud.create(3962, newTask, function(d) {
						  if (d && d.EntryId) {
							invitation.invitationOverview.addAuditLog("Note added",
																	  util.getDifference({}, d),
																	  util.Email());
							cb();
						  } else {
							mo.fn.modal.unlock();
							mo.fn.modal.msg("Failed to save data while creating a new task",3);
						  }
						});
					}
					//IF THE CURRENT TASK IS COMPLETED
					if (changeTask) {
					  if (invitation.invitationOverview.history.taskEditor.config.ops.length > 0) {
						var opsInfo = invitation.invitationOverview.history.taskEditor.config.ops.find(x => x.text == task.SubStatus);
						processNextAction(opsInfo);
					  } else processNextAction(invitation.invitationOverview.history.taskEditor.config.next);
					}
					//IF THE CURRENT TASK IS NOT COMPLETED
					else {
					  newTask.FKB = d.FKB;
					  crud.create(3962, newTask, function(d) {
						if (d && d.EntryId) {
						  cb();
						} else {
						  mo.fn.modal.unlock();
						  mo.fn.modal.msg("Failed to save data while creating a new task",3);
						}
					  });
					}
				  }
				  else {
					cb();
				  }
				};

				if(needArchive) {
				  crud.update(3961, oldTask.EntryId, {Archived: 1}, function(d) {
					invitation.invitationOverview.history.taskEditor.archive(oldTask.EntryId, fn);
				  });
				}
				else {
				  fn();
				}
			  } 
			  else {
				mo.fn.modal.unlock();
				mo.fn.modal.msg("Failed to save data while updating the task",3);
			  }
			};
			if(needArchive) {
			  var newObj = {
				Attachment: task.Attachment,
			  };
			  crud.create(3962, newObj, function(d){
				if (d && d.EntryId) {
				  var newObj = {
					Application: task.Application,
					Archived: task.Archived,
					Attachment: task.Attachment,
					Comment: task.Comment,
					Comment2: task.Comment2,
					Country: task.Country,
					CountryEntity: task.CountryEntity,
					Email: access.user.Email,
					EntryId: task.EntryId,
					FKA: task.FKA,
					FKB: task.FKB,
					FKC: task.FKC,
					History: task.History,
					Owner: task.Owner,
					OwnerClass: task.OwnerClass,
					PartyId: task.PartyId,
					Region: task.Region,
					Status: task.Status,
					StatusTS: (new Date()).toISOString(),
					SubStatus: task.SubStatus
				  };
				  if(oldTask.Attachment !== task.Attachment) {
					mo.fn.modal.lock();
					var kUpload = invitation.invitationOverview.history.taskEditor.node.querySelector("[data-name='Attachment']");
					var uploader = $(kUpload).data("kendoUpload");
					if(needArchive) {
					  uploader.options.async.saveUrl = uploader.options.async.saveUrl.replace("/"+oldTask.EntryId.toString()+"/", "/"+d.EntryId.toString()+"/");
					}
					uploader.bind("error", function() {crud.destroy("4337", d.EntryId, function(d) { mo.fn.modal.unlock(); mo.fn.modal.msg("Failed to upload attachment",3);})});
					uploader.bind("success", function() {mo.fn.modal.unlock(); crud.update(3961, d.EntryId, newObj, callback)});
					uploader.upload();
				  }
				  else {
					crud.update(3961, d.EntryId, newObj, callback);
				  }
				}
				else {
				  mo.fn.modal.unlock();
				  mo.fn.modal.msg("Failed to save data while updating the task",3);
				}
			  });
			}
			else {
			  if(oldTask.Attachment !== task.Attachment) {
				mo.fn.modal.lock();
				var kUpload = invitation.invitationOverview.history.taskEditor.node.querySelector("[data-name='Attachment']");
				var uploader = $(kUpload).data("kendoUpload");
				if(needArchive) {
				  uploader.options.async.saveUrl = uploader.options.async.saveUrl.replace("/"+oldTask.EntryId.toString()+"/", "/"+d.EntryId.toString()+"/");
				}
				uploader.bind("error", function() {mo.fn.modal.unlock(); mo.fn.modal.msg("Failed to upload attachment",3)});
				uploader.bind("success", function() {mo.fn.modal.unlock(); crud.update(3961, oldTask.EntryId, curTask, callback)});
				uploader.upload();
			  }
			  else {
				crud.update(3961, oldTask.EntryId, curTask, callback);
			  }
			}

		  },
		  archive: function(eid, cb) {
			var ds = new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1278/ARK_OPS/kendo/data/search",
				  type: 'POST'
				},
			  },
			  schema: {
				model: {
				  id: "EntryId",
				  fields: {}
				}
			  },
			  serverPaging: true,
			  pageSize: 100,
			  serverFiltering: true,
			  filter: {field: "History",operator: "eq",value: eid},
			  serverSorting: true,
			  sort: {
				field: "EntryId",
				dir: "desc"
			  }
			});

			ds.read().then(function() {
			  var data = ds.view();
			  if(data && data.length) {
				var idx = 0;
				var callback = function(){
				  idx++;
				  console.log(`arch processed ${idx} of ${data.length} for ${eid}`);
				  if(idx >= data.length) {
					cb();
				  }
				};
				data.map(el => {
				  if(!!el.Archived) {
					callback();
					return;
				  }
				  crud.update(3961, el.EntryId, {Archived: 1}, function(d) {
					invitation.invitationOverview.addAuditLog("Note archived",
															  'Archived: "-" -> 1',
															  util.Email(), null, el.EntryId);
					invitation.invitationOverview.history.taskEditor.archive(el.EntryId, callback);
				  });
				});
			  }
			  else {
				console.log("arch no data");
				cb();
			  }
			});
		  },
		},
	  },
	  progressBar: function() {

		var dataset = invitation.data.data || {};

		var progressBar = invitation.holder().querySelector(".invitation_progress_bar");

		// ADD DEFAULT HTML TO THE PAGE
		var accdTitle = ui.translate('ACCDPage_Title');
		accdTitle = accdTitle.charAt(0).toUpperCase() + accdTitle.slice(1).toLowerCase();


		progressBar.innerHTML = '<ul>' +
		  /*'<li>' +
                    '<div class="master_step">' + ui.translate('PartnerTool') + '</div>' +
                    '<span class="dte">' + ui.translate('Loading') + '</span>' +
                    '</li>' +*/
		  '<li>' +
		  '<div class="master_step">' + ui.translate('CompanyProfile') + '</div>' +
		  '<span class="dte">' + ui.translate('Loading') + '</span>' +
		  '</li>' +
		  '<li>' +
		  '<div class="master_step">' + ui.translate('Training') + '</div>' +
		  '<span class="dte">' + ui.translate('Loading') + '</span>' +
		  '</li>' +
		  '<li>' +
		  '<div class="master_step">' + ui.translate('OwnersPage_Title') + '</div>' +
		  '<span class="dte">' + ui.translate('Loading') + '</span>' +
		  '</li>' +
		  '<li>' +
		  '<div class="master_step">' + ui.translate('DDQPage_Title') + '</div>' +
		  '<span class="dte">' + ui.translate('Loading') + '</span>' +
		  '</li>' +
		  '<li>' +
		  '<div class="master_step">' + ui.translate('ReviewPage_Title') + '</div>' +
		  '<span class="dte">' + ui.translate('Loading') + '</span>' +
		  '</li>' +
		  '<li>' +
		  '<div class="master_step">' + accdTitle + '</div>' +
		  '<span class="dte">' + ui.translate('Loading') + '</span>' +
		  '</li>' +
		  '</ul>' +
		  '<div class="line"></div>';


		var pages = progressBar.querySelectorAll("ul li");
		for (var i = 0; i < pages.length; i++) {
		  //SUBMITTED
		  if (invitation.data.invitation.SubmittedTS) {
			pages[i].setAttribute("class", "completed");
			pages[i].querySelector("span.dte").innerText = ui.translate("Completed");
		  } else
			//EXPIRED OR SENT
			if (invitation.data.invitation.Status == 3) {
			  pages[i].setAttribute("class", "");
			  pages[i].querySelector("span.dte").innerText = ui.translate("NotStarted");
			}
		  else
			//IN PROGRESS
			if (dataset.Page == i) {
			  pages[i].setAttribute("class", "active");
			  pages[i].querySelector("span.dte").innerText = ui.translate("Started");
			} else if (dataset.Page > i) {
			  pages[i].setAttribute("class", "completed");
			  pages[i].querySelector("span.dte").innerText = ui.translate("Completed");
			} else {
			  pages[i].setAttribute("class", "");
			  pages[i].querySelector("span.dte").innerText = ui.translate("NotStarted");
			}
		}
	  },
	  viewNote: function(data) {
		mo.fn.modal.show({
		  ctaLabel: "Close",
		  class: "ark-modal",
		  title: "Note #" + data.EntryId,
		  content: '<div class="profile_audit_log" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			var container = document.querySelector(".profile_audit_log");

			container.innerHTML =
			  '<div class="title">Modified</div><div class="value">' + data.ModifiedBy + ' (' + util.getDate(data.Modified) + ')' + '</div>' +
			  '<div class="title">Category</div><div class="value">' + data.Category + '</div>' +
			  '<div class="title">Subject</div><div class="value">' + data.Subject + '</div>' +
			  '<div class="title">Note</div><div class="value">' + data.Note + '</div>';
		  }
		});
	  },
	  editNote: function() {
		var conf = {
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Category",
				  data: "Category",
				  required: true,
				  type: "select",
				  values: ["General Information"],
				  options: ["General Information"]

				}, ],
				[{
				  label: "Subject",
				  data: "Subject",
				  required: true,
				  type: "text",
				  validation: ["minLen|1", "maxLen|255"]
				}, ],
				[{
				  label: "Note",
				  data: "Note",
				  required: true,
				  type: "textarea",
				  validation: ["minLen|1"]
				}]
			  ],
			}],
		  }],
		};

		mo.fn.modal.show({
		  ctaLabel: "Submit",
		  class: "ark-modal",
		  title: "Add Note",
		  content: '<div class="edit_note" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			conf.dom = document.querySelector(".dxpModalContent .edit_note");
			conf.dataset = {
			  "Category": "General Information"
			};
			invitation.noteConf = conf;
			nbsf.init(conf, 0);
		  },
		  ctaCallback: function() {

			var res = nbsf.ev.global(invitation.noteConf, true);
			if (res.total.fail > 0)
			  return;

			nbsf.data.update(invitation.noteConf, {});
			var data = invitation.noteConf.dataset;

			var invitationObj = invitation.data.invitation;

			mo.fn.modal.lock();

			data.InvitationFK = invitationObj.EntryId;
			crud.create("3993", data, function(d) {
			  if (d.EntryId) {

				mo.fn.modal.unlock();
				mo.fn.modal.hide();

				invitation.invitationOverview.updateSection(invitationObj.EntryId, null, function() {
				  mo.fn.overlay.hide();
				  invitation.holder().querySelector('[tab-id="notes"]').click();
				});

				invitation.invitationOverview.addAuditLog("Note added",
														  util.getDifference({}, data, invitation.noteConf),
														  util.Email());

			  } else {
				mo.fn.modal.unlock();
				mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
			  }
			});


		  }
		});
	  },
	  addAuditLog: function(type, changes, user, callback, invFK) {
		try {
		  if (!invFK)
			invFK = invitation.data.invitation.EntryId;

		  if (!invFK)
			return;

		  crud.create("3992", {
			Changes: changes,
			Type: type,
			User: user,
			InvitationFK: invFK
		  }, function(d) {
			if (callback)
			  callback();
		  });

		} catch (e) {
		  if (callback)
			callback();
		}
	  },
	  setAccdHTML: function(config, companyName, date) {
		var html = '';
		html = html + '<div class="accd-text">' + '<span class="bold">' + companyName + ' </span>' + nbsf.ui.translate(config, "ACCDPage_Text") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_A") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_B") + '</div>';
		html = html + '<div class="accd-subtext">' + nbsf.ui.translate(config, "ACCDPage_B1") + '</div>';
		html = html + '<div class="accd-subtext">' + nbsf.ui.translate(config, "ACCDPage_B2") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_C") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_D") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_E") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_F") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_G").replaceAll("[date]", '<span class="bold">' + date + '</span>') + '</div>';

		html = html + '<div class="accd-text">' + '<span class="bold">' + nbsf.ui.translate(config, "ACCDPage_Attest") + '</span>' + '</div>';
		html = html + '<div class="accd-subtext">' + nbsf.ui.translate(config, "ACCDPage_Attest1").replaceAll("[date]", '<span class="bold">' + date + '</span>') + '</div>';
		html = html + '<div class="accd-subtext">' + nbsf.ui.translate(config, "ACCDPage_Attest2").replaceAll("[date]", '<span class="bold">' + date + '</span>') + '</div>';
		html = html + '<div class="accd-subtext">' + nbsf.ui.translate(config, "ACCDPage_Attest3") + '</div>';


		html = html + '<div class="accd-text"><span class="bold">' + nbsf.ui.translate(config, "PRIVACY_NOTICE") + '</span>' + " — " + nbsf.ui.translate(config, "ACCDPage_Privacy_1") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_Privacy_2") + '</div>';
		html = html + '<div class="accd-text">' + nbsf.ui.translate(config, "ACCDPage_Privacy_3").split("HPE Privacy Statement").join("<a class='link' target='_blank' href='https://www.hpe.com/us/en/legal/privacy.html'>HPE Privacy Statement</a>") + '</div>';
		return html;
	  },
	  showAccdTab: function(node) {
		if (!invitation.data.data || invitation.data.config.EntryId == 107) {
		  if (invitation.data.legacyDDQ) {
			invitation.invitationOverview.legacyDataPreview(node, invitation.data.legacyDDQ, "accdData");
		  } else
			node.innerHTML = "No data available";
		  return;
		}

		if (invitation.data.invitation.Status >= 2 || invitation.data.data && invitation.data.data["StandardColumn32"]) {
		  var date = invitation.data.data.SubmittedDate;
		  var ts = new Date(invitation.data.data.SubmittedDate);
		  if (!date) {
			ts = new Date(invitation.data.invitation.SubmittedTS);
		  }
		  var userTimezoneOffset = ts.getTimezoneOffset() * 60000;
		  ts = new Date(ts.getTime() - userTimezoneOffset);
		  date = ts.toJSON().slice(0, 10);
		  var config = JSON.parse(invitation.data.config.Config);
		  config.reference = {
			languages: reference.translations.data
		  };
		  config.dataset = invitation.data.data;

		  var companyName = ""; //config.dataset["OfficialCompanyName"]
		  if (config.dataset && config.dataset["OfficialCompanyName"])
			companyName = config.dataset["OfficialCompanyName"];
		  else if (invitation.data.legacyDDQ && invitation.data.legacyDDQ.OfficialCompanyName)
			companyName = invitation.data.legacyDDQ.OfficialCompanyName;


		  var html = '<div class="accd-page">';
		  html += invitation.invitationOverview.setAccdHTML(config, companyName, date);

		  //PolicyProcedureCert
		  //SubsidiariesList

		  if (invitation.data.data && invitation.data.data["PolicyProcedureCert"]) {
			html += "<div style='margin-top:30px;margin-bottom:5px;font-weight:600;'>" + nbsf.ui.translate(config, "ACCDPage_PolicyProcedureCert") + "</div>";
			html += '<a href="' +
			  globalReferences.server + 'form/' + 1285 + '/attachments/' + invitation.data.data.EntryId + '/PolicyProcedureCert?' + invitation.data.data.EntryId +
			  '" download>' + invitation.data.data["PolicyProcedureCert"] + '</a>';
		  }

		  if (invitation.data.data && invitation.data.data["SubsidiariesList"]) {
			html += "<div style='margin-top:30px;margin-bottom:5px;font-weight:600;'>" + nbsf.ui.translate(config, "ACCDPage_SubsidiariesList") + "</div>";
			html += '<a href="' +
			  globalReferences.server + 'form/' + 1285 + '/attachments/' + invitation.data.data.EntryId + '/SubsidiariesList?' + invitation.data.data.EntryId +
			  '" download>' + invitation.data.data["SubsidiariesList"] + '</a>';
		  }


		  html = html + "</div>";

		  node.innerHTML += html;

		  node.innerHTML += '<section name="submitter-data" style="margin-left:10px;margin-bottom:30px">';


		  if (invitation.data.config) {
			if (invitation.data.data) {
			  var config = util.parseConfigStr(invitation.data.config.Config);
			  var lastPage = config.pages[config.pages.length - 1];
			  var section = lastPage.structure.find(x => x.header == "SubmittedBy");
			  if (section) {
				section.group[0].forEach(x => {
				  node.innerHTML += '<div style="margin-top:20px">' + ui.translate(x.label) + '</div>';
				  node.innerHTML += '<div style="margin-top:10px;"><strong>' + invitation.data.data[x.data] + '</strong></div>';
				});

				node.innerHTML += '<div style="margin-top:40px">Date</div>';
				node.innerHTML += '<div style="margin-top:10px;margin-bottom:30px"><strong>' + date + " " + ts.toJSON().slice(11, 16) + " UTC"; + '</strong></div>';
				node.innerHTML += '</section>';
			  }
			} else {
			  if (invitation.data.legacyDDQ) {
				var obj = {
				  "Name": "SubmittedBy_Name",
				  "Telephone": "SubmittedBy_Phone",
				  "Position": "SubmittedBy_Title",
				  "Email": "SubmittedBy_Email"
				};

				var keys = Object.keys(obj);
				keys.forEach(x => {
				  node.innerHTML += '<div style="margin-top:20px">' + ui.translate(x) + '</div>';
				  node.innerHTML += '<div style="margin-top:10px;"><strong>' + invitation.data.legacyDDQ[obj[x]] + '</strong></div>';
				});

				if (invitation.data.invitation.SubmittedTS) {
				  node.innerHTML += '<div style="margin-top:40px">Date</div>';
				  node.innerHTML += '<div style="margin-top:10px;margin-bottom:30px"><strong>' + date + " " + ts.toJSON().slice(11, 16) + " UTC"; + '</strong></div>';
				  node.innerHTML += '</section>';
				}

			  } else node.innerHTML = "No data available";
			}
		  }
		} else {
		  invitation.holder().querySelector('[tab-id="accd"]').style.display = "none";
		}
	  },
	  initAuditTab: function(node) {
		node.innerHTML = "<div class='inv-audit-grid'></div>";
		var selector = node.querySelector(".inv-audit-grid");

		var columns = [{
		  field: "Type",
		  title: "Type",
		  hidden: false,
		  width: "250px",
		  locked: true,
		  headerAttributes: {
			style: "white-space: normal"
		  },
		},
					   {
						 field: "Changes",
						 title: "Changes",
						 hidden: false,
						 width: "550px",
						 template: function(d) {
						   var res = d.Changes;
						   if (d.Changes.length > 250)
							 res = d.Changes.substring(0, 250) + "...";

						   res = res.replaceAll("##", "\n");

						   return res;
						 }
					   },
					   {
						 field: "User",
						 title: "Modified By",
						 hidden: false,
						 width: "200px"

					   },
					   {
						 field: "Modified",
						 title: "Date",
						 hidden: false,
						 width: "200px",
						 template: function(d) {
						   return d.LegacyCreated ? util.getDate(d.LegacyCreated) : util.getDate(d.Created)
						 }
					   },

					   {
						 title: "",
						 width: "75px",
						 locked: true,
						 hidden: false,
						 attributes: {
						   "class": "cta"
						 },
						 template: function(d) {
						   var icons = '<a class="view_details"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
						   return icons;
						 }
					   }
					  ];

		$(selector).kendoGrid({
		  height: 500,
		  dataSource: new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1371/ARK_Profile_Audit/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				fields: {}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			filter: {
			  field: "InvitationFK",
			  operator: "eq",
			  value: invitation.data.invitation.EntryId
			},
			serverSorting: true,
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  }),
		  columns: columns,
		  pageable: {
			buttonCount: 4,
			pageSize: 15,
			pageSizes: [10, 25, 50, 100],
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  groupable: false,
		});

		$(selector).delegate(".view_details", "click", function(e) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  invitation.invitationOverview.viewAuditLog(row);
		});
	  },
	  viewAuditLog: function(data) {
		mo.fn.modal.show({
		  ctaLabel: "Close",
		  class: "ark-modal",
		  title: "Audit Log #" + data.EntryId,
		  content: '<div class="profile_audit_log" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			var container = document.querySelector(".profile_audit_log");

			container.innerHTML =
			  '<div class="title">Modified</div><div class="value">' + data.ModifiedBy + ' (' + util.getDate(data.Modified) + ')' + '</div>' +
			  '<div class="title">Type</div><div class="value">' + data.Type + '</div>';

			container.innerHTML +=
			  '<div class="title">Description</div><div class="value" style="white-space: pre-line;">' + (util.beautifyAuditString(data.Changes).replaceAll("##", "\n") || "-") + '</div>';

		  }
		});
	  },
	  initDocumentsTab: function(node) {

		mo.fn.overlay.show({
		  loading: true,
		  close: false
		});

		node.innerHTML = "<div class='inv-documents'></div>" +
		  `${!access.user.UserRole.Readonly ? '<a class="k-button k-button-action inv-add-document" style="margin-top: 30px; float: right; margin-left:15px;" href="#"  >Add Document</a>;' : '' }`;
		var selector = node.querySelector(".inv-documents");

		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1370/ARK_Profile_Document/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  filter: [{
			field: "InvitationFK",
			operator: "eq",
			value: invitation.data.invitation.EntryId
		  },
				   {
					 field: "Visible",
					 operator: "eq",
					 value: 1
				   },
				  ],
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		});
		ds.read().then(function() {
		  mo.fn.overlay.hide();
		  var data = [];
		  var docs = ds.view();

		  docs.forEach(x => {
			if(x.LegacyCreated)
			  x.Date = x.LegacyCreated || x.Created;
			else x.Date = x.Modified|| x.Created;
			data.push(x.toJSON());
		  });

		  if (invitation.data.operational)
			invitation.data.operational.tasks.forEach(x => {
			  if (!x.history)
				return;
			  x.history.forEach(y => {
				if (y.Attachment && y.Archived !== 1)
				  data.push({
					File: y.Attachment,
					Description: y.Comment,
					Category: invitation.invitationOverview.tasks.config.filter(x => x.id == y.FKB)[0].title,
					TaskFile: y.Attachment,
					TaskId: y.EntryId,
					Created: y.StatusTS,
					Date: y.StatusTS,
					CreatedBy: y.Email,
					Task: y
				  });
			  });
			});

		  data = data.sort((x,y) => (x.Date > y.Date ? -1 : (x.Date < y.Date ? 1 : 0)));


		  if (node.querySelector(".inv-add-document")) {
			node.querySelector(".inv-add-document").addEventListener("click", function() {
			  invitation.invitationOverview.editDocument();
			});
		  }

		  var columns = [
			{
			  field: "File",
			  title: "File Name",
			  hidden: false,
			  width: "300px",
			  locked: true,
			  headerAttributes: {
				style: "white-space: normal"
			  },
			  template: function(d) {
				if (d.LegacyFileName)
				  return '<a class="download" style="color: blue;text-decoration: underline;">' + d.LegacyFileName + ' </a>';
				return '<a class="download" style="color: blue;text-decoration: underline;">' + d.File + ' </a>'
			  }
			},
			{
			  field: "Description",
			  title: "Description",
			  hidden: false,
			  width: "300px",
			  locked: false,
			  template: function(d) {
				if ((d.Description || '').length > 250)
				  return d.Description.substring(0, 250);

				return d.Description;
			  }
			},
			{
			  field: "Category",
			  title: "Category",
			  hidden: false,
			  width: "200px",
			},
			{
			  field: "Date",
			  title: "Date",
			  hidden: false,
			  width: "150px",
			  template: function(d) {
				if (d.LegacyCreated)
				  return util.getDate(d.LegacyCreated);
				return util.getDate(d.Modified|| d.Created);
			  }

			},
			{
			  field: "CreatedBy",
			  title: "Owner",
			  hidden: false,
			  width: "200px",
			  template: function(d) {
				if (d.LegacyCreated)
				  return d.LegacyCreatedBy || "N/A";
				return d.CreatedBy;
			  }
			},
			{
			  title: "",
			  width: "120px",
			  locked: true,
			  hidden: false,
			  attributes: {
				"class": "cta"
			  },
			  template: function(d) {
				var icons = '<a class="view_doc"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';

				if ((util.Email() == d.CreatedBy || access.user.UserRole.ADMIN)) {
				  console.log(d);
				  if(!d.TaskId) {
					icons += '<a class="edit_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></a>';
					icons += '<a class="delete_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="21px" height="21px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M4,5 L20,5 L20,23 L4,23 L4,5 Z M1,5 L23,5 M9,1 L15,1 L15,5 L9,5 L9,1 Z M9,1 L15,1 L15,5 L9,5 L9,1 Z M15,9 L15,19 M9,9 L9,19"></path></a>';
				  }
				  else if(!!d.Task && d.Task.Archived !== 1 && d.Task.Status == "Completed" && (access.user.UserRole.ADMIN || util.Email() === d.Task.Email))
					icons += '<a style="margin-left: 5px" class="edit_task"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></a>';

				}
				return icons;
			  }
			}
		  ];

		  $(selector).kendoGrid({
			height: 500,
			dataSource: data,
			columns: columns,
			pageable: {
			  buttonCount: 4,
			  pageSize: 15,
			  pageSizes: [10, 25, 50, 100],
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
			groupable: false,
		  });


		  $(selector).delegate(".view_doc", "click", function(e) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.viewDocument(row.toJSON());
		  });

		  $(selector).delegate(".download", "click", function(e) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			var link = globalReferences.server + 'form/1370/attachments/' + row.EntryId + '/File?' + row.File;
			if (row.TaskFile)
			  link = globalReferences.server + 'form/1278/attachments/' + row.TaskId + '/Attachment?' + row.File;

			if (row.LegacyFileName)
			  link = globalReferences.server + 'resources/rs/custom/ark/attachments/' + invitation.data.profile.LegacyId + '/' + invitation.data.invitation.LegacyId + "/" + (row.LegacyFilePath || "") + row.LegacyFileName;

			var aLink = document.createElement("a");
			aLink.setAttribute("target", "_blank");
			aLink.innerHTML = row.File;
			aLink.setAttribute("href", link);
			aLink.click();
		  });


		  $(selector).delegate(".edit_doc", "click", function(e) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.editDocument(row.toJSON());
		  });

		  $(selector).delegate(".edit_task", "click", function(e) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.history.editTask(row.Task);
		  });

		  $(selector).delegate(".delete_doc", "click", function(e) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.deleteDocument(row.toJSON());
		  });
		});
	  },
	  viewDocument: function(data) {
		mo.fn.modal.show({
		  ctaLabel: "Close",
		  class: "ark-modal",
		  title: "Document #" + data.EntryId,
		  content: '<div class="profile_doc" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			var container = document.querySelector(".profile_doc");

			var link = globalReferences.server + 'form/1370/attachments/' + data.EntryId + '/File?' + data.File;
			if (data.TaskFile)
			  link = globalReferences.server + 'form/1278/attachments/' + data.TaskId + '/Attachment?' + data.File;

			container.innerHTML =
			  '<div class="title">Modified</div><div class="value">' + data.CreatedBy + ' (' + util.getDate(data.Created || data.Modified) + ')' + '</div>' +
			  '<div class="title">Category</div><div class="value">' + data.Category + '</div>';

			container.innerHTML +=
			  '<div class="title">Description</div><div class="value">' + (data.Description || "-") + '</div>';

			if (data.File)
			  container.innerHTML +=
				'<div class="title">Attachment</div><div class="value"><a target="_self" href=' + link + '>' + data.File + '</a></div>';
		  }
		});
	  },
	  editDocument: function(d) {

		function showModal(data) {
		  var conf = {
			pages: [{
			  nav: false,
			  structure: [{
				group: [
				  [{
					label: "Category",
					data: "Category",
					required: true,
					type: "select",
					values: ["DDI Scorecard", "EDD Scorecard", "Email", "Exempt Certification", "GDC report", "General", "Global Trade", "IFQ",
							 "Lobbyist Report", "LSP Report", "OSI ScoreCard", "Special Handling Documentation", "DDI Report", "IDD Report", "Supplier Report", "IDD Scorecard"
							],
					options: ["DDI Scorecard", "EDD Scorecard", "Email", "Exempt Certification", "GDC report", "General", "Global Trade", "IFQ",
							  "Lobbyist Report", "LSP Report", "OSI ScoreCard", "Special Handling Documentation", "DDI Report", "IDD Report", "Supplier Report", "IDD Scorecard"
							 ],

				  }],
				  [{
					label: "Provide a description of the document you are uploading",
					data: "Description",
					required: true,
					type: "textarea",
					validation: ["minLen|1"]
				  }],
				  [{
					label: "Select File",
					data: "File",
					required: true,
					type: "kUpload",
					value: null,
					uploadConfig: {
					  formId: 1370,
					  extensions: [],
					  maxFileSize: 10
					}
				  }]
				],
			  }, ],
			  callback: function() {

			  },
			  validation: function() {
				var result = {
				  fail: [],
				  pass: []
				};
				return result;
			  }
			}]
		  };

		  mo.fn.modal.show({
			ctaLabel: "Submit",
			class: "ark-modal",
			title: data ? "Edit document" : "Add document",
			content: '<div class="edit_doc" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {
			  document.querySelector('.dxpModalFooter').classList.remove('hidden');

			  conf.dom = document.querySelector(".dxpModalContent .edit_doc");
			  invitation.docConf = conf;
			  invitation.docData = data || {};
			  conf.dataset = JSON.parse(JSON.stringify(data || {}));
			  nbsf.init(conf, 0);
			},
			ctaCallback: function() {

			  var res = nbsf.ev.global(invitation.docConf, true);
			  if (res.total.fail > 0)
				return;


			  nbsf.data.update(invitation.docConf, {});
			  var oldData = invitation.docData;
			  var data = invitation.docConf.dataset;

			  mo.fn.modal.lock();

			  var isNew = data.Visible != 1;

			  data.Visible = 1;
			  crud.update("3990", data.EntryId, data, function(d) {
				if (d.EntryId) {

				  mo.fn.modal.unlock();
				  mo.fn.modal.hide();

				  invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, null, function() {
					mo.fn.overlay.hide();
					invitation.holder().querySelector('[tab-id="documents"]').click();
				  });

				  if (isNew)
					invitation.invitationOverview.addAuditLog("Document added", util.getDifference({}, data), util.Email());
				  else invitation.invitationOverview.addAuditLog("Document changed", util.getDifference(oldData, data), util.Email());

				} else {
				  mo.fn.modal.unlock();
				  mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
				}
			  });


			}
		  });
		}

		mo.fn.overlay.show({
		  close: false,
		  loading: true
		});

		//EDIT
		if (d && d.EntryId)
		  showModal(d);
		//NEW
		else {
		  var data = {};
		  data.InvitationFK = invitation.data.invitation.EntryId;
		  data.Visible = 0;
		  crud.create("3989", data, function(d) {
			if (d.EntryId) {
			  invitation.invitationOverview.addAuditLog("Document added", util.getDifference({}, d), util.Email(), null, data.InvitationFK);
			  mo.fn.overlay.hide();
			  showModal(d);
			} else {
			  mo.fn.modal.show({
				ctaLabel: "oK",
				class: "ark-modal",
				title: "Error",
				content: 'Error:' + JSON.stringify(d)
			  });
			}
		  });
		}


	  },
	  deleteDocument: function(d) {
		var deleteConf;

		function showModal(data) {
		  var conf = {
			pages: [{
			  nav: false,
			  structure: [{
				group: [
				  [{
					label: "Reason for deleting the document",
					data: "Reason",
					required: true,
					type: "textarea",
					validation: ["minLen|1"]
				  }]
				],
			  }, ],
			  callback: function() {

			  },
			  validation: function() {
				var result = {
				  fail: [],
				  pass: []
				};
				return result;
			  }
			}]
		  };

		  mo.fn.modal.show({
			ctaLabel: "Delete",
			class: "ark-modal",
			title: "Delete document",
			content: '<div class="delete_doc" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {
			  document.querySelector('.dxpModalFooter').classList.remove('hidden');

			  conf.dom = document.querySelector(".dxpModalContent .delete_doc");
			  deleteConf = conf;
			  // invitation.docData = data || {};
			  // conf.dataset = JSON.parse(JSON.stringify(data || {}));
			  nbsf.init(conf, 0);
			},
			ctaCallback: function() {
			  var res = nbsf.ev.global(deleteConf, true);
			  if (res.total.fail > 0)
				return;


			  nbsf.data.update(deleteConf, {});
			  var data = deleteConf.dataset;
			  mo.fn.modal.lock();

			  invitation.invitationOverview.docToDelete = d;
			  invitation.invitationOverview.docToDelete.reason = data.Reason;
			  crud.destroy("3991", d.EntryId, function(d) {
				invitation.invitationOverview.updateSection(invitation.data.invitation.EntryId, null, function() {
				  mo.fn.overlay.hide();
				  mo.fn.modal.hide();
				  invitation.holder().querySelector('[tab-id="documents"]').click();
				  invitation.invitationOverview.addAuditLog("Document deleted",
															util.getDifference({}, invitation.invitationOverview.docToDelete),
															util.Email());
				});
			  });



			}
		  });
		}

		mo.fn.overlay.show({
		  close: false,
		  loading: true
		});

		//EDIT
		if (d && d.EntryId)
		  showModal(d);
	  },
	},
  };
</script>

<!-- INVITATIONS -->
<script>
  const myInvitations = {
	holder: function() {
	  return document.querySelector('#navigation #invitations:last-child')
	},
	html: function() {
	  return '<div id="invitations">' +
		'<div class="myInv-company_details hidden"></div>' +
		'<div class="grids"></div>' +
		'<section class="quick_view hidden"></section>' +
		'</div>';
	},
	init: function() {
	  myInvitations.ui();
	  console.log('myInvitations init');

	  recentlyViewed.add({
		Module: 'Cases',
		Id: null,
	  }, function() {
		mo.fn.overlay.hide();
	  });
	},
	_overviewRefresh: function() {
	  myInvitations.holder().querySelector('.myInv-company_details').innerHTML = "";
	},
	ui: function() {
	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });
	  navigation.push(myInvitations.html());

	  hpe.ui.tabs({
		dom: myInvitations.holder().querySelector(".grids"),
		tabs: [{
		  label: "All",
		  id: "all"
		},
			   {
				 label: "Sent",
				 id: "sent"
			   },
			   {
				 label: "Submitted",
				 id: "submitted"
			   },
			   {
				 label: "Expired",
				 id: "expired"
			   },
			   {
				 label: "Passed",
				 id: "passed"
			   },
			   {
				 label: "Denied",
				 id: "denied"
			   },
			   {
				 label: "Program Enrollment",
				 id: "program-enrollment"
			   },
			  ]
	  }, function(all) {
		myInvitations.all.init(all[0]);

		myInvitations.holder().querySelector('span[tab-id="sent"]').addEventListener('click', function() {
		  myInvitations.sent.init(all[1]);
		});

		myInvitations.holder().querySelector('span[tab-id="submitted"]').addEventListener('click', function() {
		  myInvitations.submitted.init(all[2]);
		});

		myInvitations.holder().querySelector('span[tab-id="expired"]').addEventListener('click', function() {
		  myInvitations.expired.init(all[3]);
		});

		myInvitations.holder().querySelector('span[tab-id="passed"]').addEventListener('click', function() {
		  myInvitations.passed.init(all[4]);
		});

		myInvitations.holder().querySelector('span[tab-id="denied"]').addEventListener('click', function() {
		  myInvitations.rejected.init(all[5]);
		});
		myInvitations.holder().querySelector('span[tab-id="program-enrollment"]').addEventListener('click', function() {
		  myInvitations.programEnrollment.init(all[6]);
		});

	  });
	},
	dataSource: function(filter) {

	  /*var userFilter = {
              field: "RequestedBy",
              operator: "eq",
              value: util.Email()
            };

            if(!access.user.UserRole["ADMIN"])
            {
              if(filter && filter.filters)
                filter.filters.push(userFilter);
              else filter = userFilter;
            }*/
	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1284/ARK_Overview_Joined/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		pageSize: 10,
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,
		/* set default sort */
		sort: {
		  field: "EntryId",
		  dir: "desc"
		}

	  });
	},
	all: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-all'></section>";

		var filter = {};
		var columns = myInvitations.grid._columns();
		columns.splice(2, 0, {
		  field: "Status",
		  title: "Status",
		  width: "160px",
		  locked: true,
		  template: function(d) {
			return invitation.manageStatus(d.Status);
		  }
		});
		myInvitations.grid._load(node.querySelector('.invitations-grid-all'), myInvitations.dataSource(filter), columns, true, false, node);
	  },

	},
	sent: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-sent'></section>";

		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "1"
		  }]
		};
		myInvitations.grid._load(node.querySelector('.invitations-grid-sent'), myInvitations.dataSource(filter), myInvitations.grid._columns(), true, false, node);
	  },

	},
	submitted: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-submitted'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "2"
		  }]
		};
		myInvitations.grid._load(node.querySelector('.invitations-grid-submitted'), myInvitations.dataSource(filter), myInvitations.grid._columns(), true, false, node);
	  },

	},
	expired: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-expired'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "3"
		  }]
		};
		myInvitations.grid._load(node.querySelector('.invitations-grid-expired'), myInvitations.dataSource(filter), myInvitations.grid._columns(), true, false, node);
	  },

	},
	passed: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-passed'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "4"
		  }]
		};
		myInvitations.grid._load(node.querySelector('.invitations-grid-passed'), myInvitations.dataSource(filter), myInvitations.grid._columns(), true, false, node);
	  },

	},
	rejected: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-rejected'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "5"
		  }]
		};
		myInvitations.grid._load(node.querySelector('.invitations-grid-rejected'), myInvitations.dataSource(filter), myInvitations.grid._columns(), true, false, node);
	  },

	},
	programEnrollment: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-program'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Source",
			operator: "eq",
			value: "ProgramEnrollment"
		  }]
		};
		console.log(filter);
		myInvitations.grid._load(node.querySelector('.invitations-grid-program'), myInvitations.dataSource(filter), myInvitations.grid._columns(), true, false, node);
	  },

	},
	grid: {
	  _columns: function() {
		var cusConfig = [
		  {
			field: "EntryId",
			title: "Case #",
			hidden: false,
			width: "140px",
			locked: true
		  },
		  {
			field: "ConfigName",
			title: "Intake form",
			hidden: false,
			width: "200px",
			locked: true,
			headerAttributes: {
			  style: "white-space: normal"
			}
		  },
		  {
			field: "LegacyId",
			title: "Securimate Id",
			width: "180px",
			locked: false,
		  },
		  {
			field: "ProfileCompanyName",
			title: "Company",
			width: "200px",
			locked: false,
		  },
		  {
			field: "CompanyId",
			title: "Profile #",
			width: "150px",
			locked: false,
		  },
		  {
			field: "RiskRank",
			title: "Risk Rank",
			hidden: false,
			width: "200px"
		  },
		  {
			field: "RequestedBy",
			title: "Requested By",
			hidden: false,
			width: "200px"
		  },
		  {
			field: "BusinessContact",
			title: "Contact Email",
			hidden: false,
			width: "200px",
			template: function(d) {
			  if (!d)
				return "";

			  var res = JSON.parse(d.BusinessContact);
			  if (res && res.length > 0 && res[0].Email)
				return res[0].Email;

			  return '';
			}
		  },
		  /*{
                          field: "Country",
                          title: "Country",
                          hidden: false,
                          width: "180px",
                          template: function(d) {
                            var res = "";

                            if(d.City)
                              res += d.City + ", ";

                            if(d.State)
                              res += d.State + ", ";

                            if(d.Address1)
                              res += d.Address1 + ", ";

                            return res || "";
                          }
                        },  */
		  {
			field: "Region",
			title: "Region",
			hidden: false,
			width: "150px"
		  },
		  {
			field: "Address1",
			title: "Address 1",
			hidden: false,
			width: "180px"
		  },
		  /* {
                  field: "Expiry",
                  title: "Expiry",
                  hidden: false,
                  width: "150px",
                  template: function(d) {
                    return util.getDate(d.Expiry)
                  }
                },*/
		  {
			field: "Created",
			title: "Created",
			hidden: false,
			width: "150px",
			template: function(d) {
			  return util.getDate(d.Created)
			}
		  },
		  {
			title: "",
			width: "100px",
			locked: true,
			hidden: false,
			attributes: {
			  "class": "cta"
			},
			template: function(d) {
			  var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
				  '<a class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
			  return icons;
			}
		  }
		];
		return cusConfig;
	  },
	  _default: function() {
		var defConfig = [];
		var keys = Object.keys(search.data[0]);
		for (i = 0; i < keys.length; i++) {
		  var key = keys[i];
		  var obj = {};
		  obj.field = key;
		  obj.title = key;
		  obj.hidden = false;
		  obj.filterable = true;
		  obj.width = "250px";
		  obj.attributes = {
			style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
		  };
		  if (key == "en_US")
			defConfig.unshift(obj);
		  else
			defConfig.push(obj);
		}
		return defConfig;
	  },
	  _load: function(selector, datasource, config, toolbar, invitation_data, node) {
		util.kendoGrid.addDateFieldsToSchema(datasource, ["Expiry", "Created"]);

		$(selector).kendoGrid({
		  height: 500,
		  /* toolbar: [{
                        name: "excel",
                        text: "Export Excel"
                      }],
                      excel: {
                        fileName: "Case" + util.getDate((new Date()).toISOString()) + ".xlsx", 
                        filterable: true,
                        allPages: true
                      },*/
		  noRecords: {
			template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
		  },
		  //excelExport: util.exportExcel,
		  dataSource: datasource,
		  columns: config,
		  dataBound: function(e) {},
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  resizable: true,
		  dataBound: util.kendoGrid.dataBound,
		  filter: util.kendoGrid.filter
		});

		util.buildFilterCombobox($(selector), "Region", ["APJ", "EMEA", "AMS"]);
		util.buildFilterCombobox($(selector), "ConfigName", {
		  dataset: "ARK_ConfigNames",
		  form: "1279",
		  dataTextField: "ConfigName",
		  dataValueField: "ConfigName",
		  filter: [
			{ field: "Status", operator: "eq", value: 1 },
			{ field: "Application", operator: "eq", value: "ARK" },
		  ],
		});
		util.buildFilterCombobox($(selector), "Status", {
		  dataset: [
			{ text: "Sent", value: "1" },
			{ text: "Submitted", value: "2" },
			{ text: "Expired", value: "3" },
			{ text: "Passed", value: "4" },
			{ text: "Denied", value: "5" },
			{ text: "Closed", value: "6" },
		  ],
		  dataTextField: "text",
		  dataValueField: "value",
		});
		util.buildFilterCombobox($(selector), "RiskRank", ['High', 'High Touch', 'Low Pass', 'Low Touch', 'Medium High', 'Medium High Touch', 'Medium Pass', 'Medium Touch', 'No DDQ submitted', 'Not Available']);

		$(selector).delegate('.view_invitation', 'click', function(ev) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  invitation.invitationOverview.init(row.EntryId);
		});

		$(selector).delegate('.myInv-company_details', 'click', function(ev) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));


		  myInvitations.viewCompany(row.CompanyFK);
		});

		node.querySelector('.excel-button').addEventListener("click", function(e) {
		  var grid = $(selector).data("kendoGrid");
		  reporting.exportReport("ARK_Overview_Joined",
								 1284,
								 JSON.stringify(grid.columns.map(({
			field,
			title
		  }) => ({
			field,
			title
		  })).filter(x => x.field)),
								 JSON.stringify(grid.dataSource.sort()),
								 JSON.stringify(grid.dataSource.filter()),
								 ("Cases_" + util.getDate((new Date()).toISOString(), true))

								);
		});

	  }
	},
	viewCompany: function(id, holder) {
	  singleCompanyDetails.init(id, holder);
	}
  }
</script>

<!--SINGLE COMPANY DETAILS -->
<script>
  const singleCompanyDetails = {
	holder: function() {
	  return document.querySelector('#navigation #company-details:last-child')
	},
	html: function(company) {
	  return "<div id='company-details' data-id='" + (company ? company : "") + "'>" +
		"<section class='company_info'></section>" +
		"<section class='s_grid'><div class='single-company-grid'></div></section>" +
		"</div>";
	},
	init: function(company, isUpdate, callback) {
	  if (!isUpdate) {
		navigation.push(singleCompanyDetails.html(company), singleCompanyDetails.openFromBackButton);

		recentlyViewed.add({
		  Module: 'Profile',
		  Id: company,
		}, function() {});
	  }

	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });

	  companyAPI2.companyOverview(company, function(d) {

		singleCompanyDetails.company = d.company || company;
		singleCompanyDetails.overviewData = d || {};

		//singleCompanyDetails.grid._load(singleCompanyDetails.holder().querySelector('.s_grid'), d.data, singleCompanyDetails._columns());
		singleCompanyDetails.configListener(singleCompanyDetails.holder().querySelector('.s_grid'), company, function(data) {
		  singleCompanyDetails.overview = data;

		  invitationDetails.init(singleCompanyDetails.overview, singleCompanyDetails.company);

		});

		var cases = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Company_Cases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			}
		  },
		  serverPaging: true,
		  pageSize: 50,
		  serverFiltering: true,
		  filter: {
			field: "CompanyFK",
			operator: "eq",
			value: singleCompanyDetails.company.EntryId
		  },
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }
		});

		cases.read().then(function() {

		  var view = cases.view();

		  singleCompanyDetails.overviewData.Cases = view;

		  if (view.find(x => x.Status == 1)) {
			singleCompanyDetails.overviewData.ActiveInvitations = true;
		  }

		  var finishedCase = view.find(x => x.Status == 4 || x.Status == 5);
		  if (finishedCase) {
			singleCompanyDetails.overviewData.LastCase = finishedCase.toJSON();
		  }

		  singleCompanyDetails.template(d.company, singleCompanyDetails.holder().querySelector('.company_info'));

		  //Check MDM Database by PartyId
		  singleCompanyDetails.mdmPartyIdCompare.init(singleCompanyDetails.company.PartyId);

		  mo.fn.overlay.hide();

		  if (callback)
			callback();
		});

	  });
	},
	openFromBackButton: function() {
	  if (singleCompanyDetails.company && singleCompanyDetails.company.EntryId)
		singleCompanyDetails.init(singleCompanyDetails.company.EntryId, true);
	},
	template: function(company, node) {

	  var profileId = company.EntryId;
	  var cases = singleCompanyDetails.overviewData.Cases;
	  var riskRank = "N/A";
	  if (cases) {
		var lastCase = cases.find(x => x.Status == 4 || x.Status == 5 || x.Status == 2 && x.RiskRank);
		if (lastCase)
		  riskRank = lastCase.RiskRank;
	  }

	  var statusCaption = "N/A";
	  if (company.Status)
		statusCaption = company.Status + " (" + company.StatusReason + ")";

	  let statusIcon = '';
	  switch (company.Status) {
		case 'Pending':
		  statusIcon = `<div class="status-icon"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="clock" width="25px" height="25px">
<path fill="none" stroke="#ffe100" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M12,5 L12,12 L17,12">
  </path>
  </svg></div>`;
		  break;
		case 'Denied':
		  statusIcon = `<div class="status-icon"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="clear" width="25px" height="25px">
<path fill="none" stroke="#ff0000" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M5,5 L19,19">
  </path>
  </svg></div>`;
		  break;
		case 'Approved':
		  statusIcon = `<div class="status-icon"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="validate" width="25px" height="25px">
<path fill="none" stroke="#008000" stroke-width="2" d="M20,15 C19,16 21.25,18.75 20,20 C18.75,21.25 16,19 15,20 C14,21 13.5,23 12,23 C10.5,23 10,21 9,20 C8,19 5.25,21.25 4,20 C2.75,18.75 5,16 4,15 C3,14 1,13.5 1,12 C1,10.5 3,10 4,9 C5,8 2.75,5.25 4,4 C5.25,2.75 8,5 9,4 C10,3 10.5,1 12,1 C13.5,1 14,3 15,4 C16,5 18.75,2.75 20,4 C21.25,5.25 19,8 20,9 C21,10 23,10.5 23,12 C23,13.5 21,14 20,15 Z M7,12 L10,15 L17,8">
  </path>
  </svg></div>`;
		  break;
	  }

	  node.innerHTML = '<section class="wrapper headerInfo">' +
		'<div class="container">' +
		'<div tab-id="application" class="nbsf active" data-step="step-1" data-step-name="Company info"">' +
		`${!access.user.UserRole.Readonly ?
		`<div class="button-group company-refresh" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="refresh" width="128px" height="128px">
<path fill="none" stroke="#666" stroke-width="2" d="M20,8 C18.5974037,5.04031171 15.536972,3 12,3 C7.02943725,3 3,7.02943725 3,12 C3,16.9705627 7.02943725,21 12,21 L12,21 C16.9705627,21 21,16.9705627 21,12 M21,3 L21,9 L15,9">
  </path>
  </svg><span>Refresh</span>
  </div>` +
		`<div class="button-group update-approval" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="shield security" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M12,22 C12,22 2.99999999,18 3,11 L3,5 L12,2 L21,5 C21,5 21,11 21,11 C21,18 12,22 12,22 Z M12,14 C13.6568542,14 15,12.6568542 15,11 C15,9.34314575 13.6568542,8 12,8 C10.3431458,8 9,9.34314575 9,11 C9,12.6568542 10.3431458,14 12,14 Z M12,8 L12,5 M12,17 L12,14 M6,11 L9,11 M15,11 L18,11 M8,7 L10,9 M14,13 L16,15 M16,7 L14,9 M10,13 L8,15"></path></svg><span>Status</span>
  </div>` +


		`<div class="button-group merge-profiles"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="iteration" width="128px" height="128px">
<path fill="none" stroke="#666" stroke-width="2" d="M1,9 L1,23 L15,23 M5,5 L5,19 L19,19 M9,15 L23,15 L23,1 L9,1 L9,15 L9,15 L9,15 Z">
  </path>
  </svg><span>Merge</span>
  </div>` +


		`<div class="button-group company-send-invitation" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="mail" width="128px" height="128px">
<path fill="none" stroke="#666" stroke-width="2" d="M1,5 L12,14 L23,5 M1,20 L23,20 L23,4 L1,4 L1,20 L1,20 Z">
  </path>
  </svg><span>Invite</span>
  </div>` : '' }` +
		'<div class="profile-header" style="border-bottom: 1px solid #333;padding-bottom: 20px;margin-bottom: 40px;">' +
		`<div class="profile-icon profile-icon-${company.Status ? company.Status : 'none'} ${company.IsActive === 'N' ? 'profile-icon-inactive' : ''}">` +
		`<svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="35px" height="35px">
<path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21">
  </path>
  </svg>` +
		'</div>' +
		statusIcon +
		'<div class="profile-company-data">' +
		'<h3 style="text-transform:none; font-family:Helvetica !important;">Profile # ' + profileId + ":  " + company.CompanyName + ' </h3>' +
		'<div class="header-row"><div class="caption">' + "Securimate Id: " + '</div><div class="value">' + (company.LegacyId || "N/A") + '</div></div>' +
		'<div class="header-row"><div class="caption">' + "English Company Name: " + '</div><div class="value">' + (company.EnglishCompanyName || "N/A") + '</div></div>' +
		'<div class="header-row"><div class="caption">' + "Alternate Trade Name(s): " + '</div><div class="value">' + (company.TradingCompanyName || "N/A") + '</div></div>' +
		'<div class="header-row"><div class="caption">' + "City: " + '</div><div class="value">' + (company.City || "N/A") + '</div></div>' +
		'<div class="header-row"><div class="caption">' + "Country: " + '</div><div class="value">' + (reference.convertCountry(company.Country) || "N/A") + '</div></div>' +
		'<div class="header-row"><div class="caption">' + "Region: " + '</div><div class="value">' + (company.Region || "N/A") + '</div></div>' +
		'<div class="header-row status" style="cursor:pointer;"><div class="caption">' + "Approval Status: " + '</div><div class="value">' + statusCaption + '</div></div>' +
		'<div class="header-row"><div class="caption">' + "Risk Rating: " + '</div><div class="value">' + (riskRank || "N/A") + '</div></div>' +
		'</div>' +
		'</div>' +
		'<section class="compInfBySections"></section>' +
		'</div>' +
		'</div>' +
		'</section>';

	  //Sumit asked to remove this logic 15.03.22
	  //if(company.InternalOwner != access.user.Email)
	  //node.querySelector(".company-send-invitation").style.display = "none";


	  var statusNode = node.querySelector(".status");
	  if (statusNode) {
		statusNode.addEventListener("click", singleCompanyDetails.editStatus);
		if (node.querySelector(".update-approval")) node.querySelector(".update-approval").addEventListener("click", singleCompanyDetails.editStatus);
	  }
	  if (node.querySelector(".company-refresh")) {
		node.querySelector(".company-refresh").addEventListener("click", function() {
		  singleCompanyDetails.init(singleCompanyDetails.company.EntryId, true);
		});
	  }
	  if (node.querySelector(".merge-profiles")) {
		node.querySelector(".merge-profiles").addEventListener("click", function() {
		  singleCompanyDetails.mergeProfiles.init(singleCompanyDetails.company.EntryId);
		});
	  }


	  hpe.ui.tabs({
		dom: node.querySelector('.compInfBySections'),
		tabs: [{
		  label: "Company details",
		  id: "company_details"
		},
			   {
				 label: "Due Diligence",
				 id: "cases"
			   },
			   {
				 label: "Connections",
				 id: "association"
			   },
			   {
				 label: "Attachments",
				 id: "documents"
			   },
			   {
				 label: "Notes",
				 id: "notes"
			   },
			   {
				 label: "Custom Fields",
				 id: "custom_fields"
			   },
			   {
				 label: "Audit Log",
				 id: "audit"
			   }
			  ]
	  }, function(all) {

		var companyInfo = company;

		var state = company.State;
		if (state) {
		  var countryInfo = reference.states.data.find(x => x.ISO2 == companyInfo.Country);
		  if (countryInfo) {
			var states = JSON.parse(countryInfo.Districts);
			stateInfo = states.find(x => x.code == state);
			if (stateInfo)
			  state = stateInfo.name;
		  }
		}


		all[0].innerHTML =
		  '<div class="row--left">' +
		  '<h5>COMPANY DETAILS</h5>' +
		  '<div class="item"><span>Official Company Name:</span>' +
		  ' <p class="prr mdm-alternate-name">' + (companyInfo.CompanyName || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>English Company Name:</span>' +
		  ' <p class="prr">' + (companyInfo.EnglishCompanyName || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Alternate Trade Name(s):</span>' +
		  ' <p class="prr">' + (companyInfo.TradingCompanyName || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Legal Form of Company:</span>' +
		  ' <p class="prr">' + (companyInfo.LegalFormOfCompany || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Years in Business:</span>' +
		  ' <p class="prr">' + (companyInfo.NumberOfYearsInPrimaryBusiness || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Country of Registration:</span>' +
		  ' <p class="prr mdm-country-code">' + (reference.convertCountry(companyInfo.CountryOfRegistration) || 'N/A') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Tax ID / Business Registration Id:</span>' +
		  ' <p class="prr mdm-tax-reg">' + (companyInfo.TaxId || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Company Website:</span>' +
		  ' <p class="prr mdm-websites">' + (companyInfo.Website || '-') + '</p>' +
		  '</div>' +
		  '<div class="item mdm-phone-fax"><span>Company Telephone:</span>' +
		  ' <p class="prr">' + (companyInfo.CompanyTelephone || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Publicly Traded Company:</span>' +
		  ' <p class="prr">' + ((companyInfo.PublicyTradedCompany == 'Y' ? 'Yes' : 'No') || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Stock Exchange:</span>' +
		  ' <p class="prr">' + (companyInfo.StockExchange || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Ticker Symbol:</span>' +
		  ' <p class="prr">' + (companyInfo.TickerSymbol || '-') + '</p>' +
		  '</div>' +
		  '<h5 class="mdm-address">LEGAL ADDRESS</h5>' +
		  '<div class="item"><span>Address 1:</span>' +
		  ' <p class="prr">' + (companyInfo.Address1 || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Address 2:</span>' +
		  ' <p class="prr">' + (companyInfo.Address2 || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>City:</span>' +
		  ' <p class="prr">' + (companyInfo.City || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Country:</span>' +
		  ' <p class="prr">' + (reference.convertCountry(companyInfo.Country) || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>State/Province:</span>' +
		  ' <p class="prr">' + (state || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Postcode:</span>' +
		  ' <p class="prr">' + (companyInfo.PostCode || '-') + '</p>' +
		  '</div>' +
		  '<h5>PHYSICAL ADDRESS</h5>' +
		  '<div class="item"><span>Physical Address 1:</span>' +
		  ' <p class="prr">' + (companyInfo.PhysAddress1 || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Physical Address 2:</span>' +
		  ' <p class="prr">' + (companyInfo.PhysAddress2 || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Physical City:</span>' +
		  ' <p class="prr">' + (companyInfo.PhysCity || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Physical Postcode:</span>' +
		  ' <p class="prr">' + (companyInfo.PhysPostCode || '-') + '</p>' +
		  '</div>' +
		  '</div>' +
		  '<div class ="row--right">' +
		  '<h5>PROFILE META INFORMATION</h5>' +
		  '<div class="item"><span>Siebel ID:</span>' +
		  ' <p class="prr">' + (companyInfo.SiebelID || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Party ID:</span>' +
		  ' <p class="prr">' + (companyInfo.PartyId || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Internal Owner:</span>' +
		  ' <p class="prr">' + (companyInfo.InternalOwner || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Profile is Active?</span>' +
		  ' <p class="prr">' + (companyInfo.IsActive == "Y" ? "Yes" : (companyInfo.IsActive == "N" ? "No" : '-')) + '</p>' +
		  '</div>' +

		  '<div class="item"><span>Category:</span>' +
		  ' <p class="prr">' + (companyInfo.Category || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Intake Form:</span>' +
		  ' <p class="prr">' + (companyInfo.IntakeForm ? reference.configs.data.find(x => x.ConfigId == companyInfo.IntakeForm).ConfigName : "-") + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Language:</span>' +
		  ' <p class="prr">' + (companyInfo.Language ? reference.languages.data.find(x => x.value == companyInfo.Language).option : "-") + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Region:</span>' +
		  ' <p class="prr">' + (companyInfo.Region || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span> </span>' +
		  ' <p class="prr"> </p>' +
		  '</div>' +
		  '<div class="item"><span> </span>' +
		  ' <p class="prr"> </p>' +
		  '</div>' +
		  '<div class="item"><span> </span>' +
		  ' <p class="prr"> </p>' +
		  '</div>' +
		  '<div class="item"><span> </span>' +
		  ' <p class="prr"> </p>' +
		  '</div>' +
		  '<h5>MAIN POINT OF CONTACT</h5>' +
		  '<div class="item"><span>Name:</span>' +
		  ' <p class="prr">' + (companyInfo.Name || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Position:</span>' +
		  ' <p class="prr">' + (companyInfo.Position || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Email Address:</span>' +
		  ' <p class="prr">' + (companyInfo.EmailAddress || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Telephone:</span>' +
		  ' <p class="prr">' + (companyInfo.Telephone || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Alt. Telephone:</span>' +
		  ' <p class="prr">' + (companyInfo.AltTelephone || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>Mobile:</span>' +
		  ' <p class="prr">' + (companyInfo.Mobile || '-') + '</p>' +
		  '</div>' +
		  '<div class="item"><span>FAX:</span>' +
		  ' <p class="prr">' + (companyInfo.FAX || '-') + '</p>' +
		  '</div>' +
		  '</div>' +

		  (access.user.UserRole.ADMIN ? ('<h5>SETTINGS</h5>' +
										 '<div class="item"><span>Hide 95% checkbox:</span>' +
										 ' <p class="prr">' + (companyInfo.HideDDQShareQuestion == 1 ? 'Yes' : 'No') + '</p>' +
										 '</div>' +
										 '<div class="item"><span>Hide Key personnel confirmation checkbox:</span>' +
										 ' <p class="prr">' + (companyInfo.HideDDQKeyPersonalConfirmation == 1 ? 'Yes' : 'No') + '</p>' +
										 '</div>' +
										 '</div>') : '') +

		  '<div class="cfix"></div>';


		//if(company.PartyId)
		//all[0].innerHTML +='<a class=" k-button k-button-big company-details-det" style="margin-top:30px; margin-right:40px; float: right" href="#"  >EMDM Details</a>'

		if (!access.user.UserRole.Readonly) all[0].innerHTML += '<a class=" k-button k-button-big company-change" style="margin-top: 30px; margin-right:20px; float: right" href="#"  >Change profile</a>'

		all[0].innerHTML += ' </div>';


		if (singleCompanyDetails.holder().querySelector('.company-details-det'))
		  singleCompanyDetails.holder().querySelector('.company-details-det').addEventListener('click', function() {
			partyIdDetails.init(singleCompanyDetails.company.PartyId);
		  });

		if (singleCompanyDetails.holder().querySelector('.company-change'))
		  singleCompanyDetails.holder().querySelector('.company-change').addEventListener('click', function() {
			singleCompanyDetails.oldCompanyObj = JSON.parse(JSON.stringify(company));
			companyModal.init(company, function(data) {
			  singleCompanyDetails.init(company.EntryId, true);
			  singleCompanyDetails.addAuditLog("Profile changed", util.getDifference(singleCompanyDetails.oldCompanyObj, data, companyModal.config()), util.Email());
			});
		  });

		if (singleCompanyDetails.holder().querySelector('.company-send-invitation'))
		  singleCompanyDetails.holder().querySelector('.company-send-invitation').addEventListener('click', function() {

			var error = "";
			if (!companyInfo.Language)
			  error = "There is no <b>Language</b> specified for this profile. Please select a Language."


			if (!companyInfo.IntakeForm)
			  error = "There is no <b>Intake form</b> specified for this profile. Please select an Intake form."


			if (!companyInfo.EmailAddress)
			  error = "There is no <b>Email</b> specified for this profile. Please select a email."


			if (!companyInfo.Name)
			  error = "There is no <b>Name</b> specified for the main point of contact. Please provide a name."


			if (!companyInfo.Region)
			  error = "There is no <b>Region</b> specified for this profile. Please select a region."


			if (!companyInfo.Country)
			  error = "There is no <b>Country</b> specified for this profile. Please select a country."


			if (error)
			  mo.fn.modal.show({
				ctaLabel: "OK",
				title: "Error",
				class: "ark-modal",
				content: error,
			  });
			else {

			  function sendInvitation() {

				mo.fn.overlay.show({
				  close: false,
				  loading: true
				});

				$.ajax({
				  type: 'GET',
				  url: globalReferences.server + 'resources/rs/custom/php/ark/invite.php?pid=' + company.EntryId,
				  success: function(response) {
					mo.fn.overlay.hide()
					var data = JSON.parse(response);
					if (!data.Success) {
					  mo.fn.modal.show({
						ctaLabel: "OK",
						title: "Error",
						class: "ark-modal",
						content: data.Message,
					  });
					  return;
					}

					var data = JSON.parse(data.Message);

					if (data.InvitationId) {

					  singleCompanyDetails.init(company.EntryId, true, function() {
						singleCompanyDetails.holder().querySelector('[tab-id="cases"]').click();

						if (data.Type == "Create") {
						  singleCompanyDetails.addAuditLog("Invitation",
														   'ID: ' + "'" + data.InvitationId + "'",
														   util.Email());



						  invitation.invitationOverview.addAuditLog("Case created (Invitation sent)",
																	util.getAuditString('ID', null, data.InvitationId),
																	util.Email(),
																	null,
																	data.InvitationId
																   );
						} else if (data.Type == "Update") {

						  singleCompanyDetails.addAuditLog("Invitation updated",
														   'ID: ' + "'" + data.InvitationId + "'",
														   util.Email());



						  invitation.updateDDQOnResend(data.InvitationId, singleCompanyDetails.company, Number(singleCompanyDetails.company.ConfigFK), function(result) {
							if (result !== null) {
							  invitation.invitationOverview.addAuditLog("Case updated (Invitation resent)",
																		util.getDifference({ ...data.OldInvitation,
																							...result.oldObj
																						   }, { ...data.NewInvitation,
																							   ...result.newObj
																							  }, null, true),
																		util.Email(),
																		null,
																		data.InvitationId
																	   );
							} else {
							  invitation.invitationOverview.addAuditLog("Case updated (Invitation resent)",
																		util.getDifference(data.OldInvitation, data.NewInvitation, null, true),
																		util.Email(),
																		null,
																		data.InvitationId
																	   );
							}
						  });
						}

					  });

					} else {
					  mo.fn.overlay.hide();
					  mo.fn.modal.show({
						ctaLabel: "OK",
						title: "Error",
						class: "ark-modal",
						content: "Unknown error",
					  });
					}



				  },
				  error: function() {
					mo.fn.overlay.hide();
					mo.fn.modal.show({
					  ctaLabel: "OK",
					  title: "Error",
					  class: "ark-modal",
					  content: "Couldn't send invitaiton",
					});
				  }
				});

			  }


			  function onInvitationSending() {
				var activeInvite = false;
				var cases = singleCompanyDetails.overviewData.Cases;
				if (cases) activeInvite = cases.find(x => x.ConfigId == companyInfo.IntakeForm && (x.Status == 1 || x.Status == 2)) != undefined;

				if (activeInvite) {
				  error = "This profile already has an active invitation for this intake form: " + reference.configs.data.find(x => x.ConfigId == companyInfo.IntakeForm).ConfigName + ". Are you sure you want to update the invitation or send another invitation?";
				  mo.fn.modal.show({
					ctaLabel: "OK",
					close: true,
					closeLabel: "Close",
					title: "Warning",
					class: "ark-modal",
					content: "<p>" + error + "</p>",
					ctaCallback: function() {
					  mo.fn.modal.hide();
					  sendInvitation();
					}
				  });
				} else {
				  mo.fn.modal.show({
					ctaLabel: "OK",
					close: true,
					closeLabel: "Close",
					title: "Send Invitation",
					class: "ark-modal",
					content: "<p>You are about to send an invitation. Continue?" + "</p>",
					ctaCallback: function() {
					  mo.fn.modal.hide();
					  sendInvitation();
					}
				  });
				}
			  }

			  util.checkEmailTemplate(singleCompanyDetails.company.ConfigFK, singleCompanyDetails.company.Language, function() {
				onInvitationSending();
			  });

			}

		  });


		singleCompanyDetails.holder().querySelector('[tab-id="cases"]').addEventListener('click', function() {
		  singleCompanyDetails.initCasesGrid(company, all[1]);
		});


		singleCompanyDetails.holder().querySelector('.tabs [tab-id="association"]').style.display = "none";
		singleCompanyDetails.holder().querySelector('[tab-id="association"]').addEventListener('click', function() {
		  singleCompanyDetails.initAssociationTab(company, all[2]);
		});


		singleCompanyDetails.holder().querySelector('[tab-id="documents"]').addEventListener('click', function() {
		  singleCompanyDetails.initDocumentsTab(company, all[3]);
		});


		singleCompanyDetails.holder().querySelector('[tab-id="notes"]').addEventListener('click', function() {
		  singleCompanyDetails.initNotesTab(company, all[4]);
		});

		//singleCompanyDetails.holder().querySelector('[tab-id="custom_fields"]').style.display = "none";
		singleCompanyDetails.holder().querySelector('[tab-id="custom_fields"]').addEventListener('click', function() {
		  singleCompanyDetails.customFields.init(company, all[5]);
		});

		singleCompanyDetails.holder().querySelector('[tab-id="audit"]').addEventListener('click', function() {
		  singleCompanyDetails.initAuditTab(company, all[6]);
		});



	  });

	},
	_columns: function() {
	  var cusConfig = [{
		field: "ConfigName",
		title: "Name",
		hidden: false,
		locked: true,
		width: "300px"
	  },
					   {
						 field: "Invitations",
						 title: "Invitations",
						 hidden: false,
						 width: "150px"
					   },
					   {
						 field: "LastActionDate",
						 title: "Last Update",
						 hidden: false,
						 width: "150px",
						 template: function(d) {
						   if (d.LastActionDate) return util.getDate(d.LastActionDate);
						   else return 'N/A'
						 }
					   },
					   {
						 field: "ActiveInvitations",
						 title: "Active invitations",
						 hidden: false,
						 width: "140px",
						 headerAttributes: {
						   style: "white-space: normal"
						 },
						 template: function(d) {
						   return d.ActiveInvitations == true ? 'Yes' : 'No'
						 }
					   },
					   {
						 field: "Status",
						 title: "Status",
						 hidden: false,
						 width: "150px",
						 template: function(d) {
						   return invitation.manageStatus(d.Status);
						 }
					   },
					   {
						 field: "Score",
						 title: "Score",
						 hidden: false,
						 width: "150px"
					   },
					   {
						 field: "RiskRank",
						 title: "Risk Rank",
						 hidden: false,
						 width: "250px"
					   },
					   {
						 title: "",
						 width: "75px",
						 locked: true,
						 hidden: false,
						 attributes: {
						   "class": "cta"
						 },
						 template: function(d) {
						   var icons = '<a class="invite_company"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
						   return icons;
						 }
					   }
					  ];
	  return cusConfig;
	},
	grid: {
	  _default: function() {
		var defConfig = [];
		//console.log(search.data);
		var keys = Object.keys(search.data[0]);

		for (i = 0; i < keys.length; i++) {
		  var key = keys[i];
		  var obj = {};
		  obj.field = key;
		  obj.title = key;
		  obj.hidden = false;
		  obj.filterable = true;
		  obj.width = "250px";
		  obj.attributes = {
			style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
		  };
		  if (key == "en_US")
			defConfig.unshift(obj);
		  else
			defConfig.push(obj);
		}
		return defConfig;
	  },
	  _load: function(selector, datasource, config, toolbar, invitation_data) {
		$(selector).kendoGrid({
		  height: 800,
		  noRecords: {
			template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
		  },
		  dataSource: datasource,
		  columns: config,
		  dataBound: function(e) {},
		  pageable: {
			buttonCount: 4,
			pageSize: 25,
			pageSizes: [25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true
		});


	  }
	},
	configListener: function(selector, data, callback) {
	  $(selector).delegate(".invite_company", "click", function(e) {
		var arr = [];
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		search.overview = row;
		if (typeof callback == 'function') {
		  callback(row);
		}
	  });
	},
	sendInvitation: {
	  _config: null,
	  _filter: null,
	  localization: [{
		value: 'es_ES',
		option: 'Spanish'
	  },
					 {
					   value: 'cz_CH',
					   option: 'Czech'
					 },
					 {
					   value: 'de_DE',
					   option: 'German'
					 },
					 {
					   value: 'en_US',
					   option: 'English (US)'
					 },
					 {
					   value: 'es_MX',
					   option: 'LAR Spanish'
					 },
					 {
					   value: 'fr_FR',
					   option: 'French'
					 },
					 {
					   value: 'in_ID',
					   option: 'Indonesian'
					 },
					 {
					   value: 'it_IT',
					   option: 'Italian'
					 },
					 {
					   value: 'hu_HU',
					   option: 'Hungarian'
					 },
					 {
					   value: 'pl_PL',
					   option: 'Polish'
					 },
					 {
					   value: 'pt_PT',
					   option: 'Portuguese'
					 },
					 {
					   value: 'pt_BR',
					   option: 'Portuguese (Brazil)'
					 },
					 {
					   value: 'fr_CA',
					   option: 'French (Canada)'
					 },
					 {
					   value: 'ro_RO',
					   option: 'Romanian'
					 },
					 {
					   value: 'sk_SK',
					   option: 'Slovak'
					 },
					 {
					   value: 'tr_TR',
					   option: 'Turkish'
					 },
					 {
					   value: 'vi_VN',
					   option: 'Vietnamese'
					 },

					 {
					   value: 'gr_GR',
					   option: 'Greek'
					 },

					 {
					   value: 'ru_RU',
					   option: 'Russian'
					 },
					 {
					   value: 'he_IL',
					   option: 'Hebrew'
					 },
					 {
					   value: 'ar_AE',
					   option: 'Arabic'
					 },
					 {
					   value: 'th_TH',
					   option: 'Thai'
					 },
					 {
					   value: 'zh_CN',
					   option: 'Chinese (simplified)'
					 },
					 {
					   value: 'zh_TW',
					   option: 'Chinese (traditional)'
					 },
					 {
					   value: 'ja_JP',
					   option: 'Japanese'
					 },
					 {
					   value: 'ko_KR',
					   option: 'Korean'
					 }
					],
	  init: function() {

		mo.fn.modal.show({
		  ctaLabel: "Send",
		  class: "ark-modal",
		  title: "Send new invitation",
		  content: '<div class="send_invitation" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');
			singleCompanyDetails.sendInvitation._config = singleCompanyDetails.sendInvitation.config();


			var data = singleCompanyDetails.company;
			data.ConfigName = singleCompanyDetails.overview.ConfigName;
			data.ConfigId = singleCompanyDetails.overview.ConfigId;
			singleCompanyDetails.sendInvitation._config.dataset = data;
			nbsf.init(singleCompanyDetails.sendInvitation._config, 0);
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
		  },
		  ctaCallback: function() {
			singleCompanyDetails.sendInvitation.create(singleCompanyDetails.sendInvitation._config.dataset);
		  }
		});
	  },
	  config: function() {
		return {
		  dom: document.querySelector('div[class="send_invitation"]'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Company Name:",
				  data: "CompanyName",
				  disabled: true,
				  type: "text",
				  validation: ["minLen|1", "maxLen|100"],
				},
				 {
				   label: "Tax ID:",
				   data: "TaxId",
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 },
				 {
				   label: "Party ID:",
				   data: "PartyId",
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 },
				 {
				   label: "Country ID:",
				   data: "CountryEntity",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 },
				 {
				   label: "Country:",
				   data: "Country",
				   type: "select",
				   validation: ["inArray"],
				   options: reference.countries.options(),
				   values: reference.countries.values()
				 },
				 { //config name pass the config id
				   label: "Intake Form:",
				   data: "ConfigName",
				   type: "text",
				   validation: ["minLen|1", "maxLen|100"],
				 }

				]
			  ]
			},
						{
						  group: [
							[{
							  label: "Localization:",
							  data: "Localization",
							  type: "select",
							  required: true,
							  value: 'en_US',
							  validation: ["inArray"],
							  options: singleCompanyDetails.sendInvitation.localization.map(el => el.option),
							  values: singleCompanyDetails.sendInvitation.localization.map(el => el.value)
							},

							]
						  ]
						},
						{
						  repeatable: "BusinessContacts",
						  repeatableLimit: 10,
						  header: 'Business Contacts',
						  group: [
							[{
							  label: "First Name:",
							  data: "FirstName",
							  required: true,
							  value: null,

							  type: "text",
							  validation: ["minLen|1", "maxLen|100"],
							},
							 {
							   label: "Last Name:",
							   data: "LastName",
							   required: true,
							   value: null,
							   type: "text",
							   validation: ["minLen|1", "maxLen|100"],
							 },
							 {
							   label: "Email:",
							   data: "Email",
							   required: true,
							   value: null,
							   type: "text",
							   validation: ["minLen|1", "maxLen|100"],
							 }
							]
						  ],
						  callback: function() {


						  },
						}
					   ],
			callback: function() {
			  var firstGroup = document.querySelector('.dxpModalContent .send_invitation .row');
			  Array.from(firstGroup.querySelectorAll('input, select')).forEach(function(el) {
				el.disabled = true;
			  });

			  Array.from(document.querySelectorAll('[data-rname="BusinessContacts"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.text')).forEach(function(d, index) {
				  if (index < 2) {
					d.style.display = 'inline-block';
					d.style.width = '181px';
				  }
				});
			  });

			},
		  }]
		};
	  },
	  create: function(data) {

		mo.fn.modal.lock();
		invitationAPI.send({
		  CompanyId: data.EntryId,
		  Country: data.Country,
		  TaxId: data.TaxId,
		  PartyId: data.PartyId,
		  CountryEntity: data.CountryEntity,
		  CompanyName: data.CompanyName,
		  ConfigName: data.ConfigName,
		  ConfigId: data.ConfigId,
		  BusinessContact: data.BusinessContacts,
		  Language: data.Localization
		},
						   access.user.Email,
						   function(d) {

		  if (d.error) {
			mo.fn.modal.msg('Please fill in all the mandatory fields.', 3);
			mo.fn.modal.unlock();
		  } else {

			mo.fn.modal.hide();
			mo.fn.modal.unlock();
			//Used to revert to the initial state
			navigation.stack.pop();
			navigation.back();
			navigation.stack.pop();
			navigation.back();

			singleCompanyDetails.init(singleCompanyDetails.company.EntryId, function() {
			  singleCompanyDetails.overview.ActiveInvitations = true;
			  invitationDetails.init(singleCompanyDetails.overview, singleCompanyDetails.company);
			});

		  }
		}
						  );
	  }
	},
	initHierarchyGrid: function(company, node) {

	  node.innerHTML = "<div class='company-hierarchy-grid'></div>";
	  var selector = node.querySelector(".company-hierarchy-grid");

	  var columns = [{
		field: "CompanyName",
		title: "Name",
		locked: true,
		hidden: false,
		width: "250px",
	  },
					 {
					   field: "TaxId",
					   title: "Tax ID",
					   hidden: true,
					   width: "150px"
					 },
					 {
					   field: "Country",
					   title: "Country",
					   hidden: false,
					   width: "200px",
					   template: function(d) {
						 return reference.convertCountry(d.Country);
					   }
					 },
					 {
					   field: "PartyId",
					   title: "Party id",
					   hidden: false,
					   locked: true,
					   width: "150px"
					 },
					 {
					   field: "Address",
					   title: "Address",
					   hidden: false,
					   width: "500px",
					   template: function(d) {
						 try {

						   var raw = JSON.parse(d.AddressObject);

						   var city = jstr(raw["cityName"]);
						   if (city) city += ", ";
						   var province = jstr(raw["stateProvinceCd"]);
						   if (province) province += ", ";
						   var district = jstr(raw["district"]);
						   if (district) district += ", ";
						   var county = jstr(raw["countyName"]);
						   if (county) county += ", ";
						   var adline1 = jstr(raw["addressLine1"]);
						   if (adline1) adline1 += ", ";
						   var adline2 = jstr(raw["addressLine2"]);
						   if (adline2) adline2 += ", ";
						   var adline3 = jstr(raw["addressLine3"]);
						   if (adline3) adline3 += ", ";
						   var postal = jstr(raw["postalCode"]);
						   if (postal) postal += "";

						   return adline1 + adline2 + adline3 + city + district + county + province + postal;
						 } catch (e) {
						   return "";
						 }

					   }
					 },
					 {
					   title: "",
					   width: "85px",
					   hidden: false,
					   locked: true,
					   attributes: {
						 "class": "cta"
					   },
					   template: function(d) {
						 var icons = '<a class="multiple_companies"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
						 icons += '<a class="view_details" style="margin-left:5px;"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M1,2 L23,2 L23,9 L1,9 L1,2 Z M4,12 L5,12 L5,13 L4,13 L4,12 Z M4,5 L5,5 L5,6 L4,6 L4,5 Z M4,19 L5,19 L5,20 L4,20 L4,19 Z M1,16 L23,16 L23,23 L1,23 L1,16 Z M1,9 L23,9 L23,16 L1,16 L1,9 Z"></path></a>';

						 return icons;
					   }
					 }
					];

	  $(selector).kendoGrid({
		height: 500,
		dataSource: {
		  data: company.hierarchy,
		  group: {
			field: "TaxId"
		  }
		},
		columns: columns,
		pageable: {
		  buttonCount: 4,
		  pageSize: 10,
		  pageSizes: [10, 25, 50, 100],
		  messages: {
			itemsPerPage: ""
		  },
		  refresh: true
		},
		scrollable: true,
		sortable: true,
		filterable: true,
		groupable: false,
	  });

	  $(selector).delegate(".multiple_companies", "click", function(e) {

		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		multipleCompaniesDetails.viewCompany(row);
	  });

	  $(selector).delegate(".view_details", "click", function(e) {

		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		partyIdDetails.init(row.PartyId, row.RAW);
	  });

	},
	initCasesGrid: function(company, node) {
	  node.innerHTML = "<div class='company-cases-grid'></div>";
	  var selector = node.querySelector(".company-cases-grid");

	  var columns = [
		{
		  field: "EntryId",
		  title: "Id",
		  hidden: false,
		  width: "100px",
		  locked: true
		},
		{
		  field: "IntakeForm",
		  title: "Intake form",
		  hidden: false,
		  width: "200px",
		  locked: true,
		  headerAttributes: {
			style: "white-space: normal"
		  },
		  template: function(d) {
			return d.ConfigName || "";
		  }
		},
		{
		  field: "Status",
		  title: "Status",
		  hidden: false,
		  width: "150px",
		  template: function(d) {
			return invitation.manageStatus(d.Status);
		  }
		},
		{
		  field: "CloseCode",
		  title: "Pass/Fail",
		  hidden: false,
		  width: "150px"
		},
		{
		  field: "SentTS",
		  title: "Sent Date",
		  hidden: false,
		  width: "180px",
		  template: function(d) {
			return util.getDate(new Date(d.SentTS).toISOString())
		  }
		},
		{
		  field: "SubmittedTS",
		  title: "Submitted Date",
		  hidden: false,
		  width: "200px",
		  template: function(d) {
			if(!d.SubmittedTS)
			  return "";
			return util.getDate(new Date(d.SubmittedTS).toISOString()) || "";
		  }
		},
		{
		  field: "RiskRank",
		  title: "Risk Rank",
		  hidden: false,
		  width: "200px"
		},
		{
		  field: "RequestedBy",
		  title: "Requestor",
		  hidden: false,
		  width: "190px"
		},
		{
		  field: "SubmitterEmail",
		  title: "Submitter",
		  hidden: false,
		  width: "190px"
		},
		{
		  field: "Expiry",
		  title: "Expiry",
		  hidden: false,
		  width: "150px",
		  template: function(d) {
			return util.getDate(d.Expiry) || ""
		  }
		},
		{
		  title: "",
		  width: "75px",
		  locked: true,
		  hidden: false,
		  attributes: {
			"class": "cta"
		  },
		  template: function(d) {
			var icons = '<a class="view_details"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
			return icons;
		  }
		}
	  ];

	  $(selector).kendoGrid({
		height: 500,
		dataSource: new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Company_Cases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {
				SentTS: {type: "date"},
				SubmittedTS: {type: "date"},
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  filter: {
			field: "CompanyFK",
			operator: "eq",
			value: company.EntryId
		  },
		  serverSorting: true,
		  sort: [
			{
			  field: "EntryId",
			  dir: "desc"
			}
		  ]


		}),
		columns: columns,
		pageable: {
		  buttonCount: 4,
		  pageSize: 15,
		  pageSizes: [10, 25, 50, 100],
		  refresh: true
		},
		scrollable: true,
		sortable: {
		  mode: 'multiple'
		},
		filterable: true,
		groupable: false,
	  });


	  $(selector).delegate(".view_details", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		invitation.invitationOverview.init(row.EntryId);
	  });
	},
	initAssociationTab: function(company, node) {
	  node.innerHTML = "<div class='company-associations'></div>" +
		'<a class="k-button k-button-action company-add-association" style="margin-top: 30px; float: right; margin-left:15px;" href="#"  >Add Association</a>;';
	  var selector = node.querySelector(".company-associations");

	  node.querySelector(".company-add-association").addEventListener("click", function() {
		singleCompanyDetails.editAssociation();
	  });

	  var columns = [{
		field: "EntryId",
		title: "Id",
		hidden: false,
		width: "150px",
		locked: true
	  },
					 {
					   field: "Name",
					   title: "Name",
					   hidden: false,
					   width: "250px",
					   locked: true,
					   template: function(d) {
						 return d.FirstName + " " + d.LastName;
					   }
					 },
					 {
					   field: "Owner",
					   title: "Owner",
					   hidden: false,
					   width: "120px",
					   locked: true,
					   headerAttributes: {
						 style: "white-space: normal"
					   },
					   template: function(d) {
						 return util.getToggleValue(d.Owner);
					   }
					 },
					 {
					   field: "Type",
					   title: "Type",
					   hidden: false,
					   width: "150px",
					 },
					 {
					   field: "Position",
					   title: "Position",
					   hidden: false,
					   width: "250px"
					 },
					 {
					   field: "OwnershipPercent",
					   title: "Ownership",
					   hidden: false,
					   width: "150px",
					 },
					 {
					   field: "KeyManager",
					   title: "Key Manager",
					   hidden: false,
					   width: "150px",
					   template: function(d) {
						 return util.getToggleValue(d.KeyManager);
					   }
					 },
					 {
					   field: "BoardMember",
					   title: "Board Member",
					   hidden: false,
					   width: "150px",
					   template: function(d) {
						 return util.getToggleValue(d.BoardMember);
					   }
					 },
					 {
					   field: "KeyConsultant",
					   title: "Key Consultant",
					   hidden: false,
					   width: "150px",
					   template: function(d) {
						 return util.getToggleValue(d.KeyConsultant);
					   }
					 },
					 {
					   field: "Employee",
					   title: "Employee",
					   hidden: false,
					   width: "150px",
					   template: function(d) {
						 return util.getToggleValue(d.Employee);
					   }
					 },
					 {
					   field: "Email",
					   title: "Email",
					   hidden: false,
					   width: "250px",
					 },
					 {
					   field: "Phone",
					   title: "Phone",
					   hidden: false,
					   width: "180px",
					 },
					 {
					   field: "Nationality",
					   title: "Nationality",
					   hidden: false,
					   width: "180px",
					 },
					 {
					   title: "",
					   width: "75px",
					   locked: true,
					   hidden: false,
					   attributes: {
						 "class": "cta"
					   },
					   template: function(d) {
						 var icons = '<a class="view_details"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
						 return icons;
					   }
					 }
					];

	  $(selector).kendoGrid({
		height: 500,
		dataSource: new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1369/ARK_Assocications/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  filter: {
			field: "CompanyFK",
			operator: "eq",
			value: company.EntryId
		  },
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		}),
		columns: columns,
		pageable: {
		  buttonCount: 4,
		  pageSize: 15,
		  pageSizes: [10, 25, 50, 100],
		  refresh: true
		},
		scrollable: true,
		sortable: true,
		filterable: true,
		groupable: false,
	  });


	  $(selector).delegate(".view_details", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		singleCompanyDetails.editAssociation(row.toJSON());
	  });

	},
	initDocumentsTab: function(company, node) {
	  node.innerHTML = "<div class='company-documents'></div>" +
		`${!access.user.UserRole.Readonly ? '<a class="k-button k-button-action company-add-document" style="margin-top: 30px; float: right; margin-left:15px;" href="#"  >Add Document</a>;' : '' }`;
	  var selector = node.querySelector(".company-documents");
	  if (node.querySelector(".company-add-document")) {
		node.querySelector(".company-add-document").addEventListener("click", function() {
		  singleCompanyDetails.editDocument();
		});
	  }

	  var columns = [{
		field: "File",
		title: "File Name",
		hidden: false,
		width: "300px",
		locked: true,
		headerAttributes: {
		  style: "white-space: normal"
		},
		template: function(d) {
		  if (d.LegacyFileName)
			return '<a class="download" style="color: blue;text-decoration: underline;">' + d.LegacyFileName + ' </a>';

		  return '<a class="download" style="color: blue;text-decoration: underline;">' + d.File + ' </a>';
		}
	  },
					 {
					   field: "Description",
					   title: "Description",
					   hidden: false,
					   width: "300px",
					   locked: false,
					   template: function(d) {
						 if (d.Description.length > 250)
						   return d.Description.substring(0, 250);

						 return d.Description;
					   }
					 },
					 {
					   field: "Category",
					   title: "Category",
					   hidden: false,
					   width: "200px",
					 },
					 {
					   field: "Date",
					   title: "Date",
					   hidden: false,
					   width: "150px",
					   template: function(d) {
						 if (d.LegacyCreated)
						   return util.getDate(d.LegacyCreated);

						 return util.getDate(d.Created || d.Modified);
					   }
					 },
					 {
					   field: "CreatedBy",
					   title: "Owner",
					   hidden: false,
					   width: "200px",
					   template: function(d) {
						 return d.LegacyCreatedBy || d.CreatedBy
					   }
					 },
					 {
					   title: "",
					   width: "120px",
					   locked: true,
					   hidden: false,
					   attributes: {
						 "class": "cta"
					   },
					   template: function(d) {
						 var icons = '<a class="view_doc"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';

						 if (util.Email() == d.ModifiedBy || access.user.UserRole.ADMIN) {
						   icons += '<a class="edit_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></a>';
						   icons += '<a class="delete_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="21px" height="21px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M4,5 L20,5 L20,23 L4,23 L4,5 Z M1,5 L23,5 M9,1 L15,1 L15,5 L9,5 L9,1 Z M9,1 L15,1 L15,5 L9,5 L9,1 Z M15,9 L15,19 M9,9 L9,19"></path></a>';
						 }
						 return icons;
					   }
					 }
					];

	  $(selector).kendoGrid({
		height: 500,
		dataSource: new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1370/ARK_Profile_Document/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  filter: [{
			field: "CompanyFK",
			operator: "eq",
			value: company.EntryId
		  },
				   {
					 field: "Visible",
					 operator: "eq",
					 value: 1
				   },
				  ],
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		}),
		columns: columns,
		pageable: {
		  buttonCount: 4,
		  pageSize: 15,
		  pageSizes: [10, 25, 50, 100],
		  refresh: true
		},
		scrollable: true,
		sortable: true,
		filterable: true,
		groupable: false,
	  });


	  $(selector).delegate(".view_doc", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		singleCompanyDetails.viewDocument(row.toJSON());
	  });

	  $(selector).delegate(".download", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));

		var link = "";
		if (row.File)
		  link = globalReferences.server + 'form/1370/attachments/' + row.EntryId + '/File?' + row.File;
		if (row.LegacyFileName)
		  link = globalReferences.server + 'resources/rs/custom/ark/attachments/' + singleCompanyDetails.company.LegacyId + '/' + row.LegacyFileName;
		var aLink = document.createElement("a");
		aLink.setAttribute("target", "_self");
		aLink.innerHTML = row.File;
		aLink.setAttribute("href", link);
		aLink.click();
	  });


	  $(selector).delegate(".edit_doc", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		singleCompanyDetails.editDocument(row.toJSON());
	  });

	  $(selector).delegate(".delete_doc", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		singleCompanyDetails.deleteDocument(row.toJSON(), company);
	  });

	},
	initNotesTab: function(company, node) {
	  node.innerHTML = "<div class='company-notes'></div>" +
		`${!access.user.UserRole.Readonly  ? '<a class="k-button k-button-action company-add-note" style="margin-top: 30px; float: right; margin-left:15px;" href="#"  >Add Note</a>;' : '' }`;
	  var selector = node.querySelector(".company-notes");
	  if (node.querySelector(".company-add-note")) {
		node.querySelector(".company-add-note").addEventListener("click", function() {
		  singleCompanyDetails.editNote();
		});
	  }

	  var columns = [{
		field: "EntryId",
		title: "Id",
		hidden: true,
		width: "100px",
	  },
					 {
					   field: "Subject",
					   title: "Subject",
					   hidden: false,
					   width: "250px",
					   headerAttributes: {
						 style: "white-space: normal"
					   }
					 },
					 {
					   field: "Note",
					   title: "Note",
					   hidden: false,
					   //width: "150px",
					   template: function(d) {
						 var note = d.Note;
						 if (note.length > 250)
						   note = note.substring(0, 250) + "...";

						 return note;
					   }
					 },
					 {
					   field: "Created",
					   title: "Date",
					   hidden: false,
					   width: "180px",
					   template: function(d) {
						 if (d.LegacyCreated)
						   return util.getDate(d.LegacyCreated);
						 return util.getDate(d.Created);
					   }
					 },
					 {
					   field: "CreatedBy",
					   title: "Owner",
					   hidden: false,
					   width: "200px",
					   template: function(d) {
						 return d.LegacyCreatedBy || d.CreatedBy
					   }
					 },
					 {
					   title: "",
					   width: "60px",
					   //locked: true,
					   hidden: false,
					   attributes: {
						 "class": "cta"
					   },
					   template: function(d) {
						 var icons = '<a class="view_note"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';

						 /*if(util.Email() == d.ModifiedBy)
                                      {
                                        icons += '<a class="edit_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="22px" height="22px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M14,4 L20,10 L14,4 Z M22.2942268,5.29422684 C22.6840146,5.68401459 22.6812861,6.3187139 22.2864907,6.71350932 L9,20 L2,22 L4,15 L17.2864907,1.71350932 C17.680551,1.319449 18.3127724,1.31277239 18.7057732,1.70577316 L22.2942268,5.29422684 Z M3,19 L5,21 M7,17 L15,9"></path></a>';
                                        icons += '<a class="delete_doc" style="margin-left:10px"><svg version="1.1" viewBox="0 0 24 24" width="21px" height="21px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M4,5 L20,5 L20,23 L4,23 L4,5 Z M1,5 L23,5 M9,1 L15,1 L15,5 L9,5 L9,1 Z M9,1 L15,1 L15,5 L9,5 L9,1 Z M15,9 L15,19 M9,9 L9,19"></path></a>';			
                                      }*/
						 return icons;
					   }
					 }
					];

	  $(selector).kendoGrid({
		height: 500,
		dataSource: new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1372/ARK_Notes/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  filter: [{
			field: "CompanyFK",
			operator: "eq",
			value: company.EntryId
		  }],
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		}),
		columns: columns,
		pageable: {
		  buttonCount: 4,
		  pageSize: 15,
		  pageSizes: [10, 25, 50, 100],
		  refresh: true
		},
		scrollable: true,
		sortable: true,
		filterable: true,
		groupable: false,
	  });


	  $(selector).delegate(".view_note", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		singleCompanyDetails.viewNote(row.toJSON());
	  });


	  /*$(selector).delegate(".edit_doc", "click", function(e) {
                      var grid = $(selector).data("kendoGrid");			 
                      var row = grid.dataItem($(this).closest("tr"));
                      singleCompanyDetails.editDocument(row.toJSON());
                    });

                    $(selector).delegate(".delete_doc", "click", function(e) {
                      var grid = $(selector).data("kendoGrid");			 
                      var row = grid.dataItem($(this).closest("tr"));
                      singleCompanyDetails.docToDelete = row.toJSON();
                      crud.destroy("3991", row.EntryId, function(d) { 
                        singleCompanyDetails.init(company.EntryId, true, function(){
                          mo.fn.overlay.hide();
                          singleCompanyDetails.holder().querySelector('[tab-id="documents"]').click();

                          singleCompanyDetails.addAuditLog("Document deleted",
                                                           util.getDifference({}, singleCompanyDetails.docToDelete),
                                                           util.Email());
                        });
                      });
                    });*/

	},
	initAuditTab: function(company, node) {
	  node.innerHTML = "<div class='company-audit-grid'></div>";
	  var selector = node.querySelector(".company-audit-grid");

	  var columns = [{
		field: "Type",
		title: "Type",
		hidden: false,
		width: "250px",
		locked: true,
		headerAttributes: {
		  style: "white-space: normal"
		},
	  },
					 {
					   field: "Changes",
					   title: "Changes",
					   hidden: false,
					   width: "550px",
					   template: function(d) {
						 var res = d.Changes;
						 if (d.Changes.length > 250)
						   res = d.Changes.substring(0, 250) + "...";

						 res = res.replaceAll("##", "\n");

						 return res;
					   }
					 },
					 {
					   field: "User",
					   title: "Modified By",
					   hidden: false,
					   width: "200px"
					 },
					 {
					   field: "Modified",
					   title: "Date",
					   hidden: false,
					   width: "200px",
					   template: function(d) {
						 return d.LegacyCreated ? util.getDate(d.LegacyCreated) : util.getDate(d.Created)
					   }
					 },
					 {
					   title: "",
					   width: "75px",
					   locked: true,
					   hidden: false,
					   attributes: {
						 "class": "cta"
					   },
					   template: function(d) {
						 var icons = '<a class="view_details"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
						 return icons;
					   }
					 }
					];

	  $(selector).kendoGrid({
		height: 500,
		dataSource: new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1371/ARK_Profile_Audit/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  filter: {
			field: "CompanyFK",
			operator: "eq",
			value: company.EntryId
		  },
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		}),
		columns: columns,
		pageable: {
		  buttonCount: 4,
		  pageSize: 15,
		  pageSizes: [10, 25, 50, 100],
		  refresh: true
		},
		scrollable: true,
		sortable: true,
		filterable: true,
		groupable: false,
	  });

	  $(selector).delegate(".view_details", "click", function(e) {
		var grid = $(selector).data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		singleCompanyDetails.viewAuditLog(row);
	  });
	},
	statusReasonStructure: [{
	  group: [
		[{
		  label: "Status Reason:",
		  data: "StatusReason",
		  required: true,
		  type: "select",
		  values: ["Approved", "Certified", "Passed HPE DDQ", "3P belongs to HPI", "3P belongs to Microfocus", "Business Prohibited", "Contract Terminated", "Denied", "HPE Exiting Countries", "Out of Scope",
				   "Pending", "To Terminate"
				  ],
		  options: ["Approved", "Certified", "Passed HPE DDQ", "3P belongs to HPI", "3P belongs to Microfocus", "Business Prohibited", "Contract Terminated", "Denied", "HPE Exiting Countries", "Out of Scope",
					"Pending", "To Terminate"
				   ]

		}],
	  ],
	},
							{
							  group: [
								[{
								  label: "Explanation",
								  data: "Comment",
								  required: true,
								  type: "textarea",
								  validation: ["minLen|1"]
								}]
							  ],
							},
						   ],
	editStatus: function() {
	  var conf = {
		pages: [{
		  nav: false,
		  structure: singleCompanyDetails.statusReasonStructure,
		  callback: function() {

		  },
		  validation: function() {
			var result = {
			  fail: [],
			  pass: []
			};
			return result;
		  }
		}],
		onSubmit: function() {

		}
	  };

	  mo.fn.modal.show({
		ctaLabel: "Submit",
		class: "ark-modal",
		title: "Set Approval Status",
		content: '<div class="edit_status" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  conf.dom = document.querySelector(".dxpModalContent .edit_status");
		  singleCompanyDetails.statusConf = conf;
		  nbsf.init(conf, 0);
		},
		ctaCallback: function() {

		  nbsf.data.update(singleCompanyDetails.statusConf, {});
		  var data = singleCompanyDetails.statusConf.dataset;

		  if (!data.StatusReason || !data.Comment) {
			mo.fn.modal.msg("Please provide the status reason and explanation", 3);
			return;
		  }
		  var company = singleCompanyDetails.company;
		  const prevCompany = { ...singleCompanyDetails.company
							  };

		  company.StatusReason = data.StatusReason;
		  company.Status = singleCompanyDetails.getProfileStatus(data.StatusReason);
		  company.LastStatusReason = data.Comment;
		  company.LastStatusChangeDate = (new Date()).toISOString();

		  mo.fn.modal.lock();

		  crud.update("3980", company.EntryId, company, function(d) {
			if (d.EntryId) {

			  mo.fn.modal.unlock();
			  mo.fn.modal.hide();


			  singleCompanyDetails.init(company.EntryId, true, function() {
				mo.fn.overlay.hide();
			  });

			  crud.create("3993", {
				Subject: "Third Party Approval: " + company.Status,
				Category: "General Information",
				Note: data.Comment,
				CompanyFK: company.EntryId
			  },
						  function() {});

			  singleCompanyDetails.addAuditLog("Approval Status",
											   util.getDifference(prevCompany, data),
											   util.Email());

			} else {
			  mo.fn.modal.unlock();
			  mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
			}
		  });


		}
	  });
	},
	editAssociation: function(ass) {
	  var conf = {
		pages: [{
		  nav: false,
		  structure: [{
			header: "General Information",
			group: [
			  [{
				label: "Type",
				data: "Type",
				type: "select",
				required: true,
				value: "Person",
				validation: ["inArray"],
				options: ["Person", "Entity"],
				values: ["Person", "Entity"]
			  },
			   {
				 label: "Name Format",
				 data: "NameFormat",
				 type: "select",
				 required: true,
				 value: "First/Last",
				 validation: ["inArray"],
				 options: ["First/Last", "Full"],
				 values: ["First/Last", "Full"]
			   },
			   {
				 label: "First Name",
				 data: "FirstName",
				 required: true,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Last Name",
				 data: "LastName",
				 required: true,
				 value: null,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Email",
				 data: "Email",
				 required: true,
				 value: null,
				 type: "text",
				 validation: ["isEmail", "minLen|1", "maxLen|255"],
			   },
			   {
				 label: "Nationality",
				 data: "Nationality",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|100"],
			   },
			   {
				 label: "Address",
				 data: "Address",
				 required: false,
				 type: "text",
				 validation: ["flt", "minLen|1", "maxLen|255"],
				 typing: "flt"
			   },
			   {
				 label: "Country",
				 data: "Country",
				 type: "select",
				 required: false,
				 validation: ["inArray"],
				 options: reference.countries.options(),
				 values: reference.countries.values()
			   },
			   {
				 label: "Phone",
				 data: "Phone",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
			   },
			   {
				 label: "Alternate phone",
				 data: "AltPhone",
				 required: false,
				 type: "text",
				 validation: ["minLen|1", "maxLen|255"],
			   },
			  ]
			]
		  },
					  {
						header: "In relation to Current 3P",
						group: [
						  [{
							label: "Position",
							data: "Position",
							required: false,
							type: "text",
							validation: ["minLen|1", "maxLen|100"],
						  },
						   {
							 label: "Company phone",
							 data: "CompanyPhone",
							 required: false,
							 type: "text",
							 validation: ["minLen|1", "maxLen|100"],
						   },
						   {
							 label: "CompanyEmail",
							 data: "CompanyEmail",
							 required: false,
							 value: null,
							 type: "text",
							 validation: ["isEmail", "minLen|1", "maxLen|255"],
						   },
						   {
							 label: "Include In 3P Monitor",
							 data: "IncludeIn3pMonitor",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   },
						   {
							 label: "Has government relationship",
							 data: "HasGovernmentRelationship",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   },
						  ]
						]
					  },
					  {
						header: "Roles",
						group: [
						  [{
							label: "Point of Contact",
							data: "PointOfContact",
							type: "toggle",
							values: ['N', 'Y'],
							validation: ["minLen|1", "maxLen|255", "noBlanks"],
						  },
						   {
							 label: "Primary Point Of Contact",
							 data: "PrimaryPointOfContact",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   },
						   {
							 label: "Owner",
							 data: "Owner",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   }
						  ],
						  [{
							label: "Ownership Percent",
							data: "OwnershipPercent",
							required: false,
							type: "text",
							validation: ["flt", "minVal|0", "maxVal|100", "noBlanks"],
							typing: "flt"
						  }, ],
						  [{
							label: "Key Manager",
							data: "KeyManager",
							type: "toggle",
							values: ['N', 'Y'],
							validation: ["minLen|1", "maxLen|255", "noBlanks"],
						  },
						   {
							 label: "Board member",
							 data: "BoardMember",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   },
						   {
							 label: "Key consultant",
							 data: "KeyConsultant",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   },
						   {
							 label: "Employee",
							 data: "Employee",
							 type: "toggle",
							 values: ['N', 'Y'],
							 validation: ["minLen|1", "maxLen|255", "noBlanks"],
						   },
						  ]
						]
					  },
					 ],
		  callback: function() {

		  },
		  validation: function() {
			var result = {
			  fail: [],
			  pass: []
			};
			return result;
		  }
		}],
		onSubmit: function() {

		}
	  };

	  mo.fn.modal.show({
		ctaLabel: "Submit",
		class: "ark-modal",
		title: ass ? "Update association" : "Create association",
		content: '<div class="change_association" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  conf.dom = document.querySelector(".dxpModalContent .change_association");
		  singleCompanyDetails.associationPeopleConf = conf;
		  conf.dataset = JSON.parse(JSON.stringify(ass || {}));

		  nbsf.init(conf, 0);
		},
		ctaCallback: function() {

		  var res = nbsf.ev.global(singleCompanyDetails.associationPeopleConf, true);
		  if (res.total.fail > 0)
			return;

		  nbsf.data.update(singleCompanyDetails.associationPeopleConf, {});
		  var data = singleCompanyDetails.associationPeopleConf.dataset;


		  var company = singleCompanyDetails.company;
		  var people = JSON.parse(singleCompanyDetails.company.AssociationPeople || "[]");

		  mo.fn.modal.lock();
		  //IF NEW
		  if (!ass) {
			data.CompanyFK = company.EntryId;
			crud.create("3987", data, function(d) {
			  if (d.EntryId) {

				mo.fn.modal.unlock();
				mo.fn.modal.hide();

				singleCompanyDetails.init(company.EntryId, true, function() {
				  mo.fn.overlay.hide();
				  singleCompanyDetails.holder().querySelector('[tab-id="association"]').click();
				});

				singleCompanyDetails.addAuditLog("Association added", util.getDifference({}, data, singleCompanyDetails.associationPeopleConf), util.Email());

			  } else {
				mo.fn.modal.unlock();
				mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
			  }
			});
		  } else {
			crud.update("3988", ass.EntryId, data, function(d) {
			  if (d.EntryId) {

				mo.fn.modal.unlock();
				mo.fn.modal.hide();

				singleCompanyDetails.init(company.EntryId, true, function() {
				  mo.fn.overlay.hide();
				  singleCompanyDetails.holder().querySelector('[tab-id="association"]').click();
				});

				singleCompanyDetails.addAuditLog("Association changed", util.getDifference(ass, data, singleCompanyDetails.associationPeopleConf), util.Email());

			  } else {
				mo.fn.modal.unlock();
				mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
			  }
			});
		  }

		}
	  });
	},
	viewDocument: function(data) {
	  mo.fn.modal.show({
		ctaLabel: "Close",
		class: "ark-modal",
		title: "Document #" + data.EntryId,
		content: '<div class="profile_doc" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  var container = document.querySelector(".profile_doc");

		  var link = globalReferences.server + 'form/1370/attachments/' + data.EntryId + '/File?' + data.File;

		  container.innerHTML =
			'<div class="title">Modified</div><div class="value">' + data.CreatedBy + ' (' + util.getDate(data.Modified) + ')' + '</div>' +
			'<div class="title">Category</div><div class="value">' + data.Category + '</div>';

		  container.innerHTML +=
			'<div class="title">Description</div><div class="value">' + (data.Description || "-") + '</div>';

		  if (data.File)
			container.innerHTML +=
			  '<div class="title">Attachment</div><div class="value"><a target="_self" href=' + link + '>' + data.File + '</a></div>';
		}
	  });
	},
	editDocument: function(d) {

	  var company = singleCompanyDetails.company;

	  function showModal(data) {
		var conf = {
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Category",
				  data: "Category",
				  required: true,
				  type: "select",
				  values: ["DDI Scorecard", "EDD Scorecard", "Email", "Exempt Certification", "GDC report", "General", "Global Trade", "IFQ",
						   "Lobbyist Report", "LSP Report", "OSI ScoreCard", "Special Handling Documentation", "DDI Report", "IDD Report", "Supplier Report", "IDD Scorecard"
						  ],
				  options: ["DDI Scorecard", "EDD Scorecard", "Email", "Exempt Certification", "GDC report", "General", "Global Trade", "IFQ",
							"Lobbyist Report", "LSP Report", "OSI ScoreCard", "Special Handling Documentation", "DDI Report", "IDD Report", "Supplier Report", "IDD Scorecard"
						   ],


				}],
				[{
				  label: "Provide a description of the document you are uploading",
				  data: "Description",
				  required: true,
				  type: "textarea",
				  validation: ["minLen|1"]
				}],
				[{
				  label: "Select File",
				  data: "File",
				  required: true,
				  type: "kUpload",
				  value: null,
				  uploadConfig: {
					formId: 1370,
					extensions: [],
					maxFileSize: 10
				  }
				}]
			  ],
			}, ],
			callback: function() {

			},
			validation: function() {
			  var result = {
				fail: [],
				pass: []
			  };
			  return result;
			}
		  }]
		};

		mo.fn.modal.show({
		  ctaLabel: "Submit",
		  class: "ark-modal",
		  title: data ? "Edit document" : "Add document",
		  content: '<div class="edit_doc" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			conf.dom = document.querySelector(".dxpModalContent .edit_doc");
			singleCompanyDetails.docConf = conf;
			singleCompanyDetails.docData = data || {};
			conf.dataset = JSON.parse(JSON.stringify(data || {}));
			nbsf.init(conf, 0);
		  },
		  ctaCallback: function() {

			var res = nbsf.ev.global(singleCompanyDetails.docConf, true);
			if (res.total.fail > 0)
			  return;


			nbsf.data.update(singleCompanyDetails.docConf, {});
			var oldData = singleCompanyDetails.docData;
			var data = singleCompanyDetails.docConf.dataset;

			var company = singleCompanyDetails.company;

			mo.fn.modal.lock();

			var isNew = data.Visible != 1;

			data.Visible = 1;
			crud.update("3990", data.EntryId, data, function(d) {
			  if (d.EntryId) {

				mo.fn.modal.unlock();
				mo.fn.modal.hide();

				singleCompanyDetails.init(company.EntryId, true, function() {
				  mo.fn.overlay.hide();
				  singleCompanyDetails.holder().querySelector('[tab-id="documents"]').click();
				});

				if (isNew)
				  singleCompanyDetails.addAuditLog("Document added", util.getDifference({}, data), util.Email());
				else singleCompanyDetails.addAuditLog("Document changed", util.getDifference(oldData, data), util.Email());

			  } else {
				mo.fn.modal.unlock();
				mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
			  }
			});


		  }
		});
	  }

	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });

	  //EDIT
	  if (d && d.EntryId)
		showModal(d);
	  //NEW
	  else {
		var data = {};
		data.CompanyFK = company.EntryId;
		data.Visible = 0;
		crud.create("3989", data, function(d) {
		  if (d.EntryId) {
			singleCompanyDetails.addAuditLog("Document added", util.getDifference({}, d), util.Email(), null, company.EntryId);
			mo.fn.overlay.hide();
			showModal(d);
		  } else {
			mo.fn.modal.show({
			  ctaLabel: "oK",
			  class: "ark-modal",
			  title: "Error",
			  content: 'Error:' + JSON.stringify(d)
			});
		  }
		});
	  }


	},
	deleteDocument: function(d, company) {
	  var deleteConf;

	  function showModal(data) {
		var conf = {
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Reason for deleting the document",
				  data: "Reason",
				  required: true,
				  type: "textarea",
				  validation: ["minLen|1"]
				}]
			  ],
			}, ],
			callback: function() {

			},
			validation: function() {
			  var result = {
				fail: [],
				pass: []
			  };
			  return result;
			}
		  }]
		};

		mo.fn.modal.show({
		  ctaLabel: "Delete",
		  class: "ark-modal",
		  title: "Delete document",
		  content: '<div class="delete_doc" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		  contentCallback: function() {
			document.querySelector('.dxpModalFooter').classList.remove('hidden');

			conf.dom = document.querySelector(".dxpModalContent .delete_doc");
			deleteConf = conf;
			nbsf.init(conf, 0);
		  },
		  ctaCallback: function() {
			var res = nbsf.ev.global(deleteConf, true);
			if (res.total.fail > 0)
			  return;


			nbsf.data.update(deleteConf, {});
			var data = deleteConf.dataset;
			mo.fn.modal.lock();

			singleCompanyDetails.docToDelete = d;
			singleCompanyDetails.docToDelete.Reason = data.Reason;
			crud.destroy("3991", d.EntryId, function(d) {
			  singleCompanyDetails.init(company.EntryId, true, function() {
				mo.fn.overlay.hide();
				mo.fn.modal.hide();
				singleCompanyDetails.holder().querySelector('[tab-id="documents"]').click();

				singleCompanyDetails.addAuditLog("Document deleted",
												 util.getDifference({}, singleCompanyDetails.docToDelete),
												 util.Email());
			  });
			});
		  }
		});
	  }

	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });
	  if (d && d.EntryId)
		showModal(d);
	},
	viewAuditLog: function(data) {
	  mo.fn.modal.show({
		ctaLabel: "Close",
		class: "ark-modal",
		title: "Audit Log #" + data.EntryId,
		content: '<div class="profile_audit_log" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  var container = document.querySelector(".profile_audit_log");

		  container.innerHTML =
			'<div class="title">Modified</div><div class="value">' + data.ModifiedBy + ' (' + util.getDate(data.Modified) + ')' + '</div>' +
			'<div class="title">Type</div><div class="value">' + data.Type + '</div>';

		  container.innerHTML +=
			'<div class="title">Description</div><div class="value" style="white-space: pre-line;">' + (util.beautifyAuditString(data.Changes).replaceAll("##", "\n") || "-") + '</div>';

		}
	  });
	},
	addAuditLog: function(type, changes, user, callback, companyFK) {
	  try {
		if (!companyFK)
		  companyFK = singleCompanyDetails.company.EntryId

		if (!companyFK)
		  return;

		crud.create("3992", {
		  Changes: changes,
		  Type: type,
		  User: user,
		  CompanyFK: companyFK
		}, function(d) {
		  if (callback)
			callback();
		});

	  } catch (e) {
		if (callback)
		  callback();
	  }
	},
	viewNote: function(data) {
	  mo.fn.modal.show({
		ctaLabel: "Close",
		class: "ark-modal",
		title: "Note #" + data.EntryId,
		content: '<div class="profile_audit_log" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  var container = document.querySelector(".profile_audit_log");

		  container.innerHTML =
			'<div class="title">Modified</div><div class="value">' + data.ModifiedBy + ' (' + util.getDate(data.Modified) + ')' + '</div>' +
			'<div class="title">Category</div><div class="value">' + data.Category + '</div>' +
			'<div class="title">Subject</div><div class="value">' + data.Subject + '</div>' +
			'<div class="title">Note</div><div class="value">' + data.Note + '</div>';
		}
	  });
	},
	editNote: function() {
	  var conf = {
		pages: [{
		  nav: false,
		  structure: [{
			group: [
			  [{
				label: "Category",
				data: "Category",
				required: true,
				type: "select",
				values: ["General Information"],
				options: ["General Information"]

			  },

			  ],
			  [{
				label: "Subject",
				data: "Subject",
				required: true,
				type: "text",
				validation: ["minLen|1", "maxLen|255"]
			  }, ],
			  [{
				label: "Note",
				data: "Note",
				required: true,
				type: "textarea",
				validation: ["minLen|1"]
			  }]
			],
		  }],
		}],
	  };

	  mo.fn.modal.show({
		ctaLabel: "Submit",
		class: "ark-modal",
		title: "Add Note",
		content: '<div class="edit_note" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  conf.dom = document.querySelector(".dxpModalContent .edit_note");
		  conf.dataset = {
			"Category": "General Information"
		  };
		  singleCompanyDetails.noteConf = conf;
		  nbsf.init(conf, 0);
		},
		ctaCallback: function() {

		  var res = nbsf.ev.global(singleCompanyDetails.noteConf, true);
		  if (res.total.fail > 0)
			return;

		  nbsf.data.update(singleCompanyDetails.noteConf, {});
		  var data = singleCompanyDetails.noteConf.dataset;

		  var company = singleCompanyDetails.company;

		  mo.fn.modal.lock();

		  data.CompanyFK = company.EntryId;
		  crud.create("3993", data, function(d) {
			if (d.EntryId) {

			  mo.fn.modal.unlock();
			  mo.fn.modal.hide();

			  singleCompanyDetails.init(company.EntryId, true, function() {
				mo.fn.overlay.hide();
				singleCompanyDetails.holder().querySelector('[tab-id="notes"]').click();
			  });

			  singleCompanyDetails.addAuditLog("Note added",
											   util.getDifference({}, data),
											   util.Email());

			} else {
			  mo.fn.modal.unlock();
			  mo.fn.modal.msg("Error: " + JSON.stringify(d), 3);
			}
		  });


		}
	  });
	},
	customFields: {
	  getCustomFields: function(id, callback) {
		crud.read('4011', 'eid=' + id, function(d) {
		  callback(d);

		});
	  },
	  init: function(company, node) {

		makeValuesBold = function() {
		  node.querySelector(".custom-fields").querySelectorAll("input, select").forEach(x => {
			if (x.value && x.value != "Select one")
			  x.style.fontWeight = 700
		  });
		};

		node.innerHTML = "<input id='cf-search-panel' class='cf-search-panel' size='24' placeholder='Quick filter' /><section class='custom-fields' id='custom-fields'></section>" +
		  `${!access.user.UserRole.Readonly ? `<div class="customFields-control-buttons"><a class="k-button k-button-big customFields-cancel" style="margin-left:15px;width:100px" href="#">Cancel</a>
<a class="k-button k-button-action customFields-save" style="margin-left:15px;width:100px" href="#">Save</a></div>` : '' }`;

		singleCompanyDetails.customFields.getCustomFields(singleCompanyDetails.company.EntryId, function(d) {
		  singleCompanyDetails.customFieldsVal = d.Rows[0];
		  conf = singleCompanyDetails.customFields.config(singleCompanyDetails.company, node);
		  if (singleCompanyDetails.customFieldsVal) conf.dataset = Object.assign({}, singleCompanyDetails.customFieldsVal);
		  conf.dataset = util.removeTime(conf.dataset);

		  nbsf.init(conf, 0);
		  util.customFieldsTooltips(conf, node);
		  util.customFieldsSearchPanel('custom-fields', 'cf-search-panel');
		  makeValuesBold();

		});
		if (node.querySelector('.customFields-control-buttons')) {
		  const ctrlBtns = node.querySelector('.customFields-control-buttons');
		  const initialOffset = ctrlBtns.getBoundingClientRect().top + window.scrollY - 20;

		  window.addEventListener('scroll', function() {
			let vertical_position = 0;
			if (pageYOffset) // usual
			  vertical_position = pageYOffset;
			else if (document.documentElement.clientHeight) // ie
			  vertical_position = document.documentElement.scrollTop;
			else if (document.body) // ie quirks
			  vertical_position = document.body.scrollTop;

			ctrlBtns.style.top = (vertical_position > initialOffset) ? (vertical_position - initialOffset) + 'px' : 0;
		  });
		}
		if (node.querySelector('.customFields-save')) {
		  node.querySelector('.customFields-save').addEventListener('click', function(ev) {
			nbsf.data.update(conf, {});
			conf.dataset.CompanyFK = singleCompanyDetails.company.EntryId;

			var keys = Object.keys(conf.dataset);
			keys.forEach(key => {
			  if (conf.dataset[key] == "Select one")
				conf.dataset[key] = "";
			});

			if (!singleCompanyDetails.customFieldsVal || Object.keys(singleCompanyDetails.customFieldsVal).length == 0) {
			  crud.create('4009', conf.dataset, function(d) {
				singleCompanyDetails.customFieldsVal = d;
				singleCompanyDetails.addAuditLog("Profile Custom Fields added", util.getDifference({}, d), util.Email(), null, d.CompanyFK);
				mo.fn.modal.show({
				  ctaLabel: "OK",
				  class: "ark-modal",
				  title: "Success!",
				  content: "<p>Custom field created.</p>"
				});
				makeValuesBold();
			  });
			} else {
			  crud.update('4010', singleCompanyDetails.customFieldsVal.EntryId, conf.dataset, function(d) {
				const old = { ...singleCompanyDetails.customFieldsVal
							};
				singleCompanyDetails.customFieldsVal = d;
				singleCompanyDetails.addAuditLog("Profile Custom Fields changed", util.getDifference(old, d), util.Email(), null, d.CompanyFK);
				mo.fn.modal.show({
				  ctaLabel: "OK",
				  class: "ark-modal",
				  title: "Success!",
				  content: "<p>Custom field updated.</p>"
				});
				makeValuesBold();
			  });
			}

			ev.preventDefault();
		  });
		}
		if (node.querySelector('.customFields-cancel')) {
		  node.querySelector('.customFields-cancel').addEventListener('click', function(ev) {
			conf = singleCompanyDetails.customFields.config(company, node);
			if (singleCompanyDetails.customFieldsVal) conf.dataset = singleCompanyDetails.customFieldsVal;
			conf.dataset = util.removeTime(conf.dataset);

			nbsf.init(conf, 0);
			util.customFieldsTooltips(conf, node);

			ev.preventDefault();
		  });
		}
	  },
	  structure: [{
		header: "Specific to Third Language Code",
		group: [
		  [{
			label: "Preferred Language Code",
			data: "PreferredLanguageCode",
			required: false,
			value: null,
			tooltip: "Primarily used for the emailing of DDQ Invites to determine desired language.",
			disabled: true,
			type: "text",
			validation: ["minLen|1", "maxLen|100"],
		  },
		   {
			 label: "Partner Location ID",
			 data: "PartnerLocationId",
			 required: false,
			 value: null,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Party ID",
			 data: "PartyId",
			 required: false,
			 value: null,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Special Partner Type",
			 data: "SpecialPartnerType",
			 required: false,
			 value: null,
			 tooltip: "OEM Siebel ID: XXX/PRSP Siebel ID: XXX",
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Special Partner Type Siebel ID",
			 data: "SpecialPartnerTypeSiebelId",
			 required: false,
			 value: null,
			 tooltip: "If marked 'Yes', this partner has a documented list of headquarter/branch site and subsidiary locations in multiple Regions which are exempt from L&R Compliance screening per approval by the HP Ethics and Compliance Office. This list is typically included in a Partner Certification document which should be attached to each exempt location's 3P profile record.",
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },

		   {
			 label: "Global Exemption",
			 data: "GlobalExemption",
			 required: false,
			 tooltip: "If marked 'Yes,' this partner has a documented list of headquarter/branch site and subsidiary locations in multiple Regions which are exempt from L&R Compliance screening per approval by the HP Ethics and Compliance Office. This list is typically included in a Partner Certification document which should be attached to each exempt location's 3P profile record.",
			 type: "toggle",
			 values: ['No', 'Yes']
		   },
		   {
			 label: "Branch or Subsidiary Exemption",
			 data: "BranchOrSubsidiaryExemption",
			 required: false,
			 tooltip: "Under Reseller (and certain other) L&R Compliance Programs, one Region Headquarter location with an approved HQ/Sub Declaration must be screened, but all other branch and subsidiary locations in that Region are exempt from L&R screening. Do not use this field for Global Exemptions that apply to a specific list of exempt partner site & subsidiary locations in multiple Regions.",
			 type: "toggle",
			 values: ['No', 'Yes'],
		   },
		   {
			 label: "Internal HPE Contact Name",
			 data: "InternalHPEContactName",
			 required: false,
			 tooltip: "Primary internal HP contact. Examples: PR Requestor, MRU Owner, PBM, Alliance Manager, etc",
			 value: null,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Internal HPE Contact Email Address",
			 data: "InternalHPEContactEmailAddress",
			 required: false,
			 value: null,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Headquarter Location or Parent Company",
			 data: "HeadquarterLocationOrParentCompany",
			 required: false,
			 type: "radio",
			 tooltip: "f the 'Yes' box is checked, this is record is for a Headquarter or Parent Company site location",
			 type: "toggle",
			 values: ['No', 'Yes']
		   },
		   {
			 label: "Branch Site or Subsidiary Company",
			 data: "BranchSiteOrSubsidiaryCompany",
			 required: false,
			 type: "radio",
			 tooltip: "If the 'Yes' box is checked, this is record is for a Branch site or Subsidiary company location",
			 type: "toggle",
			 values: ['No', 'Yes']
		   },
		   {
			 label: "Parent Company Name",
			 data: "ParentCompanyName",
			 required: false,
			 value: null,
			 tooltip: "For Subsidiaries, enter the name of the Parent Company. This field may also be used for a headquarter location company name that is different than the branch location company name to be screened.",
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Related Reseller 3P Profile Number",
			 data: "RelatedReseller3PProfileNumber",
			 required: false,
			 tooltip: "Some Supplier and OEM partners invited for L&R Compliance screening using a Supplier or OEM version of the Due Diligence Questionnaire have also been screened as a Reseller partner using the Prospective, Current, and/or Renewal versions. This field provides a cross reference to the related Reseller 3P profile number.",
			 value: null,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Related Supplier 3P Profile Number",
			 data: "RelatedSupplier3PProfileNumber",
			 required: false,
			 value: null,
			 tooltip: "Some Reseller partners invited for L&R Compliance screening using a Prospective, Current, or Renewal version of the Due Diligence Questionnaire have also been screened as a Supplier partner under a separate Securimate 3P profile record for the same company. This field provides a cross reference to the related Supplier 3P profile number.",
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Related OEM 3P Profile Number",
			 data: "RelatedOEM3PProfileNumber",
			 required: false,
			 value: null,
			 type: "text",
			 tooltip: "Some Reseller or Supplier partners have also been screened as an OEM partner under a separate Securimate 3P profile record for the same company. This field provides a cross reference to the related OEM 3P profile number.",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Highest Risk Country CPI",
			 data: "HighestRiskCountryCPI",
			 required: false,
			 type: "select",
			 values: ['CPI<31', 'CPI>=31<52', 'CPI>=52<80', 'CPI>=80'],
			 options: ['CPI < 31 (e.g. Russia', 'CPI >= 31 < 52 (e.g. Peru, China)', 'CPI >= 52 < 80 (e.g. France, US)', 'CPI >= 80 (e.g. Canada)']
		   },
		   {
			 label: "Highest Risk Country Name",
			 data: "HighestRiskCountryName",
			 required: false,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"]
		   },
		   {
			 label: "Category Status",
			 data: "CategoryStatus",
			 required: false,
			 value: null,
			 type: "text",
			 tooltip: "Final outcome of L&R Compliance partner screening - This field should not be manually populated, it will be calculated automatically when Case Repository Report is run.",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		   {
			 label: "Tax ID",
			 data: "TaxId",
			 required: false,
			 value: null,
			 type: "text",
			 validation: ["minLen|1", "maxLen|100"],
		   },
		  ]
		]
	  },
				  {
					header: "GDC Tracker Data",
					group: [
					  [{
						label: "GDC Research Analyst",
						data: "GDCResearchAnalyst",
						required: false,
						type: "text",
						validation: ["minLen|1", "maxLen|255"],
						onChange: function() {}
					  },
					   {
						 label: "GDC Research Start Date",
						 data: "GDCResearchStartDate",
						 type: "date",
						 placeholder: "Select a date",
						 dtp: {
						   format: 'Y-m-d',
						   timepicker: false,
						   formatDate: 'Y-m-d',
						   scrollMonth: false,
						   scrollInput: false,
						   onChangeDateTime: function(dp, $input) {}
						 }
					   },
					   {
						 label: "GDC Research Completed Date",
						 data: "GDCResearchCompletedDate",
						 type: "datetime",
						 placeholder: "Select a date",
						 dtp: {
						   format: 'Y-m-d',
						   timepicker: false,
						   formatDate: 'Y-m-d',
						   scrollMonth: false,
						   scrollInput: false,
						   onChangeDateTime: function(dp, $input) {}
						 }
					   },
					   {
						 label: "GDC Risk Mitigation Owner",
						 data: "GDCRiskMitigationOwner",
						 required: false,
						 type: "select",
						 values: ['DDIInvestigationTeam', 'RLs', 'ScoringTeam', 'ScoringTeam>RLs', 'RLs&ScoringTeam>RLs'],
						 options: ['DDI investigation team', 'RLs', 'Scoring team', 'Scoring team > RLs', 'RLs & Scoring team > RLs']
					   },
					   {
						 label: "GDC Red Flags",
						 data: "GDCRedFlags",
						 required: false,
						 type: "select",
						 values: ['GtExport', 'GtEmbargoCountry', 'GtEmbargoCountry&NewPEP', 'KnownPEP', 'KnownSOE', 'KnownSOE&NewPEP', 'NewPEP', 'NewPEP&KnownOtherRedFlags', 'NewPEP&OtherRedFlag', 'NewPEP&SOE', 'NewSOE', 'NewSOE&OtherRedFlags', 'OtherRedFlags', 'PEP/SOERedFlagsIsOver5Years'],
						 options: ['GT-Export', 'GT-Embargo country', 'GT-Embargo country & New PEP', 'Known PEP', 'Known SOE', 'Known SOE & New PEP', 'New PEP', 'New PEP & known Other Red Flags', 'New PEP & Other Red Flags', 'New PEP & SOE', 'New SOE', 'New SOE & Other Red flags', 'Other Red flags', 'PEP/SOE red flags is over 5 years']
					   },
					   {
						 label: "GDC Date assigned to Agility",
						 data: "GDCDateAssignedToAgility",
						 type: "date",
						 placeholder: "Select a date",
						 dtp: {
						   format: 'Y-m-d',
						   timepicker: false,
						   formatDate: 'Y-m-d',
						   scrollMonth: false,
						   scrollInput: false,
						   onChangeDateTime: function(dp, $input) {}
						 }
					   },
					   {
						 label: "GDC Agility recommendation",
						 data: "GDCAgilityRecommendation",
						 required: false,
						 type: "select",
						 values: ['Positive', 'SpecialHandling', 'SupplementalQuestionnaire', 'EDD', 'HoldECO'],
						 options: ['Positive', 'Special handling', 'Supplemental questionnaire', 'EDD', 'Hold ECO']
					   },
					   {
						 label: "GDC Agility release date",
						 data: "GDCAgilityReleaseDate",
						 type: "datetime",
						 placeholder: "Select a date",
						 dtp: {
						   format: 'Y-m-d',
						   timepicker: false,
						   formatDate: 'Y-m-d',
						   scrollMonth: false,
						   scrollInput: false,
						   onChangeDateTime: function(dp, $input) {}
						 }
					   },
					   {
						 label: "GDC Agility Special Handling Instructions",
						 data: "GDCAgilitySpecialHandlingInstructions",
						 required: false,
						 type: "text",
						 validation: ["minLen|1", "maxLen|255"],
						 onChange: function() {}
					   },
					   {
						 label: "GDC Agility Supplemental questionnaire Instructions",
						 data: "GDCAgilitySupplementalQuestionnaireInstructions",
						 required: false,
						 type: "text",
						 validation: ["minLen|1", "maxLen|255"],
						 onChange: function() {}
					   },
					   {
						 label: "GDC Agility EDD Reasons",
						 data: "GDCAgilityEDDReasons",
						 required: false,
						 type: "text",
						 validation: ["minLen|1", "maxLen|255"],
						 onChange: function() {}
					   },
					   {
						 label: "GDC Final Risk Mitigation Outcome",
						 data: "GDCFinalRiskMitigationOutcome",
						 required: false,
						 type: "select",
						 values: ['01Mitigated', '02NoActionPEPSOERedFlagsOver5Years', '03NoActionDeclaration', '04MitigatedBySecuring', '05ThirdPartyRejectionNoResponseFromPartner', '06ThirdPartyRejectionGBRejection', '07ThirdPartyRejectionGTBlockedPartner', '08ThirdPartyRejectionECORejection', '09ThirdPartyRejectionOther', '10NoAction', '11Other'],
						 options: ['01-Mitigated by performing additional due diligence', '02-No Action- PEP/SOE red flags over 5 years', '03-No Action-Declaration/commitment obtained within past 3 years', '04-Mitigated by securing declaration/commitment + Reviewing with GB', '05-Third Party rejection-No response from partner', '06-Third Party rejection-GB rejection', '07-Third Party rejection-GT blocked partner', '08-Third Party rejection-ECO rejection', '09-Third Party rejection-Other', '10-No action-Duplicaate Monitoring Report Previously Remediated', '11-Other'],
					   },
					   {
						 label: "GDC Result Override",
						 data: "GDCResultOverride",
						 required: false,
						 type: "select",
						 values: ['Positive Recommendation', 'Other'],
						 options: ['PositiveRecommendation', 'Other']
					   },
					   {
						 label: "GDC Override Reason",
						 data: "GDCOverrideReason",
						 required: false,
						 type: "text",
						 validation: ["minLen|1", "maxLen|255"],
						 onChange: function() {}
					   }
					  ]
					]
				  }
				 ],
	  config: function(company, node) {
		return {
		  dom: node.querySelector('.custom-fields'),
		  pages: [{
			nav: false,
			structure: singleCompanyDetails.customFields.structure,
			callback: function() {
			  setTimeout(function() {
				var dates = node.querySelectorAll('.date, .datetime');
				var selects = node.querySelectorAll('.select');
				var clearIcon = `
<div class="date-clear" style="
"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="clear" width="24px" height="24px" style="
cursor: pointer;
">
<path fill="none" stroke="#666" stroke-width="2" d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M5,5 L19,19">
  </path>
  </svg></div>`;
				dates.forEach(function(el) {
				  el.querySelector('svg').remove();
				  el.querySelector('.fmmcosmin').insertAdjacentHTML('beforeend', clearIcon);
				  el.addEventListener('click', function(ev) {
					ev.target.parentNode.querySelector('input').value = '';
					ev.preventDefault();
					ev.stopPropagation();
				  });

				});
				selects.forEach(function(el) {
				  el.querySelector('.fmmcosmin').insertAdjacentHTML('beforeend', clearIcon);
				  el.querySelector('.date-clear').addEventListener('click', function(ev) {
					ev.currentTarget.parentNode.querySelector('select').value = '';
					ev.preventDefault();
					ev.stopPropagation();
				  });
				});
			  }, 500);
			},
			validation: function() {
			  var result = {
				fail: [],
				pass: []
			  };
			  return result;
			}
		  }],
		};
	  }

	},
	getProfileStatus: function(statusReason) {
	  switch (statusReason) {
		case "Approved":
		case "Certified":
		case "Passed HPE DDQ":
		  return "Approved";
		case "Denied":
		case "Contract Terminated":
		case "3P Belongs to HPI":
		case "Business Prohibited":
		case "HPE Exiting Countries":
		case "3P Belongs to Microfocus":
		case "Out of Scope":
		  return "Denied";
		case "To Terminate":
		case "Pending":
		  return "Pending";
		default:
		  return "";
	  }
	},
	mergeProfiles: {
	  profileDelete: {
		Metadata: {},
		CustomFields: {},
		Notes:[],
		Attachements: [],
		Audit: []
	  },
	  retainProfile: '',
	  retainId: '',
	  eliminateId: '',
	  init: function(profileId, duplicatedObject) {
		mo.fn.modal.show({
		  ctaLabel: "Merge",
		  close: true,
		  closeLabel: "Cancel",
		  title: "Merge Duplicate Profiles",
		  class: "ark-modal",
		  content: '<section class="mergeProfiles-modal"></section>',
		  contentCallback: function() {
			var displayType = 'search';
			var holder = document.querySelector('.dxpModal .mergeProfiles-modal');
			//Find the company by Entry Id
			singleCompanyDetails.mergeProfiles._metadata(profileId, function(data) {
			  if(data) {
				if(typeof duplicatedObject == 'object') displayType = 'duplicate';
				singleCompanyDetails.mergeProfiles.retainProfile = data[0];
				singleCompanyDetails.mergeProfiles.retainId = data[0].EntryId;

				holder.innerHTML = singleCompanyDetails.mergeProfiles.template.init(singleCompanyDetails.mergeProfiles.retainProfile, displayType);													
				singleCompanyDetails.mergeProfiles.switchBackEvent(holder);						
				singleCompanyDetails.mergeProfiles.switchDirection.init(holder);		

				// If search

				if(displayType == 'search')  {
				  document.querySelector('.dxpModalCTA').style.display="none";
				  singleCompanyDetails.mergeProfiles.onInputEvent(holder);
				}
				else singleCompanyDetails.mergeProfiles.populateCompanies(holder, duplicatedObject);

				//hey
			  }
			});


			singleCompanyDetails.mergeProfiles.resetModal();
		  },
		  ctaCallback: function() {
			mo.fn.modal.hide();
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
			var idEliminate = singleCompanyDetails.mergeProfiles.chooseToEliminate();

			var cases = new Promise(function(resolve) {
			  var updateCases = [];
			  singleCompanyDetails.mergeProfiles._cases(idEliminate, function(cs) {
				if(cs && cs.length) {
				  for (let i = 0; i < cs.length; i++) {
					updateCases.push(singleCompanyDetails.mergeProfiles._updateCases(Number(cs[i].EntryId), singleCompanyDetails.mergeProfiles.retainId));
				  }
				  Promise.all(updateCases)
					.then(() => {
					resolve(cs);
				  })
				}
				else resolve(cs); 
			  });
			});

			var metadata = new Promise(function(resolve) {
			  singleCompanyDetails.mergeProfiles._metadata(idEliminate, function(mt) {
				resolve(mt);
			  });
			});

			var customFields = new Promise(function(resolve) {
			  var updateCustomFields = [];
			  singleCompanyDetails.mergeProfiles._customFields(idEliminate, function(cf) {
				//if(cf && cf.length) {
				//updateCustomFields.push(singleCompanyDetails.mergeProfiles._updateCustomFields(Number(cf[0].EntryId), singleCompanyDetails.mergeProfiles.retainId));
				//}
				resolve(cf);
			  });
			});

			var notes = new Promise(function(resolve) {
			  var updateNotes = [];
			  singleCompanyDetails.mergeProfiles._notes(idEliminate, function(nt) {
				if(nt && nt.length) {
				  for (let i = 0; i < nt.length; i++) {
					updateNotes.push(singleCompanyDetails.mergeProfiles._updateNotes(Number(nt[i].EntryId), singleCompanyDetails.mergeProfiles.retainId, nt[i].Note , idEliminate));
				  }
				  Promise.all(updateNotes)
					.then(() => {
					resolve(nt);
				  })
				}
				else resolve(nt); 
			  });
			});

			var attachements = new Promise(function(resolve) {
			  var updateAttachements = [];
			  singleCompanyDetails.mergeProfiles._attachements(idEliminate, function(at) {
				if(at && at.length) {
				  for (let i = 0; i < at.length; i++) {
					updateAttachements.push(singleCompanyDetails.mergeProfiles._updateAttachements(Number(at[i].EntryId), singleCompanyDetails.mergeProfiles.retainId, at[i].Description , idEliminate));
				  }
				  Promise.all(updateAttachements)
					.then(() => {
					resolve(at);
				  })
				}
				else resolve(at); 
			  });
			});

			var audit = new Promise(function(resolve) {
			  var updateAudit = [];
			  singleCompanyDetails.mergeProfiles._audit(idEliminate, function(au) {			
				if(au && au.length) {
				  for (let i = 0; i < au.length; i++) {
					updateAudit.push(singleCompanyDetails.mergeProfiles._updateAudit(Number(au[i].EntryId), singleCompanyDetails.mergeProfiles.retainId));
				  }
				  Promise.all(updateAudit)
					.then(() => {
					resolve(au);
				  })
				}
				else resolve(au);
			  });
			});

			Promise.all([cases, metadata, customFields, notes, attachements, audit]).then(function(data) {

			  singleCompanyDetails.mergeProfiles.profileDelete = {
				Cases:(data && data[0].length) ? JSON.stringify(data[0]) : '',
				Metadata: (data && data[1].length) ? JSON.stringify(data[1]) : '',
				CustomFields: (data && data[2].length) ? JSON.stringify(data[2]) : '',
				Notes: (data && data[3].length) ? JSON.stringify(data[3]) : '',
				Attachements: (data && data[4].length) ? JSON.stringify(data[4]) : '',
				Audit: (data && data[5].length) ? JSON.stringify(data[5]) : '',
				ProfileRemaining: singleCompanyDetails.mergeProfiles.retainId

			  }

			  singleCompanyDetails.addAuditLog("Merge Profiles",
											   'Eliminated profile: '+idEliminate +'. Remaining profile: ' +singleCompanyDetails.mergeProfiles.retainId,
											   util.Email(),
											   null,
											   singleCompanyDetails.mergeProfiles.retainId);

			  //Upload in merge profiles data
			  crud.create("4463", singleCompanyDetails.mergeProfiles.profileDelete, function(e) { 
				crud.destroy("4337", idEliminate, function(d) {				 				  
				  navigation.reset();
				  setTimeout(function() {
					singleCompanyDetails.init(singleCompanyDetails.mergeProfiles.retainId);
					mo.fn.overlay.hide();
				  }, 5000);

				});

			  });

			});


		  }
		});
	  },
	  resetModal: function() {
		document.querySelector('.dxpModalClose').addEventListener('click', function() {
		  document.querySelector('.dxpModalCTA').style.display = 'inline-block';
		});
		document.querySelector('.modalCloseButton').addEventListener('click', function() {
		  document.querySelector('.dxpModalCTA').style.display = 'inline-block';
		});

	  },
	  chooseToEliminate:function() {
		var id;
		var holder = document.querySelector('.dxpModal .mergeProfiles-modal');
		var left = holder.querySelector('.merge-profiles__left .profile-eliminate-reference');
		var right = holder.querySelector('.merge-profiles__right .profile-eliminate-reference');

		var input = document.querySelector('input[type=radio][name=profile]:checked').id;
		if(input == 'duplicate') {
		  id = right.getAttribute('data-pr-id');
		  singleCompanyDetails.mergeProfiles.retainId = left.getAttribute('data-pr-id');
		  singleCompanyDetails.mergeProfiles.eliminateId = right.getAttribute('data-pr-id');
		}
		else {
		  id = left.getAttribute('data-pr-id');
		  singleCompanyDetails.mergeProfiles.retainId = right.getAttribute('data-pr-id');
		  singleCompanyDetails.mergeProfiles.eliminateId = left.getAttribute('data-pr-id');
		}		
		return id;		
	  },
	  switchBackEvent: function(holder) {
		holder.querySelector('.merge-profiles__back').style.display = 'none';			
		holder.querySelector('.merge-profiles__back').addEventListener('click', function() {
		  holder.querySelector('.merge-profiles__searching-section').style.display="block";
		  holder.querySelector('.merge-profiles__details-right').innerHTML = '';
		  holder.querySelector('.merge-profiles__back').style.display= "none";
		  document.querySelector('.dxpModalCTA').style.display="none";
		});
	  },
	  switchDirection: {
		init: function(holder) {

		  holder.querySelectorAll('.merge-profiles__switch input[type="radio"]').forEach(function(el) {
			el.addEventListener('click', function(ev) {
			  if(ev.target.id == 'duplicate')  {
				holder.querySelector('.merge-profiles__right .merge-profiles__type').innerHTML = singleCompanyDetails.mergeProfiles.template._eliminateTemplate(singleCompanyDetails.mergeProfiles.eliminateId);
				holder.querySelector('.merge-profiles__left .merge-profiles__type').innerHTML = singleCompanyDetails.mergeProfiles.template._retainTemplate(singleCompanyDetails.mergeProfiles.retainId);

			  }
			  else  {
				holder.querySelector('.merge-profiles__left .merge-profiles__type').innerHTML =  singleCompanyDetails.mergeProfiles.template._eliminateTemplate(singleCompanyDetails.mergeProfiles.eliminateId);
				holder.querySelector('.merge-profiles__right .merge-profiles__type').innerHTML = singleCompanyDetails.mergeProfiles.template._retainTemplate(singleCompanyDetails.mergeProfiles.retainId);
			  }
			})
		  });
		}				
	  },
	  findDuplicates: {		
		init: function(value, callback, obj) {
		  var dataSource = searchOptions.profile.dataSource(singleCompanyDetails.mergeProfiles.findDuplicates._filter(value, obj));
		  dataSource.read().then(function() {
			var view = dataSource.view();
			if(callback && typeof callback =='function') callback(view);
		  });
		},
		_filter: function(val, obj) {
		  if(obj) {
			var ret;
			switch(obj.DuplicateField) {
			  case 'PartyId':
				ret =  {
				  field: "PartyId",
				  operator: "eq",
				  value: obj.PartyId
				};
				break;
			  case 'CompanyInfo':
				ret =  {
				  field: "CompanyName",
				  operator: "contains",
				  value: obj.CompanyName
				};
				break;
			  case 'SiebelId':
				ret = {
				  field: "SiebelID",
				  operator: "eq",
				  value: obj.SiebelId
				}
				break;
			}
			return ret;
		  }
		  return {	
			logic: 'or',
			filters: [
			  {
				field: "CompanyName",
				operator: "contains",
				value: val
			  },
			  {
				field: "PartyId",
				operator: "contains",
				value: val
			  },
			  {
				field: "SiebelID",
				operator: "contains",
				value: val
			  }
			]
		  }
		}
	  },
	  populateCompanies: function(holder, obj, value) {
		var list = holder.querySelector('.merge-profiles__profile-panel ul');
		list.innerHTML = '';

		singleCompanyDetails.mergeProfiles.findDuplicates.init(value, function(results) {

		  if((typeof obj == 'object' && results.length > 2) || !Object.values(obj).length) {

			document.querySelector('.dxpModalCTA').style.display="none";
			results.forEach(function(el, index) {
			  if(el.EntryId !== obj.FirstId && el.EntryId !== singleCompanyDetails.mergeProfiles.retainId) list.innerHTML+= `<li data-id="${index}">${el.CompanyName}</li>`;
			});

			list.addEventListener('click', function(evt) {
			  holder.querySelector('.merge-profiles__searching-section').style.display="none";
			  singleCompanyDetails.mergeProfiles.eliminatedIt = results[evt.target.getAttribute('data-id')].EntryId;
			  holder.querySelector('.merge-profiles__back').style.display= "block";
			  holder.querySelector('.merge-profiles__details-right').innerHTML = singleCompanyDetails.mergeProfiles.template.details(results[evt.target.getAttribute('data-id')]);
			  document.querySelector('.dxpModalCTA').style.display="inline-block";
			});
		  } else  {
			document.querySelector('.dxpModalCTA').style.display="inline-block";
			var resultObj = results[0].EntryId !== obj.FirstId ? results[0] : results[1];
			holder.querySelector('.merge-profiles__searching-section').innerHTML = '';
			holder.querySelector('.merge-profiles__details-right').innerHTML = singleCompanyDetails.mergeProfiles.template.details(resultObj);
		  }
		}, obj);


	  },
	  onInputEvent : function(holder) {
		holder.querySelector('.merge-profiles__search').addEventListener('keyup', util.debounce(function(event) {			
		  singleCompanyDetails.mergeProfiles.populateCompanies(holder, false, event.target.value);
		}, 400));
	  },
	  _metadata: function(id, callback) {
		crud.read("4079", "eid=" + id, function(resp) {			  	
		  callback(resp.Rows);
		});
	  },
	  _customFields: function(id, callback) {
		crud.read("4011", "eid=" + id, function(resp) {
		  callback(resp.Rows);
		});
	  },
	  _cases: function(id, callback) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server+"form/data-set-provider/v2/1275/ARK_Company_Cases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverFiltering: true,
		  filter: {
			logic: "and",
			filters: [{
			  field: "CompanyFK",
			  operator: "eq",
			  value: id
			},
					 ]
		  }
		});
		ds.read().then(function() {
		  var data = ds.view();
		  console.log(data);
		  debugger;
		  callback(data);
		});
	  },
	  _notes: function(id, callback) {
		crud.read("4016", "cfk=" + id, function(resp) {	
		  callback(resp.Rows);
		});
	  },	  
	  _attachements: function(id, callback) {
		crud.read("4020", "cfk=" + id, function(resp) {	
		  callback(resp.Rows);
		});
	  },
	  _audit: function(id, callback) {
		crud.read("4018", "cfk=" + id, function(resp) {	
		  callback(resp.Rows);
		});
	  },
	  _updateNotes: function(id, retainCompanyFk, note, eliminatedCompany) {
		if(id && retainCompanyFk) {
		  return new Promise(function(resolve) {
			crud.update("4470", id, { CompanyFK:  retainCompanyFk, Note: 'Merged from '+eliminatedCompany +'. \n ' + note}, function() {
			  resolve();
			});
		  });
		} else Promise.resolve();
	  },
	  _updateCustomFields: function(id, retainCompanyFk) {
		if(id && retainCompanyFk) {
		  return new Promise(function(resolve) {
			crud.update("4010", id, { CompanyFK:  retainCompanyFk}, function() {
			  resolve();
			});
		  });
		} else Promise.resolve();
	  },
	  _updateCases: function(id, retainCompanyFk) {
		if(id && retainCompanyFk) {
		  return new Promise(function(resolve) {
			crud.update("3693", id, { CompanyFK:  retainCompanyFk}, function() {
			  resolve();
			})
		  });
		} else Promise.resolve();
	  },
	  _updateAttachements: function(id, retainCompanyFk, note, eliminatedCompany) {
		if(id && retainCompanyFk) {
		  return new Promise(function(resolve) {
			crud.update("4471", id, { CompanyFK:  retainCompanyFk, Description: 'Merged from '+eliminatedCompany +'. \n ' + note}, function() {
			  resolve();
			});
		  });
		} else Promise.resolve();
	  },
	  _updateAudit: function(id, retainCompanyFk) {
		if(id && retainCompanyFk) {
		  return new Promise(function(resolve) {
			crud.update("4472", id, { CompanyFK:  retainCompanyFk}, function() {
			  resolve();
			});
		  });
		} else Promise.resolve();
	  },
	  template: {
		init: function(data, switchValue) {
		  return `
<section class="merge-profiles">
<div class="merge-profiles__header">
<div class="merge-profiles__desc">
<p>Use this facility to eliminate a duplicate profile. It moves records from the profile that is being eliminated into the profile that is retained and then deletes the one marked for elimination.<a href="#">This action is not reversible.</a>
  </div>
<div class="merge-profiles__switch">
<p>Choose which Profile to eliminate:</p>
<div>
<input type="radio" id="current" name="profile">
<label for="current">Current Profile(left)</label>
  </div>
<div>
<input type="radio" id="duplicate" name="profile" checked>
<label for="dupliacte">Duplicate Profile(right)</label>
  </div>
  </div>
  </div>
<div class="merge-profiles__body">
<div class="merge-profiles__left">
<div class="merge-profiles__type">
<div class="merge-profiles__type__retain">
<h3>Retain this Profile</h3>
  </div>
  </div>
<h6>Current Profile</h6>
<div class="merge-profiles__left__content">
${singleCompanyDetails.mergeProfiles.template.details(data)}
  </div>
  </div>
<div class="merge-profiles__right">
<div class="merge-profiles__type">
<div class="merge-profiles__type__eliminate">
<h3>Eliminate this Profile</h3>
  </div>
  </div>
<h6>Duplicate Profile</h6>
<div class="merge-profiles__searching-section">
${singleCompanyDetails.mergeProfiles.template.switchTemplate(switchValue)}
  </div>
<div class="merge-profiles__details-right"></div>
<a class="merge-profiles__back"> <Change Profile </a>
  </div>
  </section>`;
		},
		switchTemplate:function(whichOne, data) {
		  var ret;
		  switch(whichOne) {
			case 'details':
			  ret =  singleCompanyDetails.mergeProfiles.template.details(data);
			  break;
			case 'search':
			  ret = singleCompanyDetails.mergeProfiles.template.search();
			  break;
			case 'duplicate':
			  ret = singleCompanyDetails.mergeProfiles.template.displayDuplicates();
		  }
		  return ret;
		},
		details: function(data) {
		  return `<div class="profile-eliminate-reference" data-pr-id="${data.EntryId || data.FirstId || ''}" > <h5>${data.CompanyName || ''}</h5>
<div class="item"><span>Profile #:</span> <p class="prr">${data.EntryId || data.FirstId || ''}</p></div>
<div class="item"><span>Alt. Trade Name(s):</span> <p class="prr">${data.TradingCompanyName || ''}</p></div>
<div class="item"><span>City:</span> <p class="prr">${data.City || ''}</p></div>
<div class="item"><span>State:</span> <p class="prr">${data.State || ''}</p></div>
<div class="item"><span>Country:</span> <p class="prr">${data.Country || ''}</p></div>
<div class="item"><span>Region:</span> <p class="prr">${data.Region || ''}</p></div>
<div class="item"><span>Department:</span> <p class="prr"></p></div>
<div class="item"><span>Internal code:</span> <p class="prr">New URL Request</p></div>
<div class="item"><span>Profile type:</span> <p class="prr">Third Party</p></div>
<div class="item"><span>Party Id:</span> <p class="prr">${data.PartyId || ''}</p></div>
<div class="item"><span>Siebel Id:</span> <p class="prr">${data.SiebelId || ''}</p></div>
<div class="item"><span>Category:</span> <p class="prr">${data.ConfigName || ''}</p></div>
<div class="item"><span>Created:</span> <p class="prr">${data.Created || ''}</p></div>
  </div>`  
		},
		search: function() {
		  return `		  
<div class="merge-profiles__search">
<label>1. Search for company name:</label>
<input type="text" />
  </div>
<div class="merge-profiles__select-profile">
<label>2. Select duplicate profile from results below:</label>
<section class="merge-profiles__profile-panel">
<ul></ul>
  </section>
  </div>
`;
		},
		displayDuplicates: function() {
		  return `		  
<div class="merge-profiles__select-profile">
<label>1. Select duplicate profile from results below:</label>
<section class="merge-profiles__profile-panel">
<ul></ul>
  </section>
  </div>
`;

		},
		_eliminateTemplate: function() {
		  return `<div class="merge-profiles__type__eliminate">
<h3>Eliminate this Profile</h3>
  </div>
`;
		},
		_retainTemplate: function() {
		  return ` <div class="merge-profiles__type__retain">
<h3>Retain this Profile</h3>
  </div>
`;
		}
	  },

	},
	mdmPartyIdCompare: {
	  init: function(pid) {
		if(!pid) return ;
		singleCompanyDetails.mdmPartyIdCompare.getInfo(pid, function(res) {

		  if(res[0].organizationAlternateName && res[0].organizationAlternateName.length) {
			if(singleCompanyDetails.holder()) {
			  var name = singleCompanyDetails.holder().querySelector('.mdm-alternate-name');
			  singleCompanyDetails.mdmPartyIdCompare.alternateName.init(name, res[0].organizationAlternateName);
			}
		  }	
		  if(res[0].externalIdentifier && res[0].externalIdentifier.length) {
			if(singleCompanyDetails.holder()) {
			  var taxReg = singleCompanyDetails.holder().querySelector('.mdm-tax-reg');
			  singleCompanyDetails.mdmPartyIdCompare.taxReg.init(taxReg, res[0].externalIdentifier);
			}
		  }	
		  if(res[0].electronicCommunication && res[0].electronicCommunication.length) {
			if(singleCompanyDetails.holder()) {
			  var websites = singleCompanyDetails.holder().querySelector('.mdm-websites');
			  singleCompanyDetails.mdmPartyIdCompare.websites.init(websites, res[0].electronicCommunication);
			}
		  }	
		  if(res[0].phoneFax && res[0].phoneFax.length) {
			if(singleCompanyDetails.holder()) {
			  var phoneFax = singleCompanyDetails.holder().querySelector('.mdm-phone-fax');
			  singleCompanyDetails.mdmPartyIdCompare.phoneFax.init(phoneFax, res[0].phoneFax);
			}
		  }	
		  if(res[0].countryCode && res[0].countryCode.length) {
			if(singleCompanyDetails.holder()) {
			  var countryCode = singleCompanyDetails.holder().querySelector('.mdm-country-code');
			  singleCompanyDetails.mdmPartyIdCompare.countryCode.init(countryCode, res[0].countryCode);
			}
		  }	
		  if(res[0].address && res[0].address.length) {
			if(singleCompanyDetails.holder()) {
			  var address = singleCompanyDetails.holder().querySelector('.mdm-address');
			  singleCompanyDetails.mdmPartyIdCompare.insertListener(address, function() {
				singleCompanyDetails.mdmPartyIdCompare.adresses.init(res[0].address);
			  });
			}
		  }		
		});
	  },
	  getInfo:function(pid, callback) {		  
		hpe.data.xref(pid, function(d){
		  if(d && d.party && d.party.length) {
			callback(d.party); 
		  }
		});
	  },
	  insertListener: function(holder, callback) {
		holder.innerHTML += `
<a class="mdm-view" >
<svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path>
  </svg>
  </a>
` ;

		holder.querySelector('.mdm-view').addEventListener('click', function() {
		  callback();
		});
	  },
	  adresses:  {
		template: function(d, index) {
		  return '<section>'+
			'<h4>Address ' + index + ' ' + '(' + d.addressType + ')' +'</h4>' +
			'<div class="item"><span>Address 1:</span>' +
			' <p class="prr">' + (d.addressLine1 || '-') + '</p>' +
			'</div>' +
			'<div class="item"><span>Address 2:</span>' +
			' <p class="prr">' + (d.addressLine2 || '-') + '</p>' +
			'</div>' +
			'<div class="item"><span>City:</span>' +
			' <p class="prr">' + (d.cityName || '-') + '</p>' +
			'</div>' +
			'<div class="item"><span>Country:</span>' +
			' <p class="prr">' + (d.countryName || '-') + '</p>' +
			'</div>' +
			'<div class="item"><span>State/Province:</span>' +
			' <p class="prr">' + (d.stateProvince || '-') + '</p>' +
			'</div>' +
			'<div class="item"><span>Postcode:</span>' +
			' <p class="prr">' + (d.stdPostalCode || '-') + '</p>' +
			'</div>'+
			'</section>';
		},
		init: function(data) {
		  mo.fn.modal.show({
			ctaLabel: "Close",
			class: "ark-modal",
			title:  "EMDM Data by Party ID",
			content: '<div class="mdm-modal mdm-info" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {

			  document.querySelector('.dxpModal').style.maxWidth="1180px";
			  var holder = document.querySelector('.mdm-modal');
			  data.forEach(function(d, index) {
				holder.innerHTML += singleCompanyDetails.mdmPartyIdCompare.adresses.template(d, index+1);
			  });
			}
		  });
		}
	  },
	  alternateName:  {
		template: function(holder, data) {
		  var dt = '';
		  data.forEach(function(el) {
			if(el.status == 'ACTIVE') {
			  dt+=el.organizationAlternateName + '</br>'
			}
		  });
		  return holder.insertAdjacentHTML('beforeend',`<div class="tooltipMess"><div class="tooltipMessWrapper"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path>
  </svg><span class="tooltiptext">${dt}</span></div><div>`);
		},
		init: function(holder, data) {
		  singleCompanyDetails.mdmPartyIdCompare.alternateName.template(holder, data);
		}
	  },
	  taxReg:  {
		template: function(holder, data) {
		  var dt = '';
		  data.forEach(function(el) {
			if(el.status == 'ACTIVE') {
			  dt+=el.identifierValue + '</br>'
			}
		  });
		  return holder.insertAdjacentHTML('beforeend',`<div class="tooltipMess"><div class="tooltipMessWrapper"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path>
  </svg><span class="tooltiptext">${dt}</span></div><div>`);
		},
		init: function(holder, data) {
		  singleCompanyDetails.mdmPartyIdCompare.taxReg.template(holder, data);
		}
	  },
	  websites:  {
		template: function(holder, data) {
		  var dt = '';
		  data.forEach(function(el) {
			if(el.electronicCommunicationTypeName == 'Website' && el.status == 'ACTIVE') {
			  dt+=el.value + '</br>'
			}
		  });
		  return holder.insertAdjacentHTML('beforeend',`<div class="tooltipMess"><div class="tooltipMessWrapper"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path>
  </svg><span class="tooltiptext">${dt}</span></div><div>`);
		},
		init: function(holder, data) {
		  singleCompanyDetails.mdmPartyIdCompare.websites.template(holder, data);
		}
	  },
	  phoneFax:  {
		template: function(holder, data) {
		  var dt = '';
		  data.forEach(function(el) {
			if(el.phoneFaxTypeName == 'Phone number' && el.status == 'ACTIVE') {
			  dt+=el.phoneFaxNumber + '</br>'
			}
		  });
		  return holder.insertAdjacentHTML('beforeend',`<div class="tooltipMess"><div class="tooltipMessWrapper"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path>
  </svg><span class="tooltiptext">${dt}</span></div><div>`);
		},
		init: function(holder, data) {
		  singleCompanyDetails.mdmPartyIdCompare.phoneFax.template(holder, data);
		}
	  },
	  countryCode:  {
		template: function(holder, data) {
		  var dt =  reference.convertCountry(data);
		  return holder.insertAdjacentHTML('beforeend',`<div class="tooltipMess"><div class="tooltipMessWrapper"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit">
<path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path>
  </svg><span class="tooltiptext">${dt}</span></div><div>`);
		},
		init: function(holder, data) {
		  singleCompanyDetails.mdmPartyIdCompare.countryCode.template(holder, data);
		}
	  },
	}
  };
</script>

<!--INVITATION DETAILS -->
<script>
  const invitationDetails = {
	holder: function() {
	  return document.querySelector('#navigation #invitation-details:last-child')
	},
	html: function() {
	  return "<div id='invitation-details'>" +
		"<section class='company_info'></section>" +
		"<section class='i_grid'><h4 class='invitation_config_name'></h4><div class='invitation-grid'></div><div class='toolbar'></div></section>" +
		"</div>";
	},
	_filter: null,
	init: function(data, company) {
	  navigation.push(invitationDetails.html());
	  mo.fn.overlay.show({
		close: false,
		loading: true
	  });

	  //companyDetails.resetInvitation();
	  invitationDetails.holder().querySelector(".invitation_config_name").innerHTML = data.ConfigName;
	  invitationDetails._filter = companyAPI2.companyConfigOverviewKendoFilter(company, data.ConfigId);
	  invitationDetails.grid._load(invitationDetails.holder().querySelector(".invitation-grid"), invitationDetails.dataSource(invitationDetails._filter), invitationDetails._columns(), true, data);
	  invitationDetails.invitationListener(invitationDetails.holder().querySelector(".i_grid"));
	  mo.fn.overlay.hide();

	},
	dataSource: function(filter) {
	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1284/ARK_Overview/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		pageSize: 15,
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,
		/* set default sort */
		sort: {
		  field: "EntryId",
		  dir: "desc"
		}

	  });

	},
	_columns: function() {
	  var cusConfig = [{
		field: "InvitationFK",
		title: "Id",
		hidden: false,
		width: "100px",
		locked: true
	  },
					   {
						 field: "ConfigVersion",
						 title: "Intake form version",
						 hidden: false,
						 width: "200px",
						 locked: true,
						 headerAttributes: {
						   style: "white-space: normal"
						 },
					   },
					   {
						 field: "GlobalStatus",
						 title: "Status",
						 hidden: false,
						 width: "150px",
						 template: function(d) {
						   return invitation.manageStatus(d.GlobalStatus);
						 }
					   },
					   {
						 field: "RiskRank",
						 title: "Risk Rank",
						 hidden: false,
						 width: "200px"
					   },
					   {
						 field: "Expiry",
						 title: "Expiry",
						 hidden: false,
						 width: "150px",
						 template: function(d) {
						   //return beautify date
						   return util.getDate(d.Expiry)
						 }
					   },
					   {
						 field: "RequestedBy",
						 title: "Requestor",
						 hidden: false,
						 width: "150px"
					   },
					   {
						 field: "SubmitterEmail",
						 title: "Submitter",
						 hidden: false,
						 width: "150px"
					   },
					   {
						 title: "",
						 width: "75px",
						 locked: true,
						 hidden: false,
						 attributes: {
						   "class": "cta"
						 },
						 template: function(d) {
						   var icons = '<a class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
						   return icons;
						 }
					   }
					  ];
	  return cusConfig;
	},
	grid: {
	  _default: function() {
		var defConfig = [];
		//console.log(search.data);
		var keys = Object.keys(search.data[0]);

		for (i = 0; i < keys.length; i++) {
		  var key = keys[i];
		  var obj = {};
		  obj.field = key;
		  obj.title = key;
		  obj.hidden = false;
		  obj.filterable = true;
		  obj.width = "250px";
		  obj.attributes = {
			style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
		  };
		  if (key == "en_US")
			defConfig.unshift(obj);
		  else
			defConfig.push(obj);
		}
		return defConfig;
	  },
	  _load: function(selector, datasource, config, toolbar, invitation_data) {


		if ($(selector).data("kendoGrid")) {
		  $(selector).data("kendoGrid").setDataSource(datasource);
		  $(selector).data("kendoGrid").dataSource.sync();

		} else {
		  //IF INVITATION HAS ACTIVE STATUS 1 THEN HIDE THE TOOLBAR

		  var toolbar = [{
			name: "send_invitation" + selector.className.split(' ')[0],
			text: "Send invitation"
		  }];


		  $(selector).kendoGrid({
			height: 500,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			toolbar: toolbar,
			dataSource: datasource,
			columns: config,
			dataBound: function(e) {},
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true
		  });

		  if (toolbar) {
			invitationDetails.holder().querySelector('.toolbar').innerHTML = '';
			$(invitationDetails.holder().querySelector('.k-grid-toolbar')).appendTo('.toolbar');

			if (invitationDetails.holder().querySelector("a[class*='k-grid-send_invitation'"))
			  invitationDetails.holder().querySelector("a[class*='k-grid-send_invitation'").addEventListener("click", function(e) {
				singleCompanyDetails.sendInvitation.init();
				e.stopImmediatePropagation();
			  });

		  }
		}


		var toolbar = invitationDetails.holder().querySelector('.k-grid-toolbar');
		if (invitation_data && !invitation_data.ActiveInvitations)
		  toolbar.classList.remove("hidden")
		else toolbar.classList.add("hidden")

	  }
	},
	invitationListener: function(selector) {
	  $(selector).delegate('.view_invitation', 'click', function(ev) {
		var grid = $(selector).find('.invitation-grid').data("kendoGrid");
		var row = grid.dataItem($(this).closest("tr"));
		invitation.invitationOverview.init(row.InvitationFK, invitationDetails.holder().querySelector('.company_invitation_info'));
	  });
	},
  };
</script>

<!--MULTIPLE COMPANIES DETAILS -->
<script>
  const multipleCompaniesDetails = {
	holder: function() {
	  return document.querySelector('#navigation #multiple-companies:last-child')
	},
	html: function() {
	  return "<section id='multiple-companies'><div class='multi-companies-grid'></div></section>";
	},
	data: {},
	init: function(companies) {

	  navigation.push(multipleCompaniesDetails.html());

	  if (companies[0].EntryId)
		multipleCompaniesDetails.grid._genLoad(multipleCompaniesDetails.holder().querySelector('.multi-companies-grid'), companies, multipleCompaniesDetails._CTIDcolumns());
	  else multipleCompaniesDetails.grid._genLoad(multipleCompaniesDetails.holder().querySelector('.multi-companies-grid'), companies, multipleCompaniesDetails._Ecolumns());
	  mo.fn.overlay.hide();
	},
	_CTIDcolumns: function() {
	  var cusConfig = [{
		field: "EntryId",
		title: "Profile #",
		hidden: false,
		width: "140px",
		locked: true
	  },
					   {
						 field: "CompanyName",
						 title: "Company Name",
						 hidden: false,
						 width: "200px",
						 locked: true,
						 headerAttributes: {
						   style: "white-space: normal"
						 },
					   },
					   {
						 field: "LegacyId",
						 title: "Securimate Id",
						 hidden: false,
						 width: "170px",
					   },
					   {
						 field: "InternalOwner",
						 title: "Internal Owner",
						 hidden: false,
						 width: "200px",
					   },
					   {
						 field: "Region",
						 title: "Region",
						 hidden: false,
						 width: "150px",
					   },
					   {
						 field: "CountryName",
						 title: "Country",
						 hidden: false,
						 width: "180px",
						 /*template: function(d) {
                            return reference.convertCountry(d.Country) || "";
                          }*/
					   },
					   {
						 field: "Category",
						 title: "Category",
						 hidden: false,
						 width: "200px"
					   },
					   {
						 field: "ConfigName",
						 title: "Intake Form",
						 hidden: false,
						 width: "200px"
					   },
					   {
						 field: "SiebelID",
						 title: "Siebel ID",
						 hidden: false,
						 width: "150px",
					   },
					   {
						 field: "PartyId",
						 title: "Party ID",
						 hidden: false,
						 width: "150px",
					   },
					   {
						 field: "City",
						 title: "City",
						 hidden: false,
						 width: "180px",
					   },
					   {
						 field: "Address1",
						 title: "Address 1",
						 hidden: false,
						 width: "200px",
					   },
					   {
						 field: "EmailAddress",
						 title: "Contact Email",
						 hidden: false,
						 width: "200px",
						 headerAttributes: {
						   style: "white-space: normal"
						 },
					   },
					   {
						 field: "Name",
						 title: "Contact Name",
						 hidden: false,
						 width: "180px"
					   },
					   {
						 field: "Website",
						 title: "Website",
						 hidden: false,
						 width: "180px"
					   },
					   {
						 field: "TaxId",
						 title: "Tax Id / Registration Number",
						 hidden: false,
						 width: "180px",
						 headerAttributes: {
						   style: "white-space: normal"
						 },
					   },
					   {
						 field: "TradingCompanyName",
						 title: "Trading Company Name",
						 hidden: false,
						 width: "180px",
						 headerAttributes: {
						   style: "white-space: normal"
						 },
					   },
					   {
						 field: "Created",
						 title: "Created",
						 hidden: false,
						 width: "180px",
						 template: function(d) {
						   return util.getDate(d.Created) || "";
						 }
					   },
					   {
						 title: "",
						 width: "100px",
						 locked: true,
						 hidden: false,
						 attributes: {
						   "class": "cta"
						 },
						 template: function(d) {
						   var icons = '<a class="multiple_companies"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
						   return icons;
						 }
					   }
					  ];
	  return cusConfig;
	},
	_Ecolumns: function() {
	  var cusConfig = [{
		field: "CompanyName",
		title: "Name",
		hidden: false,
		// width: "200px",
	  },
					   {
						 field: "PartyId",
						 title: "Party ID",
						 hidden: false,
						 width: "150px"
					   },
					   {
						 field: "CountryEntity",
						 title: "Country Entity",
						 hidden: false,
						 width: "170px"
					   },
					   {
						 field: "DunsId",
						 title: "Duns Id",
						 hidden: false,
						 width: "150px"
					   },
					   {
						 title: "",
						 width: "75px",
						 hidden: false,
						 attributes: {
						   "class": "cta"
						 },
						 template: function(d) {
						   var icons = '<a class="view_details"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M1,2 L23,2 L23,9 L1,9 L1,2 Z M4,12 L5,12 L5,13 L4,13 L4,12 Z M4,5 L5,5 L5,6 L4,6 L4,5 Z M4,19 L5,19 L5,20 L4,20 L4,19 Z M1,16 L23,16 L23,23 L1,23 L1,16 Z M1,9 L23,9 L23,16 L1,16 L1,9 Z"></path></a>';
						   return icons;
						 }
					   }
					  ];
	  return cusConfig;
	},
	grid: {
	  _default: function() {
		var defConfig = [];
		var keys = Object.keys(search.data[0]);

		for (i = 0; i < keys.length; i++) {
		  var key = keys[i];
		  var obj = {};
		  obj.field = key;
		  obj.title = key;
		  obj.hidden = false;
		  obj.filterable = true;
		  obj.width = "250px";
		  obj.attributes = {
			style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
		  };
		  if (key == "en_US")
			defConfig.unshift(obj);
		  else
			defConfig.push(obj);
		}
		return defConfig;
	  },
	  _genLoad: function(selector, data, config, toolbar, invitation_data) {

		var detailInit = null;
		//if from the external search
		if (!data[0].EntryId)
		  detailInit = function(e) {

			var variations = e.data.variations;

			//INIT DETAIL GRID
			var gridVar = $("<div/>").appendTo(e.detailCell);
			gridVar.kendoGrid({
			  dataSource: new kendo.data.DataSource({
				data: variations,
				schema: {
				  model: {
					id: "EntryId"
				  }
				}
			  }),
			  scrollable: false,
			  sortable: false,
			  pageable: false,
			  columns: [{
				field: "TaxId",
				title: "Tax ID",
				hidden: false,
				width: "150px"
			  },
						{
						  field: "Country",
						  title: "Country",
						  hidden: false,
						  width: "200px",
						  template: function(d) {
							return reference.convertCountry(d.Country);
						  }
						},
						{
						  field: "Address",
						  title: "Address",
						  hidden: false,
						  //width: "500px"
						},
						{
						  field: "AddressId",
						  title: "Address Id",
						  hidden: false,
						  width: "150px"
						},
						{
						  title: "",
						  width: "75px",
						  hidden: false,
						  attributes: {
							"class": "cta"
						  },
						  template: function(d) {
							var icons = '<a class="multiple_companies"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>';
							return icons;
						  }
						}
					   ],
			  editable: false
			});

			gridVar.on("click", ".multiple_companies", function(e) {

			  var grid = $(gridVar).data("kendoGrid");
			  var childRow = grid.dataItem($(this).closest("tr"));

			  var gridParent = $(selector).data("kendoGrid");
			  var row = gridParent.dataItem(grid.wrapper.closest("tr").prev()[0]);

			  multipleCompaniesDetails.viewCompany(row, childRow);
			});


		  };

		$(selector).kendoGrid({
		  height: 500,
		  noRecords: {
			template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
		  },
		  // toolbar: inviteButton,
		  dataSource: data,
		  columns: config,
		  dataBound: function(e) {},
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  detailInit: detailInit
		});

		$(selector).delegate(".multiple_companies", "click", function(e) {

		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  multipleCompaniesDetails.viewCompany(row);
		});

		/*$(selector).delegate(".view_details", "click", function(e) {

                                var grid = $(selector).data("kendoGrid");
                                var row = grid.dataItem($(this).closest("tr"));
                                partyIdDetails.init(row.PartyId ,row.RAW);
                              });*/
	  }
	},
	viewCompany: function(row, childRow) {

	  //IF A COMPANY EXISTS UPDATE THE DATA AND SHOW DETAILS
	  if (row.EntryId)
		search.viewCompany(row.EntryId);
	  //IF A COMPANY DOES NOT EXIST, CREATE IT AND THEN SHOW DETAILS
	  else {
		mo.fn.overlay.show({
		  close: false,
		  loading: true
		});
		companyAPI2.createorUpdateCompany(row.toJSON(), childRow.toJSON(), function(response) {
		  if (response.error)
			mo.fn.modal.show({
			  ctaLabel: "OK",
			  class: "ark-modal",
			  title: "Can not create a company",
			  content: "<p>Error: " + response.error + "</p>"
			});
		  else {
			mo.fn.overlay.hide();
			search.viewCompany(response.EntryId);
		  }

		});

	  }

	}
  };
</script>

<!--NAVIGATION SEARCH -->
<script>
  const navigationSearch = {
	holder: function() { //identifier
	  return document.querySelector('#navigation #navigationSearch')
	},
	html: function() { // where we store data
	  return "<div id='navigationSearch'>" +
		"<section class='company_not_found'>" +
		'<center><h2>Company not found</h2>' +
		'<p>We were unable to find any company using the information provided.<br>' +
		' <a href="#" class="initSearch k-button k-button-big k-button-icontext k-grid-add" style="width:170px;margin-top:20px" >External Search</a>' +
		'</center></section>' +
		"</div>";
	},
	init: function() {
	  document.querySelector('#navigationSearch').addEventListener('click', function(ev) {
		navigationSearch.eventListener();
	  });
	},
	notFound: function() {
	  navigation.push(navigationSearch.html());
	  navigationSearch.initSearchSection();
	},
	initSearchSection: function() {
	  navigationSearch.holder().querySelector('.initSearch').addEventListener('click', function() {
		search.init();
	  });
	},
	eventListener: function() {
	  mo.fn.overlay.show({
		loading: true
	  });
	  var inputSearch = document.querySelector('#search-input-nav').value;
	  if(!inputSearch || inputSearch.length == 0) {
		mo.fn.modal.show({
		  ctaLabel: "Ok",
		  class: "ark-modal",
		  title: "Empty filter",
		  content: "Please Specify a search string."
		});
	  }

	  companyAPI2.internalSearch(inputSearch, function(response) {
		if (response.error || response.length == 0) {
		  navigationSearch.notFound();
		  mo.fn.overlay.hide();
		} else {

		  var dt = response;
		  if (dt && dt.length == 1) {

			singleCompanyDetails.init(dt[0].EntryId);

		  } else if (dt && dt.length > 1) {
			//search.multipleCompanies.init(dt, searchArgs);
			multipleCompaniesDetails.init(dt);
		  }
		  mo.fn.overlay.hide();
		  document.querySelector('#search-input-nav').value = '';
		}
	  });

	}
  }
</script>

<!-- SEARCH MODULE -->
<script>
  const search = {
	holder: function() { //identifier
	  return document.querySelector('#searchBar'); //navigation #search:last-child
	},
	html: function() { // where we store data
	  return "<div id='search'>" +
		"<div id='search-container'>" +
		"<h4>Quick Search</h4>" +
		"<div style='' class='search-tabs'></div>" +
		"<section style='' class='filter_group'><div class='filter'></div><a href='#' id='search-company-btn' class='search_company disabled k-button k-button-big k-button-icontext k-grid-add'>Search</a></section>" +
		"<div class='content_wrapper'>" +
		"<section class='company_not_found hidden'></section>" +
		"<section class='m_grid hidden'><div class='multi-companies-grid'></div></section>" +
		"</div></div>" +
		"<section class='company_details hidden'></section>" +
		"<section class='recently-searched-section'>" +
		"<div class='recently-searched-title'><h4>Recently Searched</h4>" +
		'<span class="title-icon title-icon-down"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret down" width="15px" height="15px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 8 12 20 2 8"></polygon></svg></span>' +
		'<span class="title-icon title-icon-up title-icon-hidden"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret up" width="15px" height="15px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 4 12 16 2 4" transform="matrix(1 0 0 -1 0 20)"></polygon></svg></span>' +
		"</div>" +
		"<div style='display:none;' id='recently-searched'></div>" +
		"</section>" +
		"<section class='recently-viewed-section'>" +
		"<div class='recently-viewed-title'><h4>Recently Viewed</h4>" +
		'<span class="title-icon title-icon-down"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret down" width="15px" height="15px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 8 12 20 2 8"></polygon></svg></span>' +
		'<span class="title-icon title-icon-up title-icon-hidden"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret up" width="15px" height="15px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 4 12 16 2 4" transform="matrix(1 0 0 -1 0 20)"></polygon></svg></span>' +
		"</div>" +
		"<div style='margin-bottom: 15px;display:none;' id='recently-viewed'></div>" +
		"</section>" +
		"</div>";
	},
	init: function() {

	  search.holder().innerHTML = search.html();
	  const searchBarOffset = search.holder().offsetTop + 10;
	  window.onscroll = function() {
		if (window.pageYOffset > searchBarOffset) {
		  search.holder().classList.add("sticky");
		} else {
		  search.holder().classList.remove("sticky");
		}
	  };

	  //  navigation.push(search.html()); //adding to the navigation and display           
	  search.ui();
	  recentlySearched.show(function() {
		recentlyViewed.show(function() {
		  mo.fn.overlay.hide();
		});
	  });
	},
	countries: {
	  all: [],
	  options: [],
	  values: [],
	},

	_hardRefresh: function() {
	  search.holder().querySelector('#search .content_wrapper').innerHTML = "<section class='company_not_found hidden'></section>" +
		"<section class='m_grid hidden'><div class='multi-companies-grid'></div></section>";
	},
	ui: function() {
	  mo.fn.overlay.show({
		close: false
	  });


	  hpe.ui.tabs({
		dom: search.holder().querySelector(".search-tabs"),
		tabs: [
		  {
			label: "Profile search",
			id: "profile-search"
		  },
		  {
			label: "Case search",
			id: "case-search"
		  },
		  {
			label: "External Search",
			id: "external-search"
		  },


		]
	  }, function(all) {
		search.profileSearch.init(all[0]);
		search.caseSearch.init(all[1]);
		search.externalSearch.init(all[2]);

	  });

	  search.holder().querySelector('#searchBar .tabs').addEventListener('click', function(ev) {
		switch (ev.target.getAttribute('tab-id')) {
		  case 'profile-search':
			const profileSearchField = search.holder().querySelector('[tab-id="' + ev.target.getAttribute('tab-id') + '"] [data-name="search"]');
			const profileTypeField = search.holder().querySelector('[tab-id="' + ev.target.getAttribute('tab-id') + '"] [data-name="profileType"]');
			if (!profileSearchField.value || !profileTypeField.value || profileTypeField.value == 'Select one') {
			  search.holder().querySelector('#search-company-btn').classList.add('disabled');
			} else {
			  search.holder().querySelector('#search-company-btn').classList.remove('disabled');
			}

			break;
		  case 'case-search':
			const caseSearchField = search.holder().querySelector('[tab-id="' + ev.target.getAttribute('tab-id') + '"] [data-name="search"]');
			const caseTypeField = search.holder().querySelector('[tab-id="' + ev.target.getAttribute('tab-id') + '"] [data-name="caseType"]');
			if (!caseSearchField.value || !caseTypeField.value || caseTypeField.value == 'Select one') {
			  search.holder().querySelector('#search-company-btn').classList.add('disabled');
			} else {
			  search.holder().querySelector('#search-company-btn').classList.remove('disabled');
			}

			break;
		  case 'external-search':
			search.holder().querySelector('input[data-name="PartyId"]').value = '';
			search.holder().querySelector('input[data-name="TaxId"]').value = '';
			search.holder().querySelector('input[data-name="Email"]').value = '';
			search.holder().querySelector('#search-company-btn').classList.add('disabled');

			break;
		}
	  });

	  search.holder().querySelector('.search_company').addEventListener('click', function(ev) {
		if (search.holder().querySelector('.search_company').classList.contains('disabled')) {
		  return;
		}

		mo.fn.overlay.show({
		  close: false
		});
		let valid = true;

		search.holder().querySelectorAll('.search-tabs .container [tab-id]').forEach(function(el) {
		  switch (el.getAttribute('tab-id')) {
			case 'profile-search':
			  if (el.classList.contains('active')) {
				var select = el.querySelector('select').value;
				var searchString = el.querySelector('input[type="text"]').value;
				var selectedIndex = el.querySelector('select').selectedIndex;
				recentlySearched.new = {
				  Type: select,
				  Parameter: searchString,
				  SearchType: el.getAttribute('tab-id').split("-", 1)[0],
				};

				var filter = {
				  logic: "or",
				  filters: selectedIndex ? [{
					field: select,
					operator: "contains",
					value: searchString
				  }] : [],
				};

				if(select == "CompanyName") {
				  filter.filters.push({
					field: "TradingCompanyName",
					operator: "contains",
					value: searchString
				  });
				  filter.filters.push({
					field: "EnglishCompanyName",
					operator: "contains",
					value: searchString
				  });
				}


				searchOptions.init('profile', filter);
			  }
			  break;
			case 'case-search':
			  if (el.classList.contains('active')) {
				var select = el.querySelector('select').value;
				var searchString = el.querySelector('input[type="text"]').value;
				var selectedIndex = el.querySelector('select').selectedIndex;
				recentlySearched.new = {
				  Type: select,
				  Parameter: searchString,
				  SearchType: el.getAttribute('tab-id').split("-", 1)[0],
				};

				var filter = {
				  logic: "and",
				  filters: selectedIndex ? [{
					field: select,
					operator: "contains",
					value: searchString
				  }] : [],
				};
				searchOptions.init('case', filter);
			  }
			  break;
			case 'external-search':

			  if (el.classList.contains('active')) {

				search._hardRefresh();
				var searchArgs = {};
				var selected = search.holder().querySelector('select[data-name="Key"]');

				switch (selected.value) {
				  case 'By Party Id':
					if (search.holder().querySelector('input[data-name="PartyId"]').value.length == 10) {
					  searchArgs = {
						PartyId: search.holder().querySelector('input[data-name="PartyId"]').value
					  };
					} else {
					  valid = false;
					}
					break;
				  case 'By Country And Tax Id':
					searchArgs = {
					  Country: search.holder().querySelector('select[data-name="Country"]').value,
					  TaxId: search.holder().querySelector('input[data-name="TaxId"]').value
					};
					break;
				  case 'By Email':
					searchArgs = {
					  Email: search.holder().querySelector('input[data-name="Email"]').value,
					};
					break;
				}

				if (valid) {
				  recentlySearched.new = {
					Type: selected.value,
					Parameter: JSON.stringify(searchArgs),
					SearchType: el.getAttribute('tab-id').split("-", 1)[0],
				  };

				  companyAPI2.searchCompany(searchArgs, function(response) {

					if (response.error) {
					  var not_found = search.holder().querySelector('.company_not_found');
					  not_found.classList.remove('hidden');
					  search.companyNotFound.init(not_found);
					} else {
					  var dt = response.data;
					  /*if (dt && dt.length == 1) {
                                                                              search.viewCompany(dt[0], search.holder().querySelector('.company_details'), "search");
                                                                            } else if*/
					  if (dt && dt.length >= 1) {
						multipleCompaniesDetails.init(dt);
					  }
					}
				  });
				}

			  }
			  break;
		  };

		});

		if (valid) {
		  recentlySearched.add(function() {
			mo.fn.overlay.hide();
		  });
		} else {
		  mo.fn.overlay.hide();
		}
	  });

	},
	profileSearch: {
	  profileOptions: [{
		option: 'Company Name',
		value: 'CompanyName'
	  },
					   {
						 option: 'Profile #',
						 value: 'EntryId'
					   },
					   {
						 option: 'Securimate #',
						 value: 'LegacyId'
					   },
					   {
						 option: 'Internal Owner',
						 value: 'InternalOwner'
					   },
					   {
						 option: 'Country',
						 value: 'CountryName'
					   },
					   {
						 option: 'Street Address',
						 value: 'Address1'
					   },
					   {
						 option: 'Contact Name',
						 value: 'Name'
					   },
					   {
						 option: 'Contact Email',
						 value: 'EmailAddress'
					   },
					   {
						 option: 'Siebel ID',
						 value: 'SiebelID'
					   },
					   {
						 option: 'Party ID',
						 value: 'PartyId'
					   },
					   {
						 option: 'Location ID',
						 value: 'PartnerLocationId'
					   },

					  ],
	  init: function(node) {

		var conf = {
		  dom: node,
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Profile Types:",
				  data: "profileType",
				  required: true,
				  type: "select",
				  change: ["inArray"],
				  options: search.profileSearch.profileOptions.map(x => x.option),
				  values: search.profileSearch.profileOptions.map(x => x.value)
				}],
				[{
				  label: "Search",
				  data: "search",
				  required: true,
				  type: "text",
				  placeholder: "Search for company",
				  validation: ["minLen|1", "maxLen|100", "noBlanks"]
				}]
			  ]
			}],
			callback: function() {
			},
			validation: function() {
			  const result = {
				fail: [],
				pass: []
			  };
			  const textField = node.querySelector('[data-name="search"]');
			  const typeField = node.querySelector('[data-name="profileType"]');
			  if (!textField.value || !typeField.value || typeField.value == 'Select one') {
				if (!textField.value) {
				  result.fail.push(textField);
				}
				if (!typeField.value || typeField.value == 'Select one') {
				  result.fail.push(typeField);
				}
				search.holder().querySelector('#search-company-btn').classList.add('disabled');
			  } else {
				result.pass.push(textField);
				result.pass.push(typeField);
				search.holder().querySelector('#search-company-btn').classList.remove('disabled');
			  }

			  return result;
			},
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  }
	},
	caseSearch: {
	  caseOptions: [
		/*({
                                option: 'Case Name',
                                value: 'caseName'
                              },*/
		{
		  option: 'Case Number',
		  value: 'EntryId'
		},
		{
		  option: 'Securimate #',
		  value: 'LegacyId'
		},
		{
		  option: 'Company Name',
		  value: 'CompanyName'
		},
		/*{
                                option: 'Description',
                                value: 'description'
                              },*/
		{
		  option: 'Country',
		  value: 'CountryName'
		},
		{
		  option: 'Street Address',
		  value: 'Address1'
		},
		{
		  option: 'Requester',
		  value: 'RequestedBy'
		},
		/*{
                                option: 'Department',
                                value: 'department'
                              }*/
	  ],
	  init: function(node) {
		var conf = {
		  dom: node,
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Case Types:",
				  data: "caseType",
				  required: true,
				  type: "select",
				  change: ["inArray"],
				  options: search.caseSearch.caseOptions.map(x => x.option),
				  values: search.caseSearch.caseOptions.map(x => x.value)
				}],
				[{
				  label: "Search",
				  data: "search",
				  required: true,
				  type: "text",
				  placeholder: "Search for company",
				  validation: ["minLen|1", "maxLen|100", "noBlanks"]
				}]
			  ]
			}],
			callback: function() {

			},
			validation: function() {
			  const result = {
				fail: [],
				pass: []
			  };
			  const textField = node.querySelector('[data-name="search"]');
			  const typeField = node.querySelector('[data-name="caseType"]');
			  if (!textField.value || !typeField.value || typeField.value == 'Select one') {
				if (!textField.value) {
				  result.fail.push(textField);
				}
				if (!typeField.value || typeField.value == 'Select one') {
				  result.fail.push(typeField);
				}
				search.holder().querySelector('#search-company-btn').classList.add('disabled');
			  } else {
				result.pass.push(textField);
				result.pass.push(typeField);
				search.holder().querySelector('#search-company-btn').classList.remove('disabled');
			  }

			  return result;
			},
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  }
	},
	externalSearch: {
	  init: function(node) {
		var conf = {
		  dom: node,
		  pages: [{
			nav: false,
			structure: [
			  {
				group: [
				  [{
					label: "Search type:",
					data: "Key",
					required: true,
					value: "By Country And Tax Id",
					type: "select",
					values: ["By Country And Tax Id", "By Party Id"],
					validation: ["inArray"],
					change: ["inArray"]
				  }
				  ]
				]
			  },
			  {
				group: [
				  [{
					label: "Country",
					data: "Country",
					required: true,
					type: "select",
					value: null,
					options: reference.countries.options(),
					values: reference.countries.values(),
					validation: ["inArray"],
				  },
				   {
					 label: "Tax ID",
					 data: "TaxId",
					 required: true,
					 type: "text",
					 placeholder: "Provide the Tax id",
					 validation: ["minLen|1", "maxLen|100", "noBlanks"]
				   }
				  ]
				]
			  },
			  {
				hidden: true,
				group: [
				  [{
					label: "Party ID",
					data: "PartyId",
					required: true,
					type: "text",
					placeholder: "Provide the Party id",
					validation: ["minLen|1", "maxLen|100"]
				  }]
				]
			  },
			  {
				hidden: true,
				group: [
				  [

					{
					  label: "Email",
					  data: "Email",
					  required: true,
					  type: "text",
					  placeholder: "Provide the Tax id",
					  validation: ["minLen|1", "maxLen|100", "noBlanks"]
					}
				  ]
				]
			  }
			],
			callback: function() {
			  search.holder().querySelector('select[data-name="Key"]').addEventListener('change', function(ev) {
				var hideAll = search.holder().querySelectorAll('[tab-id="external-search"] .row');
				Array.from(hideAll).forEach(function(el, index) {
				  if (!el.classList.contains('hidden') && index !== 0) el.classList.add('hidden');
				});
				switch (ev.target.value) {
				  case 'By Party Id':
					var target = search.holder().querySelector('input[data-name="PartyId"]').closest('.row');
					target.classList.remove('hidden');
					break;
				  case 'By Country And Tax Id':
					var target = search.holder().querySelector('select[data-name="Country"]').closest('.row');
					target.classList.remove('hidden');
					break;
				  case 'By Email':
					var target = search.holder().querySelector('input[data-name="Email"]').closest('.row');
					target.classList.remove('hidden');
					break;
				}
			  });
			},
			validation: function() {
			  const result = {
				fail: [],
				pass: []
			  };

			  switch (search.holder().querySelector('select[data-name="Key"]').value) {
				case 'By Party Id':
				  var target = search.holder().querySelector('input[data-name="PartyId"]');
				  if (!target.value) {
					result.fail.push(target);
					search.holder().querySelector('#search-company-btn').classList.add('disabled');
				  } else {
					result.pass.push(target);
					search.holder().querySelector('#search-company-btn').classList.remove('disabled');
				  }
				  break;
				case 'By Country And Tax Id':
				  var target1 = search.holder().querySelector('select[data-name="Country"]');
				  var target2 = search.holder().querySelector('input[data-name="TaxId"]');
				  if (!target1.value || !target2.value || target1.value == 'Select one') {
					if (!target1.value || target1.value == 'Select one') {
					  result.fail.push(target1);
					}
					if (!target2.value) {
					  result.fail.push(target2);
					}
					search.holder().querySelector('#search-company-btn').classList.add('disabled');
				  } else {
					result.pass.push(target1);
					result.pass.push(target2);
					search.holder().querySelector('#search-company-btn').classList.remove('disabled');
				  }
				  break;
				case 'By Email':
				  var target = search.holder().querySelector('input[data-name="Email"]');
				  if (!target.value) {
					result.fail.push(target);
					search.holder().querySelector('#search-company-btn').classList.add('disabled');
				  } else {
					result.pass.push(target);
					search.holder().querySelector('#search-company-btn').classList.remove('disabled');
				  }
				  break;
			  }

			  return result;
			},
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },

	},
	companyNotFound: {
	  init: function(node) {
		//	node.innerHTML = search.companyNotFound.template();
		navigation.push(search.companyNotFound.template());
		//	search.companyNotFound.buttonListener();
		mo.fn.overlay.hide();
	  },
	  template: function() {
		return '<section id="companyNotFound"><h2>Company not found</h2>' +
		  '<p>We were unable to find any company using the information provided.<br>' +
		  'Please try other search options</p></section>';
	  },
	  buttonListener: function() {
		/*search.holder().querySelector('.add_new_company').addEventListener('click', function(ev) {
                                              search.createCompany.init();
                                            });*/
	  },
	},
	viewCompany: function(company) {
	  singleCompanyDetails.init(company);

	}

  };
</script>

<!-- RECENTLY SEARCHED -->
<script>
  const recentlySearched = {
	new: {},
	data: [],
	add: function(cb) {
	  const found = recentlySearched.data.find(o => o.Type === recentlySearched.new.Type && 
											   o.Parameter === recentlySearched.new.Parameter && 
											   o.SearchType === recentlySearched.new.SearchType);
	  if (found) {
		crud.update("5135", found.EntryId, recentlySearched.new, function(d) {
		  recentlySearched.new = {};
		  recentlySearched.show(function() {
			cb();
		  });
		});
	  } else {
		crud.create("5134", recentlySearched.new, function(d) {
		  recentlySearched.new = {};
		  recentlySearched.show(function() {
			cb();
		  });
		});
	  }
	},
	show: function(cb) {
	  search.holder().querySelector('.recently-searched-title .title-icon-down').addEventListener('click', function() {
		const searchBlock = search.holder().querySelector('#recently-searched');
		searchBlock.style.display = 'block';
		this.classList.add('title-icon-hidden');
		search.holder().querySelector('.recently-searched-title .title-icon-up').classList.remove('title-icon-hidden');
	  });
	  search.holder().querySelector('.recently-searched-title .title-icon-up').addEventListener('click', function() {
		const searchBlock = search.holder().querySelector('#recently-searched');
		searchBlock.style.display = 'none';
		this.classList.add('title-icon-hidden');
		search.holder().querySelector('.recently-searched-title .title-icon-down').classList.remove('title-icon-hidden');
	  });

	  recentlySearched.data = [];

	  const ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1687/Search History/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			fields: {
			  //	  Created: { type: "date" },
			  //	  Modified: { type: "date" },
			}
		  }
		},
		serverFiltering: true,
		filter: {field: "CreatedBy", operator: "eq", value: '[SSOData.Email]'},
		serverPaging: true,
		page: 1,
		pageSize: 5,
		serverSorting: true,
		sort: { field: 'Modified', dir: 'desc' },
	  });

	  ds.read().then(function() {
		const view = ds.view();
		console.log('view', view);
		search.holder().querySelector('#recently-searched').innerHTML = '';

		view.forEach((item, i) => {
		  recentlySearched.data.push(item);
		  recentlySearched.build(item, i);
		});

		cb();
	  });
	},
	build: function(record, key) {
	  const holder = search.holder().querySelector('#recently-searched');
	  const date = new Date(record.Modified + 'Z');

	  function timeSince(date) {
		var seconds = Math.floor((new Date() - date) / 1000);
		var interval = seconds / 31536000;
		if (interval > 1) {
		  return Math.floor(interval) + " years";
		}
		interval = seconds / 2592000;
		if (interval > 1) {
		  return Math.floor(interval) + " mon";
		}
		interval = seconds / 86400;
		if (interval > 1) {
		  return Math.floor(interval) + " days";
		}
		interval = seconds / 3600;
		if (interval > 1) {
		  return Math.floor(interval) + " hours";
		}
		interval = seconds / 60;
		if (interval > 1) {
		  return Math.floor(interval) + " min";
		}
		return Math.floor(seconds) + " sec";
	  }

	  let searchString = record.Parameter;
	  if (record.SearchType == 'external') {
		searchString = record.Parameter.replace(/["{}]/gi, '');
	  }

	  const element = document.createElement("div");
	  element.classList.add('recently-searched-row');
	  element.innerHTML = `
<span class="recently-searched-num">${key+1}.</span> 
<span class="recently-searched-searchType">${record.SearchType.charAt(0).toUpperCase() + record.SearchType.slice(1)}:</span> 
<span class="recently-searched-type">${record.Type}</span> 
<span class="recently-searched-name">Search:</span><span class="recently-searched-parameter">${searchString}</span> 
<span class="recently-searched-date">${timeSince(date)}</span>
`;

	  element.addEventListener('click', function() {
		console.log('record', record);

		switch (record.SearchType) {
		  case 'profile':
			var filter = {
			  logic: "and",
			  filters: [{
				field: record.Type,
				operator: "contains",
				value: record.Parameter
			  }]
			};
			searchOptions.init('profile', filter);
			break;
		  case 'case':
			var filter = {
			  logic: "and",
			  filters: [{
				field: record.Type,
				operator: "contains",
				value: record.Parameter
			  }]
			};
			searchOptions.init('case', filter);
			break;
		  case 'external':
			mo.fn.overlay.show({
			  close: false
			});
			search._hardRefresh();
			var searchArgs = JSON.parse(record.Parameter);
			var selected = record.Type;

			companyAPI2.searchCompany(searchArgs, function(response) {
			  if (response.error) {
				var not_found = search.holder().querySelector('.company_not_found');
				not_found.classList.remove('hidden');
				search.companyNotFound.init(not_found);
			  } else {
				var dt = response.data;
				if (dt && dt.length >= 1) {
				  multipleCompaniesDetails.init(dt);
				}
			  }
			});


			break;
		};

	  });
	  holder.appendChild(element);
	},
  };
</script>

<!-- RECENTLY VIEWED -->
<script>
  const recentlyViewed = {
	data: [],
	add: function(obj, cb) {
	  const found = recentlyViewed.data.find(o => o.Module === obj.Module && o.Id === obj.Id);
	  if (found) {
		crud.update("5138", found.EntryId, obj, function(d) {
		  recentlyViewed.show(function() {
			cb();
		  });
		});
	  } else {
		crud.create("5137", obj, function(d) {
		  recentlyViewed.show(function() {
			cb();
		  });
		});
	  }
	},
	show: function(cb) {
	  search.holder().querySelector('.recently-viewed-title .title-icon-down').addEventListener('click', function() {
		const searchBlock = search.holder().querySelector('#recently-viewed');
		searchBlock.style.display = 'block';
		this.classList.add('title-icon-hidden');
		search.holder().querySelector('.recently-viewed-title .title-icon-up').classList.remove('title-icon-hidden');
	  });
	  search.holder().querySelector('.recently-viewed-title .title-icon-up').addEventListener('click', function() {
		const searchBlock = search.holder().querySelector('#recently-viewed');
		searchBlock.style.display = 'none';
		this.classList.add('title-icon-hidden');
		search.holder().querySelector('.recently-viewed-title .title-icon-down').classList.remove('title-icon-hidden');
	  });

	  recentlyViewed.data = [];

	  const ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: "https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/1688/View History/kendo/data/search",
			type: 'POST'
		  },

		},
		schema: {
		  model: {
			id: "EntryId",
			fields: {
			}
		  }
		},
		serverFiltering: true,
		filter: {field: "CreatedBy", operator: "eq", value: '[SSOData.Email]'},
		serverPaging: true,
		page: 1,
		pageSize: 5,
		serverSorting: true,
		sort: { field: 'Modified', dir: 'desc' },
	  });

	  ds.read().then(function() {
		const view = ds.view();
		console.log('view', view);
		search.holder().querySelector('#recently-viewed').innerHTML = '';

		view.forEach((item, i) => {
		  recentlyViewed.data.push(item);
		  recentlyViewed.build(item, i);
		});

		cb();
	  });
	},
	build: function(record, key) {
	  const holder = search.holder().querySelector('#recently-viewed');
	  const date = new Date(record.Modified + 'Z');

	  function timeSince(date) {
		var seconds = Math.floor((new Date() - date) / 1000);
		var interval = seconds / 31536000;
		if (interval > 1) {
		  return Math.floor(interval) + " years";
		}
		interval = seconds / 2592000;
		if (interval > 1) {
		  return Math.floor(interval) + " mon";
		}
		interval = seconds / 86400;
		if (interval > 1) {
		  return Math.floor(interval) + " days";
		}
		interval = seconds / 3600;
		if (interval > 1) {
		  return Math.floor(interval) + " hours";
		}
		interval = seconds / 60;
		if (interval > 1) {
		  return Math.floor(interval) + " min";
		}
		return Math.floor(seconds) + " sec";
	  }

	  const element = document.createElement("div");
	  element.classList.add('recently-viewed-row');
	  element.innerHTML = `
<span class="recently-viewed-num">${key+1}.</span> 
<span class="recently-viewed-module">${record.Module}${record.Id ? ': #'+record.Id : ''}</span> 
<span class="recently-viewed-date">${timeSince(date)}</span>
`;

	  element.addEventListener('click', function() {
		console.log('record', record);
		mo.fn.overlay.show({
		  close: false
		});

		const prevSection = document.querySelector('#navigation #container > :last-child');
		const prevSectionType = prevSection ? prevSection.id : null;
		const prevSectionId = prevSection ? prevSection.dataset.id : null;
		console.log('prevSectionType', prevSectionType);

		switch (record.Module) {
		  case 'Profile':
			if (record.Id) {
			  if (prevSectionType != 'company-details' || record.Id != prevSectionId) {
				singleCompanyDetails.init(record.Id);
			  } else {
				mo.fn.overlay.hide();
			  }
			} else {
			  if (prevSectionType != 'profiles-section') {
				profiles.init();
			  }
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Case':
			if (record.Id && (prevSectionType != 'company_invitation_info' || record.Id != prevSectionId)) {
			  invitation.invitationOverview.init(record.Id);
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Cases':
			if (prevSectionType != 'invitations') {
			  myInvitations.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Pending tasks':
			if (prevSectionType != 'pending-apps') {
			  pending.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Reporting':
			if (prevSectionType != 'reporting') {
			  reporting.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Users':
			if (prevSectionType != 'users') {
			  users.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Countries':
			if (prevSectionType != 'countries') {
			  countries.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Localization':
			if (prevSectionType != 'localization') {
			  localization.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Batch operations':
			if (prevSectionType != 'bulk-ops') {
			  bulkInvitations.init();
			}
			mo.fn.overlay.hide();
			break;
		  case 'Intake forms':
			if (prevSectionType != 'intake') {
			  intakeForms.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Auth codes':
			if (prevSectionType != 'authCodes') {
			  authCodes.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  case 'Email tracking system':
			if (prevSectionType != 'emailTracking') {
			  emailTracking.init();
			} else {
			  mo.fn.overlay.hide();
			}
			break;
		  default:
			mo.fn.overlay.hide();
		}
	  });
	  holder.appendChild(element);
	},
  };
</script>


<!-- SEARCH OPTIONS -->
<script>
  const searchOptions = {
	holder: function() { //identifier
	  return document.querySelector('#navigation #search-options:last-child');
	},
	html: function() { // where we store data
	  return "<section id='search-options'><div class='search-options-grid'></div></section>";
	},
	init: function(type, filter) {
	  navigation.push(searchOptions.html());

	  switch (type) {
		case 'profile':
		  searchOptions.profile.grid._load(searchOptions.holder().querySelector('.search-options-grid'), searchOptions.profile.dataSource(filter), searchOptions.profile.grid._columns(), true);
		  break;
		case 'case':
		  searchOptions.case.grid._load(searchOptions.holder().querySelector('.search-options-grid'), searchOptions.case.dataSource(filter), searchOptions.case.grid._columns(), true);
		  break;
	  }


	},
	profile: {
	  dataSource: function(filter) {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_Company/kendo/data/search",
			  type: 'POST'
			}
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  /* set page size*/
		  serverFiltering: true,
		  /* set default filter
                                  filter: { logic: "and", filters: [ { field: "name", operator: "startswith", value: "Jane" } ] }
                                  */
		  filter: filter,
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }

		});
	  },
	  grid: {
		_columns: function() {
		  var cusConfig = [{
			field: "EntryId",
			title: "Profile #",
			hidden: false,
			width: "140px",
			locked: true
		  },
						   {
							 field: "CompanyName",
							 title: "Company Name",
							 hidden: false,
							 width: "200px",
							 locked: true,
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },
						   {
							 field: "Status",
							 title: "Status",
							 hidden: false,
							 width: "160px",
						   },
						   {
							 field: "LegacyId",
							 title: "Securimate #",
							 hidden: false,
							 width: "170px",
						   },
						   {
							 field: "InternalOwner",
							 title: "Internal Owner",
							 hidden: false,
							 width: "200px",
						   },
						   {
							 field: "Region",
							 title: "Region",
							 hidden: false,
							 width: "150px",
						   },
						   {
							 field: "CountryName",
							 title: "Country",
							 hidden: false,
							 width: "180px",
						   },
						   {
							 field: "Category",
							 title: "Category",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "ConfigName",
							 title: "Intake Form",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "SiebelID",
							 title: "Siebel ID",
							 hidden: false,
							 width: "150px",
						   },
						   {
							 field: "PartyId",
							 title: "Party ID",
							 hidden: false,
							 width: "150px",
						   },

						   {
							 field: "City",
							 title: "City",
							 hidden: false,
							 width: "180px",
						   },
						   {
							 field: "Address1",
							 title: "Address 1",
							 hidden: false,
							 width: "200px",
						   },
						   {
							 field: "EmailAddress",
							 title: "Contact Email",
							 hidden: false,
							 width: "200px",
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },

						   {
							 field: "Name",
							 title: "Contact Name",
							 hidden: false,
							 width: "180px"
						   },
						   {
							 field: "Website",
							 title: "Website",
							 hidden: false,
							 width: "180px"
						   },
						   {
							 field: "TaxId",
							 title: "Tax Id / Registration Number",
							 hidden: false,
							 width: "180px",
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },
						   {
							 field: "TradingCompanyName",
							 title: "Registration Number",
							 hidden: false,
							 width: "180px",
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "180px",
							 template: function(d) {
							   return util.getDate(d.Created) || "";
							 }
						   },
						   {
							 title: "",
							 width: "100px",
							 locked: true,
							 hidden: false,
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons = '<a class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
							   return icons;
							 }
						   }
						  ];
		  return cusConfig;
		},
		_load: function(selector, datasource, config, toolbar, invitation_data) {

		  $(selector).kendoGrid({
			height: 500,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			dataSource: datasource,
			columns: config,
			dataBound: function(e) {},
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
		  });
		  util.buildFilterCombobox($(selector), "Region", ["APJ", "EMEA", "AMS"]);
		  util.buildFilterCombobox($(selector), "CountryName", {
			dataset: "Countries_Metadata",
			form: "1269",
			dataTextField: "Name",
			dataValueField: "Name",
		  });
		  util.buildFilterCombobox($(selector), "InternalOwner", {
			dataset: "ARK_Users_MetaData",
			form: "641",
			dataTextField: "Email",
			dataValueField: "Email",
		  });
		  util.buildFilterCombobox($(selector), "Category", {
			dataset: "ARK_Categories",
			form: "1647",
			dataTextField: "Category",
			dataValueField: "Category",
		  });		  
		  util.buildFilterCombobox($(selector), "ConfigName", {
			dataset: "ARK_ConfigNames",
			form: "1279",
			dataTextField: "ConfigName",
			dataValueField: "ConfigName",
			filter: [
			  { field: "Status", operator: "eq", value: 1 },
			  { field: "Application", operator: "eq", value: "ARK" },
			],
		  });

		  $(selector).delegate('.myInv-company_details', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));

			singleCompanyDetails.init(row.EntryId);
		  });

		  var exportFlag = false;
		  $(selector).data("kendoGrid").bind("excelExport", function(e) {
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
			if (!exportFlag) {

			  util.export(e, function() {
				exportFlag = true;
				mo.fn.overlay.hide();
			  });

			} else {
			  exportFlag = false;
			  mo.fn.overlay.hide();

			}
		  });
		}
	  }
	},
	case: {
	  dataSource: function(filter) {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Company_Cases/kendo/data/search",
			  type: 'POST'
			}
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  /* set page size*/
		  serverFiltering: true,
		  filter: filter,
		  serverSorting: true,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }
		});
	  },
	  grid: {
		_columns: function() {
		  var cusConfig = [{
			field: "EntryId",
			title: "Case #",
			hidden: false,
			width: "140px",
			locked: true
		  },
						   {
							 field: "LegacyId",
							 title: "Securimate #",
							 hidden: false,
							 width: "170px"
						   },
						   {
							 field: "ConfigName",
							 title: "Intake form",
							 hidden: false,
							 width: "200px",
							 locked: true,
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },
						   {
							 field: "CompanyName",
							 title: "Company",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "CompanyId",
							 title: "Profile #",
							 hidden: false,
							 width: "150px",
							 locked: false,
						   },
						   {
							 field: "RiskRank",
							 title: "Risk Rank",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "RequestedBy",
							 title: "Requested By",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "CountryName",
							 title: "Country",
							 hidden: false,
							 width: "180px",
						   },
						   {
							 field: "Region",
							 title: "Region",
							 hidden: false,
							 width: "150px"
						   },
						   {
							 field: "Address1",
							 title: "Address 1",
							 hidden: false,
							 width: "180px"
						   },
						   {
							 field: "Expiry",
							 title: "Expiry",
							 hidden: false,
							 width: "150px",
							 template: function(d) {
							   return util.getDate(d.Expiry)
							 }
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "150px",
							 template: function(d) {
							   return util.getDate(d.Created)
							 }
						   },
						   {
							 title: "",
							 width: "100px",
							 locked: true,
							 hidden: false,
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
								   '<a class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
							   return icons;
							 }
						   }
						  ];
		  return cusConfig;
		},
		_default: function() {
		  var defConfig = [];
		  var keys = Object.keys(search.data[0]);
		  for (i = 0; i < keys.length; i++) {
			var key = keys[i];
			var obj = {};
			obj.field = key;
			obj.title = key;
			obj.hidden = false;
			obj.filterable = true;
			obj.width = "250px";
			obj.attributes = {
			  style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
			};
			if (key == "en_US")
			  defConfig.unshift(obj);
			else
			  defConfig.push(obj);
		  }
		  return defConfig;
		},
		_load: function(selector, datasource, config, toolbar, invitation_data) {
		  var inviteButton = null;
		  $(selector).kendoGrid({
			height: 500,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			toolbar: inviteButton,
			dataSource: datasource,
			columns: config,
			dataBound: function(e) {},
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
		  });

		  util.buildFilterCombobox($(selector), "Region", ["APJ", "EMEA", "AMS"]);
		  util.buildFilterCombobox($(selector), "CountryName", {
			dataset: "Countries_Metadata",
			form: "1269",
			dataTextField: "Name",
			dataValueField: "Name",
		  });
		  util.buildFilterCombobox($(selector), "ConfigName", {
			dataset: "ARK_ConfigNames",
			form: "1279",
			dataTextField: "ConfigName",
			dataValueField: "ConfigName",
			filter: [
			  { field: "Status", operator: "eq", value: 1 },
			  { field: "Application", operator: "eq", value: "ARK" },
			],
		  });


		  $(selector).delegate('.view_invitation', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.init(row.EntryId);
		  });

		  $(selector).delegate('.myInv-company_details', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));


			myInvitations.viewCompany(row.CompanyFK);
		  });


		  var exportFlag = false;
		  $(selector).data("kendoGrid").bind("excelExport", function(e) {
			//move to util method, 100 records > show modal add amount of the records in content string of modal(check kendo grid totalMethod of datasourece)  e.sender.dataSource.total()
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			});
			if (!exportFlag) {

			  util.export(e, function() {
				exportFlag = true;
				mo.fn.overlay.hide();
			  });

			} else {
			  exportFlag = false;
			  mo.fn.overlay.hide();

			}
			mo.fn.overlay.hide();
		  });

		}

	  }
	}
  };
</script>


<!-- COMPANY PROFILES -->
<script>
  const profiles = {
	holder: function() {
	  return document.querySelector('#navigation #profiles-section:last-child')
	},
	html: function() {
	  return "<section id='profiles-section'><div class='profiles-grid'></div></section>";
	},
	init: function() {
	  navigation.push(profiles.html());
	  profiles.ui();

	  recentlyViewed.add({
		Module: 'Profile',
		Id: null,
	  }, function() {});
	},
	ui: function() {

	  hpe.ui.tabs({
		dom: profiles.holder().querySelector(".profiles-grid"),
		tabs: [{
		  label: "All",
		  id: "all"
		},
			   /*{
                      label: "Certified",
                      id: "Certified"
                    },*/
			   {
				 label: "Approved",
				 id: "Approved"
			   },
			   {
				 label: "Denied",
				 id: "Denied"
			   },
			   {
				 label: "Pending",
				 id: "Pending"
			   },
			   /*{
                      label: "Out of Scope",
                      id: "OutofScope"
                    }, 
                    {
                      label: "Business Prohibited",
                      id: "BusinessProhibited"
                    }, 
                    {
                      label: "Contract Terminated",
                      id: "ContractTerminated"
                    }, 
                    {
                      label: "To Terminate",
                      id: "ToTerminate"
                    }, */
			  ]
	  }, function(all) {

		profiles.all.init(all[0]);

		/*profiles.holder().querySelector('span[tab-id="Certified"]').addEventListener('click', function() {
                            profiles.certified.init(all[1]);
                          });*/
		profiles.holder().querySelector('span[tab-id="Approved"]').addEventListener('click', function() {
		  profiles.approved.init(all[1]);
		});
		/*profiles.holder().querySelector('span[tab-id="Passed"]').addEventListener('click', function() {
                            profiles.passed.init(all[3]);
                          });*/
		profiles.holder().querySelector('span[tab-id="Denied"]').addEventListener('click', function() {
		  profiles.denied.init(all[2]);
		});
		profiles.holder().querySelector('span[tab-id="Pending"]').addEventListener('click', function() {
		  profiles.pending.init(all[3]);
		});
		/*profiles.holder().querySelector('span[tab-id="OutofScope"]').addEventListener('click', function() {
                            profiles.outofScope.init(all[5]);
                          });
                          profiles.holder().querySelector('span[tab-id="BusinessProhibited"]').addEventListener('click', function() {
                            profiles.businessProhibited.init(all[6]);
                          });
                          profiles.holder().querySelector('span[tab-id="ContractTerminated"]').addEventListener('click', function() {
                            profiles.contractTerminated.init(all[7]);
                          });
                          profiles.holder().querySelector('span[tab-id="ToTerminate"]').addEventListener('click', function() {
                            profiles.toTerminate.init(all[8]);
                          });*/


	  });
	},
	dataSource: function(filter, pageSize) {

	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_Company/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		pageSize: pageSize || 15,
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,
		/* set default sort */
		sort: {
		  field: "EntryId",
		  dir: "desc"
		}

	  });
	},
	all: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-all'></section>";

		var filter = {};
		var columns = profiles.grid._columns();
		columns.push({
		  field: "Status",
		  title: "Status",
		  width: "160px",
		  locked: true,
		});
		profiles.grid._load(node.querySelector('.invitations-grid-all'), profiles.dataSource(filter), columns, true, false, node);
	  },

	},
	/*certified: {
                    init: function(node, callback) {
                      node.innerHTML = "<section class='invitations-grid-certified'></section>";

                      var filter = 
                          {
                            logic: 'and',
                            filters: [
                              {
                                field: "StatusReason",
                                operator: "eq",
                                value: "Certified"
                              }
                            ]
                          };
                      profiles.grid._load(node.querySelector('.invitations-grid-certified'), profiles.dataSource(filter), profiles.grid._columns(), true);
                    },

                  },*/
	approved: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-approved'></section>";
		var filter = {
		  logic: 'or',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "Approved"
		  },
					{
					  field: "StatusReason",
					  operator: "eq",
					  value: "Passed HPE DDQ"
					}
				   ]
		};
		profiles.grid._load(node.querySelector('.invitations-grid-approved'), profiles.dataSource(filter), profiles.grid._columns(), true, false, node);
	  },

	},
	denied: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button'  class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-denied'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "Denied"
		  }]
		};
		profiles.grid._load(node.querySelector('.invitations-grid-denied'), profiles.dataSource(filter), profiles.grid._columns(), true, false, node);
	  },

	},
	/*passed: {
                    init: function(node, callback) {
                      node.innerHTML = "<section class='invitations-grid-passed'></section>";
                      var filter = 
                          {
                            logic: 'and',
                            filters: [
                              {
                                field: "StatusReason",
                                operator: "eq",
                                value: "Passed HPE DDQ"
                              }
                            ]
                          };
                      profiles.grid._load(node.querySelector('.invitations-grid-passed'), profiles.dataSource(filter), profiles.grid._columns(), true);
                    },

                  },*/
	pending: {
	  init: function(node, callback) {
		node.innerHTML = "<div role='button' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><section class='invitations-grid-pending'></section>";
		var filter = {
		  logic: 'and',
		  filters: [{
			field: "Status",
			operator: "eq",
			value: "Pending"
		  }]
		};
		profiles.grid._load(node.querySelector('.invitations-grid-pending'), profiles.dataSource(filter), profiles.grid._columns(), true, false, node);
	  },

	},
	/*outofScope: {
                    init: function(node, callback) {
                      node.innerHTML = "<section class='invitations-grid-outofScope'></section>";
                      var filter = 
                          {
                            logic: 'and',
                            filters: [
                              {
                                field: "StatusReason",
                                operator: "eq",
                                value: "Out of Scope"
                              }
                            ]
                          };
                      profiles.grid._load(node.querySelector('.invitations-grid-outofScope'), profiles.dataSource(filter), profiles.grid._columns(), true);
                    },

                  },
                  businessProhibited: {
                    init: function(node, callback) {
                      node.innerHTML = "<section class='invitations-grid-businessProhibited'></section>";
                      var filter = 
                          {
                            logic: 'and',
                            filters: [
                              {
                                field: "StatusReason",
                                operator: "eq",
                                value: "Business Prohibited"
                              }
                            ]
                          };
                      profiles.grid._load(node.querySelector('.invitations-grid-businessProhibited'), profiles.dataSource(filter), profiles.grid._columns(), true);
                    },

                  },
                  contractTerminated: {
                    init: function(node, callback) {
                      node.innerHTML = "<section class='invitations-grid-contractTerminated'></section>";
                      var filter = 
                          {
                            logic: 'and',
                            filters: [
                              {
                                field: "StatusReason",
                                operator: "eq",
                                value: "Contract Terminated"
                              }
                            ]
                          };
                      profiles.grid._load(node.querySelector('.invitations-grid-contractTerminated'), profiles.dataSource(filter), profiles.grid._columns(), true);
                    },

                  },
                  toTerminate: {
                    init: function(node, callback) {
                      node.innerHTML = "<section class='invitations-grid-toTermiante'></section>";
                      var filter = 
                          {
                            logic: 'and',
                            filters: [
                              {
                                field: "StatusReason",
                                operator: "eq",
                                value: "To Terminate"
                              }
                            ]
                          };
                      profiles.grid._load(node.querySelector('.invitations-grid-toTermiante'), profiles.dataSource(filter), profiles.grid._columns(), true);
                    },
                  },*/
	grid: {
	  _columns: function() {
		var cusConfig = [{
		  field: "EntryId",
		  title: "Profile #",
		  hidden: false,
		  width: "140px",
		  locked: true
		},
						 {
						   field: "CompanyName",
						   title: "Company Name",
						   hidden: false,
						   width: "200px",
						   locked: true,
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },
						 {
						   field: "LegacyId",
						   title: "Securimate Id",
						   hidden: false,
						   width: "170px",
						 },
						 {
						   field: "StatusReason",
						   title: "Status Reason",
						   width: "160px",
						 },
						 {
						   field: "InternalOwner",
						   title: "Internal Owner",
						   hidden: false,
						   width: "200px",
						 },
						 {
						   field: "Region",
						   title: "Region",
						   hidden: false,
						   width: "150px",
						 },
						 {
						   field: "CountryName",
						   title: "Country",
						   hidden: false,
						   width: "180px",
						   /*template: function(d) {
                                        return reference.convertCountry(d.Country) || "";
                                      }*/
						 },
						 {
						   field: "Category",
						   title: "Category",
						   hidden: false,
						   width: "200px"
						 },
						 {
						   field: "ConfigName",
						   title: "Intake Form",
						   hidden: false,
						   width: "200px"
						 },
						 {
						   field: "SiebelID",
						   title: "Siebel ID",
						   hidden: false,
						   width: "150px",
						 },
						 {
						   field: "PartyId",
						   title: "Party ID",
						   hidden: false,
						   width: "150px",
						 },

						 {
						   field: "City",
						   title: "City",
						   hidden: false,
						   width: "180px",
						 },
						 {
						   field: "Address1",
						   title: "Address 1",
						   hidden: false,
						   width: "200px",
						 },
						 {
						   field: "EmailAddress",
						   title: "Contact Email",
						   hidden: false,
						   width: "200px",
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },

						 {
						   field: "Name",
						   title: "Contact Name",
						   hidden: false,
						   width: "180px"
						 },
						 {
						   field: "Website",
						   title: "Website",
						   hidden: false,
						   width: "180px"
						 },
						 {
						   field: "TaxId",
						   title: "Tax Id / Registration Number",
						   hidden: false,
						   width: "180px",
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },
						 {
						   field: "TradingCompanyName",
						   title: "Trading Company Name",
						   hidden: false,
						   width: "180px",
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },
						 {
						   field: "Created",
						   title: "Created",
						   hidden: false,
						   width: "180px",
						   template: function(d) {
							 return util.getDate(d.Created) || "";
						   }
						 },
						 {
						   title: "",
						   width: "100px",
						   locked: true,
						   hidden: false,
						   attributes: {
							 "class": "cta"
						   },
						   template: function(d) {
							 var icons = '<a class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
							 return icons;
						   }
						 }
						];
		return cusConfig;
	  },
	  _load: function(selector, datasource, config, toolbar, invitation_data, node) {

		util.kendoGrid.addDateFieldsToSchema(datasource, ["Created"]);

		$(selector).kendoGrid({
		  height: 800,
		  /*toolbar: [{
                        name: "excel",
                        text: "Export Excel"
                      }],
                      excel: {
                        fileName: "Profile_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                        filterable: true,
                        allPages: true
                      },*/
		  // excelExport: util.exportExcel,
		  noRecords: {
			template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
		  },
		  dataSource: datasource,
		  columns: config,
		  dataBound: function(e) {},
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: true
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  resizable: true,
		  dataBound: util.kendoGrid.dataBound,
		  filter: util.kendoGrid.filter
		});

		util.buildFilterCombobox($(selector), "Status", ["Approved", "Denied", "Pending"]);
		util.buildFilterCombobox($(selector), "StatusReason", ["Approved", "Certified", "Passed HPE DDQ", "3P belongs to HPI", "3P belongs to Microfocus", "Business Prohibited", "Contract Terminated", "Denied", "HPE Exiting Countries", "Out of Scope", "Pending", "To Terminate"]);
		util.buildFilterCombobox($(selector), "Region", ["APJ", "EMEA", "AMS"]);
		util.buildFilterCombobox($(selector), "CountryName", {
		  dataset: "Countries_Metadata",
		  form: "1269",
		  dataTextField: "Name",
		  dataValueField: "Name",
		});
		util.buildFilterCombobox($(selector), "Category", {
		  dataset: "ARK_Categories",
		  form: "1647",
		  dataTextField: "Category",
		  dataValueField: "Category",
		});		  
		util.buildFilterCombobox($(selector), "ConfigName", {
		  dataset: "ARK_ConfigNames",
		  form: "1279",
		  dataTextField: "ConfigName",
		  dataValueField: "ConfigName",
		  filter: [
			{ field: "Status", operator: "eq", value: 1 },
			{ field: "Application", operator: "eq", value: "ARK" },
		  ],
		});
		util.buildFilterCombobox($(selector), "InternalOwner", {
		  dataset: "ARK_Users_MetaData",
		  form: "641",
		  dataTextField: "Email",
		  dataValueField: "Email",
		});

		$(selector).delegate('.myInv-company_details', 'click', function(ev) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));

		  singleCompanyDetails.init(row.EntryId);
		});

		$(selector).delegate('.selected-change-profile', 'click', function(ev) {
		  var grid = $(selector).data("kendoGrid");
		  var row = grid.dataItem($(this).closest("tr"));
		  crud.update("3693", invitation_data.invitation.EntryId, {
			CompanyFK: row.EntryId
		  }, function() {
			invitation.invitationOverview.addAuditLog("Case Moved", `ProfileId: "${invitation_data.invitation.CompanyFK}" -> "${row.EntryId}";`, util.Email());
			mo.fn.modal.hide();
			invitation.invitationOverview.updateSection(invitation_data.invitation.EntryId);

		  });

		});

		node.querySelector('.excel-button').addEventListener("click", function(e) {
		  var grid = $(selector).data("kendoGrid");
		  reporting.exportReport("ARK_Company",
								 1363,
								 JSON.stringify(grid.columns.map(({
			field,
			title
		  }) => ({
			field,
			title
		  })).filter(x => x.field)),
								 JSON.stringify(grid.dataSource.sort()),
								 JSON.stringify(grid.dataSource.filter()),
								 ("Profiles_" + util.getDate((new Date()).toISOString(), true))

								);
		});
	  }
	},
	changeProfile: {
	  init: function(invitation, callback) {
		mo.fn.modal.show({
		  ctaLabel: "Ok",
		  //closeLabel: "No",
		  class: "ark-modal",
		  title: "Change profile for case #" + invitation.invitation.EntryId,
		  content: "<div class='change-profile'></div>",
		  contentCallback: function() {
			document.querySelector('.dxpModal').style.maxWidth = "1180px";
			var filter = {};
			var columns = profiles.changeProfile.columns();
			setTimeout(function() {
			  profiles.grid._load(document.querySelector(".dxpModalContent .change-profile"), profiles.dataSource(filter), columns, true, invitation);
			}, 300);

		  },
		  ctaCallback: function() {}
		});
	  },
	  columns: function() {
		var cusConfig = [{
		  field: "EntryId",
		  title: "Profile #",
		  hidden: false,
		  width: "140px",
		  locked: true
		},
						 {
						   field: "CompanyName",
						   title: "Company Name",
						   hidden: false,
						   width: "200px",
						   locked: true,
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },
						 {
						   field: "LegacyId",
						   title: "Securimate Id",
						   hidden: false,
						   width: "170px",
						 },
						 {
						   field: "InternalOwner",
						   title: "Internal Owner",
						   hidden: false,
						   width: "200px",
						 },
						 {
						   field: "Region",
						   title: "Region",
						   hidden: false,
						   width: "150px",
						 },
						 {
						   field: "CountryName",
						   title: "Country",
						   hidden: false,
						   width: "180px",
						   /*template: function(d) {
                                      return reference.convertCountry(d.Country) || "";
                                    }*/
						 },
						 {
						   field: "Category",
						   title: "Category",
						   hidden: false,
						   width: "200px"
						 },
						 {
						   field: "ConfigName",
						   title: "Intake Form",
						   hidden: false,
						   width: "200px"
						 },
						 {
						   field: "SiebelID",
						   title: "Siebel ID",
						   hidden: false,
						   width: "150px",
						 },
						 {
						   field: "PartyId",
						   title: "Party ID",
						   hidden: false,
						   width: "150px",
						 },

						 {
						   field: "City",
						   title: "City",
						   hidden: false,
						   width: "180px",
						 },
						 {
						   field: "Address1",
						   title: "Address 1",
						   hidden: false,
						   width: "200px",
						 },
						 {
						   field: "EmailAddress",
						   title: "Contact Email",
						   hidden: false,
						   width: "200px",
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },

						 {
						   field: "Name",
						   title: "Contact Name",
						   hidden: false,
						   width: "180px"
						 },
						 {
						   field: "Website",
						   title: "Website",
						   hidden: false,
						   width: "180px"
						 },
						 {
						   field: "TaxId",
						   title: "Tax Id / Registration Number",
						   hidden: false,
						   width: "180px",
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },
						 {
						   field: "TradingCompanyName",
						   title: "Trading Company Name",
						   hidden: false,
						   width: "180px",
						   headerAttributes: {
							 style: "white-space: normal"
						   },
						 },
						 {
						   field: "Created",
						   title: "Created",
						   hidden: false,
						   width: "180px",
						   template: function(d) {
							 return util.getDate(d.Created) || "";
						   }
						 },
						 {
						   title: "",
						   width: "100px",
						   locked: true,
						   hidden: false,
						   attributes: {
							 "class": "cta"
						   },
						   template: function(d) {
							 var icons = '<a class=" k-button k-button-big selected-change-profile" style="font-size: 10px;width: 50px; border: 1px solid #000" href="#">SELECT</a>';
							 return icons;
						   }
						 }
						];
		return cusConfig;
	  },
	}
  }
</script>

<!-- PENDING APPS MODULE -->
<script>
  const pending = {
	holder: function() {
	  return document.querySelector('#navigation #pending-apps:last-child')
	},
	html: function() {
	  return "<section id='pending-apps'><div class='pending-apps-grid'></div></section>";
	},
	init: function() {
	  navigation.push(pending.html());

	  pending.ui.init();

	  recentlyViewed.add({
		Module: 'Pending tasks',
		Id: null,
	  }, function() {});
	},
	ui: {
	  init: function() {
		mo.fn.overlay.show({
		  loading: true
		});
		pending.getData(function(data) {
		  pending.ui.grid._load(pending.holder().querySelector('.pending-apps-grid'), data, pending.ui.grid._columns());
		  mo.fn.overlay.hide();
		});

	  },
	  grid: {
		_columns: function() {
		  var cusConfig = [{
			field: "FKA",
			title: "Case #",
			hidden: false,
			width: "120px",
			locked: true
		  },
						   {
							 field: "Email",
							 title: "Assigned To",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "EntryId",
							 title: "EntryId",
							 hidden: true,
							 locked: false,
						   },
						   {
							 field: "ConfigName",
							 title: "Intake form",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 headerAttributes: {
							   style: "white-space: normal"
							 },
							 template: function(d) {
							   return d.ConfigName;
							 }
						   },
						   {
							 field: "CompanyId",
							 title: "Profile #",
							 hidden: false,
							 width: "130px",
							 locked: true
						   },
						   {
							 field: "CompanyName",
							 title: "Company name",
							 hidden: false,
							 width: "200px",
							 locked: true,
						   },
						   {
							 field: "TaskName",
							 title: "Task",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Region",
							 title: "Region",
							 hidden: false,
							 width: "150px"
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "140px",
							 template: function(d) {
							   return d.Created ? util.getDate(d.Created) : "";
							 }
						   },
						   {
							 title: "",
							 width: "150px",
							 locked: true,
							 hidden: false,
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
								   '<a style="margin-right: 6px" class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></path></svg></a>' +
								   `${!access.user.UserRole.Readonly ? '<a style="position: relative; top: -2px"class="myInv-assign-task"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="user" width="21px" height="21px"><path fill="none" stroke="#666" stroke-width="2" d="M8,24 L8,19 M16,24 L16,19 M3,24 L3,19 C3,14.0294373 7.02943725,11 12,11 C16.9705627,11 21,14.0294373 21,19 L21,24 M12,11 C14.7614237,11 17,8.76142375 17,6 C17,3.23857625 14.7614237,1 12,1 C9.23857625,1 7,3.23857625 7,6 C7,8.76142375 9.23857625,11 12,11 Z"></path></svg></a>' : '' }`;

							   return icons;
							 }
						   }
						  ];
		  return cusConfig;
		},
		_load: function(selector, data, config) {
		  var inviteButton = null;
		  // util.kendoGrid.addDateFieldsToSchema(datasource, ["Created"]);
		  $(selector).kendoGrid({
			height: 600,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			toolbar: inviteButton,
			dataSource: new kendo.data.DataSource({
			  data: data
			}),
			columns: config,
			dataBound: function(e) {},
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: false
			},
			scrollable: true,
			sortable: true,
			filterable: true,
			dataBound: util.kendoGrid.dataBound,
			filter: util.kendoGrid.filter
		  });

		  util.buildFilterCombobox($(selector), "Region", ["APJ", "EMEA", "AMS"]);
		  util.buildFilterCombobox($(selector), "ConfigName", {
			dataset: "ARK_ConfigNames",
			form: "1279",
			dataTextField: "ConfigName",
			dataValueField: "ConfigName",
			filter: [
			  { field: "Status", operator: "eq", value: 1 },
			  { field: "Application", operator: "eq", value: "ARK" },
			],
		  });
		  util.buildFilterCombobox($(selector), "Email", {
			dataset: "ARK_Users_MetaData",
			form: "641",
			dataTextField: "Email",
			dataValueField: "Email",
		  });
		  util.buildFilterCombobox($(selector), "TaskName", {
			dataset: "Tasks_Config",
			form: "1485",
			dataTextField: "TaskName",
			dataValueField: "TaskName",
		  });		


		  $(selector).delegate('.view_invitation', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.init(row.FKA);
		  });

		  $(selector).delegate('.myInv-company_details', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));

			myInvitations.viewCompany(row.CompanyFK);
		  });
		  if ($(selector).find('.myInv-assign-task')) {
			$(selector).delegate('.myInv-assign-task', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));

			  pending.assignTask.init(row.EntryId, row.FKA);
			});
		  }
		}
	  },
	},
	dataSource: function() {
	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1278/ARK_Pending_Applications/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: false,
		pageSize: 99999,
		serverFiltering: true,
		serverSorting: true,
		sort: {
		  field: 'Created',
		  dir: 'desc'
		}
	  });
	},
	getData: function(callback) {

	  var ds = pending.dataSource();

	  var eligible = [];

	  ds.read().then(() => {
		var data = ds.view();

		data.forEach(x => {

		  if (access.hasAccessToOperationTask(x))
			eligible.push(x);
		});

		eligible.forEach(x => {
		  var taskInfo = invitation.invitationOverview.tasks.config.find(c => c.id == x.FKB);
		  x.TaskName = taskInfo.title;
		});

		callback(eligible);

	  });
	},
	updateTile: function() {

	  /*var el = document.querySelector(".tile[section-id=pending] strong");
                          if(el)
                          {
                            pending.getData(function(){
                                el.innerHTML 
                            });
                          }*/
	},
	assignTask: {
	  users: [],
	  init: function(companyId, caseId) {
		pending.assignTask.getUsers(function() {
		  pending.assignTask.modal(companyId, caseId)
		});

	  },
	  getUsers: function(callback) {
		var dataSource = pending.assignTask.datasource();
		dataSource.read().then(function() {
		  var a;
		  a = dataSource.view();
		  a.forEach(el => {
			console.log(el);
			pending.assignTask.users.push({
			  email: el.Email,
			  firstName: el.FirstName,
			  lastName: el.LastName
			});
		  });
		  callback();
		});
	  },
	  modal: function(pendingId, caseId) {
		mo.fn.modal.show({
		  ctaLabel: "Add",
		  class: "ark-modal",
		  title: "Assign task",
		  content: "<div class='choose-user-for-task'></div>",
		  contentCallback: function() {
			var conf = {
			  dom: document.querySelector('.choose-user-for-task'),
			  pages: [{
				nav: false,
				structure: [{
				  group: [
					[{
					  label: "Users",
					  data: "Users",
					  type: "select",
					  required: false,
					  value: null,
					  validation: ["inArray"],
					  options: pending.assignTask.users.map(el => `${el.firstName} ${el.lastName} ${el.email}`),
					  values: pending.assignTask.users.map(el => el.email)
					}, ]
				  ]
				}]
			  }],
			  dataset: {},
			};
			nbsf.init(conf, 0);
		  },
		  ctaCallback: function() {
			var user = document.querySelector("select[data-name='Users']").value;
			console.log(user);
			var data = {
			  Email: user,
			  id: pendingId,
			  caseId: caseId
			};
			pending.assignTask.update(data, function() {
			  mo.fn.overlay.show();
			  navigation.reset();
			  pending.init();
			  mo.fn.overlay.hide();
			});


		  },
		});
	  },
	  update: function(data, callback) {
		crud.update('3961', data.id, {
		  Email: data.Email
		}, function(el) {
		  invitation.invitationOverview.addAuditLog("Task assigned", util.getDifference({}, {
			TaskId: el.EntryId,
			Email: el.Email
		  }), util.Email(), null, data.caseId);
		  mo.fn.modal.hide();
		  callback();
		});
	  },
	  datasource: function() {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/641/CustomInternalUser/kendo/data/search",
			  type: "POST"
			}
		  },
		  schema: {
			model: {
			  id: "EntryId",
			}
		  },
		  filter: {
			logic: "and",
			filters: [{
			  field: "Source",
			  operator: "eq",
			  value: 'Ark'
			}]
		  },
		  autoSync: true,
		  serverPaging: true,
		  //  pageSize: 10, // -1 to 
		  serverFiltering: true,
		  serverSorting: true,
		  sort: {
			field: "Modified",
			dir: "desc"
		  }
		})
	  },
	}
  }
</script>

<!-- NAVIGATION -->
<script>
  const navigation = {
	holder: document.querySelector("#navigation"),
	container: document.querySelector("#navigation #container"),
	stack: [],
	initialState: function() {
	  return document.querySelector('#tiles')
	},
	sideNav: function() {
	  return document.querySelector('#nav nav ul')
	},
	logo: function() {
	  return document.querySelector('#logo')
	},
	changeSelect: function(target) {
	  if (target && target.getAttribute('section-id')) {
		switch (target.getAttribute('section-id')) {
		  default: console.log("No application component requested");
			break;
		  case "profile":
			profile.init();
			break;
			//  case "search":
			//	search.init();
			//	break;
		  case "pending":
			pending.init();
			break;
		  case "last-actions":
			lastActions.init();
			break;
		  case "invitations":
			myInvitations.init();
			break;
		  case "countries":
			countries.init();
			break;
		  case "users":
			users.init();
			break;
		  case "localization":
			localization.init();
			break;
		  case "company":
			company.init();
			break;
		  case "intake":
			intakeForms.init();
			break;
		  case "create-company":
			companyModal.init();
			break;
		  case "profiles":
			profiles.init();
			break;
		  case "bulk-invs":
			bulkInvitations.init();
			break;
		  case "bulk-invs-serv":
			bulkInvitationsServer.init();
			break;
		  case "reporting":
			reporting.init();
			break;
		  case "authCodes":
			authCodes.init();
			break;
		  case "emailTracking":
			emailTracking.init();
			break;


		}
	  }
	},
	init: function() {
	  //add event to tabs
	  navigation.initialState().addEventListener('click', function(ev) {
		navigation.changeSelect(ev.target.closest('.tile'));
	  });
	  //add event to side nav list

	  navigation.sideNav().addEventListener('click', function(ev) {
		navigation.changeSelect(ev.target);
	  });
	  //add event to logo
	  navigation.logo().addEventListener('click', function(ev) {
		navigation.reset();
	  });

	  navigation.manageBackButton();
	},
	reset: function() {
	  navigation.stack = [];
	  navigation.container.innerHTML = "";
	  navigation.holder.classList.remove("active");
	  navigation.initialState().classList.add("active");
	},
	push: function(holder, backCallback) {

	  navigation.holder.classList.add("active");
	  navigation.holder.classList.remove("inactive");
	  if (navigation.stack.length) {
		navigation.container.lastChild.classList.add('hidden');
	  }
	  if (!navigation.stack.length) navigation.initialState().classList.remove("active");
	  navigation.container.insertAdjacentHTML('beforeend', holder);
	  navigation.stack.push({
		holder: holder,
		backCallback: backCallback
	  });
	},
	back: function() {
	  navigation.container.removeChild(navigation.container.lastChild);
	  if (navigation.container.lastChild) navigation.container.lastChild.classList.remove('hidden');

	  var lastItem = null;

	  if (navigation.stack.length > 0)
		lastItem = navigation.stack[navigation.stack.length - 1];
	  if (lastItem && lastItem.backCallback)
		lastItem.backCallback();

	},
	manageBackButton: function() {

	  document.querySelector('.back-button').addEventListener('click', function(ev) {
		navigation.stack.pop();
		if (!navigation.stack.length) {
		  document.querySelector('#container section[id="navigation"]').classList.remove('active');
		  navigation.initialState().classList.add("active");
		  navigation.container.removeChild(navigation.container.lastChild);
		} else navigation.back();
	  });
	}


  }
  navigation.init();
</script>

<!-- EMAIL TRACKING -->
<script>
  const emailTracking = {
	holder: function() {
	  return document.querySelector('#navigation #emailTracking:last-child');
	},
	html: function() {
	  return "<section id='emailTracking'><div class='email-tracking-tabs'></div></section>";
	},
	init: function() {
	  navigation.push(emailTracking.html());
	  emailTracking.ui.init();
	  recentlyViewed.add({
		Module: 'Email tracking system',
		Id: null,
	  }, function() {});
	},
	ui: {
	  init: function() {
		mo.fn.overlay.show({
		  loading: true
		});

		hpe.ui.tabs({
		  dom: emailTracking.holder().querySelector('.email-tracking-tabs'),
		  tabs: [
			{
			  label: "Invites",
			  id: "invites"
			},
			{
			  label: "Reminders",
			  id: "reminders"
			},
			{
			  label: "Statistics",
			  id: "statistics"
			}
		  ]
		}, function(all) {

		  var cleanLayout = function(id) {
			var items = emailTracking.holder().querySelector('.container').children;
			for (var i = 0; i < items.length; i++)
			  if (items[i].getAttribute("tab-id") != id)
				items[i].classList.remove("active");
		  }

		  emailTracking.ui.tab(all[0], "invites");

		  emailTracking.holder().querySelector('[tab-id="reminders"]').addEventListener('click', function() {
			//cleanLayout();
			emailTracking.ui.tab(all[1], "reminders");
			//  emailTracking.ui.grid._load(all[1], "reminders", emailTracking.ui.grid._dataSource("reminders"), emailTracking.ui.grid._columns());
		  });

		  emailTracking.holder().querySelector('[tab-id="statistics"]').addEventListener('click', function() {
			//cleanLayout();
			emailTracking.ui.statistics.init(all[2]);
		  });

		});


		mo.fn.overlay.hide();
	  },
	  tab: function(node, type) {
		node.innerHTML = "<div role='button' style='margin-bottom: 30px' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div><div class='email-tracking-content'></div>";
		emailTracking.ui.grid._load(node.querySelector('.email-tracking-content'), type,  emailTracking.ui.grid._dataSource(type), emailTracking.ui.grid._columns(), node);
	  },
	  grid: {
		_columns: function() {
		  var cusConfig = [
			{
			  field: "InvitationId",
			  title: "Case #",
			  hidden: false,
			  width: "120px",
			  locked: true
			},
			{
			  field: "ProfileId",
			  title: "Profile #",
			  hidden: false,
			  width: "130px",
			  locked: true
			},
			{
			  field: "To",
			  title: "Recipient",
			  hidden: false,
			  width: "250px",
			  locked: false,
			},
			{
			  field: "Status",
			  title: "Status",
			  hidden: false,
			  width: "150px",
			  locked: true
			},
			{
			  field: "CompanyName",
			  title: "Company name",
			  hidden: false,
			  width: "200px",
			  locked: false,
			},
			{
			  field: "ErrorMessage",
			  title: "Error",
			  hidden: false,
			  width: "400px",
			  template: function(d) {
				if(!d.ErrorMessage)
				  return "";

				var message = "";

				var idx = d.ErrorMessage.indexOf("Stack Trace");
				while(idx != -1) {

				  var idx1 = d.ErrorMessage.indexOf("Message:", idx);
				  if(idx1 == -1)
					break;

				  var idx2 = d.ErrorMessage.indexOf("Stack Trace", idx1);
				  if(idx1 && idx2)
					message += d.ErrorMessage.substring(idx1, idx2) + "<br>";

				  idx = idx2;
				}


				return "<div>" + message + "</div>";
			  }
			},
			{
			  title: "",
			  width: "150px",
			  locked: true,
			  hidden: false,
			  attributes: {
				"class": "cta"
			  },
			  template: function(d) {
				var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
					'<a style="margin-right: 6px" class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></path></svg></a>';
				return icons;
			  }
			}
		  ];
		  return cusConfig;
		},
		_load: function(holder, type, datasource, config, node) {
		  holder.innerHTML = "<div class='grid" + type + "'></div>";
		  var selector = holder.querySelector(".grid" + type);
		  $(selector).kendoGrid({
			height: 600,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			dataSource: datasource,
			columns: config,
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
		  });

		  util.buildFilterCombobox($(selector), "Status", ["Sent", "Read", "Failed"]);
		  util.buildFilterCombobox($(selector), "To", {
			dataset: "ARK_Users_MetaData",
			form: "641",
			dataTextField: "Email",
			dataValueField: "Email",
		  });

		  $(selector).delegate('.view_invitation', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.init(row.InvitationId);
		  });

		  $(selector).delegate('.myInv-company_details', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));

			myInvitations.viewCompany(row.ProfileId);
		  });

		  node.querySelector('.excel-button').addEventListener("click", function(e) {
			var grid = $(selector).data("kendoGrid");
			let datasetName = '';
			if (type == "invites")
			  datasetName = "ARK_EmailTracking_Invites";
			if (type == "reminders")
			  datasetName = "ARK_EmailTracking_Reminders";
			reporting.exportReport(datasetName,
								   1275,
								   JSON.stringify(grid.columns.map(({
			  field,
			  title
			}) => ({
			  field,
			  title
			})).filter(x => x.field)),
								   JSON.stringify(grid.dataSource.sort()),
								   JSON.stringify(grid.dataSource.filter()),
								   ("EmailTracking_" + util.getDate((new Date()).toISOString(), true))

								  );
		  });
		},
		_dataSource: function(type) {
		  var dataset = null;
		  if(type == "invites")
			dataset = "ARK_EmailTracking_Invites";
		  if(type == "reminders")
			dataset = "ARK_EmailTracking_Reminders";

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1275/" + dataset + "/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {

			  }
			},
			serverPaging: true,
			pageSize:15,
			serverFiltering: true,
			serverSorting: true,
			sort: { field: "Sent", dir: "desc" }


		  });

		},
	  },  
	  statistics: {
		countLoaded: 0,
		config: null,
		data: {},
		total: {},
		init: function(node) {
		  node.innerHTML = '';
		  const form = document.createElement("div");
		  form.setAttribute("id", "statistics-form");
		  node.appendChild(form);

		  const button = document.createElement("button");
		  button.setAttribute("id", "statistics-show");
		  button.classList.add('button-primary');
		  button.innerHTML = 'Show';
		  const buttonWrapper = document.createElement("div");
		  buttonWrapper.classList.add("statistics-show-wrapper");
		  buttonWrapper.appendChild(button);
		  node.appendChild(buttonWrapper);

		  const excelBtn = document.createElement("div");
		  excelBtn.classList.add("statistics-excel-button");
		  excelBtn.innerHTML = "<div role='button' class='k-button k-button-icontext k-grid-excel excel-button' href='#'>Export Excel</div>";
		  node.appendChild(excelBtn);

		  const reportsArea = emailTracking.ui.statistics.renderReports();
		  node.appendChild(reportsArea);

		  emailTracking.ui.statistics.config = emailTracking.ui.statistics.getConfig();
		  emailTracking.ui.statistics.config.dom = form;
		  nbsf.init(emailTracking.ui.statistics.config, 0);

		  button.addEventListener('click', function() {
			emailTracking.ui.statistics.showStats();
		  });

		  node.querySelector('.excel-button').addEventListener("click", function(e) {
			emailTracking.ui.statistics.exportExcel();
		  });

		  emailTracking.ui.statistics.showStats();
		},
		exportExcel: function() {
		  const data = [];

		  Object.keys(emailTracking.ui.statistics.data).forEach(function(key) {
			data.push([key]);
			data.push(["All", emailTracking.ui.statistics.total[key]]);
			const arr = emailTracking.ui.statistics.data[key];
			arr.forEach(item => {
			  data.push([item.category, item.value]);
			});
			data.push([]);
		  });

		  var processRow = function (row) {
			var finalVal = '';
			for (var j = 0; j < row.length; j++) {
			  var innerValue = row[j] === null ? '' : row[j].toString();
			  if (row[j] instanceof Date) {
				innerValue = row[j].toLocaleString();
			  };
			  var result = innerValue.replace(/"/g, '""');
			  if (result.search(/("|,|\n)/g) >= 0)
				result = '"' + result + '"';
			  if (j > 0)
				finalVal += ',';
			  finalVal += result;
			}
			return finalVal + '\n';
		  };

		  var csvFile = '';
		  for (var i = 0; i < data.length; i++) {
			csvFile += processRow(data[i]);
		  }

		  var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
		  if (navigator.msSaveBlob) { // IE 10+
			navigator.msSaveBlob(blob, filename);
		  } else {
			var link = document.createElement("a");
			if (link.download !== undefined) { // feature detection
			  // Browsers that support HTML5 download attribute
			  var url = URL.createObjectURL(blob);
			  link.setAttribute("href", url);
			  link.setAttribute("download", "Statistics.csv");
			  link.style.visibility = 'hidden';
			  document.body.appendChild(link);
			  link.click();
			  document.body.removeChild(link);
			}
		  }
		},
		showStats: function() {
		  const val = nbsf.ev.global(emailTracking.ui.statistics.config);

		  if (!val.total.fail) {
			mo.fn.overlay.show({ loading: true, close: false,});
			emailTracking.ui.statistics.countLoaded = 0;
			emailTracking.ui.statistics.loadReport('statistics-authcodes', 1166, 'ARK_AuthTokens', emailTracking.ui.statistics.config.dataset.DateRange, 'Auth codes');
			emailTracking.ui.statistics.loadReport('statistics-invites', 1275, 'ARK_EmailTracking_Invites', emailTracking.ui.statistics.config.dataset.DateRange, 'Invitations');
			emailTracking.ui.statistics.loadReport('statistics-reminders', 1275, 'ARK_EmailTracking_Reminders', emailTracking.ui.statistics.config.dataset.DateRange, 'Reminders');
		  }
		},
		renderReports: function() {
		  const reportsArea = document.createElement("div");
		  reportsArea.setAttribute("id", "statistics-reports");

		  const authCodes = document.createElement("div");
		  authCodes.setAttribute("id", "statistics-authcodes");
		  reportsArea.appendChild(authCodes);

		  const invites = document.createElement("div");
		  invites.setAttribute("id", "statistics-invites");
		  reportsArea.appendChild(invites);

		  const reminders = document.createElement("div");
		  reminders.setAttribute("id", "statistics-reminders");
		  reportsArea.appendChild(reminders);

		  return reportsArea;
		},
		loadReport: function(id, formId, dataset, daterange, name) {
		  const dr = daterange.split(';');
		  const dateFrAr = dr[0].split('/');
		  const dateFr = new Date(dateFrAr[2], dateFrAr[1]-1, dateFrAr[0]);
		  const dateToAr = dr[1].split('/');
		  const dateTo = new Date(dateToAr[2], dateToAr[1]-1, dateToAr[0]);

		  const filters = [{
			field: 'Created',
			operator: 'gt',
			value: dateFr.toISOString(),
		  }, {
			field: 'Created',
			operator: 'lt',
			value: dateTo.toISOString(),
		  }];

		  let groupField = null;
		  if (dataset === 'ARK_AuthTokens') {
			groupField = 'EmailStatus';
			filters.push({
			  field: 'EmailStatus',
			  operator: 'neq',
			  value: '-',
			});
		  } else {
			groupField = 'Status';
		  }

		  const rep = new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: `https://hpe-rfb.it.hpe.com/form/data-set-provider/v2/${formId}/${dataset}/kendo/data/search`,
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				//	  id: "EntryId",
				fields: {
				}
			  }
			},
			serverFiltering: true,
			filter: {
			  logic: 'and',
			  filters: filters,
			},
			group: { field: groupField },
			serverGrouping: true,
			serverSorting: true,
		  });
		  rep.read().then(function() {
			emailTracking.ui.statistics.countLoaded++;
			if (emailTracking.ui.statistics.countLoaded === 3) {
			  mo.fn.overlay.hide();
			}
			const view = rep.view();
			emailTracking.ui.statistics.createChart(id, view, name);
		  });
		},
		createChart: function(id, view, name) {
		  const colors = {
			Failed: "#FA3A37",
			Sent: "#8BFAA7",
			Read: "#068c35",
			'Sent (confirmed)': "#90cc38",
		  };

		  const data = view.map(function(group) {
			return {
			  category: group.value,
			  value: group.items.length,
			  color: colors[group.value],
			};
		  });
		  emailTracking.ui.statistics.data[name] = data;

		  var total = 0;
		  view.forEach(x => total += x.items.length);
		  emailTracking.ui.statistics.total[name] = total;

		  $("#" + id).kendoChart({
			theme: "flat",
			title: {
			  position: "top",
			  text: name + " (" + total + ")",
			},
			legend: {
			  visible: false
			},
			chartArea: {
			  background: ""
			},
			seriesDefaults: {
			  type: "donut",
			  startAngle: 120,
			},
			series: [{
			  name: "Status",
			  data: data,
			  labels: {
				visible: true,
				background: "transparent",
				position: "outsideEnd",
				template: "#= category #: \n #= value#"
			  }
			}],
			tooltip: {
			  visible: false,
			  template: "#= category #: #= value #"
			}
		  });
		},
		getConfig: function() {
		  const dt = new Date();
		  dt.setMonth(dt.getMonth() - 1);
		  const dateRangeValue = dt.toLocaleString('en-GB').split(',')[0] + ';' + new Date().toLocaleString('en-GB').split(',')[0];

		  return {
			dataset: {
			  "DateRange": null,
			},
			pages: [{
			  title: "",
			  subtitle: "",
			  description: "",
			  nav: false,
			  //  width: '',
			  structure: [{
				header: "",
				description: "",
				group: [
				  [
					{
					  label: "Date range",
					  data: "DateRange",
					  required: true,
					  type: "daterange",
					  value: dateRangeValue,
					  dtpStart: {
						format: 'd/m/Y',
						formatDate: 'd/m/Y',
						timepicker: false,
						onChangeDateTime: function(dp, $input) {}
					  },
					  dtpEnd: {
						format: 'd/m/Y',
						formatDate: 'd/m/Y',
						timepicker: false,
						onChangeDateTime: function(dp, $input) {}
					  }
					}
				  ],
				]
			  }],
			  callback: function() {},
			  validation: function() {
				var result = {
				  fail: [],
				  pass: []
				};
				return result;
			  }
			}],
			onClone: function(donor, clone) {
			  //console.log("Called anytime a clone is generated");
			},
			onDeClone: function(donor, clone) {
			  //console.log("Called anytime a clone is deleted");
			},
			onNext: function() {
			  console.log("CONFIG:", this);
			  console.log("CURRENT:", this.page);
			  console.log("NEXT:", this.page + 1);
			  console.log("DATA:", this.dataset);
			  nbsf.init(config, config.page + 1);
			},
			onPrev: function() {
			  console.log("CONFIG:", this);
			  console.log("CURRENT:", this.page);
			  console.log("PREV:", this.page - 1);
			  console.log("DATA:", this.dataset);
			  nbsf.init(config, config.page - 1);
			},
			onSubmit: function() {
			  console.log("CONFIG", this);
			  console.log("DATA", this.dataset);
			}
		  };
		},
	  }
	},

  }
</script>


<!-- COMPONENT PROFILE -->
<script>
  const profile = {
	ready: false,
	init: function() {
	  if (!profile.ready) {
		profile.personal();
		profile.roles();
		profile.ready = true;
	  }
	},
	personal: function() {
	  var personal = document.querySelector("#profile .personal");
	  personal.innerHTML += '<p>Version: ' + access.version + '</p>';
	  personal.innerHTML += '<p>Name: ' + access.user.FirstName + " " + access.user.LastName + '</p>';
	  personal.innerHTML += '<p>Email: ' + access.user.Email + '</p>';
	  //personal.innerHTML += '<p>Logged in: ' + access.user.LastLogin.split("T").join(", ") + '</p>';
	},
	roles: function() {
	  var selector = document.querySelector("#profile .roles ul");

	  function regional(role) {
		var regions = [];
		var keys = Object.keys(access.user.UserRole[role]);
		for (i = 0; i < keys.length; i++) {
		  if (Array.isArray(access.user.UserRole[role][keys[i]])) {
			if (access.user.UserRole[role].EMEA && access.user.UserRole[role].EMEA.length) regions.push("EMEA: " + access.user.UserRole[role][keys[i]].length);
			if (access.user.UserRole[role].AMS && access.user.UserRole[role].AMS.length) regions.push(" AMS: " + access.user.UserRole[role][keys[i]].length);
			if (access.user.UserRole[role].APJ && access.user.UserRole[role].APJ.length) regions.push(" APJ: " + access.user.UserRole[role][keys[i]].length);
			return regions.join(", ");
		  } else if (access.user.UserRole[role][keys[i]]) {
			Object.entries(access.user.UserRole[role]).forEach(function([index, value]) {
			  if (value == true) regions.push(index);
			});

			if (regions.length == 3) return "WW";
			else if (!regions.length) return "N/A";
			else return regions.join(", ");
		  }
		}
	  }

	  function insert(role, regions) {
		switch (role.toLowerCase()) {
		  case "admin":
			return "Administrator";
			break;
		  case "loc":
			return "Localization";
			break;
		  case "cmr":
			return "Country Management Role";
			break;
		  case "ddi":
			return "DDI Investigation";
			break;
		  case "edd":
			return "EDD Investigation";
			break;
		  case "rl":
			return "Regional Lead";
			break;
		  case "ddis":
			return "DDI Scoring";
			break;
		  case "idd":
			return "IDD Investigation";
			break;
		  case "ifm":
			return "Intake Forms Management";
			break;
		  case "opa":
			return "Operational Admin Role";
			break;
		  case "rpr":
			return "Reporting";
			break;
		  case "at":
			return "Agility Team";
			break;
		  case "uar":
			return "User Admin Role";
			break;
		}
	  }

	  var sorted = Object.entries(access.user.UserRole).sort(x => typeof(x[1]) == "boolean");
	  var keys = sorted.map(x => x[0]);
	  for (j = 0; j < keys.length; j++) {
		if (access.user.UserRole[keys[j]]) {
		  if (typeof(access.user.UserRole[keys[j]]) === "boolean" && insert(keys[j]))
			selector.innerHTML += '<li>' + insert(keys[j]) + '<span>✓</span></li>';
		  else if (regional(keys[j]) &&  insert(keys[j], regional(keys[j])))
			selector.innerHTML += '<li>' + insert(keys[j], regional(keys[j])) + '<span>' + regional(keys[j]) + '</span></li>';
		}
	  }

	}
  }
</script>

<!-- REFERENCE -->
<script>
  const reference = {
	init: function(callback) {
	  var idx = 0;
	  const cb = function() {
		idx++;
		if (idx >= 8) {
		  callback();
		}
	  };
	  reference.users.init(cb);
	  reference.configs.init(cb);
	  reference.translations.init(cb);
	  reference.countries.init(cb);
	  reference.states.init(cb);
	  reference.languages.init(cb);
	  reference.tasks.init(cb);
	  reference.categories.init(cb);
	},
	users: {
	  data: [],
	  init: function(callback) {

		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/641/ARK_Users_MetaData/kendo/data/search",
			  type: 'POST'
			},
		  },
		});
		dataSource.read().then(function() {
		  var view = dataSource.view();

		  view.forEach(x => {
			reference.users.data.push(x.toJSON());
		  });
		  callback();
		});
	  }
	},
	configs: {
	  data: [],
	  all: [],
	  init: function(callback) {

		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1279/ARK_Configs_MetaData/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverFiltering: true,

		});
		dataSource.read().then(function() {
		  var view = dataSource.view();

		  view.forEach(x => {
			x.Label = x.ConfigName + " " + x.Version;

			if(x.Status == 1)
			  reference.configs.data.push(x.toJSON());
			else 
			  x.Label += " - NOT IN USE"; 

			reference.configs.all.push(x.toJSON());	
		  });
		  callback();
		});
	  }
	},
	translations: {
	  data: [],
	  groups: {},
	  init: function(callback) {

		var dataSourceWOEmails = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1274/ARK_Localization/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverFiltering: true,
		  filter: {
			logic: "and",
			filters: [{
			  field: "Group",
			  operator: "neq",
			  value: "EmailReminder"
			},
					  {
						field: "Group",
						operator: "neq",
						value: "Emails"
					  }
					 ]
		  }
		});

		var dataSourceEmails = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1274/ARK_Localization_MetaData/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverFiltering: true,
		  filter: {
			logic: "or",
			filters: [{
			  field: "Group",
			  operator: "eq",
			  value: "EmailReminder"
			},
					  {
						field: "Group",
						operator: "eq",
						value: "Emails"
					  }
					 ]
		  }
		});

		dataSourceWOEmails.read().then(function() {
		  dataSourceEmails.read().then(function() {

			var view = dataSourceWOEmails.view();
			var view2 = dataSourceEmails.view();

			function add(rawItem) {
			  var item = rawItem.toJSON();
			  reference.translations.data[item.Key] = item;


			  if (reference.translations.groups[item.Group])
				reference.translations.groups[item.Group].push(item)
			  else reference.translations.groups[item.Group] = [item];
			}

			reference.translations.data = {};
			for (var i = 0; i < view.length; i++)
			  add(view[i]);

			for (var i = 0; i < view2.length; i++)
			  add(view2[i]);


			callback();
		  });
		});
	  }
	},
	countries: {
	  data: [],
	  rawData: [],
	  options: function() {
		return reference.countries.data.map(function(x) {
		  return x.option
		})
	  },
	  values: function() {
		return reference.countries.data.map(function(x) {
		  return x.value
		})
	  },
	  init: function(callback) {
		crud.read('3668', "", function(d) {

		  reference.countries.rawData = d.Rows;
		  var data = d.Rows.sort((a, b) => (a.Name > b.Name) ? 1 : ((b.Name > a.Name) ? -1 : 0));
		  data.forEach(function(el) {

			reference.countries.data.push({
			  option: el.Name,
			  value: el.ISO2,
			  states: el.states
			})
		  });

		  callback();
		});
	  }
	},
	states: {
	  data: [],
	  init: function(callback) {
		crud.read(3672, "", function(d) {
		  reference.states.data = d.Rows;
		  for (var i = 0; i < reference.countries.data.length; i++)
			for (var j = 0; j < reference.states.data.length; j++)
			  if (reference.countries.data[i].ISO2 == reference.states.data[j].ISO2) {
				try {
				  reference.countries.data[i].states = JSON.parse(reference.states.data[j].Districts);
				} catch (e) {
				  reference.countries.data[i].states = [];
				}
			  }
		  callback();
		})
	  }
	},
	convertCountry: function(identifier, revert) {
	  for (var i = 0; i < reference.countries.data.length; i++) {
		if (revert) {
		  if (reference.countries.data[i].option == identifier) {
			return reference.countries.data[i].value;
		  }
		} else {
		  if (reference.countries.data[i].value == identifier) {
			return reference.countries.data[i].option;
		  }
		}
	  }
	},
	convertState: function(country, state, revert) {
	  try {
		var countryInfo = reference.states.data.find(x => x.ISO2 == country);
		if (countryInfo) {
		  var statesInfo = JSON.parse(countryInfo.Districts);
		  var stateInfo = statesInfo.find(x => x.code == state);
		  if (stateInfo)
			return stateInfo.name;
		}
	  } catch (e) {}

	  return null;
	},
	convertAll: function(el, state, revert) {
	  if (el) {
		if (state) {

		  console.log(el);
		  for (var i = 0; i < reference.states.data.length; i++) {
			if (revert) {
			  if (reference.states.data[i].name == el) {
				return reference.countries.data[i].ISO2;
			  }
			} else {
			  if (reference.countries.data[i].ISO2 == el) {
				return reference.countries.data[i].name;
			  }
			}
		  }
		} else {
		  for (var i = 0; i < reference.countries.data.length; i++) {
			if (revert) {
			  if (reference.countries.data[i].option == el) {
				return reference.countries.data[i].value;
			  }
			} else {
			  if (reference.countries.data[i].value == el) {
				return reference.countries.data[i].option;
			  }
			}
		  }

		}
	  }
	  return el;
	},
	/*languages: [
                  {
                    value: 'es_ES',
                    option: 'Spanish'
                  },
                  {
                    value: 'cz_CH',
                    option: 'Czech'
                  },
                  {
                    value: 'de_DE',
                    option: 'German'
                  },
                  {
                    value: 'en_US',
                    option: 'English (US)'
                  },
                  {
                    value: 'es_MX',
                    option: 'LAR Spanish'
                  },
                  {
                    value: 'fr_FR',
                    option: 'French'
                  },
                  {
                    value: 'in_ID',
                    option: 'Indonesian'
                  },
                  {
                    value: 'it_IT',
                    option: 'Italian'
                  },
                  {
                    value: 'hu_HU',
                    option: 'Hungarian'
                  },
                  {
                    value: 'pl_PL',
                    option: 'Polish'
                  },
                  {
                    value: 'pt_PT',
                    option: 'Portuguese'
                  },
                  {
                    value: 'pt_BR',
                    option: 'Portuguese (Brazil)'
                  },
                  {
                    value: 'fr_CA',
                    option: 'French (Canada)'
                  },
                  {
                    value: 'ro_RO',
                    option: 'Romanian'
                  },
                  {
                    value: 'sk_SK',
                    option: 'Slovak'
                  },
                  {
                    value: 'tr_TR',
                    option: 'Turkish'
                  },
                  {
                    value: 'vi_VN',
                    option: 'Vietnamese'
                  },

                  {
                    value: 'gr_GR',
                    option: 'Greek'
                  },

                  {
                    value: 'ru_RU',
                    option: 'Russian'
                  },
                  {
                    value: 'he_IL',
                    option: 'Hebrew'
                  },
                  {
                    value: 'ar_AE',
                    option: 'Arabic'
                  },
                  {
                    value: 'th_TH',
                    option: 'Thai'
                  },
                  {
                    value: 'zh_CN',
                    option: 'Chinese (simplified)'
                  },
                  {
                    value: 'zh_TW',
                    option: 'Chinese (traditional)'
                  },
                  {
                    value: 'ja_JP',
                    option: 'Japanese'
                  },
                  {
                    value: 'ko_KR',
                    option: 'Korean'
                  },
                  {
                    value: "ms_MY",
                    option: 'Malay'
                  }
                ],*/
	languages: {
	  data: [],
	  init: function(callback) {

		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1476/LanguagesList/kendo/data/search",
			  type: 'POST'
			},
		  },
		});
		dataSource.read().then(function() {
		  var view = dataSource.view();

		  view.forEach(x => {
			var item = {};
			item.value = x.LanguageCode;
			item.option = x.LanguageName;
			item.aliases = JSON.parse(x.Aliases);
			reference.languages.data.push(item);
		  });
		  callback();
		});
	  }
	},
	category: [
	  {
		value: 'Brokers/Forwarders',
		configs: ['lsp_prospective', 'lsp_renewal']
	  },
	  {
		value: 'Logistics',
		configs: ['lsp_prospective', 'lsp_renewal']
	  },
	  {
		value: 'Hierarchy',
		configs: ['hierarchy']
	  },
	  {
		value: 'Multi-National Partner',
		configs: ['multi_national']
	  },
	  {
		value: 'Lobbyist',
		configs: ['lobbyist', 'lobbyist_renewal']
	  },
	  {
		value: 'Marketing Vendor',
		configs: ['marketing_vendor']
	  },
	  {
		value: 'Micro Focus',
		configs: ['reseller_prospective', 'proximity_prospective']
	  },
	  {
		value: 'OEM',
		configs: ['oem', 'oem_renewal']
	  },
	  {
		value: 'Reseller-Current',
		configs: ['reseller_current_2', 'reseller_current', 'reseller_renewal']
	  },
	  {
		value: 'Reseller-Prospective',
		configs: ['reseller_prospective', 'proximity_prospective']
	  },
	  {
		value: 'Reseller-Simplified',
		configs: ['reseller_simplified']
	  },
	  {
		value: 'Reseller-South Korea-Current',
		configs: ['reseller_current_sk', 'reseller_reactivation_sk']
	  },
	  {
		value: 'Supplier',
		configs: ['supplier_prospective', 'supplier_renewal']
	  },
	],
	categories: {
	  data: [],
	  init: function(callback) {

		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1647/Ark Categories/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverSorting: true,
		  sort: {
			field: "Category",
			dir: "asc"
		  }
		});
		dataSource.read().then(function() {
		  var view = dataSource.view();
		  var result = [];
		  view.reduce(function (r, a, idx) {
			if(r != null && r.value == a.Category) {
			  r.configs = r.configs;
			  r.configs.push(a.Config);
			}
			else {
			  if(r!==null)
				result.push(r);
			  r = Object.create(null);
			  r.value = a.Category;
			  r.configs = [a.Config];
			}
			if(idx == view.length-1) {
			  result.push(r);
			}
			return r;
		  }, null);
		  reference.categories.data = result;
		  reference.category = result;
		  callback();
		});
	  }
	},
	profileCascadeDelete: {
	  start: function(id, cb) {
		console.log("Profile Cascade Delete: delete profile");
		reference.profileCascadeDelete.deleteProfile(id, function() {
		  console.log("Profile Cascade Delete: delete custom fields");
		  reference.profileCascadeDelete.deleteCustomFields(id, function() {
			console.log("Profile Cascade Delete: delete attachments");
			reference.profileCascadeDelete.deleteAttachments(id, function() {
			  console.log("Profile Cascade Delete: delete audit log");
			  reference.profileCascadeDelete.deleteAuditLog(id, function() {
				console.log("Profile Cascade Delete: delete notes");
				reference.profileCascadeDelete.deleteNotes(id, function() {
				  console.log("Profile Cascade Delete: done");
				  cb();
				  //reference.caseCascadeDelete.findCasesByCompanyFK(id, cb);
				});
			  });
			});
		  });
		});
	  },
	  deleteProfile: function(id, cb) {
		crud.read("4079", "eid=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4337", id, function(d) {
			  console.log("Profile Cascade Delete: profile deleted");
			  cb();
			});
		  } else {
			console.log("Profile Cascade Delete: profile not found");
			cb();
		  }
		});
	  },
	  deleteCustomFields: function(id, cb) {
		crud.read("4011", "eid=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4338", resp.Rows[0].EntryId, function(d) {
			  console.log("Profile Cascade Delete: custom fields are removed");
			  cb();
			});
		  } else {
			console.log("Profile Cascade Delete: custom fields not found");
			cb();
		  }
		});
	  },
	  deleteAttachments: function(id, cb) {
		crud.read("4020", "cfk=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Profile Cascade Delete: attachments delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Profile Cascade Delete: all attachments are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("3991", resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Profile Cascade Delete: attachments not found");
			cb();
		  }
		});
	  },
	  deleteAuditLog: function(id, cb) {
		crud.read("4018", "cfk=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Profile Cascade Delete: audit log delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Profile Cascade Delete: all audit logs are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("4019", resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Profile Cascade Delete: audit log not found");
			cb();
		  }
		});
	  },
	  deleteNotes: function(id, cb) {
		crud.read("4016", "cfk=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Profile Cascade Delete: notes delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Profile Cascade Delete: all notes are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("4017", resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Profile Cascade Delete: notes not found");
			cb();
		  }
		});
	  }
	},
	caseCascadeDelete: {
	  findCasesByCompanyFK: function(pid, cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_TestCases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverFiltering: true,
		  filter: {
			field: "CompanyFK",
			operator: "eq",
			value: pid
		  },
		  serverSorting: true,
		  serverPaging: true,
		  pageSize: 1000,
		});

		ds.read().then(function() {
		  var data = ds.view();

		  if (data.length) {
			const total = data.length;
			var idx = 0;
			const callback = function() {
			  idx++;
			  if (idx == total) {
				cb();
			  } else if (currIdx < total) {
				reference.caseCascadeDelete.start(data[idx].EntryId, callback);
			  }
			};
			reference.caseCascadeDelete.start(data[idx].EntryId, callback);
		  } else {
			cb();
		  }
		});

	  },
	  start: function(id, cb) {
		console.log("Case Cascade Delete: delete case");
		reference.caseCascadeDelete.deleteCase(id, function() {
		  console.log("Case Cascade Delete: delete overview");
		  reference.caseCascadeDelete.deleteOverview(id, function() {
			console.log("Case Cascade Delete: delete scoring");
			reference.caseCascadeDelete.deleteScoring(id, function() {
			  console.log("Case Cascade Delete: delete data intake");
			  reference.caseCascadeDelete.deleteDataIntake(id, function() {
				console.log("Case Cascade Delete: delete reminders");
				reference.caseCascadeDelete.deleteReminders(id, function() {
				  console.log("Case Cascade Delete: delete custom fields");
				  reference.caseCascadeDelete.deleteCustomFields(id, function() {
					console.log("Case Cascade Delete: delete attachments");
					reference.caseCascadeDelete.deleteAttachments(id, function() {
					  console.log("Case Cascade Delete: delete audit log");
					  reference.caseCascadeDelete.deleteAuditLog(id, function() {
						console.log("Case Cascade Delete: delete notes");
						reference.caseCascadeDelete.deleteNotes(id, function() {
						  console.log("Case Cascade Delete: done");
						  cb();
						});
					  });
					});
				  });
				});
			  });
			});
		  });
		});
	  },
	  deleteCase: function(id, cb) {
		crud.read("3694", "eid=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4339", id, function(d) {
			  console.log("Case Cascade Delete: case deleted");
			  cb();
			});
		  } else {
			console.log("Case Cascade Delete: case not found");
			cb();
		  }
		});
	  },
	  deleteOverview: function(id, cb) {
		crud.read("3703", "inv=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4340", id, function(d) {
			  console.log("Case Cascade Delete: overview deleted");
			  cb();
			});
		  } else {
			console.log("Case Cascade Delete: overview not found");
			cb();
		  }
		});
	  },
	  deleteScoring: function(id, cb) {
		crud.read("3712", "inv=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4341", id, function(d) {
			  console.log("Case Cascade Delete: scoring deleted");
			  cb();
			});
		  } else {
			console.log("Case Cascade Delete: scoring not found");
			cb();
		  }
		});
	  },
	  deleteDataIntake: function(id, cb) {
		crud.read("3699", "inv=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4342", id, function(d) {
			  console.log("Case Cascade Delete: intake data deleted");
			  cb();
			});
		  } else {
			console.log("Case Cascade Delete: intake data not found");
			cb();
		  }
		});
	  },
	  deleteReminders: function(id, cb) {
		crud.read("4256", "inv=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Case Cascade Delete: reminders delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Case Cascade Delete: all reminders are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("3898", "eid=" + resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Case Cascade Delete: reminders not found");
			cb();
		  }
		});
	  },
	  deleteCustomFields: function(id, cb) {
		crud.read("4012", "eid=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4343", resp.Rows[0].EntryId, function(d) {
			  console.log("Case Cascade Delete: custom fields are removed");
			  cb();
			});
		  } else {
			console.log("Case Cascade Delete: custom fields not found");
			cb();
		  }
		});
	  },
	  deleteAttachments: function(id, cb) {
		crud.read("4026", "ifk=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Case Cascade Delete: attachments delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Case Cascade Delete: all attachments are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("3991", resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Case Cascade Delete: attachments not found");
			cb();
		  }
		});
	  },
	  deleteAuditLog: function(id, cb) {
		crud.read("4025", "ifk=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Case Cascade Delete: audit log delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Case Cascade Delete: all audit logs are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("4019", resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Case Cascade Delete: audit log not found");
			cb();
		  }
		});
	  },
	  deleteNotes: function(id, cb) {
		crud.read("4024", "ifk=" + id, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const remove = function(idx) {
			  console.log(`Case Cascade Delete: notes delete ${idx}/${resp.Rows.length}`);
			  const nextCB = function() {
				idx++;
				if (idx >= resp.Rows.length) {
				  console.log("Case Cascade Delete: all notes are removed");
				  cb();
				  return;
				} else {
				  remove(idx);
				  return;
				}
			  };
			  crud.destroy("4017", resp.Rows[idx].EntryId, function(d) {
				nextCB();
			  });
			  return;
			};
			remove(idx);
		  } else {
			console.log("Case Cascade Delete: notes not found");
			cb();
		  }
		});
	  }
	},
	generateUid: function() {
	  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		var r = Math.random() * 16 | 0,
			v = c == 'x' ? r : (r & 0x3 | 0x8);
		return v.toString(16);
	  });
	},
	tasks: {
	  data: [],
	  init: function(callback) {

		var dataSource = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1485/Tasks Config/kendo/data/search",
			  type: 'POST'
			},
		  },
		});
		dataSource.read().then(function() {
		  var view = dataSource.view();
		  console.log(view);

		  view.forEach(x => {
			var item = {};
			item.id = x.TaskId;
			item.caption = x.Caption;
			item.permissions = JSON.parse(x.Permissions || '[]');
			item.emails = JSON.parse(x.Emails || '[]');
			item.statuses = JSON.parse(x.Statuses || '[]');
			item.ops = JSON.parse(x.Operations || '[]');
			item.attachment = JSON.parse(x.Attachment || '{}');
			item.comment = JSON.parse(x.Comment || '{}');
			item.next = JSON.parse(x.NextAction || '{}');
			item.title = x.TaskName;
			reference.tasks.data.push(item);
		  });
		  invitation.invitationOverview.tasks.config = reference.tasks.data;
		  callback();
		});
	  }
	},
	switchMonthDay: function(value) {
	  // if empty fo nothing
	  if(!value) {
		return undefined;
	  }
	  var dayFirst = false;
	  if(value.indexOf('AM') > -1 || value.indexOf('PM') > -1) {
		value = value.replace('AM', ' AM').replace('PM', ' PM').replace(/\s{2,}/g, ' ');
		dayFirst = true;
	  }

	  // when string is corrected, start to switch values properly
	  var date = new Date(value);
	  if(date.getFullYear() === 1900) {
		return undefined;
	  }
	  // undo timezone offset if it exists
	  var userTimezoneOffset = date.getTimezoneOffset() * 60000;
	  var resultDate = new Date(date.getTime() - userTimezoneOffset);

	  var parts = value.split('/');

	  // there should be 3 parts: day month year+time
	  if(parts.length >= 3) {
		var month = Number(parts[dayFirst ? 1 : 0]);
		var day = Number(parts[dayFirst ? 0 : 1]);
		date.setMonth(month-1);
		date.setDate(day); 
	  }
	  else { // just in case if date somehow in another format
		return undefined;
	  }

	  var userTimezoneOffset = date.getTimezoneOffset() * 60000;
	  var resultDate = new Date(date.getTime() - userTimezoneOffset);
	  return resultDate.toISOString();
	}
  }
</script>

<!-- PARTY ID DETAILS POPUP -->
<script>
  const partyIdDetails = {
	init: function(partyId, raw) {

	  if (typeof(raw) === "string")
		raw = JSON.parse(raw);

	  partyIdDetails.partyId = partyId;
	  partyIdDetails.raw = raw;

	  if (partyId) {
		if (raw)
		  partyIdDetails.showModal();
		else {
		  //get data
		  mo.fn.overlay.show({
			close: false,
			loading: true
		  });

		  companyAPI2.searchCompany({
			PartyId: partyId
		  }, function(d) {
			partyIdDetails.raw = d.data[0].RAW;
			partyIdDetails.showModal();

			mo.fn.overlay.hide();
		  });
		}
	  }


	},
	showModal: function() {
	  mo.fn.modal.show({
		ctaLabel: "OK",
		title: "Party Id: " + partyIdDetails.partyId,
		class: "ark-modal",
		content: "<div class='partyId-details'><div>",
		contentCallback: function() {
		  hpe.ui.tabs({
			dom: document.querySelector(".dxpModalContent .partyId-details"),
			tabs: [{
			  label: "Type",
			  id: "type"
			},
				   {
					 label: "EID",
					 id: "eid"
				   },
				   {
					 label: "Address",
					 id: "Address"
				   },
				   {
					 label: "DUNS",
					 id: "DUNS"
				   },
				   {
					 label: "RAW",
					 id: "RAW"
				   },
				  ]
		  }, function(all) {

			var raw = partyIdDetails.raw;

			// DUNS
			var duns = all[3];
			duns.innerHTML = "";
			// DUNS IDs
			if (raw["dnb"] && Object.keys(raw["dnb"]).length != 0) {
			  duns.innerHTML += "<div class='result'>" +
				"<p>DUNS IDs (<span title='Last D&B update'>" + jstr(raw["dnb"][0]["dnbLastEnrichedDate"]).split(" ")[0] + "</span>)</p>" +
				"<div class='box'><strong>Domestic ID:</strong><em>" + jstr(raw["dnb"][0]["domesticUltimateDUNSId"]) + "</div>" +
				"<div class='box'><strong>Global ID:</strong><em>" + jstr(raw["dnb"][0]["globalUltimateDUNSId"]) + "</div>" +
				"<div class='box'><strong>Parent ID:</strong><em>" + jstr(raw["dnb"][0]["parentDUNSId"]) + "</div>" +
				"<div class='box'><strong>HQ ID:</strong><em>" + jstr(raw["dnb"][0]["headquarterDUNSId"]) + "</div>" +
				"</div>";
			  // DUNS BUS INFO 1
			  duns.innerHTML += "<div class='result'>" +
				"<p>Primary business overview</p>" +
				"<div class='box'><strong>Headquarter:</strong><em>" + jstr(raw["dunsHeadquarterIndicator"]) + "</div>" +
				"<div class='box'><strong>Branch:</strong><em>" + jstr(raw["dnb"][0]["branchIndicator"]) + "</div>" +
				"<div class='box'><strong>Marketable:</strong><em>" + jstr(raw["dnb"][0]["marketableIndicator"]) + "</div>" +
				"<div class='box'><strong>Standalone:</strong><em>" + jstr(raw["dnb"][0]["standAloneIndicator"]) + "</div>" +
				"</div>";
			  // DUNS BUS INFO 2
			  duns.innerHTML += "<div class='result'>" +
				"<p>Secondary business overview</p>" +
				"<div class='box'><strong>Minority owned:</strong><em>" + jstr(raw["dnb"][0]["minorityOwnedIndicator"]) + "</div>" +
				"<div class='box'><strong>Subsidiery:</strong><em>" + jstr(raw["dnb"][0]["subsidiaryIndicator"]) + "</div>" +
				"<div class='box' style='width:100%;clear:both;height:auto;'><strong>Ownership:</strong><em>" + jstr(raw["dnb"][0]["controlOwnershipType"]) + "</div>" +
				"</div>";
			  // DUNS EMPLOYEE INFO
			  duns.innerHTML += "<div class='result'>" +
				"<p>Employee overview</p>" +
				"<div class='box'><strong>Total:</strong><em>" + jstr(raw["dnb"][0]["totalEmployeeCount"]) + "</div>" +
				"<div class='box'><strong>Reliability:</strong><em title='Reliability code:" + jstr(raw["dnb"][0]["employeeInformationReliabilityCode"]) + "'>" + jstr(raw["dnb"][0]["employeeInformationReliabilityName"]) + "</div>" +
				"<div class='box'><strong>Scope:</strong><em>" + jstr(raw["dnb"][0]["employeeInformationScopeName"]) + "</div>" +
				"<div class='box'><strong>Code:</strong><em>" + jstr(raw["dnb"][0]["employeeInformationScopeCode"]) + "</div>" +
				"</div>";
			  duns.innerHTML += "<div class='clear'></div>";
			} else duns.innerHTML += "<p>DUNS data missing. </p>";


			// EID
			var eid = all[1];
			eid.innerHTML = "";
			if (raw["externalIdentifier"] && Object.keys(raw["externalIdentifier"]).length != 0) {
			  for (i = 0; i < raw["externalIdentifier"].length; i++) {
				eid.innerHTML += "<div class='result'>" +
				  "<p>[" + jstr(raw["externalIdentifier"][i]["countryCode"]) + "] " + jstr(raw["externalIdentifier"][i]["externalIdentifierName"]) + "</p>" +
				  "<div class='box'><strong>Value:</strong><em>" + jstr(raw["externalIdentifier"][i]["identifierValue"]) + "</div>" +
				  "<div class='box'><strong>Status:</strong><em>" + jstr(raw["externalIdentifier"][i]["status"]) + "</em></div>" +
				  "</div>";
			  }
			  eid.innerHTML += "<div class='clear'></div>";
			} else eid.innerHTML += "<p>EID data missing. Record likely internally sourced.</p>";

			// ADDRESSES
			var addy = all[2];
			addy.innerHTML = "";
			if (raw["address"]) {
			  for (i = 0; i < raw["address"].length; i++) {
				var country = jstr(raw["address"][i]["country"]) + ", ";
				if (country.indexOf("null") > -1) country = "";
				var city = jstr(raw["address"][i]["cityName"]) + ", ";
				if (city.indexOf("null") > -1) city = "";
				var province = jstr(raw["address"][i]["stateProvinceCd"]) + ", ";
				if (province.indexOf("null") > -1) province = "";
				var district = jstr(raw["address"][i]["district"]) + ", ";
				if (district.indexOf("null") > -1) district = "";
				var county = jstr(raw["address"][i]["countyName"]) + ", ";
				if (county.indexOf("null") > -1) county = "";
				var adline1 = jstr(raw["address"][i]["addressLine1"]) + ", ";
				if (adline1.indexOf("null") > -1) adline1 = "";
				var adline2 = jstr(raw["address"][i]["addressLine2"]) + ", ";
				if (adline2.indexOf("null") > -1) adline2 = "";
				var adline3 = jstr(raw["address"][i]["addressLine3"]) + ", ";
				if (adline3.indexOf("null") > -1) adline3 = "";
				var postal = jstr(raw["address"][i]["postalCode"]);
				if (postal == "null") postal = "N/A";

				if (jstr(raw["address"][i]["addressValidationIndicator"]) == "Y") var validated = "Yes";
				else if (jstr(raw["address"][i]["addressValidationIndicator"]) == "N") var validated = "No";
				else var validated = "N/A";

				if (jstr(raw["address"][i]["addressType"]) == "PHY") var addytype = "Physical";
				else if (jstr(raw["address"][i]["addressType"]) == "POST") var addytype = "Postal";
				else var addytype = "N/A";

				if (jstr(raw["address"][i]["addressDeliveryIndicator"]) == "Y") var delivery = "Yes";
				else if (jstr(raw["address"][i]["addressDeliveryIndicator"]) == "N") var delivery = "No";
				else var delivery = "N/A";

				if (jstr(raw["address"][i]["externalIndicator"]) == "Y") var external = "Yes";
				else if (jstr(raw["address"][i]["externalIndicator"]) == "N") var external = "No";
				else var external = "N/A";

				var fulladdy = adline1 + adline2 + adline3 + city + district + county + province + country + postal;

				if (typeof(raw["address"][i]["status"]) !== "undefined" && raw["address"][i]["status"] == "ACTIVE") {
				  var css = "style='border:1px solid #00B388;color:#00B388;'"
				  } else css = "";

				addy.innerHTML += "<div class='result' " + css + ">" +
				  "<p>[" + jstr(raw["address"][i]["country"]) + "] " + jstr(raw["address"][i]["cityName"]) + "</p>" +
				  "<div class='box'><strong>Address type:</strong><em>" + addytype + "</em></div>" +
				  "<div class='box'><strong>Delivery address:</strong><em>" + delivery + "</em></div>" +
				  "<div class='box'><strong>Externally sourced:</strong><em>" + external + "</em></div>" +
				  "<div class='box'><strong>Validated address:</strong><em>" + validated + "</em></div>" +
				  "<div class='box' style='width:100%;clear:both;height:auto;'><strong>Full address:</strong><em>" + fulladdy + "</div>" +
				  "</div>";
			  }
			  addy.innerHTML += "<div class='clear'></div>";
			}

			// BUSINESS RELATIONSHIP
			var br = all[0];
			br.innerHTML = "";
			if (raw["businessRelationship"] && Object.keys(raw["businessRelationship"]).length != 0) {
			  for (i = 0; i < raw["businessRelationship"].length; i++) {
				var begindate = "-";
				if (raw["businessRelationship"][i]["beginDate"])
				  begindate = jstr(raw["businessRelationship"][i]["beginDate"]).split(" ")[0];

				var enddate = "-";
				if (raw["businessRelationship"][i]["endDate"])
				  enddate = jstr(raw["businessRelationship"][i]["endDate"]).split(" ")[0];

				if (enddate.indexOf("null") > -1) enddate = "";
				br.innerHTML += "<div class='result'>" +
				  "<p>" + jstr(raw["businessRelationship"][i]["businessRelationshipName"]) + " (<span title='" + jstr(raw["businessRelationship"][i]["beginDate"]) + "'>" + begindate + "</span><span title='" + jstr(raw["businessRelationship"][i]["endDate"]) + "'> to" + enddate + ")</p>" +
				  "<div class='box'><strong>BR Code:</strong><em>" + jstr(raw["businessRelationship"][i]["businessRelationshipCode"]) + "</div>" +
				  "<div class='box'><strong>Status:</strong><em>" + jstr(raw["businessRelationship"][i]["status"]) + "</em></div>" +
				  "</div>";
			  }
			  br.innerHTML += "<div class='clear'></div>";
			} else br.innerHTML += "<p>BR data missing. Record likely internally sourced or is a Customer.</p>";

			// RAW
			var rawContainer = all[4];
			rawContainer.innerHTML = "<div style='white-space: pre;font-size: 13px;font-family: monospace !important;'>" + JSON.stringify(raw, null, 4) + "</div>";

		  });

		}
	  });
	}

  }
</script>

<!-- ADD/EDIT COMPANY -->
<script>
  const companyModal = {
	init: function(companyInfo, callback) {
	  companyModal.company = companyInfo || {};
	  companyModal.saveCallback = callback;
	  companyModal.showModal(companyModal.company);
	  companyModal.notificationUniquePartyID = new Map();

	},
	showModal: function(company) {

	  mo.fn.modal.show({
		ctaLabel: company ? "Save" : "Create",
		class: "ark-modal",
		title: company ? "Edit profile" : "Create new profile",
		content: '<div class="add_edit_company" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
		contentCallback: function() {
		  document.querySelector('.dxpModalFooter').classList.remove('hidden');

		  var data = company;

		  companyModal.conf = companyModal.config(data);
		  companyModal.conf.dom = document.querySelector(".dxpModalContent .add_edit_company");
		  companyModal.conf.dataset = JSON.parse(JSON.stringify(data));

		  nbsf.init(companyModal.conf, 0);

		  mo.fn.overlay.show({
			close: false,
			loading: true
		  })


		  function onCountryChange(onInit) {

			try
			{
			  var iso = document.querySelector(".dxpModalContent select[data-name='Country']").value;
			  var countryInfo = reference.countries.rawData.find(x => x.ISO2 == iso);

			  //states
			  var selectState = document.querySelector(".dxpModalContent select[data-name='State']");
			  var info = reference.states.data.find(x => x.ISO2 == iso);

			  if (info) {
				var states = JSON.parse(info.Districts);
				util.populateSelect(
				  selectState,
				  states.map(function(a) {
					return a.code;
				  }),
				  states.map(function(a) {
					return a.name;
				  }));
			  }

			  if (companyModal.company && companyModal.company.State)
				selectState.value = companyModal.company.State;


			  //languages
			  var selectLang = document.querySelector("select[data-name='Language']");
			  var options = reference.languages.data.map(x => x.option);
			  var values = reference.languages.data.map(x => x.value);

			  var value = "en_US";
			  if (countryInfo && countryInfo.PreferredLang) {
				value = countryInfo.PreferredLang;
			  }

			  util.populateSelect(selectLang, values, options);

			  if (onInit)
				if (companyModal.company && companyModal.company.Language)
				  value = companyModal.company.Language;
			  selectLang.value = value;

			}
			catch(e){
			  console.log("Error", e);
			}
		  };

		  document.querySelector("select[data-name='Country']").addEventListener("change", function() {
			onCountryChange();
		  });
		  onCountryChange(true);	  

		  function onCategoryChange() {

			var category = document.querySelector("select[data-name='Category']").value;
			var selectIntake = document.querySelector("select[data-name='IntakeForm']");
			var categoryInfo = reference.category.find(x => x.value == category);

			if (categoryInfo) {
			  var configIds = categoryInfo.configs;
			  var configs = [];

			  configIds.forEach(x => {
				var config = reference.configs.data.find(y => y.ConfigId == x);
				if (config)
				  configs.push(config);
			  });

			  util.populateSelect(
				selectIntake,
				configs.map(function(a) {
				  return a.ConfigId;
				}),
				configs.map(function(a) {
				  return a.ConfigName;
				}));


			}

			if (companyModal.company && companyModal.company.IntakeForm)
			  selectIntake.value = companyModal.company.IntakeForm;

		  };

		  document.querySelector("select[data-name='Category']").addEventListener("change", function() {
			onCategoryChange();
		  });

		  onCategoryChange();
		},
		ctaCallback: function() {

		  var res = nbsf.ev.global(companyModal.conf, true);
		  if (res.total.fail > 0) {
			mo.fn.modal.msg("Please provide all the required information", 3);
			return;
		  }

		  var company = companyModal.company || {};
		  var partyId = companyModal.conf.dataset.PartyId;

		  const saveData = function () {			
			nbsf.data.update(companyModal.conf, {});

			var data = companyModal.conf.dataset;

			Object.keys(data).forEach(x => {
			  if (data[x] == "Select one")
				data[x] = null;
			});

			company.Custom = JSON.stringify(data);
			company.PartyId = companyModal.conf.dataset.PartyId;

			Object.keys(data).forEach(x => {
			  company[x] = data[x];
			});

			var configInfo = reference.configs.data.find(x => x.ConfigId == companyModal.conf.dataset.IntakeForm);
			if (configInfo) {
			  company.ConfigFK = configInfo.EntryId;
			  company.ConfigName = configInfo.ConfigName;
			}

			if (company.EntryId) {
			  crud.update("3980", company.EntryId, company, function(e) {
				mo.fn.modal.msg();
				if (!e.EntryId)
				  mo.fn.modal.msg("Error occured: " + e, 3);
				else {
				  mo.fn.modal.hide();
				  if (companyModal.saveCallback)
					companyModal.saveCallback(e);

				  singleCompanyDetails.init(e.EntryId);
				  //singleCompanyDetails.addAuditLog("Profile updated", util.getDifference(companyModal.company || {}, e), util.Email(), null, e.EntryId);
				}
			  });
			} else {
			  crud.create("3984", { ...company,
								   Status: "Pending",
								   StatusReason: "Pending"
								  }, function(e) {
				mo.fn.modal.msg();
				if (!e.EntryId)
				  mo.fn.modal.msg("Error occured: " + e, 3);
				else {
				  mo.fn.modal.hide();
				  if (companyModal.saveCallback)
					companyModal.saveCallback(e);

				  singleCompanyDetails.init(e.EntryId);
				  singleCompanyDetails.addAuditLog("Profile created", util.getDifference({}, e, companyModal.config()), util.Email(), null, e.EntryId);
				}
			  });
			}
		  };

		  if (partyId && !companyModal.notificationUniquePartyID.get(partyId)) { 
			const filter = `pid=${partyId}&eid=${company.EntryId || 0}`;
			mo.fn.overlay.show({loading:true});
			crud.read("5239", filter, function (d) {
			  if (d.Total) {
				companyModal.notificationUniquePartyID.set(partyId, true);				
				mo.fn.modal.msg("The same Party ID is currently in use for another ARK profile. Are you sure you want to proceed with this update?", 2);
			  } else {
				saveData();
			  }
			});
		  } else {
			saveData();
		  }
		}
	  });
	},
	config: function(company) {
	  var config = {
		dom: document.querySelector('div[class="create_company"]'),
		pages: [{
		  nav: false,
		  structure: [
			{
			  header: "Company Details",
			  group: [
				[
				  {
					label: "Company Name:",
					data: "CompanyName",
					required: true,
					value: null,
					type: "text",
					validation: ["minLen|1", "maxLen|100"],
				  },
				  {
					label: "English Company Name:",
					data: "EnglishCompanyName",
					required: false,
					value: null,
					type: "text",
					validation: ["minLen|1", "maxLen|100"],
				  },
				  {
					label: "Alternate Trade Name:",
					data: "TradingCompanyName",
					required: false,
					value: null,
					type: "text",
					validation: ["minLen|1", "maxLen|100"],
				  },
				  {
					label: "Legal Form of Company:",
					data: "LegalFormOfCompany",
					required: false,
					type: "select",
					values: ['AB', 'AG', 'BV', 'BVBA', 'Co', 'Corp', 'Dd', 'Doo', 'EOOD', 'GDK', 'GmbH', 'HB', 'INC', 'Individual', 'KD', 'KDA', 'Kft', 'KK', 'LLC', 'LLP', 'Ltd', 'Ltda', 'NV', 'OOD', 'Other', 'Oy', 'Partnersh', 'Plc', 'Pty Ltd', 'Pvt Ltd', 'SA', 'SA de CV', 'SD', 'Sdn Bhd', 'SL', 'Sole Proprietor', 'SP.zo.o', 'SpA', 'SPRL', 'Srl'],
					options: ['AB', 'AG', 'BV', 'BVBA', 'Co', 'Corp', 'Dd', 'Doo', 'EOOD', 'GDK', 'GmbH', 'HB', 'INC', 'Individual', 'KD', 'KDA', 'Kft', 'KK', 'LLC', 'LLP', 'Ltd', 'Ltda', 'NV', 'OOD', 'Other', 'Oy', 'Partnersh', 'Plc', 'Pty Ltd', 'Pvt Ltd', 'SA', 'SA de CV', 'SD', 'Sdn Bhd', 'SL', 'Sole Proprietor', 'SP.zo.o', 'SpA', 'SPRL', 'Srl']
				  },
				  {
					label: "Years in Business",
					data: "NumberOfYearsInPrimaryBusiness",
					required: false,
					type: "text",
					validation: ["flt", "minLen|1", "maxLen|255"],
					typing: "flt"
				  },
				  {
					label: "Country Of Registration:",
					data: "CountryOfRegistration",
					type: "select",
					required: false,
					value: null,
					validation: ["inArray"],
					options: reference.countries.options(),
					values: reference.countries.values()
				  },
				  {
					label: "Tax ID / Business Registration ID",
					data: "TaxId",
					required: false,
					type: "text",
					validation: ["minLen|1", "maxLen|255"],
				  },
				  {
					label: "Website",
					data: "Website",
					required: false,
					type: "text",
					validation: ["minLen|1", "maxLen|255"],
				  },
				  {
					label: "Telephone",
					data: "CompanyTelephone",
					required: false,
					type: "text",
					validation: ["minLen|1", "maxLen|255"],
				  },
				  {
					label: 'Publicy Traded Company',
					data: "PublicyTradedCompany",
					required: false,
					type: "radio",
					values: ["Y", "N"],
					options: ["Yes", "No"],
				  },
				  {
					label: "Stock Exchange",
					data: "StockExchange",
					required: false,
					type: "text",
					validation: ["flt", "minLen|1", "maxLen|255"],
					typing: "flt"
				  },
				  {
					label: "Ticker Symbol",
					data: "TickerSymbol",
					required: false,
					type: "text",
					validation: ["minLen|1", "maxLen|255"],
				  },
				  {
					label: 'Is Active?',
					data: "IsActive",
					required: false,
					type: "radio",
					values: ["Y", "N"],
					options: ["Yes", "No"],
				  },
				]
			  ]
			},
			{
			  header: "Address",
			  group: [
				[{
				  label: "Address 1",
				  data: "Address1",
				  required: false,
				  type: "text",
				  validation: ["minLen|1", "maxLen|255"],
				  onChange: function() {}
				},
				 {
				   label: "Address 2",
				   data: "Address2",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 }
				],
				[{
				  label: "City",
				  data: "City",
				  required: false,
				  type: "text",
				  validation: ["minLen|1", "maxLen|255"],
				  onChange: function() {}
				},
				 {
				   label: "Country",
				   data: "Country",
				   required: true,
				   type: "select",
				   validation: ["inArray"],
				   options: reference.countries.options(),
				   values: reference.countries.values()
				 },
				 {
				   label: "State/Province",
				   data: "State",
				   required: false,
				   type: "select",
				   options: [""],
				   values: [""]
				 },
				 {
				   label: "PostCode",
				   data: "PostCode",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 },
				 {
				   label: "Language",
				   data: "Language",
				   type: "select",
				   required: false,
				   value: null,
				   validation: ["inArray"],
				   options: reference.languages.data.map(x => x.option),
				   values: reference.languages.data.map(x => x.value)
				 },
				]
			  ]
			},
			{
			  header: "Meta Information",
			  group: [
				[{
				  label: "Siebel ID",
				  data: "SiebelID",
				  required: false,
				  type: "text",
				  validation: ["minLen|1", "maxLen|255"],
				  onChange: function() {}
				},
				 {
				   label: "Party ID",
				   data: "PartyId",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				   onChange: function() {}
				 },
				 {
				   label: "Internal Owner",
				   data: "InternalOwner",
				   required: true,
				   type: "select",
				   validation: ["inArray"],
				   options: reference.users.data.map(x => x.Email),
				   values: reference.users.data.map(x => x.Email),
				 },
				 {
				   label: "Category",
				   data: "Category",
				   required: true,
				   type: "select",
				   validation: ["inArray"],
				   options: reference.category.map(x => x.value),
				   values: reference.category.map(x => x.value),
				 },
				 {
				   label: "Intake Type",
				   data: "IntakeForm",
				   required: false,
				   type: "select",
				   validation: ["inArray"],
				   options: [''],
				   values: [''],
				 },
				 {
				   label: "Region",
				   data: "Region",
				   required: true,
				   type: "select",
				   validation: ["inArray"],
				   options: ["EMEA", "APJ", "AMS"],
				   values: ["EMEA", "APJ", "AMS"],
				 },
				],


			  ]
			},
			{
			  header: "Main Point of Contact",
			  group: [
				[{
				  label: "Name",
				  data: "Name",
				  required: true,
				  type: "text",
				  validation: ["minLen|1", "maxLen|255"],
				  onChange: function() {}
				},
				 {
				   label: "Position",
				   data: "Position",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 },

				 {
				   label: "Email Address",
				   data: "EmailAddress",
				   required: true,
				   type: "text",
				   validation: ["isEmail", "minLen|1", "maxLen|255", "noBlanks"],
				 },
				 {
				   label: "Telephone",
				   data: "Telephone",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 },
				 {
				   label: "Alt. Telephone",
				   data: "AltTelephone",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 },
				 {
				   label: "Mobile",
				   data: "Mobile",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 },
				 {
				   label: "FAX",
				   data: "FAX",
				   required: false,
				   type: "text",
				   validation: ["minLen|1", "maxLen|255"],
				 }
				]

			  ]
			}
		  ],
		  callback: function() {},
		}],
	  };
	  if(access.user.UserRole.ADMIN) {
		config.pages[0].structure.push(
		  {
			header: "Settings",
			group: [
			  [{
				label: "Hide 95% checkbox",
				data: "HideDDQShareQuestion",
				required: false,
				type: "toggle",
				values: [0, 1]
			  },
			   {
				 label: "Hide Key personnel confirmation checkbox",
				 data: "HideDDQKeyPersonalConfirmation",
				 required: false,
				 type: "toggle",
				 values: [0, 1]
			   },
			  ]

			]
		  }
		);
	  }
	  return config;
	}
  }
</script>

<!-- BULK INVITATION -->
<script>
  const bulkInvitations = {
	batchId: '',
	fileName: '',
	node: function() {
	  return Array.from(document.querySelectorAll('#navigation .bulk-ops')).pop();
	},
	baseHolder: function() {
	  return Array.from(document.querySelectorAll('#navigation .bulk-ops .bulk-invs-menu')).pop();
	},
	contentHolder: function() {
	  return Array.from(document.querySelectorAll('#navigation .bulk-ops .bulk-invs-content')).pop();
	},
	holder: function() {
	  //var node = Array.from(document.querySelectorAll('#navigation .bulk-ops .bulk-invs-content #bulk-invs')).pop();
	  //return node.lastChild;
	  return Array.from(document.querySelectorAll('#navigation .bulk-ops .bulk-invs-content #bulk-invs')).pop();
	},
	holderDropdown: function() {
	  return Array.from(document.querySelectorAll('#navigation .bulk-ops .bulk-template-select')).pop();
	},
	reportBuilderHolder: function() {
	  return Array.from(document.querySelectorAll('#navigation .bulk-ops .scEditor')).pop();
	},
	init: function(holder) {
	  navigation.push(bulkInvitations.htmlBase());
	  recentlyViewed.add({
		Module: 'Batch operations',
		Id: null,
	  }, function() {});
	  //navigation.push(bulkInvitations.htmlContent());
	  var holder = bulkInvitations.baseHolder();
	  hpe.ui.tabs({
		dom: holder,
		tabs: [{
		  label: "Batch Invitations",
		  id: "invitations"
		},
			   {
				 label: "Batch Updates",
				 id: "updates"
			   },
			  ]
	  }, function(all) {
		bulkInvitations.initInvites();
		holder.querySelector('[tab-id="invitations"]').addEventListener('click', function() {
		  bulkInvitations.initInvites();
		});

		holder.querySelector('[tab-id="updates"]').addEventListener('click', function() {
		  bulkInvitations.initUpdates();
		});
	  });
	},
	htmlBase: function() {
	  var html =
		  "<section id='bulk-ops' class='bulk-ops'>" +
		  "<div class='bulk-invs-menu'></div>" +
		  "<div class='bulk-template-select'></div>" +
		  "<div class='scEditor'></div>" +
		  "<div class='bulk-invs-content'></div>" +
		  "</section>";
	  return html;
	},
	htmlInvites: function() {
	  var html = "<div id='bulk-invs'>" +
		  "<div class='options'></div>" +

		  "<div style='margin-bottom: 25px;'>" +
		  "<a class='k-button k-button-big invitation-reset'>Reset</a>" +
		  "<a class='k-button k-button-big invitation-sample'>Download template</a>" +
		  "<a class='k-button k-button-big invitation-report'>Download report</a>" +
		  "</div>" +

		  "<div class='bulk-invs-grid'></div>" +
		  "<div  style='display:none'><div class='bulk-invs-grid_export'></div></div>" +
		  "<div class='footer'>" +

		  "<div class='progress-bar'>" +
		  "<div class='back'>" +
		  "<div class='bar' style='width:0%'></div>" +
		  "<div class='value'>0% (0/0)</div>" +
		  "</div>" +
		  "</div>" +

		  "<div class='buttons'>" +
		  "<a class='k-button k-button-big invitation-upload'>Upload file</a>" +
		  "<a class='k-button k-button-big invitation-validate'>Validate data</a>" +
		  "<a class='k-button k-button-action invitation-update-profiles'>Update data</a>" +
		  "<a class='k-button k-button-action invitation-send'>Send invitations</a>" +
		  "<input type='file' id='upload' style='display:none' onclick='this.value=null;'>" +
		  "</div>" +

		  "</div>" +
		  "</div>";

	  return html;
	},
	htmlUpdates: function() {
	  var html = "<div id='bulk-invs'>" +
		  "<div class='options'></div>" +

		  "<div style='margin-bottom: 25px;'>" +
		  "<a class='k-button k-button-big invitation-reset'>Reset</a>" +
		  "<a class='k-button k-button-big invitation-sample'>Download template</a>" +
		  "<a class='k-button k-button-big invitation-report'>Download report</a>" +
		  "</div>" +

		  "<div class='bulk-invs-grid'></div>" +
		  "<div  style='display:none'><div class='bulk-invs-grid_export'></div></div>" +
		  "<div class='footer'>" +

		  "<div class='progress-bar'>" +
		  "<div class='back'>" +
		  "<div class='bar' style='width:0%'></div>" +
		  "<div class='value'>0% (0/0)</div>" +
		  "</div>" +
		  "</div>" +

		  "<div class='buttons'>" +
		  "<a class='k-button k-button-big invitation-upload'>Upload file</a>" +
		  "<a class='k-button k-button-big invitation-validate'>Validate data</a>" +
		  "<a class='k-button k-button-action invitation-update-profiles'>Update data</a>" +
		  "<a class='k-button k-button-action invitation-send'>Send invitations</a>" +
		  "<input type='file' id='upload' style='display:none' onclick='this.value=null;'>" +
		  "</div>" +

		  "</div>" +
		  "</div>";

	  return html;
	},
	initInvites: function() {
	  bulkInvitations.currTemplate = '';
	  bulkInvitations.holderDropdown().innerHTML = "";
	  bulkInvitations.reportBuilderHolder().innerHTML = "";
	  bulkInvitations.reportBuilder.scEditor.selectedFieldsArray = [];
	  var holder = bulkInvitations.contentHolder();
	  holder.innerHTML = bulkInvitations.htmlInvites();
	  bulkInvitations.ui.init();
	},
	initUpdates: function() {
	  const f = function() {
		mo.fn.overlay.show({
		  loading: true,
		  close: false
		});
		bulkInvitations.currTemplate = bulkInvitations.templates[0].name;
		var holder = bulkInvitations.contentHolder();
		holder.innerHTML = bulkInvitations.htmlUpdates();
		bulkInvitations.ui.dropDownInit();
		bulkInvitations.reportBuilder.ui();
		bulkInvitations.ui.init(true);
		bulkInvitations.getReportBuilderReportsColumns(bulkInvitations.templates[0].name, function() {
		  mo.fn.overlay.hide();
		  bulkInvitations.reportBuilder.switchType(bulkInvitations.templates[0].name, bulkInvitations.reportBuilderHolder());
		});
	  }
	  if (!bulkInvitations.mappingData.length) {
		bulkInvitations.getColumnMapping(f);
	  } else {
		f();
	  }
	},
	data: [],
	ui: {
	  init: function(fromTemplate = false) {
		var holder = bulkInvitations.holder();

		bulkInvitations.ui.initHiddenGrid(fromTemplate);
		bulkInvitations.ui.initGrid(fromTemplate);
		//bulkInvitations.ui.initOptions();
		bulkInvitations.ui.reset();

		holder.querySelector(".invitation-sample").addEventListener("click", function() {
		  $(bulkInvitations.holder().querySelector(".bulk-invs-grid_export")).data("kendoGrid").saveAsExcel();
		});

		holder.querySelector(".invitation-report").addEventListener("click", function() {
		  $(bulkInvitations.holder().querySelector(".bulk-invs-grid")).data("kendoGrid").saveAsExcel();
		  /*bulkInvitations.exportReport("ARK_Invitations_ToExpire", 
                                             1275, 
                                             JSON.stringify(grid.columns.map(({field, title}) => ({field, title})).filter(x => x.field)),
                                             JSON.stringify(grid.dataSource.sort()),
                                             JSON.stringify(grid.dataSource.filter()),
                                             ("ExpirationReport_" + util.getDate((new Date()).toISOString(), true))

                                            );*/
		});

		holder.querySelector(".invitation-upload").addEventListener("click", function() {
		  $(bulkInvitations.holder().querySelector("#upload")).click();
		});

		holder.querySelector(".invitation-reset").addEventListener("click", function(ev) {
		  bulkInvitations.ui.reset();
		  bulkInvitations.reportBuilder.scEditor.selectedFieldsArray = [];
		  if (bulkInvitations.currTemplate) {
			bulkInvitations.initUpdates();
		  } else {
			bulkInvitations.initInvites()
		  }
		  //bulkInvitations.reportBuilder.ui();
		  ev.preventDefault();
		});


		holder.querySelector('#upload').addEventListener('change', function(e) {
		  var files = e.target.files;
		  if (files.length > 0) {
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			})

			bulkInvitations.parseExcel(files[0], function(excelData) {
			  if (typeof excelData == "string") {
				mo.fn.modal.show({
				  ctaLabel: "OK",
				  class: "ark-modal",
				  title: "Error",
				  content: excelData
				});
				mo.fn.overlay.hide();
				return;
			  }

			  var grid = $(bulkInvitations.holder().querySelector(".bulk-invs-grid")).data("kendoGrid");
			  var columns = grid.columns;

			  excelData.forEach(x => {
				columns.forEach(column => {
				  if (x[column.title]) {
					x[column.field] = x[column.title];
					if (column.field != column.title)
					  delete x[column.title];
				  } else
					x[column.field] = "";
				});

			  });

			  bulkInvitations.ui.reset();

			  bulkInvitations.data = excelData;
			  grid.dataSource.data(excelData);
			  mo.fn.overlay.hide();

			});
		  }
		}, false);


		holder.querySelector(".invitation-validate").addEventListener("click", function() {
		  var data = [...bulkInvitations.data];
		  data.forEach(x => {
			x.Status = "";
			x.Comment = "";
		  });
		  bulkInvitations.processData(
			data,
			false,
			true, //bulkInvitations.holder().querySelector("[name=CreateWhenNotFound]").value == "Y",
			true);
		});
		if (fromTemplate) {
		  holder.querySelector(".invitation-send").style.visibility = 'hidden';
		} else {
		  holder.querySelector(".invitation-send").style.visibility = 'visible';
		  holder.querySelector(".invitation-send").addEventListener("click", function() {
			mo.fn.modal.show({
			  ctaLabel: "Yes",
			  closeLabel: "No",
			  class: "ark-modal",
			  title: "Send invitations",
			  content: "You are about to send <b>" + bulkInvitations.data.length + "</b> invitations. Continue?",
			  ctaCallback: function() {
				mo.fn.modal.hide()
				var data = [...bulkInvitations.data];
				data.forEach(x => {
				  x.Status = "";
				  x.Comment = "";
				});
				bulkInvitations.processData(
				  data,
				  true,
				  true //bulkInvitations.holder().querySelector("[name=CreateWhenNotFound]").value == "Y"
				);
			  }
			});

		  });
		}

		holder.querySelector(".invitation-update-profiles").addEventListener("click", function() {
		  mo.fn.modal.show({
			ctaLabel: "Yes",
			closeLabel: "No",
			class: "ark-modal",
			title: "Send invitations",
			content: "You are about to update <b>" + bulkInvitations.data.length + "</b> rows. Continue?",
			ctaCallback: function() {
			  mo.fn.modal.hide();
			  var data = [...bulkInvitations.data];
			  data.forEach(x => {
				x.Status = "";
				x.Comment = "";
			  });
			  bulkInvitations.processData(
				data,
				false,
				true //bulkInvitations.holder().querySelector("[name=CreateWhenNotFound]").value == "Y"
			  );
			}
		  });


		});

	  },
	  dropDownInit: function() {
		var node = bulkInvitations.holderDropdown();
		node.innerHTML = "<div class='template-selector' style='margin-bottom:20px;'></div>";
		var conf = {
		  dom: node,
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Batch template",
				  data: "batchTemplateSelector",
				  type: "select",
				  value: bulkInvitations.templates[0].name,
				  values: bulkInvitations.templates.map(el => el.name),
				  options: bulkInvitations.templates.map(el => el.name)
				}]
			  ]
			}, ],
			callback: function() {
			  node.querySelector('[data-name="batchTemplateSelector"]').addEventListener('change', function(ev) {
				bulkInvitations.changeTemplate(ev.target.value);
			  });
			},
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },
	  reset: function() {
		var holder = bulkInvitations.holder();

		$(holder.querySelector(".bulk-invs-grid")).data("kendoGrid").dataSource.data([]);

		holder.querySelector(".invitation-send").style.display = "none";
		holder.querySelector(".invitation-validate").style.display = "none";
		holder.querySelector(".invitation-report").style.display = "none";
		holder.querySelector(".invitation-update-profiles").style.display = "none";
		holder.querySelector(".buttons").style.marginTop = "0px";

		holder.querySelector(".progress-bar .bar").style.width = "0%";
		holder.querySelector(".progress-bar .value").innerHTML = "0%";
		holder.querySelector(".progress-bar").style.display = "none";
	  },
	  /*initOptions: function() {
                  var conf = {
                    dom: bulkInvitations.holder().querySelector('div[class="options"]'),
                    pages: [
                      {
                        nav: false,
                        structure: [
                          {
                            group: [
                              [{
                                label: "Create a company profile if not found",
                                data: "CreateWhenNotFound",
                                required: false,
                                type: "toggle",
                                values: ["N","Y"],
                                options: ["No","Yes"]
                              }]
                            ]
                          }
                        ]
                      }
                    ]
                  };

                  nbsf.init(conf, 0);

                  bulkInvitations.holder().querySelector('.options .toggle').style.maxWidth = "250px";
                  bulkInvitations.holder().querySelector('.options .toggle .name').style.fontSize = "18px";

                },*/
	  initGrid: function(fromTemplate = false) {
		var holder = bulkInvitations.holder();

		var columns = fromTemplate ? bulkInvitations.ui.getColumns() : bulkInvitations.ui.columns();
		columns.splice(0, 0, {
		  field: "Comment",
		  title: "Comment",
		  hidden: false,
		  width: "250px",
		});
		columns.splice(0, 0, {
		  field: "Status",
		  title: " ",
		  hidden: false,
		  width: "50px",
		  template: function(d) {
			if (d.Status == 1)
			  return '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><polyline fill="none" stroke="green" stroke-width="2" points="2 14 9 20 22 4"></polyline></svg></a>';
			else if (d.Status == -1)
			  return '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="red" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path></svg></a>';

			return "";
		  }
		});
		var node = holder.querySelector(".bulk-invs-grid");
		$(node).kendoGrid({
		  height: 1500,
		  noRecords: {
			template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
		  },
		  excel: {
			fileName: "Report.xlsx",
			filterable: true,
			allPages: true
		  },
		  dataSource: [],
		  columns: columns,
		  pageable: {
			buttonCount: 4,
			pageSize: 100,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: false
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  resizable: true,
		  dataBound: function(e) {
			if (e.sender.dataSource.total() > 0) {
			  holder.querySelector(".invitation-update-profiles").style.display = "inline-flex";
			  holder.querySelector(".invitation-send").style.display = "inline-flex";
			  holder.querySelector(".invitation-validate").style.display = "inline-flex";
			  holder.querySelector(".buttons").style.marginTop = "-35px";
			}

		  },
		});

	  },
	  initHiddenGrid: function(fromTemplate = false) {
		var holder = bulkInvitations.holder();

		var node = holder.querySelector(".bulk-invs-grid_export");
		$(node).kendoGrid({
		  height: 1,
		  dataSource: [],
		  columns: fromTemplate ? bulkInvitations.ui.getColumns() : bulkInvitations.ui.columns(),
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: false
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: false,
		});
	  },
	  columns: function() {

		var columns = [
		  //KEY FIELDS
		  {
			field: "ProfileId",
			title: "Profile #",
			hidden: false,
			width: "150px",
		  },
		  /* {
                          field: "LegacyId",
                          title: "Securimate #",
                          hidden: false,
                          width: "150px",
                          headerAttributes: {
                            style: "white-space: normal"
                          },
                        },*/
		  //SEARCH FIELDS
		  {
			field: "SiebelID",
			title: "Profile. Siebel ID",
			hidden: false,
			width: "250px",
		  },
		  {
			field: "PartyId",
			title: "Profile. Party ID",
			hidden: false,
			width: "200px",
		  },
		  {
			field: "CompanyName",
			title: "Profile. Company Name",
			hidden: false,
			width: "250px",
		  },
		  {
			field: "IntakeForm",
			title: "Profile. Intake Form",
			hidden: false,
			width: "200px"
		  },
		  //CREATE NEW PROFILE FIELDS (MANDATORY)
		  {
			field: "InternalOwner",
			title: "Profile. Internal Owner",
			hidden: false,
			width: "200px",
		  },
		  {
			field: "Region",
			title: "Profile. Region",
			hidden: false,
			width: "180px"
		  },
		  {
			field: "Country",
			title: "Profile. Country",
			hidden: false,
			width: "200px"
		  },
		  {
			field: "State",
			title: "Profile. State",
			hidden: false,
			width: "200px"
		  },
		  {
			field: "EmailAddress",
			title: "Profile. Contact Email",
			hidden: false,
			width: "200px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  {
			field: "Name",
			title: "Profile. Contact Name",
			hidden: false,
			width: "180px"
		  },
		  {
			field: "Position",
			title: "Profile. Contact Position",
			hidden: false,
			width: "200px"
		  },
		  /*{
                          field: "Category",
                          title: "Category",
                          hidden: false,
                          width: "200px"
                        },  */
		  {
			field: "Address1",
			title: "Profile. Address 1",
			hidden: false,
			width: "200px",
		  },
		  {
			field: "TradingCompanyName",
			title: "Profile. Trading Company Name",
			hidden: false,
			width: "200px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  {
			field: "EnglishCompanyName",
			title: "Profile. English Company Name",
			hidden: false,
			width: "200px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  {
			field: "City",
			title: "Profile. City",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "TaxId",
			title: "Profile. Tax Id / Registration Number",
			hidden: false,
			width: "250px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  // OTHER FIELDS
		  {
			field: "PostCode",
			title: "Profile. Postcode",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "CompanyTelephone",
			title: "Profile. Phone number",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "Category",
			title: "Profile. Partner Category",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "Language",
			title: "Profile. Preferred Language",
			hidden: false,
			width: "180px",
		  },
		  /*{
                      field: "RelationshipStatus",
                      title: "Profile. Relationship Status",
                      hidden: false,
                      width: "180px",
                    },*/
		  // CASE FIELDS
		  {
			field: "CaseId",
			title: "Case #",
			hidden: false,
			width: "150px",
		  },
		  {
			field: "CaseLanguage",
			title: "Case. Language",
			hidden: false,
			width: "120px",
		  }
		  /*,
                                    {
                                      field: "CaseCPI",
                                      title: "Case. CPI",
                                      hidden: false,
                                      width: "180px",
                                    },*/
		];

		columns.forEach(column => {
		  column.template = function(d, field = column.field) {
			return d[field] || "-";
		  }
		});

		return columns;
	  },
	  getColumns: function() {
		var columns = [];
		switch (bulkInvitations.currTemplate) {
		  case 'Profiles':
			columns.push({
			  field: "ProfileId",
			  title: "Profile #",
			  width: "150px",
			});
			break;
		  case 'Cases':
			columns.push({
			  field: 'CaseId',
			  title: 'Case #',
			  width: "150px",
			});
			break;
		  case 'Cases and Profiles':
			columns.push({
			  field: 'CaseId',
			  title: 'Case #',
			  width: "150px",
			}, {
			  field: "ProfileId",
			  title: "Profile #",
			  width: "150px",
			});
			break;
		}

		(bulkInvitations.reportBuilder.scEditor.selectedFieldsArray || []).map(el => {
		  columns.push({ ...el,
						'width': "150px",
						'field': el.field.replace('table1363_EntryId', 'ProfileId')
						.replace('table1363_Status', 'ProfileStatus')
						.replace('ProfileStatusReason', 'StatusReason')
						.replace('table1363_', '')
						.replace('table1374_', 'ProfileCF')
						.replace('table1275_EntryId', 'CaseId')
						.replace('table1275_', 'Case')
						.replace('table1375_', 'CaseCF')
					   });
		});
		columns.forEach(column => {
		  column.template = function(d, field = column.field) {
			return d[field] || "-";
		  }
		});
		//debugger;
		return columns;
	  },
	  updateProgress: function(cur, total) {
		var holder = bulkInvitations.holder();

		holder.querySelector(".progress-bar").style.display = "block";

		var bar = holder.querySelector(".bar");
		var value = holder.querySelector(".value");

		var percent = parseFloat(cur / total * 100).toFixed(0);

		value.innerHTML = percent + "% (" + cur + "/" + total + ")";
		bar.style.width = percent + "%";
	  }

	},
	templates: [
	  {
		name: "Profiles",
		columns: [
		  //KEY FIELDS
		  {
			field: "ProfileId",
			title: "Profile #",
			hidden: false,
			width: "150px",
		  },
		  /* {
                          field: "LegacyId",
                          title: "Securimate #",
                          hidden: false,
                          width: "150px",
                          headerAttributes: {
                            style: "white-space: normal"
                          },
                        },*/
		  //SEARCH FIELDS
		  {
			field: "SiebelID",
			title: "Profile. Siebel ID",
			hidden: false,
			width: "250px",
		  },
		  {
			field: "PartyId",
			title: "Profile. Party ID",
			hidden: false,
			width: "200px",
		  },
		  {
			field: "CompanyName",
			title: "Profile. Company Name",
			hidden: false,
			width: "250px",
		  },
		  {
			field: "IntakeForm",
			title: "Profile. Intake Form",
			hidden: false,
			width: "200px"
		  },
		  //CREATE NEW PROFILE FIELDS (MANDATORY)
		  {
			field: "InternalOwner",
			title: "Profile. Internal Owner",
			hidden: false,
			width: "200px",
		  },
		  {
			field: "Region",
			title: "Profile. Region",
			hidden: false,
			width: "180px"
		  },
		  {
			field: "Country",
			title: "Profile. Country",
			hidden: false,
			width: "200px"
		  },
		  {
			field: "State",
			title: "Profile. State",
			hidden: false,
			width: "200px"
		  },
		  {
			field: "EmailAddress",
			title: "Profile. Contact Email",
			hidden: false,
			width: "200px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  {
			field: "Name",
			title: "Profile. Contact Name",
			hidden: false,
			width: "180px"
		  },
		  {
			field: "Position",
			title: "Profile. Contact Position",
			hidden: false,
			width: "200px"
		  },
		  /*{
                          field: "Category",
                          title: "Category",
                          hidden: false,
                          width: "200px"
                        },  */
		  {
			field: "Address1",
			title: "Profile. Address 1",
			hidden: false,
			width: "200px",
		  },
		  {
			field: "TradingCompanyName",
			title: "Profile. Trading Company Name",
			hidden: false,
			width: "200px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  {
			field: "EnglishCompanyName",
			title: "Profile. English Company Name",
			hidden: false,
			width: "200px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },

		  {
			field: "City",
			title: "Profile. City",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "TaxId",
			title: "Profile. Tax Id / Registration Number",
			hidden: false,
			width: "250px",
			headerAttributes: {
			  style: "white-space: normal"
			},
		  },
		  // OTHER FIELDS
		  {
			field: "PostCode",
			title: "Profile. Postcode",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "CompanyTelephone",
			title: "Profile. Phone number",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "Category",
			title: "Profile. Partner Category",
			hidden: false,
			width: "180px",
		  },
		  {
			field: "Language",
			title: "Profile. Preferred Language",
			hidden: false,
			width: "180px",
		  },
		  /*{
                      field: "RelationshipStatus",
                      title: "Profile. Relationship Status",
                      hidden: false,
                      width: "180px",
                    },*/
		  // CASE FIELDS
		  {
			field: "CaseId",
			title: "Case #",
			hidden: false,
			width: "150px",
		  },
		  {
			field: "CaseLanguage",
			title: "Case. Language",
			hidden: false,
			width: "120px",
		  }
		  /*,
                                    {
                                      field: "CaseCPI",
                                      title: "Case. CPI",
                                      hidden: false,
                                      width: "180px",
                                    },*/
		]
	  },
	  {
		name: "Cases",
		columns: [{
		  field: "CaseId",
		  title: "Case #",
		  hidden: false,
		  width: "150px",
		},
				  {
					field: "CaseCPI",
					title: "Case. CPI",
					hidden: false,
					width: "180px",
				  },
				 ]
	  },
	  {
		name: "Cases and Profiles",
		columns: []
	  },
	],
	getReportBuilderReportsColumns: function(type, cb) {
	  switch (type) {
		case 'Profiles':
		  if (Object.keys(bulkInvitations.reportBuilder.profilesData).length === 0)
			bulkInvitations.reportBuilder.reportProfiles(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'Cases':
		  if (Object.keys(bulkInvitations.reportBuilder.casesData).length === 0)
			bulkInvitations.reportBuilder.reportCases(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'Cases and Profiles':
		  if (Object.keys(bulkInvitations.reportBuilder.casesData).length === 0)
			bulkInvitations.reportBuilder.reportCases(function() {
			  if (Object.keys(bulkInvitations.reportBuilder.profilesData).length === 0)
				bulkInvitations.reportBuilder.reportProfiles(function() {
				  cb();
				});
			  else
				cb();
			});
		  else
			cb();
		  return;
	  }
	},
	reportBuilder: {
	  selectedFields: [],
	  casesSorted: ["Case. Case #", "Case. Created", "Case. Name", "Case. Region", "Case. Country Code", "Case. Intake Form", "Case. Submitted Date", "Case. Pass/Fail", "Case. Stage", "Case. Status", "Case. Close Reason", "Case. Sent To (Name)", "Case. Sent To (Email)", "Case. First Visit Date", "Case. Last Visit Date", "Case. Created By", "Case. Company #", "Case. Securimate #", "Case. Completed Date", "Case. Requestor", "Case. Related Cases", "Case Assigned Date", "Case Accepted", "Case Due Date", "Case Closed", "Case Invoice", "Case Description", "Case Department", "Case (CF). App ID", "Case (CF). BU EDD Decision", "Case (CF). Business Caution Factors", "Case (CF). Category Status", "Case (CF). CFI Analyst", "Case (CF). Contract Inactivation Date", "Case (CF). Contract Inactivation Reason", "Case (CF). Contract Requestor Email", "Case (CF). Contract Termination Date", "Case (CF). Contract Termination Reason", "Case (CF). CPI", "Case (CF). CPI Do Not Update", "Case (CF). Date Assigned To Agility", "Case (CF). Date Batch Created", "Case (CF). Date EDD Decision Released", "Case (CF). Date Scorecard Received", "Case (CF). DDI Agility Comments Additional Request", "Case (CF). DDI Agility Reason For Override", "Case (CF). DDI Agility Release Date", "Case (CF). DDI Agility Result Override", "Case (CF). DDI Agility Special Handling Instructions", "Case (CF). DDI Analyst", "Case (CF). DDI Batch Number", "Case (CF). DDI Completed Date", "Case (CF). DDI Date Assigned To Agility", "Case (CF). DDI Final Result", "Case (CF). DDI No Info Responses", "Case (CF). DDI No Responses", "Case (CF). DDI Reason For Override", "Case (CF). DDI Region Lead Active Review", "Case (CF). DDI Region Lead Review Result Date", "Case (CF). DDI Result Override", "Case (CF). DDI Result Sent To Contracts Team", "Case (CF). DDI Scoring Analyst", "Case (CF). DDI Scoring Completed Date", "Case (CF). DDI SQ Comments", "Case (CF). DDI SQ Result", "Case (CF). DDI Start Date", "Case (CF). DDI Update Sent To Contracts Team", "Case (CF). DDI Yes Responses", "Case (CF). DDQ Reminder Date", "Case (CF). Reactivation Reminder Date", "Case (CF). Update Reactivation Result to Contracts Team", "Case (CF). DDQ Reactivation Result", "Case (CF). BU EDD Decision Date", "Case (CF). DDQ Request Receive Date", "Case (CF). DDQ Result", "Case (CF). DDQ Score", "Case (CF). DDQ Score Do Not Update", "Case (CF). EDD Case Numbers", "Case (CF). EDD Decision Released", "Case (CF). EDD Result Receive Date", "Case (CF). EDD Scorecard Results", "Case (CF). EDD Scorecard Results Revised", "Case (CF). EDD Trigger Date", "Case (CF). Extended DDQ Days", "Case (CF). Extension Reason", "Case (CF). Final EDD Result", "Case (CF). GT Question Do Not Update", "Case (CF). Holidays", "Case (CF). IDD Agility Business Caution Instructions", "Case (CF). IDD Agility EDD Reasons", "Case (CF). IDD Agility Recommendation", "Case (CF). IDD Agility Release Date", "Case (CF). IDD Agility Special Handling Instructions", "Case (CF). IDD Agility Supplemental Questionnaire Instructions", "Case (CF). IDD Analyst", "Case (CF). IDD Completed Date", "Case (CF). IDD Date Assigned To Agility", "Case (CF). IDD Reason Override", "Case (CF). IDD Result Override", "Case (CF). IDD Result Sent To Contracts Team", "Case (CF). IDD Start Date", "Case (CF). IDD Update Sent To Contract Team", "Case (CF). IFQ Do Not Update", "Case (CF). Marketing Vendor Low Risk Q5 Q6", "Case (CF). No Info Responses", "Case (CF). No Responses", "Case (CF). On Boarding Program", "Case (CF). On Going Special Handling", "Case (CF). OSI Case Number", "Case (CF). OSI Final Result", "Case (CF). OSI Reason For Override", "Case (CF). OSI Result", "Case (CF). OSI Result Override", "Case (CF). OSI Result Receive Date", "Case (CF). OSI SQ Comments", "Case (CF). OSI SQ Result", "Case (CF). OSI Trigger Date", "Case (CF). OSI Batch Number", "Case (CF). Other Instructions", "Case (CF). Other Notable Factors", "Case (CF). Partner Location ID", "Case (CF). Party ID", "Case (CF). Post OSI Result Override", "Case (CF). Post Osi Supplementary Research", "Case (CF). Pre Screened", "Case (CF). Raw FK", "Case (CF). Red Flag Questions", "Case (CF). Red Flag Questions Do Not Update", "Case (CF). Red Line DDQ", "Case (CF). Remarks", "Case (CF). OSI Date Assigned to Agility", "Case (CF). OSI Agility Release Date", "Case (CF). Reactivation Request Trigger Date", "Case (CF). DDQ Reactivation Trigger Date", "Case (CF). Osi Agility Special Handling Instruction", "Case (CF). Requesting Business Unit", "Case (CF). SH BC Final Result", "Case (CF). SH BC Result Receive Date", "Case (CF). Siebel PRMID Or Supplier Vendor ID", "Case (CF). Simplified Code 06 Case", "Case (CF). Special Handling Instructions", "Case (CF). Sub Region", "Case (CF). Update DDQ Result To Contracts Team",
					"Case (CF). Update EDD Result To Contracts Team", "Case (CF). Update OSI Result To Contracts Team", "Case (CF). Yes Responses", "Case (CF). Special Consideration"
				   ],
	  profilesSorted: ["Profile. Profile #", "Profile. Securimate #", "Profile. Company Name", "Profile. English Company Name",  "Profile. Siebel ID", "Profile. Party Id", "Profile. Approval Status", "Profile. Approval Status Reason", "Profile. Approval Status Comment", "Profile. Is Active", "Profile. Region", "Profile. Country", "Profile. Created", "Profile. Category", "Profile. Intake Form", "Profile. Tax Id", "Profile. Address 1", "Profile. Address 2", "Profile. State", "Profile. City", "Profile. Telephone", "Profile. Company Telephone", "Profile. Alt Telephone", "Profile. Post Code", "Profile. FAX", "Profile. POC Name", "Profile. POC Email Address", "Profile. POC Position", "Profile. Created By", "Profile. Modified", "Profile. Modified By", "Profile. Internal Owner", "Profile. Cases", "Profile. Cases Securimate", "Risk Rank", "Risk Score", "Profile. Language", "Profile. Legal Form Of Company", "Profile. Mobile", "Profile. Number Of Years In Primary Business", "Profile. Profile Global Status", "Profile. Publicy Traded Company", "Profile. Registration Number", "Profile. Stock Exchange", "Profile. Ticker Symbol", "Profile. Trading Company Name", "Profile. Website", "Profile. Country Of Registration", "Profile (CF). Branch Or Subsidiary Exemption", "Profile (CF). Branch Subsidiary", "Profile (CF). Category Status", "Profile (CF). GDC Agility EDD Reasons", "Profile (CF). GDC Agility Recommendation", "Profile (CF). GDC Agility Release Date", "Profile (CF). GDC Agility Special Handling Instructions", "Profile (CF). GDC Agility Supplemental Questionnaire Instructions", "Profile (CF). GDC Date Assigned To Agility", "Profile (CF). GDC Final Risk Mitigation Outcome", "Profile (CF). GDC Override Reason", "Profile (CF). GDC Red Flags", "Profile (CF). GDC Research Analyst", "Profile (CF). GDC Research Completed Date", "Profile (CF). GDC Research Start Date", "Profile (CF). GDC Result Override", "Profile (CF). GDC Risk Mitigation Owner", "Profile (CF). Global Exemption", "Profile (CF). Headquarter Location Or Parent Company", "Profile (CF). Highest Risk Country CPI", "Profile (CF). Highest Risk Country Name", "Profile (CF). Internal HPE Contact Email Address", "Profile (CF). Internal HPE Contact Name", "Profile (CF). Parent Company Name", "Profile (CF). Preferred Language Code", "Profile (CF). Partner Location Id", "Profile (CF). Party Id", "Profile (CF). Related OEM 3P Profile Number", "Profile (CF). Related Reseller 3P Profile Number", "Profile (CF). Related Supplier 3P Profile Number", "Profile (CF). Special Partner Type", "Profile (CF). Special Partner Type Siebel Id", "Profile (CF). Tax Id"],
	  profilesData: {},
	  casesData: {},
	  reportProfiles: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Batch_Profiles/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1,
		  serverFiltering: true,
		  serverSorting: true,
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent' && el !== 'uid') {
			  if (bulkInvitations.mappingData[el] && bulkInvitations.mappingData[el].Title) {
				bulkInvitations.reportBuilder.profilesData[el] = bulkInvitations.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});
	  },
	  reportCases: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Batch_Cases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1,
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent' && el !== 'uid') {
			  if (bulkInvitations.mappingData[el] && bulkInvitations.mappingData[el].Title) {
				bulkInvitations.reportBuilder.casesData[el] = bulkInvitations.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});
	  },
	  ui: function() {
		var editor = bulkInvitations.reportBuilderHolder();
		bulkInvitations.reportBuilder.scEditor.init(editor);
	  },
	  refresh: function(templateId) {
		bulkInvitations.reportBuilder.ui();
	  },
	  getColumnInfo: function(columnName) {
		var columnInfo = bulkInvitations.mappingData[columnName];
		return columnInfo;
	  },
	  sortFields: function(arr) {
		var arry = Object.entries(arr);
		var arr_first = [];
		var arr_sec = [];
		var arr_third = [];
		switch (bulkInvitations.currTemplate) {
		  case "Profiles":
			bulkInvitations.reportBuilder.profilesSorted.forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  case "Cases":
			bulkInvitations.reportBuilder.casesSorted.forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  case "Cases and Profiles":
			[...bulkInvitations.reportBuilder.casesSorted, ...bulkInvitations.reportBuilder.profilesSorted].forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		}
		return [...arr_first, ...arr_sec, ...arr_third];

	  },
	  switchType: function(data, node) {
		switch (data) {
		  case 'Profiles':
			bulkInvitations.reportBuilder.initAvailableFields(node, bulkInvitations.reportBuilder.profilesData);
			break;
		  case 'Cases':
			bulkInvitations.reportBuilder.initAvailableFields(node, bulkInvitations.reportBuilder.casesData);
			break;
		  case 'Cases and Profiles':
			bulkInvitations.reportBuilder.initAvailableFields(node, { ...bulkInvitations.reportBuilder.casesData,
																	 ...bulkInvitations.reportBuilder.profilesData
																	});
			break;
		}
	  },
	  initAvailableFields: function(node, data) {
		bulkInvitations.reportBuilder.scEditor.init(node, data, function(dt) {
		  bulkInvitations.reportBuilder.selectedFields = Object.assign({}, dt);
		});
	  },
	  scEditor: {
		availableFields: {},
		selectedFields: {},
		activeAvailable: {},
		activeSelected: {},
		leftPanel: '',
		rightPanel: '',
		reset: function() {
		  bulkInvitations.reportBuilder.scEditor.availableFields = {};
		  bulkInvitations.reportBuilder.scEditor.selectedFields = {};
		  bulkInvitations.reportBuilder.scEditor.activeAvailable = {};
		  bulkInvitations.reportBuilder.scEditor.activeSelected = {};
		},
		init: function(node, data, callback) {
		  bulkInvitations.reportBuilder.scEditor.reset();

		  if (data) bulkInvitations.reportBuilder.scEditor.availableFields = Object.assign({}, data); //Object.keys(data).map(el => el.split('_')[1]);
		  node.innerHTML = bulkInvitations.reportBuilder.scEditor.template();

		  bulkInvitations.reportBuilder.scEditor.leftPanel = node.querySelector('.scEditor__left__panel select');
		  bulkInvitations.reportBuilder.scEditor.rightPanel = node.querySelector('.scEditor__right__panel select');

		  node.querySelector('.scEditor__leftArr').addEventListener('click', function(ev) {
			bulkInvitations.reportBuilder.scEditor.arrowLeft(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__rightArr').addEventListener('click', function() {
			bulkInvitations.reportBuilder.scEditor.arrowRight(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__upArr').addEventListener('click', function(ev) {
			bulkInvitations.reportBuilder.scEditor.arrowUp(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__downArr').addEventListener('click', function() {
			bulkInvitations.reportBuilder.scEditor.arrowDown(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.available_fields-filter').addEventListener('input', function(e) {
			bulkInvitations.reportBuilder.scEditor.onFilter(e.target.value);
		  });

		  bulkInvitations.reportBuilder.scEditor.addOptions();

		},
		template: function(node) {
		  return '<section class="scEditor__wrapper">' +
			'<div class="scEditor__left">' +
			'<h4>Available fields</h4>' +
			'<div class="header"><input placeholder="Quick filter" class="available_fields-filter"> </div>' +
			'<div class="scEditor__left__panel">' +
			'<select multiple="true"></select>' +
			'</div>' +
			'</div>' +
			'<div class="scEditor__arrows">' +
			'<svg class="scEditor__rightArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret next" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="6 2 18 12 6 22"></polygon></svg>' +
			'<svg class="scEditor__leftArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret previous" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="6 2 18 12 6 22" transform="matrix(-1 0 0 1 24 0)"></polygon></svg>' +
			'</div>' +
			'<div class="scEditor__right">' +
			'<h4>Fields in report</h4>' +
			'<div class="header"></div>' +
			'<div class="scEditor__right__panel">' +
			'<select multiple="true"></select>' +
			'</div>' +
			'</div>' +
			'<div class="scEditor__arrows" style="margin-left: 10px;">' +
			'<svg class="scEditor__upArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret up" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 4 12 16 2 4" transform="matrix(1 0 0 -1 0 20)"></polygon></svg>' +
			'<svg class="scEditor__downArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret down" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 8 12 20 2 8"></polygon></svg>' +
			'</div>' +
			'</section>';
		},
		arrowLeft: function(node, callback) {

		  var toDelete = [];
		  var length = bulkInvitations.reportBuilder.scEditor.rightPanel.selectedOptions.length;
		  for (var i = 0; i < length; i++) {
			var x = bulkInvitations.reportBuilder.scEditor.rightPanel.selectedOptions[i];
			var opt = document.createElement('option');
			opt.value = x.value;
			opt.innerHTML = x.innerHTML;
			bulkInvitations.reportBuilder.scEditor.leftPanel.appendChild(opt);

			toDelete.push(x);
		  }
		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < bulkInvitations.reportBuilder.scEditor.rightPanel.options.length; j++) {
			  if (!bulkInvitations.reportBuilder.scEditor.rightPanel.options[j])
				debugger;
			  if (bulkInvitations.reportBuilder.scEditor.rightPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			bulkInvitations.reportBuilder.scEditor.rightPanel.remove(idx);
		  });

		  bulkInvitations.reportBuilder.scEditor.updateSelectedArray();

		  if (callback && typeof callback == 'function') callback(bulkInvitations.reportBuilder.scEditor.selectedFields);
		},
		arrowRight: function(node, callback) {

		  var toDelete = [];
		  var lenght = bulkInvitations.reportBuilder.scEditor.leftPanel.selectedOptions.length;
		  for (var i = 0; i < lenght; i++) {
			var x = bulkInvitations.reportBuilder.scEditor.leftPanel.selectedOptions[i];

			var opt = document.createElement('option');
			opt.value = x.value;
			opt.innerHTML = x.innerHTML;
			bulkInvitations.reportBuilder.scEditor.rightPanel.appendChild(opt);

			toDelete.push(x);
		  }

		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < bulkInvitations.reportBuilder.scEditor.leftPanel.options.length; j++) {
			  if (bulkInvitations.reportBuilder.scEditor.leftPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			bulkInvitations.reportBuilder.scEditor.leftPanel.remove(idx);
		  });

		  bulkInvitations.reportBuilder.scEditor.updateSelectedArray();

		  if (callback && typeof callback == 'function') callback(bulkInvitations.reportBuilder.scEditor.selectedFields);

		},
		arrowUp: function() {
		  var select = bulkInvitations.reportBuilder.scEditor.rightPanel;
		  var length = select.selectedOptions.length;
		  if (length == 0)
			return;

		  for (var i = 0; i < length; i++) {
			var x = select.selectedOptions[i];

			for (var j = 0; j < select.options.length; j++) {
			  if (select.options[j].value == x.value) {
				var idx = j;
				if (j - 1 >= 0)
				  select.insertBefore(select.options[j], select.options[j - 1])
				break;
			  }
			}

		  }

		  bulkInvitations.reportBuilder.scEditor.updateSelectedArray();

		},
		arrowDown: function() {
		  var select = bulkInvitations.reportBuilder.scEditor.rightPanel;
		  var length = select.selectedOptions.length;
		  if (length == 0)
			return;

		  for (var i = 0; i < length; i++) {
			var x = select.selectedOptions[i];

			for (var j = 0; j < select.options.length; j++) {
			  if (select.options[j].value == x.value) {
				var idx = j;
				if (j + 2 == select.options.length)
				  select.appendChild(select.options[j]);
				//if(j + 1 < select.options.length)
				else select.insertBefore(select.options[j], select.options[j + 2])
				break;
			  }
			}

		  }

		  bulkInvitations.reportBuilder.scEditor.updateSelectedArray();
		},
		onFilter: function(text) {
		  var options = bulkInvitations.reportBuilder.scEditor.leftPanel.options;
		  for (var i = 0; i < options.length; i++) {
			if (!text)
			  options[i].removeAttribute("hidden");
			else {
			  if (options[i].innerHTML.toLowerCase().includes(text.toLowerCase()))
				options[i].removeAttribute("hidden");
			  else options[i].hidden = "hidden";
			}
		  }
		},
		updateSelectedArray: function() {
		  var opts = bulkInvitations.reportBuilder.scEditor.rightPanel.options;

		  bulkInvitations.reportBuilder.scEditor.selectedFields = {};
		  bulkInvitations.reportBuilder.scEditor.selectedFieldsArray = [];

		  for (var i = 0; i < opts.length; i++) {
			bulkInvitations.reportBuilder.scEditor.selectedFields[opts[i].value] = opts[i].innerHTML;
			bulkInvitations.reportBuilder.scEditor.selectedFieldsArray.push({
			  field: opts[i].value,
			  title: opts[i].innerHTML
			});
		  }
		  var holder = bulkInvitations.contentHolder();
		  holder.innerHTML = bulkInvitations.htmlUpdates();
		  bulkInvitations.ui.init(true);
		},
		addOptions: function(node) {
		  var obj = Object.assign({}, bulkInvitations.reportBuilder.scEditor.availableFields);
		  var keysSorted = bulkInvitations.reportBuilder.sortFields(obj); //Object.keys(obj).sort(function(a,b){return ((obj[a] > obj[b]) ? 1 : ((obj[b] > obj[a]) ? -1 : 0))});

		  keysSorted.forEach(x => {
			var opt = document.createElement('option');
			opt.value = x[0];
			opt.innerHTML = x[1];
			bulkInvitations.reportBuilder.scEditor.leftPanel.appendChild(opt);
		  });
		},
		autoFill: function(data, node, callback) {
		  bulkInvitations.reportBuilder.scEditor.activeAvailable = JSON.parse(data.Fields);

		  var keys = Object.keys(bulkInvitations.reportBuilder.scEditor.activeAvailable);
		  var options = bulkInvitations.reportBuilder.scEditor.leftPanel.options;
		  var toDelete = [];
		  keys.forEach(key => {
			for (var i = 0; i < options.length; i++)
			  if (options[i].value == key) {
				toDelete.push(options[i]);
				break;
			  }

			var opt = document.createElement('option');
			opt.value = key;
			opt.innerHTML = bulkInvitations.reportBuilder.scEditor.activeAvailable[key];
			bulkInvitations.reportBuilder.scEditor.rightPanel.appendChild(opt);
		  });

		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < bulkInvitations.reportBuilder.scEditor.leftPanel.options.length; j++) {
			  if (bulkInvitations.reportBuilder.scEditor.leftPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			bulkInvitations.reportBuilder.scEditor.leftPanel.remove(idx);
		  });

		  bulkInvitations.reportBuilder.scEditor.updateSelectedArray();


		  if (callback && typeof callback == 'function') callback();

		}
	  },
	},
	mappingData: [],
	getColumnMapping: function(cb) {
	  var mappingDS = bulkInvitations.getMappingValuesDS();

	  mappingDS.read().then(function() {
		//debugger;
		mappingDS.view().forEach(function(el) {
		  bulkInvitations.mappingData['table' + el.FormId + '_' + el.ColumnName] = el;
		});
		cb();
	  });
	},
	getMappingValuesDS: function() {
	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Name_Mapping/kendo/data/search",
			type: 'POST'
		  },
		},

		serverPaging: true,
		serverFiltering: true,
		serverSorting: true,
	  });
	},
	currTemplate: '',
	changeTemplate: function(val) {
	  bulkInvitations.reportBuilder.scEditor.selectedFieldsArray = [];
	  bulkInvitations.currTemplate = val;
	  var holder = bulkInvitations.contentHolder();
	  holder.innerHTML = bulkInvitations.htmlUpdates();
	  bulkInvitations.ui.init(true);
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  bulkInvitations.getReportBuilderReportsColumns(val, function() {
		mo.fn.overlay.hide();
		bulkInvitations.reportBuilder.switchType(val, bulkInvitations.reportBuilderHolder());
	  });
	},
	parseExcel: function(file, callback) {

	  var reader = new FileReader();
	  bulkInvitations.fileName = file.name;
	  reader.onload = function(e) {
		var data = e.target.result;
		var workbook = XLSX.read(data, {
		  type: 'binary'
		});
		workbook.SheetNames.forEach(function(sheetName) {
		  var excelData = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		  callback(excelData);
		})
	  };

	  reader.onerror = function(ex) {
		callback(ex);
	  };

	  reader.readAsBinaryString(file);

	},
	processData: function(data, sendInvite, createNewProfile, validation) {


	  bulkInvitations.holder().querySelector(".invitation-report").style.pointerEvents = "none";
	  bulkInvitations.holder().querySelector(".invitation-validate").style.pointerEvents = "none";
	  bulkInvitations.holder().querySelector(".invitation-upload").style.pointerEvents = "none";
	  bulkInvitations.holder().querySelector(".invitation-send").style.pointerEvents = "none";
	  bulkInvitations.holder().querySelector(".invitation-reset").style.pointerEvents = "none";
	  bulkInvitations.batchId = `${access.user.Email};${bulkInvitations.fileName};${new Date().toISOString().replace(/[T,Z]/g, ' ').replace(/\.\d{3}/,'')}`;

	  bulkInvitations.recursion(0, 10, data, bulkInvitations.currTemplate !== '' ? false : sendInvite, createNewProfile, validation);

	},
	recursion: function(page, pageSize, data, sendInvite, createNewProfile, validation) {
	  console.log(`recursive batch ops: page ${page} started`);
	  const currData = data.slice(pageSize * page, pageSize * (page + 1));
	  if (currData && currData.length) {
		var total = currData.length;
		var cur = 0;
		var idx = (pageSize * page) + cur;
		const cb = function(row, currIdx) {
		  data[(pageSize * page) + currIdx] = row;
		  cur++;
		  if (cur == total) {
			setTimeout(function() {
			  var grid = $(bulkInvitations.holder().querySelector(".bulk-invs-grid")).data("kendoGrid");
			  grid.dataSource.data(data);
			  grid.refresh();
			  bulkInvitations.recursion(page + 1, pageSize, data, sendInvite, createNewProfile, validation);
			}, 500);
		  }
		};
		currData.forEach((x, currIdx) => {
		  idx = (pageSize * page) + cur;
		  bulkInvitations.ui.updateProgress(idx, data.length);
		  bulkInvitations.proccessCaseRow(x, validation, function(resp) {
			if (bulkInvitations.currTemplate !== '') {
			  bulkInvitations.proccessCaseCFRow(resp, validation, function(cfResp) {
				bulkInvitations.proccessProfileRow(cfResp, sendInvite, createNewProfile, validation, function(r) {
				  bulkInvitations.proccessProfileCFRow(r, validation, function(pcfResp) {
					cb(pcfResp, currIdx);
				  });
				});
			  });
			} else {
			  bulkInvitations.proccessProfileRow(resp, sendInvite, createNewProfile, validation, function(row) {
				cb(row, currIdx);
			  });
			}
		  });
		});
	  } else {
		bulkInvitations.ui.updateProgress(data.length, data.length);
		console.log('recursive batch ops finished');
		bulkInvitations.holder().querySelector(".invitation-validate").style.pointerEvents = "all";
		bulkInvitations.holder().querySelector(".invitation-upload").style.pointerEvents = "all";
		bulkInvitations.holder().querySelector(".invitation-send").style.pointerEvents = "all";
		bulkInvitations.holder().querySelector(".invitation-reset").style.pointerEvents = "all";
		return;
	  }
	},
	validateProfileData: function(row) {
	  var error = "";

	  var required = "";
	  var invalid = "";
	  const isTemplate = bulkInvitations.currTemplate !== '';
	  if (isTemplate && !row.ProfileId) {
		required += "ProfileId/";
	  }

	  if (!isTemplate && !row.CompanyName) {
		required += "Company Name/";
	  }

	  if (row.Region) {
		if (row.Region != "NA" && row.Region != "EMEA" && row.Region != "AMS" && row.Region != "APJ")
		  invalid += "Region/";
	  } else if (!isTemplate) required += "Region/";

	  if (row.Country) {
		var country = reference.countries.rawData.find(x => x.Name == row.Country || x.ISO2 == row.Country);
		if (country) {
		  row.Country = country.ISO2;
		  row.Language = row.Language || country.PreferredLang || "en_US";
		} else invalid += "Country/";
	  } else if (!isTemplate) {
		required += "Country/";
	  }
	  if (row.Language) {
		const lang = reference.languages.data.find(el => el.value.toLowerCase() == row.Language.toLowerCase() || !!el.aliases.find(a => a.toLowerCase() == row.Language.toLowerCase()));
		if (!lang) {
		  invalid += "Language/";
		} else {
		  row.Language = lang.value;
		}
	  }
	  /*if(row.State) {
            const state = reference.states.data.find(el => el.Capital === row.State || el.Districts.indexOf(`\"name\":\"${row.State}\"`) > -1);
            if (!state) {
              invalid += "State/";
            }
          }*/

	  /*
        if (row.IntakeForm) {
          var config = reference.configs.data.find(x => x.ConfigName == row.IntakeForm || x.ConfigId == row.IntakeForm);
          if (config) {
            row.IntakeForm = config.ConfigId;
            row.ConfigFK = config.EntryId;
            var category = reference.category.find(x => x.configs.find(x => x == config.ConfigId));
            if (category) {
              row.Category = category.value;
            }
          } else invalid += "Intake Form/";
        } else if (!isTemplate) {
          required += "Intake Form/";
          if (row.Category) {
            var category = reference.category.find(cat => cat.value == row.Category);
            if (!category) {
              invalid += "Category/";
            }
          }
        }

        if (!row.Category && !isTemplate) {
          required += "Category/";
        }
        */

	  if (row.IntakeForm) {
		var config = reference.configs.data.find(x => x.ConfigName == row.IntakeForm || x.ConfigId == row.IntakeForm);
		if (config) {
		  row.IntakeForm = config.ConfigId;
		  row.ConfigFK = config.EntryId;
		  if(row.Category) {
			var category = reference.category.find(cat => !!cat.configs.find(x => x == config.ConfigId) && cat.value == row.Category);
			if(!category) {
			  invalid += "Category/";
			}
		  }
		  else {
			if(config.ConfigId === "reseller_prospective" || config.ConfigId === "proximity_prospective") {
			  row.Category = "Reseller-Prospective";

			}
			else {
			  var category = reference.category.find(x => x.configs.find(x => x == config.ConfigId));
			  if (category) {
				row.Category = category.value;
			  }
			  else {
				invalid += "Category/";
			  }
			}
		  }
		} 
		else {
		  invalid += "Intake Form/";
		}
	  } 
	  else if (!isTemplate) {
		required += "Intake Form/";
		if (row.Category) {
		  var category = reference.category.find(cat => cat.value == row.Category);
		  if (!category) {
			invalid += "Category/";
		  }
		}
	  }

	  if (row.Category && !row.IntakeForm) {
		required += "Intake Form/";
	  }

	  if (!row.Category && !isTemplate) {
		required += "Category/";
	  }

	  if (row.EmailAddress) {
		if (!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(row.EmailAddress))
		  invalid += "Contact Email/"
	  } else if (!isTemplate) required += "Contact Email/";

	  if (!row.Name && !isTemplate)
		required += "Contact Name/";

	  if (row.InternalOwner) {
		var owner = reference.users.data.find(x => x.Email == row.InternalOwner);
		if (!owner)
		  invalid += "Internal Owner/";
	  } else if (!isTemplate) required += "Internal Owner/";

	  if (row.PublicyTradedCompany) {
		if (row.PublicyTradedCompany == 'Yes' || row.PublicyTradedCompany == 'No') {
		  row.PublicyTradedCompany = row.PublicyTradedCompany === 'Yes' ? 'Y' : 'N';
		}
		if (row.PublicyTradedCompany !== 'Y' && row.PublicyTradedCompany !== 'N') {
		  invalid += "PublicyTradedCompany/";
		}
	  }

	  if (row.IsActive) {
		if (row.IsActive == 'Yes' || row.IsActive == 'No') {
		  row.IsActive = row.IsActive === 'Yes' ? 'Y' : 'N';
		}
		if (row.IsActive !== 'Y' && row.IsActive !== 'N') {
		  invalid += "IsActive/";
		}
	  }

	  if (row.CountryOfRegistration) {
		var regCountry = reference.countries.rawData.find(x => x.Name == row.CountryOfRegistration || x.ISO2 == row.CountryOfRegistration);
		if (regCountry) {
		  row.CountryOfRegistration = regCountry.ISO2;
		} else invalid += "CountryOfRegistration/";
	  }

	  if (row.LegalFormOfCompany) {
		const lfOptions = ['AB', 'AG', 'BV', 'BVBA', 'Co', 'Corp', 'Dd', 'Doo', 'EOOD', 'GDK', 'GmbH', 'HB', 'INC', 'Individual', 'KD', 'KDA', 'Kft', 'KK', 'LLC', 'LLP', 'Ltd', 'Ltda', 'NV', 'OOD', 'Other', 'Oy', 'Partnersh', 'Plc', 'Pty Ltd', 'Pvt Ltd', 'SA', 'SA de CV', 'SD', 'Sdn Bhd', 'SL', 'Sole Proprietor', 'SP.zo.o', 'SpA', 'SPRL', 'Srl'];
		if (!!!lfOptions.find(el => el === row.LegalFormOfCompany)) {
		  invalid += "Legal Form Of Company/";
		}
	  }

	  if (row.SiebelID) {
		if (!/[1,2,3]-[A-Za-z0-9-]+/.test(row.SiebelID)) {
		  invalid += "Siebel ID/";
		}
	  }
	  // check if any of them provided
	  if (row.StatusReason || row.ProfileStatus || row.LastStatusReason) {
		if (!row.StatusReason) {
		  required += "StatusReason/";
		}
		if (!row.LastStatusReason) {
		  required += "Approval Status Comment/";
		}
		// at least both required params were passed
		if (row.StatusReason && row.LastStatusReason) {
		  const idx = singleCompanyDetails.statusReasonStructure[0].group[0][0].options.findIndex(el => el === row.StatusReason);
		  if (idx > -1) {
			row.StatusReason = singleCompanyDetails.statusReasonStructure[0].group[0][0].values[idx];
		  } else {
			if (!!!singleCompanyDetails.statusReasonStructure[0].group[0][0].values.find(el => el === row.StatusReason)) {
			  invalid += "Status Reason/";
			}
		  }
		  if (row.ProfileStatus) {
			// may be empty, but if not, it should be correct
			if (singleCompanyDetails.getProfileStatus(row.StatusReason) !== row.ProfileStatus) {
			  invalid += "Status/";
			}
		  } else {
			row.ProfileStatus = singleCompanyDetails.getProfileStatus(row.StatusReason);
		  }
		  // date will be generated automaticaly, do not need to pass it manually
		  row.LastStatusChangeDate = (new Date()).toISOString();
		}
	  }

	  if (required)
		error += "Required: " + required.substring(0, required.length - 1);

	  if (invalid) {
		if (error == "")
		  error += "Invalid: " + invalid.substring(0, invalid.length - 1);
		else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
	  }

	  return {
		"row": row,
		"error": error
	  };
	},
	validateCustomFields: function(row, type = 'Profiles') {
	  var error = "";
	  var invalid = "";
	  const cf = type === 'Profiles' ? singleCompanyDetails.customFields.structure : invitation.invitationOverview.customFields.structure;
	  var cfFields = [];
	  var cfObj = {};
	  var hasField = false;
	  const replacementKey = type === 'Profiles' ? "ProfileCF" : "CaseCF";
	  cf.map(el => {
		cfFields = [...cfFields, ...el.group[0]];
	  });
	  const fields = Object.keys(row);
	  fields.map(field => {
		if (!!row[field]) {
		  const itm = cfFields.find(el => el.label == field.replace(replacementKey, "") || el.data == field.replace(replacementKey, ""));
		  if (itm) {
			hasField = hasField || true;
			switch (itm.type) {
			  case 'toggle':
				/*if (row[field] == 'Yes' || row[field] == 'No') {
                    row[field] = row[field] === 'Yes' ? 'Y' : 'N';
                  }
                  if (row[field] !== 'Y' && row[field] !== 'N') {
                    invalid += itm.label + "/";
                  }*/
				if(row[field].toLowerCase() == 'yes' || row[field].toLowerCase() == 'y') {
				  row[field] = 'Yes';
				}
				else if(row[field].toLowerCase() == 'no' || row[field].toLowerCase() == 'n') {
				  row[field] = 'No';
				}
				if (row[field] !== 'Yes' && row[field] !== 'No') {
				  invalid += itm.label + "/";
				}
				break;
			  case 'datetime':
			  case 'date':
				var dRes = bulkInvitations.validateDate(row[field]);
				if(!dRes) {
				  invalid += itm.label + "/";
				}
				else {
				  row[field] = dRes;
				}
				break;
			  case 'select':
				var idx = itm.options.findIndex(el => el === row[field]);
				if (idx > -1) {
				  row[field] = itm.values[idx];
				}
				if (!!!itm.values.find(el => el == row[field])) {
				  invalid += itm.label + "/";
				}
				break;
			  case 'multiselect':
				var parts = row[field].split(',');
				var result = '';
				var valid = true;
				for (let i = 0; i < parts.length; i++) {
				  if (parts[i]) {
					var idx = itm.options.findIndex(el => el === parts[i]);
					if (idx > -1) {
					  result += itm.values[idx];
					} else if (!!itm.values.find(el => el == parts[i])) {
					  result += parts[i];
					} else {
					  result += parts[i];
					  if (valid) {
						valid = false;
						invalid += itm.label + "/";
					  }
					}
					result += (i < (parts.length - 1)) ? ',' : '';
				  }
				}
				row[field] = result;
				break;
			  default:
				break;
			}
			cfObj[field.replace(replacementKey, "")] = row[field];
		  }
		}
	  });
	  if (invalid) {
		if (error == "")
		  error += "Invalid: " + invalid.substring(0, invalid.length - 1);
		else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
	  }

	  return {
		"row": row,
		"error": error,
		"hasField": hasField,
		"cf": cfObj
	  };
	},
	validateCaseData: function(row) {
	  var error = "";
	  var required = "";
	  var invalid = "";
	  const isTemplate = bulkInvitations.currTemplate !== '';
	  if (isTemplate && !row.CaseId) {
		required += "CaseId/";
	  }

	  if (row.CaseLanguage) {
		const lang = reference.languages.data.find(el => el.value.toLowerCase() == row.CaseLanguage.toLowerCase() || !!el.aliases.find(a => a.toLowerCase() == row.CaseLanguage.toLowerCase()));
		if (!lang) {
		  invalid += "Language/";
		} else {
		  row.CaseLanguage = lang.value;
		}
	  }
	  if (row.CaseStage) {
		if (row.CaseStatus && row.CaseStatus !== 'Closed') {
		  invalid += "Case Status/";
		}
		if (!!!row.CaseCloseComment) {
		  required += "Case Close Reason/";
		} else {
		  switch (row.CaseStage) {
			case 'Passed':
			  row["CaseStatusId"] = 4;
			  break;
			case 'Denied':
			  row["CaseStatusId"] = 5;
			  break;
			case 'Closed':
			  row["CaseStatusId"] = 6;
			  break;
			default:
			  invalid += "Case Stage/";
			  break;
		  }
		  if (row.CaseCloseCode) {
			var closeCodes = [];
			switch (row.CaseStage) {
			  case 'Passed':
				closeCodes = ['04-Pass -Low Risk', '05-Pass-Medium Risk',
							  '06-Pass-Medium-High Risk', '07-Pass-High Risk',
							  '08-Pass-Hold for Review', '09-Pass-Executive Exemption'
							 ];
				break;
			  case 'Denied':
				closeCodes = ['01-Reject/Fail-Incomplete, Non-Responsive', '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision'];
				break;
			  case 'Closed':
				closeCodes = ['97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case', 'Non-Responsive']
				break;
			}
			if (!!!closeCodes.find(el => el === row.CaseCloseCode)) {
			  invalid += "Case Pass Fail/";
			}
		  } else {
			required += "Case Pass Fail/";
		  }
		}
	  } else if (row.CaseCloseCode) {
		if (!!!row.CaseCloseComment) {
		  required += "Case Close Reason/";
		}
		switch (row.CaseCloseCode) {
		  case '04-Pass -Low Risk':
		  case '05-Pass-Medium Risk':
		  case '06-Pass-Medium-High Risk':
		  case '07-Pass-High Risk':
		  case '08-Pass-Hold for Review':
		  case '09-Pass-Executive Exemption':
			row["CaseStatusId"] = 4;
			break;
		  case '01-Reject/Fail-Incomplete, Non-Responsive':
		  case '02-Reject-CL1/PL1 Decision':
		  case '03-Reject-Business Decision':
			row["CaseStatusId"] = 5;
			break;
		  case '97-Closed-No Contract':
		  case '98-Reactive Case':
		  case '99-Permanently Deleted Case':
		  case 'Non-Responsive':
			row["CaseStatusId"] = 6;
			break;
		  default:
			invalid += "Case Pass Fail/";
			break;
		}
	  }
	  if (required) {
		error += "Required: " + required.substring(0, required.length - 1);
	  }
	  if (invalid) {
		if (error == "")
		  error += "Invalid: " + invalid.substring(0, invalid.length - 1);
		else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
	  }
	  return {
		"row": row,
		"error": error
	  };
	},
	/*validateCaseCustomFields: function(row) {
                        var error = "";
                      var invalid = "";
                      const cf = invitation.invitationOverview.customFields.structure;
                      var cfFields = [];
                        var cfObj = {};
                        var hasField = false;
                      cf.map(el => {
                          cfFields = [...cfFields, ...el.group[0]];
                      });
                      const fields = Object.keys(row);
                      fields.map(field => {
                          if (!!row[field]) {
                              const itm = cfFields.find(el => el.label == field.replace("CaseCF","") || el.data == field.replace("CaseCF",""));
                              if (itm) {
                                    hasField = hasField || true;
                                  switch (itm.type) {
                                      case 'toggle':
                                          if(row[field] == 'Yes' || row[field] == 'No') {
                                              row[field] = row[field] === 'Yes' ? 'Y' : 'N';
                                          }
                                          if(row[field] !== 'Y' && row[field] !== 'N') {
                                            invalid += itm.label+"/";
                                          }
                                          break;
                                      case 'datetime':
                                          var date = new Date(row[field]);
                                            var userTimezoneOffset = date.getTimezoneOffset() * 60000;
                                          row[field] = new Date(date.getTime() - userTimezoneOffset);
                                          break;
                                      case 'select':
                                          var idx = itm.options.findIndex(el => el === row[field]);
                                          if(idx > -1) {
                                            row[field] = itm.values[idx];
                                          }
                                          if(!!!itm.values.find(el => el == row[field])) {
                                             invalid += itm.label+"/";
                                          }
                                          break;
                                      case 'multiselect':
                                          var parts = row[field].split(',');
                                          var result = '';
                                          var valid = true;
                                          for(let i = 0; i < parts.length; i++) {
                                            if(parts[i]) {
                                              var idx = itm.options.findIndex(el => el === parts[i]);
                                              if(idx > -1) {
                                                result += itm.values[idx];
                                              }
                                              else if(!!itm.values.find(el => el == parts[i])) {
                                                result += parts[i];
                                                }
                                                else {
                                                result += parts[i];
                                                if(valid) {
                                                  valid = false;
                                                  invalid += itm.label+"/";
                                                }
                                              }
                                              result += (i < (parts.length - 1)) ? ',' : '';
                                            }
                                          }
                                          row[field] = result;
                                          break;
                                      default: 
                                          break;
                                  }
                                    cfObj[field.replace("CaseCF","")] = row[field];
                              }
                          }
                      });
                      if (invalid) {
                          if (error == "")
                              error += "Invalid: " + invalid.substring(0, invalid.length - 1);
                          else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
                      }

                      return {
                          "row": row,
                          "error": error,
                            "hasField": hasField,
                            "cf": cfObj
                      };
                  },*/
	findProfileByKeys: function(row, callback) {

	  var filter1 = {
		logic: "or",
		filters: [{
		  field: "EntryId",
		  operator: "eq",
		  value: row["ProfileId"]
		},
				  {
					field: "LegacyId",
					operator: "eq",
					value: row["ProfileId"]
				  }
				 ]
	  };

	  /*
                  var filter2 =	{
                    logic: "and",
                    filters: [
                      {
                            logic: "and",
                            filters: [
                              {
                                field: "SiebelID",
                                operator: "eq",
                                value: row["SiebelID"] || "--"
                              },
                              {
                                field: "IntakeForm",
                                operator: "eq",
                                value: row["IntakeForm"] || "--"
                              }
                            ]
                          },
                          {
                            logic: "and",
                            filters: [
                              {
                                field: "PartyId",
                                operator: "eq",
                                value: row["PartyId"] || "--"
                              },
                              {
                                field: "IntakeForm",
                                operator: "eq",
                                value: row["IntakeForm"] || "--"
                              }
                            ]
                          },
                          {
                            logic: "and",
                            filters: [
                              {
                                field: "CompanyName",
                                operator: "eq",
                                value: row["CompanyName"] || "--"
                              },
                              {
                                field: "IntakeForm",
                                operator: "eq",
                                value: row["IntakeForm"] || "--"
                              }
                            ]
                          }
                    ]
                  };

                  if(row["SiebelID"])
                    filter2.filters.push({
                      field: "SiebelID",
                      operator: "eq",
                      value: row["SiebelID"]
                    });

                  if(row["PartyId"])
                    filter2.filters.push({
                      field: "PartyId",
                      operator: "eq",
                      value: row["PartyId"]
                    },);

                  if(row["CompanyName"])
                    filter2.filters.push({
                      field: "CompanyName",
                      operator: "eq",
                      value: row["CompanyName"] 
                    });

                  if(row["IntakeForm"])
                    filter2.filters.push({
                      field: "IntakeForm",
                      operator: "eq",
                      value: row["IntakeForm"] 
                    });


                  var filter3 =	{
                    logic: "and",
                    filters: []
                  };

          */

	  if (row["ProfileId"]) {
		bulkInvitations.findProfile(filter1, function(item) {
		  if (item && typeof item != "string") {
			callback(item);
		  } else if (typeof item == "string") {
			//row.Comment = item;
			//row.Status = -1;
			callback(undefined, item);
		  } else {
			//row.Comment = "Profile not found.";
			//row.Status = -1;
			callback(undefined, "Profile not found.");
		  }
		  /* else
                        findProfile(filter2, function(item) {
                          if(item &&typeof item != "string")
                          {
                            callback(item);
                          }
                          else if(typeof item == "string")
                          {
                            row.Comment = item;
                            row.Status = -1;
                            callback();
                          }
                          else  findProfile(filter3, function(item) {
                            if(item &&typeof item != "string")
                            {
                              callback(item);
                            }
                            else if(typeof item == "string")
                            {
                              row.Comment = item;
                              row.Status = -1;
                              callback();
                            }
                            else 
                            {
                              row.Comment = "Profile not found.";
                              row.Status = -1;
                              callback();
                            }
                          });
                        });
          */
		});
	  }
	  /*   else if(filter2.filters.length > 0)
                  {
                    findProfile(filter2, function(item) {
                      if(item && typeof item != "string")
                      {
                        callback(item);
                      }
                      else if(typeof item == "string")
                      {
                        row.Comment = item;
                        row.Status = -1;
                        callback();
                      }
                      else  findProfile(filter3, function(item) {
                        if(item &&typeof item != "string")
                        {
                          callback(item);
                        }
                        else if(typeof item == "string")
                        {
                          row.Comment = item;
                          row.Status = -1;
                          callback();
                        }
                      });
                    });

                  }
                  else if(filter3.filters.length > 0)
                  {
                    findProfile(filter3, function(item) {
                      if(item &&typeof item != "string")
                      {
                        callback(item);
                      }
                      else if(typeof item == "string")
                      {
                        row.Comment = item;
                        row.Status = -1;
                        callback();
                      }
                      else 
                      {
                        row.Comment = "Profile not found.";
                        row.Status = -1;
                        callback();
                      }
                    });
                  } */
	  else {
		//row.Comment = "Profile not found.";
		//row.Status = -1;
		callback();
	  }
	},
	findProfile: function(filter, callback) {
	  if (filter.filters.length == 0)
		return callback("Profile not found");

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_CompanyInformation/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,

	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length == 1)
		  callback(data[0].toJSON());

		if (data.length == 0)
		  callback();

		if (data.length > 1)
		  callback("Multiple profiles found: " + data.map(x => {
			return x.EntryId
		  }).join(", "));

	  });

	},
	findCaseByKeys: function(row, callback) {

	  var filter1 = {
		logic: "or",
		filters: [{
		  field: "EntryId",
		  operator: "eq",
		  value: row["CaseId"]
		},
				  {
					field: "LegacyId",
					operator: "eq",
					value: row["CaseId"]
				  }
				 ]
	  };

	  if (row["CaseId"]) {
		bulkInvitations.findCase(filter1, function(item) {
		  if (item && typeof item != "string") {
			callback(item);
		  } else if (typeof item == "string") {
			callback(undefined, item);
		  } else {
			callback(undefined, "Case not found.");
		  }
		});
	  } else {
		callback();
	  }
	},
	findCase: function(filter, callback) {
	  if (filter.filters.length == 0)
		return callback("Case not found");

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Invitations/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,

	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length == 1)
		  callback(data[0].toJSON());

		if (data.length == 0)
		  callback();

		if (data.length > 1)
		  callback("Multiple cases found: " + data.map(x => {
			return x.EntryId
		  }).join(", "));

	  });

	},
	createProfile: function(data, callback) {

	  data.Status = "";

	  crud.create("3984", { ...data,
						   Status: "Pending",
						   StatusReason: "Pending"
						  }, function(e) {
		if (!e.EntryId) {
		  try {
			callback(JSON.stringify(e));
		  } catch (e) {
			callback(e);
		  }
		} else {
		  singleCompanyDetails.addAuditLog("Profile created", util.getDifference({}, e, companyModal.config()), util.Email());
		  return callback(e);
		}
	  });

	},
	updateProfile: function(profile, data, callback) {
	  const prevData = { ...profile
					   };
	  data.Status = "";
	  var keys = Object.keys(data);
	  keys.forEach(x => {
		if (data[x])
		  if (x == "ProfileStatus") {
			profile["Status"] = data[x];
		  }
		  else {
			profile[x] = data[x];
		  }
	  });
	  crud.update("3980", profile.EntryId, profile, function(e) {
		if (!e.EntryId) {
		  try {
			return callback(JSON.stringify(e));
		  } catch (e) {
			return callback(e);
		  }
		} else {
		  singleCompanyDetails.addAuditLog("Profile changed", util.getDifference(prevData, e, companyModal.config()), util.Email());
		  return callback(e);
		}
	  });

	},
	updateCase: function(caseItem, data, callback) {
	  const old = { ...caseItem
				  };
	  const newStatus = data["CaseStatusId"] || 0;
	  const oldStatus = {...caseItem}["Status"];
	  Object.keys(data).map(key => {
		if (key !== 'CaseStatus' && key !== 'CaseStage' && !key.startsWith("CaseCF") && key.startsWith("Case") && !!data[key]) {
		  if (key == "CaseStatusId") {
			caseItem["Status"] = data[key];
		  } else {
			caseItem[key.replace("Case", "")] = data[key];
		  }
		}
	  });
	  //caseItem.Language = data.CaseLanguage || caseItem.Language;
	  crud.update("3693", caseItem.EntryId, caseItem, function(e) {
		const cb = function() {
		  if (!e.EntryId) {
			try {
			  return callback(JSON.stringify(e));
			} catch (e) {
			  return callback(e);
			}
		  } else {
			invitation.invitationOverview.addAuditLog("Case Updated", util.getDifference(old, e), util.Email());
			return callback(e);
		  }
		}
		if(oldStatus <= 2 && newStatus > 2) {
		  $.ajax({
			type: 'GET',
			url: 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/ark/sync_case.php?caseId='+caseItem.EntryId+'&user='+util.Email(),
			success: function() {},
			error: function() {}
		  });
		}

		if (!bulkInvitations.currTemplate && data.CaseCPI) {
		  crud.read("4012", "eid=" + caseItem.EntryId, function(resp) {
			if (resp && resp.Rows && resp.Rows.length) {
			  crud.update("4008", resp.Rows[0].EntryId, { ...resp.Rows[0],
														 CPI: data.CaseCPI
														}, function(r) {
				invitation.invitationOverview.addAuditLog("Case Custom Fields updated", util.getDifference(resp.Rows[0], r), util.Email(), null, caseItem.EntryId);
				cb();
			  });
			} else {
			  crud.create("4007", {
				CaseFK: caseItem.EntryId,
				CPI: data.CaseCPI
			  }, function(r) {
				invitation.invitationOverview.addAuditLog("Case Custom Fields created", util.getDifference({}, d), util.Email(), null, caseItem.EntryId);
				cb();
			  });
			}
		  });
		} else {
		  cb();
		}
	  });

	},
	proccessProfileRow: function(row, sendInvite, createNewProfile, validation, callback) {
	  if (!row.ProfileId && bulkInvitations.currTemplate) {
		callback(row);
		return;
	  }
	  var itm = null;
	  const cols = bulkInvitations.currTemplate ? bulkInvitations.ui.getColumns() : bulkInvitations.ui.columns();
	  cols.map(col => {
		var k = col.field;
		if (!k.startsWith("Case") && !k.startsWith("ProfileCF") && row[k]) {
		  itm = itm ? { ...itm,
					   [k]: row[k]
					  } : {
			[k]: row[k]
		  }
		}
	  });
	  if (!itm) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitations.validateProfileData(itm);
	  var error = result.error;
	  /*bulkInvitations.ui.columns().map(col => {
              var k = col.field;
              if(!k.startsWith("Case") && result.row[k])
              {
                row[k] = result.row[k];
              }
            });*/
	  row = { ...row,
			 ...result.row
			};

	  bulkInvitations.findProfileByKeys(row, function(profile, comment) {
		if (profile) {
		  if (validation) {
			var profileCopy = JSON.parse(JSON.stringify(profile));
			var keys = Object.keys(profileCopy);
			keys.forEach(x => {
			  if (row[x] && !x.startsWith("Case") && !x.startsWith("ProfileCF"))
				profileCopy[x] = row[x];
			});

			//var error = bulkInvitations.validateData(profileCopy);
			if (error) {
			  row.Comment = (row.Comment || "") + "The profile (#" + profile.EntryId + ") doesn't contain required information. Error: " + error + "\n";
			  row.Status = -1;
			} else
			  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);

			callback(row);
			return;
		  }


		  //if(sendInvite)
		  //{
		  var keys = Object.keys(row);
		  var dataToUpdate = {};
		  keys.forEach(x => {
			if (row[x] && !(typeof row[x] === 'function') && !x.startsWith("Case") && !x.startsWith("ProfileCF"))
			  dataToUpdate[x] = row[x];
		  });

		  if (error) {
			row.Comment = (row.Comment || "") + "Could not update the profile. Error: " + error + "\n";
			row.Status = -1;
			callback(row);
			return;
		  }
		  bulkInvitations.updateProfile(profile, dataToUpdate, function(item) {
			if (item && typeof item == "string") {
			  row.Comment = (row.Comment || "") + "Could not update the profile. Error: " + (item || "Unknown") + "\n";
			  row.Status = -1;
			  callback(row);
			} else {

			  if (sendInvite) {
				//var error = bulkInvitations.validateData(item);

				if (error) {
				  row.Comment = (row.Comment || "") + "The profile (#" + profile.EntryId + ") doesn't contain required information. Error: " + error + "\n";
				  row.Status = -1;
				  callback(row);
				  return;
				}

				bulkInvitations.invite(item, function(response) {
				  if (response && typeof response == "string") {
					row.Comment = (row.Comment || "") + "Could not send the invitation. Error: " + (response || "Unknown") + "\n";
					row.Status = -1;
				  } else {
					singleCompanyDetails.addAuditLog("Profile updated", util.getDifference({}, item, companyModal.config()), util.Email(), null, item.EntryId);
					row.Comment = (row.Comment || "") + "Profile #" + profile.EntryId + " updated. Invitation # " + response.EntryId + " was sent." + "\n";
					row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
				  }
				  callback(row);
				});
			  } else {
				singleCompanyDetails.addAuditLog("Profile updated", util.getDifference({}, item, companyModal.config()), util.Email(), null, item.EntryId);
				row.Comment = (row.Comment || "") + "Profile #" + profile.EntryId + " updated." + "\n";
				row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);

				callback(row);
			  }
			}
		  });
		  //}
		  /*else 
                        {
                          row.Status = 1;
                          callback(row);
                        }*/
		} else {
		  if (row.ProfileId) {
			row.Comment = (row.Comment || "") + `Could not update the profile. Error: Could not find the profile with # ${row.ProfileId}` + error + "\n";
			row.Status = -1;
			callback(row);
			return;
		  }
		  if (createNewProfile) {
			//var error = bulkInvitations.validateData(row);

			if (error) {
			  row.Comment = (row.Comment || "") + (row.Comment || "") + "Could not create the profile. Error: " + error + "\n";
			  row.Status = -1;
			  callback(row);
			  return;
			}


			if (validation) {
			  row.Comment = (row.Comment || "") + "Profile will be created.\n";
			  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
			  callback(row);
			  return;
			}

			row.Source = "Bulk Invitations";
			bulkInvitations.createProfile(row, function(item) {

			  if (item && typeof item == "string") {
				row.Comment = (row.Comment || "") + "Could not create the profile. Error: " + (item || "Unknown") + "\n";
				row.Status = -1;
				callback(row);
			  } else {

				if (sendInvite)
				  bulkInvitations.invite(item, function(response) {
					if (response && typeof response == "string") {
					  row.Comment = (row.Comment || "") + "Could not send the invitation. Error: " + (item || "Unknown") + "\n";
					  row.Status = -1;
					  // callback(row);
					} else {
					  singleCompanyDetails.addAuditLog("Profile created", util.getDifference({}, item, companyModal.config()), util.Email(), null, item.EntryId);
					  row.Comment = (row.Comment || "") + "Profile #" + item.EntryId + " was created. Invitation # " + response.EntryId + " was sent.\n";
					  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
					}
					callback(row);
				  });
				else {
				  singleCompanyDetails.addAuditLog("Profile created", util.getDifference({}, item, companyModal.config()), util.Email(), null, item.EntryId);
				  row.Comment = (row.Comment || "") + "Profile #" + item.EntryId + " was created.\n";
				  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
				  callback(row);
				}

			  }
			});
		  } else {

			if (!row.Comment) {
			  row.Comment = (row.Comment || "") + "Profile not found.\n";
			  row.Status = -1;
			}
			callback(row);
		  }
		}
	  });
	},
	proccessProfileCFRow: function(row, validation, callback) {
	  if (!row.ProfileId) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitations.validateCustomFields(row);
	  var error = result.error;
	  var hasField = result.hasField;
	  var cf = result.cf;
	  if (!hasField) {
		callback(row);
		return;
	  }
	  row = result.row;
	  if (error) {
		row.Comment = (row.Comment || "") + "The Profile (#" + row.ProfileId + ") Custom Fields item has errors. Error: " + error + '\n';
		row.Status = -1;
		callback(row);
		return;
	  }
	  if (validation) {
		row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
		callback(row);
		return;
	  }
	  crud.read("4011", "eid=" + row.ProfileId, function(resp) {
		if (resp && resp.Rows && resp.Rows.length) {
		  const itm = resp.Rows[0];
		  const old = { ...itm
					  };
		  const fields = Object.keys(itm);
		  fields.map(field => {
			itm[field] = cf[field] ? cf[field] : itm[field];
		  });
		  crud.update("4010", itm.EntryId, itm, function(resp) {
			if (!!resp) {
			  row.Comment = (row.Comment || "") + "Profile #" + row.ProfileId + " Custom Fields updated." + '\n';
			  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
			  singleCompanyDetails.addAuditLog("Profile Custom Fields updated", util.getDifference(old, itm), util.Email(), null, row.ProfileId);
			  callback(row);
			  return;
			} else {
			  row.Comment = (row.Comment || "") + "Could not update the profile custom field.\n";
			  row.Status = -1;
			  callback(row);
			  return;
			}

		  });
		} else {
		  crud.create("4009", {
			CompanyFK: row.ProfileId,
			...cf
		  }, function(resp) {
			if (!!resp) {
			  row.Comment = (row.Comment || "") + "Profile #" + row.ProfileId + " Custom Fields created." + '\n';
			  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
			  singleCompanyDetails.addAuditLog("Profile Custom Fields created", util.getDifference({}, cf), util.Email(), null, row.ProfileId);
			  callback(row);
			  return;
			} else {
			  row.Comment = (row.Comment || "") + "Could not create the profile custom field.\n";
			  row.Status = -1;
			  callback(row);
			  return;
			}
		  });
		}
	  });
	},
	proccessCaseRow: function(row, validation, callback) {
	  if (!row.CaseId || (!bulkInvitations.currTemplate && !(row.CaseLanguage || row.CaseCPI))) {
		callback(row);
		return;
	  }
	  var itm = null;
	  const cols = bulkInvitations.currTemplate ? bulkInvitations.ui.getColumns() : bulkInvitations.ui.columns();
	  cols.map(col => {
		var k = col.field;
		if (k.startsWith("Case") && !k.startsWith("CaseCF") && row[k]) {
		  itm = itm ? { ...itm,
					   [k]: row[k]
					  } : {
			[k]: row[k]
		  }
		}
	  });
	  if (!itm) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitations.validateCaseData(itm);
	  var error = result.error;
	  /*bulkInvitations.ui.columns().map(col => {
            var k = col.field;
            if (k.startsWith("Case") && !k.startsWith("CaseCF") && result.row[k]) {
              row[k] = result.row[k];
            }
          });*/
	  row = { ...row,
			 ...result.row
			};

	  bulkInvitations.findCaseByKeys(row, function(caseItm, comment) {
		if (caseItm) {
		  if (bulkInvitations.currTemplate === "Cases and Profiles") {
			if (!!caseItm.CompanyFK) {
			  row['ProfileId'] = caseItm.CompanyFK;
			} else {
			  row.Comment = (row.Comment || "") + "This Case contains incorrect Profile Id. Error: " + error + '\n';
			  row.Status = -1;
			  callback(row);
			  return;
			}
		  }
		  if (validation) {
			var caseCopy = JSON.parse(JSON.stringify(caseItm));
			var keys = Object.keys(caseCopy);
			keys.forEach(x => {
			  if (row[x] && x.startsWith("Case") && !x.startsWith("CaseCF"))
				caseCopy[x] = row[x];
			});

			if (error) {
			  row.Comment = (row.Comment || "") + "The case (#" + caseItm.EntryId + ") doesn't contain required information. Error: " + error + '\n';
			  row.Status = -1;
			} else
			  row.Status = 1;

			callback(row);
			return;
		  }

		  var keys = Object.keys(row);
		  var dataToUpdate = {};
		  keys.forEach(x => {
			if (row[x] && !(typeof row[x] === 'function') && x.startsWith("Case") && !x.startsWith("CaseCF"))
			  dataToUpdate[x] = row[x];
		  });

		  if (error) {
			row.Comment = (row.Comment || "") + "Could not update the case. Error: " + error + '\n';
			row.Status = -1;
			callback(row);
			return;
		  }
		  bulkInvitations.updateCase({ ...caseItm
									 }, dataToUpdate, function(item) {
			if (item && typeof item == "string") {
			  row.Comment = (row.Comment || "") + "Could not update the case. Error: " + (item || "Unknown") + '\n';
			  row.Status = -1;
			  callback(row);
			} else {
			  invitation.invitationOverview.addAuditLog("Case updated",
														util.getDifference(caseItm, item, null, true),
														util.Email(),
														function() {
				row.Comment = (row.Comment || "") + "Case #" + caseItm.EntryId + " updated." + '\n';
				row.Status = 1;

				callback(row);
			  },
														caseItm.EntryId
													   );
			}
		  });
		} else {
		  if (row.CaseId) {
			row.Comment = (row.Comment || "") + `Could not update the case. Could not find the case with # ${row.CaseId}. Error: ` + error + '\n';
			row.Status = -1;
			callback(row);
			return;
		  } else {
			row.Comment = (row.Comment || "") + `Could not update the case. Case # not provided. Error: ` + error + '\n';
			row.Status = -1;
			callback(row);
			return;
		  }
		  callback(row);
		}
	  });
	},
	proccessCaseCFRow: function(row, validation, callback) {
	  if (!row.CaseId) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitations.validateCustomFields(row, 'Cases');
	  var error = result.error;
	  var hasField = result.hasField;
	  var cf = result.cf;
	  if (!hasField) {
		callback(row);
		return;
	  }
	  row = result.row;
	  if (error) {
		row.Comment = (row.Comment || "") + "The Case (#" + row.CaseId + ") Custom Fields item has errors. Error: " + error + '\n';
		row.Status = -1;
		callback(row);
		return;
	  }
	  if (validation) {
		row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
		callback(row);
		return;
	  }
	  crud.read("4012", "eid=" + row.CaseId, function(resp) {
		if (resp && resp.Rows && resp.Rows.length) {
		  const itm = resp.Rows[0];
		  const old = { ...itm
					  };
		  const fields = Object.keys(itm);
		  fields.map(field => {
			itm[field] = cf[field] ? cf[field] : itm[field];
		  });
		  crud.update("4008", itm.EntryId, itm, function(resp) {
			if (!!resp) {
			  row.Comment = (row.Comment || "") + "Case #" + row.CaseId + "Custom Fields updated." + '\n';
			  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
			  invitation.invitationOverview.addAuditLog("Case Custom Fields updated", util.getDifference(old, itm), util.Email(), null, row.CaseId);
			  callback(row);
			  return;
			} else {
			  row.Comment = (row.Comment || "") + "Could not update the case custom field.\n";
			  row.Status = -1;
			  callback(row);
			  return;
			}

		  });
		} else {
		  crud.create("4007", {
			CaseFK: row.CaseId,
			...cf
		  }, function(resp) {
			if (!!resp) {
			  row.Comment = (row.Comment || "") + "Case #" + row.CaseId + "Custom Fields created." + '\n';
			  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
			  invitation.invitationOverview.addAuditLog("Case Custom Fields created", util.getDifference({}, cf), util.Email(), null, row.CaseId);
			  callback(row);
			  return;
			} else {
			  row.Comment = (row.Comment || "") + "Could not create the case custom field.\n";
			  row.Status = -1;
			  callback(row);
			  return;
			}
		  });
		}
	  });
	},
	invite: function(profile, callback) {

	  bulkInvitations.curProfile = profile;

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Company_Cases/kendo/data/search",
			type: 'POST'
		  },
		},
		serverFiltering: true,
		filter: {
		  logic: "and",
		  filters: [{
			logic: "and",
			filters: [{
			  field: "ConfigId",
			  operator: "eq",
			  value: profile.IntakeForm
			},
					  {
						field: "CompanyFK",
						operator: "eq",
						value: profile.EntryId
					  },
					 ]
		  },
					/*{
                        logic: "or",
                        filters: [
                          {
                            field: "Status",
                            operator: "eq",
                            value: 1
                          },
                          {
                            field: "Status",
                            operator: "eq",
                            value: 2
                          }
                        ]
                      },*/
				   ]
		}


	  });

	  ds.read().then(function() {
		var data = ds.view();
		if (data.length > 0 && data[0].Status == 2) {
		  //if(data[0].Status == 2) {
		  callback("Profile #" + profile.EntryId + " has an active invitation with the selected intake form.");
		  return;
		  //}
		  /*else {
                  const invDate = data[0].SubmittedTS || data[0].CompletedTS || data[0].LastVisitTS || data[0].SentTS || data[0].Created;
                  var diffYear = (new Date(invDate).getTime() - (new Date()).getTime()) / 1000;
                  diffYear /= (60 * 60 * 24);
                  diffYear = Math.abs(Math.round(diffYear/365.25));
                  if(diffYear < 3) {
                    callback("Profile #" + profile.EntryId + " has a ddq data within 3 past years.");
                    return;
                  }
                }*/
		} else {
		  const addParam = (data && data.length && data[0].Status == 1 ? "&cid=" + data[0].EntryId : '') + ("&bid=" + btoa(bulkInvitations.batchId));
		  $.ajax({
			type: 'GET',
			url: globalReferences.server + 'resources/rs/custom/php/ark/invite.php?pid=' + profile.EntryId + addParam,
			success: function(response) {
			  var data = JSON.parse(response);
			  if (!data.Success) {
				callback(data.Message);
				return;
			  }

			  var data = JSON.parse(data.Message);


			  if (data.InvitationId) {
				crud.update("4023", data.InvitationId, {
				  BatchId: bulkInvitations.batchId
				}, function() {});

				if (data.Type == "Create") {
				  singleCompanyDetails.addAuditLog("Invitation",
												   'ID: ' + "'" + data.InvitationId + "'",
												   util.Email());



				  invitation.invitationOverview.addAuditLog("Case created (Invitaiton sent)",
															util.getAuditString('ID', null, data.InvitationId),
															util.Email(),
															null,
															data.InvitationId
														   );
				} else if (data.Type == "Update") {
				  singleCompanyDetails.addAuditLog("Invitation updated",
												   'ID: ' + "'" + data.InvitationId + "'",
												   util.Email());



				  invitation.updateDDQOnResend(data.InvitationId, profile, Number(profile.ConfigFK), function(result) {
					if (result !== null) {
					  invitation.invitationOverview.addAuditLog("Case updated (Invitaiton resent)",
																util.getDifference({ ...data.OldInvitation,
																					...result.oldObj
																				   }, { ...data.NewInvitation,
																					   ...result.newObj
																					  }, null, true),
																util.Email(),
																null,
																data.InvitationId
															   );
					} else {
					  invitation.invitationOverview.addAuditLog("Case updated (Invitaiton resent)",
																util.getDifference(data.OldInvitation, data.NewInvitation, null, true),
																util.Email(),
																null,
																data.InvitationId
															   );
					}
					callback(data.NewInvitation);
				  });
				}

				callback(data.NewInvitation);

			  } else {
				callback("Unknown error");
			  }



			},
			error: function() {
			  callback("Unknown error");
			}
		  });

		}
	  });

	},
	findTestProfiles: function(callback, page = 1, pageSize = 5000) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_REMOVE_TEST_PROFILES/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		/* set page size*/
		/*serverFiltering: true,
                              filter: { field: "InternalOwner",//"CompanyName", 
                                       operator: "eq",//"startswith" 
                                       value: "anton.zhabin@hpe.com"//"Anton Zhabin Async Test"
                                      },*/
		serverSorting: true,
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data.map(el => {
			return el.EntryId
		  }));
		}
	  });
	},
	removeTestProfiles: function(page = 1, pageSize = 20) {
	  const cb = function(ids) {
		if (ids && ids.length) {
		  var idx = 0;
		  const total = ids.length;
		  for (var eid of ids) {
			console.log(`Delete Profile Id: ${eid}`);
			reference.profileCascadeDelete.start(eid, function() {
			  idx++;
			  if (idx == total) {
				bulkInvitations.removeTestProfiles(1, pageSize);
			  }
			});
		  }
		}
	  };
	  bulkInvitations.findTestProfiles(cb, page, pageSize);
	},
	findTestCases: function(callback, page = 1, pageSize = 5000) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_TestCases/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		/* set page size*/
		//serverFiltering: true,
		//filter: { field: "InternalOwner",//"CompanyName", 
		//		 operator: "eq",//"startswith" 
		//		 value: "andrici.andrei-toni@hpe.com"//"Anton Zhabin Async Test"
		//		},
		serverSorting: true,
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data.map(el => {
			return el.EntryId
		  }));
		}
	  });
	},
	removeTestCases: function(page = 1, pageSize = 20) {
	  const cb = function(ids) {
		if (ids && ids.length) {
		  var idx = 0;
		  const total = ids.length;
		  for (var eid of ids) {
			console.log(`Delete Case Id: ${eid}`);
			reference.caseCascadeDelete.start(eid, function() {
			  idx++;
			  if (idx == total) {
				bulkInvitations.removeTestCases(1, pageSize);
			  }
			});
		  }
		}
	  };
	  bulkInvitations.findTestCases(cb, page, pageSize);
	},
	findReminders: function(callback, page = 1, pageSize = 10) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1275/ark_reminders_fix_italy/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data);
		}
	  });
	},
	fixReminders: function(page = 1, pageSize = 10) {
	  const cb = function(data) {
		if (data && data.length) {
		  var idx = 0;
		  const total = data.length;
		  const callback = function() {
			idx++;
			if (idx == total) {
			  setTimeout(() => {
				bulkInvitations.fixReminders(page + 1, pageSize);
			  }, 3000);
			}
		  };
		  for (var row of data) {
			// do php
			const addParam = "&cid=" + row.CaseFK;
			$.ajax({
			  type: 'GET',
			  url: globalReferences.server + 'resources/rs/custom/php/ark/invite.php?pid=' + row.CompanyFK + addParam,
			  success: function(response) {
				callback();
				var info = JSON.parse(response);
				if (!info.Success) {
				  console.error("Invites Fix: ", info.Message);
				}

				var msg = JSON.parse(info.Message);
				if (!msg.InvitationId) {
				  console.error("Invites Fix: Unknown error");
				}
			  },
			  error: function() {
				console.error("Invites Fix: Unknown error");
				callback();
			  }
			});
		  }
		}
	  };
	  bulkInvitations.findReminders(cb, page, pageSize);
	},
	recalculateScoring: {
	  start: function(cid, deleteTasks = false, cb) {
		console.log("Scoring Recalculation: recalculation for Case# ", cid);
		crud.read("3694", "eid=" + cid, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			const itm = resp.Rows[0];
			const fn = function() {
			  bulkInvitations.recalculateScoring.removeScoring(cid, function() {
				crud.update("3693", cid, {
				  "Status": 2
				}, function() {
				  $.ajax({
					type: 'GET',
					url: 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/ark/scoring.php?ifk=' + cid,
					success: function(response) {
					  console.log("Scoring Recalculation: recalculation done");
					  cb();
					},
					error: function() {
					  console.error("Scoring Recalculation: recalculation error");
					  cb();
					}
				  });
				});
			  });
			};
			if (itm && itm.Status > 1) {
			  if (deleteTasks) {
				bulkInvitations.recalculateScoring.removeTasks(cid, fn);
			  } else {
				fn();
			  }
			} else {
			  console.log("Scoring Recalculation: no need to recalc");
			  cb();
			}
		  } else {
			console.log("Scoring Recalculation: case not found");
			cb();
		  }
		});
	  },
	  removeTasks: function(cid, cb) {
		crud.read("3960", "inv=" + cid + "&app=ARK", function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			var idx = 0;
			const total = resp.Rows.length;
			for (var itm of resp.Rows) {
			  crud.destroy("4432", itm.EntryId, function() {
				idx++;
				if (idx == total) {
				  console.log("Scoring Recalculation: tasks removed");
				  cb();
				}
			  });
			}
		  } else {
			console.log("Scoring Recalculation: tasks not found");
			cb();
		  }
		});
	  },
	  removeScoring: function(cid, cb) {
		crud.read("3712", "inv=" + cid, function(resp) {
		  if (resp && resp.Rows && resp.Rows.length) {
			crud.destroy("4341", resp.Rows[0].EntryId, function() {
			  console.log("Scoring Recalculation: old scoring removed");
			  cb();
			});
		  } else {
			console.log("Scoring Recalculation: old scoring not found");
			cb();
		  }
		});
	  },
	  findCases: function(callback, page = 1, pageSize = 10) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1275/ark_reminders_fix_italy/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  page: page,
		  pageSize: pageSize,
		});

		ds.read().then(function() {
		  var data = ds.view();

		  if (data.length) {
			callback(data);
		  }
		});
	  },
	  execute: function(page = 1, pageSize = 10, deleteTasks = false) {
		const cb = function(data) {
		  if (data && data.length) {
			var idx = 0;
			const total = data.length;
			const callback = function() {
			  idx++;
			  if (idx == total) {
				setTimeout(() => {
				  bulkInvitations.recalculateScoring.execute(page + 1, pageSize, deleteTasks);
				}, 300);
			  }
			};
			for (var row of data) {
			  bulkInvitations.recalculateScoring.start(row.EntryId, deleteTasks, cb);
			}
		  }
		};
		bulkInvitations.recalculateScoring.findCases(cb, page, pageSize);
	  },
	},
	switchMonthDay: function(value) {
	  // if empty fo nothing
	  if (!value) {
		return undefined;
	  }
	  var separator = value.indexOf('-') > 0 ? '-' : value.indexOf('/') > 0 ? '/' : value.indexOf('.') > 0 ? '.' : null;
	  if(!separator) {
		return undefined;
	  }
	  var currDate = new Date(value);
	  var userTimezoneOffset = currDate.getTimezoneOffset() * 60000;
	  var resultDate = new Date(currDate.getTime() - userTimezoneOffset);

	  // if ISO string, do nothing
	  if(separator == '-') {
		return resultDate.toISOString(); 
	  }

	  var dt = value.split(separator);
	  if(!dt.length || dt.length !== 3) {
		return undefined;
	  }
	  currDate.setMonth(Number(dt[1])-1);
	  currDate.setDate(Number(dt[0]));
	  return resultDate.toISOString(); 
	},
	validateDate: function(value) {
	  var processDate = function(val, delimeter) {
		// split date and time
		var valParts = val.split(' ');
		var dateVal = valParts[0];
		var timeVal = valParts[1];
		// split date parts
		var dateParts = dateVal.split(delimeter);
		var resultDate = new Date();
		// set year, it's always 3rd
		resultDate.setFullYear(dateParts[2]);
		// set month
		resultDate.setMonth(Number(delimeter == '.' ? dateParts[1] : dateParts[0])-1);
		// set day
		resultDate.setDate(Number(delimeter == '.' ? dateParts[0] : dateParts[1]));

		if(!!timeVal) {
		  // do time
		  var timeParts = timeVal.split(':');
		  resultDate.setHours(timeParts[0]);
		  resultDate.setMinutes(timeParts[1]);
		  if(!!timeParts[2]) {
			resultDate.setSeconds(timeParts[2]);
		  }
		  else {
			resultDate.setSeconds(0);
		  }
		}
		else {
		  resultDate.setHours(0);
		  resultDate.setMinutes(0);
		  resultDate.setSeconds(0);
		}
		resultDate.setMilliseconds(0);

		// timezone offset
		var dateTZ = new Date();
		var userTimezoneOffset = dateTZ.getTimezoneOffset() * 60000;
		resultDate = new Date(resultDate.getTime() - userTimezoneOffset);

		return resultDate.toISOString();
	  };
	  if(value.match(/^(19[0-9]{2}|2[0-9]{3})\-(0[1-9]|1[0-2])\-((0[1-9])|[1-2][0-9]|3[0-1])(T((0[0-9])|1[0-9]|2[0-3]):([0-5][0-9])(:([0-5][0-9])Z?))?$/)) {
		// ISO string already, all good
		return value.replace('Z', '');
	  }
	  if(value.match(/^((0[1-9])|[1-2][0-9]|3[0-1])\.(0[1-9]|1[0-2])\.(19[0-9]{2}|2[0-9]{3})(\s((0[0-9])|1[0-9]|2[0-3]):([0-5][0-9])(:([0-5][0-9]))?)?$/)) {
		// day first, EU style
		return processDate(value, '.');
	  }
	  if(value.match(/^(0[1-9]|1[0-2])\/((0[1-9])|[1-2][0-9]|3[0-1])\/(19[0-9]{2}|2[0-9]{3})(\s((0[0-9])|1[0-9]|2[0-3]):([0-5][0-9])(:([0-5][0-9]))?)?$/)) {
		// month first, US style
		return processDate(value, '/');
	  }
	  return null;
	},
	findProfileLastCase: function(callback, page = 1, pageSize = 100) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_Profile_LastCase_FIX/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data);
		}
	  });
	},
	fixProfileLastCase: function(page = 1, pageSize = 100) {
	  const cb = function(data) {
		if (data && data.length) {
		  var idx = 0;
		  const total = data.length;
		  const callback = function() {
			idx++;
			if (idx == total) {
			  setTimeout(() => {
				bulkInvitations.fixProfileLastCase( /*page + */ 1, pageSize);
			  }, 500);
			}
		  };
		  for (var row of data) {
			crud.update("3980", row.EntryId, {
			  "LastCaseFK": row.LastCaseFK
			}, callback);
		  }
		}
	  };
	  bulkInvitations.findProfileLastCase(cb, page, pageSize);
	},
	findProfileCategory: function(callback, page = 1, pageSize = 500) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_FIX_Profile_Intake_Category/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data);
		}
	  });
	},
	fixProfileCategory: function(page = 1, pageSize = 500) {
	  const cb = function(data) {
		if (data && data.length) {
		  var idx = 0;
		  const total = data.length;
		  const callback = function() {
			idx++;
			if (idx == total) {
			  setTimeout(() => {
				bulkInvitations.fixProfileCategory(page + 1, pageSize);
			  }, 500);
			}
		  };
		  for (var row of data) {
			if (row.IntakeForm) {
			  var config = reference.configs.data.find(x => x.ConfigName == row.IntakeForm || x.ConfigId == row.IntakeForm);
			  if (config) {
				var category = reference.category.find(x => x.configs.find(x => x == config.ConfigId));
				if (category) {
				  row.Category = category.value;
				  crud.update("3980", row.EntryId, {
					"Category": row.Category
				  }, callback);
				} else {
				  callback();
				}
			  } else {
				callback();
			  }
			} else {
			  callback();
			}
		  }
		}
	  };
	  bulkInvitations.findProfileCategory(cb, page, pageSize);
	},
	findInvites: function(callback, page = 1, pageSize = 500) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/690/ARK_BATCH_INVITES_FIX/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data);
		}
	  });
	},
	fixInvites: function(page = 1, pageSize = 500) {
	  console.log("invites fix", page);
	  const cb = function(data) {
		if (data && data.length) {
		  var idx = 0;
		  const total = data.length;
		  const callback = function() {
			idx++;
			if (idx == total) {
			  setTimeout(() => {
				bulkInvitations.fixInvites(page + 1, pageSize);
			  }, 3000);
			}
		  };
		  for (var row of data) {
			crud.update("4605", row.EntryId, {
			  "Col3": ""
			}, callback);
		  }
		}
	  };
	  bulkInvitations.findInvites(cb, page, pageSize);
	},
	findCaseCF: function(callback, page = 1, pageSize = 500) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1375/ARK_LEGACY_CF_FIX/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		serverPaging: true,
		page: page,
		pageSize: pageSize,
	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length) {
		  callback(data);
		}
	  });
	},
	fixCaseCF: function(page = 1, pageSize = 500) {
	  console.log("cf fix", page);
	  const cb = function(data) {
		if (data && data.length) {
		  var idx = 0;
		  const total = data.length;
		  const callback = function() {
			idx++;
			if (idx == total) {
			  setTimeout(() => {
				bulkInvitations.fixCaseCF(page + 1, pageSize);
			  }, 3000);
			}
		  };
		  const cf = invitation.invitationOverview.customFields.structure;
		  var cfFields = [];
		  cf.map(el => {
			cfFields = [...cfFields, ...el.group[0]];
		  });
		  for (var row of data) {
			//debugger;
			var obj = {};
			var hasField = false;
			const fields = Object.keys(row);
			fields.map(field => {
			  if (!!row[field]) {
				const itm = cfFields.find(el => el.label == field || el.data == field);
				if (itm) {
				  switch (itm.type) {
					case 'toggle':
					  if(row[field].toLowerCase() == 'yes' || row[field].toLowerCase() == 'y') {
						row[field] = 'Yes';
						obj[field] = row[field];
						hasField = hasField || true;
					  }
					  else if(row[field].toLowerCase() == 'no' || row[field].toLowerCase() == 'n') {
						row[field] = 'No';
						obj[field] = row[field];
						hasField = hasField || true;
					  }
					  break;
					case 'select':
					  var idx = itm.options.findIndex(el => el.replace(/[^a-zA-Z]/gi, '').toLowerCase() === row[field].replace(/[^a-zA-Z]/gi, '').toLowerCase());
					  if (idx > -1) {
						row[field] = itm.values[idx];
						obj[field] = row[field];
						hasField = hasField || true;
					  }
					  else {
						idx = itm.values.findIndex(el => el.replace(/[^a-zA-Z]/gi, '').toLowerCase() === row[field].replace(/[^a-zA-Z]/gi, '').toLowerCase());
						if (idx > -1) {
						  row[field] = itm.values[idx];
						  obj[field] = row[field];
						  hasField = hasField || true;
						}
					  }
					  break;
					case 'multiselect':
					  var parts = row[field].split(',');
					  var result = '';
					  var valid = true;
					  for (let i = 0; i < parts.length; i++) {
						if (parts[i]) {
						  var idx = itm.options.findIndex(el => el.replace(/[^a-zA-Z]/gi, '').toLowerCase() === parts[i].replace(/[^a-zA-Z]/gi, '').toLowerCase());
						  if (idx > -1) {
							result += itm.values[idx];
							hasField = hasField || true;
						  } else if (!!itm.values.find(el => el.replace(/[^a-zA-Z]/gi, '').toLowerCase() == parts[i].replace(/[^a-zA-Z]/gi, '').toLowerCase())) {
							result += parts[i];
							hasField = hasField || true;
						  } else {
							result += parts[i];
						  }
						  result += (i < (parts.length - 1)) ? ',' : '';
						}
					  }
					  row[field] = result;
					  obj[field] = row[field];
					  break;
					default:
					  break;
				  }
				}
			  }
			});
			if(hasField) {
			  crud.update("4008", row.EntryId, obj, callback);
			}
			else {
			  callback();
			}
		  }
		}
	  };
	  bulkInvitations.findCaseCF(cb, page, pageSize);
	},
  };

  const bulkInvitationsServer = {
	batchId: '',
	fileName: '',
	intervalId: null,
	file: null,
	sendInvites: false,
	canCreate: false,
	data: [],
	dbTemplates: [],
	node: function() {
	  return Array.from(document.querySelectorAll('.bulk-ops')).pop();
	},
	templateNode: function() {
	  return Array.from(document.querySelectorAll('#bulk-ops')).pop();
	},
	progressNode: function() {
	  return Array.from(document.querySelectorAll('.bulk-ops-progress')).pop();
	},
	baseHolder: function() {
	  var node = bulkInvitationsServer.node();
	  return node.querySelector('.bulk-invs-server-menu');
	},
	contentHolder: function() {
	  var node = bulkInvitationsServer.node();
	  return node.querySelector('.bulk-invs-server-content');
	},
	holder: function() {
	  var node = bulkInvitationsServer.node();
	  return node.querySelector('.bulk-invs-server-content .bulk-invs-server:first-child');
	},
	holderDropdown: function() {
	  var node = bulkInvitationsServer.node();
	  return node.querySelector('.bulk-template-select');
	},
	reportBuilderHolder: function() {
	  var node = bulkInvitationsServer.node();
	  return node.querySelector('.scEditor');
	},
	init: function(holder) {
	  //navigation.container.innerHTML = "";
	  bulkInvitationsServer.batchId = '';
	  bulkInvitationsServer.fileName = '';
	  bulkInvitationsServer.file = null;
	  bulkInvitationsServer.sendInvites = false;
	  bulkInvitationsServer.canCreate = false;
	  bulkInvitationsServer.data = [];
	  bulkInvitationsServer.dbTemplates = [];
	  bulkInvitationsServer.templates = [...bulkInvitationsServer.defaultTemplates];
	  navigation.push(bulkInvitationsServer.htmlBase(), function(){
		clearInterval(bulkInvitationsServer.intervalId);
	  });
	  //navigation.push(bulkInvitationsServer.htmlContent());
	  var holder = bulkInvitationsServer.baseHolder();
	  bulkInvitationsServer.initUpdates();
	},
	htmlBase: function() {
	  var html =
		  "<section class='bulk-ops'>" +
		  "<div id='bulk-ops'>"+
		  "<div class='bulk-invs-server-menu'></div>" +
		  "<div class='bulk-template-select'></div>" +
		  "<div class='scEditor'></div>" +
		  "<div class='bulk-invs-server-content'></div>" +
		  "</div>"+
		  "<div class='bulk-ops-progress' style='display:none'>" +
		  "<div class='batch-progress-grid'></div>" +
		  "<div class='footer'>" +
		  "<div class='buttons'>" +
		  "<a class='k-button k-button-action invitation-upload' id='batch-progress-back'>Return</a>" +
		  "</div>" +
		  "</div>"+
		  "</section>";
	  return html;
	},
	htmlUpdates: function() {
	  var html = "<div class='bulk-invs-server'>" +
		  "<div class='options'></div>" +

		  "<div style='margin-bottom: 25px;'>" +
		  "<a class='k-button k-button-big invitation-reset'>Reset</a>" +
		  "<a class='k-button k-button-big invitation-sample'>Download template</a>" +
		  "<a class='k-button k-button-big invitation-report'>Download report</a>" +
		  "</div>" +

		  "<div class='bulk-invs-server-grid'></div>" +
		  "<div style='display:none'><div class='bulk-invs-server-grid_export'></div></div>" +
		  "<div class='footer'>" +
		  "<div class='progress-bar'>" +
		  "<div class='back'>" +
		  "<div class='bar' style='width:0%'></div>" +
		  "<div class='value'>0% (0/0)</div>" +
		  "</div>" +
		  "</div>" +
		  "<div class='buttons'>" +
		  "<input type='file' name='batch-upload' class='batch-upload' />" +
		  "<div class='batch-switch batch-switch-invites'><div>Send invitations</div><label class='switch'><input type='checkbox' class='batch-switch-invites'><span class='slider'></span></label></div>"+
		  "<div class='batch-switch batch-switch-create'><div>Create New Records</div><label class='switch'><input type='checkbox' class='batch-switch-create'><span class='slider'></span></label></div>"+
		  "<a class='k-button k-button-action invitation-validate-only'>Validate only</a>" +
		  "<a class='k-button k-button-action invitation-update-profiles'>Process data</a>" +
		  "</div>" +

		  "</div>" +
		  "</div>";

	  return html;
	},
	initUpdates: function() {
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  const f = function() {
		bulkInvitationsServer.currTemplate = bulkInvitationsServer.templates[0].name;
		var holder = bulkInvitationsServer.contentHolder();
		holder.innerHTML = bulkInvitationsServer.htmlUpdates();
		bulkInvitationsServer.batchId = '';
		bulkInvitationsServer.fileName = '';
		bulkInvitationsServer.file = null;
		bulkInvitationsServer.sendInvites = false;
		bulkInvitationsServer.canCreate = false;
		bulkInvitationsServer.data = [];
		clearInterval(bulkInvitationsServer.intervalId);

		var mainTable = bulkInvitationsServer.templateNode();
		mainTable.style.display = "";

		var node = Array.from(document.querySelectorAll('.batch-progress-grid')).pop();
		node.parentElement.style.display = "none";

		//bulkInvitationsServer.ui.reset();
		bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray = [];

		bulkInvitationsServer.initUploader();
		bulkInvitationsServer.ui.dropDownInit();
		bulkInvitationsServer.reportBuilder.ui();
		bulkInvitationsServer.ui.init(true);
		bulkInvitationsServer.getReportBuilderReportsColumns(bulkInvitationsServer.templates[0].name, function() {
		  mo.fn.overlay.hide();
		  bulkInvitationsServer.reportBuilder.switchType(bulkInvitationsServer.templates[0].name, bulkInvitationsServer.reportBuilderHolder());
		});
	  }
	  if (!bulkInvitationsServer.mappingData.length) {
		bulkInvitationsServer.getColumnMapping(function(){
		  bulkInvitationsServer.readTemplates(f);
		});
	  } else {
		bulkInvitationsServer.readTemplates(f);
	  }
	},
	initUploader: function() {
	  var wrapper = bulkInvitationsServer.node();
	  var upl = wrapper.querySelector(".batch-upload");
	  $(upl).kendoUpload({
		async: {
		  saveUrl: globalReferences.server+'form/1631/attachments/0/File/handler',
		  saveField: "File",
		  autoUpload: false
		},
		multiple: false,
		validation: {
		  allowedExtensions: [".xlsx"]
		},
		select: function(e) {
		  var files = e.files;
		  if (files.length > 0) {
			mo.fn.overlay.show({
			  close: false,
			  loading: true
			})
			bulkInvitationsServer.file = files[0];
			bulkInvitationsServer.parseExcel(files[0], function(excelData) {
			  if (typeof excelData == "string") {
				mo.fn.modal.show({
				  ctaLabel: "OK",
				  class: "ark-modal",
				  title: "Error",
				  content: excelData
				});
				mo.fn.overlay.hide();
				return;
			  }
			  var grid = $(bulkInvitationsServer.holder().querySelector(".bulk-invs-server-grid")).data("kendoGrid");
			  var columns = grid.columns;

			  excelData.forEach(x => {
				columns.forEach(column => {
				  if (x[column.title]) {
					x[column.field] = x[column.title];
					if (column.field != column.title)
					  delete x[column.title];
				  } else
					x[column.field] = "";
				});

			  });

			  bulkInvitationsServer.ui.reset();

			  bulkInvitationsServer.data = excelData;
			  grid.dataSource.data(excelData);
			  mo.fn.overlay.hide();

			});
		  }
		}
	  }).data("kendoUpload");
	},
	ui: {
	  init: function(fromTemplate = false) {
		var holder = bulkInvitationsServer.holder();

		bulkInvitationsServer.ui.initHiddenGrid(fromTemplate);
		bulkInvitationsServer.ui.initGrid(fromTemplate);
		//bulkInvitationsServer.ui.initOptions();
		bulkInvitationsServer.ui.reset();

		holder.querySelector(".invitation-sample").addEventListener("click", function() {
		  $(bulkInvitationsServer.holder().querySelector(".bulk-invs-server-grid_export")).data("kendoGrid").saveAsExcel();
		});

		holder.querySelector(".invitation-report").addEventListener("click", function() {
		  $(bulkInvitationsServer.holder().querySelector(".bulk-invs-server-grid")).data("kendoGrid").saveAsExcel();
		});

		holder.querySelector(".invitation-reset").addEventListener("click", function(ev) {
		  mo.fn.overlay.show({
			loading: true,
			close: false
		  });
		  bulkInvitationsServer.ui.reset();
		  bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray = [];
		  if (bulkInvitationsServer.currTemplate) {
			bulkInvitationsServer.initUpdates();
		  } else {
			bulkInvitationsServer.initInvites()
		  }
		  mo.fn.overlay.hide();
		  ev.preventDefault();
		});

		holder.querySelector(".invitation-update-profiles").addEventListener("click", function() {
		  mo.fn.modal.show({
			ctaLabel: "Yes",
			closeLabel: "No",
			class: "ark-modal",
			title: "Send invitations",
			content: "You are about to update <b>" + bulkInvitationsServer.data.length + "</b> rows. Continue?",
			ctaCallback: function() {
			  mo.fn.modal.hide();
			  var data = [...bulkInvitationsServer.data];
			  data.forEach(x => {
				x.Status = "";
				x.Comment = "";
			  });
			  bulkInvitationsServer.processData(
				data,
				false,
				true //bulkInvitations.holder().querySelector("[name=CreateWhenNotFound]").value == "Y"
			  );
			}
		  });
		});

		holder.querySelector(".invitation-validate-only").addEventListener("click", function() {
		  var data = [...bulkInvitationsServer.data];
		  data.forEach(x => {
			x.Status = "";
			x.Comment = "";
		  });
		  bulkInvitationsServer.validateDataStart(data, bulkInvitationsServer.canCreate);
		});

		var toggle = holder.querySelector(".batch-switch-invites");
		toggle.addEventListener('change', function(e) {
		  bulkInvitationsServer.sendInvites = e.target.checked;
		});

		var toggle2 = holder.querySelector(".batch-switch-create");
		toggle2.addEventListener('change', function(e) {
		  bulkInvitationsServer.canCreate = e.target.checked;
		});

	  },
	  dropDownInit: function() {
		var node = bulkInvitationsServer.holderDropdown();
		node.innerHTML = "<div class='template-selector' style='margin-bottom:20px;'></div>";
		var conf = {
		  dom: node,
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Batch template",
				  data: "batchTemplateSelector",
				  type: "select",
				  value: bulkInvitationsServer.templates[0].name,
				  values: bulkInvitationsServer.templates.map(el => el.name),
				  options: bulkInvitationsServer.templates.map(el => el.name)
				}]
			  ]
			}, ],
			callback: function() {
			  node.querySelector('[data-name="batchTemplateSelector"]').addEventListener('change', function(ev) {
				bulkInvitationsServer.changeTemplate(ev.target.value);
			  });
			},
		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);
	  },
	  reset: function() {
		var holder = bulkInvitationsServer.holder();

		$(holder.querySelector(".bulk-invs-server-grid")).data("kendoGrid").dataSource.data([]);

		holder.querySelector(".batch-switch-invites").style.display = "none";
		holder.querySelector(".batch-switch-create").style.display = "none";
		holder.querySelector(".invitation-report").style.display = "none";
		holder.querySelector(".invitation-update-profiles").style.display = "none";
		holder.querySelector(".invitation-validate-only").style.display = "none";
		holder.querySelector(".buttons").style.marginTop = "0px";

		holder.querySelector(".progress-bar .bar").style.width = "0%";
		holder.querySelector(".progress-bar .value").innerHTML = "0%";
		holder.querySelector(".progress-bar").style.display = "none";
	  },
	  initGrid: function(fromTemplate = false) {
		var holder = bulkInvitationsServer.holder();

		var columns = bulkInvitationsServer.ui.getColumns();
		columns.splice(0, 0, {
		  field: "Comment",
		  title: "Comment",
		  hidden: false,
		  width: "250px",
		  locked: !!bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray && !!bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray.length
		});
		columns.splice(0, 0, {
		  field: "Status",
		  title: " ",
		  hidden: false,
		  width: "50px",
		  locked: !!bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray && !!bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray.length,
		  template: function(d) {
			if (d.Status == 1)
			  return '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><polyline fill="none" stroke="green" stroke-width="2" points="2 14 9 20 22 4"></polyline></svg></a>';
			else if (d.Status == -1)
			  return '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="red" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path></svg></a>';

			return "";
		  }
		});
		var node = holder.querySelector(".bulk-invs-server-grid");
		$(node).kendoGrid({
		  height: 1500,
		  noRecords: {
			template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
		  },
		  excel: {
			fileName: "Report.xlsx",
			filterable: true,
			allPages: true
		  },
		  dataSource: [],
		  columns: columns,
		  pageable: {
			buttonCount: 4,
			pageSize: 100,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: false
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: true,
		  resizable: true,
		  dataBound: function(e) {
			if (e.sender.dataSource.total() > 0) {
			  holder.querySelector(".invitation-update-profiles").style.display = "inline-flex";
			  holder.querySelector(".invitation-validate-only").style.display = "inline-flex";
			  holder.querySelector(".batch-switch-invites").style.display = "inline-block";
			  holder.querySelector(".batch-switch-create").style.display = "inline-block";
			  holder.querySelector(".buttons").style = "margin-top:-35px;display:flex;align-items:center;";
			}
		  },
		});

	  },
	  initHiddenGrid: function(fromTemplate = false) {
		var holder = bulkInvitationsServer.holder();

		var node = holder.querySelector(".bulk-invs-server-grid_export");
		$(node).kendoGrid({
		  height: 1,
		  dataSource: [],
		  columns: bulkInvitationsServer.ui.getColumns(),
		  pageable: {
			buttonCount: 4,
			pageSize: 10,
			pageSizes: [10, 25, 50, 100],
			messages: {
			  itemsPerPage: ""
			},
			refresh: false
		  },
		  scrollable: true,
		  sortable: true,
		  filterable: false,
		});
	  },
	  getColumns: function() {
		var columns = [];
		var template = bulkInvitationsServer.templates.find(t => t.name == bulkInvitationsServer.currTemplate);
		template.requiredFields.map(c => {
		  columns.push({...c,
						locked: !!bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray && !!bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray.length
					   });
		});

		(bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray || []).map(el => {
		  columns.push({ ...el,
						'width': "150px",
						'field': el.field.replace('table1363_EntryId', 'ProfileId')
						.replace('table1363_Status', 'ProfileStatus')
						.replace('ProfileStatusReason', 'StatusReason')
						.replace('table1363_', '')
						.replace('table1374_', 'ProfileCF')
						.replace('table1275_EntryId', 'CaseId')
						.replace('table1275_', 'Case')
						.replace('table1375_', 'CaseCF')
					   });
		});
		columns.forEach(column => {
		  column.template = function(d, field = column.field) {
			return d[field] || "-";
		  }
		});
		return columns;
	  },
	  updateProgress: function(cur, total) {
		var holder = bulkInvitationsServer.holder();

		holder.querySelector(".progress-bar").style.display = "block";

		var bar = holder.querySelector(".bar");
		var value = holder.querySelector(".value");

		var percent = parseFloat(cur / total * 100).toFixed(0);

		value.innerHTML = percent + "% (" + cur + "/" + total + ")";
		bar.style.width = percent + "%";
	  }
	},
	templates: [],
	defaultTemplates: [
	  {
		name: "Profiles",
		fields: [],
		requiredFields: [
		  {
			field: "ProfileId",
			title: "Profile. Profile #",
			width: "150px",
			locked: true,	
		  }],
	  },
	  {
		name: "Cases",
		fields: [],
		requiredFields: [
		  {
			field: 'CaseId',
			title: 'Case. Case #',
			width: "150px",
			locked: true,
		  }],
	  },
	  {
		name: "Cases and Profiles",
		fields: [],
		requiredFields: [
		  {
			field: 'CaseId',
			title: 'Case. Case #',
			width: "150px",
			locked: true,
		  }, 
		  {
			field: "ProfileId",
			title: "Profile. Profile #",
			width: "150px",
			locked: true,
		  }
		],
	  },
	],
	getReportBuilderReportsColumns: function(type, cb) {
	  switch (type) {
		case 'Profiles':
		  if (Object.keys(bulkInvitationsServer.reportBuilder.profilesData).length === 0)
			bulkInvitationsServer.reportBuilder.reportProfiles(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'Cases':
		  if (Object.keys(bulkInvitationsServer.reportBuilder.casesData).length === 0)
			bulkInvitationsServer.reportBuilder.reportCases(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'Cases and Profiles':
		  if (Object.keys(bulkInvitationsServer.reportBuilder.casesData).length === 0)
			bulkInvitationsServer.reportBuilder.reportCases(function() {
			  if (Object.keys(bulkInvitationsServer.reportBuilder.profilesData).length === 0)
				bulkInvitationsServer.reportBuilder.reportProfiles(function() {
				  cb();
				});
			  else
				cb();
			});
		  else
			cb();
		  return;
		default:
		  cb();
		  return;
	  }
	},
	reportBuilder: {
	  selectedFields: [],
	  casesSorted: ["Case. Case #", "Case. Created", "Case. Name", "Case. Region", "Case. Country Code", "Case. Intake Form", "Case. Submitted Date", "Case. Pass/Fail", "Case. Stage", "Case. Status", "Case. Close Reason", "Case. Sent To (Name)", "Case. Sent To (Email)", "Case. First Visit Date", "Case. Last Visit Date", "Case. Created By", "Case. Company #", "Case. Securimate #", "Case. Completed Date", "Case. Requestor", "Case. Related Cases", "Case Assigned Date", "Case Accepted", "Case Due Date", "Case Closed", "Case Invoice", "Case Description", "Case Department", "Case (CF). App ID", "Case (CF). BU EDD Decision", "Case (CF). Business Caution Factors", "Case (CF). Category Status", "Case (CF). CFI Analyst", "Case (CF). Contract Inactivation Date", "Case (CF). Contract Inactivation Reason", "Case (CF). Contract Requestor Email", "Case (CF). Contract Termination Date", "Case (CF). Contract Termination Reason", "Case (CF). CPI", "Case (CF). CPI Do Not Update", "Case (CF). Date Assigned To Agility", "Case (CF). Date Batch Created", "Case (CF). Date EDD Decision Released", "Case (CF). Date Scorecard Received", "Case (CF). DDI Agility Comments Additional Request", "Case (CF). DDI Agility Reason For Override", "Case (CF). DDI Agility Release Date", "Case (CF). DDI Agility Result Override", "Case (CF). DDI Agility Special Handling Instructions", "Case (CF). DDI Analyst", "Case (CF). DDI Batch Number", "Case (CF). DDI Completed Date", "Case (CF). DDI Date Assigned To Agility", "Case (CF). DDI Final Result", "Case (CF). DDI No Info Responses", "Case (CF). DDI No Responses", "Case (CF). DDI Reason For Override", "Case (CF). DDI Region Lead Active Review", "Case (CF). DDI Region Lead Review Result Date", "Case (CF). DDI Result Override", "Case (CF). DDI Result Sent To Contracts Team", "Case (CF). DDI Scoring Analyst", "Case (CF). DDI Scoring Completed Date", "Case (CF). DDI SQ Comments", "Case (CF). DDI SQ Result", "Case (CF). DDI Start Date", "Case (CF). DDI Update Sent To Contracts Team", "Case (CF). DDI Yes Responses", "Case (CF). DDQ Reminder Date", "Case (CF). Reactivation Reminder Date", "Case (CF). Update Reactivation Result to Contracts Team", "Case (CF). DDQ Reactivation Result", "Case (CF). BU EDD Decision Date", "Case (CF). DDQ Request Receive Date", "Case (CF). DDQ Result", "Case (CF). DDQ Score", "Case (CF). DDQ Score Do Not Update", "Case (CF). EDD Case Numbers", "Case (CF). EDD Decision Released", "Case (CF). EDD Result Receive Date", "Case (CF). EDD Scorecard Results", "Case (CF). EDD Scorecard Results Revised", "Case (CF). EDD Trigger Date", "Case (CF). Extended DDQ Days", "Case (CF). Extension Reason", "Case (CF). Final EDD Result", "Case (CF). GT Question Do Not Update", "Case (CF). Holidays", "Case (CF). IDD Agility Business Caution Instructions", "Case (CF). IDD Agility EDD Reasons", "Case (CF). IDD Agility Recommendation", "Case (CF). IDD Agility Release Date", "Case (CF). IDD Agility Special Handling Instructions", "Case (CF). IDD Agility Supplemental Questionnaire Instructions", "Case (CF). IDD Analyst", "Case (CF). IDD Completed Date", "Case (CF). IDD Date Assigned To Agility", "Case (CF). IDD Reason Override", "Case (CF). IDD Result Override", "Case (CF). IDD Result Sent To Contracts Team", "Case (CF). IDD Start Date", "Case (CF). IDD Update Sent To Contract Team", "Case (CF). IFQ Do Not Update", "Case (CF). Marketing Vendor Low Risk Q5 Q6", "Case (CF). No Info Responses", "Case (CF). No Responses", "Case (CF). On Boarding Program", "Case (CF). On Going Special Handling", "Case (CF). OSI Case Number", "Case (CF). OSI Final Result", "Case (CF). OSI Reason For Override", "Case (CF). OSI Result", "Case (CF). OSI Result Override", "Case (CF). OSI Result Receive Date", "Case (CF). OSI SQ Comments", "Case (CF). OSI SQ Result", "Case (CF). OSI Trigger Date", "Case (CF). OSI Batch Number", "Case (CF). Other Instructions", "Case (CF). Other Notable Factors", "Case (CF). Partner Location ID", "Case (CF). Party ID", "Case (CF). Post OSI Result Override", "Case (CF). Post Osi Supplementary Research", "Case (CF). Pre Screened", "Case (CF). Raw FK", "Case (CF). Red Flag Questions", "Case (CF). Red Flag Questions Do Not Update", "Case (CF). Red Line DDQ", "Case (CF). Remarks", "Case (CF). OSI Date Assigned to Agility", "Case (CF). OSI Agility Release Date", "Case (CF). Reactivation Request Trigger Date", "Case (CF). DDQ Reactivation Trigger Date", "Case (CF). Osi Agility Special Handling Instruction", "Case (CF). Requesting Business Unit", "Case (CF). SH BC Final Result", "Case (CF). SH BC Result Receive Date", "Case (CF). Siebel PRMID Or Supplier Vendor ID", "Case (CF). Simplified Code 06 Case", "Case (CF). Special Handling Instructions", "Case (CF). Sub Region", "Case (CF). Update DDQ Result To Contracts Team",
					"Case (CF). Update EDD Result To Contracts Team", "Case (CF). Update OSI Result To Contracts Team", "Case (CF). Yes Responses", "Case (CF). Special Consideration"
				   ],
	  profilesSorted: ["Profile. Profile #", "Profile. Securimate #", "Profile. Company Name", "Profile. English Company Name", "Profile. Siebel ID", "Profile. Party Id", "Profile. Approval Status", "Profile. Approval Status Reason", "Profile. Approval Status Comment", "Profile. Is Active", "Profile. Region", "Profile. Country", "Profile. Created", "Profile. Category", "Profile. Intake Form", "Profile. Tax Id", "Profile. Address 1", "Profile. Address 2", "Profile. State", "Profile. City", "Profile. Telephone", "Profile. Company Telephone", "Profile. Alt Telephone", "Profile. Post Code", "Profile. FAX", "Profile. POC Name", "Profile. POC Email Address", "Profile. POC Position", "Profile. Created By", "Profile. Modified", "Profile. Modified By", "Profile. Internal Owner", "Profile. Cases", "Profile. Cases Securimate", "Risk Rank", "Risk Score", "Profile. Language", "Profile. Legal Form Of Company", "Profile. Mobile", "Profile. Number Of Years In Primary Business", "Profile. Profile Global Status", "Profile. Publicy Traded Company", "Profile. Registration Number", "Profile. Stock Exchange", "Profile. Ticker Symbol", "Profile. Trading Company Name", "Profile. Website", "Profile. Country Of Registration", "Profile (CF). Branch Or Subsidiary Exemption", "Profile (CF). Branch Subsidiary", "Profile (CF). Category Status", "Profile (CF). GDC Agility EDD Reasons", "Profile (CF). GDC Agility Recommendation", "Profile (CF). GDC Agility Release Date", "Profile (CF). GDC Agility Special Handling Instructions", "Profile (CF). GDC Agility Supplemental Questionnaire Instructions", "Profile (CF). GDC Date Assigned To Agility", "Profile (CF). GDC Final Risk Mitigation Outcome", "Profile (CF). GDC Override Reason", "Profile (CF). GDC Red Flags", "Profile (CF). GDC Research Analyst", "Profile (CF). GDC Research Completed Date", "Profile (CF). GDC Research Start Date", "Profile (CF). GDC Result Override", "Profile (CF). GDC Risk Mitigation Owner", "Profile (CF). Global Exemption", "Profile (CF). Headquarter Location Or Parent Company", "Profile (CF). Highest Risk Country CPI", "Profile (CF). Highest Risk Country Name", "Profile (CF). Internal HPE Contact Email Address", "Profile (CF). Internal HPE Contact Name", "Profile (CF). Parent Company Name", "Profile (CF). Preferred Language Code", "Profile (CF). Partner Location Id", "Profile (CF). Party Id", "Profile (CF). Related OEM 3P Profile Number", "Profile (CF). Related Reseller 3P Profile Number", "Profile (CF). Related Supplier 3P Profile Number", "Profile (CF). Special Partner Type", "Profile (CF). Special Partner Type Siebel Id", "Profile (CF). Tax Id"],
	  profilesData: {},
	  casesData: {},
	  reportProfiles: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Batch_Profiles/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1,
		  serverFiltering: true,
		  serverSorting: true,
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent' && el !== 'uid') {
			  if (bulkInvitationsServer.mappingData[el] && bulkInvitationsServer.mappingData[el].Title) {
				bulkInvitationsServer.reportBuilder.profilesData[el] = bulkInvitationsServer.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});
	  },
	  reportCases: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Batch_Cases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1,
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent' && el !== 'uid') {
			  if (bulkInvitationsServer.mappingData[el] && bulkInvitationsServer.mappingData[el].Title) {
				bulkInvitationsServer.reportBuilder.casesData[el] = bulkInvitationsServer.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});
	  },
	  ui: function() {
		var editor = bulkInvitationsServer.reportBuilderHolder();
		bulkInvitationsServer.reportBuilder.scEditor.init(editor);
	  },
	  refresh: function(templateId) {
		bulkInvitationsServer.reportBuilder.ui();
	  },
	  getColumnInfo: function(columnName) {
		var columnInfo = bulkInvitationsServer.mappingData[columnName];
		return columnInfo;
	  },
	  sortFields: function(arr) {
		var arry = Object.entries(arr);
		var arr_first = [];
		var arr_sec = [];
		var arr_third = [];
		switch (bulkInvitationsServer.currTemplate) {
		  case "Profiles":
			bulkInvitationsServer.reportBuilder.profilesSorted.forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  case "Cases":
			bulkInvitationsServer.reportBuilder.casesSorted.forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  case "Cases and Profiles":
			[...bulkInvitationsServer.reportBuilder.casesSorted, ...bulkInvitationsServer.reportBuilder.profilesSorted].forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  default:
			arr_first = [...arry];
		}
		return [...arr_first, ...arr_sec, ...arr_third];

	  },
	  switchType: function(data, node) {
		switch (data) {
		  case 'Profiles':
			bulkInvitationsServer.reportBuilder.initAvailableFields(node, bulkInvitationsServer.reportBuilder.profilesData);
			break;
		  case 'Cases':
			bulkInvitationsServer.reportBuilder.initAvailableFields(node, bulkInvitationsServer.reportBuilder.casesData);
			break;
		  case 'Cases and Profiles':
			bulkInvitationsServer.reportBuilder.initAvailableFields(node, { ...bulkInvitationsServer.reportBuilder.casesData,
																		   ...bulkInvitationsServer.reportBuilder.profilesData
																		  });
			break;
		  default:
			bulkInvitationsServer.reportBuilder.initAvailableFields(node, null);
			break;
		}
	  },
	  initAvailableFields: function(node, data) {
		bulkInvitationsServer.reportBuilder.scEditor.init(node, data, function(dt) {
		  bulkInvitationsServer.reportBuilder.selectedFields = Object.assign({}, dt);
		});
	  },
	  scEditor: {
		availableFields: {},
		selectedFields: {},
		activeAvailable: {},
		activeSelected: {},
		leftPanel: '',
		rightPanel: '',
		reset: function() {
		  bulkInvitationsServer.reportBuilder.scEditor.availableFields = {};
		  bulkInvitationsServer.reportBuilder.scEditor.selectedFields = {};
		  bulkInvitationsServer.reportBuilder.scEditor.activeAvailable = {};
		  bulkInvitationsServer.reportBuilder.scEditor.activeSelected = {};
		},
		init: function(node, data, callback) {
		  bulkInvitationsServer.reportBuilder.scEditor.reset();
		  node.innerHTML = bulkInvitationsServer.reportBuilder.scEditor.template();
		  if (!!data && data !== {}) {
			bulkInvitationsServer.reportBuilder.scEditor.availableFields = Object.assign({}, data); //Object.keys(data).map(el => el.split('_')[1]);
			node.style = "";
		  }
		  else {
			bulkInvitationsServer.reportBuilder.scEditor.availableFields = {};
			node.style.visibility = "hidden";
			node.style.height = "0px";
		  }


		  bulkInvitationsServer.reportBuilder.scEditor.leftPanel = node.querySelector('.scEditor__left__panel select');
		  bulkInvitationsServer.reportBuilder.scEditor.rightPanel = node.querySelector('.scEditor__right__panel select');

		  node.querySelector('.scEditor__leftArr').addEventListener('click', function(ev) {
			bulkInvitationsServer.reportBuilder.scEditor.arrowLeft(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__rightArr').addEventListener('click', function() {
			bulkInvitationsServer.reportBuilder.scEditor.arrowRight(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__upArr').addEventListener('click', function(ev) {
			bulkInvitationsServer.reportBuilder.scEditor.arrowUp(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__downArr').addEventListener('click', function() {
			bulkInvitationsServer.reportBuilder.scEditor.arrowDown(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.available_fields-filter').addEventListener('input', function(e) {
			bulkInvitationsServer.reportBuilder.scEditor.onFilter(e.target.value);
		  });

		  bulkInvitationsServer.reportBuilder.scEditor.addOptions();

		},
		template: function(node) {
		  return '<section class="scEditor__wrapper">' +
			'<div class="scEditor__left">' +
			'<h4>Available fields</h4>' +
			'<div class="header"><input placeholder="Quick filter" class="available_fields-filter"> </div>' +
			'<div class="scEditor__left__panel">' +
			'<select multiple="true"></select>' +
			'</div>' +
			'</div>' +
			'<div class="scEditor__arrows">' +
			'<svg class="scEditor__rightArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret next" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="6 2 18 12 6 22"></polygon></svg>' +
			'<svg class="scEditor__leftArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret previous" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="6 2 18 12 6 22" transform="matrix(-1 0 0 1 24 0)"></polygon></svg>' +
			'</div>' +
			'<div class="scEditor__right">' +
			'<h4>Fields in report</h4>' +
			'<div class="header"></div>' +
			'<div class="scEditor__right__panel">' +
			'<select multiple="true"></select>' +
			'</div>' +
			'</div>' +
			'<div class="scEditor__arrows" style="margin-left: 10px;">' +
			'<svg class="scEditor__upArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret up" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 4 12 16 2 4" transform="matrix(1 0 0 -1 0 20)"></polygon></svg>' +
			'<svg class="scEditor__downArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret down" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 8 12 20 2 8"></polygon></svg>' +
			'</div>' +
			'</section>';
		},
		arrowLeft: function(node, callback) {

		  var toDelete = [];
		  var length = bulkInvitationsServer.reportBuilder.scEditor.rightPanel.selectedOptions.length;
		  for (var i = 0; i < length; i++) {
			var x = bulkInvitationsServer.reportBuilder.scEditor.rightPanel.selectedOptions[i];
			var opt = document.createElement('option');
			opt.value = x.value;
			opt.innerHTML = x.innerHTML;
			bulkInvitationsServer.reportBuilder.scEditor.leftPanel.appendChild(opt);

			toDelete.push(x);
		  }
		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < bulkInvitationsServer.reportBuilder.scEditor.rightPanel.options.length; j++) {
			  if (!bulkInvitationsServer.reportBuilder.scEditor.rightPanel.options[j])
				debugger;
			  if (bulkInvitationsServer.reportBuilder.scEditor.rightPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			bulkInvitationsServer.reportBuilder.scEditor.rightPanel.remove(idx);
		  });

		  bulkInvitationsServer.reportBuilder.scEditor.updateSelectedArray();

		  if (callback && typeof callback == 'function') callback(bulkInvitationsServer.reportBuilder.scEditor.selectedFields);
		},
		arrowRight: function(node, callback) {

		  var toDelete = [];
		  var lenght = bulkInvitationsServer.reportBuilder.scEditor.leftPanel.selectedOptions.length;
		  for (var i = 0; i < lenght; i++) {
			var x = bulkInvitationsServer.reportBuilder.scEditor.leftPanel.selectedOptions[i];

			var opt = document.createElement('option');
			opt.value = x.value;
			opt.innerHTML = x.innerHTML;
			bulkInvitationsServer.reportBuilder.scEditor.rightPanel.appendChild(opt);

			toDelete.push(x);
		  }

		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < bulkInvitationsServer.reportBuilder.scEditor.leftPanel.options.length; j++) {
			  if (bulkInvitationsServer.reportBuilder.scEditor.leftPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			bulkInvitationsServer.reportBuilder.scEditor.leftPanel.remove(idx);
		  });

		  bulkInvitationsServer.reportBuilder.scEditor.updateSelectedArray();

		  if (callback && typeof callback == 'function') callback(bulkInvitationsServer.reportBuilder.scEditor.selectedFields);

		},
		arrowUp: function() {
		  var select = bulkInvitationsServer.reportBuilder.scEditor.rightPanel;
		  var length = select.selectedOptions.length;
		  if (length == 0)
			return;

		  for (var i = 0; i < length; i++) {
			var x = select.selectedOptions[i];

			for (var j = 0; j < select.options.length; j++) {
			  if (select.options[j].value == x.value) {
				var idx = j;
				if (j - 1 >= 0)
				  select.insertBefore(select.options[j], select.options[j - 1])
				break;
			  }
			}

		  }

		  bulkInvitationsServer.reportBuilder.scEditor.updateSelectedArray();

		},
		arrowDown: function() {
		  var select = bulkInvitationsServer.reportBuilder.scEditor.rightPanel;
		  var length = select.selectedOptions.length;
		  if (length == 0)
			return;

		  for (var i = 0; i < length; i++) {
			var x = select.selectedOptions[i];

			for (var j = 0; j < select.options.length; j++) {
			  if (select.options[j].value == x.value) {
				var idx = j;
				if (j + 2 == select.options.length)
				  select.appendChild(select.options[j]);
				//if(j + 1 < select.options.length)
				else select.insertBefore(select.options[j], select.options[j + 2])
				break;
			  }
			}

		  }

		  bulkInvitationsServer.reportBuilder.scEditor.updateSelectedArray();
		},
		onFilter: function(text) {
		  var options = bulkInvitationsServer.reportBuilder.scEditor.leftPanel.options;
		  for (var i = 0; i < options.length; i++) {
			if (!text)
			  options[i].removeAttribute("hidden");
			else {
			  if (options[i].innerHTML.toLowerCase().includes(text.toLowerCase()))
				options[i].removeAttribute("hidden");
			  else options[i].hidden = "hidden";
			}
		  }
		},
		updateSelectedArray: function() {
		  var opts = bulkInvitationsServer.reportBuilder.scEditor.rightPanel.options;

		  bulkInvitationsServer.reportBuilder.scEditor.selectedFields = {};
		  bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray = [];

		  for (var i = 0; i < opts.length; i++) {
			bulkInvitationsServer.reportBuilder.scEditor.selectedFields[opts[i].value] = opts[i].innerHTML;
			bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray.push({
			  field: opts[i].value,
			  title: opts[i].innerHTML
			});
		  }
		  var holder = bulkInvitationsServer.contentHolder();
		  holder.innerHTML = bulkInvitationsServer.htmlUpdates();
		  bulkInvitationsServer.initUploader();
		  bulkInvitationsServer.ui.init(true);
		},
		addOptions: function(node) {
		  var obj = Object.assign({}, bulkInvitationsServer.reportBuilder.scEditor.availableFields);
		  var keysSorted = bulkInvitationsServer.reportBuilder.sortFields(obj); //Object.keys(obj).sort(function(a,b){return ((obj[a] > obj[b]) ? 1 : ((obj[b] > obj[a]) ? -1 : 0))});

		  keysSorted.forEach(x => {
			var opt = document.createElement('option');
			opt.value = x[0];
			opt.innerHTML = x[1];
			bulkInvitationsServer.reportBuilder.scEditor.leftPanel.appendChild(opt);
		  });
		},
		autoFill: function(data, node, callback) {
		  bulkInvitationsServer.reportBuilder.scEditor.activeAvailable = JSON.parse(data.Fields);

		  var keys = Object.keys(bulkInvitationsServer.reportBuilder.scEditor.activeAvailable);
		  var options = bulkInvitationsServer.reportBuilder.scEditor.leftPanel.options;
		  var toDelete = [];
		  keys.forEach(key => {
			for (var i = 0; i < options.length; i++)
			  if (options[i].value == key) {
				toDelete.push(options[i]);
				break;
			  }

			var opt = document.createElement('option');
			opt.value = key;
			opt.innerHTML = bulkInvitationsServer.reportBuilder.scEditor.activeAvailable[key];
			bulkInvitationsServer.reportBuilder.scEditor.rightPanel.appendChild(opt);
		  });

		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < bulkInvitationsServer.reportBuilder.scEditor.leftPanel.options.length; j++) {
			  if (bulkInvitationsServer.reportBuilder.scEditor.leftPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			bulkInvitationsServer.reportBuilder.scEditor.leftPanel.remove(idx);
		  });

		  bulkInvitationsServer.reportBuilder.scEditor.updateSelectedArray();


		  if (callback && typeof callback == 'function') callback();

		}
	  },
	},
	mappingData: [],
	columnAliases: [],
	getColumnMapping: function(cb) {
	  var mappingDS = bulkInvitationsServer.getMappingValuesDS();

	  mappingDS.read().then(function() {
		//debugger;
		bulkInvitationsServer.columnAliases = [];
		mappingDS.view().forEach(function(el) {
		  bulkInvitationsServer.columnAliases.push(el);
		  bulkInvitationsServer.mappingData['table' + el.FormId + '_' + el.ColumnName] = el;
		});
		cb();
	  });
	},
	getMappingValuesDS: function() {
	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Name_Mapping/kendo/data/search",
			type: 'POST'
		  },
		},

		serverPaging: true,
		serverFiltering: true,
		serverSorting: true,
	  });
	},
	currTemplate: '',
	changeTemplate: function(val) {
	  bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray = [];
	  bulkInvitationsServer.currTemplate = val;
	  var holder = bulkInvitationsServer.contentHolder();
	  holder.innerHTML = bulkInvitationsServer.htmlUpdates();
	  bulkInvitationsServer.initUploader();
	  bulkInvitationsServer.ui.init(true);
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  bulkInvitationsServer.getReportBuilderReportsColumns(val, function() {
		var template = bulkInvitationsServer.templates.find(t => t.name == bulkInvitationsServer.currTemplate);
		var holder = bulkInvitationsServer.holder();
		var toggleCreate = holder.querySelector("input.batch-switch-invites");
		var toggleInvite = holder.querySelector("input.batch-switch-create");
		if(!!template && template.autoCreate != null) {
		  toggleCreate.disabled = true;
		  toggleCreate.checked = !!template.autoCreate;
		  bulkInvitationsServer.canCreate = !!template.autoCreate;
		}
		else {
		  toggleCreate.disabled = false;
		  toggleCreate.checked = false;
		  bulkInvitationsServer.canCreate = false;
		}
		if(!!template && template.autoInvite != null) {
		  toggleInvite.disabled = true;
		  toggleInvite.checked = !!template.autoInvite;
		  bulkInvitationsServer.sendInvites = !!template.autoInvite;
		}
		else {
		  toggleInvite.disabled = false;
		  toggleInvite.checked = false;
		  bulkInvitationsServer.sendInvites = false;
		}
		bulkInvitationsServer.reportBuilder.switchType(val, bulkInvitationsServer.reportBuilderHolder());
		mo.fn.overlay.hide();
	  });
	},
	parseExcel: function(file, callback) {

	  var reader = new FileReader();
	  bulkInvitationsServer.fileName = file.name;
	  reader.onload = function(e) {
		var data = e.target.result;
		var workbook = XLSX.read(data, {
		  type: 'binary'
		});
		workbook.SheetNames.forEach(function(sheetName) {
		  var excelData = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		  callback(excelData);
		})
	  };

	  reader.onerror = function(ex) {
		callback(ex);
	  };

	  reader.readAsBinaryString(file.rawFile);

	},
	processData: function(data) {
	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });
	  var obj = {
		BatchId: `${access.user.Email};${bulkInvitationsServer.fileName};${new Date().toISOString().replace(/[T,Z]/g, ' ').replace(/\.\d{3}/,'')}`,
		CanCreate: bulkInvitationsServer.canCreate ? 1 : 0,
		CurrentRow: 1,
		Email: access.user.Email,
		File: bulkInvitationsServer.fileName,
		SendInvite: bulkInvitationsServer.sendInvites ? 1 : 0,
		TotalRows: bulkInvitationsServer.data.length,
		UniqueId: bulkInvitationsServer.generateUid(),
	  };
	  crud.create("4894", obj, function(d) {
		if(d.EntryId) {
		  var wrapper = bulkInvitationsServer.node();
		  var upl = wrapper.querySelector(".batch-upload");
		  var upload = $(upl).data("kendoUpload");
		  upload.options.async.saveUrl = globalReferences.server+'form/1631/attachments/'+d.EntryId+'/File/handler';
		  upload.bind("error",function(e){
			if (e.operation == "upload") {
			  mo.fn.modal.show({
				ctaLabel: "OK",
				class: "ark-modal",
				title: "Error",
				content: "<p>Failed to upload file</p>"
			  });
			}
			mo.fn.overlay.hide();
		  });
		  upload.bind("success",function(e){
			var xhr = new XMLHttpRequest();
			xhr.withCredentials = true;
			xhr.addEventListener("readystatechange", function() {
			  if (this.readyState === 4) {
				bulkInvitationsServer.renderProgressSection(d.EntryId);
				mo.fn.overlay.hide();
			  }
			});
			xhr.open("GET", globalReferences.server + "resources/rs/custom/php/ark/batch.php?eid=" + d.EntryId);
			xhr.send();
		  });
		  upload.upload();
		}
		else {
		  mo.fn.overlay.hide();
		  mo.fn.modal.show({
			ctaLabel: "OK",
			class: "ark-modal",
			title: "Error",
			content: "<p>An error occured on create</p>"
		  });
		}
	  });
	},
	generateUid: function() {
	  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		var r = Math.random() * 16 | 0,
			v = c == 'x' ? r : (r & 0x3 | 0x8);
		return v.toString(16);
	  });
	},
	renderProgressSection: function(batchFk) {
	  var mainTable = bulkInvitationsServer.templateNode();
	  mainTable.style.display = "none";

	  var node = Array.from(document.querySelectorAll(".batch-progress-grid")).pop();
	  node.parentElement.style = "";
	  node.innerHTML = "";
	  $(node).kendoGrid({
		height: 500,
		dataSource: new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1475/BatchOperationsReports/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  fields: {}
			},
			parse: function(response) {  
			  var parsedresponse = [];
			  response.Data.map(row => {
				var itm = {
				  BatchStatus: (row.ValidationStatus != null ? row.ValidationStatus : 1) * (row.ProcessingStatus != null ? row.ProcessingStatus : 1),
				  BatchComment: (row.ValidationComment || "") + ' ' + (row.ProcessingComment || ""),
				  ...JSON.parse(row.ProcessedRowData)
				};
				parsedresponse.push(itm);
			  });
			  return parsedresponse;
			},
		  },
		  serverPaging: true,
		  pageSize: 100,
		  serverFiltering: true,
		  filter: [{
			field: "BatchFK",
			operator: "eq",
			value: batchFk
		  }],
		  serverSorting: false,
		  sort: {
			field: "EntryId",
			dir: "desc"
		  }
		}),
		pageable: {
		  buttonCount: 4,
		  pageSize: 100,
		  pageSizes: [100, 25, 50, 100],
		  refresh: true
		},
		noRecords: {
		  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
		},
		scrollable: true,
		sortable: false,
		filterable: false,
		groupable: false,
		resizable: true,
		dataBound: function(e) { 
		  var columns = e.sender.columns;
		  var columnIndex = this.wrapper.find(".k-grid-header [data-field=" + "BatchStatus" + "]").index();

		  e.sender.element.find(".k-header").css('width', 150);
		  var rows = e.sender.tbody.children();
		  for (var j = 0; j < rows.length; j++) {
			var row = $(rows[j]);
			var cells = row.children();
			for (var i = 0; i < cells.length; i++) {  
			  var cell = $(cells[i]);
			  cell.css('width', 150);  
			}

			var dataItem = e.sender.dataItem(row);
			var status = dataItem.get("BatchStatus");
			var template = "";
			if (status == 1)
			  template = '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><polyline fill="none" stroke="green" stroke-width="2" points="2 14 9 20 22 4"></polyline></svg></a>';
			else
			  template = '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="red" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path></svg></a>';

			var cell = row.children().eq(columnIndex);
			cell.html(template);
		  }
		  var head = e.sender.thead.children();
		  var hrow = $(head[0]);
		  var cells = hrow.children();
		  for (var i = 0; i < cells.length; i++) {  
			var cell = $(cells[i]);
			var old = cell.html();
			var column = bulkInvitationsServer.columnAliases.find(el => el.ColumnName == old);
			if(!!column) {
			  cell.html(column.Title);
			}
			else {
			  cell.html(old.replace("CaseId", "Case. Case #").replace("ProfileId","Profile. Profile #"));
			}
		  }
		}
	  }).data("kendoGrid");
	  var holder = bulkInvitationsServer.progressNode();
	  var button = holder.querySelector("#batch-progress-back");
	  button.addEventListener('click',function(e){
		mo.fn.overlay.show({
		  loading: true,
		  close: false
		});
		bulkInvitationsServer.batchId = '';
		bulkInvitationsServer.fileName = '';
		bulkInvitationsServer.file = null;
		bulkInvitationsServer.sendInvites = false;
		bulkInvitationsServer.canCreate = false;
		bulkInvitationsServer.data = [];
		clearInterval(bulkInvitationsServer.intervalId);
		mainTable.style.display = "";

		node.parentElement.style.display = "none";

		bulkInvitationsServer.ui.reset();
		bulkInvitationsServer.reportBuilder.scEditor.selectedFieldsArray = [];
		bulkInvitationsServer.initUpdates();
		mo.fn.overlay.hide();
		e.preventDefault();
	  });
	  var intervalId = setInterval(function () {
		$(node).data('kendoGrid').dataSource.read();
		$(node).data('kendoGrid').refresh();
	  }, 5000);

	  bulkInvitationsServer.intervalId = intervalId;
	},
	// validate on frontend
	validateDataStart: function(data, createNewProfile) {


	  bulkInvitationsServer.holder().querySelector(".invitation-report").style.pointerEvents = "none";
	  bulkInvitationsServer.holder().querySelector(".invitation-reset").style.pointerEvents = "none";
	  bulkInvitationsServer.holder().querySelector(".invitation-sample").style.pointerEvents = "none";
	  bulkInvitationsServer.holder().querySelector(".batch-switch-invites").style.pointerEvents = "none";
	  bulkInvitationsServer.holder().querySelector(".batch-switch-create").style.pointerEvents = "none";
	  bulkInvitationsServer.holder().querySelector(".invitation-update-profiles").style.pointerEvents = "none";

	  bulkInvitationsServer.validateData(0, 10, data, createNewProfile);

	},
	validateData: function(page, pageSize, data, createNewProfile) {
	  console.log(`recursive batch ops: page ${page} started`);
	  const currData = data.slice(pageSize * page, pageSize * (page + 1));
	  if (currData && currData.length) {
		var total = currData.length;
		var cur = 0;
		var idx = (pageSize * page) + cur;
		const cb = function(row, currIdx) {
		  data[(pageSize * page) + currIdx] = row;
		  cur++;
		  if (cur == total) {
			setTimeout(function() {
			  var grid = $(bulkInvitationsServer.holder().querySelector(".bulk-invs-server-grid")).data("kendoGrid");
			  grid.dataSource.data(data);
			  grid.refresh();
			  bulkInvitationsServer.validateData(page + 1, pageSize, data, createNewProfile);
			}, 500);
		  }
		};
		currData.forEach((x, currIdx) => {
		  idx = (pageSize * page) + cur;
		  bulkInvitationsServer.ui.updateProgress(idx, data.length);
		  bulkInvitationsServer.proccessCaseRow(x, function(resp) {
			bulkInvitationsServer.proccessCaseCFRow(resp, function(cfResp) {
			  bulkInvitationsServer.proccessProfileRow(cfResp, createNewProfile, function(r) {
				bulkInvitationsServer.proccessProfileCFRow(r, function(pcfResp) {
				  cb(pcfResp, currIdx);
				});
			  });
			});
		  });
		});
	  } else {
		bulkInvitationsServer.ui.updateProgress(data.length, data.length);
		console.log('recursive batch ops finished');
		bulkInvitationsServer.holder().querySelector(".invitation-report").style.pointerEvents = "all";
		bulkInvitationsServer.holder().querySelector(".invitation-reset").style.pointerEvents = "all";
		bulkInvitationsServer.holder().querySelector(".invitation-sample").style.pointerEvents = "all";
		bulkInvitationsServer.holder().querySelector(".batch-switch-invites").style.pointerEvents = "all";
		bulkInvitationsServer.holder().querySelector(".batch-switch-create").style.pointerEvents = "all";
		bulkInvitationsServer.holder().querySelector(".invitation-update-profiles").style.pointerEvents = "all";
		return;
	  }
	},
	validateProfileData: function(row, canCreate) {
	  var error = "";

	  var required = "";
	  var invalid = "";

	  var isNew = canCreate && !row.ProfileId;
	  if (!canCreate && !row.ProfileId) {
		required += "ProfileId/";
	  }

	  if (isNew && !row.CompanyName) {
		required += "Company Name/";
	  }

	  if (row.Region) {
		if (row.Region != "NA" && row.Region != "EMEA" && row.Region != "AMS" && row.Region != "APJ")
		  invalid += "Region/";
	  } else if (isNew) required += "Region/";

	  if (row.Country) {
		var country = reference.countries.rawData.find(x => x.Name == row.Country || x.ISO2 == row.Country);
		if (country) {
		  row.Country = country.ISO2;
		  row.Language = row.Language || country.PreferredLang || "en_US";
		} else invalid += "Country/";
	  } else if (isNew) {
		required += "Country/";
	  }
	  if (row.Language) {
		const lang = reference.languages.data.find(el => el.value.toLowerCase() == row.Language.toLowerCase() || !!el.aliases.find(a => a.toLowerCase() == row.Language.toLowerCase()));
		if (!lang) {
		  invalid += "Language/";
		} else {
		  row.Language = lang.value;
		}
	  }

	  if (row.IntakeForm) {
		var config = reference.configs.data.find(x => x.ConfigName == row.IntakeForm || x.ConfigId == row.IntakeForm);
		if (config) {
		  row.IntakeForm = config.ConfigId;
		  row.ConfigFK = config.EntryId;
		  if(row.Category) {
			var category = reference.category.find(cat => !!cat.configs.find(x => x == config.ConfigId) && cat.value == row.Category);
			if(!category) {
			  invalid += "Category/";
			}
		  }
		  else {
			if(config.ConfigId === "reseller_prospective" || config.ConfigId === "proximity_prospective") {
			  row.Category = "Reseller-Prospective";

			}
			else {
			  var category = reference.category.find(x => x.configs.find(x => x == config.ConfigId));
			  if (category) {
				row.Category = category.value;
			  }
			  else {
				invalid += "Category/";
			  }
			}
		  }
		} 
		else {
		  invalid += "Intake Form/";
		}
	  } 
	  else if (isNew) {
		required += "Intake Form/";
		if (row.Category) {
		  var category = reference.category.find(cat => cat.value == row.Category);
		  if (!category) {
			invalid += "Category/";
		  }
		}
	  }

	  if (row.Category && !row.IntakeForm) {
		required += "Intake Form/";
	  }

	  if (!row.Category && isNew) {
		required += "Category/";
	  }

	  if (row.EmailAddress) {
		if (!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(row.EmailAddress))
		  invalid += "Contact Email/"
	  } else if (isNew) required += "Contact Email/";

	  if (!row.Name && isNew)
		required += "Contact Name/";

	  if (row.InternalOwner) {
		var owner = reference.users.data.find(x => x.Email == row.InternalOwner);
		if (!owner)
		  invalid += "Internal Owner/";
	  } else if (isNew) required += "Internal Owner/";

	  if (row.PublicyTradedCompany) {
		if (row.PublicyTradedCompany == 'Yes' || row.PublicyTradedCompany == 'No') {
		  row.PublicyTradedCompany = row.PublicyTradedCompany === 'Yes' ? 'Y' : 'N';
		}
		if (row.PublicyTradedCompany !== 'Y' && row.PublicyTradedCompany !== 'N') {
		  invalid += "PublicyTradedCompany/";
		}
	  }

	  if (row.IsActive) {
		if (row.IsActive == 'Yes' || row.IsActive == 'No') {
		  row.IsActive = row.IsActive === 'Yes' ? 'Y' : 'N';
		}
		if (row.IsActive !== 'Y' && row.IsActive !== 'N') {
		  invalid += "IsActive/";
		}
	  }

	  if (row.CountryOfRegistration) {
		var regCountry = reference.countries.rawData.find(x => x.Name == row.CountryOfRegistration || x.ISO2 == row.CountryOfRegistration);
		if (regCountry) {
		  row.CountryOfRegistration = regCountry.ISO2;
		} else invalid += "CountryOfRegistration/";
	  }

	  if (row.LegalFormOfCompany) {
		const lfOptions = ['AB', 'AG', 'BV', 'BVBA', 'Co', 'Corp', 'Dd', 'Doo', 'EOOD', 'GDK', 'GmbH', 'HB', 'INC', 'Individual', 'KD', 'KDA', 'Kft', 'KK', 'LLC', 'LLP', 'Ltd', 'Ltda', 'NV', 'OOD', 'Other', 'Oy', 'Partnersh', 'Plc', 'Pty Ltd', 'Pvt Ltd', 'SA', 'SA de CV', 'SD', 'Sdn Bhd', 'SL', 'Sole Proprietor', 'SP.zo.o', 'SpA', 'SPRL', 'Srl'];
		if (!!!lfOptions.find(el => el === row.LegalFormOfCompany)) {
		  invalid += "Legal Form Of Company/";
		}
	  }

	  if (row.SiebelID) {
		if (!/[1,2,3]-[A-Za-z0-9-]+/.test(row.SiebelID)) {
		  invalid += "Siebel ID/";
		}
	  }
	  // check if any of them provided
	  if (row.StatusReason || row.ProfileStatus || row.LastStatusReason) {
		if (!row.StatusReason) {
		  required += "StatusReason/";
		}
		if (!row.LastStatusReason) {
		  required += "Approval Status Comment/";
		}
		// at least both required params were passed
		if (row.StatusReason && row.LastStatusReason) {
		  const idx = singleCompanyDetails.statusReasonStructure[0].group[0][0].options.findIndex(el => el === row.StatusReason);
		  if (idx > -1) {
			row.StatusReason = singleCompanyDetails.statusReasonStructure[0].group[0][0].values[idx];
		  } else {
			if (!!!singleCompanyDetails.statusReasonStructure[0].group[0][0].values.find(el => el === row.StatusReason)) {
			  invalid += "Status Reason/";
			}
		  }
		  if (row.ProfileStatus) {
			// may be empty, but if not, it should be correct
			if (singleCompanyDetails.getProfileStatus(row.StatusReason) !== row.ProfileStatus) {
			  invalid += "Status/";
			}
		  } else {
			row.ProfileStatus = singleCompanyDetails.getProfileStatus(row.StatusReason);
		  }
		  // date will be generated automaticaly, do not need to pass it manually
		  row.LastStatusChangeDate = (new Date()).toISOString();
		}
	  }

	  if (required)
		error += "Required: " + required.substring(0, required.length - 1);

	  if (invalid) {
		if (error == "")
		  error += "Invalid: " + invalid.substring(0, invalid.length - 1);
		else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
	  }

	  return {
		"row": row,
		"error": error
	  };
	},
	validateCustomFields: function(row, type = 'Profiles') {
	  var error = "";
	  var invalid = "";
	  const cf = type === 'Profiles' ? singleCompanyDetails.customFields.structure : invitation.invitationOverview.customFields.structure;
	  var cfFields = [];
	  var cfObj = {};
	  var hasField = false;
	  const replacementKey = type === 'Profiles' ? "ProfileCF" : "CaseCF";
	  cf.map(el => {
		cfFields = [...cfFields, ...el.group[0]];
	  });
	  const fields = Object.keys(row);
	  fields.map(field => {
		if (!!row[field]) {
		  const itm = cfFields.find(el => el.label == field.replace(replacementKey, "") || el.data == field.replace(replacementKey, ""));
		  if (itm) {
			hasField = hasField || true;
			switch (itm.type) {
			  case 'toggle':
				if(row[field].toLowerCase() == 'yes' || row[field].toLowerCase() == 'y') {
				  row[field] = 'Yes';
				}
				else if(row[field].toLowerCase() == 'no' || row[field].toLowerCase() == 'n') {
				  row[field] = 'No';
				}
				if (row[field] !== 'Yes' && row[field] !== 'No') {
				  invalid += itm.label + "/";
				}
				break;
			  case 'datetime':
			  case 'date':
				var dRes = bulkInvitationsServer.validateDate(row[field]);
				if(!dRes) {
				  invalid += itm.label + "/";
				}
				else {
				  row[field] = dRes;
				}
				break;
			  case 'select':
				var idx = itm.options.findIndex(el => el === row[field]);
				if (idx > -1) {
				  row[field] = itm.values[idx];
				}
				if (!!!itm.values.find(el => el == row[field])) {
				  invalid += itm.label + "/";
				}
				break;
			  case 'multiselect':
				var parts = row[field].split(',');
				var result = '';
				var valid = true;
				for (let i = 0; i < parts.length; i++) {
				  if (parts[i]) {
					var idx = itm.options.findIndex(el => el === parts[i]);
					if (idx > -1) {
					  result += itm.values[idx];
					} else if (!!itm.values.find(el => el == parts[i])) {
					  result += parts[i];
					} else {
					  result += parts[i];
					  if (valid) {
						valid = false;
						invalid += itm.label + "/";
					  }
					}
					result += (i < (parts.length - 1)) ? ',' : '';
				  }
				}
				row[field] = result;
				break;
			  default:
				break;
			}
			cfObj[field.replace(replacementKey, "")] = row[field];
		  }
		}
	  });
	  if (invalid) {
		if (error == "")
		  error += "Invalid: " + invalid.substring(0, invalid.length - 1);
		else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
	  }

	  return {
		"row": row,
		"error": error,
		"hasField": hasField,
		"cf": cfObj
	  };
	},
	validateCaseData: function(row) {
	  var error = "";
	  var required = "";
	  var invalid = "";
	  if (!row.CaseId) {
		required += "CaseId/";
	  }

	  if (row.CaseLanguage) {
		const lang = reference.languages.data.find(el => el.value.toLowerCase() == row.CaseLanguage.toLowerCase() || !!el.aliases.find(a => a.toLowerCase() == row.CaseLanguage.toLowerCase()));
		if (!lang) {
		  invalid += "Language/";
		} else {
		  row.CaseLanguage = lang.value;
		}
	  }
	  if (row.CaseStage) {
		if (row.CaseStatus && row.CaseStatus !== 'Closed') {
		  invalid += "Case Status/";
		}
		if (!!!row.CaseCloseComment) {
		  required += "Case Close Reason/";
		} else {
		  switch (row.CaseStage) {
			case 'Passed':
			  row["CaseStatusId"] = 4;
			  break;
			case 'Denied':
			  row["CaseStatusId"] = 5;
			  break;
			case 'Closed':
			  row["CaseStatusId"] = 6;
			  break;
			default:
			  invalid += "Case Stage/";
			  break;
		  }
		  if (row.CaseCloseCode) {
			var closeCodes = [];
			switch (row.CaseStage) {
			  case 'Passed':
				closeCodes = ['04-Pass -Low Risk', '05-Pass-Medium Risk',
							  '06-Pass-Medium-High Risk', '07-Pass-High Risk',
							  '08-Pass-Hold for Review', '09-Pass-Executive Exemption'
							 ];
				break;
			  case 'Denied':
				closeCodes = ['01-Reject/Fail-Incomplete, Non-Responsive', '02-Reject-CL1/PL1 Decision', '03-Reject-Business Decision'];
				break;
			  case 'Closed':
				closeCodes = ['97-Closed-No Contract', '98-Reactive Case', '99-Permanently Deleted Case', 'Non-Responsive']
				break;
			}
			if (!!!closeCodes.find(el => el === row.CaseCloseCode)) {
			  invalid += "Case Pass Fail/";
			}
		  } else {
			required += "Case Pass Fail/";
		  }
		}
	  } else if (row.CaseCloseCode) {
		if (!!!row.CaseCloseComment) {
		  required += "Case Close Reason/";
		}
		switch (row.CaseCloseCode) {
		  case '04-Pass -Low Risk':
		  case '05-Pass-Medium Risk':
		  case '06-Pass-Medium-High Risk':
		  case '07-Pass-High Risk':
		  case '08-Pass-Hold for Review':
		  case '09-Pass-Executive Exemption':
			row["CaseStatusId"] = 4;
			break;
		  case '01-Reject/Fail-Incomplete, Non-Responsive':
		  case '02-Reject-CL1/PL1 Decision':
		  case '03-Reject-Business Decision':
			row["CaseStatusId"] = 5;
			break;
		  case '97-Closed-No Contract':
		  case '98-Reactive Case':
		  case '99-Permanently Deleted Case':
		  case 'Non-Responsive':
			row["CaseStatusId"] = 6;
			break;
		  default:
			invalid += "Case Pass Fail/";
			break;
		}
	  }
	  if (required) {
		error += "Required: " + required.substring(0, required.length - 1);
	  }
	  if (invalid) {
		if (error == "")
		  error += "Invalid: " + invalid.substring(0, invalid.length - 1);
		else error += ". Invalid: " + invalid.substring(0, invalid.length - 1);
	  }
	  return {
		"row": row,
		"error": error
	  };
	},
	findProfileByKeys: function(row, callback) {

	  var filter1 = {
		logic: "or",
		filters: [{
		  field: "EntryId",
		  operator: "eq",
		  value: row["ProfileId"]
		},
				  {
					field: "LegacyId",
					operator: "eq",
					value: row["ProfileId"]
				  }
				 ]
	  };

	  /*
                var filter2 =	{
                  logic: "and",
                  filters: [
                    {
                          logic: "and",
                          filters: [
                            {
                              field: "SiebelID",
                              operator: "eq",
                              value: row["SiebelID"] || "--"
                            },
                            {
                              field: "IntakeForm",
                              operator: "eq",
                              value: row["IntakeForm"] || "--"
                            }
                          ]
                        },
                        {
                          logic: "and",
                          filters: [
                            {
                              field: "PartyId",
                              operator: "eq",
                              value: row["PartyId"] || "--"
                            },
                            {
                              field: "IntakeForm",
                              operator: "eq",
                              value: row["IntakeForm"] || "--"
                            }
                          ]
                        },
                        {
                          logic: "and",
                          filters: [
                            {
                              field: "CompanyName",
                              operator: "eq",
                              value: row["CompanyName"] || "--"
                            },
                            {
                              field: "IntakeForm",
                              operator: "eq",
                              value: row["IntakeForm"] || "--"
                            }
                          ]
                        }
                  ]
                };

                if(row["SiebelID"])
                  filter2.filters.push({
                    field: "SiebelID",
                    operator: "eq",
                    value: row["SiebelID"]
                  });

                if(row["PartyId"])
                  filter2.filters.push({
                    field: "PartyId",
                    operator: "eq",
                    value: row["PartyId"]
                  },);

                if(row["CompanyName"])
                  filter2.filters.push({
                    field: "CompanyName",
                    operator: "eq",
                    value: row["CompanyName"] 
                  });

                if(row["IntakeForm"])
                  filter2.filters.push({
                    field: "IntakeForm",
                    operator: "eq",
                    value: row["IntakeForm"] 
                  });


                var filter3 =	{
                  logic: "and",
                  filters: []
                };

        */

	  if (row["ProfileId"]) {
		bulkInvitationsServer.findProfile(filter1, function(item) {
		  if (item && typeof item != "string") {
			callback(item);
		  } else if (typeof item == "string") {
			//row.Comment = item;
			//row.Status = -1;
			callback(undefined, item);
		  } else {
			//row.Comment = "Profile not found.";
			//row.Status = -1;
			callback(undefined, "Profile not found.");
		  }
		  /* else
                      findProfile(filter2, function(item) {
                        if(item &&typeof item != "string")
                        {
                          callback(item);
                        }
                        else if(typeof item == "string")
                        {
                          row.Comment = item;
                          row.Status = -1;
                          callback();
                        }
                        else  findProfile(filter3, function(item) {
                          if(item &&typeof item != "string")
                          {
                            callback(item);
                          }
                          else if(typeof item == "string")
                          {
                            row.Comment = item;
                            row.Status = -1;
                            callback();
                          }
                          else 
                          {
                            row.Comment = "Profile not found.";
                            row.Status = -1;
                            callback();
                          }
                        });
                      });
        */
		});
	  }
	  /*   else if(filter2.filters.length > 0)
                {
                  findProfile(filter2, function(item) {
                    if(item && typeof item != "string")
                    {
                      callback(item);
                    }
                    else if(typeof item == "string")
                    {
                      row.Comment = item;
                      row.Status = -1;
                      callback();
                    }
                    else  findProfile(filter3, function(item) {
                      if(item &&typeof item != "string")
                      {
                        callback(item);
                      }
                      else if(typeof item == "string")
                      {
                        row.Comment = item;
                        row.Status = -1;
                        callback();
                      }
                    });
                  });

                }
                else if(filter3.filters.length > 0)
                {
                  findProfile(filter3, function(item) {
                    if(item &&typeof item != "string")
                    {
                      callback(item);
                    }
                    else if(typeof item == "string")
                    {
                      row.Comment = item;
                      row.Status = -1;
                      callback();
                    }
                    else 
                    {
                      row.Comment = "Profile not found.";
                      row.Status = -1;
                      callback();
                    }
                  });
                } */
	  else {
		//row.Comment = "Profile not found.";
		//row.Status = -1;
		callback();
	  }
	},
	findProfile: function(filter, callback) {
	  if (filter.filters.length == 0)
		return callback("Profile not found");

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_CompanyInformation/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,

	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length == 1)
		  callback(data[0].toJSON());

		if (data.length == 0)
		  callback();

		if (data.length > 1)
		  callback("Multiple profiles found: " + data.map(x => {
			return x.EntryId
		  }).join(", "));

	  });

	},
	findCaseByKeys: function(row, callback) {

	  var filter1 = {
		logic: "or",
		filters: [{
		  field: "EntryId",
		  operator: "eq",
		  value: row["CaseId"]
		},
				  {
					field: "LegacyId",
					operator: "eq",
					value: row["CaseId"]
				  }
				 ]
	  };

	  if (row["CaseId"]) {
		bulkInvitationsServer.findCase(filter1, function(item) {
		  if (item && typeof item != "string") {
			callback(item);
		  } else if (typeof item == "string") {
			callback(undefined, item);
		  } else {
			callback(undefined, "Case not found.");
		  }
		});
	  } else {
		callback();
	  }
	},
	findCase: function(filter, callback) {
	  if (filter.filters.length == 0)
		return callback("Case not found");

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Invitations/kendo/data/search",
			type: 'POST'
		  },
		},
		schema: {
		  model: {
			id: "EntryId",
			/* please define primary key name */
			fields: {
			  /* define filed here for use update/create*/
			}
		  }
		},
		/* set page size*/
		serverFiltering: true,
		filter: filter,
		serverSorting: true,

	  });

	  ds.read().then(function() {
		var data = ds.view();

		if (data.length == 1)
		  callback(data[0].toJSON());

		if (data.length == 0)
		  callback();

		if (data.length > 1)
		  callback("Multiple cases found: " + data.map(x => {
			return x.EntryId
		  }).join(", "));

	  });

	},
	proccessProfileRow: function(row, createNewProfile, callback) {
	  var itm = null;
	  const cols = bulkInvitationsServer.ui.getColumns();
	  cols.map(col => {
		var k = col.field;
		if (!k.startsWith("Case") && !k.startsWith("ProfileCF") && row[k]) {
		  itm = itm ? { ...itm,
					   [k]: row[k]
					  } : {
			[k]: row[k]
		  }
		}
	  });
	  if (!itm) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitationsServer.validateProfileData(itm, createNewProfile);
	  var error = result.error;
	  row = { ...row,
			 ...result.row
			};

	  bulkInvitationsServer.findProfileByKeys(row, function(profile, comment) {
		if (profile) {
		  var profileCopy = JSON.parse(JSON.stringify(profile));
		  var keys = Object.keys(profileCopy);
		  keys.forEach(x => {
			if (row[x] && !x.startsWith("Case") && !x.startsWith("ProfileCF"))
			  profileCopy[x] = row[x];
		  });

		  //var error = bulkInvitationsServer.validateData(profileCopy);
		  if (error) {
			row.Comment = (row.Comment || "") + "The profile (#" + profile.EntryId + ") doesn't contain required information. Error: " + error + "\n";
			row.Status = -1;
		  } else
			row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);

		  callback(row);
		  return;
		} 
		else {
		  if (row.ProfileId) {
			row.Comment = (row.Comment || "") + `Could not find the profile. Error: Could not find the profile with # ${row.ProfileId}` + error + "\n";
			row.Status = -1;
			callback(row);
			return;
		  }
		  if (createNewProfile) {
			//var error = bulkInvitationsServer.validateData(row);

			if (error) {
			  row.Comment = (row.Comment || "") + (row.Comment || "") + "Could not create the profile. Error: " + error + "\n";
			  row.Status = -1;
			  callback(row);
			  return;
			}


			row.Comment = (row.Comment || "") + "Profile will be created.\n";
			row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
			callback(row);
			return;
		  } 
		  else {

			if (!row.Comment) {
			  row.Comment = (row.Comment || "") + "Profile Id not found."+error+"\n";
			  row.Status = -1;
			}
			callback(row);
		  }
		}
	  });
	},
	proccessProfileCFRow: function(row, callback) {
	  if (!row.ProfileId) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitationsServer.validateCustomFields(row);
	  var error = result.error;
	  var hasField = result.hasField;
	  var cf = result.cf;
	  if (!hasField) {
		callback(row);
		return;
	  }
	  row = result.row;
	  if (error) {
		row.Comment = (row.Comment || "") + "The Profile (#" + row.ProfileId + ") Custom Fields item has errors. Error: " + error + '\n';
		row.Status = -1;
		callback(row);
		return;
	  }
	  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
	  callback(row);
	  return;
	},
	proccessCaseRow: function(row, callback) {
	  if (!row.CaseId) {
		callback(row);
		return;
	  }
	  var itm = null;
	  const cols = bulkInvitationsServer.ui.getColumns();
	  cols.map(col => {
		var k = col.field;
		if (k.startsWith("Case") && !k.startsWith("CaseCF") && row[k]) {
		  itm = itm ? { ...itm,
					   [k]: row[k]
					  } : {
			[k]: row[k]
		  }
		}
	  });
	  if (!itm) {
		callback(row);
		return;
	  }
	  var result = bulkInvitationsServer.validateCaseData(itm);
	  var error = result.error;
	  row = { ...row,
			 ...result.row
			};

	  bulkInvitationsServer.findCaseByKeys(row, function(caseItm, comment) {
		if (caseItm) {
		  var caseCopy = JSON.parse(JSON.stringify(caseItm));
		  var keys = Object.keys(caseCopy);
		  keys.forEach(x => {
			if (row[x] && x.startsWith("Case") && !x.startsWith("CaseCF"))
			  caseCopy[x] = row[x];
		  });

		  if (error) {
			row.Comment = (row.Comment || "") + "The case (#" + caseItm.EntryId + ") doesn't contain required information. Error: " + error + '\n';
			row.Status = -1;
		  } else
			row.Status = 1;

		  callback(row);
		  return;
		} 
		else {
		  if (row.CaseId) {
			row.Comment = (row.Comment || "") + `Could not update the case. Could not find the case with # ${row.CaseId}. Error: ` + error + '\n';
			row.Status = -1;
			callback(row);
			return;
		  } else {
			row.Comment = (row.Comment || "") + `Could not update the case. Case # not provided. Error: ` + error + '\n';
			row.Status = -1;
			callback(row);
			return;
		  }
		  callback(row);
		}
	  });
	},
	proccessCaseCFRow: function(row, callback) {
	  if (!row.CaseId) {
		callback(row);
		return;
	  }
	  //validate and convert specific data
	  var result = bulkInvitationsServer.validateCustomFields(row, 'Cases');
	  var error = result.error;
	  var hasField = result.hasField;
	  var cf = result.cf;
	  if (!hasField) {
		callback(row);
		return;
	  }
	  row = result.row;
	  if (error) {
		row.Comment = (row.Comment || "") + "The Case (#" + row.CaseId + ") Custom Fields item has errors. Error: " + error + '\n';
		row.Status = -1;
		callback(row);
		return;
	  }
	  row.Status = row.Status == null ? 1 : Math.min(row.Status, 1);
	  callback(row);
	  return;
	},
	switchMonthDay: function(value) {
	  // if empty fo nothing
	  if (!value) {
		return undefined;
	  }
	  var separator = value.indexOf('-') > 0 ? '-' : value.indexOf('/') > 0 ? '/' : value.indexOf('.') > 0 ? '.' : null;
	  if(!separator) {
		return undefined;
	  }
	  var currDate = new Date(value);
	  var userTimezoneOffset = currDate.getTimezoneOffset() * 60000;
	  var resultDate = new Date(currDate.getTime() - userTimezoneOffset);

	  // if ISO string, do nothing
	  if(separator == '-') {
		return resultDate.toISOString(); 
	  }

	  var dt = value.split(separator);
	  if(!dt.length || dt.length !== 3) {
		return undefined;
	  }
	  currDate.setMonth(Number(dt[1])-1);
	  currDate.setDate(Number(dt[0]));
	  return resultDate.toISOString(); 
	},
	validateDate: function(value) {
	  var processDate = function(val, delimeter) {
		// split date and time
		var valParts = val.split(' ');
		var dateVal = valParts[0];
		var timeVal = valParts[1];
		// split date parts
		var dateParts = dateVal.split(delimeter);
		var resultDate = new Date();
		// set year, it's always 3rd
		resultDate.setFullYear(dateParts[2]);
		// set month
		resultDate.setMonth(Number(delimeter == '.' ? dateParts[1] : dateParts[0])-1);
		// set day
		resultDate.setDate(Number(delimeter == '.' ? dateParts[0] : dateParts[1]));

		if(!!timeVal) {
		  // do time
		  var timeParts = timeVal.split(':');
		  resultDate.setHours(timeParts[0]);
		  resultDate.setMinutes(timeParts[1]);
		  if(!!timeParts[2]) {
			resultDate.setSeconds(timeParts[2]);
		  }
		  else {
			resultDate.setSeconds(0);
		  }
		}
		else {
		  resultDate.setHours(0);
		  resultDate.setMinutes(0);
		  resultDate.setSeconds(0);
		}
		resultDate.setMilliseconds(0);

		// timezone offset
		var dateTZ = new Date();
		var userTimezoneOffset = dateTZ.getTimezoneOffset() * 60000;
		resultDate = new Date(resultDate.getTime() - userTimezoneOffset);

		return resultDate.toISOString();
	  };
	  if(value.match(/^(19[0-9]{2}|2[0-9]{3})\-(0[1-9]|1[0-2])\-((0[1-9])|[1-2][0-9]|3[0-1])(T((0[0-9])|1[0-9]|2[0-3]):([0-5][0-9])(:([0-5][0-9])Z?))?$/)) {
		// ISO string already, all good
		return value.replace('Z', '');
	  }
	  if(value.match(/^((0[1-9])|[1-2][0-9]|3[0-1])\.(0[1-9]|1[0-2])\.(19[0-9]{2}|2[0-9]{3})(\s((0[0-9])|1[0-9]|2[0-3]):([0-5][0-9])(:([0-5][0-9]))?)?$/)) {
		// day first, EU style
		return processDate(value, '.');
	  }
	  if(value.match(/^(0[1-9]|1[0-2])\/((0[1-9])|[1-2][0-9]|3[0-1])\/(19[0-9]{2}|2[0-9]{3})(\s((0[0-9])|1[0-9]|2[0-3]):([0-5][0-9])(:([0-5][0-9]))?)?$/)) {
		// month first, US style
		return processDate(value, '/');
	  }
	  return null;
	},
	readTemplates: function(callback) {
	  bulkInvitationsServer.templates = [...bulkInvitationsServer.defaultTemplates];
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1672/BatchTemplates/kendo/data/search",
			type: 'POST'
		  },
		},

		serverPaging: true,
		serverFiltering: true,
		serverSorting: true,
	  });

	  ds.read().then(function() {
		bulkInvitationsServer.dbTemplates = ds.view();
		bulkInvitationsServer.templates = [...bulkInvitationsServer.defaultTemplates];
		bulkInvitationsServer.dbTemplates.map(el => {
		  var required = [];
		  var fields = [];
		  (el.AvailableFields || '').split(',').map(f => {
			fields.push(
			  { 
				'title': bulkInvitationsServer.getTitle(f),
				'width': "150px",
				'field': f
			  }
			);
		  });
		  (el.SelectedFields || '').split(',').map(f => {
			required.push(
			  { 
				'title': bulkInvitationsServer.getTitle(f),
				'width': "150px",
				'field': f
			  }
			);
		  });
		  bulkInvitationsServer.templates.push({
			name: el.TemplateName,
			fields: fields,
			requiredFields: required,
			autoCreate: el.AutoCreate,
			autoInvite: el.AutoInvite,
		  });
		});
		callback();
	  });
	},
	getTitle: function(name) {
	  var formId = 0;
	  if(name.startsWith('CaseCF'))
		formId = 1375;
	  else if(name.startsWith('ProfileCF'))
		formId = 1374;
	  else if(name.startsWith('Case'))
		formId = 1275;
	  else
		formId = 1363;
	  var val = name.replace('ProfileId', 'EntryId')
	  .replace('ProfileStatus', 'Status')
	  .replace('StatusReason')
	  .replace('ProfileCF', '')
	  .replace('CaseId', 'EntryId')
	  .replace('Case', '')
	  .replace('CaseCF', '');
	  var alias = bulkInvitationsServer.columnAliases.find(a => a.FormId == formId && a.ColumnName == val);
	  return !!alias ? alias.Title : val;
	},
  };
</script>

<!--REPORTING -->
<script>
  const reporting = {
	holder: function() {
	  return document.querySelector('#navigation #reporting:last-child')
	},
	html: function() {
	  var html =
		  "<section id='reporting'>" +
		  "<div class='reporting-tabs'></div>" +
		  "</section>";

	  return html;
	},
	init: function() {
	  navigation.push(reporting.html());

	  mo.fn.overlay.show({
		loading: true,
		close: false
	  });

	  recentlyViewed.add({
		Module: 'Reporting',
		Id: null,
	  }, function() {});

	  reporting.getConfigs(function() {
		reporting.getColumnMapping(function() {
		  mo.fn.overlay.hide();
		  reporting.ui();
		});
	  });
	},
	mappingData: [],
	configs: [],
	getColumnMapping: function(cb) {
	  var mappingDS = reporting.getMappingValuesDS();

	  mappingDS.read().then(function() {
		mappingDS.view().forEach(function(el) {
		  reporting.mappingData['table' + el.FormId + '_' + el.ColumnName] = el;

		  //exception for generic columns like MinColumn1, MinColumn2 etc
		  if(el.FormId == "1285" && el.ColumnName.includes("Column"))
			reporting.mappingData[el.ColumnName] = el;
		});
		cb();
	  });
	},
	ui: function() {

	  hpe.ui.tabs({
		dom: reporting.holder().querySelector(".reporting-tabs"),
		tabs: [
		  {
			label: "Report builder",
			id: 'reportBuilder'
		  },
		  {
			label: "Additional Reports",
			id: "reports"
		  },
		  {
			label: "Securimate",
			id: "legacy"
		  }, {
			label: "My Reports",
			id: "myReports"
		  },
		  {
			label: "Internal",
			id: "internal"
		  },
		]
	  }, function(all) {

		var cleanLayout = function(id) {
		  var items = reporting.holder().querySelector('.container').children;
		  for (var i = 0; i < items.length; i++)
			if (items[i].getAttribute("tab-id") != id)
			  items[i].classList.remove("active");
		}

		if (!util.isDeveloper()) reporting.holder().querySelector('[tab-id="internal"]').style.display = 'none';
		reporting.reportBuilder.init(all[0]);

		reporting.holder().querySelector('[tab-id="reportBuilder"]').addEventListener('click', function() {
		  cleanLayout("reportBuilder");
		  reporting.ark.init(all[1]);
		});

		reporting.holder().querySelector('[tab-id="reports"]').addEventListener('click', function() {
		  cleanLayout("reports");
		  reporting.ark.init(all[1]);
		});

		reporting.holder().querySelector('[tab-id="legacy"]').addEventListener('click', function() {
		  cleanLayout("legacy");
		  reporting.legacy.init(all[2]);
		});

		reporting.holder().querySelector('[tab-id="myReports"]').addEventListener('click', function() {
		  cleanLayout("myReports");
		  reporting.myReports.init(all[3]);
		});

		reporting.holder().querySelector('[tab-id="internal"]').addEventListener('click', function() {
		  cleanLayout("internal");
		  reporting.internalRep.init(all[4]);
		});

	  });
	},
	getConfigs: function(callback) {
	  var configDS = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1279/FormConfigs/kendo/data/search",
			type: 'POST'
		  },
		},

		serverPaging: true,
		serverFiltering: true,
		serverSorting: true,
	  });

	  configDS.read().then(function() {
		reporting.configs = configDS.view();
		callback();
	  });
	},
	getMappingValuesDS: function() {
	  return new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Name_Mapping/kendo/data/search",
			type: 'POST'
		  },
		},

		serverPaging: true,
		serverFiltering: true,
		serverSorting: true,
	  });
	},
	getColumnsOfTable: function(formId, dataset, callback) {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/" + formId + "/" + dataset + "/kendo/data/search",
			type: 'POST'
		  },
		},
		serverPaging: true,
		page: 1,
		pageSize: 1,
		serverFiltering: true,
		serverSorting: true,
	  });

	  ds.read().then(function() {
		var view = ds.view();
		var res = [];
		if (view.length > 0) {
		  var row = view[0].toJSON();
		  res = Object.keys(row);
		}

		callback(res);
	  });
	},
	getKendoColumnsFromNames: function(columns, formId, useMapping, excludeSystemColumns) {
	  var res = [];

	  columns.forEach(x => {

		if (excludeSystemColumns && ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x) != -1)
		  return;

		var column = {};
		column.title = x;
		column.field = "[\"" + x + "\"]";
		column.width = "150px";
		column.headerAttributes = {
		  style: "white-space: normal"
		};

		var columnInfo = reporting.mappingData["table" + formId + "_" + x];
		if (columnInfo) {
		  column.systemType = columnInfo.Type;
		  switch (column.systemType) {
			case "Date":
			  column.template = function(d, field = x) {
				return util.getDate(d[field]) || '';
			  };
			  break;
		  }
		}

		if (x.includes("Date"))
		  column.template = function(d, field = x) {
			return util.getDate(d[field]) || '';
		  };

		res.push(column);
	  });

	  return res;
	},
	getReportBuilderReportsColumns: function(type, cb) {
	  switch (type) {
		case 'Profiles':
		  if (Object.keys(reporting.reportBuilder.profilesData).length === 0)
			reporting.reportBuilder.reportProfiles(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'Cases':
		  if (Object.keys(reporting.reportBuilder.casesData).length === 0)
			reporting.reportBuilder.reportCases(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'Users':
		  if (Object.keys(reporting.reportBuilder.usersData).length === 0)
			reporting.reportBuilder.reportUsers(function() {
			  cb();
			});
		  else
			cb();
		  return;
		case 'DDQ':
		  if (Object.keys(reporting.reportBuilder.ddqData).length === 0)
			reporting.reportBuilder.reportDDQ(function() {
			  cb();
			});
		  else
			cb();
		  return;
	  }
	},
	reportBuilder: {
	  casesSorted: ["Case. Case #", "Case. Created", "Profile. Official Company Name", "Profile. English Company Name", "Profile. Siebel ID", "Profile. Party Id", "Case. Name", "Case. Region", "Case. Country Code", "Case. Intake Form", "Case. Intake Form Version", "Case. Submitted Date", "Case. Pass/Fail", "Case. Stage", "Case. Status", "Case. Sent To (Name)", "Case. Sent To (Email)", "Case. First Visit Date", "Case. Last Visit Date", "Case. Created By", "Case. Company #", "Case. Securimate #", "Case. Completed Date", "Case. Requestor", "Task. Name", "Task. Assigned To", "Task. Status", "Task. Completed Date", "Profile. Country", "Profile. Approval Status", "Profile. Address 1", "Profile. Address 2", "Profile. Alt Telephone", "Profile. Category", "Profile. City", "Profile. State", "Profile. Company Telephone", "Profile. POC Name", "Profile. POC Email Address", "Profile. FAX", "Profile. Internal Owner", "Profile. Language", "Profile. Legal Form Of Company", "Profile. Mobile", "Profile. Number Of Years In Primary Business", "Profile. POC Position", "Profile. Post Code", "Profile. Publicy Traded Company", "Profile. Region", "Profile. Registration Number", "Profile. Stock Exchange", "Profile. Tax Id", "Profile. Telephone", "Profile. Ticker Symbol", "Profile. Alternate Trade Name(s)", "Profile. Website", "Profile. Created", "Profile. Created By", "Profile. Profile #", "Profile. Modified", "Profile. Modified By", "Country CPI", "Country Max", "Country Override", "Country Score", "CPI Weight", "DDQ Max", "DDQ Points", "DDQ Score", "DDQ Weight", "Risk Rank", "Risk Rank Id",
					"Risk Score", "Source", "Referral Id", "Case. Related Cases", "Case Assigned Date", "Case Accepted", "Case Due Date", "Case Closed", "Case Invoice", "Case Description", "Case Department", "Case Scope", "Subject Status", "Subject Type", "Case (CF). App ID", "Case (CF). BU EDD Decision", "Case (CF). Business Caution Factors", "Case (CF). Category Status", "Case (CF). CFI Analyst", "Case (CF). Contract Inactivation Date", "Case (CF). Contract Inactivation Reason", "Case (CF). Contract Requestor Email", "Case (CF). Contract Termination Date", "Case (CF). Contract Termination Reason", "Case (CF). CPI", "Case (CF). CPI Do Not Update", "Case (CF). Date Assigned To Agility", "Case (CF). Date Batch Created", "Case (CF). Date EDD Decision Released", "Case (CF). Date Scorecard Received", "Case (CF). DDI Agility Comments Additional Request", "Case (CF). DDI Agility Reason For Override", "Case (CF). DDI Agility Release Date", "Case (CF). DDI Agility Result Override", "Case (CF). DDI Agility Special Handling Instructions", "Case (CF). DDI Analyst", "Case (CF). DDI Batch Number", "Case (CF). DDI Completed Date", "Case (CF). DDI Date Assigned To Agility", "Case (CF). DDI Final Result", "Case (CF). DDI No Info Responses", "Case (CF). DDI No Responses", "Case (CF). DDI Reason For Override", "Case (CF). DDI Region Lead Active Review", "Case (CF). DDI Region Lead Review Result Date", "Case (CF). DDI Result Override", "Case (CF). DDI Result Sent To Contracts Team", "Case (CF). DDI Scoring Analyst", "Case (CF). DDI Scoring Completed Date", "Case (CF). DDI SQ Comments", "Case (CF). DDI SQ Result", "Case (CF). DDI Start Date", "Case (CF). DDI Update Sent To Contracts Team", "Case (CF). DDI Yes Responses", "Case (CF). DDQ Reminder Date", "Case (CF). Reactivation Reminder Date", "Case (CF). Update Reactivation Result to Contracts Team", "Case (CF). DDQ Reactivation Result", "Case (CF). BU EDD Decision Date", "Case (CF). DDQ Request Receive Date", "Case (CF). DDQ Result", "Case (CF). DDQ Score", "Case (CF). DDQ Score Do Not Update", "Case (CF). EDD Case Numbers", "Case (CF). EDD Decision Released", "Case (CF). EDD Result Receive Date", "Case (CF). EDD Scorecard Results", "Case (CF). EDD Scorecard Results Revised", "Case (CF). EDD Trigger Date", "Case (CF). Extended DDQ Days", "Case (CF). Extension Reason", "Case (CF). Final EDD Result", "Case (CF). GT Question Do Not Update", "Case (CF). Holidays", "Case (CF). IDD Agility Business Caution Instructions", "Case (CF). IDD Agility EDD Reasons", "Case (CF). IDD Agility Recommendation", "Case (CF). IDD Agility Release Date", "Case (CF). IDD Agility Special Handling Instructions", "Case (CF). IDD Agility Supplemental Questionnaire Instructions", "Case (CF). IDD Analyst", "Case (CF). IDD Completed Date", "Case (CF). IDD Date Assigned To Agility", "Case (CF). IDD Reason Override", "Case (CF). IDD Result Override", "Case (CF). IDD Result Sent To Contracts Team", "Case (CF). IDD Start Date", "Case (CF). IDD Update Sent To Contract Team", "Case (CF). IFQ Do Not Update", "Case (CF). Marketing Vendor Low Risk Q5 Q6", "Case (CF). No Info Responses", "Case (CF). No Responses", "Case (CF). On Boarding Program", "Case (CF). On Going Special Handling", "Case (CF). OSI Case Number", "Case (CF). OSI Final Result", "Case (CF). OSI Reason For Override", "Case (CF). OSI Result", "Case (CF). OSI Result Override", "Case (CF). OSI Result Receive Date", "Case (CF). OSI SQ Comments", "Case (CF). OSI SQ Result", "Case (CF). OSI Trigger Date", "Case (CF). OSI Batch Number", "Case (CF). Other Instructions", "Case (CF). Other Notable Factors", "Case (CF). Partner Location ID", "Case (CF). Party ID", "Case (CF). Post OSI Result Override", "Case (CF). Post Osi Supplementary Research", "Case (CF). Pre Screened", "Case (CF). Raw FK", "Case (CF). Red Flag Questions", "Case (CF). Red Flag Questions Do Not Update", "Case (CF). Red Line DDQ", "Case (CF). Remarks", "Case (CF). OSI Date Assigned to Agility", "Case (CF). OSI Agility Release Date", "Case (CF). Reactivation Request Trigger Date", "Case (CF). DDQ Reactivation Trigger Date", "Case (CF). Osi Agility Special Handling Instruction", "Case (CF). Requesting Business Unit", "Case (CF). SH BC Final Result", "Case (CF). SH BC Result Receive Date", "Case (CF). Siebel PRMID Or Supplier Vendor ID", "Case (CF). Simplified Code 06 Case", "Case (CF). Special Handling Instructions", "Case (CF). Sub Region", "Case (CF). Update DDQ Result To Contracts Team",
					"Case (CF). Update EDD Result To Contracts Team", "Case (CF). Update OSI Result To Contracts Team", "Case (CF). Yes Responses", "Case (CF). Special Consideration"
				   ],
	  profilesSorted: ["Profile. Profile #", "Profile. Securimate #", "Profile. Official Company Name", "Profile. English Company Name", "Profile. Siebel ID", "Profile. Party Id", "Profile. Approval Status", "Profile. Approval Status Reason", "Profile. Is Active", "Profile. Region", "Profile. Country", "Profile. Created", "Profile. Category", "Profile. Intake Form", "Profile. Tax Id", "Profile. Address 1", "Profile. Address 2", "Profile. State", "Profile. City", "Profile. Telephone", "Profile. Company Telephone", "Profile. Alt Telephone", "Profile. Post Code", "Profile. FAX", "Profile. POC Name", "Profile. POC Email Address", "Profile. POC Position", "Profile. Created By", "Profile. Modified", "Profile. Modified By", "Profile. Internal Owner", "Profile. Cases", "Profile. Cases Securimate", "Risk Rank", "Risk Score", "Profile. Language", "Profile. Legal Form Of Company", "Profile. Mobile", "Profile. Number Of Years In Primary Business", "Profile. Profile Global Status", "Profile. Publicy Traded Company", "Profile. Registration Number", "Profile. Stock Exchange", "Profile. Ticker Symbol", "Profile. Alternate Trade Name(s)", "Profile. Website", "Profile. Country Of Registration", "Profile (CF). Branch Or Subsidiary Exemption", "Profile (CF). Branch Subsidiary", "Profile (CF). Category Status", "Profile (CF). GDC Agility EDD Reasons", "Profile (CF). GDC Agility Recommendation", "Profile (CF). GDC Agility Release Date", "Profile (CF). GDC Agility Special Handling Instructions", "Profile (CF). GDC Agility Supplemental Questionnaire Instructions", "Profile (CF). GDC Date Assigned To Agility", "Profile (CF). GDC Final Risk Mitigation Outcome", "Profile (CF). GDC Override Reason", "Profile (CF). GDC Red Flags", "Profile (CF). GDC Research Analyst", "Profile (CF). GDC Research Completed Date", "Profile (CF). GDC Research Start Date", "Profile (CF). GDC Result Override", "Profile (CF). GDC Risk Mitigation Owner", "Profile (CF). Global Exemption", "Profile (CF). Headquarter Location Or Parent Company", "Profile (CF). Highest Risk Country CPI", "Profile (CF). Highest Risk Country Name", "Profile (CF). Internal HPE Contact Email Address", "Profile (CF). Internal HPE Contact Name", "Profile (CF). Parent Company Name", "Profile (CF). Preferred Language Code", "Profile (CF). Partner Location Id", "Profile (CF). Party Id", "Profile (CF). Related OEM 3P Profile Number", "Profile (CF). Related Reseller 3P Profile Number", "Profile (CF). Related Supplier 3P Profile Number", "Profile (CF). Special Partner Type", "Profile (CF). Special Partner Type Siebel Id", "Profile (CF). Tax Id"],
	  reportType: [
		{
		  option: 'Profiles',
		  value: 'Profiles'
		},
		{
		  option: 'Cases',
		  value: 'Cases'
		},
		{
		  option: 'Due Diligence',
		  value: 'DDQ'
		},
		{
		  option: 'Users',
		  value: 'Users'
		}
	  ],
	  dateRange: [
		{
		  option: 'Past Month',
		  value: 'past1mon'
		},
		{
		  option: 'Past 3 Months',
		  value: 'past3mon'
		},
		{
		  option: 'Past 6 Months',
		  value: 'past6mon'
		},
		{
		  option: 'Past 12 Months',
		  value: 'past12mon'
		},
		{
		  option: 'Month to Date',
		  value: 'mtd'
		},
		{
		  option: 'Quarter to Date',
		  value: 'qtd'
		},
		{
		  option: 'Year to Date',
		  value: 'ytd'
		},
		{
		  option: 'Past Day',
		  value: 'prevday'
		},
		{
		  option: 'Past Week',
		  value: 'prevweek'
		},
		{
		  option: 'Previous Month',
		  value: 'prevmon'
		},
		{
		  option: 'Previous Quarter',
		  value: 'prevqtr'
		},
		{
		  option: 'Previous Year',
		  value: 'prevyr'
		},
		{
		  option: 'Include All Dates',
		  value: 'all'
		},
		{
		  option: 'Custom Date Range',
		  value: 'custom'
		},
	  ],
	  msg: function(str, typ) {
		$('.msgBox').addClass(typ);
		$('.msgBox p').text(str);
		window.scrollTo({
		  top: 0,
		  behavior: 'smooth'
		});
		$('.msgBox .close').on('click', function(ev) {
		  $('.msgBox').removeClass('err');

		});
	  },
	  kendoOperators: [
		{
		  option: 'Greater than or equal',
		  value: 'gte'
		},
		{
		  option: 'Less than or equal',
		  value: 'lte'
		},
		{
		  option: 'Greater than ',
		  value: 'gt'
		},
		{
		  option: 'Less than',
		  value: 'lt'
		},
		{
		  option: 'Equal',
		  value: 'eq'
		},
		{
		  option: 'Not equal',
		  value: 'neq'
		},
		{
		  option: 'Is null',
		  value: 'isnull'
		},
		{
		  option: 'Is not null',
		  value: 'isnotnull'
		},
		{
		  option: 'Is empty',
		  value: 'isempty'
		},
		{
		  option: 'Is not empty',
		  value: 'isnotempty'
		},
		{
		  option: 'Starts with',
		  value: 'startswith'
		},
		{
		  option: 'Does not start with',
		  value: 'doesnotstartwith'
		},
		{
		  option: 'Contains',
		  value: 'contains'
		},
		{
		  option: 'Does not contain',
		  value: 'doesnotcontain'
		},
		{
		  option: 'Ends with',
		  value: 'endswith'
		},
		{
		  option: 'Does not end with',
		  value: 'doesnotendwith'
		}
	  ],
	  typeConf: {},
	  repeatableConf: {},
	  savedTemplate: {},
	  savedTemplateDataSource: function(user) {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Report_Templates/kendo/data/search",
			  type: 'POST'
			},
		  },
		  /* set page size*/
		  serverFiltering: true,
		  //filter: filter,
		  serverSorting: true,
		  /* set default sort */
		});

	  },
	  initReportTypeConfig: function(node, templates) {
		console.log(templates);
		var templs = [];

		templates.forEach(function(el) {
		  if (access.user.Email == el.CreatedBy || el.Public == 1) templs.push(el);
		});

		var configs = [];
		var configsSorted = reference.configs.all.sort((x,y) => x.Label > y.Label ? 1 : (x.Label < y.Label ? -1 : 0));
		configsSorted.filter(x => x.Status == 1).forEach(x => { configs.push(x); });
		configsSorted.filter(x => x.Status != 1).forEach(x => { configs.push(x); });

		var conf = {
		  dom: node.querySelector('.reportBuilderUi'),
		  pages: [
			{
			  nav: false,
			  structure: [
				{
				  group: [
					[
					  {
						label: "Saved Template",
						data: "SavedTemplate",
						type: "select",
						options: templs.map((el) => el.Name),
						values: templs.map(el => el.EntryId)
					  }]
				  ]
				},
				{
				  group: [
					[{
					  label: "Report Type",
					  data: "reportType",
					  type: "select",
					  options: reporting.reportBuilder.reportType.map(el => el.option),
					  values: reporting.reportBuilder.reportType.map(el => el.value)
					},
					 {
					   label: "Intake Form",
					   data: "intakeForm",
					   type: "select",
					   options: configs.map(x => x.Label),
					   values: configs.map(x => x.EntryId)
					 },
					]
				  ]
				}
			  ]
			}],
		  dataset: {},
		};
		nbsf.init(conf, 0);

		//hidden by default
		node.querySelector("[data-name=intakeForm]").closest(".wrapper").style.display = "none";

		reporting.reportBuilder.typeConf = conf;
	  },
	  reportProfiles: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Report_Profiles/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1,
		  serverFiltering: true,
		  serverSorting: true,
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent' && el !== 'uid') {
			  if (reporting.mappingData[el] && reporting.mappingData[el].Title) {
				reporting.reportBuilder.profilesData[el] = reporting.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});
	  },
	  reportCases: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Report_Cases/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1,
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent' && el !== 'uid') {
			  if (reporting.mappingData[el] && reporting.mappingData[el].Title) {
				reporting.reportBuilder.casesData[el] = reporting.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});
	  },
	  reportUsers: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Report_Users/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent') {
			  if (reporting.mappingData[el] && reporting.mappingData[el].Title) {
				reporting.reportBuilder.usersData[el] = reporting.mappingData[el].Title;
			  }
			}
		  });
		  cb();
		});

	  },
	  reportDDQ: function(cb) {
		var ds = new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Report_DDQ/kendo/data/search",
			  type: 'POST'
			},
		  },
		  serverPaging: true,
		  page: 1,
		  pageSize: 1
		});

		ds.read().then(function() {
		  Object.keys(ds.view()[0]).forEach(function(el) {
			if (el !== '_events' && el !== '_handlers' && el !== 'parent') {
			  var temp = "table1285_" + el;
			  if (reporting.mappingData[el] && reporting.mappingData[el].Title)
				reporting.reportBuilder.ddqData[el] = reporting.mappingData[el].Title;
			  else {
				if (reporting.mappingData[temp] && reporting.mappingData[temp].Title) {
				  reporting.reportBuilder.ddqData[el] = reporting.mappingData[temp].Title;
				} else reporting.reportBuilder.ddqData[el] = el;
			  }

			}
		  });
		  cb();
		});
	  },
	  profilesData: {},
	  casesData: {},
	  ddqData: {},
	  selectedFields: [],
	  usersData: {},
	  init: function(node) {
		reporting.reportBuilder.ui(node);
	  },
	  ui: function(node) {
		reporting.reportBuilder.savedTemplate = {};
		reporting.reportBuilder.node = node;
		var templates = [];

		var dataSource = reporting.reportBuilder.savedTemplateDataSource();
		dataSource.read().then(function() {
		  reporting.reportBuilder.templates = dataSource.view();

		  node.innerHTML =
			'<div class="msgBox">' +
			'<p></p>' +
			'<span class="close">×</span>' +
			'</div> ' +
			'<a class="k-button k-button-big reportingBuild-reset" style="margin-left:80%;width:100px;position:absolute;" href="#">Reset</a>' +
			'<section class="reportBuilderUi"></section><section class="scEditor"></section><section class="reportManaging"><div class="content"></div></section>' +
			'<a class="k-button k-button-action reportingBuild-run" style="margin-right:50px;width:100px" href="#">Run</a>' +
			'<a class="k-button k-button-action reportingBuild-save" style="margin-left:15px;width:100px" href="#">Save</a>' +
			'<a class="k-button k-button-big reportingBuild-delete" style="margin-left:15px;width:100px" href="#">Delete</a>' +
			'<section class="reportGrid"></section>';


		  reporting.reportBuilder.initReportTypeConfig(node, reporting.reportBuilder.templates);

		  var editor = node.querySelector('.scEditor');
		  reporting.reportBuilder.scEditor.init(node.querySelector('.scEditor'));
		  reporting.reportBuilder.initRepeatableFieldsConfig(node);
		  reporting.reportBuilder.initReportType(node);


		  node.querySelector('.reportingBuild-save').addEventListener('click', function(ev) {
			reporting.reportBuilder.save();
			ev.preventDefault();
		  });

		  node.querySelector('.reportingBuild-run').addEventListener('click', function(ev) {
			reporting.reportBuilder.run.init(node.querySelector('.reportGrid'));
			ev.preventDefault();
		  });

		  node.querySelector('.reportingBuild-reset').addEventListener('click', function(ev) {
			$('.msgBox').removeClass('err');
			reporting.reportBuilder.typeConf.dataset.reportType = '';
			reporting.reportBuilder.scEditor.selectedFieldsArray = [];
			reporting.reportBuilder.repeatableConf.dataset.from = '';
			reporting.reportBuilder.repeatableConf.dataset.to = '';
			reporting.reportBuilder.typeConf.dataset.intakeForm = '';
			reporting.reportBuilder.init(node);

			ev.preventDefault();
		  });

		  node.querySelector('.reportingBuild-delete').addEventListener('click', function(ev) {
			if (reporting.reportBuilder.savedTemplate && Object.keys(reporting.reportBuilder.savedTemplate).length) {
			  reporting.reportBuilder.delete(function() {
				node.innerHTML = '';
				reporting.reportBuilder.init(node);

			  });
			} else {
			  reporting.reportBuilder.init(node);
			  node.innerHTML = '';
			}
			ev.preventDefault();
		  });

		  node.querySelector('[data-name="SavedTemplate"]').addEventListener('change', function(ev) {
			//var index = node.querySelector('[data-name="SavedTemplate"]').selectedIndex;
			reporting.reportBuilder.templates.forEach(function(el) {
			  if (el.EntryId == ev.target.value) reporting.reportBuilder.savedTemplate = el;
			});
			reporting.reportBuilder.useSavedTemplate(node);
		  });


		});

		reporting.holder().addEventListener('click', function(ev) {
		  if (!ev.target.closest('.rep-popup')) {
			if (reporting.holder().querySelector('.popup-open')) {
			  reporting.holder().querySelectorAll('.rep-popup').forEach(function(el) {
				el.classList.remove('popup-open');
			  });
			}
		  }
		  ev.stopPropagation();

		});
	  },
	  refresh: function(templateId) {
		reporting.reportBuilder.ui(reporting.reportBuilder.node);

		if (templateId) {
		  var select = reporting.reportBuilder.node.querySelector("[data-name=SavedTemplate]");
		  var options = select.options;
		  for (var i = 0; i < options.length; i++)
			if (options[i].value == templateId) {
			  options[i].selected = true;
			  break;
			}

		  select.dispatchEvent(new Event('change'));

		}
	  },
	  getColumnInfo: function(columnName) {
		var columnInfo = reporting.mappingData[columnName];
		if (!columnInfo) {
		  if (reporting.reportBuilder.CurrentReportType == "IntakeForm")
			columnName = "table1285_" + columnName
		  columnInfo = reporting.mappingData[columnName];
		}

		return columnInfo;
	  },
	  useSavedTemplate: function(node) {

		node.querySelector('[data-name="reportType"]').value = reporting.reportBuilder.savedTemplate.Type;
		reporting.reportBuilder.switchType(reporting.reportBuilder.savedTemplate.Type, node, true);

	  },
	  initReportType: function(node) {

		node.querySelector('[data-name="reportType"]').addEventListener('change', function(ev) {
		  mo.fn.overlay.show({
			loading: true,
			close: false
		  });
		  reporting.getReportBuilderReportsColumns(ev.target.value, function() {
			mo.fn.overlay.hide();
			reporting.reportBuilder.initRepeatableFieldsConfig(node);
			reporting.reportBuilder.switchType(ev.target.value, node);
		  });
		});

		node.querySelector('[data-name="intakeForm"]').addEventListener('change', function(ev) {
		  reporting.reportBuilder.initRepeatableFieldsConfig(node);
		  reporting.reportBuilder.switchType("IntakeForm", node);
		});

	  },
	  sortFields: function(arr) {
		var arry = Object.entries(arr);
		var arr_first = [];
		var arr_sec = [];
		var arr_third = [];
		switch (reporting.reportBuilder.CurrentReportType) {
		  case "Profiles":
			reporting.reportBuilder.profilesSorted.forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  case "Cases":
			reporting.reportBuilder.casesSorted.forEach(el => {
			  arry.forEach(opt => {
				if (el == opt[1].replace("  ", " ")) arr_first.push(opt);
			  });
			});
			break;
		  default:
			var arr_first = arry.filter(el => ["table1275_EntryId", "table1275_LegacyId", "table1363_EntryId", "table1363_LegacyId", "table1275_Created"].indexOf(el[0]) >= 0);
			var arr_sec = [];
			var arr_third = arry.filter(el => arr_first.map(x => x[0]).indexOf(el[0]) == -1 && arr_sec.map(x => x[0]).indexOf(el[0]) == -1);
			break;
		}


		return [...arr_first, ...arr_sec, ...arr_third];

	  },
	  switchType: function(data, node, auto) {
		node.querySelector("[data-name=intakeForm]").closest(".wrapper").style.display = "none";

		reporting.reportBuilder.CurrentReportType = data;

		if (document.querySelector(".grid"))
		  document.querySelector(".grid").parentElement.innerHTML = "";

		switch (data) {
		  case 'Profiles':
			reporting.reportBuilder.initAvailableFields(node, reporting.reportBuilder.profilesData, auto);
			break;
		  case 'Cases':
			reporting.reportBuilder.initAvailableFields(node, reporting.reportBuilder.casesData, auto);
			break;
		  case 'Users':
			reporting.reportBuilder.initAvailableFields(node, reporting.reportBuilder.usersData, auto);
			break;
		  case 'DDQ':
			node.querySelector("[data-name=intakeForm]").closest(".wrapper").style.display = "block";
			reporting.reportBuilder.initAvailableFields(node, {}, auto);
			if (reporting.reportBuilder.savedTemplate.SubType)
			  reporting.reportBuilder.switchType("IntakeForm", node, true);
			break;
		  case 'IntakeForm':
			node.querySelector("[data-name=intakeForm]").closest(".wrapper").style.display = "block";

			if (!auto)
			  reporting.reportBuilder.intakeFormId = node.querySelector("[data-name=intakeForm]").selectedOptions[0].value;
			else {
			  reporting.reportBuilder.intakeFormId = reporting.reportBuilder.savedTemplate.SubType;
			  var options = node.querySelector("[data-name=intakeForm]").options;
			  for (var i = 0; i < options.length; i++)
				if (options[i].value == reporting.reportBuilder.intakeFormId) {
				  options[i].selected = true;
				  break;
				}

			}
			reporting.reportBuilder.initAvailableFields(
			  node,
			  reporting.reportBuilder.getColumnsForIntakeForm(reporting.reportBuilder.intakeFormId),
			  auto);
			break;

		}
	  },
	  getColumnsForIntakeForm: function(configId) {

		var configInfo = reporting.configs.find(x => x.EntryId == configId);
		reporting.reportBuilder.CurrentIntakeForm = configInfo;
		var config = util.parseConfigStr(configInfo.Config);

		var ddqPage = config.pages.find(x => x.ddq);

		var columnsInfo = [];

		var tempColumns = [];
		Object.keys(reporting.reportBuilder.ddqData).forEach(x => {
		  if (!x.includes("Standard") && !x.includes("Upload") && !x.includes("LargeColumn") && !x.includes("MinColumn"))
			tempColumns[x] = reporting.reportBuilder.ddqData[x];
		});
		var columns = {};
		for (var p = 0; p < config.pages.length; p++) {
		  var page = config.pages[p];
		  for (var s = 0; s < page.structure.length; s++)
			for (var g = 0; g < page.structure[s].group.length; g++)
			  for (var e = 0; e < page.structure[s].group[g].length; e++) {
				var item = page.structure[s].group[g][e];
				if (item.questionId || item.data == "MinColumn2") {
				  if(item.questionId)
					columns[item.data] = item.questionId;
				  else columns[item.data] = reporting.reportBuilder.ddqData[item.data];
				  columnsInfo.push({
					Item: item,
					ColumnName: item.data
				  });
				} else {
				  Object.keys(tempColumns).forEach(x => {
					var columnNameWoPrefix = x.replace("table1285", "");
					if (item.data == columnNameWoPrefix) {
					  columns[x] = tempColumns[x];
					}
				  });
				}
			  }
		}


		Object.keys(tempColumns).forEach(x => {
		  if (x.includes("table"))
			columns[x] = tempColumns[x];
		});

		var kp = Object.keys(tempColumns).find(x => x.toLowerCase().includes("personnel"));
		if (kp)
		  columns[kp] = tempColumns[kp];

		reporting.reportBuilder.IntakeFormColumnsInfo = columnsInfo;

		return columns;

	  },
	  initAvailableFields: function(node, data, auto) {
		reporting.reportBuilder.scEditor.init(node.querySelector('.scEditor'), data, function(dt) {
		  reporting.reportBuilder.selectedFields = Object.assign({}, dt);
		  reporting.reportBuilder.initRepeatableFieldsConfig(node, dt);

		});
		if (auto) reporting.reportBuilder.scEditor.autoFill(reporting.reportBuilder.savedTemplate, node, function() {
		  reporting.reportBuilder.selectedFields = Object.assign({}, JSON.parse(reporting.reportBuilder.savedTemplate.Fields));
		  reporting.reportBuilder.initRepeatableFieldsConfig(node, reporting.reportBuilder.selectedFields, reporting.reportBuilder.savedTemplate, true);
		});
	  },
	  initRepeatableFieldsConfig: function(node, options, data, autoPopulate) {

		var cols, dates = [],
			displayPublic;
		if (typeof options == 'object') {
		  for (const [key, value] of Object.entries(options)) {
			var mapping = reporting.mappingData[key];
			//custom logic for DDQ Reports to get aliases for columns
			if (!mapping)
			  mapping = reporting.mappingData["table1285_" + key];
			if (mapping && mapping.Type == 'Date') dates.push(reporting.mappingData[key].Title);
		  }

		  cols = Object.values(options);

		} else cols = options;
		node.querySelector('.reportManaging').innerHTML = '<div class="content"></div>';

		var conf2 = {
		  dom: node.querySelector('.reportManaging .content'),
		  pages: [{
			nav: false,
			structure: [{
			  header: 'Sorting',
			  group: [
				[]
			  ]
			},
						{
						  repeatable: "sorting",
						  repeatableLimit: 10,
						  group: [
							[{
							  label: "Column",
							  data: "column",
							  type: "text",
							  placeholder: 'Select one'
							  //options: cols ? cols : [],
							  //values: cols ? cols : []
							},
							 {
							   label: "Direction",
							   data: "direction",
							   type: "select",
							   options: ['Ascending', 'Descending'],
							   values: ['asc', 'desc']
							 },

							]
						  ],
						  callback: function() {},

						},
						{
						  header: 'Filters',
						  description: "Interval",
						  group: [
							[{
							  label: "Date Range",
							  data: "dateRange",
							  type: "select",
							  options: reporting.reportBuilder.dateRange.map(el => el.option),
							  values: reporting.reportBuilder.dateRange.map(el => el.value)
							},
							 {
							   label: "on",
							   data: "on",
							   type: "text",
							   placeholder: 'Select one'
							   //options: dates ? dates: [],
							   // values: dates ? dates: []
							 },
							]
						  ]
						},
						{

						  group: [
							[{
							  label: "Start",
							  data: "from",
							  type: "datetime",
							  placeholder: "Select a date",
							  dtp: {
								format: 'Y-m-d',
								timepicker: false,
								formatDate: 'Y-m-d',
								scrollMonth: false,
								scrollInput: false,
								onChangeDateTime: function(dp, $input) {}
							  }
							},
							 {
							   label: "End",
							   data: "to",
							   type: "datetime",
							   placeholder: "Select a date",
							   dtp: {
								 format: 'Y-m-d',
								 formatDate: 'Y-m-d',
								 timepicker: false,
								 scrollMonth: false,
								 scrollInput: false,
								 onChangeDateTime: function(dp, $input) {}
							   }
							 },
							]
						  ]
						},
						{
						  description: "Additional filters",
						  repeatable: "filters",
						  repeatableLimit: 10,
						  group: [
							[{
							  label: "Column",
							  data: "column",
							  type: "text",
							  placeholder: 'Select one'
							},
							 {
							   label: "Operator",
							   data: "operator",
							   type: "select",
							   options: reporting.reportBuilder.kendoOperators.map(el => el.option),
							   values: reporting.reportBuilder.kendoOperators.map(el => el.value)
							 },
							 {
							   label: "Value",
							   data: "value",
							   type: "text",
							   onChange: function() {}
							 }
							]
						  ],
						  callback: function() {},

						},
					   ],
			callback: function() {
			  node.querySelector('[data-name="from"]').insertAdjacentHTML('afterend', '<div class="rep-clear-dp">Clear</div>');
			  node.querySelector('[data-name="to"]').insertAdjacentHTML('afterend', '<div class="rep-clear-dp">Clear</div>');

			  node.querySelector('[data-rname="sorting"]').previousSibling.querySelector('.heading').insertAdjacentHTML('afterend', '<div class="rep-sort-clear">Clear Sorting</div>');
			  node.querySelector('[data-rname="sorting"]').nextSibling.querySelector('.heading').insertAdjacentHTML('afterend', '<div class="rep-date-filters-clear">Clear Date Filters</div>');
			  node.querySelectorAll('.heading')[2].insertAdjacentHTML('afterend', '<div class="rep-extra-filters-clear">Clear Filters</div>');

			  node.querySelectorAll('.rep-clear-dp').forEach(function(el) {
				el.addEventListener('click', function(ev) {
				  ev.target.parentNode.querySelector('input').value = '';
				  ev.preventDefault();
				  ev.stopPropagation();
				});
			  });


			  util.initPopup(node.querySelector('[data-name="on"]'), dates);
			  Array.from(node.querySelectorAll('[data-rname="sorting"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.select, .wrapper.text')).forEach(function(d, index) {
				  if (cols && cols.length) {

					if (d.querySelector('[data-name="column"]')) {
					  var arr = [...cols];
					  util.initPopup(d.querySelector('[data-name="column"]'), arr);

					}
				  }

				});
			  });
			  Array.from(node.querySelectorAll('[data-rname="filters"]')).forEach(function(el) {
				Array.from(el.querySelectorAll('.wrapper.select, .wrapper.text')).forEach(function(d, index) {
				  if (cols && cols.length) {
					if (d.querySelector('[data-name="column"]')) {
					  var arr = [...cols];
					  util.initPopup(d.querySelector('[data-name="column"]'), arr);

					}
				  }
				});
			  });


			  reporting.holder().querySelector('.reportManaging').addEventListener('click', function(ev) {
				if (ev.target.closest(".repeater") && !ev.target.classList.contains('rem')) {
				  if (cols && cols.length) {
					var el = ev.target.closest('.repeater').parentNode.nextSibling;

					if (el.querySelector('[data-name="column"]')) {
					  var arr = [...cols];
					  util.initPopup(el.querySelector('[data-name="column"]'), arr);


					}
				  }
				} else if (ev.target.classList.contains('rep-sort-clear')) {
				  //Clear sorting for inputs and selects
				  node.querySelectorAll('[data-rname="sorting"]').forEach(function(el) {
					el.querySelectorAll('.wrapper.select, .wrapper.text').forEach(function(d) {
					  if (d.classList.contains('text')) d.querySelector('input').value = '';
					  if (d.classList.contains('select')) d.querySelector('select').value = '';
					});
					ev.preventDefault();
					ev.stopPropagation();
				  });
				}
				//Clear filters, datepickers, interval
				else if (ev.target.classList.contains('rep-date-filters-clear')) {
				  ev.target.parentNode.querySelectorAll('.wrapper.select, .wrapper.text').forEach(function(d, index) {
					if (d.classList.contains('text')) d.querySelector('input').value = '';
					if (d.classList.contains('select')) d.querySelector('select').value = '';
				  });
				  node.querySelectorAll('.rep-clear-dp').forEach(function(e) {
					e.click();
				  });

				} else if (ev.target.classList.contains('rep-extra-filters-clear')) {
				  Array.from(node.querySelectorAll('[data-rname="filters"]')).forEach(function(el) {
					Array.from(el.querySelectorAll('.wrapper.select, .wrapper.text')).forEach(function(d, index) {
					  if (d.classList.contains('text')) d.querySelector('input').value = '';
					  if (d.classList.contains('select')) d.querySelector('select').value = '';
					});
				  });
				}
			  }, false);
			},

		  }],
		  dataset: {},
		};


		displayPublic = [{
		  label: "Template name",
		  data: "templateName",
		  type: "text"
		},
						 {
						   label: "Public",
						   data: "public",
						   type: "toggle",
						   values: ['0', '1']
						 },
						];


		if (autoPopulate) {
		  data = reporting.reportBuilder.savedTemplate;

		  if (access.user.Email !== data.CreatedBy) {
			displayPublic = [{
			  label: "Template name",
			  data: "templateName",
			  type: "text"
			}]
		  }

		  conf2.dataset = {
			filters: data.Filters,
			sorting: data.Sorting,
			templateName: data.Name,
			public: String(data.Public),
			dateRange: data.DateRange,
			on: data.DtRangeOn
		  };

		}

		conf2.pages[0].structure.push({
		  header: 'Report',
		  group: [
			displayPublic
		  ]
		}, );

		nbsf.init(conf2, 0);



		if (autoPopulate) reporting.reportBuilder.switchDateRange(data.DateRange, node);
		node.querySelector('[data-name="dateRange"]').addEventListener('change', function(ev) {
		  reporting.reportBuilder.switchDateRange(ev.target.value, node);

		  //node.querySelector('[data-name="from"]'). value = '2021-10-06 16:11';

		});


		if (!autoPopulate)
		  document.querySelector("[data-name=operator]").value = "contains";

		reporting.reportBuilder.repeatableConf = conf2;
		reporting.reportBuilder.getFiltersValue(node, options);

	  },
	  switchDateRange: function(val, node) {
		var pd = new Date(),
			ad = new Date();
		switch (val) {
		  case 'past1mon':
			pd.setMonth(pd.getMonth() - 1);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];
			break;
		  case 'past3mon':
			pd.setMonth(pd.getMonth() - 3);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'past6mon':
			pd.setMonth(pd.getMonth() - 6);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];
			break;
		  case 'past12mon':
			pd.setMonth(pd.getMonth() - 12);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'mtd':
			var firstD;
			firstD = new Date(pd.getFullYear(), pd.getMonth(), 2);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'qtd':

			var quarter = Math.floor((pd.getMonth() / 3)),
				startDate,
				startDate = new Date(pd.getFullYear(), quarter * 3, 2);

			node.querySelector('[data-name="from"]').value = startDate.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'ytd':
			var firstD;
			firstD = new Date(pd.getFullYear(), 0, 2);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];
			break;
		  case 'prevday':


			var firstD;
			firstD = new Date(new Date().setDate(pd.getDate() - 1));
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = firstD.toISOString().split('T')[0];

			break;
		  case 'prevweek':

			var pastDate, aux, ad = new Date(new Date().setDate(new Date().getDate() - 1));
			aux = new Date().getDate() - 7;
			pastDate = new Date().setDate(aux);
			pastDate = new Date(pastDate);
			node.querySelector('[data-name="from"]').value = pastDate.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'prevmon':
			var firstD, lastD;
			firstD = new Date(pd.getFullYear(), pd.getMonth() - 1, 2);
			lastD = new Date(ad.getFullYear(), ad.getMonth(), 1);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = lastD.toISOString().split('T')[0];

			break;
		  case 'prevqtr':

			var today = new Date(),
				quarter = Math.floor((today.getMonth() / 3)),
				startDate,
				endDate;
			startDate = new Date(today.getFullYear(), quarter * 3 - 3, 2);
			endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 3, 1);
			node.querySelector('[data-name="from"]').value = startDate.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = endDate.toISOString().split('T')[0];

			break;
		  case 'prevyr':
			var firstD, pd = new Date(),
				lastD;
			firstD = new Date(new Date().getFullYear() - 1, 0, 2);
			lastD = new Date(new Date().getFullYear() - 1, 12, 1, 1);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = lastD.toISOString().split('T')[0];

			break;
		  case 'all':
			var pd = new Date();

			node.querySelector('[data-name="from"]').value = '';
			node.querySelector('[data-name="to"]').value = pd.toISOString().split('T')[0];

			break;
		  case 'custom':
			var pd = new Date();

			node.querySelector('[data-name="from"]').value = '';
			node.querySelector('[data-name="to"]').value = pd.toISOString().split('T')[0];

			break;
		}

	  },
	  getFiltersValue: function(node, options) {
		node.querySelector('.reportManaging .content').addEventListener('click', function(ev) {
		  var index;

		  if (ev.target.getAttribute('data-name') == 'value') {

			//Get index of filter 

			node.querySelectorAll('[data-name="value"]').forEach(function(el, ind) {
			  if (ev.target == el) index = ind;
			});

			nbsf.data.update(reporting.reportBuilder.repeatableConf, {});
			var filter = JSON.parse(reporting.reportBuilder.repeatableConf.dataset.filters)[index];
			for (const [key, value] of Object.entries(options)) {
			  if (filter.column !== 'Select one') {
				if (filter.column == value.replace('  ', ' ')) {
				  reporting.reportBuilder.value.init(key, function(resp) {
					ev.target.value = resp;
				  });
				}
			  }

			}
		  }
		});

	  },
	  delete: function(callback) {
		mo.fn.overlay.show();
		mo.fn.modal.show({
		  ctaLabel: "Yes",
		  class: "ark-modal",
		  title: "Delete template",
		  content: "Are you sure you want to delete template?",
		  ctaCallback: function() {
			crud.destroy('4054', reporting.reportBuilder.savedTemplate.EntryId, function(d) {
			  if (callback && typeof callback == 'function') callback();
			  mo.fn.modal.hide();
			  mo.fn.overlay.hide();
			});

		  }
		});

	  },
	  save: function() {
		nbsf.data.update(reporting.reportBuilder.typeConf, {});
		nbsf.data.update(reporting.reportBuilder.repeatableConf, {});

		var typeConf = reporting.reportBuilder.typeConf.dataset;
		var repeatableConf = reporting.reportBuilder.repeatableConf.dataset;

		var sData = {
		  Type: typeConf.reportType,
		  SubType: typeConf.intakeForm !== 'Select one' ? typeConf.intakeForm : '',
		  Filters: repeatableConf.filters,
		  Sorting: repeatableConf.sorting,
		  Fields: JSON.stringify(reporting.reportBuilder.scEditor.selectedFields),
		  Name: repeatableConf.templateName,
		  Public: reporting.reportBuilder.repeatableConf.dataset.public,
		  DateRange: reporting.reportBuilder.repeatableConf.dataset.dateRange,
		  DtRangeOn: reporting.reportBuilder.repeatableConf.dataset.on
		};

		if (!repeatableConf.templateName) {
		  mo.fn.modal.show({
			ctaLabel: "OK",
			class: "ark-modal",
			title: "Error",
			content: "<p>Please provide template name.</p>"
		  });

		} else {
		  if (reporting.reportBuilder.savedTemplate && reporting.reportBuilder.savedTemplate.EntryId) {
			crud.update('4042', reporting.reportBuilder.savedTemplate.EntryId, sData, function(d) {

			  console.log(d);
			  mo.fn.modal.show({
				ctaLabel: "OK",
				class: "ark-modal",
				title: "Success!",
				content: "<p>Report template updated.</p>"
			  });


			  var template = reporting.reportBuilder.templates.find(x => x.EntryId = d.EntryId);
			  if (template) {
				var idx = reporting.reportBuilder.templates.indexOf(template);
				reporting.reportBuilder.templates[idx] = d;
				reporting.reportBuilder.node.querySelector('[data-name="SavedTemplate"]').options[idx].Name = d.Name;
			  }


			});
		  } else {

			crud.create('4041', sData, function(d) {
			  console.log(d);
			  mo.fn.modal.show({
				ctaLabel: "OK",
				class: "ark-modal",
				title: "Success!",
				content: "<p>Report template created.</p>"
			  });

			  reporting.reportBuilder.templates.push(d);

			  var opt = document.createElement('option');
			  opt.value = d.EntryId;
			  opt.innerHTML = d.Name;
			  reporting.reportBuilder.node.querySelector('[data-name="SavedTemplate"]').appendChild(opt);
			});
		  }
		}

	  },
	  value: {
		data: {
		  options: [],
		  uniqueValues: []
		},
		_foundCompletedValue: function(values) {
		  for (var i = 0; i < values.length; i++) {
			if (values[i].value) {
			  return values[i].value
			}
		  }
		  return null;
		},
		_foundObjectInsideObject: function(object) {
		  var finalRes;
		  if (typeof object == 'string') finalRes = JSON.parse(object);
		  if (Array.isArray(finalRes) && finalRes.length) finalRes = finalRes[0];
		  if (finalRes && Object.keys(finalRes).length) {
			for (const [key, value] of Object.entries(finalRes)) {
			  if (util.isJson(value)) {
				return true;
			  }
			}
		  }
		  return false;
		},
		init: function(columnName, callback) {

		  var columnInfo = reporting.reportBuilder.getColumnInfo(columnName);

		  switch (columnInfo.Type) {
			case "Date":
			  reporting.reportBuilder.value.dateModal(function(filter) {
				callback(filter);
			  });
			  break;
			case "CheckboxList":
			  var splitedColumn, checkedValue, checkedState = false,
				  checkCountry;
			  reporting.reportBuilder.value.data.options = [];
			  splitedColumn = columnName.split('_'); //Split column value to insert it into apiCall		

			  util.getUnqiueValues(columnInfo.UniqueValuesDataSet, columnName, function(values) { //Get unique values
				if (values && values.length) {
				  reporting.reportBuilder.value.data.uniqueValues = values;

				  reporting.reportBuilder.value.data.uniqueValues.forEach(function(val) {
					checkedValue = val.value;
					if (checkedValue) {
					  if (util.isJson(checkedValue)) { //arrays or objects
						checkedValue = JSON.parse(checkedValue);
						reporting.reportBuilder.value.isObject.init(checkedValue, columnName, function(typ) {
						  if (checkedValue && checkedValue.length) reporting.reportBuilder.value.data.options.push({
							value: checkedValue
						  });

						});
					  } else { //simplevalues
						if (checkedValue) reporting.reportBuilder.value.data.options.push({
						  value: checkedValue
						});
					  }
					}
				  });

				  reporting.reportBuilder.value.stringModal(reporting.reportBuilder.value.data.options, checkedState, function(filter) {
					callback(filter);
				  });

				}
			  });


			  break;
			default:
			  reporting.reportBuilder.value.stringModal([], checkedState, function(filter) {
				callback(filter);
			  });
			  break;

		  }
		  /* 
                        var columnInfo = reporting.mappingData[columnName];
                        if(!columnInfo)
                        {
                          if(reporting.reportBuilder.CurrentReportType == "IntakeForm")
                            columnName = "table1285_" + columnName
                          columnInfo = reporting.mappingData[columnName];
                        }

                        if(columnInfo.Type == 'Date') {
                          reporting.reportBuilder.value.dateModal(function(filter) {
                            callback(filter);
                          });
                        }
                        else {
                          var splitedColumn, checkedValue, checkedState = false, checkCountry;
                          reporting.reportBuilder.value.data.options = []; 
                          splitedColumn = columnName.split('_'); //Split column value to insert it into apiCall		
                          if(splitedColumn[1] == 'State') checkedState = true;
                          util.getUnqiueValues('form_data_table_' + splitedColumn[0].substr(5), splitedColumn[1], function(values){ //Get unique values
                            if(values && values.length) {	

                              reporting.reportBuilder.value.data.uniqueValues = values;
                              console.log(reporting.reportBuilder.value.data.uniqueValues);

                              reporting.reportBuilder.value.data.uniqueValues.forEach(function(val) {
                                checkedValue = val.value;
                                if(checkedValue) {
                                  if(util.isJson(checkedValue)) { //arrays or objects
                                    checkedValue = JSON.parse(checkedValue);
                                    reporting.reportBuilder.value.isObject.init(checkedValue, columnName, function(typ) {
                                      if(checkedValue && checkedValue.length) reporting.reportBuilder.value.data.options.push({value:checkedValue});

                                    });		   
                                  }
                                  else { //simplevalues
                                    if(checkedValue) reporting.reportBuilder.value.data.options.push({value:checkedValue});		   
                                  }
                                }
                              });

                            } 

                            reporting.reportBuilder.value.stringModal(reporting.reportBuilder.value.data.options, checkedState, function(filter) {
                              callback(filter);
                            });

                          });
                        }*/
		},
		dateModal: function(callback) {
		  var conf = '';
		  mo.fn.modal.show({
			ctaLabel: 'OK',
			title: 'Date time filter',
			class: "ark-modal",
			content: '<div class="date_time_filter" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {

			  conf = {
				dom: document.querySelector('.date_time_filter'),
				pages: [{
				  nav: false,
				  structure: [{
					group: [
					  [{
						label: "Date",
						data: "date",
						type: "datetime",
						placeholder: "Select a date",
						dtp: {
						  format: 'Y-m-d',
						  timepicker: false,
						  formatDate: 'Y-m-d',
						  scrollMonth: false,
						  scrollInput: false,
						  onChangeDateTime: function(dp, $input) {}
						}
					  }, ]
					]
				  }]
				}],
				dataset: {},
			  };
			  nbsf.init(conf, 0);
			  mo.fn.overlay.show({
				close: false,
				loading: true
			  })
			},
			ctaCallback: function() {
			  nbsf.data.update(conf, {});
			  callback(conf.dataset.date);
			  mo.fn.modal.hide();
			}
		  });
		},
		stringModal: function(options, state, callback) {
		  var conf;
		  mo.fn.modal.show({
			ctaLabel: 'OK',
			title: 'Filters',
			class: "ark-modal",
			content: '<div class="multiple_values_filter" style="overflow:auto;padding-bottom:10px;max-width:100%;white-space: nowrap;"></div>',
			contentCallback: function() {
			  var node = document.querySelector('.multiple_values_filter');
			  conf = {
				dom: node,
				pages: [{
				  nav: false,
				  structure: [{
					description: "Custom filter string",
					group: [
					  [{
						label: "Provide the filter string",
						data: "custom",
						required: false,
						type: "text"

					  }, ]
					]
				  }]
				}],
				dataset: {},
				callback: function() {}
			  };

			  if (options && options.length) {
				conf.pages[0].structure.push({
				  description: "OR",
				  group: [
					[

					]
				  ]
				});
				conf.pages[0].structure.push({
				  description: "Select values",
				  group: [
					[{
					  //label: " ",
					  data: "multipleFiltersString",
					  required: false,
					  type: "checkbox",
					  values: options.map(el => el.value || []),
					  options: options.map(el => reference.convertAll(el.option, state) || reference.convertAll(el.value, state) || [])
					}, ]
				  ]
				});
			  }

			  nbsf.init(conf, 0);

			  var headings = node.querySelectorAll('.heading p');
			  headings.forEach(x => {
				x.style.fontWeight = 600;
				x.style.fontSize = "18px";

				if (headings[headings.length - 1] == x)
				  x.parentElement.style.marginBottom = "0px";
			  });

			  if (options && options.length) {

				var rows = node.querySelectorAll('.row');
				rows[0].style.marginBottom = "40px";
				rows[1].style.marginBottom = "20px";


				var heading = rows[2].querySelector(".heading");
				if (heading) {
				  var divButtons = '<div  style="margin-top: 10px;margin-left: -15px;">' +
					  '<div class="k-button k-button-big reportingBuild-checkAll" style="margin-left:15px;width:100px">Select All</div>' +
					  '<div class="k-button k-button-big reportingBuild-uncheckAll" style="margin-left:15px;width:100px">Deselect All</div>' +
					  '</div>';

				  heading.innerHTML += divButtons;

				  heading.querySelector(".reportingBuild-checkAll").addEventListener('click', function(ev) {
					var wrap = node.querySelectorAll('.multiple_values_filter .wrapper.checkbox')[0];
					wrap.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
					  el.checked = true;
					})
				  });
				  heading.querySelector(".reportingBuild-uncheckAll").addEventListener('click', function(ev) {
					var wrap = node.querySelectorAll('.multiple_values_filter .wrapper.checkbox')[0];
					wrap.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
					  el.checked = false;
					})
				  });

				}
			  }

			  mo.fn.overlay.show({
				close: false
			  })
			},
			ctaCallback: function() {
			  nbsf.data.update(conf, {});
			  var custom = conf.dataset.custom || '';
			  console.log(conf.dataset.multipleFiltersString);
			  var values = conf.dataset.multipleFiltersString || '';
			  //getFilters = (getFilters && getFilters !== 'null') ?  getFilters+= ','+conf.dataset.multipleFiltersString.join(',') : conf.dataset.multipleFiltersString.split(' ').join(',');
			  var final = custom && values ? custom + ',' + values : custom ? custom : values ? values : '';
			  callback(final);
			  mo.fn.modal.hide();
			}
		  });
		},
		isObject: {
		  init: function(checkedValue, columnName, callback) {
			var mainValue = checkedValue;

			// check type of object
			if (Array.isArray(mainValue) && mainValue.length) { //array with objects or array with strings
			  mainValue.forEach(function(el) {
				if (util.isJson(el)) {
				  reporting.reportBuilder.value.isObject.parseObject(mainValue, function() {
					if (callback && typeof callback == 'function') callback();
					return;
				  });
				} else { //just strings
				  var stringFromArray, arrVal;
				  arrVal = mainValue.join(',');
				  if (arrVal && arrVal.length) reporting.reportBuilder.value.data.options.push({
					value: arrVal
				  });
				}
			  })
			} else if (typeof mainValue == 'object') {
			  reporting.reportBuilder.value.isObject.parseObject(mainValue, function() {
				if (callback && typeof callback == 'function') callback();
				return;
			  });
			}

		  },
		  parseObject: function(value, callback) {

			var is_obj_inside = reporting.reportBuilder.value._foundObjectInsideObject(value);
			if (is_obj_inside) { //Complicated object, display it as it is 
			  if (callback && typeof callback == 'function') callback();
			  return;
			} else {

			  if (value && value.length || value && Object.keys(value)) {
				var aux = value;
				var fakeValue = '';
				if (Array.isArray(aux)) { //is Array inside
				  aux.forEach(function(innerObj, index) {
					if (typeof innerObj == 'object' && Object.keys(innerObj).length) {
					  for (const [key, value] of Object.entries(innerObj)) {
						if (value && value.length) {
						  if (Array.isArray(value)) {
							value.forEach(function(el) {
							  fakeValue += ', ' + value;
							})
						  } else fakeValue += ', ' + value;
						}
					  }
					  if (aux[index + 1]) fakeValue += ', ';
					} else {
					  fakeValue += ', ' + innerObj;
					}

				  });
				} else { // is just the object
				  for (const [key, value] of Object.entries(aux)) {
					if (value && value.length) {
					  if (Array.isArray(value)) {
						value.forEach(function(el) {
						  fakeValue += ', ' + value;
						})
					  } else fakeValue += ', ' + value;
					}
				  }
				}
				if (fakeValue && fakeValue.length) reporting.reportBuilder.value.data.options.push({
				  value: fakeValue
				});
			  }

			}
		  },

		},
		updateTypeOfColumn: function(eid, type) { //If no type in database, update it
		  crud.update('4075', eid, {
			Type: type
		  }, function(d) {
			console.log(d);
		  });
		},
	  },
	  scEditor: {
		availableFields: {},
		selectedFields: {},
		activeAvailable: {},
		activeSelected: {},
		leftPanel: '',
		rightPanel: '',
		reset: function() {
		  reporting.reportBuilder.scEditor.availableFields = {};
		  reporting.reportBuilder.scEditor.selectedFields = {};
		  reporting.reportBuilder.scEditor.activeAvailable = {};
		  reporting.reportBuilder.scEditor.activeSelected = {};
		},
		init: function(node, data, callback) {
		  reporting.reportBuilder.scEditor.reset();

		  if (data) reporting.reportBuilder.scEditor.availableFields = Object.assign({}, data); //Object.keys(data).map(el => el.split('_')[1]);
		  node.innerHTML = reporting.reportBuilder.scEditor.template();

		  reporting.reportBuilder.scEditor.leftPanel = node.querySelector('.scEditor__left__panel select');
		  reporting.reportBuilder.scEditor.rightPanel = node.querySelector('.scEditor__right__panel select');

		  node.querySelector('.scEditor__leftArr').addEventListener('click', function(ev) {
			reporting.reportBuilder.scEditor.arrowLeft(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__rightArr').addEventListener('click', function() {
			reporting.reportBuilder.scEditor.arrowRight(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__upArr').addEventListener('click', function(ev) {
			reporting.reportBuilder.scEditor.arrowUp(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.scEditor__downArr').addEventListener('click', function() {
			reporting.reportBuilder.scEditor.arrowDown(node, function(d) {
			  callback(d);
			});
		  });

		  node.querySelector('.available_fields-filter').addEventListener('input', function(e) {
			reporting.reportBuilder.scEditor.onFilter(e.target.value);
		  });

		  reporting.reportBuilder.scEditor.addOptions();

		},
		template: function(node) {
		  return '<section class="scEditor__wrapper">' +
			'<div class="scEditor__left">' +
			'<h4>Available fields</h4>' +
			'<div class="header"><input placeholder="Quick filter" class="available_fields-filter"> </div>' +
			'<div class="scEditor__left__panel">' +
			'<select multiple="true"></select>' +
			'</div>' +
			'</div>' +
			'<div class="scEditor__arrows">' +
			'<svg class="scEditor__rightArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret next" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="6 2 18 12 6 22"></polygon></svg>' +
			'<svg class="scEditor__leftArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret previous" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="6 2 18 12 6 22" transform="matrix(-1 0 0 1 24 0)"></polygon></svg>' +
			'</div>' +
			'<div class="scEditor__right">' +
			'<h4>Fields in report</h4>' +
			'<div class="header"></div>' +
			'<div class="scEditor__right__panel">' +
			'<select multiple="true"></select>' +
			'</div>' +
			'</div>' +
			'<div class="scEditor__arrows" style="margin-left: 10px;">' +
			'<svg class="scEditor__upArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret up" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 4 12 16 2 4" transform="matrix(1 0 0 -1 0 20)"></polygon></svg>' +
			'<svg class="scEditor__downArr" version="1.1" viewBox="0 0 24 24" role="img" aria-label="caret down" width="40px" height="40px"><polygon fill="none" stroke="#666" stroke-width="2" points="22 8 12 20 2 8"></polygon></svg>' +
			'</div>' +
			'</section>';
		},
		arrowLeft: function(node, callback) {

		  var toDelete = [];
		  var length = reporting.reportBuilder.scEditor.rightPanel.selectedOptions.length;
		  for (var i = 0; i < length; i++) {
			var x = reporting.reportBuilder.scEditor.rightPanel.selectedOptions[i];
			var opt = document.createElement('option');
			opt.value = x.value;
			opt.innerHTML = x.innerHTML;
			reporting.reportBuilder.scEditor.leftPanel.appendChild(opt);

			toDelete.push(x);
		  }
		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < reporting.reportBuilder.scEditor.rightPanel.options.length; j++) {
			  if (!reporting.reportBuilder.scEditor.rightPanel.options[j])
				debugger;
			  if (reporting.reportBuilder.scEditor.rightPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			reporting.reportBuilder.scEditor.rightPanel.remove(idx);
		  });

		  reporting.reportBuilder.scEditor.updateSelectedArray();

		  if (callback && typeof callback == 'function') callback(reporting.reportBuilder.scEditor.selectedFields);
		},
		arrowRight: function(node, callback) {

		  var toDelete = [];
		  var lenght = reporting.reportBuilder.scEditor.leftPanel.selectedOptions.length;
		  for (var i = 0; i < lenght; i++) {
			var x = reporting.reportBuilder.scEditor.leftPanel.selectedOptions[i];

			var opt = document.createElement('option');
			opt.value = x.value;
			opt.innerHTML = x.innerHTML;
			reporting.reportBuilder.scEditor.rightPanel.appendChild(opt);

			toDelete.push(x);
		  }

		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < reporting.reportBuilder.scEditor.leftPanel.options.length; j++) {
			  if (reporting.reportBuilder.scEditor.leftPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			reporting.reportBuilder.scEditor.leftPanel.remove(idx);
		  });

		  reporting.reportBuilder.scEditor.updateSelectedArray();

		  if (callback && typeof callback == 'function') callback(reporting.reportBuilder.scEditor.selectedFields);

		},
		arrowUp: function() {
		  var select = reporting.reportBuilder.scEditor.rightPanel;
		  var length = select.selectedOptions.length;
		  if (length == 0)
			return;

		  for (var i = 0; i < length; i++) {
			var x = select.selectedOptions[i];

			for (var j = 0; j < select.options.length; j++) {
			  if (select.options[j].value == x.value) {
				var idx = j;
				if (j - 1 >= 0)
				  select.insertBefore(select.options[j], select.options[j - 1])
				break;
			  }
			}

		  }

		  reporting.reportBuilder.scEditor.updateSelectedArray();

		},
		arrowDown: function() {
		  var select = reporting.reportBuilder.scEditor.rightPanel;
		  var length = select.selectedOptions.length;
		  if (length == 0)
			return;

		  for (var i = 0; i < length; i++) {
			var x = select.selectedOptions[i];

			for (var j = 0; j < select.options.length; j++) {
			  if (select.options[j].value == x.value) {
				var idx = j;
				if (j + 2 == select.options.length)
				  select.appendChild(select.options[j]);
				//if(j + 1 < select.options.length)
				else select.insertBefore(select.options[j], select.options[j + 2])
				break;
			  }
			}

		  }

		  reporting.reportBuilder.scEditor.updateSelectedArray();
		},
		onFilter: function(text) {
		  var options = reporting.reportBuilder.scEditor.leftPanel.options;
		  for (var i = 0; i < options.length; i++) {
			if (!text)
			  options[i].removeAttribute("hidden");
			else {
			  if (options[i].innerHTML.toLowerCase().includes(text.toLowerCase()))
				options[i].removeAttribute("hidden");
			  else options[i].hidden = "hidden";
			}
		  }
		},
		updateSelectedArray: function() {
		  var opts = reporting.reportBuilder.scEditor.rightPanel.options;

		  reporting.reportBuilder.scEditor.selectedFields = {};
		  reporting.reportBuilder.scEditor.selectedFieldsArray = [];

		  for (var i = 0; i < opts.length; i++) {
			reporting.reportBuilder.scEditor.selectedFields[opts[i].value] = opts[i].innerHTML;
			reporting.reportBuilder.scEditor.selectedFieldsArray.push({
			  field: opts[i].value,
			  title: opts[i].innerHTML
			});
		  }

		},
		addOptions: function(node) {
		  var obj = Object.assign({}, reporting.reportBuilder.scEditor.availableFields);
		  var keysSorted = reporting.reportBuilder.sortFields(obj); //Object.keys(obj).sort(function(a,b){return ((obj[a] > obj[b]) ? 1 : ((obj[b] > obj[a]) ? -1 : 0))});

		  keysSorted.forEach(x => {
			var opt = document.createElement('option');
			opt.value = x[0];
			opt.innerHTML = x[1];
			reporting.reportBuilder.scEditor.leftPanel.appendChild(opt);
		  });
		},
		autoFill: function(data, node, callback) {
		  reporting.reportBuilder.scEditor.activeAvailable = JSON.parse(data.Fields);

		  var keys = Object.keys(reporting.reportBuilder.scEditor.activeAvailable);
		  var options = reporting.reportBuilder.scEditor.leftPanel.options;
		  var toDelete = [];
		  keys.forEach(key => {
			for (var i = 0; i < options.length; i++)
			  if (options[i].value == key) {
				toDelete.push(options[i]);
				break;
			  }

			var opt = document.createElement('option');
			opt.value = key;
			opt.innerHTML = reporting.reportBuilder.scEditor.activeAvailable[key];
			reporting.reportBuilder.scEditor.rightPanel.appendChild(opt);
		  });

		  toDelete.forEach(option => {

			var idx = -1;
			for (var j = 0; j < reporting.reportBuilder.scEditor.leftPanel.options.length; j++) {
			  if (reporting.reportBuilder.scEditor.leftPanel.options[j].value == option.value) {
				idx = j;
				break;
			  }
			}

			reporting.reportBuilder.scEditor.leftPanel.remove(idx);
		  });

		  reporting.reportBuilder.scEditor.updateSelectedArray();


		  if (callback && typeof callback == 'function') callback();

		}
	  },
	  run: {
		stopTimer: false,
		init: function(node) {
		  node.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div></div><div class="grid"><div class="innerGrid"></div></div>';
		  nbsf.data.update(reporting.reportBuilder.typeConf, {});
		  nbsf.data.update(reporting.reportBuilder.repeatableConf, {});
		  var filtersArray = JSON.parse(reporting.reportBuilder.repeatableConf.dataset.filters);
		  console.log(filtersArray);
		  var sortingArray = JSON.parse(reporting.reportBuilder.repeatableConf.dataset.sorting);
		  var path = reporting.reportBuilder.typeConf.dataset.reportType;
		  var sorting = [],
			  filter = {
				logic: "and",
				filters: []
			  };
		  if (reporting.reportBuilder.repeatableConf.dataset.on) {
			for (var i = 0; i < reporting.reportBuilder.scEditor.selectedFieldsArray.length; i++) {
			  if (reporting.reportBuilder.repeatableConf.dataset.on == reporting.reportBuilder.scEditor.selectedFieldsArray[i].title.replace('  ', ' ')) {
				var dateRange = {
				  logic: "and",
				  filters: []
				};
				if (reporting.reportBuilder.repeatableConf.dataset.from) dateRange.filters.push({
				  field: reporting.reportBuilder.scEditor.selectedFieldsArray[i].field,
				  operator: "gte",
				  value: reporting.reportBuilder.repeatableConf.dataset.from
				});
				if (reporting.reportBuilder.repeatableConf.dataset.to) dateRange.filters.push({
				  field: reporting.reportBuilder.scEditor.selectedFieldsArray[i].field,
				  operator: "lte",
				  value: reporting.reportBuilder.repeatableConf.dataset.to + 'T23:59:59'
				})
				filter.filters.push(dateRange);
			  }
			}
		  }

		  var filterValue = true;
		  var operatorValue = true;
		  filtersArray.forEach(function(el) {
			if (el.value && el.value.length && el.operator !== 'Select one') {
			  var val = el.value.split(',');

			  for (var i = 0; i < reporting.reportBuilder.scEditor.selectedFieldsArray.length; i++) {
				if (el.column == reporting.reportBuilder.scEditor.selectedFieldsArray[i].title.replace('  ', ' ')) {
				  var tempArr = [];
				  val.forEach(function(innerEl) {
					if (innerEl && innerEl !== 'Select one') {
					  tempArr.push({
						field: reporting.reportBuilder.scEditor.selectedFieldsArray[i].field,
						operator: el.operator,
						value: innerEl
					  });
					}
				  });
				  filter.filters.push(util.filter(tempArr, 'or'));
				}
			  }

			} else {
			  if (el.operator == 'Select one') {
				operatorValue = false;
			  } else if (el.column) {
				filterValue = false;
			  }
			}
		  });

		  if (path == "DDQ")
			filter.filters.push({
			  field: "ConfigEntryId",
			  operator: "eq",
			  value: reporting.reportBuilder.CurrentIntakeForm.EntryId
			});

		  var sortDirection = true;
		  var sortColumn = true;

		  sortingArray.forEach(function(el) {
			if (el.direction && el.direction !== 'Select one' && el.column) {
			  for (var i = 0; i < reporting.reportBuilder.scEditor.selectedFieldsArray.length; i++) {
				if (el.column == reporting.reportBuilder.scEditor.selectedFieldsArray[i].title.replace('  ', ' ')) {

				  sorting.push({
					field: reporting.reportBuilder.scEditor.selectedFieldsArray[i].field,
					dir: el.direction
				  });
				}

			  }
			} else {
			  if (!el.column && (el.direction && el.direction !== 'Select one')) {
				sortColumn = false;
			  } else if (el.column && (!el.direction || el.direction == 'Select one')) sortDirection = false;
			}
		  });


		  //VALIDATION


		  // Validation for report type 
		  if (!reporting.reportBuilder.typeConf.dataset.reportType || reporting.reportBuilder.typeConf.dataset.reportType == 'Select one') {
			reporting.reportBuilder.msg("You didn't select Report Type.", 'err');
			return;
		  }

		  if (reporting.reportBuilder.typeConf.dataset.reportType == 'DDQ' && reporting.reportBuilder.typeConf.dataset.intakeForm == 'Select one') {
			reporting.reportBuilder.msg("You didn't select Intake Form.", 'err');
			return;
		  }
		  // Validation for parsing fields
		  if (!reporting.reportBuilder.scEditor || !reporting.reportBuilder.scEditor.selectedFieldsArray || !reporting.reportBuilder.scEditor.selectedFieldsArray.length) {
			reporting.reportBuilder.msg("You didn't select the fields in report.", 'err');
			return;
		  }

		  // Validation for Interval		  
		  if (!reporting.reportBuilder.repeatableConf.dataset.on && (reporting.reportBuilder.repeatableConf.dataset.from || reporting.reportBuilder.repeatableConf.dataset.to)) {
			reporting.reportBuilder.msg("You didn't select the column 'on' in the Interval. The Date Range needs to be applied on a selected date from the Fields in report.", 'err');
			return;
		  }

		  // Validation for filters		
		  if (filterValue == false) {
			reporting.reportBuilder.msg("What is the value of the filter you want to apply?", 'err');
			return;
		  }
		  // Validation operator fitler
		  if (operatorValue == false) {
			reporting.reportBuilder.msg("What is the operator of the filter you want to apply?", 'err');
			return;
		  }

		  // Validation operator direction
		  if (sortDirection == false) {
			reporting.reportBuilder.msg("What is the sort direction you want to apply?", 'err');
			return;
		  }

		  // Validation operator direction
		  if (sortColumn == false) {
			reporting.reportBuilder.msg("What is the sort column you want to apply?", 'err');
			return;
		  }


		  /*if(!sorting.length) {			
                          for(var i = 0; i< reporting.reportBuilder.scEditor.selectedFieldsArray.length; i++) {
                            if(reporting.reportBuilder.scEditor.selectedFieldsArray[i].field == 'table1275_EntryId' && reporting.reportBuilder.typeConf.dataset.reportType == 'Cases') {
                              sorting.push({
                                field: 'table1275_EntryId',
                                dir: 'desc'
                              })				  
                            }else if(reporting.reportBuilder.scEditor.selectedFieldsArray[i].field == 'table1363_EntryId' && reporting.reportBuilder.typeConf.dataset.reportType == 'Profiles') {
                              sorting.push({
                                field: 'table1363_EntryId',
                                dir: 'desc'
                              })
                            }
                          };		

                        }*/

		  console.log(filter);

		  $('.msgBox').removeClass('err');

		  mo.fn.overlay.show({
			loading: true
		  });
		  reporting.reportBuilder.run.grid._load(node, reporting.reportBuilder.run.grid.dataSource(filter, sorting, path));

		},
		grid: {
		  dataSource: function(filters, sort, path) {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1384/ARK_Report_" + path + "/kendo/data/search",
				  type: 'POST'
				},
			  },
			  serverPaging: true,
			  page: 1,
			  pageSize: 10,
			  /* set page size*/
			  serverFiltering: true,
			  filter: filters,
			  serverSorting: true,
			  sort: sort,
			  schema: {
				parse: function(response) {
				  mo.fn.overlay.hide();

				  if (reporting.reportBuilder.CurrentReportType == "IntakeForm") {

					var columns = [];
					if (response.Data.length > 0)
					  columns = Object.keys(response.Data[0]);

					var specialColumns = [];
					columns.forEach(x => {
					  var col = reporting.reportBuilder.IntakeFormColumnsInfo.find(y => y.ColumnName == x);
					  if (col)
						specialColumns.push(col);
					});


					var keyPersonnelCount = 0;

					for (var i = 0; i < response.Data.length; i++) {
					  specialColumns.forEach(x => {

						if (["radio", "select", "agree", "checkbox"].indexOf(x.Item.type) != -1) {
						  var idx = x.Item.values.indexOf(response.Data[i][x.ColumnName]);
						  if (idx != -1) {
							try {
							  var opts = x.Item.options;
							  if (!opts && x.Item.values && x.Item.values.length > idx)
								opts = x.Item.values;
							  if (opts)
							  {
								if(opts[idx] == "Y")
								  opts[idx] = "Yes";
								if(opts[idx] == "N")
								  opts[idx] = "No";
								response.Data[i][x.ColumnName] = ui.translate(opts[idx]);
							  }
							} catch (e) {
							  debugger;
							}
						  }
						}
					  });

					  //key personnel
					  if (reporting.reportBuilder.scEditor.selectedFields["KeyPersonnel"]) {
						var value = response.Data[i]["KeyPersonnel"];

						if (util.isJson(value))
						  value = JSON.parse(value);

						for (var k = 0; k < 10; k++) {
						  response.Data[i]["KeyPersonnel_Name_" + (k + 1)] = value ? (value.length > k ? value[k].Name : '') : '';
						  response.Data[i]["KeyPersonnel_Email_" + (k + 1)] = value ? (value.length > k ? value[k].Email : '') : '';
						  response.Data[i]["KeyPersonnel_Position_" + (k + 1)] = value ? (value.length > k ? value[k].Position : '') : '';
						  response.Data[i]["KeyPersonnel_Address_" + (k + 1)] = value ? (value.length > k ? value[k].Address : '') : '';
						  response.Data[i]["KeyPersonnel_Roles_" + (k + 1)] = value ? (value.length > k ? value[k].Role : '') : '';
						  response.Data[i]["KeyPersonnel_Ownership_" + (k + 1)] = value ? (value.length > k ? value[k].Ownership : '') : '';
						}
					  }
					}
				  }
				  return response;
				}

			  }
			});
		  },
		  createColumn: function(array, item) {
			var obj = {};
			obj.field = item.field;
			obj.title = item.title;
			obj.width = "250px";
			obj.attributes = {
			  style: "overflow: hidden;text-overflow: ellipsis; white-space: nowrap;"
			};

			var columnInfo = reporting.reportBuilder.getColumnInfo(item.field);
			if (columnInfo && columnInfo.Type == "Date" || item.title.includes("Date"))
			  obj.template = function(d, field = item.field) {
				return util.getDate(d[field]) || '';
			  }

			  array.push(obj);

		  },
		  _default: function() {

			var defConfig = [];
			reporting.reportBuilder.scEditor.selectedFieldsArray.forEach(x => {
			  reporting.reportBuilder.run.grid.createColumn(defConfig, x);
			});

			return defConfig;
		  },
		  _load: function(selector, datasource, expand) {

			var columns = reporting.reportBuilder.run.grid._default();
			reporting.cbGrid = $(selector).find('.innerGrid').kendoGrid({
			  excelExport: function(e) {
				e.preventDefault();

			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: false,
			  filterable: false,
			  resizable: true,
			  dataBound: function(e) {

				var data = e.sender.dataSource.view();
				if (data.length == 0)
				  return;
				var kpKeys = Object.keys(data[0]).filter(x => x.includes("KeyPersonnel_"));
				var kpKeysExisted = e.sender.columns.filter(x => x.field.includes("KeyPersonnel_"));
				if (kpKeys.length > 0 && kpKeysExisted.length == 0) {
				  kpKeys.forEach(x => {
					reporting.reportBuilder.run.grid.createColumn(e.sender.columns, {
					  field: x,
					  title: x
					});
				  });
				  setTimeout(function() {
					e.sender.setOptions({
					  columns: e.sender.columns
					});
					e.sender.refresh();
				  }, 400);
				}

			  }
			});

			selector.querySelector(".excel-button").addEventListener("click", function() {
			  var grid = reporting.cbGrid.data().kendoGrid;
			  debugger;
			  reporting.exportReport("ARK_Report_" + reporting.reportBuilder.typeConf.dataset.reportType,
									 1384,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 reporting.reportBuilder.repeatableConf.dataset.templateName ? reporting.reportBuilder.repeatableConf.dataset.templateName : ("Report_" + util.getDate((new Date()).toISOString(), true))

									);
			});

			document.querySelector(".reportGrid").scrollIntoView({
			  behavior: "smooth",
			  block: "end",
			  inline: "nearest"
			});

		  }

		}
	  }
	},
	ark: {
	  init: function(holder) {
		holder.innerHTML = "";
		const isArkAdmin = access.user.Email == "sergey.kalinin@hpe.com" ||
			  access.user.Email == "anton.zhabin@hpe.com" ||
			  access.user.Email == "andrici.andrei-toni@hpe.com" ||
			  access.user.Email == "ciprian.filipoiu@hpe.com";
		var tabs = [

		  {
			label: "Expires",
			id: "expired"
		  },
		  {
			label: "Profile notes",
			id: "profile-notes"
		  },
		  {
			label: "Profile documents",
			id: "profiles-docs"
		  },
		  {
			label: "Case notes",
			id: "case-notes"
		  },
		  {
			label: "Case documents",
			id: "case-docs"
		  },
		  {
			label: "Profile audit log",
			id: "profile-audit"
		  },
		  {
			label: "Case audit log",
			id: "case-audit"
		  },
		  {
			label: "Emails",
			id: "emails"
		  },
		  {
			label: "Case Tasks",
			id: "case-tasks"
		  },
		  {
			label: "Duplicate Profiles",
			id: "duplicate-profiles"
		  }
		];
		if (isArkAdmin) {
		  tabs.push({
			label: "PartyId Error Report",
			id: "partyid-error"
		  });
		  tabs.push({
			label: "Reseller Simplified Report",
			id: "reseller-simplified"
		  });
		}
		hpe.ui.tabs({
		  dom: holder,
		  tabs: tabs,
		}, function(all) {
		  reporting.ark.expired.init(all[0]);

		  reporting.holder().querySelector('[tab-id="expired"]').addEventListener('click', function() {
			reporting.ark.expired.init(all[0]);
		  });

		  reporting.holder().querySelector('[tab-id="profile-notes"]').addEventListener('click', function() {
			reporting.ark.profileNotes.init(all[1]);
		  });

		  reporting.holder().querySelector('[tab-id="profiles-docs"]').addEventListener('click', function() {
			reporting.ark.profileDocs.init(all[2]);
		  });

		  reporting.holder().querySelector('[tab-id="case-notes"]').addEventListener('click', function() {
			reporting.ark.caseNotes.init(all[3]);
		  });

		  reporting.holder().querySelector('[tab-id="case-docs"]').addEventListener('click', function() {
			reporting.ark.caseDocs.init(all[4]);
		  });
		  reporting.holder().querySelector('[tab-id="profile-audit"]').addEventListener('click', function() {
			reporting.ark.profileAudit.init(all[5]);
		  });
		  reporting.holder().querySelector('[tab-id="case-audit"]').addEventListener('click', function() {
			reporting.ark.caseAudit.init(all[6]);
		  });

		  reporting.holder().querySelector('[tab-id="emails"]').addEventListener('click', function() {
			reporting.ark.emails.init(all[7]);
		  });
		  reporting.holder().querySelector('[tab-id="case-tasks"]').addEventListener('click', function() {
			reporting.ark.caseTasks.init(all[8]);
		  });
		  reporting.holder().querySelector('[tab-id="duplicate-profiles"]').addEventListener('click', function() {
			reporting.ark.duplicateProfiles.init(all[9]);
		  });
		  if (isArkAdmin) {
			//reporting.holder().querySelector('[tab-id="partyid-error"]').visibility='hidden';
			reporting.holder().querySelector('[tab-id="partyid-error"]').addEventListener('click', function() {
			  reporting.ark.partyIdErrors.init(all[10]);
			});
			reporting.holder().querySelector('[tab-id="reseller-simplified"]').addEventListener('click', function() {
			  reporting.ark.resellerSimplified.init(all[11]);
			});
		  }

		});
	  },
	  emails: {
		init: function(holder) {
		  holder.innerHTML = '<a role="button"style="float: right; margin-right: 19px;z-index: 1;" class="k-button k-button-icontext k-grid-send_email_reporting " href="#">Test email/reminder template</a><div class="reports-tabs-emails"></div>';
		  var tabs = [{
			label: "Reminders",
			id: "reminders"
		  },
					  {
						label: "Batch Invites",
						id: "batch-reminders"
					  },
					  {
						label: "Batch Server Report",
						id: "batch-server"
					  },
					 ];
		  if (access.user.UserRole["ADMIN"]) {
			tabs.push({
			  label: "Batch Issues",
			  id: "batch-issues"
			});
		  }
		  hpe.ui.tabs({
			dom: holder.querySelector('.reports-tabs-emails'),
			tabs: tabs,
		  }, function(all) {

			reporting.ark.emails.remindersToSend.init(all[0]);

			holder.querySelector('[tab-id="reminders"]').addEventListener('click', function() {
			  reporting.ark.emails.remindersToSend.init(all[0]);
			});

			holder.querySelector('[tab-id="batch-reminders"]').addEventListener('click', function() {
			  reporting.ark.emails.batchReminders.init(all[1]);
			});

			holder.querySelector('[tab-id="batch-server"]').addEventListener('click', function() {
			  reporting.ark.emails.batchServer.init(all[2]);
			});

			holder.querySelector('[tab-id="reminders"]').addEventListener('click', function() {
			  reporting.ark.emails.remindersToSend.init(all[0]);
			});

			holder.querySelector('.k-grid-send_email_reporting').addEventListener('click', function() {
			  localization.modal.email();
			});

			if (access.user.UserRole["ADMIN"]) {
			  holder.querySelector('[tab-id="batch-issues"]').addEventListener('click', function() {
				reporting.ark.emails.batchIssues.init(all[3]);
			  });
			}

		  });
		},
		remindersToSend: {
		  init: function(holder) {
			holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="reminderstosend-grid"></div>';

			reporting.ark.emails.remindersToSend.grid.load(holder, holder.querySelector('.reminderstosend-grid'), reporting.ark.emails.remindersToSend.dataSource());
		  },
		  grid: {
			columns: function() {
			  var columns = [{
				field: "ReminderDate",
				title: "Reminder Date",
				hidden: false,
				width: "200px",
				template: function(d) {
				  return util.getDate(d.ReminderDate)
				}
			  },
							 {
							   field: "InvitationFK",
							   title: "Case Id",
							   hidden: false,
							   width: "150px",
							   headerAttributes: {
								 style: "white-space: normal"
							   },
							 },
							 {
							   field: "CompanyId",
							   title: "Profile Id",
							   hidden: false,
							   width: "150px",
							   headerAttributes: {
								 style: "white-space: normal"
							   },
							 },
							 {
							   field: "CompanyName",
							   title: "Company",
							   hidden: false,
							   width: "200px",
							   locked: false,
							 },
							 {
							   field: "To",
							   title: "Recipient",
							   hidden: false,
							   width: "250px",
							   locked: false,
							 },
							 {
							   field: "ReminderTemplateId",
							   title: "Type",
							   hidden: false,
							   width: "250px"
							 },
							 {
							   title: "",
							   width: "60px",
							   locked: true,
							   hidden: false,
							   attributes: {
								 "class": "cta"
							   },
							   template: function(d) {
								 var icons = '<a style="margin-right: 5px" class="send_email_copy"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="send" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M22,3 L2,11 L20.5,19 L22,3 Z M10,20.5 L13,16 M15.5,9.5 L9,14 L9.85884537,20.0119176 C9.93680292,20.5576204 10.0751625,20.5490248 10.1651297,20.009222 L11,15 L15.5,9.5 Z"></path></svg></a>';
								 return icons;
							   }
							 }
							];

			  return columns;
			},
			load: function(holder, selector, datasource) {
			  var columns = reporting.ark.emails.remindersToSend.grid.columns();

			  util.kendoGrid.addDateFieldsToSchema(datasource, ["ReminderDate"]);

			  $(selector).kendoGrid({
				height: 500,
				noRecords: {
				  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
				},
				dataSource: datasource,
				columns: columns,
				pageable: {
				  buttonCount: 4,
				  pageSize: 10,
				  pageSizes: [10, 25, 50, 100],
				  messages: {
					itemsPerPage: ""
				  },
				  refresh: true
				},
				scrollable: true,
				sortable: true,
				filterable: true,
				resizable: true,
				dataBound: util.kendoGrid.dataBound,
				filter: util.kendoGrid.filter
			  });

			  $(selector).delegate('.send_email_copy', 'click', function(ev) {
				var grid = $(selector).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));

				var conf = '';
				mo.fn.modal.show({
				  ctaLabel: 'Ok',
				  cancelLabel: "Cancel",
				  title: "Provide Email address",
				  class: "ark-modal",
				  content: '<div class="provide_email" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
				  contentCallback: function() {

					conf = {
					  dom: document.querySelector('.provide_email'),
					  pages: [{
						nav: false,
						structure: [{
						  group: [
							[{
							  label: "Email",
							  data: "Email",
							  required: true,
							  value: null,
							  type: "text",
							  placeholder: "Email",
							  validation: ["minLen|1", "maxLen|100", "noBlanks"]
							}, ]
						  ]
						}]
					  }],
					  dataset: {},
					};
					nbsf.init(conf, 0);
				  },
				  ctaCallback: function() {

					mail.send({
					  "ID": "Reminder_Sample",
					  "To": conf.dataset.Email,
					  "Subject": row.Subject,
					  "Big1": row.ReminderTemplate,

					});
					mo.fn.modal.hide()
				  }


				});
			  });

			  var grid = $(selector).data("kendoGrid");
			  holder.querySelector(".excel-button").addEventListener("click",
																	 function(e) {

				reporting.exportReport("ARK_Reminders_Custom",
									   1358,
									   JSON.stringify(grid.columns.map(({
				  field,
				  title
				}) => ({
				  field,
				  title
				})).filter(x => x.field)),
									   JSON.stringify(grid.dataSource.sort()),
									   JSON.stringify(grid.dataSource.filter()),
									   ("Reminders_ToSend_" + util.getDate((new Date()).toISOString(), true))

									  );
			  });

			  mo.fn.overlay.hide();
			}
		  },
		  dataSource: function() {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1358/ARK_Reminders_Custom/kendo/data/search",
				  type: 'POST'
				},
			  },
			  schema: {
				model: {
				  id: "EntryId",
				  /* please define primary key name */
				  fields: {
					/* define filed here for use update/create*/
				  }
				}
			  },
			  serverPaging: true,
			  pageSize: 15,
			  serverFiltering: true,
			  serverSorting: true,
			  filter: {
				field: "Status",
				operator: "eq",
				value: 0
			  },
			  sort: {
				field: "ReminderDate",
				dir: "asc"
			  }
			});
		  }
		},
		batchReminders: {
		  holder: null,
		  getGridHtml: function() {
			return '<div class="batch-report"><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="batch-report-grid"></div></div>';
		  },
		  init: function(holder) {
			holder.innerHTML = '<div class="intakeSelector"></div>' + reporting.ark.emails.batchReminders.getGridHtml();
			reporting.ark.emails.batchReminders.holder = holder;
			mo.fn.overlay.show({
			  loading: true,
			  close: false
			});
			reporting.ark.emails.batchReminders.batchIdSelector.getData(function() {
			  mo.fn.overlay.hide();
			  reporting.ark.emails.batchReminders.batchIdSelector.init(holder.querySelector('.intakeSelector'));
			});

			reporting.ark.emails.batchReminders.grid.load(holder, holder.querySelector('.batch-report-grid'), reporting.ark.emails.batchReminders.dataSourceReminders('All'));

		  },
		  batchIdSelector: {
			batchIdData: [],
			batchIdDataDropDownOptions: [],
			init: function(node, callback) {
			  node.innerHTML = "<div class='intakeForm-filter' style='margin-bottom:20px;'></div>";
			  var conf = {
				dom: node.querySelector('.intakeForm-filter'),
				pages: [{
				  nav: false,
				  structure: [{
					group: [
					  [{
						label: "Batch operation",
						data: "intakeFormSelector",
						type: "select",
						value: 'All',
						values: reporting.ark.emails.batchReminders.batchIdSelector.batchIdData,
						options: reporting.ark.emails.batchReminders.batchIdSelector.batchIdDataDropDownOptions
					  }]
					]
				  }, ],
				  callback: function() {
					node.querySelector('[data-name="intakeFormSelector"]').addEventListener('change', function(ev) {
					  reporting.ark.emails.batchReminders.batchIdSelector.changeForm(ev.target.value);
					});
				  },
				}],
				dataset: {},
			  };
			  nbsf.init(conf, 0);
			},
			getData: function(callback) {
			  const ds = reporting.ark.emails.batchReminders.dataSourceCase();
			  ds.fetch(function() {
				var batchIdData = this.data();
				reporting.ark.emails.batchReminders.batchIdSelector.batchIdData = batchIdData.map(x => x.BatchId);

				reporting.ark.emails.batchReminders.batchIdSelector.batchIdDataDropDownOptions = batchIdData.map(el => {
				  return el.BatchId.split(';')[1] + ' (' + el.BatchId.split(';')[2].substring(0, el.BatchId.split(';')[2].length - 4) + ') - ' + el.BatchId.split(';')[0];
				});
				reporting.ark.emails.batchReminders.batchIdSelector.batchIdData.unshift('All');
				reporting.ark.emails.batchReminders.batchIdSelector.batchIdDataDropDownOptions.unshift('All');
				callback();
			  });
			},
			changeForm: function(val) {
			  reporting.ark.emails.batchReminders.grid.intakeForm = val;
			  var container = reporting.ark.emails.batchReminders.holder.querySelector('.batch-report');
			  container.innerHTML = reporting.ark.emails.batchReminders.getGridHtml();
			  reporting.ark.emails.batchReminders.grid.load(
				reporting.ark.emails.batchReminders.holder,
				container.querySelector('.batch-report-grid'),
				reporting.ark.emails.batchReminders.dataSourceReminders(reporting.ark.emails.batchReminders.grid.intakeForm));
			},
		  },
		  grid: {
			intakeForm: "",
			columns: function() {
			  var columns = [
				//KEY FIELDS
				{
				  field: "CompanyFK",
				  title: "Profile #",
				  hidden: false,
				  locked: true,
				  width: "100px",
				},
				{
				  field: "InvitationFK",
				  title: "Case #",
				  hidden: false,
				  locked: true,
				  width: "100px",
				},
				{
				  field: "Days",
				  title: "T+N",
				  hidden: false,
				  width: "150px",
				},
				{
				  field: "CaseCreated",
				  title: "Case Created",
				  hidden: false,
				  width: "150px",
				  template: function(d) {
					return util.getDate(d.CaseCreated)
				  }
				},
				{
				  field: "CaseStatus",
				  title: "Case Status",
				  hidden: false,
				  width: "150px",
				  template: function(d) {
					return invitation.manageStatus(d.CaseStatus);
				  }
				},
				{
				  field: "Sender",
				  title: "Sender",
				  hidden: false,
				  width: "150px",
				},
				{
				  field: "Recipient",
				  title: "Recipient",
				  hidden: false,
				  width: "150px",
				},
				{
				  field: "SiebelID",
				  title: "Profile. Siebel ID",
				  hidden: false,
				  width: "150px",
				},
				{
				  field: "PartyId",
				  title: "Profile. Party ID",
				  hidden: false,
				  width: "150px",
				},
				{
				  field: "ProfileName",
				  title: "Profile. Company Name",
				  hidden: false,
				  width: "250px"
				},
				{
				  field: "IntakeForm",
				  title: "Profile. Intake Form",
				  hidden: false,
				  width: "200px",
				  template: function(d) {
					return (util.getConfigNameById(d.IntakeForm) || "");
				  }
				},
				//CREATE NEW PROFILE FIELDS (MANDATORY)
				{
				  field: "InternalOwner",
				  title: "Profile. Internal Owner",
				  hidden: false,
				  width: "200px",
				},
				{
				  field: "Region",
				  title: "Profile. Region",
				  hidden: false,
				  width: "180px"
				},
				{
				  field: "CountryName",
				  title: "Profile. Country",
				  hidden: false,
				  width: "200px"
				},
				{
				  field: "EmailAddress",
				  title: "Profile. Contact Email",
				  hidden: false,
				  width: "250px",
				  headerAttributes: {
					style: "white-space: normal"
				  },
				},
				{
				  field: "Name",
				  title: "Profile. Contact Name",
				  hidden: false,
				  width: "180px"
				},
				{
				  field: "Address1",
				  title: "Profile. Address 1",
				  hidden: false,
				  width: "400px",
				},
				{
				  field: "TradingCompanyName",
				  title: "Profile. Trading Company Name",
				  hidden: false,
				  width: "180px",
				  headerAttributes: {
					style: "white-space: normal"
				  },
				},
				{
				  field: "EnglishProfileName",
				  title: "Profile. English Company Name",
				  hidden: false,
				  width: "180px",
				  headerAttributes: {
					style: "white-space: normal"
				  },
				},
				{
				  field: "City",
				  title: "Profile. City",
				  hidden: false,
				  width: "180px",
				},
				{
				  field: "TaxId",
				  title: "Profile. Tax Id / Registration Number",
				  hidden: false,
				  width: "180px",
				  headerAttributes: {
					style: "white-space: normal"
				  },
				},
				{
				  field: "PostCode",
				  title: "Profile. Postcode",
				  hidden: false,
				  width: "180px"
				},
				{
				  field: "CompanyTelephone",
				  title: "Profile. Phone number",
				  hidden: false,
				  width: "180px"
				},
				{
				  field: "Category",
				  title: "Profile. Partner Category",
				  hidden: false,
				  width: "200px"
				},
				{
				  field: "Language",
				  title: "Profile. Preferred Language",
				  hidden: false,
				  width: "180px"
				},
				{
				  field: "CaseLanguage",
				  title: "Case. Language",
				  hidden: false,
				  width: "180px"
				},
				{
				  field: "CPIDoNotUpdate",
				  title: "Case. CPI",
				  hidden: false,
				  width: "180px"
				},

				{
				  title: "",
				  width: "100px",
				  locked: true,
				  hidden: false,
				  attributes: {
					"class": "cta"
				  },
				  template: function(d) {
					var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
						'<a class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
					return icons;
				  }
				}

			  ];
			  return columns;
			},
			load: function(holder, selector, datasource) {

			  $(selector).kendoGrid({
				height: 500,
				noRecords: {
				  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
				},
				dataSource: datasource,
				columns: reporting.ark.emails.batchReminders.grid.columns(),
				pageable: {
				  buttonCount: 4,
				  pageSize: 10,
				  pageSizes: [10, 25, 50, 100],
				  messages: {
					itemsPerPage: ""
				  },
				  refresh: true
				},
				scrollable: true,
				sortable: false,
				resizable: true,
				filterable: true,
				filter: util.kendoGrid.filter,
				dataBound: util.kendoGrid.dataBound,
			  });
			  $(selector).delegate('.view_invitation', 'click', function(ev) {
				var grid = $(selector).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));
				invitation.invitationOverview.init(row.InvitationFK);
			  });

			  $(selector).delegate('.myInv-company_details', 'click', function(ev) {
				var grid = $(selector).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));


				myInvitations.viewCompany(row.CompanyFK);
			  });

			  var grid = $(selector).data("kendoGrid");
			  holder.querySelector(".excel-button").addEventListener("click",
																	 function(e) {

				reporting.exportReport("ARK_Reminders_Sent",
									   1275,
									   JSON.stringify(grid.columns.map(({
				  field,
				  title
				}) => ({
				  field,
				  title
				})).filter(x => x.field)),
									   JSON.stringify(grid.dataSource.sort()),
									   JSON.stringify(grid.dataSource.filter()),
									   ("BatchInvites_Report_" + util.getDate((new Date()).toISOString(), true))

									  );
			  });

			}

		  },
		  dataSourceCase: function() {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Cases_BatchId/kendo/data/search",
				  type: 'POST'
				},
			  },
			  schema: {
				model: {
				  id: "EntryId",
				  /* please define primary key name */
				  fields: {
					/* define filed here for use update/create*/
				  }
				}
			  },
			  serverPaging: true,
			  pageSize: 100,
			  serverSorting: true,
			});
		  },
		  dataSourceReminders: function(batchOp) {
			batchOp = batchOp.trim();
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Reminders_Sent/kendo/data/search",
				  type: 'POST'
				},
			  },
			  serverPaging: true,
			  pageSize: 10,
			  serverFiltering: !!batchOp && batchOp !== 'All',
			  filter: batchOp == 'All' ? {} : {
				field: "BatchId",
				operator: "eq",
				value: batchOp
			  },
			});
		  }
		},
		batchIssues: {
		  holder: null,
		  getGridHtml: function() {
			return '<div class="batch-report"><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="batch-report-grid"></div></div>';
		  },
		  init: function(holder) {
			holder.innerHTML = reporting.ark.emails.batchIssues.getGridHtml();
			reporting.ark.emails.batchIssues.holder = holder;
			reporting.ark.emails.batchIssues.grid.load(holder, holder.querySelector('.batch-report-grid'), reporting.ark.emails.batchIssues.dataSource());

		  },
		  grid: {
			columns: function() {
			  var columns = [
				//KEY FIELDS
				{
				  field: "EntryId",
				  title: "Profile #",
				  hidden: false,
				  width: "100px",
				},
				{
				  field: "CompanyName",
				  title: "Company Name",
				  hidden: false,
				  width: "200px",
				},
				{
				  field: "LegacyId",
				  title: "Third Party",
				  hidden: false,
				  width: "150px",
				},
				{
				  field: "BatchId",
				  title: "Batch Id",
				  hidden: false,
				  width: "300px",
				},
			  ];
			  return columns;
			},
			load: function(holder, selector, datasource) {

			  $(selector).kendoGrid({
				height: 500,
				noRecords: {
				  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
				},
				dataSource: datasource,
				columns: reporting.ark.emails.batchIssues.grid.columns(),
				pageable: {
				  buttonCount: 4,
				  pageSize: 10,
				  pageSizes: [10, 25, 50, 100],
				  messages: {
					itemsPerPage: ""
				  },
				  refresh: true
				},
				scrollable: true,
				sortable: false,
				resizable: true,
				filterable: true,
				filter: util.kendoGrid.filter,
				dataBound: util.kendoGrid.dataBound,
			  });

			  var grid = $(selector).data("kendoGrid");
			  holder.querySelector(".excel-button").addEventListener("click",
																	 function(e) {

				reporting.exportReport("ARK_PROFILE_MIGRATION_ISSUES",
									   1363,
									   JSON.stringify(grid.columns.map(({
				  field,
				  title
				}) => ({
				  field,
				  title
				})).filter(x => x.field)),
									   JSON.stringify(grid.dataSource.sort()),
									   JSON.stringify(grid.dataSource.filter()),
									   ("Batch_Issues_Report_" + util.getDate((new Date()).toISOString(), true))

									  );
			  });

			}

		  },
		  dataSource: function() {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_PROFILE_MIGRATION_ISSUES/kendo/data/search",
				  type: 'POST'
				},
			  },
			  serverPaging: true,
			  pageSize: 10,
			});
		  }
		},
		batchServer: {
		  holder: null,
		  batchId: '',
		  columnAliases: [],
		  columns: [
			//KEY FIELDS
			{
			  field: "EntryId",
			  title: "Entry #",
			  hidden: false,
			  width: "100px",
			},
			{
			  field: "BatchFK",
			  title: "Batch #",
			  hidden: false,
			  width: "100px",
			},
			{
			  field: "RowId",
			  title: "Row #",
			  hidden: false,
			  width: "100px",
			},
			{
			  field: "ValidationStatus",
			  title: "Validation Status",
			  hidden: false,
			  width: "50px",
			},
			{
			  field: "ValidationComment",
			  title: "Validation Comment",
			  hidden: false,
			  width: "300px",
			},
			{
			  field: "ProcessingStatus",
			  title: "Processing Status",
			  hidden: false,
			  width: "50px",
			},
			{
			  field: "ProcessingComment",
			  title: "Processing Comment",
			  hidden: false,
			  width: "300px",
			},
			{
			  field: "RowData",
			  title: "Row Data",
			  hidden: false,
			  width: "400px",
			},
			{
			  field: "ProcessedRowData",
			  title: "Processed Row Data",
			  hidden: false,
			  width: "400px",
			}
		  ],
		  getGridHtml: function() {
			return '<div class="batch-report"><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="batch-report-grid"></div></div>';
		  },
		  init: function(holder) {
			holder.innerHTML = '<div class="intakeSelector"></div>' + reporting.ark.emails.batchServer.getGridHtml();
			reporting.ark.emails.batchServer.holder = holder;
			mo.fn.overlay.show({
			  loading: true,
			  close: false
			});
			const cb = function() {
			  reporting.ark.emails.batchServer.batchIdSelector.getData(function() {
				mo.fn.overlay.hide();
				reporting.ark.emails.batchServer.batchIdSelector.init(holder.querySelector('.intakeSelector'));
				reporting.ark.emails.batchServer.grid.load(holder, holder.querySelector('.batch-report-grid'), reporting.ark.emails.batchServer.dataSourceReminders(reporting.ark.emails.batchServer.batchIdSelector.batchIdData[0] || 0));
			  });
			};
			var mappingDS = bulkInvitationsServer.getMappingValuesDS();
			mappingDS.read().then(function() {
			  reporting.ark.emails.batchServer.batchIdSelector.columnAliases = [];
			  mappingDS.view().forEach(function(el) {
				reporting.ark.emails.batchServer.batchIdSelector.columnAliases.push(el);
			  });
			  cb();
			});
		  },
		  batchIdSelector: {
			batchIdData: [],
			batchIdDataDropDownOptions: [],
			init: function(node, callback) {
			  node.innerHTML = "<div class='intakeForm-filter' style='margin-bottom:20px;'></div>";
			  var conf = {
				dom: node.querySelector('.intakeForm-filter'),
				pages: [{
				  nav: false,
				  structure: [{
					group: [
					  [{
						label: "Batch Id",
						data: "intakeFormSelector",
						type: "select",
						value: reporting.ark.emails.batchServer.batchIdSelector.batchIdData[0] || '',
						values: reporting.ark.emails.batchServer.batchIdSelector.batchIdData,
						options: reporting.ark.emails.batchServer.batchIdSelector.batchIdDataDropDownOptions
					  }]
					]
				  }, ],
				  callback: function() {
					node.querySelector('[data-name="intakeFormSelector"]').addEventListener('change', function(ev) {
					  reporting.ark.emails.batchServer.batchIdSelector.changeForm(ev.target.value);
					});
				  },
				}],
				dataset: {},
			  };
			  nbsf.init(conf, 0);
			},
			getData: function(callback) {
			  const ds = reporting.ark.emails.batchServer.dataSourceCase();
			  ds.fetch(function() {
				var batchIdData = this.data();
				reporting.ark.emails.batchServer.batchIdSelector.batchIdData = batchIdData.map(x => x.EntryId);

				reporting.ark.emails.batchServer.batchIdSelector.batchIdDataDropDownOptions = batchIdData.map(el => {
				  return el.BatchId.split(';')[1] + ' (' + el.BatchId.split(';')[2].substring(0, el.BatchId.split(';')[2].length - 4) + ') - ' + el.BatchId.split(';')[0];
				});
				callback();
			  });
			},
			changeForm: function(val) {
			  reporting.ark.emails.batchServer.grid.intakeForm = val;
			  var container = reporting.ark.emails.batchServer.holder.querySelector('.batch-report');
			  container.innerHTML = reporting.ark.emails.batchServer.getGridHtml();
			  reporting.ark.emails.batchServer.grid.load(
				reporting.ark.emails.batchServer.holder,
				container.querySelector('.batch-report-grid'),
				reporting.ark.emails.batchServer.dataSourceReminders(reporting.ark.emails.batchServer.grid.intakeForm));
			},
		  },
		  grid: {
			intakeForm: "",
			load: function(holder, selector, datasource) {

			  $(selector).kendoGrid({
				height: 500,
				noRecords: {
				  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
				},
				dataSource: datasource,
				pageable: {
				  buttonCount: 4,
				  pageSize: 100000,
				  pageSizes: [10, 25, 50, 100],
				  messages: {
					itemsPerPage: ""
				  },
				  refresh: true
				},
				scrollable: true,
				sortable: false,
				resizable: true,
				filterable: false,
				dataBound: function(e) { 
				  var columns = e.sender.columns;
				  var columnIndex = this.wrapper.find(".k-grid-header [data-field=" + "BatchStatus" + "]").index();

				  e.sender.element.find(".k-header").css('width', 150);
				  var rows = e.sender.tbody.children();
				  for (var j = 0; j < rows.length; j++) {
					var row = $(rows[j]);
					var cells = row.children();
					for (var i = 0; i < cells.length; i++) {  
					  var cell = $(cells[i]);
					  cell.css('width', 150);  
					}
					var dataItem = e.sender.dataItem(row);
					var status = dataItem.get("BatchStatus");
					var template = "";
					if (status == 1)
					  template = '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><polyline fill="none" stroke="green" stroke-width="2" points="2 14 9 20 22 4"></polyline></svg></a>';
					else
					  template = '<a class=""><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="copy"><path fill="none" stroke="red" stroke-width="2" d="M3,3 L21,21 M3,21 L21,3"></path></svg></a>';

					var cell = row.children().eq(columnIndex);
					cell.html(template);
				  }
				  var head = e.sender.thead.children();
				  var hrow = $(head[0]);
				  var cells = hrow.children();
				  for (var i = 0; i < cells.length; i++) {  
					var cell = $(cells[i]);
					var old = cell.html();
					var column = reporting.ark.emails.batchServer.batchIdSelector.columnAliases.find(el => el.ColumnName == old);
					if(!!column) {
					  cell.html(column.Title);
					}
					else {
					  cell.html(old.replace("CaseId", "Case. Case #").replace("ProfileId","Profile. Profile #"));
					}
				  }
				}
			  });
			  var grid = $(selector).data("kendoGrid");
			  holder.querySelector(".excel-button").addEventListener("click",
																	 function(e) {

				reporting.exportReport("BatchOperationsReports",
									   1475,
									   JSON.stringify(reporting.ark.emails.batchServer.columns.map(({
				  field,
				  title
				}) => ({
				  field,
				  title
				}))),
									   JSON.stringify(grid.dataSource.sort()),
									   JSON.stringify(grid.dataSource.filter()),
									   ("BatchServer_Report_" + util.getDate((new Date()).toISOString(), true))

									  );
			  });

			}

		  },
		  dataSourceCase: function() {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1631/Batch Server Operations/kendo/data/search",
				  type: 'POST'
				},
			  },
			  schema: {
				model: {
				  id: "EntryId",
				  /* please define primary key name */
				  fields: {
					/* define filed here for use update/create*/
				  }
				}
			  },
			  serverPaging: true,
			  pageSize: 1000,
			  serverSorting: true,
			});
		  },
		  dataSourceReminders: function(batchOp) {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1475/BatchOperationsReports/kendo/data/search",
				  type: 'POST'
				},
			  },
			  schema: {
				parse: function(response) {  
				  var parsedresponse = [];
				  response.Data.map(row => {
					var itm = {
					  BatchStatus: (row.ValidationStatus != null ? row.ValidationStatus : 1) * (row.ProcessingStatus != null ? row.ProcessingStatus : 1),
					  BatchComment: (row.ValidationComment || "") + ' ' + (row.ProcessingComment || ""),
					  RowNumber: row.RowId,
					  ...JSON.parse(row.ProcessedRowData)
					};
					parsedresponse.push(itm);
				  });
				  return parsedresponse;
				},
			  },
			  serverPaging: true,
			  pageSize: 100000,
			  serverFiltering: !!batchOp,
			  filter: !batchOp ? {} : {
				field: "BatchFK",
				operator: "eq",
				value: batchOp
			  },
			});
		  }
		},
	  },
	  rescreening: {
		init: function(holder) {
		  holder.innerHTML = "<div class='rescreening-grid'></div>";
		  reporting.ark.rescreening.grid.load(holder.querySelector('.rescreening-grid'), reporting.ark.rescreening.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [
			  //KEY FIELDS
			  {
				field: "EntryId",
				title: "Profile #",
				hidden: false,
				width: "150px",
			  },
			  {
				field: "RescreeningDate",
				title: "Rescreening Date",
				hidden: false,
				width: "150px",
				headerAttributes: {
				  style: "white-space: normal"
				},
				template: function(d) {
				  var date = d.RescreeningDate;
				  //if(new Date(d.RescreeningDate) < new Date())
				  //	date = (new Date()).toISOString();

				  return util.getDate(date, true)
				}

			  },
			  //SEARCH FIELDS
			  {
				field: "SiebelID",
				title: "Siebel ID",
				hidden: false,
				width: "150px",
			  },
			  {
				field: "PartyId",
				title: "Party ID",
				hidden: false,
				width: "150px",
			  },
			  {
				field: "CompanyName",
				title: "Company Name",
				hidden: false,
				width: "200px"
			  },
			  {
				field: "IntakeForm",
				title: "Intake Form",
				hidden: false,
				width: "200px",
				template: function(d) {
				  return util.getConfigNameById(d.IntakeForm);
				}
			  },
			  //CREATE NEW PROFILE FIELDS (MANDATORY)
			  {
				field: "InternalOwner",
				title: "Internal Owner",
				hidden: false,
				width: "200px",
			  },
			  {
				field: "Region",
				title: "Region",
				hidden: false,
				width: "180px"
			  },
			  {
				field: "Country",
				title: "Country",
				hidden: false,
				width: "200px",
				template: function(d) {
				  return reference.convertCountry(d.Country);
				}
			  },
			  {
				field: "Category",
				title: "Category",
				hidden: false,
				width: "200px"
			  },
			  {
				field: "Address1",
				title: "Address 1",
				hidden: false,
				width: "200px",
			  },
			  {
				field: "EmailAddress",
				title: "Contact Email",
				hidden: false,
				width: "200px",
				headerAttributes: {
				  style: "white-space: normal"
				},
			  },
			  {
				field: "Name",
				title: "Contact Name",
				hidden: false,
				width: "180px"
			  },
			  {
				field: "City",
				title: "City",
				hidden: false,
				width: "180px",
			  },
			  {
				field: "TaxId",
				title: "Tax Id / Registration Number",
				hidden: false,
				width: "180px",
				headerAttributes: {
				  style: "white-space: normal"
				},
			  },
			  {
				field: "TradingCompanyName",
				title: "Trading Company Name",
				hidden: false,
				width: "180px",
				headerAttributes: {
				  style: "white-space: normal"
				},
			  },
			  {
				field: "Website",
				title: "Website",
				hidden: false,
				width: "180px"
			  },
			];


			return columns;
		  },
		  load: function(selector, datasource) {
			var columns = reporting.ark.rescreening.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["RescreeningDate"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  toolbar: [{
				name: "excel",
				text: "Export Excel"
			  }],
			  excel: {
				fileName: "Rescreening_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
				filterable: true,
				allPages: true
			  },
			  excelExport: util.exportExcel,
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			mo.fn.overlay.hide();
		  }
		},
		dataSource: function(filter) {

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_Rescreening/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  expired: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="expired-grid"></div>';
		  var cols = [{
			field: "Expiry",
			title: "Expiry"
		  }, {
			field: "Created",
			title: "Created"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {
			var grid = $(holder.querySelector('.expired-grid')).getKendoGrid();
			grid.setDataSource(reporting.ark.expired.dataSource(data));
		  });
		  reporting.ark.expired.grid.load(holder, holder.querySelector('.expired-grid'), reporting.ark.expired.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "EntryId",
			  title: "Case #",
			  hidden: false,
			  width: "140px",
			  locked: true
			},
						   {
							 field: "FormType",
							 title: "Intake form",
							 hidden: false,
							 width: "200px",
							 locked: true,
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },
						   {
							 field: "CompanyName",
							 title: "Company",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "CompanyId",
							 title: "Profile #",
							 hidden: false,
							 width: "150px",
							 locked: false,
						   },
						   {
							 field: "RiskRank",
							 title: "Risk Rank",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "RequestedBy",
							 title: "Requested By",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Region",
							 title: "Region",
							 hidden: false,
							 width: "150px"
						   },
						   {
							 field: "Expiry",
							 title: "Expiry",
							 hidden: false,
							 width: "150px",
							 template: function(d) {
							   return util.getDate(d.Expiry)
							 }
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "150px",
							 template: function(d) {
							   return util.getDate(d.Created)
							 }
						   },
						   {
							 title: "",
							 width: "100px",
							 locked: true,
							 hidden: false,
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
								   '<a class="company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
							   return icons;
							 }
						   }
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.expired.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Expiry", "Created"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },

			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			$(selector).delegate('.view_invitation', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));
			  invitation.invitationOverview.init(row.EntryId);
			});

			$(selector).delegate('.company_details', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));

			  singleCompanyDetails.init(row.CompanyFK);
			});


			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".excel-button").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_Invitations_ToExpire",
									 1275,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("ExpirationReport_" + util.getDate((new Date()).toISOString(), true))

									);
			});

			mo.fn.overlay.hide();
		  }
		},
		dataSource: function(filter) {
		  console.log(filter);

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Invitations_ToExpire/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			filter: filter,
			/* set page size*/
			serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "Expiry",
			  dir: "asc"
			}

		  });
		}
	  },
	  caseTasks: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseTasks-grid"></div>';
		  var cols = [{
			field: "CompletedTS",
			title: "Completed"
		  }, {
			field: "Modified",
			title: "Modified"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {
			var grid = $(holder.querySelector('.caseTasks-grid')).getKendoGrid();
			grid.setDataSource(reporting.ark.caseTasks.dataSource(data));
		  });
		  reporting.ark.caseTasks.grid.load(holder, holder.querySelector('.caseTasks-grid'), reporting.ark.caseTasks.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "CaseId",
			  title: "Case id",
			  hidden: false,
			  width: "140px",
			  locked: true
			},
						   {
							 field: "ProfileId",
							 title: "Profile id",
							 hidden: false,
							 width: "140px",
							 locked: true
						   },
						   {
							 field: "ProfileCompanyName",
							 title: "Company name",
							 hidden: false,
							 width: "200px",
							 locked: true,
							 headerAttributes: {
							   style: "white-space: normal"
							 },
						   },
						   {
							 field: "Tasks",
							 title: "Tasks",
							 hidden: false,
							 width: "400px",
							 locked: false,
						   },
						   {
							 field: "Modified",
							 title: "Modified date",
							 hidden: false,
							 width: "150px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Modified)
							 }
						   },
						   {
							 field: "CompletedTS",
							 title: "Completed date",
							 hidden: false,
							 width: "200px",
							 template: function(d) {
							   return util.getDate(d.CompletedTS) || '';
							 }
						   },
						   {
							 field: "RequestedBy",
							 title: "Requested By",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 title: "",
							 width: "100px",
							 locked: true,
							 hidden: false,
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
								   '<a class="company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>';
							   return icons;
							 }
						   }
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.caseTasks.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["CompletedTS", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },

			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			$(selector).delegate('.view_invitation', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));
			  invitation.invitationOverview.init(row.CaseId);
			});

			$(selector).delegate('.company_details', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));

			  singleCompanyDetails.init(row.ProfileId);
			});


			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".excel-button").addEventListener("click",
																   function(e) {

			  reporting.exportReport("Ark_Case_Tasks",
									 1278,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("CaseTasks_" + util.getDate((new Date()).toISOString(), true))

									);
			});

			mo.fn.overlay.hide();
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1278/Ark_Case_Tasks/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			filter: filter,
			/* set page size*/
			serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			/*sort: {
                                field: "Expiry",
                                dir: "asc"
                              }*/

		  });
		}
	  },
	  duplicateProfiles: {
		init: function(holder) {

		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="duplicateProfiles-grid"></div>';
		  reporting.ark.duplicateProfiles.grid.load(holder, holder.querySelector('.duplicateProfiles-grid'), reporting.ark.duplicateProfiles.dataSource());

		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "FirstId",
			  title: "Profile #",
			  hidden: false,
			  locked: true,
			  width: "140px",
			},
						   {
							 field: "CompanyName",
							 title: "Company Name",
							 hidden: false,
							 locked: true,
							 width: "300px",
						   },
						   {
							 field: "PartyId",
							 title: "Party Id",
							 hidden: false,
							 width: "200px",
						   },
						   {
							 field: "SiebelId",
							 title: "Siebel Id",
							 hidden: false,
							 width: "200px",
						   },
						   {
							 field: "Country",
							 title: "Country",
							 hidden: false,
							 width: "200px",
							 template: function(d) {
							   return reference.convertCountry(d.Country) || "";
							 }
						   },
						   {
							 field: "City",
							 title: "City",
							 hidden: false,
							 width: "140px",
						   },
						   {
							 field: "DuplicateField",
							 title: "",
							 hidden: true,
						   },
						   {
							 title: "",
							 width: "100px",
							 hidden: false,
							 locked: true,
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons =
								   '<a style="margin-right: 5px" class="company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>' +
								   '<a class="merge_company"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="iteration" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M1,9 L1,23 L15,23 M5,5 L5,19 L19,19 M9,15 L23,15 L23,1 L9,1 L9,15 L9,15 L9,15 Z"></path></svg></a>';
							   return icons;
							 }
						   }
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.duplicateProfiles.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["CompletedTS", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			$(selector).delegate('.merge_company', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));
			  singleCompanyDetails.mergeProfiles.init(row.FirstId, row);
			});




			$(selector).delegate('.company_details', 'click', function(ev) {
			  var grid = $(selector).data("kendoGrid");
			  var row = grid.dataItem($(this).closest("tr"));

			  singleCompanyDetails.init(row.FirstId);
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".excel-button").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_DataToFindDuplicateProfiles",
									 1363,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("CaseTasks_" + util.getDate((new Date()).toISOString(), true))

									);
			});

			mo.fn.overlay.hide();
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_DuplicateProfiles/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			filter: filter,
			/* set page size*/
			serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "FirstId",
			  dir: "desc"
			}

		  });
		}
	  },
	  profileNotes: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profileNotes-grid"></div>';
		  var cols = [{
			field: "Created",
			title: "Created"
		  }, {
			field: "Modified",
			title: "Modified"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.profileNotes-grid')).getKendoGrid();
			grid.setDataSource(reporting.ark.profileNotes.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.ark.profileNotes.grid.load(holder, holder.querySelector('.profileNotes-grid'), reporting.ark.profileNotes.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "ProfileId",
			  title: "Profile #",
			  hidden: false,
			  width: "140px",
			  /*template: function(d) {
                                              return d.LegacyProfileId || d.ProfileId;
                                            }*/
			}, {
			  field: "ProfileLegacyId",
			  title: "Securimate #",
			  hidden: false,
			  width: "170px",
			  /*template: function(d) {
                                              return d.LegacyProfileId || d.ProfileId;
                                            }*/
			},
						   {
							 field: "CompanyName",
							 title: "Company",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "CreatedBy",
							 title: "Owner",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 /*template: function(d) {
                                              return d.LegacyCreatedBy || d.CreatedBy;
                                            }*/
						   },
						   {
							 field: "Subject",
							 title: "Subject",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Category",
							 title: "Category",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Note",
							 title: "Note",
							 hidden: false,
							 width: "350px",
							 locked: false,
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Created);
							 }
						   },
						   {
							 field: "Modified",
							 title: "Modified",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Modified);
							 }
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.profileNotes.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Created", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "ProfileNotes.Report_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },	
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".excel-button").addEventListener("click", function() {
			  reporting.exportReport("ARK_Report_ProfileNotes",
									 1372,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("ProfileNotes.Report_" + util.getDate((new Date()).toISOString(), true))
									);
			});
		  }
		},
		dataSource: function(filter) {

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1372/ARK_Report_ProfileNotes/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			filter: filter,
			serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  profileDocs: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profileDocs-grid"></div>';
		  var cols = [{
			field: "Created",
			title: "Created"
		  }, {
			field: "Modified",
			title: "Modified"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {


			var grid = $(holder.querySelector('.profileDocs-grid')).getKendoGrid();
			grid.setDataSource(reporting.ark.profileDocs.dataSource(data));
			grid.dataSource.read();

		  });
		  reporting.ark.profileDocs.grid.load(holder, holder.querySelector('.profileDocs-grid'), reporting.ark.profileDocs.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "ProfileId",
			  title: "Profile #",
			  hidden: false,
			  width: "140px",
			  /*template: function(d) {
                                              return d.LegacyProfileId || d.ProfileId;
                                            }*/
			}, {
			  field: "ProfileLegacyId",
			  title: "Securimate #",
			  hidden: false,
			  width: "170px",
			  /*template: function(d) {
                                              return d.LegacyProfileId || d.ProfileId;
                                            }*/
			},
						   {
							 field: "CompanyName",
							 title: "Company",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "CreatedBy",
							 title: "Owner",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 /*template: function(d) {
                                              return d.LegacyCreatedBy || d.CreatedBy;
                                            }*/
						   },
						   {
							 field: "File",
							 title: "File",
							 hidden: false,
							 width: "250px",
							 locked: false,
							 /*template: function(d) {
                                              return d.LegacyFileName || d.File || '';
                                            }*/
						   },
						   {
							 field: "Link",
							 title: "Link",
							 hidden: false,
							 width: "250px",
							 template: function(d) {
							   /*if(d.LegacyFileName)
                              return 'https://hpe-rfb.it.hpe.com/resources/rs/custom/ark/attachments/' + d.ProfileLegacyId + "/" + d.LegacyFileName; 

                            if(d.File)
                              return 'https://hpe-rfb.it.hpe.com/form/1370/attachments/' + d.EntryId + '/File?' + d.File;
                              */

							   return `<a target="_blank" href=${d.Link}>${d.Link}</a>`;
							 }
						   },
						   {
							 field: "Category",
							 title: "Category",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Description",
							 title: "Description",
							 hidden: false,
							 width: "350px",
							 locked: false,
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Created);
							 }
						   },
						   {
							 field: "Modified",
							 title: "Modified",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Modified);
							 }
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.profileDocs.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Created", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "ProfileDocuments.Report_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },	
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_Report_ProfileDocs",
									 1370,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("ProfileDocuments_" + util.getDate((new Date()).toISOString(), true))
									);

			});

		  }
		},
		dataSource: function(filter) {

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1370/ARK_Report_ProfileDocs/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			serverFiltering: true,
			filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  caseNotes: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseNotes-grid"></div>';
		  var cols = [{
			field: "Created",
			title: "Created"
		  }, {
			field: "Modified",
			title: "Modified"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.caseNotes-grid')).getKendoGrid();
			grid.setDataSource(reporting.ark.caseNotes.dataSource(data));
			grid.dataSource.read();

		  });
		  reporting.ark.caseNotes.grid.load(holder, holder.querySelector('.caseNotes-grid'), reporting.ark.caseNotes.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "CaseId",
			  title: "Case #",
			  hidden: false,
			  width: "140px",
			},
						   {
							 field: "CaseLegacyId",
							 title: "Securimate #",
							 hidden: false,
							 width: "170px",
						   },
						   {
							 field: "ProfileId",
							 title: "Profile #",
							 hidden: false,
							 width: "140px",
						   },
						   {
							 field: "CompanyName",
							 title: "Company",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "CreatedBy",
							 title: "Owner",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "Subject",
							 title: "Subject",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Category",
							 title: "Category",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Note",
							 title: "Note",
							 hidden: false,
							 width: "350px",
							 locked: false,
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Created);
							 }
						   },
						   {
							 field: "Modified",
							 title: "Modified",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Modified);
							 }
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.caseNotes.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Created", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "CaseNotes.Report_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },	
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_Report_CaseNotes",
									 1372,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("CaseNotes_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1372/ARK_Report_CaseNotes/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			serverFiltering: true,
			filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  caseDocs: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseDocs-grid"></div>';
		  var cols = [{
			field: "Created",
			title: "Created"
		  }, {
			field: "Modified",
			title: "Modified"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {
			var grid = $(holder.querySelector('.caseDocs-grid')).getKendoGrid();
			grid.setDataSource(reporting.ark.caseDocs.dataSource(data));
			grid.dataSource.read();

		  });
		  reporting.ark.caseDocs.grid.load(holder, holder.querySelector('.caseDocs-grid'), reporting.ark.caseDocs.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "CaseId",
			  title: "Case #",
			  hidden: false,
			  width: "140px",
			},
						   {
							 field: "CaseLegacyId",
							 title: "Securimate #",
							 hidden: false,
							 width: "170px",
						   },
						   {
							 field: "ProfileId",
							 title: "Profile #",
							 hidden: false,
							 width: "140px",
						   },
						   {
							 field: "CompanyName",
							 title: "Company",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "CreatedBy",
							 title: "Owner",
							 hidden: false,
							 width: "200px",
							 locked: false,
						   },
						   {
							 field: "File",
							 title: "File",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Link",
							 title: "Link",
							 hidden: false,
							 width: "170px",
							 template: function(d) {
							   /* if(d.LegacyFileName)
                              return 'https://hpe-rfb.it.hpe.com/resources/rs/custom/ark/attachments/' +  d.ProfileLegacyId + '/' +  d.CaseLegacyId + "/" + d.LegacyFileName

                            if(d.File)
                              return 'https://hpe-rfb.it.hpe.com/form/1370/attachments/' + d.EntryId + '/File?' + d.File;*/

							   return `<a target="_blank" href=${d.Link}>${d.Link}</a>`;
							 }
						   },
						   {
							 field: "Category",
							 title: "Category",
							 hidden: false,
							 width: "170px",
							 locked: false,
						   },
						   {
							 field: "Description",
							 title: "Description",
							 hidden: false,
							 width: "350px",
							 locked: false,
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Created);
							 }
						   },
						   {
							 field: "Modified",
							 title: "Modified",
							 hidden: false,
							 width: "200px",
							 locked: false,
							 template: function(d) {
							   return util.getDate(d.Modified);
							 }
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.caseDocs.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Created", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*  toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "CaseDocuments.Report_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },	
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_Report_CaseDocs",
									 1370,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("CaseDocuments_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {

		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1370/ARK_Report_CaseDocs/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			serverFiltering: true,
			filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  profileAudit: {
		init: function(holder) {
		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profileAudit-grid"></div>';
		  reporting.ark.profileAudit.grid.load(holder, holder.querySelector('.profileAudit-grid'), reporting.ark.profileAudit.dataSource());
		  var grid = $(holder.querySelector('.profileAudit-grid')).getKendoGrid();
		  grid.setDataSource(reporting.ark.profileAudit.dataSource());
		  grid.dataSource.read();
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "Type",
			  title: "Type",
			  hidden: false,
			  width: "160px",
			},
						   {
							 field: "Changes",
							 title: "Changes",
							 hidden: false,
							 width: "250px",
						   },
						   {
							 field: "CreatedBy",
							 title: "User",
							 hidden: false,
							 width: "160px",
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "200px",
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.profileAudit.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Created", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ArkAuditLogData",
									 1371,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("ProfileAuditLog_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function() {
		  const filter = {
			field: "CompanyFK",
			operator: "isnotempty",
			value: ""
		  };
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1371/ArkAuditLogData/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			serverFiltering: true,
			filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}
		  });
		}
	  },
	  caseAudit: {
		init: function(holder) {
		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseAudit-grid"></div>';
		  reporting.ark.caseAudit.grid.load(holder, holder.querySelector('.caseAudit-grid'), reporting.ark.caseAudit.dataSource());
		  var grid = $(holder.querySelector('.caseAudit-grid')).getKendoGrid();
		  grid.setDataSource(reporting.ark.caseAudit.dataSource());
		  grid.dataSource.read();
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "Type",
			  title: "Type",
			  hidden: false,
			  width: "160px",
			},
						   {
							 field: "Changes",
							 title: "Changes",
							 hidden: false,
							 width: "250px",
						   },
						   {
							 field: "CreatedBy",
							 title: "User",
							 hidden: false,
							 width: "160px",
						   },
						   {
							 field: "Created",
							 title: "Created",
							 hidden: false,
							 width: "200px",
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.caseAudit.grid.columns();

			util.kendoGrid.addDateFieldsToSchema(datasource, ["Created", "Modified"]);

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ArkAuditLogData",
									 1371,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("CaseAuditLog_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function() {
		  const filter = {
			field: "InvitationFK",
			operator: "isnotempty",
			value: ""
		  };
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1371/ArkAuditLogData/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			/* set page size*/
			serverFiltering: true,
			filter: filter,
			serverSorting: true,
			/* set default sort */
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  partyIdErrors: {
		init: function(holder) {
		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="partyIdErrors-grid"></div>';
		  reporting.ark.partyIdErrors.grid.load(holder, holder.querySelector('.partyIdErrors-grid'), reporting.ark.partyIdErrors.dataSource());
		  var grid = $(holder.querySelector('.partyIdErrors-grid')).getKendoGrid();
		  grid.setDataSource(reporting.ark.partyIdErrors.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "CompanyName",
			  title: "Company Name",
			  hidden: false,
			  width: "200px"
			},
						   {
							 field: "PartyId",
							 title: "Party id",
							 hidden: false,
							 width: "140px"
						   },
						   {
							 field: "SiebelID",
							 title: "Siebel ID",
							 hidden: false,
							 width: "150px",
						   },
						   {
							 field: "Region",
							 title: "Region",
							 hidden: false,
							 width: "100px",
						   },
						   {
							 field: "Country",
							 title: "Country",
							 hidden: false,
							 width: "150px",
						   },
						   {
							 field: "State",
							 title: "State",
							 hidden: false,
							 width: "200px",
						   },
						   {
							 field: "City",
							 title: "City",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Address1",
							 title: "Address 1",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Address2",
							 title: "Address 2",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Error",
							 title: "Error",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Answer",
							 title: "Answer",
							 hidden: false,
							 width: "200px"
						   },
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.partyIdErrors.grid.columns();

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },

			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});


			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".excel-button").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_PartyId_Report",
									 1487,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("ARK_PartyId_Report_" + util.getDate((new Date()).toISOString(), true))

									);
			});

			mo.fn.overlay.hide();
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1487/ARK_PartyId_Report/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			//filter: filter,
			/* set page size*/
			//serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			/*sort: {
                                field: "Expiry",
                                dir: "asc"
                              }*/

		  });
		}
	  },
	  resellerSimplified: {
		init: function(holder) {
		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="resellerSimplified-grid"></div>';
		  reporting.ark.resellerSimplified.grid.load(holder, holder.querySelector('.resellerSimplified-grid'), reporting.ark.resellerSimplified.dataSource());
		  var grid = $(holder.querySelector('.resellerSimplified-grid')).getKendoGrid();
		  grid.setDataSource(reporting.ark.resellerSimplified.dataSource());
		},
		grid: {
		  columns: function() {
			var columns = [{
			  field: "CompanyId",
			  title: "Company Id",
			  hidden: false,
			  width: "200px"
			},
						   {
							 field: "CompanyName",
							 title: "Company Name",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "CaseId",
							 title: "Case Id",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "CountryName",
							 title: "Country Name",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "ReminderDate",
							 title: "Reminder Date",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Days",
							 title: "Days",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Subject",
							 title: "Subject",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "Status",
							 title: "Status",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "To",
							 title: "To",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "FirstName",
							 title: "First Name",
							 hidden: false,
							 width: "200px"
						   },
						   {
							 field: "LastName",
							 title: "Last Name",
							 hidden: false,
							 width: "200px"
						   }
						  ];

			return columns;
		  },
		  load: function(holder, selector, datasource) {
			var columns = reporting.ark.resellerSimplified.grid.columns();

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },

			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});


			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".excel-button").addEventListener("click",
																   function(e) {

			  reporting.exportReport("ARK_Reseller_Simplified_report",
									 1275,
									 JSON.stringify(grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field)),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("ARK_Reseller_Simplified_report_" + util.getDate((new Date()).toISOString(), true))

									);
			});

			mo.fn.overlay.hide();
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1275/ARK_Reseller_Simplified_report/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			//filter: filter,
			/* set page size*/
			//serverFiltering: true,
			//filter: filter,
			serverSorting: true,
			/* set default sort */
			/*sort: {
                                field: "Expiry",
                                dir: "asc"
                              }*/

		  });
		}
	  },
	},
	legacy: {
	  init: function(holder) {
		holder.innerHTML = "";
		hpe.ui.tabs({
		  dom: holder,
		  tabs: [{
			label: "Profiles",
			id: 'profiles'
		  },
				 {
				   label: "Profile notes",
				   id: "profile-notes"
				 },
				 {
				   label: "Profile documents",
				   id: "profile-docs"
				 },
				 {
				   label: "Profile audit",
				   id: "profile-audit"
				 },
				 {
				   label: "Cases",
				   id: "cases"
				 },
				 {
				   label: "Case notes",
				   id: "case-notes"
				 },
				 {
				   label: "Case documents",
				   id: "case-docs"
				 },
				 {
				   label: "Case audit",
				   id: "case-audit"
				 },
				 {
				   label: "Due Diligence",
				   id: "ddq"
				 },
				 {
				   label: "Associated Connections",
				   id: "assoc-conn"
				 },
				 {
				   label: "Associated Profiles",
				   id: "assoc-profiles"
				 },
				 {
				   label: "Attachments Overview",
				   id: "attachments-overview"
				 },
				]
		}, function(all) {
		  reporting.legacy.profiles.init(all[0]);

		  holder.querySelector('[tab-id="profile-notes"]').addEventListener('click', function() {
			reporting.legacy.profileNotes.init(all[1]);
		  });

		  holder.querySelector('[tab-id="profile-docs"]').addEventListener('click', function() {
			reporting.legacy.profileDocs.init(all[2]);
		  });

		  holder.querySelector('[tab-id="profile-audit"]').addEventListener('click', function() {
			reporting.legacy.profileAudit.init(all[3]);
		  });

		  holder.querySelector('[tab-id="cases"]').addEventListener('click', function() {
			reporting.legacy.cases.init(all[4]);
		  });

		  holder.querySelector('[tab-id="case-notes"]').addEventListener('click', function() {
			reporting.legacy.caseNotes.init(all[5]);
		  });

		  holder.querySelector('[tab-id="case-docs"]').addEventListener('click', function() {
			reporting.legacy.caseDocs.init(all[6]);
		  });

		  holder.querySelector('[tab-id="case-audit"]').addEventListener('click', function() {
			reporting.legacy.caseAudit.init(all[7]);
		  });

		  holder.querySelector('[tab-id="ddq"]').addEventListener('click', function() {
			reporting.legacy.caseDDQ.init(all[8]);
		  });


		  holder.querySelector('[tab-id="assoc-conn"]').addEventListener('click', function() {
			reporting.legacy.assocConnections.init(all[9]);
		  });
		  holder.querySelector('[tab-id="assoc-profiles"]').addEventListener('click', function() {
			reporting.legacy.assocProfiles.init(all[10]);
		  });
		  holder.querySelector('[tab-id="attachments-overview"]').addEventListener('click', function() {
			reporting.legacy.attachOverview.init(all[11]);
		  });
		});
	  },
	  profiles: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profiles-grid"></div>';

		  var cols = [{
			field: "ThirdPartyCreated",
			title: "Third Party Created"
		  }, {
			field: "ThirdPartyLastUpdated",
			title: "Third Party Last Updated"
		  }, {
			field: "ThirdPartyLastUpdated",
			title: "ThirdPartyLastUpdated"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $('.profiles-grid').getKendoGrid();
			grid.setDataSource(reporting.legacy.profiles.dataSource(data));
			grid.dataSource.read();

		  });

		  reporting.legacy.profiles.grid.getColumns(function() {
			reporting.legacy.profiles.grid.load(holder, holder.querySelector('.profiles-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1376, "ARK_Migration. Profiles Data", function(columns) {
			  reporting.legacy.profiles.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.profiles.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.profiles.grid.columns, 1376, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.profiles.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_Profiles_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Profiles Data",
									 1376,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_Profiles_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }

		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1376/ARK_Migration. Profiles Data/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                                    field: "EntryId",
                                    dir: "desc"
                                  }*/

		  });
		}
	  },
	  profileDocs: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profileDocs-grid"></div>';

		  var cols = [{
			field: "ProfileDocumentUploaded",
			title: "Profile Document Uploaded"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.profileDocs-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.profileDocs.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.profileDocs.grid.getColumns(function() {
			reporting.legacy.profileDocs.grid.load(holder, holder.querySelector('.profileDocs-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1379, "ARK_Migration. Profile Attachments", function(columns) {
			  reporting.legacy.profileDocs.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.profileDocs.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.profileDocs.grid.columns, 1379, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId", "ThirdPartyStatus"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.profileDocs.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_ProfileDocuments_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {
			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Profile Attachments",
									 1379,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_ProfileDocuments_" + util.getDate((new Date()).toISOString(), true))
									);

			});

		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1379/ARK_Migration. Profile Attachments/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                                    field: "EntryId",
                                    dir: "desc"
                                  }*/

		  });
		}
	  },
	  profileNotes: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profileNotes-grid"></div>';

		  var cols = [{
			field: "ProfileNotesCreated",
			title: "Profile Notes Created"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.profileNotes-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.profileNotes.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.profileNotes.grid.getColumns(function() {
			reporting.legacy.profileNotes.grid.load(holder, holder.querySelector('.profileNotes-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1377, "ARK_Migration. Profile Notes", function(columns) {
			  reporting.legacy.profileNotes.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.profileNotes.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.profileNotes.grid.columns, 1377, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId", "ThirdPartyStatus"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.profileNotes.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_ProfileNotes_" + util.getDate((new Date()).toISOString()) + ".xlsx",
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Profile Notes",
									 1377,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_ProfileNotes_" + util.getDate((new Date()).toISOString(), true))
									);

			});

		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1377/ARK_Migration. Profile Notes/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                                    field: "EntryId",
                                    dir: "desc"
                                  }*/

		  });
		}
	  },
	  profileAudit: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="profileAudit-grid"></div>';

		  var cols = [{
			field: "AuditLogCreated",
			title: "Audit Log Created"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.profileAudit-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.profileAudit.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.profileAudit.grid.getColumns(function() {
			reporting.legacy.profileAudit.grid.load(holder, holder.querySelector('.profileAudit-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1378, "ARK_Migration. Profile Audit", function(columns) {
			  reporting.legacy.profileAudit.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.profileAudit.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.profileAudit.grid.columns, 1378, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.profileAudit.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_ProfileNotes_" + util.getDate((new Date()).toISOString()) + ".xlsx",
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Profile Audit",
									 1378,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_ProfileNotes_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1378/ARK_Migration. Profile Audit/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                                    field: "EntryId",
                                    dir: "desc"
                                  }*/

		  });
		}
	  },
	  cases: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="cases-grid"></div>';

		  var cols = [{
			field: "CaseLastUpdated",
			title: "Case Last Updated"
		  }, {
			field: "CaseDueDate",
			title: "Case Due Date"
		  }, {
			field: "CaseLastUpdated",
			title: "Case Last Updated"
		  }, {
			field: "SubjectLastModified",
			title: "Subject Last Modified"
		  },
					  {
						field: "CaseIntakeFormSubmitted",
						title: "Case Intake Form Submitted"
					  }, {
						field: "csContractInactivationDate",
						title: "cs Contract Inactivation Date"
					  },
					  {
						field: "csDdiStartDate",
						title: "cs Ddi Start Date"
					  }, {
						field: "csDdiCompletedDate",
						title: "cs Ddi Completed Date"
					  }, {
						field: "csDdiScoringCompletedDate",
						title: "cs Ddi Scoring Completed Date"
					  },
					  {
						field: "csDdiDateAssignedToAgility",
						title: "cs Ddi Date Assigned To Agility"
					  }, {
						field: "csDdiAgilityReleaseDate",
						title: "cs Ddi Agility Release Date"
					  }, {
						field: "csIddDateAssignedToAgility",
						title: "cs Idd Date Assigned To Agility"
					  }, {
						field: "csIddAgilityReleaseDate",
						title: "cs Idd Agility Release Date"
					  }, {
						field: "csOsiAgilityReleaseDate",
						title: "cs Osi Agility Release Date"
					  }, {
						field: "csEddDecisionReleasedDate",
						title: "cs Edd Decision Released Date"
					  }, {
						field: "csDdqReminderDate",
						title: "cs Ddq Reminder Date"
					  }, {
						field: "csReactivationRequestTriggerDate",
						title: "cs Reactivation Request Trigger Date"
					  }, , {
					  field: "csDdqReactivationTriggerDate",
					  title: "cs Ddq Reactivation Trigger Date"
					  }, {
					  field: "csBuEddDecisionDate",
					  title: "cs Bu Edd Decision Date"
					  }, {
					  field: "csEddTriggerDate",
					  title: "cs Edd Trigger Date"
					  }, {
					  field: "csEddResultReceiveDate",
					  title: "cs Edd Result Receive Date"
					  }, {
					  field: "csShbcResultReceiveDate",
					  title: "cs Shbc Result Receive Date"
					  }, {
					  field: "ThirdPartyApprovalStatusChange",
					  title: "Third Party Approval Status Change"
					  }, {
					  field: "ThirdPartyCreated",
					  title: "Third Party Created"
					  }, {
					  field: "ThirdPartyLastGDCScreening",
					  title: "Third Party Last GDC Screening"
					  }, {
					  field: "ThirdPartyLastUpdated",
					  title: "Third Party Last Updated"
					  }, {
					  field: "ThirdPartyLastUpdated",
					  title: "Third Party Last Updated"
					  }
					 ];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.cases-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.cases.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.cases.grid.getColumns(function() {
			reporting.legacy.cases.grid.load(holder, holder.querySelector('.cases-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1380, "ARK_Migration. Cases Data", function(columns) {
			  reporting.legacy.cases.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.cases.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.cases.grid.columns, 1380, true, true);
			columns.forEach(x => {
			  x.width = "250px";
			});


			var datasource = reporting.legacy.cases.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));


			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /*toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_Profiles_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Cases Data",
									 1380,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_Cases_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1380/ARK_Migration. Cases Data/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "Case",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter

		  });
		}
	  },
	  caseDocs: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseDocs-grid"></div>';

		  var cols = [{
			field: "CaseAttachUploaded",
			title: "Case Attach Uploaded"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.caseDocs-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.caseDocs.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.caseDocs.grid.getColumns(function() {
			reporting.legacy.caseDocs.grid.load(holder, holder.querySelector('.caseDocs-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1383, "ARK_Migration. Case Attachments", function(columns) {
			  reporting.legacy.caseDocs.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.caseDocs.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.caseDocs.grid.columns, 1383, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.caseDocs.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /* toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_ProfileDocuments_" + util.getDate((new Date()).toISOString()) + ".xlsx", //beautify date
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Case Attachments",
									 1383,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_CaseDocuments_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1383/ARK_Migration. Case Attachments/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                                    field: "EntryId",
                                    dir: "desc"
                                  }*/

		  });
		}
	  },
	  caseNotes: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseNotes-grid"></div>';

		  var cols = [{
			field: "CaseNotesCreated",
			title: "Case Notes Created"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.caseNotes-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.caseNotes.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.caseNotes.grid.getColumns(function() {
			reporting.legacy.caseNotes.grid.load(holder, holder.querySelector('.caseNotes-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1381, "ARK_Migration. Case Notes", function(columns) {
			  reporting.legacy.caseNotes.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.caseNotes.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.caseNotes.grid.columns, 1381, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.caseNotes.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Case Notes",
									 1381,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_CaseNotes_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1381/ARK_Migration. Case Notes/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                                    field: "EntryId",
                                    dir: "desc"
                                  }*/

		  });
		}
	  },
	  caseAudit: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseAudit-grid"></div>';
		  var cols = [{
			field: "AuditLogCreated",
			title: "Audit Log Created"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.caseAudit-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.caseAudit.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.caseAudit.grid.getColumns(function() {
			reporting.legacy.caseAudit.grid.load(holder, holder.querySelector('.caseAudit-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1382, "ARK_Migration. Case Audit", function(columns) {
			  reporting.legacy.caseAudit.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.caseAudit.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.caseAudit.grid.columns, 1382, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.caseAudit.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /* toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_CaseNotes_" + util.getDate((new Date()).toISOString()) + ".xlsx",
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("ARK_Migration. Case Audit",
									 1382,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_CaseNotes_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1382/ARK_Migration. Case Audit/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                        field: "EntryId",
                        dir: "desc"
                      }
          */
		  });
		}
	  },
	  caseDDQ: {
		holder: null,
		init: function(holder) {
		  holder.innerHTML = '<div class="intakeSelector"></div><div class="ddq-report"></div>';
		  reporting.legacy.caseDDQ.holder = holder;
		  mo.fn.overlay.show({
			loading: true,
			close: false
		  });
		  reporting.legacy.caseDDQ.intakeFormSelector.getData(function() {
			mo.fn.overlay.hide();
			reporting.legacy.caseDDQ.intakeFormSelector.init(holder.querySelector('.intakeSelector'));
		  });
		},
		intakeFormSelector: {
		  intakeFormData: [],
		  init: function(node, callback) {
			node.innerHTML = "<div class='intakeForm-filter' style='margin-bottom:20px;'></div>";
			var conf = {
			  dom: node.querySelector('.intakeForm-filter'),
			  pages: [{
				nav: false,
				structure: [{
				  group: [
					[{
					  label: "Intake Form",
					  data: "intakeFormSelector",
					  type: "select",
					  values: reporting.legacy.caseDDQ.intakeFormSelector.intakeFormData,
					}, ]
				  ]
				}, ],
				callback: function() {
				  node.querySelector('[data-name="intakeFormSelector"]').addEventListener('change', function(ev) {
					reporting.legacy.caseDDQ.intakeFormSelector.changeForm(ev.target.value);
				  });
				},
			  }],
			  dataset: {},
			};
			nbsf.init(conf, 0);
		  },
		  getData: function(callback) {
			const ds = reporting.legacy.caseDDQ.intakeFormSelector.dataSource();
			ds.fetch(function() {
			  var intakeFormData = this.data();
			  reporting.legacy.caseDDQ.intakeFormSelector.intakeFormData = intakeFormData.map(el => {
				return el.IntakeForm;
			  });
			  callback();
			});
		  },
		  changeForm: function(val) {
			reporting.legacy.caseDDQ.grid.intakeForm = val;
			var container = reporting.legacy.caseDDQ.holder.querySelector('.ddq-report');
			container.innerHTML = "";
			container.innerHTML += '<div><div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="caseDDQ-grid"></div></div>';
			var cols = [{
			  field: "CaseCreated",
			  title: "Case Created Date"
			}, {
			  field: "CaseSubmitted",
			  title: "Case Submitted Date"
			}];
			reporting.intervalMethod.init(container.querySelector('.flter'), cols, function(data) {
			  var grid = $(container.querySelector('.caseDDQ-grid')).getKendoGrid();
			  grid.setDataSource(reporting.legacy.caseDDQ.dataSource(data));
			  grid.dataSource.read();
			});
			reporting.legacy.caseDDQ.grid.load(container.querySelector('.caseDDQ-grid'));
		  },
		  dataSource: function() {
			return new kendo.data.DataSource({
			  type: "rfb-v2",
			  transport: {
				read: {
				  url: globalReferences.server + "form/data-set-provider/v2/1422/Migration DDQ Answers V2 Intake Forms/kendo/data/search",
				  type: 'POST'
				},
			  },
			  schema: {
				model: {
				  id: "EntryId",
				  /* please define primary key name */
				  fields: {
					/* define filed here for use update/create*/
				  }
				}
			  },
			  serverPaging: true,
			  pageSize: 100,
			  serverSorting: true,
			  sort: {
				field: "IntakeForm",
				dir: "asc"
			  }
			});
		  }

		},
		grid: {
		  columns: [],
		  intakeForm: "",
		  setColumns: function() {
			var res = [];

			reporting.legacy.caseDDQ.grid.columns.forEach(x => {
			  var column = {};
			  column.title = x;
			  column.field = "[\"" + x.replace(/\W/g, '') + "\"]";
			  column.width = "250px";
			  column.headerAttributes = {
				style: "white-space: normal"
			  };
			  res.push(column);
			});


			return res;
		  },
		  load: function(selector) {
			var datasource = reporting.legacy.caseDDQ.dataSource();

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  autoBind: false,
			  dataSource: datasource,
			  //columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: false,
			  resizable: true,
			  dataBound: function(e) {
				if (reporting.legacy.caseDDQ.grid.columns && reporting.legacy.caseDDQ.grid.columns.length > 0) {
				  setTimeout(function() {
					e.sender.setOptions({
					  columns: reporting.legacy.caseDDQ.grid.setColumns()
					});
					reporting.legacy.caseDDQ.grid.columns = null;
					e.sender.refresh();
				  }, 10);
				}
			  },
			  filter: util.kendoGrid.filter
			});
			datasource.read();
			var grid = $(selector).data("kendoGrid");
			reporting.legacy.caseDDQ.holder.querySelector(".k-grid-excel").addEventListener("click",
																							function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  new_columns.push({
				field: "JSON",
				title: "JSON"
			  });

			  var sort = grid.dataSource.sort();
			  sort.forEach(x => x.field = x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""));
			  reporting.exportReport("Migration. DDQ Answers V2",
									 1422,
									 JSON.stringify(new_columns),
									 JSON.stringify(sort),
									 JSON.stringify(grid.dataSource.filter()),
									 ("LegacyData_CaseDDQ_" + util.getDate((new Date()).toISOString(), true))
									);

			});

		  }
		},
		dataSource: function(filter) {
		  const intakeFilter = {
			field: "IntakeForm",
			operator: "eq",
			value: reporting.legacy.caseDDQ.grid.intakeForm
		  };
		  if (filter) {
			if (filter.filters) {
			  filter.filters.push(intakeFilter);
			} else {
			  filter = {
				logic: "and",
				filters: [intakeFilter, filter]
			  };
			}
		  } else {
			filter = {
			  logic: "and",
			  filters: [intakeFilter, ]
			};
		  }
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1422/Migration. DDQ Answers V2/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  parse: function(response) {
				var columns = [];
				if (response.Data.length > 0) {
				  var json = response.Data[0].JSON;
				  var colItem = JSON.parse(json);
				  columns = Object.keys(colItem).filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"]);
				}
				for (var i = 0; i < response.Data.length; i++) {
				  var item = JSON.parse(response.Data[i].JSON);
				  response.Data[i] = {};
				  columns.map((col, idx) => {
					if (Object.prototype.toString.call(item[col]) === '[object Date]') {
					  response.Data[i][col.replace(/\W/g, '')] = new Date(item[col]).toLocaleDateString();
					} else {
					  response.Data[i][col.replace(/\W/g, '')] = item[col];
					}
				  });
				}
				reporting.legacy.caseDDQ.grid.columns = columns;
				return response;
			  },
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter,
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}

		  });
		}
	  },
	  assocConnections: {
		init: function(holder) {
		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="assocConnections-grid"></div>';

		  reporting.legacy.assocConnections.grid.getColumns(function() {
			reporting.legacy.assocConnections.grid.load(holder, holder.querySelector('.assocConnections-grid'));
			var grid = $(holder.querySelector('.assocConnections-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.assocConnections.dataSource());
			grid.dataSource.read();
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1454, "Migration. 3P Associated Connections", function(columns) {
			  reporting.legacy.assocConnections.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.assocProfiles.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.assocConnections.grid.columns, 1454, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.assocConnections.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("Migration. 3P Associated Connections",
									 1454,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("3P_Associated_Connections_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function() {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1454/Migration. 3P Associated Connections/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
		  });
		}
	  },
	  assocProfiles: {
		init: function(holder) {
		  holder.innerHTML = '<div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="assocProfiles-grid"></div>';

		  reporting.legacy.assocProfiles.grid.getColumns(function() {
			reporting.legacy.assocProfiles.grid.load(holder, holder.querySelector('.assocProfiles-grid'));
			var grid = $(holder.querySelector('.assocProfiles-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.assocProfiles.dataSource());
			grid.dataSource.read();
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1455, "Migration. 3P Associated Profiles", function(columns) {
			  reporting.legacy.assocProfiles.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.assocProfiles.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.assocProfiles.grid.columns, 1455, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.assocProfiles.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("Migration. 3P Associated Profiles",
									 1455,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("3P_Associated_Profiles_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function() {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1455/Migration. 3P Associated Profiles/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
		  });
		}
	  },
	  attachOverview: {
		init: function(holder) {
		  holder.innerHTML = '<div class="flter"></div><div role="button" class="k-button k-button-icontext k-grid-excel excel-button" href="#">Export Excel</div><div class="attachOverview-grid"></div>';
		  var cols = [{
			field: "ProfileDocumentUploaded",
			title: "Profile Document Uploaded"
		  }];
		  reporting.intervalMethod.init(holder.querySelector('.flter'), cols, function(data) {

			var grid = $(holder.querySelector('.attachOverview-grid')).getKendoGrid();
			grid.setDataSource(reporting.legacy.attachOverview.dataSource(data));
			grid.dataSource.read();
		  });

		  reporting.legacy.attachOverview.grid.getColumns(function() {
			reporting.legacy.attachOverview.grid.load(holder, holder.querySelector('.attachOverview-grid'));
		  });
		},
		grid: {
		  columns: [],
		  getColumns: function(callback) {
			reporting.getColumnsOfTable(1456, "Migration. 3P Attachments Overview", function(columns) {
			  reporting.legacy.attachOverview.grid.columns = columns;
			  callback();
			});

			return reporting.legacy.attachOverview.grid.columns;
		  },
		  load: function(holder, selector) {

			var columns = reporting.getKendoColumnsFromNames(reporting.legacy.attachOverview.grid.columns, 1456, false, true);
			columns.forEach(x => {
			  x.width = "250px";
			});

			columns = columns.filter(x => ["Created", "CreatedBy", "Modified", "ModifiedBy", "EntryId"].indexOf(x.field) == -1);

			var datasource = reporting.legacy.attachOverview.dataSource();
			util.kendoGrid.addDateFieldsToSchema(datasource, columns.filter(x => x.systemType == "Date").map(x => x.field));

			$(selector).kendoGrid({
			  height: 500,
			  noRecords: {
				template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			  },
			  /* toolbar: [{
                          name: "excel",
                          text: "Export Excel"
                        }],
                        excel: {
                          fileName: "LegacyData_CaseNotes_" + util.getDate((new Date()).toISOString()) + ".xlsx",
                          filterable: true,
                          allPages: true
                        },		
                        excelExport: util.exportExcel,*/
			  dataSource: datasource,
			  columns: columns,
			  pageable: {
				buttonCount: 4,
				pageSize: 10,
				pageSizes: [10, 25, 50, 100],
				messages: {
				  itemsPerPage: ""
				},
				refresh: true
			  },
			  scrollable: true,
			  sortable: true,
			  filterable: true,
			  resizable: true,
			  dataBound: util.kendoGrid.dataBound,
			  filter: util.kendoGrid.filter
			});

			var grid = $(selector).data("kendoGrid");
			holder.querySelector(".k-grid-excel").addEventListener("click",
																   function(e) {

			  var columns = grid.columns.map(({
				field,
				title
			  }) => ({
				field,
				title
			  })).filter(x => x.field);
			  var new_columns = []
			  columns.forEach(x => {
				new_columns.push({
				  field: x.field.replace("[", "").replace("]", "").replace('"', "").replace('"', ""),
				  title: x.title
				});
			  });
			  reporting.exportReport("Migration. 3P Attachments Overview",
									 1456,
									 JSON.stringify(new_columns),
									 JSON.stringify(grid.dataSource.sort()),
									 JSON.stringify(grid.dataSource.filter()),
									 ("Attachments_Overview_" + util.getDate((new Date()).toISOString(), true))
									);

			});
		  }
		},
		dataSource: function(filter) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1456/Migration. 3P Attachments Overview/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				id: "EntryId",
				/* please define primary key name */
				fields: {
				  /* define filed here for use update/create*/
				}
			  }
			},
			serverPaging: true,
			pageSize: 15,
			serverFiltering: true,
			serverSorting: true,
			filter: filter
			/*sort: {
                        field: "EntryId",
                        dir: "desc"
                      }
          */
		  });
		}
	  },

	},
	myReports: {
	  init: function(holder) {
		holder.innerHTML = "<div class='myReports-grid'></div>";
		reporting.myReports.grid.load(holder.querySelector('.myReports-grid'), reporting.myReports.grid.dataSource(), reporting.myReports.grid.columns());
	  },
	  grid: {
		dataSource: function(callback) {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1424/Reports/kendo/data/search",
				type: 'POST'
			  },
			},
			pageSize: 10,
			serverPaging: true,
			serverFiltering: true,
			serverSorting: true,
			filter: [{
			  field: "RequestedBy",
			  operator: "eq",
			  value: access.user.Email
			},
					 {
					   field: "Source",
					   operator: "eq",
					   value: "ARK"
					 },
					 {
					   field: "Status",
					   operator: "eq",
					   value: "1"
					 },
					 {
					   field: "Cancelled",
					   operator: "isempty",
					   value: ""
					 }
					],
			sort: {
			  field: "EntryId",
			  dir: "desc"
			}
		  });
		},
		columns: function() {
		  var cusConfig = [{
			field: "EntryId",
			title: "ID",
			hidden: false,
			filterable: true,
			width: "110px"
		  },
						   {
							 field: "Filename",
							 title: "File Name",
							 hidden: false,
							 filterable: true,
						   },
						   {
							 field: "Percentage",
							 title: "Progress",
							 hidden: false,
							 filterable: true,
							 width: "150px"
						   },
						   {
							 field: "StartDate",
							 title: "Start Date",
							 hidden: false,
							 filterable: true,
							 template: function(data) {
							   if (!data.StartDate)
								 return "Calculating...";
							   var d = new Date();
							   var date = new Date(new Date(data.StartDate) - new Date(d.getTimezoneOffset() * 60 * 1000)).toLocaleString();
							   date = date.replace(",", "") || "N/A";

							   return date;
							 },
							 width: "170px"
						   },
						   {
							 field: "Finish",
							 title: "Finish Date",
							 hidden: false,
							 filterable: true,
							 template: function(data) {
							   if (!data.Finish)
								 return "Calculating...";
							   var d = new Date();
							   var date = new Date(new Date(data.Finish) - new Date(d.getTimezoneOffset() * 60 * 1000)).toLocaleString();
							   date = date.replace(",", "") || "N/A";
							   return date;
							 },
							 width: "170px"
						   },
						   {
							 field: "Expire",
							 title: "Expire",
							 hidden: false,
							 filterable: true,
							 template: function(d) {
							   return util.getDate(d.Expire, true) || "";
							 },
							 width: "170px"
						   },
						   {
							 title: "Actions",
							 width: "100px",
							 attributes: {
							   "class": "cta"
							 },
							 template: function(d) {
							   var icons = '<a style="margin-right: 5px" class="view_rep_prog"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></svg></a>';

							   if (d.Percentage >= 100)
								 icons += '<a style="margin-left:10px" href="#" class="download"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="download" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M1,17 L1,23 L23,23 L23,17 M12,2 L12,19 M5,12 L12,19 L19,12"></path></svg></a>';

							   return icons;
							 }
						   }
						  ];
		  return cusConfig;
		},
		load: function(selector, datasource, columns) {

		  $(selector).kendoGrid({
			height: 500,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			},
			dataSource: datasource,
			columns: columns,
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
			resizable: true,
			dataBound: function() {
			  $(selector).find('.view_rep_prog').on('click', function(ev) {
				var grid = $(selector).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));
				reporting.myReports.reportProgress.init(row.EntryId);
			  });

			  $(selector).find('.download').click(function(ev) {
				var grid = $(selector).data("kendoGrid");
				var row = grid.dataItem($(this).closest("tr"));


				var aLink = document.createElement("a");
				aLink.setAttribute("target", "_self");
				aLink.innerHTML = row.Filename;
				aLink.setAttribute("href", row.Path);
				aLink.click();
			  });
			},
			filter: util.kendoGrid.filter
		  });



		}
	  },
	  reportProgress: {
		reportData: {},
		init: function(id) {
		  mo.fn.overlay.show({
			loading: true,
			close: false
		  });
		  reporting.myReports.reportProgress.getData(id, function() {
			mo.fn.overlay.hide();
			reporting.myReports.reportProgress.ui();
		  });
		},
		getData: function(id, cb) {
		  reporting.myReports.reportProgress.getColumnMapping(function() {
			crud.read("4160", "eid=" + id, function(d) {
			  if (d.Rows && d.Rows.length > 0)
				reporting.myReports.reportProgress.reportData = d.Rows[0];

			  cb();
			});
		  });
		},
		getColumnMapping: function(cb) {
		  if (reporting.mappingData)
			cb();
		  else
			reporting.getColumnMapping(cb)
		},
		ui: function() {

		  mo.fn.modal.show({
			ctaLabel: 'Ok',
			title: 'Report # ' + reporting.myReports.reportProgress.reportData.EntryId,
			class: "ark-modal",
			content: '<div class="report-progress-wrapper" style="overflow:hidden;padding-bottom:10px;max-width:100%"></div>',
			contentCallback: function() {
			  document.querySelector('.report-progress-wrapper').innerHTML = reporting.myReports.reportProgress.template();
			  reporting.myReports.reportProgress.createUI();
			  reporting.myReports.reportProgress.updateUI();
			  reporting.myReports.reportProgress.startTimer();
			},
			ctaCallback: function() {
			  clearInterval(reporting.myReports.reportProgress.timer);
			  clearInterval(reporting.myReports.reportProgress.sendEmailTimer);

			  mo.fn.modal.hide();
			}
		  });
		},
		startTimer: function() {
		  if (reporting.myReports.reportProgress.reportData.Progress >= 100)
			return;

		  reporting.myReports.reportProgress.timer = setInterval(function() {
			reporting.myReports.reportProgress.getData(reporting.myReports.reportProgress.reportData.EntryId, function() {
			  reporting.myReports.reportProgress.updateUI();
			});
		  },
																 1000);
		},
		updateUI: function() {
		  var node = document.querySelector('.report-progress-wrapper');
		  var data = reporting.myReports.reportProgress.reportData;

		  node.querySelector("#download").style.display = data.Percentage >= 100 && data.Cancelled != 1 ? "block" : "none";
		  node.querySelector("#cancel").style.display = data.Percentage != 100 && data.Cancelled != 1 ? "block" : "none";

		  node.querySelector("#records").innerHTML = data.TotalRows || "Calculating...";

		  var d = new Date();
		  d.setTime(d.getTime() + d.getTimezoneOffset() * 60 * 1000);
		  d = new Date(d);

		  if (data.StartDate) {
			var startDate = new Date(new Date(data.StartDate) - new Date(d.getTimezoneOffset() * 60 * 1000)).toLocaleString();
			node.querySelector("#reportRequested").innerHTML = startDate.replace(",", "") || "N/A";
		  } else
			node.querySelector("#reportRequested").innerHTML = "Calculating...";

		  if (data.Finish) {
			var finishDate = new Date(new Date(data.Finish) - new Date(d.getTimezoneOffset() * 60 * 1000)).toLocaleString();
			node.querySelector("#finish").innerHTML = finishDate.replace(",", "") || "N/A";
		  } else
			node.querySelector("#finish").innerHTML = "Calculating...";

		  if (data.Expire) {
			var finishDate = new Date(new Date(data.Expire) - new Date(d.getTimezoneOffset() * 60 * 1000)).toLocaleString();
			node.querySelector("#reportExpire").innerHTML = finishDate.split(",")[0] || "N/A";
		  } else
			node.querySelector("#reportExpire").innerHTML = "Calculating...";

		  if (data.Percentage == 100 || data.Cancelled == 1)
			node.querySelector("#elapsed").innerHTML = util.dateDiffToString(new Date(data.Finish), new Date(data.StartDate));
		  else if (data.StartDate)
			node.querySelector("#elapsed").innerHTML = util.dateDiffToString(d, new Date(data.StartDate));
		  else node.querySelector("#elapsed").innerHTML = "Calculating...";

		  if (data.Percentage >= 100 || new Date(data.Finish) < d)
			node.querySelector("#remaining").innerHTML = "00:00:00";
		  else if (data.Finish)
			node.querySelector("#remaining").innerHTML = util.dateDiffToString(new Date(data.Finish), d);
		  else node.querySelector("#remaining").innerHTML = "N/A";

		  if (data.Percentage) {
			//just in case
			if (data.Percentage > 100)
			  data.Percentage = 100;

			node.querySelector("#progress").style.width = data.Percentage + "%";
			node.querySelector("#progressLabel").innerHTML = data.Percentage + "%";
		  }

		  if (data.Cancelled == 1) {
			node.querySelector("#remaining").innerHTML = "Cancelled";
			node.querySelector("#finish").innerHTML = "Cancelled";
			node.querySelector("#reportExpire").innerHTML = "Cancelled";
		  }


		},
		createUI: function() {
		  var node = document.querySelector('.report-progress-wrapper');
		  var data = reporting.myReports.reportProgress.reportData;

		  document.querySelector(".dxpModalClose").addEventListener("click", function() {
			clearInterval(reporting.myReports.reportProgress.timer);
			clearInterval(reporting.myReports.reportProgress.sendEmailTimer);
		  });


		  node.querySelector("#download").addEventListener("click", function() {
			var aLink = document.createElement("a");
			aLink.setAttribute("target", "_self");
			aLink.innerHTML = reporting.myReports.reportProgress.reportData.Filename;
			aLink.setAttribute("href", reporting.myReports.reportProgress.reportData.Path);
			aLink.click();
		  });


		  node.querySelector("#cancel").addEventListener("click", function() {

			reporting.myReports.reportProgress.reportData.Cancelled = 1;

			crud.update("4164", reporting.myReports.reportProgress.reportData.EntryId, {
			  Cancelled: reporting.myReports.reportProgress.reportData.Cancelled
			}, function() {

			});
		  });


		  var nbsfSendEmail = {
			dom: node.querySelector("#send-email"),
			pages: [{
			  nav: false,
			  structure: [{
				group: [
				  [{
					label: "Send an email after generating the report",
					data: "SendEmail",
					required: false,
					type: "toggle",
					value: reporting.myReports.reportProgress.reportData.SendEmail == 1 ? "Y" : "N",
					values: ['N', 'Y'],
				  }]
				]
			  }]
			}],
			dataset: {},
		  };
		  nbsf.init(nbsfSendEmail, 0);

		  //TODO
		  if (data.Percentage < 100)
			reporting.myReports.reportProgress.sendEmailTimer = setInterval(function() {
			  if (data.Percentage >= 100)
				return;
			  var newValue = document.querySelector("input[data-name=SendEmail]").value == "Y" ? 1 : 0;
			  if (!reporting.myReports.reportProgress.reportData.SendEmail)
				reporting.myReports.reportProgress.reportData.SendEmail = 0;

			  if (reporting.myReports.reportProgress.reportData.SendEmail != newValue) {
				reporting.myReports.reportProgress.reportData.SendEmail = newValue;
				crud.update("4164", reporting.myReports.reportProgress.reportData.EntryId, {
				  SendEmail: reporting.myReports.reportProgress.reportData.SendEmail
				}, function() {});
			  }
			});

		  document.querySelector("#send-email .row").style.marginBottom = "0px";
		  document.querySelector("#send-email .row .name").style.fontWeight = "500px";
		  document.querySelector("#send-email .row .name").style.fontSize = "19px";
		  document.querySelector("#send-email .row .name").style.color = "black";
		  document.querySelector("#send-email .row .name").style.marginLeft = "-2px";
		  document.querySelector("#send-email .row .fmmcosmin").style.left = "330px";
		  document.querySelector("#send-email .row .toggle").style.marginTop = "10px";

		  node.querySelector("#reportName").innerHTML = data.Filename;
		  node.querySelector("#reportRequestedBy").innerHTML = data.RequestedBy;
		  node.querySelector("#reportRequested").innerHTML = util.getDate(data.StartDate);


		  var convertKendoOperator = function(value) {
			var info = reporting.reportBuilder.kendoOperators.find(x => x.value == value);
			if (info) return info.option;
			return value;
		  }

		  var convertColumnName = function(name) {
			name = name.replace("[", "").replace("]", "").replace('"', "").replace('"', "");
			var info = reporting.mappingData[name];
			if (info) return info.Title;
			return name;
		  }

		  var divSorting = node.querySelector("#sorting");
		  if (data.Sort) {
			var getSortString = function(sort) {
			  return "<div>" + convertColumnName(sort.field) + ": " + (sort.dir == "asc" ? "Ascending" : "Descending") + "</div>";
			}

			eval('var sort=' + data.Sort);
			if (sort.length) {
			  sort.forEach(x => {
				divSorting.innerHTML += getSortString(x);
			  });
			}
		  }

		  if (!divSorting.innerHTML.trim())
			divSorting.innerHTML = "No sorting";

		  var divFilters = node.querySelector("#filters");
		  if (data.Filter) {
			var getFilterString = function(filter) {
			  if (new Date(filter.value) != "Invalid Date")
				filter.value = util.getDate(new Date(filter.value).toISOString(), true);
			  return "<div><b>" + convertColumnName(filter.field) + "</b> " + convertKendoOperator(filter.operator) + " <b>" + filter.value + "</b></div>";
			}

			eval('var filter=' + data.Filter);
			if (filter.filters)
			  filter.filters.forEach(x => {
				if (x.filters)
				  x.filters.forEach(xx => {
					divFilters.innerHTML += getFilterString(xx);
				  });
				else if (x.field) divFilters.innerHTML += getFilterString(x);
			  });
			else if (filter.field) divFilters.innerHTML += getFilterString(filter);
			else if (filter.length) {
			  filter.forEach(x => {
				divFilters.innerHTML += getFilterString(filter);
			  });
			}
		  }

		  if (!divFilters.innerHTML.trim())
			divFilters.innerHTML = "No filters";

		  var divColumns = node.querySelector("#columns");
		  if (data.Columns) {
			eval('var columns=' + data.Columns);
			if (columns.length) {
			  columns.forEach(x => {
				divColumns.innerHTML += "<div>" + convertColumnName(x.title || x.field) + "</div>";
			  });
			  node.querySelector("#columns_title").innerHTML = "Columns (" + columns.length + ")";
			}
		  }
		},
		template: function() {
		  return '<section class="report-progress">' +
			'<div class="report-progress__left">' +
			'<div class="report-progress__info">' +
			'<h2> Information </h2>' +
			'<div class="report-progress__info__container">' +

			'<div class="report-progress__info__left">' +
			'<span>Report Name: </span>' +
			'<span> Requested By: </span>' +
			'<span >Requested Date:</span>' +
			'<span >Records:</span>' +
			'<span >Expire Date:</span>' +
			'</div>' +
			'<div class="report-progress__info__right">' +
			'<span id="reportName" style="text-overflow: ellipsis;white-space: nowrap;max-width: 250px;overflow: hidden;"> </span>' +
			'<span id="reportRequestedBy"></span>' +
			'<span id="reportRequested"></span>' +
			'<span id="records"> </span>' +
			'<span id="reportExpire"> </span>' +
			'</div>' +

			'</div>' +

			'<div id="send-email"></div>' +
			'</div>' +

			'<div class="report-progress__status">' +
			'<h2> Status </h2>' +
			'<div class="report-progress__status__container">' +

			'<div class="report-progress__status__left">' +
			'<span>Elapsed: </span>' +
			'<span>Remaining: </span>' +
			'<span >Finish Date:</span>' +
			'</div>' +
			'<div class="report-progress__status__right">' +
			'<span id="elapsed"> N/A </span>' +
			'<span id="remaining">  N/A</span>' +
			'<span id="finish">  N/A</span>' +
			'</div>' +
			'</div>' +
			'<div class="report-progress__progress"> ' +
			'<div id="progress" class="report-progress__progress__bar" style="width:0%">' +
			'<p id="progressLabel" class="report-progress__progress__percent"> 0% </p>' +
			'</div>' +
			'</div>' +
			'</div>' +
			'<div class="k-button k-button-action reportingBuild-run" id="download" >Download</div>' +
			'<div class="k-button k-button-action reportingBuild-cancel" id="cancel" >Cancel</div>' +
			'</div>' +

			'<div class="report-progress__right">' +

			'<div class="report-progress__sorting">' +
			'<h2>Sorting</h2>' +
			'<div id="sorting"> </div>' +
			'</div>' +

			'<div class="report-progress__filters">' +
			'<h2>Filters</h2>' +
			'<div id="filters"> </div>' +
			'</div>' +

			'<div class="report-progress__columns">' +
			'<h2 id="columns_title">Columns</h2>' +
			'<div id="columns" style="height: 208px;overflow-y: auto;"> </div>' +
			'</div>' +

			'</div>' +
			'</section>'

		}

	  }
	},
	intervalMethod: {
	  init: function(node, columns, callback) {
		var cols = [];
		columns.forEach(el => {
		  console.log(el);
		  cols.push(el.title);
		});

		node.innerHTML = "<div class='interval-filter'></div>" +
		  '<a class="k-button k-button-action run-interval" style="margin-right:50px;width:100px" href="#">Search</a>' +
		  "<div class='k-button k-button-big rep-date-filters-general'>Clear Date Filters</div>";
		var conf = {
		  dom: node.querySelector('.interval-filter'),
		  pages: [{
			nav: false,
			structure: [{
			  group: [
				[{
				  label: "Date Range",
				  data: "dateRange",
				  type: "select",
				  options: reporting.reportBuilder.dateRange.map(el => el.option),
				  values: reporting.reportBuilder.dateRange.map(el => el.value)
				},
				 {
				   label: "on",
				   data: "on",
				   type: "text",
				   placeholder: 'Select one'

				 },
				]
			  ]
			},
						{

						  group: [
							[{
							  label: "Start",
							  data: "from",
							  type: "datetime",
							  placeholder: "Select a date",
							  dtp: {
								format: 'Y-m-d',
								timepicker: false,
								formatDate: 'Y-m-d',
								scrollMonth: false,
								scrollInput: false,
								onChangeDateTime: function(dp, $input) {}
							  }
							},
							 {
							   label: "End",
							   data: "to",
							   type: "datetime",
							   placeholder: "Select a date",
							   dtp: {
								 format: 'Y-m-d',
								 formatDate: 'Y-m-d',
								 timepicker: false,
								 scrollMonth: false,
								 scrollInput: false,
								 onChangeDateTime: function(dp, $input) {}
							   }
							 },
							]
						  ]
						}
					   ],
			callback: function() {
			  node.querySelector('[data-name="from"]').insertAdjacentHTML('afterend', '<div class="rep-clear-dp">Clear</div>');
			  node.querySelector('[data-name="to"]').insertAdjacentHTML('afterend', '<div class="rep-clear-dp">Clear</div>');


			  node.querySelector('.rep-date-filters-general').addEventListener('click', function(ev) {
				ev.target.parentNode.querySelectorAll('.wrapper.select, .wrapper.text').forEach(function(d, index) {
				  if (d.classList.contains('text')) d.querySelector('input').value = '';
				  if (d.classList.contains('select')) d.querySelector('select').value = '';
				});
				node.querySelectorAll('.rep-clear-dp').forEach(function(e) {
				  e.click();
				});

				var dateRange = {
				  logic: "and",
				  filters: []
				};
				callback(dateRange);

			  });


			  node.querySelectorAll('.rep-clear-dp').forEach(function(el) {
				el.addEventListener('click', function(ev) {
				  ev.target.parentNode.querySelector('input').value = '';
				  ev.preventDefault();
				  ev.stopPropagation();
				});
			  });

			  node.querySelector('[data-name="dateRange"]').addEventListener('change', function(ev) {
				reporting.intervalMethod.switchDateRange(ev.target.value, node);
			  });

			  util.initPopup(node.querySelector('[data-name="on"]'), cols, null, 150);
			},

		  }],
		  dataset: {},
		};
		nbsf.init(conf, 0);

		node.querySelector('.run-interval').addEventListener('click', function(ev) {
		  nbsf.data.update(conf, {});
		  if (conf.dataset.on) {
			var found;
			columns.forEach(el => {
			  if (el.title == conf.dataset.on) {
				found = el.field;
			  }
			})

			var dateRange = {
			  logic: "and",
			  filters: []
			};
			if (conf.dataset.from) dateRange.filters.push({
			  field: found || conf.dataset.on,
			  operator: "gte",
			  value: conf.dataset.from
			});
			if (conf.dataset.to) dateRange.filters.push({
			  field: found || conf.dataset.on,
			  operator: "lte",
			  value: conf.dataset.to
			})

			debugger;

			if (callback && typeof callback == 'function') callback(dateRange);
		  }

		  ev.preventDefault();
		  ev.stopPropagation();
		});

	  },
	  switchDateRange: function(val, node) {
		var pd = new Date(),
			ad = new Date();
		switch (val) {
		  case 'past1mon':
			pd.setMonth(pd.getMonth() - 1);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];
			break;
		  case 'past3mon':
			pd.setMonth(pd.getMonth() - 3);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'past6mon':
			pd.setMonth(pd.getMonth() - 6);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];
			break;
		  case 'past12mon':
			pd.setMonth(pd.getMonth() - 12);
			node.querySelector('[data-name="from"]').value = pd.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'mtd':
			var firstD;
			firstD = new Date(pd.getFullYear(), pd.getMonth(), 2);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'qtd':

			var quarter = Math.floor((pd.getMonth() / 3)),
				startDate,
				startDate = new Date(pd.getFullYear(), quarter * 3, 2);

			node.querySelector('[data-name="from"]').value = startDate.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'ytd':
			var firstD;
			firstD = new Date(pd.getFullYear(), 0, 2);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];
			break;
		  case 'prevday':


			var firstD;
			firstD = new Date(new Date().setDate(pd.getDate() - 1));
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = firstD.toISOString().split('T')[0];

			break;
		  case 'prevweek':

			var pastDate, aux, ad = new Date(new Date().setDate(new Date().getDate() - 1));
			aux = new Date().getDate() - 7;
			pastDate = new Date().setDate(aux);
			pastDate = new Date(pastDate);
			node.querySelector('[data-name="from"]').value = pastDate.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = ad.toISOString().split('T')[0];

			break;
		  case 'prevmon':
			var firstD, lastD;
			firstD = new Date(pd.getFullYear(), pd.getMonth() - 1, 2);
			lastD = new Date(ad.getFullYear(), ad.getMonth(), 1);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = lastD.toISOString().split('T')[0];

			break;
		  case 'prevqtr':

			var today = new Date(),
				quarter = Math.floor((today.getMonth() / 3)),
				startDate,
				endDate;
			startDate = new Date(today.getFullYear(), quarter * 3 - 3, 2);
			endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 3, 1);
			node.querySelector('[data-name="from"]').value = startDate.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = endDate.toISOString().split('T')[0];

			break;
		  case 'prevyr':
			var firstD, pd = new Date(),
				lastD;
			firstD = new Date(new Date().getFullYear() - 1, 0, 2);
			lastD = new Date(new Date().getFullYear() - 1, 12, 1, 1);
			node.querySelector('[data-name="from"]').value = firstD.toISOString().split('T')[0];
			node.querySelector('[data-name="to"]').value = lastD.toISOString().split('T')[0];

			break;
		  case 'all':
			var pd = new Date();

			node.querySelector('[data-name="from"]').value = '';
			node.querySelector('[data-name="to"]').value = pd.toISOString().split('T')[0];

			break;
		  case 'custom':
			var pd = new Date();

			node.querySelector('[data-name="from"]').value = '';
			node.querySelector('[data-name="to"]').value = pd.toISOString().split('T')[0];

			break;
		}
	  }
	},
	exportReport: function(dataset, formId, columns, sort, filters, filename, cb) {
	  if (!cb)
		cb = function() {};

	  if (!dataset)
		return cb("Dataset is not provided");
	  if (!formId)
		return cb("Form Id is not provided");

	  if (sort == "[]") {
		sort = null;
		try {
		  var entryIdFieldName = JSON.parse(columns).find(x => x.field.includes("EntryId")).field;
		  if (entryIdFieldName) {
			sort = {
			  field: entryIdFieldName,
			  dir: "asc"
			};
			sort = JSON.stringify(sort);
		  }
		} catch (e) {}
	  }

	  generateReport(util.Email(), dataset, formId, columns, sort, filters, filename, null, "ARK", null, true, null, null,
					 function(name) {
		name = name.replace("[", "").replace("]", "").replace('"', "").replace('"', "");
		var info = reporting.mappingData[name];
		if (info) return info.Title;
		return name;
	  }, "", cb);
	  /*
        var obj = {
          Source: "ARK",
          RequestedBy: util.Email(),
          Status: 1,
          Sort: sort,
          Filter: filters,
          Columns: columns,
          FormId: formId,
          Dataset: dataset,
          Filename: filename
        };

        crud.create("4162", obj, function(d) {
          if (!d.EntryId) {
            return cb("Couldd't create the record");
          }
          var xhr = new XMLHttpRequest();
          xhr.withCredentials = true;
          xhr.addEventListener("readystatechange", function() {
            if (this.readyState === 4) {

            }
          });
          xhr.open("GET", globalReferences.server + "resources/rs/custom/php/reporting/reporting.php?eid=" + d.EntryId);
          xhr.send();

          reporting.myReports.reportProgress.init(d.EntryId);
          cb();
        });
        */
	},
	internalRep: {
	  init: function(holder) {

		holder.innerHTML = '<a role="button" class="k-button k-button-icontext excel-button" href="https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/ark/rescoring.php">Validate</a><div class="internal-grid"></div>';
		reporting.internalRep.grid.load(holder, holder.querySelector('.internal-grid'), reporting.internalRep.dataSource());

	  },
	  grid: {
		columns: function() {
		  var columns = [{
			field: "EntryId",
			title: "Invitation #",
			hidden: false,
			locked: true,
			width: "140px",
		  },
						 {
						   field: "ProfileId",
						   title: "Company #",
						   hidden: false,
						   locked: true,
						   width: "300px",
						 },
						 {
						   field: "ProfileCompanyName",
						   title: "Company Name",
						   hidden: false,
						   width: "200px",
						 },
						 {
						   field: "SiebelId",
						   title: "Siebel Id",
						   hidden: false,
						   width: "200px",
						 },
						 {
						   field: "Status",
						   title: "Case Status",
						   hidden: false,
						   width: "200px"
						 },
						 {
						   field: "SubmittedTS",
						   title: "Submitted Date",
						   hidden: false,
						   width: "200px"
						 },
						 {
						   title: "",
						   width: "150px",
						   hidden: false,
						   locked: true,
						   attributes: {
							 "class": "cta"
						   },
						   template: function(d) {
							 var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
								 '<a style="margin-right: 5px" class="company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></a>' +
								 '<a class="check_this"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="like" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M1,23 L20,23 C22,23 23,22 23,20 L23,10 L16,10 L16,4 C16,2 15,1 13,1 L11,1 C11,1 10.9842682,7 10.9842677,8.32575545 C10.9842672,9.65151089 10,11 8,11 L1,11 L1,23 Z M6,23 L6,11"></path></svg> </a>';
							 return icons;
						   }
						 }
						];

		  return columns;
		},
		load: function(holder, selector, datasource) {
		  var columns = reporting.internalRep.grid.columns();

		  util.kendoGrid.addDateFieldsToSchema(datasource, ["CompletedTS", "Modified"]);

		  $(selector).kendoGrid({
			height: 500,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available </div>"
			},
			dataSource: datasource,
			columns: columns,
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
			resizable: true,
			dataBound: util.kendoGrid.dataBound,
			filter: util.kendoGrid.filter
		  });

		  $(selector).delegate('.view_invitation', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.init(row.EntryId);
		  });
		  $(selector).delegate('.check_this', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			var path = 'https://hpe-rfb.itcs.hpe.com/resources/rs/custom/php/ark/scoring.php?ifk=' + row.EntryId;
			window.location.href = path;
		  });

		  $(selector).delegate('.company_details', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));

			singleCompanyDetails.init(row.ProfileId);
		  });

		  mo.fn.overlay.hide();
		}
	  },
	  dataSource: function() {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1424/ARK_CASES_NOT_SCORED/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		  serverFiltering: true,
		  serverSorting: true,
		  //filter: {field: "Status", operator: "eq", value: 0},
		  //sort: {field: "ReminderDate", dir: "asc"}
		});
	  }
	}
  };
</script>

<!--AUTH CODES -->
<script>
  const authCodes = {
	holder: function() {
	  return document.querySelector('#navigation #authCodes:last-child')
	},
	html: function() {
	  return "<section id='authCodes'><div class='auth-codes-grid'></div></section>";
	},
	init: function() {
	  navigation.push(authCodes.html());
	  authCodes.ui.init();
	},
	ui: {
	  init: function() {
		mo.fn.overlay.show({
		  loading: true
		});
		authCodes.ui.grid._load(authCodes.holder().querySelector('.auth-codes-grid'), authCodes.ui.grid._dataSource(), authCodes.ui.grid._columns());
		recentlyViewed.add({
		  Module: 'Auth codes',
		  Id: null,
		}, function() {});
		mo.fn.overlay.hide();
	  },
	  grid: {
		_columns: function() {
		  var cusConfig = [
			{
			  field: "InvitationId",
			  title: "Case #",
			  hidden: false,
			  width: "120px",
			  locked: true
			},
			{
			  field: "Email",
			  title: "To",
			  hidden: false,
			  width: "250px",
			  locked: true,
			},
			{
			  field: "EmailStatus",
			  title: "Email Status",
			  hidden: false,
			  width: "150px",
			  locked: true,
			},
			{
			  field: "Status",
			  title: "Case Status",
			  hidden: false,
			  width: "150px",
			  locked: false,
			  template: function(d) {
				return invitation.manageStatus(d.Status);
			  }
			},
			{
			  field: "Sent",
			  title: "Sent",
			  hidden: false,
			  width: "140px",
			  template: function(d) {
				return d.Sent ? util.getDate(d.Sent) : "";
			  }
			},
			{
			  field: "Created",
			  title: "Created",
			  hidden: false,
			  width: "140px",
			  template: function(d) {
				return d.Created ? util.getDate(d.Created) : "";
			  }
			},
			{
			  field: "Token",
			  title: "Token",
			  hidden: false,
			  width: "120px",
			  locked: false
			},
			{
			  field: "CompanyName",
			  title: "Company name",
			  hidden: false,
			  width: "200px",
			  locked: false,
			},
			{
			  field: "ProfileId",
			  title: "Profile #",
			  hidden: false,
			  width: "130px",
			  locked: false
			},
			{
			  field: "ErrorMessage",
			  title: "Email error",
			  hidden: false,
			  width: "500px",
			  locked: false,
			  template: function(d) {
				if(!d.ErrorMessage)
				  return "";

				var message = "";

				var idx = d.ErrorMessage.indexOf("Stack Trace");
				while(idx != -1) {

				  var idx1 = d.ErrorMessage.indexOf("Message:", idx);
				  if(idx1 == -1)
					break;

				  var idx2 = d.ErrorMessage.indexOf("Stack Trace", idx1);
				  if(idx1 && idx2)
					message += d.ErrorMessage.substring(idx1, idx2) + "<br>";

				  idx = idx2;
				}


				return "<div>" + message + "</div>";
			  }
			},
			{
			  title: "",
			  width: "150px",
			  locked: true,
			  hidden: false,
			  attributes: {
				"class": "cta"
			  },
			  template: function(d) {
				var icons = '<a style="margin-right: 5px" class="view_invitation"><svg version="1.1" viewBox="0 0 24 24" width="24px" height="24px" role="img" aria-label="edit"><path fill="none" stroke="#666" stroke-width="2" d="M12,21 C7,21 1,16 1,12 C1,8 7,3 12,3 C17,3 23,8 23,12 C23,16 17,21 12,21 Z M12,7 C9.23875,7 7,9.23875 7,12 C7,14.76125 9.23875,17 12,17 C14.76125,17 17,14.76125 17,12 C17,9.23875 14.76125,7 12,7 L12,7 Z"></path></a>' +
					'<a style="margin-right: 6px" class="myInv-company_details"><svg version="1.1" viewBox="0 0 24 24" role="img" aria-label="article" width="24px" height="24px"><path fill="none" stroke="#666" stroke-width="2" d="M16,7 L19,7 L19,11 L16,11 L16,7 Z M9,15 L20,15 M9,11 L13,11 M9,7 L13,7 M6,18.5 C6,19.8807119 4.88071187,21 3.5,21 C2.11928813,21 1,19.8807119 1,18.5 L1,7 L6.02493781,7 M6,18.5 L6,3 L23,3 L23,18.5 C23,19.8807119 21.8807119,21 20.5,21 L3.5,21"></path></svg></path></svg></a>';
				return icons;
			  }
			}
		  ];
		  return cusConfig;
		},
		_load: function(selector, datasource, config) {
		  $(selector).kendoGrid({
			height: 600,
			noRecords: {
			  template: "<div style='margin-top:180px; text-align: center'> No data available on current page. </div>"
			},
			dataSource: datasource,
			columns: config,
			pageable: {
			  buttonCount: 4,
			  pageSize: 10,
			  pageSizes: [10, 25, 50, 100],
			  messages: {
				itemsPerPage: ""
			  },
			  refresh: true
			},
			scrollable: true,
			sortable: true,
			filterable: true,
		  });
		  $(selector).delegate('.view_invitation', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));
			invitation.invitationOverview.init(row.InvitationId);
		  });

		  $(selector).delegate('.myInv-company_details', 'click', function(ev) {
			var grid = $(selector).data("kendoGrid");
			var row = grid.dataItem($(this).closest("tr"));

			myInvitations.viewCompany(row.ProfileId);
		  });
		},
		_dataSource: function() {
		  return new kendo.data.DataSource({
			type: "rfb-v2",
			transport: {
			  read: {
				url: globalReferences.server + "form/data-set-provider/v2/1166/ARK_AuthTokens/kendo/data/search",
				type: 'POST'
			  },
			},
			schema: {
			  model: {
				Created: {type: "date"},
				Sent: {type: "date"},
			  }
			},
			serverPaging: true,
			pageSize:15,/* set page size*/
			serverFiltering: true,
			/* set default filter
                  filter: { logic: "and", filters: [ { field: "name", operator: "startswith", value: "Jane" } ] }
                  */
			serverSorting: true,

			sort: { field: "Sent", dir: "desc" }


		  });

		},
	  },
	},

  }
</script>

<!--FOOTER -->
<script>
  const footer = {
	holder: document.querySelector('.overview'),
	init: function() {
	  footer.invitations(function(response) {
		footer.holder.querySelector('[card-id="INV"] strong').innerHTML = response.Total;
	  });
	  footer.pendingCases(function(response1) {
		footer.holder.querySelector('[card-id="PC"] strong').innerHTML = response1.Total;
	  });
	  footer.awaitRescreening(function(response2) {
		footer.holder.querySelector('[card-id="AR"] strong').innerHTML = 0; //response2.Total;
		//footer.holder.querySelector('[card-id="AR"]').innerHTML= "";
	  });
	  footer.expiredSoon(function(response3) {
		footer.holder.querySelector('[card-id="ES"] strong').innerHTML = response3.Total;
	  });
	},
	invitations: function(callback) {
	  $.ajax({
		type: 'POST',
		url: globalReferences.server + 'form/data-set-provider/v2/1275/ARK_Invitations_Sent/kendo/data/search',
		data: {
		  pageSize: -1,
		  page: 1
		},
		success: function(response) {

		  callback(response);

		},
		error: function() {
		  console.log("error")
		}
	  });


	},
	pendingCases: function(callback) {
	  $.ajax({
		type: 'POST',
		url: globalReferences.server + 'form/data-set-provider/v2/1275/ARK_Invitations_Submitted/kendo/data/search',
		data: {
		  pageSize: -1,
		  page: 1
		},
		success: function(response) {
		  callback(response);

		},
		error: function() {
		  console.log("error")
		}
	  });

	},
	awaitRescreening: function(callback) {
	  $.ajax({
		type: 'POST',
		url: globalReferences.server + 'form/data-set-provider/v2/1363/ARK_Rescreening/kendo/data/search',
		data: {
		  pageSize: -1,
		  page: 1
		},
		success: function(response) {

		  callback(response);

		},
		error: function() {
		  console.log("error")
		}
	  });

	},
	expiredSoon: function(callback) {
	  $.ajax({
		type: 'POST',
		url: globalReferences.server + 'form/data-set-provider/v2/1275/ARK_Invitations_ToExpire/kendo/data/search',
		data: {
		  pageSize: -1,
		  page: 1
		},
		success: function(response) {

		  callback(response);

		},
		error: function() {
		  console.log("error")
		}
	  });

	},
	apiCall: function(url, type) {
	  $.ajax({
		type: 'POST',
		url: url,
		data: {
		  pageSize: -1,
		  page: 1
		},
		success: function(response) {

		  callback(response);

		},
		error: function() {
		  console.log("error")
		}
	  });

	}
  }
</script>

<script>
  const setCopySubmitterColumnsProfiles = {
	start: function(page) {
	  setCopySubmitterColumnsProfiles.page = page;

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1285/ARK_IntakeData/kendo/data/search",
			type: 'POST'
		  },
		},
		serverPaging: true,
		page: setCopySubmitterColumnsProfiles.page,
		pageSize: 1000,
		/* set page size*/
		serverFiltering: true,
		serverSorting: true,
		schema: {}
		/* set default sort */
	  });
	  ds.read().then(function() {
		var data = ds.view();
		var current = 0;
		var total = data.length;

		checkStatus = function() {
		  current++;
		  if (current == total)
			setCopySubmitterColumnsProfiles.start(page + 1)
		}

		data.forEach(x => {
		  var row = x.toJSON();

		  if (row.SubmitterEmail) {
			checkStatus();
			return;
		  }

		  var needupdate = false;
		  if (row.StandardColumn35 && row.StandardColumn35 == row.StandardColumn36) {

			row.SubmitterEmail = row.StandardColumn35;
			row.SubmitterEmailConfirm = row.StandardColumn36;
			row.SubmitterName = row.StandardColumn32;
			row.SubmitterPhone = row.StandardColumn34;
			row.SubmitterPosition = row.StandardColumn33;
			needupdate = true;
		  }

		  if (row.StandardColumn28 && row.StandardColumn28 == row.StandardColumn29) {

			row.SubmitterEmail = row.StandardColumn28;
			row.SubmitterEmailConfirm = row.StandardColumn29;
			row.SubmitterName = row.StandardColumn25;
			row.SubmitterPhone = row.StandardColumn27;
			row.SubmitterPosition = row.StandardColumn26;
			needupdate = true;
		  }

		  if (row.StandardColumn21 && row.StandardColumn24 == row.StandardColumn25) {

			row.SubmitterEmail = row.StandardColumn24;
			row.SubmitterEmailConfirm = row.StandardColumn25;
			row.SubmitterName = row.StandardColumn21;
			row.SubmitterPhone = row.StandardColumn23;
			row.SubmitterPosition = row.StandardColumn22;
			needupdate = true;
		  }


		  if (row.StandardColumn29 && row.StandardColumn27) {

			row.SubmitterEmail = row.StandardColumn29;
			row.SubmitterEmailConfirm = row.StandardColumn29;
			row.SubmitterName = row.StandardColumn25;
			row.SubmitterPhone = row.StandardColumn27;
			row.SubmitterPosition = row.StandardColumn26;
			needupdate = true;
		  }

		  if (needupdate)
			crud.update("4090", row.EntryId, row, function() {
			  checkStatus();
			});
		  else checkStatus();

		});
	  });
	}
  }

  const setLegacyColumnsForProfiles = {
	start: function(page) {
	  setLegacyColumnsForProfiles.page = page;

	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_CompanyInformation/kendo/data/search",
			type: 'POST'
		  },
		},
		serverPaging: true,
		page: setLegacyColumnsForProfiles.page,
		pageSize: 1000,
		/* set page size*/
		serverFiltering: true,
		serverSorting: true,
		schema: {}
		/* set default sort */
	  });
	  ds.read().then(function() {
		var data = ds.view();
		var current = 0;
		var total = data.length;

		checkStatus = function() {
		  current++;
		  if (current == total)
			setLegacyColumnsForProfiles.start(page + 1)
		}

		data.forEach(x => {
		  var row = x.toJSON();

		  if (!row.LegacyId) {
			checkStatus();
			return;
		  }

		  crud.read("4163", "tp=" + row.LegacyId, function(d) {
			if (d.Rows && d.Rows.length > 0) {
			  row.LegacyCreatedBy = d.Rows[0].ThirdPartyCreatedBy;
			  row.LegacyCreated = d.Rows[0].ThirdPartyCreated;
			  row.LastStatusChangeDate = d.Rows[0].ThirdPartyApprovalStatusChange;
			  row.StatusHistory = null;

			  if (row.FAX == 0)
				row.FAX = null;
			  crud.update("3980", row.EntryId, row, function() {
				//singleCompanyDetails.init(row.EntryId);
				//singleCompanyDetails.addAuditLog("Profile changed", util.getDifference(x, row, companyModal.config()), util.Email());
				checkStatus();
			  });
			} else checkStatus();
		  });
		});
	  });
	}
  }

  const countryLangMappingScript = {
	start: function(json) {
	  var jsonData = JSON.parse(json);

	  var keys = Object.keys(jsonData);

	  keys.forEach(key => {

		var country = reference.countries.rawData.find(x => x.ISO2 == key);
		if (!country)
		  return;

		var info = jsonData[key];
		var langCodes = info["languages"];
		var langs = [];
		langCodes.forEach(x => {
		  langs.push(countryLangMappingScript.mapLang(x, country.ISO2));
		});

		if (langs.length > 0) {
		  country.Languages = JSON.stringify(langs);
		  country.PreferredLang = langs[0];
		}


		crud.update("3666", country.EntryId, country, function() {});

	  });
	},
	mapLang: function(lang, country) {
	  switch (lang) {
		case "cs":
		  return "cz_CH";
		case "de":
		  return "de_DE";
		case "en":
		  return "en_US";
		case "es":
		  return "es_ES";
		case "fr":
		  return country == "CA" ? "fr_CA" : "fr_FR";
		case "id":
		  return "in_ID";
		case "it":
		  return "it_IT";
		case "hu":
		  return "hu_HU";
		case "pl":
		  return "pl_PL";
		case "pt":
		  return country == "PT" ? "pt_PT" : "pt_BR";
		case "ro":
		  return "ro_RO";
		case "sk":
		  return "sk_SK";
		case "tr":
		  return "tr_TR";
		case "vi":
		  return "vi_VN";
		case "el":
		  return "gr_GR";
		case "ru":
		  return "ru_RU";
		case "he":
		  return "he_IL";
		case "ar":
		  return "ar_AE";
		case "th":
		  return "th_TH";
		case "zh":
		  return country == "TW" ? "zh_TW" : "zh_CN";
		case "ja":
		  return "ja_JP";
		case "ko":
		  return "ko_KR";
		default:
		  return "en_US";
	  }
	}
  }

  const setConfigFKForProfiles = {
	start: function() {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1363/ARK_CompanyInformation/kendo/data/search",
			type: 'POST'
		  },
		},
		serverPaging: true,
		page: 1,
		pageSize: 10000,
		/* set page size*/
		serverFiltering: true,
		serverSorting: true,
		schema: {}
		/* set default sort */
	  });
	  ds.read().then(function() {
		var data = ds.view();
		data.forEach(x => {
		  var row = x.toJSON();
		  var configInfo = reference.configs.data.find(x => x.ConfigId == row.IntakeForm);
		  if (configInfo) {
			row.ConfigFK = configInfo.EntryId;
			row.ConfigName = configInfo.ConfigName;
		  }
		  crud.update("3980", row.EntryId, row, function() {
			//singleCompanyDetails.addAuditLog("Profile changed", util.getDifference(x, row, companyModal.config()), util.Email());
		  });
		});
	  });
	}
  }

  const renameColumnFriendlyNames = {
	start: function() {
	  var ds = new kendo.data.DataSource({
		type: "rfb-v2",
		transport: {
		  read: {
			url: globalReferences.server + "form/data-set-provider/v2/1396/ARK_ColumnMapping/kendo/data/search",
			type: 'POST'
		  },
		},
		serverPaging: true,
		page: 1,
		pageSize: 10000,
		/* set page size*/
		serverFiltering: true,
		serverSorting: true,
		schema: {}
		/* set default sort */
	  });
	  ds.read().then(function() {
		var data = ds.view();
		data.forEach(x => {
		  var row = x.toJSON();
		  switch (row.FormId) {
			case 1363:
			  if (!row.Title.includes("Profile."))
				row.Title = "Profile. " + row.Title;
			  break;
			case 1374:
			  if (!row.Title.includes("Profile."))
				row.Title = "Profile (CF). " + row.Title;
			  else row.Title = row.Title.replace("Profile.", "Profile (CF). ");
			  break;
			case 1275:
			case 1285:
			  if (!row.Title.includes("Case."))
				row.Title = "Case. " + row.Title;
			  break;
			case 1375:
			  if (!row.Title.includes("Case."))
				row.Title = "Case (CF). " + row.Title;
			  else row.Title = row.Title.replace("Case.", "Case (CF). ");
			  break;
			case 1278:
			case 1485:
			  if (!row.Title.includes("Task."))
				row.Title = "Task. " + row.Title;
			  break;
		  }
		  crud.update("4075", row.EntryId, row, function() {});
		});
	  });
	}
  }

</script>


<script>
  const countryCPIMappingScript = {
	start: function(json) {
	  var jsonData = JSON.parse(json);

	  countryCPIMappingScript.getCountryRisk(function(rows) {


		var data = jsonData["Sheet1"];

		data.forEach(d => {

		  var countryInfo = rows.find(x => x.Name == d.Country);
		  if (!countryInfo)
			return;

		  countryInfo.CountryCPI = d["2020 CPI Score"];


		  crud.update("3708", countryInfo.EntryId, countryInfo, function() {});

		});
	  });

	},
	getCountryRisk: function(callback) {
	  $.ajax({
		type: 'POST',
		url: globalReferences.server + 'form/data-set-provider/v2/1288/ArkCountryRiskModels/kendo/data/search',
		data: {
		  pageSize: 500,
		  page: 1
		},
		success: function(response) {
		  callback(response.Data);
		},
		error: function() {
		  console.log("error")
		}
	  });

	}

  }

  const profileConfigIdFix = {
	start: function() {

	  profileConfigIdFix.get(function(rows) {

		rows.forEach(d => {
		  crud.update("3980", d.PID, {
			ConfigFK: d.CaseConfigFK
		  }, function() {});

		});
	  });

	},
	get: function(callback) {
	  $.ajax({
		type: 'POST',
		url: globalReferences.server + 'form/data-set-provider/v2/1363/ARK_PROFILE_CONFIG_FIX/kendo/data/search',
		data: {
		  pageSize: 500,
		  page: 1
		},
		success: function(response) {
		  callback(response.Data);
		},
		error: function() {
		  console.log("error")
		}
	  });

	}

  }
</script>


<script>
  const overviewCounters = {
	init: function() {
	  overviewCounters.profiles();
	  overviewCounters.cases();
	  overviewCounters.pendingTasks();
	  overviewCounters.users();
	  overviewCounters.countries();
	  overviewCounters.localization.init();
	  overviewCounters.intakeForms();
	},
	profiles: function() {
	  var dataSource = profiles.dataSource();
	  dataSource.read().then(function() {
		var a;
		a = dataSource.total();
		document.querySelector('.tile[section-id="profiles"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
	  });
	},
	cases: function() {
	  var dataSource = myInvitations.dataSource();
	  dataSource.read().then(function() {
		var a;
		a = dataSource.total();
		document.querySelector('.tile[section-id="invitations"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
	  });
	},
	pendingTasks: function() {
	  var dataSource = pending.dataSource();
	  dataSource.read().then(function() {
		var a;
		a = dataSource.total();
		document.querySelector('.tile[section-id="pending"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
	  });
	},
	users: function() {
	  var dataSource = users.grid.datasource();
	  dataSource.read().then(function() {
		var a;
		a = dataSource.total();
		document.querySelector('.tile[section-id="users"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
	  });
	},
	countries: function() {
	  var dataSource = countries.ui.grid.dataSource();
	  dataSource.read().then(function() {
		var a;
		a = dataSource.total();
		document.querySelector('.tile[section-id="countries"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
	  });
	},
	localization: {
	  dataSource: function() {
		return new kendo.data.DataSource({
		  type: "rfb-v2",
		  transport: {
			read: {
			  url: globalReferences.server + "form/data-set-provider/v2/1274/ARK_Localization_MetaData/kendo/data/search",
			  type: 'POST'
			},
		  },
		  schema: {
			model: {
			  id: "EntryId",
			  /* please define primary key name */
			  fields: {
				/* define filed here for use update/create*/
			  }
			}
		  },
		  serverPaging: true,
		  pageSize: 15,
		});
	  },
	  init: function() {
		var dataSource = overviewCounters.localization.dataSource();
		dataSource.read().then(function() {
		  var a;
		  a = dataSource.total();
		  document.querySelector('.tile[section-id="localization"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
		});
	  },
	},
	intakeForms: function() {
	  configsAPI.overview(function(d) {
		var a = d.length;
		document.querySelector('.tile[section-id="intake"]').insertAdjacentHTML('afterbegin', '<span>(' + a + ')</span>');
	  });
	}
  }; //add it in ui.init or footer
</script>


<!-- INIT -->
<script>
  function jstr(val) {
	try {
	  return JSON.stringify(val).replace(/"/gi, "") || "";
	} catch (e) {
	  return JSON.stringify(val) || "";
	}
  }

  function init() {
	mo.init();

	access.init(function() {
	  reference.init(function() {
		ui.init();
		footer.init();
	  });

	});
  }



  init();
</script>